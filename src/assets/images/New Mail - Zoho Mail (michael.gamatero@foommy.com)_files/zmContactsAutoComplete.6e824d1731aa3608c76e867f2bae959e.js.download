"use strict";!function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),o=zmail.Utils.DOM,t=zmail.Components.AutoComplete,r=t.System.AbstractTrigger,s=t.Utils,n=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"textChangeAction",value:function(){var e=this,t=e._input.getText();0===(t=t.trim()).indexOf("@")&&(t=t.substr(1,t.length)),t?e.publishTriggerEvent({searchToken:t}):e.publishNegativeTriggerEvent()}},{key:"bindEvents",value:function(){var e,t=this,r=t._input,n=200;0<=r.setDebounce&&(n=r.setDebounce),t._textChangeEventHandler=t._textChangeEventHandler.bind(t),t._textChangeEventHandler=s.debounce(t._textChangeEventHandler,n),e=t._textChangeEventHandler,o.element(r).on("textchange",e)}}]),t}(r);e.zmInputTrigger=n}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),n=zmail.Utils.DOM,t=zmail.Components.AutoComplete,r=t.System.AbstractTrigger,o=t.Utils,s=/(?:^[@]{1}(([^\s]+[\s]?)*))/i,a=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getCurrentWord",value:function(){var e=this._input,t=e.getText(),r=e.getCursorPosition(),n=t.substr(0,r),o=n.lastIndexOf("@"),s="";return 0===o?s=n.substr(o,r):0<o&&(" "===n[o-1]||"\n"===n[o-1])&&(s=n.substr(o,r)),s}},{key:"textChangeAction",value:function(){var e,t=this;e=t._input.editor||t._input.contenteditable?t._input.getCurrentTypingWord(!0):t.getCurrentWord(),t.currentText=e,s.lastIndex=0;var r=s.exec(e);if(r){var n=r[1]||"";t.publishTriggerEvent({searchToken:n})}else t.publishNegativeTriggerEvent()}},{key:"bindEvents",value:function(){var e,t=this,r=t._input;t._textChangeEventHandler=t._textChangeEventHandler.bind(t),t._textChangeEventHandler=o.debounce(t._textChangeEventHandler,0),e=t._textChangeEventHandler,n.element(r).on("textchange",e)}}]),t}(r);e.zmMentionTrigger=a}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),t=zmail.Components.AutoComplete.System.AbstractListItemModel.extend({defaults:{firstName:"",middleName:"",lastName:"",nickName:"",email:"",profileImage:"",zid:null,internalData:{}}});e.zmListItemModel=t}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),h=zmail.Utils.DOM,t=zmail.Components.AutoComplete.System.AbstractListItemComponent,C=function(r,e,n,o){o=o||{},h.clearHTML(r),function(e,t,r){e=e||"";var n=[];if(!(t=t||""))return n=e?[e]:[];var o=e;(r=r||{}).caseSensitive||(t=t.toLowerCase(),o=o.toLowerCase());var s,a,i=-1;for(s=0,a=e.length;s<a&&-1!==(i=o.indexOf(t,s));s++)0!==i&&n.push(e.substring(s,i)),n.push(e.substring(i,i+t.length)),s=i+t.length-1;return s<a&&n.push(e.substring(s)),n}(e,n,o).forEach(function(e){var t=function(e,t,r){r=r||{};var n=h.element(zdom("span",null));return n.text(e),r.caseSensitive||(t=t.toLowerCase(),e=e.toLowerCase()),t===e&&n.addClass("afHgl"),n}(e,n,o);h.mount(t,r)}),h.setAttribute(r,{title:e})},r=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"createDOM",value:function(e){return this.dom=e?zdom("li",{ref:"wrapper"},zdom("div",{ref:"name"}),zdom("div",{ref:"avatar"})):zdom("li",{ref:"wrapper"},zdom("div",{className:"SC_cont"},zdom("div",{ref:"name"}),zdom("span",{ref:"email"})),zdom("div",{ref:"avatar"})),this.dom}},{key:"render",value:function(e,t){var r=this;t=t||{};var n=e.attributes;r.model=e,r.state.selected=n.selected||!1,r.dom?r.uninitializeDOM():(r.createDOM(t.hideEmailId),r.createDOMRefs()),r.state.searchWord=t.searchWord||r.state.searchWord||"";var o="SC_Psli";r.state.selected?h.addClass(r.refs.wrapper,o):h.removeClass(r.refs.wrapper,o);var s=n.internalData.avatar()[0];h.mountAfter(s,r.refs.avatar),h.unmount(r.refs.avatar,!0);var a=r.state.searchWord,i=[],l=(n.firstName||"").trim(),u=(n.middleName||"").trim(),c=(n.lastName||"").trim(),p=(n.nickName||"").trim();if(l&&i.push(l),u&&i.push(u),c&&i.push(c),p&&(p="("+p+")",i.push(p)),i=i.join(" "),h.clearHTML(r.refs.name),C(r.refs.name,i,a),"crm"===n.internalData.type){var m=h.element(zdom("i",{className:"msi-crm",title:"CRM Contact"}));h.mount(m,r.refs.name)}if(r.refs.email){var d=n.email||"";h.clearHTML(r.refs.email),d?C(r.refs.email,d,a):h.hide(r.refs.email)}else h.setAttribute(r.refs.name,{title:n.email});r._postRender()}},{key:"focus",value:function(){var e=this;e.focusTimeoutID=setTimeout(function(){e._mounted&&(h.focus(e.refs.wrapper),e.refs.wrapper.scrollIntoView(!1))},0)}}]),t}(t);e.zmListItemComponent=r}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),t=zmail.Components.AutoComplete.System.AbstractListItemComponentFactory,r=zmContactsAutoComplete.zmListItemModel,n=zmContactsAutoComplete.zmListItemComponent,o=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"createComponent",value:function(e){if(e instanceof r)return new n}}]),t}(t);e.zmListItemComponentFactory=o}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),n=zmail.Utils.DOM,t=function(e){function r(){var e;return babelHelpers.classCallCheck(this,r),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(r).call(this)),babelHelpers.assertThisInitialized(e).popUp=!0,e}return babelHelpers.inherits(r,e),babelHelpers.createClass(r,[{key:"createDOM",value:function(e){var t=e?"SC_Pr":"SC_P2r";this.dom=zdom("div",{ref:"wrapper",className:"SC_dd shw SC_contacts"},zdom("div",{className:"scrlldiv zmDDScroll"},zdom("ul",{ref:"listWrapper",className:t})))}},{key:"_preRender",value:function(e,t){var r=this;r.model=e,r.dom?r.uninitializeDOM():(r.createDOM(t),r.createDOMRefs())}},{key:"render",value:function(e,t){t=t||{},this._preRender(e,t.hideEmailId),this.renderListItems(e,t),this._postRender()}},{key:"getScrollWrapperDOM",value:function(){return this.refs.listWrapper}},{key:"handleListSpaceOverflow",value:function(e){e=e||{};var t=this.getScrollWrapperDOM();n.setStyle(t,{height:e.height+"px"})}},{key:"positionComponent",value:function(e){var t=this.getScrollWrapperDOM();return n.setStyle(t,{height:"auto"}),babelHelpers.get(babelHelpers.getPrototypeOf(r.prototype),"positionComponent",this).call(this,e)}},{key:"_mouseDownHandler",value:function(e){this.mouseDown=!0,_zm.stopEvents(e)}},{key:"show",value:function(){babelHelpers.get(babelHelpers.getPrototypeOf(r.prototype),"show",this).call(this),this.popUp?n.setStyle(this.dom,{"z-index":"105"}):n.setStyle(this.dom,{"z-index":""}),n.show(this.dom)}},{key:"hide",value:function(){babelHelpers.get(babelHelpers.getPrototypeOf(r.prototype),"hide",this).call(this),n.hide(this.dom)}}]),r}(zmail.Components.AutoComplete.System.AbstractListComponent);e.zmListComponent=t}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),t=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"accumulateData",value:function(e){var t=this;e.collectionList.forEach(function(e){t.dataCollection.add(e.models)});var r=t.dataCollection.models;t.dataCollection.reset(r,{silent:!0}),t.triggerAccumulationComplete()}}]),t}(zmail.Components.AutoComplete.System.AbstractDataAccumulator);e.zmContactDataAccumulator=t}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),t=zmail.Components.AutoComplete.System.AbstractDataProvider,i=zmContactsAutoComplete.zmListItemModel,r=function(e){function t(){var e;return babelHelpers.classCallCheck(this,t),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this)),babelHelpers.assertThisInitialized(e).searchResultLimit=10,e}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"destroy",value:function(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"destroy",this).call(this),this.searchResultLimit=null}},{key:"constructModel",value:function(e){for(var t=(e=e||{}).contact||[],r=e.collection,n=0,o=t.length;n<o;n++){var s=t[n];if(e.showGroup||!e.excludeGroups||!zmail.ContactBook.isGroup(s.attrs.eid)){var a=new i({id:s.attrs.eid||s.id,firstName:s.attrs.fn||s.attrs.name,middleName:s.attrs.mn,lastName:s.attrs.ln,nickName:s.attrs.nn,email:s.attrs.eid,profileImage:s.attrs.photo,zid:s.attrs.zid||s.attrs.id,internalData:s});if(r.add(a),10<=r.length)break}}return r}},{key:"searchData",value:function(t){var r=this,e=(t=t||{}).searchToken||"",n="";t.showGroup&&(n=t.showGroup,t.includeAllGroups=!1,t.includeEmailedGroups=!1,t.excludeGroups=!0);var o=[],s=t.collection||null,a=t.deferred||null;if(t.exclude&&(o=t.exclude()),e){e=e.toLowerCase();var i,l=t.includeOnly||[],u=[];if(n&&!(o&&-1<o.indexOf(n))){var c=zmail.ContactBook.getGroups(n);if(c.length)0===c[0].attrs.name.toLowerCase().indexOf(e)&&u.push(c[0])}var p={str:e,excludeMe:t.excludeMe,exclude:o,includeAllGroups:t.includeAllGroups,containsSearch:!0,includeEmailedGroups:t.includeEmailedGroups,excludeGroups:t.excludeGroups,type:t.type,expected:10};n&&(p.prioritizeGroupMembers=[n]),p.prioritizeGroupMembers=p.prioritizeGroupMembers||[],t.prioritizeGroupMembers&&t.prioritizeGroupMembers.length&&(p.prioritizeGroupMembers=p.prioritizeGroupMembers.concat(t.prioritizeGroupMembers)),t.prioritizeAllGroupMembers&&(p.prioritizeAllGroupMembers=!0),zmail.ContactBook.get(p).done(function(e){u=u.concat(e),Array.isArray(l)&&l.length&&(u=u.filter(function(e){var t=String(e.attrs.zid||e.attrs.id);return-1!==l.indexOf(t)})),i=r.constructModel({contact:u,collection:s,excludeGroups:t.excludeGroups,showGroup:t.showGroup}).models,s.reset(i,{silent:!0}),a.resolve()}).fail(function(){a.resolve()})}else a.reject()}}]),t}(t);e.zmContactsDataProvider=r}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),o=zmail.Utils.DOM,s=zmail.Components.AutoComplete,t=s.System.BaseHTMLEditableAutoCompleteSystem,n=s.System.AbstractHTMLInput,a=s.System.AbstractHTMLTextArea,r=zmContactsAutoComplete.zmInputTrigger,i=zmContactsAutoComplete.zmMentionTrigger,l=zmContactsAutoComplete.zmListComponent,u=zmContactsAutoComplete.zmListItemComponentFactory,c=zmContactsAutoComplete.zmContactsDataProvider,p=zmContactsAutoComplete.zmContactDataAccumulator,m={LIST_SHOWN:"listShown",LIST_HIDDEN:"listHidden",CLICK:"click",ITEM_SELECTED:"itemSelected"},d=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"initUserInput",value:function(e){var t=this,r=e.inputElement;switch(t.inputType){case"1":t.userInput=new a,t.userInput.init(r);break;case"2":t.userInput=new n,t.userInput.init(r);break;case"3":case"4":t.userInput=r}t.userInput.setDebounce=t.setDebounce}},{key:"createDataProviders",value:function(){return[new c]}},{key:"createTrigger",value:function(){switch(this.inputType){case"1":return new i;case"2":return new r;case"3":case"4":return new i}}},{key:"createDataAccumulator",value:function(){return new p}},{key:"createListComponent",value:function(){return new l}},{key:"createListItemComponentFactory",value:function(){return new u}},{key:"showComponent",value:function(){var e,t=this,r=t.dataAccumulator.dataCollection,n=r.find(function(e){return e.attributes.selected});(n&&n.set({selected:!1}),r.length)&&("2"===t.inputType?e=t.userInput._element.getBoundingClientRect():(e=t.userInput.getListAnchorBounds(),"3"!==t.inputType&&(e.top-=t.userInput._element.scrollTop,e.bottom-=t.userInput._element.scrollTop)),t.listComponent.positionComponent({anchorBounds:e}),t.listComponent.listItemComponents[0].model.set("selected",!0),t.listComponent.show(),o.element(t).triggerHandler(m.LIST_SHOWN),s.Utils.autoCompleteListsShown({instance:t}))}},{key:"hideComponent",value:function(){var e=this;e&&e.listComponent&&(e.listComponent.hide(),o.element(e).triggerHandler(m.LIST_HIDDEN),s.Utils.autoCompleteListsShown({instance:e,hide:!0}))}},{key:"invokeDataProviderSearch",value:function(t){var r=this,e=r.dataProviders||[];r.dataAccumulator.dataCollection.reset(null),r.listModel.resetData(),r.listModel.set({currentSearchKey:t.searchToken},{silent:!0}),r.hideComponent(),r.disable||e.forEach(function(e){e.getData({searchToken:t.searchToken,trigger:t.trigger,includeAllGroups:r.includeAllGroups,includeEmailedGroups:r.includeEmailedGroups,excludeGroups:r.excludeGroups,exclude:r.exclude,excludeMe:r.excludeMe,showGroup:r.showGroup,includeOnly:r.includeOnly,type:r.contactType,prioritizeAllGroupMembers:r.prioritizeAllGroupMembers,prioritizeGroupMembers:r.prioritizeGroupMembers})})}},{key:"listItemSelectAction",value:function(e){var t=this;t.isSelectActionProgress||(t.isSelectActionProgress=!0,o.element(t).triggerHandler(m.ITEM_SELECTED,{item:e.listItemModel}),t.isSelectActionProgress=!1,setTimeout(function(){t.cancelAutoComplete()},0))}},{key:"renderComponent",value:function(){var e=this.listModel,t=this.listComponent,r=e.attributes.currentSearchKey||"";t.render(e,{searchWord:r,hideEmailId:this.hideEmailId})}},{key:"_inputClickHandler",value:function(){this.hideComponent()}},{key:"bindEvents",value:function(){o.element(this.userInput._element).on(m.CLICK,this._inputClickHandler.bind(this)),babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"bindEvents",this).call(this)}},{key:"unbindEvents",value:function(){o.element(this.userInput._element).off(m.CLICK,this._inputClickHandler),babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"unbindEvents",this).call(this)}}]),t}(t);d.EVENTS=m,d.INPUTS={TEXTAREA:"1",INPUT:"2",EDITOR:"3",DIV:"4"},e.zmAutoCompleteSystem=d}(),function(){var e=zmail.Core.Namespaces.create("zmContactsAutoComplete"),n=zmail.Components.AutoComplete.System.AbstractAutoCompleteSystem,o=zmail.Utils.DOM,s=zmContactsAutoComplete.zmAutoCompleteSystem;e.autoComplete=function(e){var t=(e=e||{}).input,r=new s;return"INPUT"===o.element(t,!0).nodeName?r.inputType=s.INPUTS.INPUT:"TEXTAREA"===o.element(t,!0).nodeName?r.inputType=s.INPUTS.TEXTAREA:t.editor?r.inputType=s.INPUTS.EDITOR:t.contenteditable&&(r.inputType=s.INPUTS.DIV),r.excludeMe=e.excludeMe||!1,r.exclude=e.exclude,r.includeAllGroups=e.includeAllGroups||!1,r.includeEmailedGroups=e.includeEmailedGroups||!1,r.excludeGroups=e.excludeGroups||!1,r.disable=e.disable||!1,r.showGroup=e.showGroup,r.contactType=e.contactType,r.setDebounce=e.setDebounce,r.inputInstance=e.inputInstance,r.hideEmailId=e.hideEmailId,r.includeOnly=e.includeOnly,r.prioritizeAllGroupMembers=e.prioritizeAllGroupMembers,r.prioritizeGroupMembers=e.prioritizeGroupMembers,r.init({inputElement:t,parentDOM:document.body}),o.element(r).on(n.EVENTS.ITEM_SELECTED,e.onSelect),o.element(r).on(s.EVENTS.LIST_SHOWN,e.listShown),o.element(r).on(s.EVENTS.LIST_HIDDEN,e.listHidden),r}}();
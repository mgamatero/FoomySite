"use strict";!function(){var e=zmail.Core.Namespaces.create("zmHashTagAutoComplete"),s=zmail.Utils.DOM,t=zmail.Components.AutoComplete,a=t.System.AbstractTrigger,n=t.Utils,r=/(?:^[#]{1}([^\s]+))/i,l=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"textChangeAction",value:function(){var e=this,t=e._input.getCurrentTypingWord();if(/\s$/.test(t))e.publishNegativeTriggerEvent();else{e.currentText=t,r.lastIndex=0;var a=r.exec(t);if(a){var s=a[1]||"";e.publishTriggerEvent({searchToken:s})}else e.publishNegativeTriggerEvent()}}},{key:"bindEvents",value:function(){var e,t=this,a=t._input;t._textChangeEventHandler=t._textChangeEventHandler.bind(t),t._textChangeEventHandler=n.debounce(t._textChangeEventHandler,0),e=t._textChangeEventHandler,s.element(a).on("textchange",e)}}]),t}(a);e.HashTagTrigger=l}(),function(){var e=zmail.Core.Namespaces.create("zmHashTagAutoComplete"),s=zmail.Utils.DOM,t=function(e){function a(){var e;return babelHelpers.classCallCheck(this,a),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(a).call(this)),babelHelpers.assertThisInitialized(e).popUp=!0,e}return babelHelpers.inherits(a,e),babelHelpers.createClass(a,[{key:"getTemplate",value:function(){return zdom("div",{ref:"wrapper",className:"SC_dd shw"},zdom("div",{className:"scrlldiv zmDDScroll"},zdom("ul",{ref:"listWrapper"})))}},{key:"getScrollWrapperDOM",value:function(){return this.refs.listWrapper}},{key:"handleListSpaceOverflow",value:function(e){e=e||{};var t=this.getScrollWrapperDOM();s.setStyle(t,{height:e.height+"px"})}},{key:"positionComponent",value:function(e){var t=this.getScrollWrapperDOM();return s.setStyle(t,{height:"auto"}),babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"positionComponent",this).call(this,e)}},{key:"_mouseDownHandler",value:function(e){this.mouseDown=!0,_zm.stopEvents(e)}},{key:"show",value:function(){var e=this;babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"show",this).call(this),e.popUp?s.setStyle(e.dom,{"z-index":"105"}):s.setStyle(e.dom,{"z-index":""}),s.show(e.dom)}},{key:"hide",value:function(){babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"hide",this).call(this),s.hide(this.dom)}}]),a}(zmail.Components.AutoComplete.System.AbstractListComponent);e.HashTagListComponent=t}(),function(){var e=zmail.Core.Namespaces.create("zmHashTagAutoComplete"),t=zmail.Components.AutoComplete.System.AbstractListItemComponent,o=zmail.Utils.DOM,i=function(a,e,s,n){n=n||{},o.clearHTML(a),function(e,t,a){e=e||"";var s=[];if(!(t=t||""))return s=e?[e]:[];var n=e;(a=a||{}).caseSensitive||(t=t.toLowerCase(),n=n.toLowerCase());var r,l,o=-1;for(r=0,l=e.length;r<l&&-1!==(o=n.indexOf(t,r));r++)0!==o&&s.push(e.substring(r,o)),s.push(e.substring(o,o+t.length)),r=o+t.length-1;return r<l&&s.push(e.substring(r)),s}(e,s,n).forEach(function(e){var t=function(e,t,a){a=a||{};var s=o.element(zdom("span",null));return s.text(e),a.caseSensitive||(t=t.toLowerCase(),e=e.toLowerCase()),t===e&&s.addClass("afHgl"),s}(e,s,n);o.mount(t,a)}),o.setAttribute(a,{title:e})},a=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getTemplate",value:function(){return zdom("li",{ref:"wrapper"},zdom("span",{ref:"text"}))}},{key:"render",value:function(e,t){var a=this;t=t||{},a._preRender(e),a.state.searchWord=t.searchWord||a.state.searchWord||"";var s=e.attributes,n="SC_Psli";a.state.selected?o.addClass(a.refs.wrapper,n):o.removeClass(a.refs.wrapper,n);var r=a.state.searchWord,l=s.text||"";o.clearHTML(a.refs.text),i(a.refs.text,l,r),a._postRender()}}]),t}(t);e.HashTagListItemComponent=a}(),function(){var e=zmail.Core.Namespaces.create("zmHashTagAutoComplete"),t=zmail.Components.AutoComplete,a=t.System.AbstractListItemComponentFactory,s=t.System.AbstractListItemModel,n=zmHashTagAutoComplete.HashTagListItemComponent,r=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"createComponent",value:function(e){if(e instanceof s)return new n}}]),t}(a);e.HashTagListItemComponentFactory=r}(),function(){var e=zmail.Core.Namespaces.create("zmHashTagAutoComplete"),t=zmail.Components.AutoComplete,a=t.System.AbstractDataProvider,u=t.System.AbstractListItemModel,s=function(e){function a(){var e;babelHelpers.classCallCheck(this,a),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(a).call(this));var t=babelHelpers.assertThisInitialized(e);return t.searchResultLimit=10,t.priority=5,e}return babelHelpers.inherits(a,e),babelHelpers.createClass(a,[{key:"destroy",value:function(){babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"destroy",this).call(this),this.searchResultLimit=null,this.priority=null}},{key:"searchData",value:function(e){var r=this,l=(e.searchToken||"").toLowerCase(),o=null,i=null;o=(e=e||{}).collection,i=e.deferred,l?zmStreamsApp.GroupApp.fetchHashTags(zmail.zuid,"",function(e){if(e&&e.length)for(var t=0,a=e.length;t<a&&o.length<=r.searchResultLimit;t++){var s=(e[t].name||"").toLowerCase();if(0===s.indexOf(l)){var n=new u({text:s,id:s});o.add(n)}}i.resolve()}):i.reject()}}]),a}(a);e.HashTagDataProvider=s}(),function(){var e=zmail.Core.Namespaces.create("zmHashTagAutoComplete"),t=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"accumulateData",value:function(e){var t=this;e.collectionList.forEach(function(e){t.dataCollection.add(e.models)}),t.triggerAccumulationComplete()}}]),t}(zmail.Components.AutoComplete.System.AbstractDataAccumulator);e.HashTagDataAccumulator=t}(),function(){var e=zmail.Core.Namespaces.create("zmHashTagAutoComplete"),a=zmail.Utils.DOM,s=zmail.Components.AutoComplete,t=s.System.BaseHTMLEditableAutoCompleteSystem,n=s.System.AbstractHTMLTextArea,r=zmHashTagAutoComplete.HashTagDataProvider,l=zmHashTagAutoComplete.HashTagListComponent,o=zmHashTagAutoComplete.HashTagListItemComponentFactory,i=zmHashTagAutoComplete.HashTagTrigger,u=zmHashTagAutoComplete.HashTagDataAccumulator,p={LIST_SHOWN:"listShown",LIST_HIDDEN:"listHidden",CLICK:"click",ITEM_SELECTED:"itemSelected"},c=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"initUserInput",value:function(e){var t=this,a=e.inputElement;switch(t.inputType){case"1":t.userInput=new n,t.userInput.init(a);break;case"3":case"4":t.userInput=a}}},{key:"createDataProviders",value:function(){return[new r]}},{key:"createTrigger",value:function(){return new i}},{key:"createDataAccumulator",value:function(){return new u}},{key:"createListComponent",value:function(){return new l}},{key:"createListItemComponentFactory",value:function(){return new o}},{key:"invokeDataProviderSearch",value:function(t){var e=this,a=e.dataProviders;e.dataAccumulator.dataCollection.reset(null),e.listModel.resetData(),e.disable||(e.listModel.set({currentSearchKey:t.searchToken},{silent:!0}),a.forEach(function(e){e.getData({searchToken:t.searchToken,trigger:t.trigger})}))}},{key:"showComponent",value:function(){var e=this;if(e.dataAccumulator.dataCollection.length){var t=e.userInput.getListAnchorBounds();t.top-=e.userInput._element.scrollTop,t.bottom-=e.userInput._element.scrollTop,e.listComponent.positionComponent({anchorBounds:t}),e.listComponent.listItemComponents[0].model.set("selected",!0),e.listComponent.show(),a.element(e).triggerHandler(p.LIST_SHOWN),s.Utils.autoCompleteListsShown({instance:e})}}},{key:"hideComponent",value:function(){var e=this;e&&e.listComponent&&(e.listComponent.hide(),a.element(e).triggerHandler(p.LIST_HIDDEN),s.Utils.autoCompleteListsShown({instance:e,hide:!0}))}},{key:"listItemSelectAction",value:function(e){var t=this;t.isSelectActionProgress||(t.isSelectActionProgress=!0,a.element(t).triggerHandler(p.ITEM_SELECTED,{item:e.listItemModel}),t.isSelectActionProgress=!1,setTimeout(function(){t.cancelAutoComplete()},0))}},{key:"_inputClickHandler",value:function(){this.hideComponent()}},{key:"bindEvents",value:function(){a.element(this.userInput._element).on(p.CLICK,this._inputClickHandler.bind(this)),babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"bindEvents",this).call(this)}},{key:"unbindEvents",value:function(){a.element(this.userInput._element).off(p.CLICK,this._inputClickHandler),babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"unbindEvents",this).call(this)}}]),t}(t);c.INPUTS={TEXTAREA:"1",EDITOR:"3",DIV:"4"},c.EVENTS=p,e.HashTagAutoCompleteSystem=c}(),function(){var e=zmail.Core.Namespaces.create("zmHashTagAutoComplete"),s=zmail.Components.AutoComplete.System.AbstractAutoCompleteSystem,n=zmHashTagAutoComplete.HashTagAutoCompleteSystem,r=zmail.Utils.DOM;e.HashTagAutoComplete=function(e){var t=(e=e||{}).input,a=new n;return"TEXTAREA"===r.element(t,!0).nodeName?a.inputType=n.INPUTS.TEXTAREA:t.editor?a.inputType=n.INPUTS.EDITOR:t.contenteditable&&(a.inputType=n.INPUTS.DIV),a.disable=e.disable||!1,a.inputInstance=e.inputInstance,a.init({inputElement:t,parentDOM:document.body}),r.element(a).on(s.EVENTS.ITEM_SELECTED,e.onSelect),r.element(a).on(n.EVENTS.LIST_SHOWN,e.listShown),r.element(a).on(n.EVENTS.LIST_HIDDEN,e.listHidden),a}}();
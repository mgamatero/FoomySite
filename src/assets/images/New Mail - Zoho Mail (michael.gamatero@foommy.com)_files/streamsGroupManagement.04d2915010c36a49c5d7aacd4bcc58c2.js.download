"use strict";window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=zmStreamsApp.GroupManageApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp.ajaxReq={sync:function(e,t,a){(a=a||{}).type=a.type||"POST",a.url=_.result(t,"url"),a.data=t.serialized(e,a),a.setSessionId=a.setSessionId||!1;var r=a.xhr=this.ajax(a);return t.trigger("request",t,r,a),r},ajax:function(e){var t=e.url,a=(new Date).getTime(),r="get"===e.type.toLowerCase();r&&(t=t+(t.indexOf("?")+1?"&":"?")+"xhr="+a);var i=e.data,s={url:t,type:e.type||"POST"};return r||(s.contentType="application/json"),e.noStringify&&(s.data=i,s.contentType=!1,s.processData=!1,s.cache=!1),i&&!e.noStringify&&(s.data=JSON.stringify(i)),e.noStringify||(s.dataType="json"),e.header?s.headers={"X-ZCSRF-TOKEN":"zmrcsr="+zmAjq.getCookie("zmcsr")}:i.zmrcsr=zmAjq.getCookie("zmcsr"),e.setSessionId&&zmail.isWSEnabled&&zmail._ws&&zmail._ws.getSessionId()&&(s.headers||(s.headers={}),s.headers.sId=zmail._ws.getSessionId()),$.ajax(s)}},window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({});var urls={groupUrl:zmail.urls.accURL+"/u/h#groups/allgroups"};window.zmStreamsApp.GroupManageApp.urls=urls,window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=function(S){var C=zmText.get("streams"),M=S.models,i=S.views,A=zmStreamsApp.constants;S.template=zmStreamsApp.GroupManageApp.template,S.imageInput=void 0,S.domainList=void 0,S.isorgadmin=zmail.isAdmin,S.isMailHostingEnabled=void 0,S.groupCount=0,S.groupMode="",S.createMode="",S.fromApp="",S.createCallback="",S.closeWorkspace=!1,S.activeGroups=[],S.isOnboard=!1;var r={};S.groupPermission={};var b,G=zmStreamsApp.GroupManageApp.ajaxReq,w=!0,k=".filterLHS",y=".filterList",N=".groupClass",x=".descClass",D=".membersClass",L=".domainList select",u=".createButton",o=".textChange",d=".switchTxt",l="flVR vrFail",E=".headerContainer",O=".groupCount",c=".viewContainer",f=".createGroup",v=".mainContainer",T=".toggleSel";S.dataViewList=[];var I=".groupHolder",g=".autoFilldata",V=function(){var e=zmsuite.getCenter(A.groupWorkId)[0].getNodes();S.removeGroupViews(e[2].$el.find(I).find("div.groupDom")),b&&b.dataProviders&&b.destroy(),$.publish(zmStreamsApp.constants.removeNotificationPreview,{element:zmsuite.getCenter(A.groupWorkId)[0].$el[0]}),S.fromApp="",S.createCallback="",S.closeWorkspace=!1,S.activeGroups=[],S.groupCount=0,S.groupMode="",S.createMode="",S.imageInput=void 0,r={},S.groupPermission={}},B=function(e,t){var a=zmsuite.getCenter(A.groupWorkId)[0].$el;a&&(a=a.find(I)),t=t||a;var r=new i.GroupManage({model:e});t.find("#addGroup").length&&(_zm.clearHTML(t[0]),t[0].appendChild(r.$el)),e.get("isOwner")?t.prependDOM(r.$el):t.appendDOM(r.$el)},H=function(t){var e;return t&&M.lists&&(e=_.find(M.lists.models,function(e){return String(e.id)===String(t)})),e};"undefined"!=typeof zmComponent&&zmComponent.notifier&&zmComponent.notifier.addHandler("streams",function(e,t){"string"==typeof t.group&&(t.group=$.parseJSON(t.group)),"string"==typeof t.shgroups&&(t.shgroups=$.parseJSON(t.shgroups)),t.group=t.group||{};var a=_.size(t.shgroups)?t.shgroups:[t.group];if(a&&_.size(a)){var r,i,s=A.notifications,n=t.ntype,o=!1,d=[s.mail_type,s.post_mention,s.unshared,s.invite,s.add_post,s.add_comment,s.comment_mention,s.add_task,s.post_group_mention,s.comment_group_mention,s.add_event,s.update_event,s.add_group_member,s.mail_share,s.add_attachment,s.change_task_due_date,s.change_task_assignee,s.change_task_status,s.change_task_priority,s.change_task_category,s.change_task_title,s.change_task_description,s.remove_attachment,s.draft_share,s.draft_shareupdate,s.draft_autosave,s.draft_mailmention,s.add_link],l=[s.add_comment,s.comment_group_mention,s.comment_mention];if(-1!==d.indexOf(n)&&t.nby!==zmail.zuid&&(o=!0),-1!==l.indexOf(n)&&t.nby!==zmail.zuid&&(o=!0),zmsuite.isWorkspaceAvailable(A.groupWorkId)&&o)for(var m in a)i=a[m],(r=H(i.id))&&r.get("hidden")&&(r.set("lastActivityAt",(new Date).toString()),r.trigger("change:showActivity"))}}),$.subscribe("streams/removeGroupMember",function(e,a){var t=H(a.gid);if(t){var r=t.get("members"),i=t.get("moderators"),s=t.get("totalMembers"),n=[],o=[];_.each(r,function(e,t){e.id!==a.zid&&n.push(e)}),_.each(i,function(e,t){e.id!==a.zid&&o.push(e)}),t.set("members",n),t.set("moderators",o),s-=1,t.set("totalMembers",s),zmsuite.isWorkspaceAvailable(A.groupWorkId)&&S.groupMode&&t.trigger("change:memberList")}}),$.subscribe("streams/addGroupMember",function(e,t){var a=H(t.gid);if(a){var r=a.get("members");if(-1===_.pluck(r,"id").indexOf(t.zid)){var i=a.get("totalMembers"),s=zmStreamsApp.util.getContactDetails([t.zid])[t.zid],n={emailAddress:s.eid,name:s.fn,id:s.zid};r.push(n),a.set("members",r),i+=1,a.set("totalMembers",i),zmsuite.isWorkspaceAvailable(A.groupWorkId)&&S.groupMode&&a.trigger("change:memberList")}}}),$.subscribe("streams/addRemGroupSelf",function(e,t){var a;if(t.isAdd){var r=new M.listGroup({id:t.gid});G.sync("getGroupDetail",r).done(function(e){if(200===e.status.code){M.lists||(M.lists=new M.listGroupCollection);var t=e.data;r=M.lists.addModel(t),zmTab.currentTab===A.groupWorkId&&B(r)}})}else(a=H(t.gid))&&a.trigger("change:deleteGroup")}),$.subscribe("streams/changeMemberRole",function(e,a){var t=H(a.gid);if(t){var r=t.get("moderators"),i={},s=t.get("isOwner");if("addModerator"===a.mode){var n=zmStreamsApp.util.getContactDetails([a.zid])[a.zid];i={emailAddress:n.eid,name:n.fn,id:n.zid},r.push(i),t.set("moderators",r),a.zid===zmail.zuid&&(s=!0)}else i=[],_.each(r,function(e,t){e.id!==a.zid&&i.push(e)}),t.set("moderators",i),a.zid===zmail.zuid&&(s=!1);t.set("isOwner",s),zmsuite.isWorkspaceAvailable(A.groupWorkId)&&S.groupMode&&a.zid===zmail.zuid&&t.trigger("change:memberRole")}}),S.removeGroupViews=function(e,a){var r;_.each(e,function(e){r=$.e(e).data();var t=H(r.id);t&&t.getView(r.groupviewid).onClose(a)})},S.triggerEditGroup=_.debounce(function(e,t){zmModules.getMemberViewModule().then(function(e){var t=e.constructMemberPopup,a=e.resetMemberValues,r=e.addMemberDialog,i=e.memberText,s=e.getUserDetails;zmStreamsApp.GroupManageApp.assignFunction({constructMemberPopup:t,resetMemberValues:a,addMemberDialog:r,memberText:i,getUserDetails:s})}),e=String(e);var a=H(e);if(!a){var r=zmail.ContactBook.getGroups(e);r=r[0]&&r[0].attrs?r[0].attrs:{},a=new M.listGroup({id:e,name:r.name,moderators:r.modArr,members:r.memArr})}return new i.GroupManage({model:a,editGroup:!0,tabObj:t})},100),S.hideGroup=function(e){var t=H(e);if(!t){var a=zmail.ContactBook.getGroups(e);a=a[0]&&a[0].attrs?a[0].attrs:{},t=new M.listGroup({id:e,name:a.name,hidden:a.hidden})}var r=t.get("hidden");t.set("hidden",!r),G.sync("update",t).done(function(){zmStreamsApp.GroupManageApp.editGroupDetails(t),r?zmUtil.succErrMsg("s",zmText.applyArgs(C.groupSubscription.editGrp.showMsg,{gName:t.get("name")})):zmUtil.succErrMsg("s",zmText.applyArgs(C.groupSubscription.editGrp.hiddenMsg,{gName:t.get("name")})),$.publish("group/showHideGroup",{id:t.id,hidden:!r})}).fail(function(e){e.length&&(e=$.parseJSON(e)),zmUtil.succErrMsg("e",e.status.description),t.set("hidden",r)})};var z=function(e,t){for(var a=_.pluck(e,"id"),r=0,i=0;i<t.length;i++)for(var s=0;s<a.length;s++)t[i]===a[s]&&r++;return r===t.length},h=function(r,i,e){if(w=!1,!$.e(r).hasClass("zs_snd")){var t,a,s,n=i.find(N),o=i.find(x),d=i.find(D),l=S.imageInput[0].files[0],m=i.find(T),p="",u="",c="";if(t=zmStreamsApp.GroupManageApp.checkGroupName(n,M.lists.toJSON()),a=zmStreamsApp.GroupManageApp.checkMembers(d,e),s=zmStreamsApp.GroupManageApp.checkDescription(o),m.length&&m.hasClass("on")){p=i.find(".userName").val(),u=i.find(L).val();var g=zmUtil.hasXSSChars(p);if(""===p.trim()||""===u.trim()||g){var f="";return f=g?C.groupSubscription.errMsg.emailSplChar:C.groupSubscription.errMsg.validEmail,zmUtil.succErrMsg("e",f),void i.find(".userName").focus()}c=p+"@"+u}if(s&&t&&a){var v=zmStreamsApp.GroupManageApp.getMembersAddress(e),z={name:$.trim(n.val()),desc:$.trim(o.val()),mzuid:v};c&&""!==c&&(z.emailAddress=c),zmStreamsApp.util.sendRemove($.e(r),"",C.streams.common.creating+"...");var h=new M.listGroup(z);G.sync("createGroup",h).done(function(e){if(200===e.status.code){M.lists||(M.lists=new M.listGroupCollection);var t=e.data;if(h=M.lists.addModel(t),S.addGroupToContacts(h.toJSON()),zmTab.currentTab===A.groupWorkId&&(_zm.clearHTML(i[0]),w=!0,b&&b.dataProviders&&b.destroy(),S.constructGroupView()),l){var a=h.get("photo");h.set("photo",l),G.sync("updateLogo",h).done(function(e){200===e.status.code&&(h.set("photo",e.data.photo),h.trigger("change:changepreview"))}).fail(function(e){h.set("photo",a),e&&(e=$.parseJSON(e)),e&&e.status.description?zmUtil.succErrMsg("e",e.status.description):zmUtil.succErrMsg("e",C.groupSubscription.errMsg.errLogoUpload)})}S.createCallback&&(S.createCallback(t.id),S.closeWorkspace&&(V(),zmsuite.closeWorkspace(A.groupWorkId)))}}).fail(function(e){zmStreamsApp.util.sendRemove($.e(r),!0,C.groupSubscription.creategrp);var t=C.groupSubscription.errMsg;if(e.responseText){var a=(e=$.parseJSON(e.responseText)).status.description;-1!==a.indexOf("G113")?zmUtil.succErrMsg("e",t.privilegeErr):-1!==a.indexOf("G119")?zmUtil.succErrMsg("e",t.maxGrpErr):zmUtil.succErrMsg("e",a)}else e&&((e=$.parseJSON(e))&&e.status.description?zmUtil.succErrMsg("e",e.status.description):zmUtil.succErrMsg("e",t.errcreate))})}}},t=function(t){var a=t.find(u),r=t.find(g),e=C.groupSubscription.createGrp,i=t.find(N),s=t.find(x),n=t.find(D),o=zmStreamsApp.GroupManageApp.checkGroupName(i,M.lists.toJSON()),d=zmStreamsApp.GroupManageApp.checkMembers(n,r);if(zmStreamsApp.GroupManageApp.checkDescription(s)&&o&&d&&1<S.groupCount&&w){var l=function(e,t){if(e.length<1)return!1;e.push(zmail.zuid);for(var a=[],r=[],i=0;i<t.length;i++)(a=t[i]).members.length===e.length&&z(a.members,e)&&r.push(a);return r}(zmStreamsApp.GroupManageApp.getMembersAddress(r),M.lists.toJSON());if(l.length){var m=zdom("h2",{className:"cs_main_header SC_thm"},e.simGrpHeader),p={ignoreMouseDown:!1,$content:$.e(m),defaultCloseIcon:!1,dialogDidMount:function(e){var t=$.e(e.$els.$content);if(t.appendDOM(S.template.getSimilarGroup(l)),5<l.length){$.e(e.$els.$positionWrapper).addClass("SC_PopTop");$.e(e.$els.$positionWrapper).css("top","40px"),t.css("max-height",.7*$.e(window).height())}t.find(".moreOpt").bind("click",function(){var e=t.find("ul.ulDom");_zm.clearHTML(e[0]),S.template.constUlGroup(e[0],l,!0)})},buttons:[{name:C.groupSubscription.proceed,callback:function(e){h(a,t,r),e.remove()}},{name:C.common.labels.cancel,isCancel:!0,callback:function(e){e.remove()}}]};Dialog.new(p)}else h(a,t,r)}else h(a,t,r)},s=function(e,t){var s,n,a=t.find(g);e.unbind("focusin").bind("focusin",function(){$.e(this).parent().addClass("flBoxF")}).unbind("focusout").bind("focusout",function(){zmStreamsApp.GroupManageApp.checkMembers($.e(this),a)}),s=e,n=t,b=zmContactsAutoComplete.autoComplete({input:s[0],exclude:function(){var e=zmStreamsApp.GroupManageApp.getMembersAddress(n.find(g));return(e=e.length?e:[]).push(zmail.zuid),e},contactType:"org",excludeGroups:!0,setDebounce:0,onSelect:function(e,t){e.stopPropagation();var a=t.item.attributes,r=S.template.autoFillData(a.zid),i=n.find(g);i.appendDOM($.e(r)),1===i.children().length&&(i.removeClass("SC_dyn"),zmStreamsApp.GroupManageApp.checkMembers(s,i)),$.e(s).val(""),$.e(r).find(".closePopup").unbind("click").bind("click",function(){$.e(this).parent(".dFill").remove(),i.children().length||(i.addClass("SC_dyn"),s.focus())}),s.focus()}})},m=function(a){var r=a,i=$.e(r.find(u));$.e(r.find(".imgLogo")).attr("tabindex",10),$.e(r.find(N)).attr("tabindex",11),$.e(r.find(D)).attr("tabindex",12),$.e(r.find(x)).attr("tabindex",13);var s=$.e(r.find(T));s.length&&s.attr("tabindex",13),i.attr("tabindex",14),s.unbind("keydown").bind("keydown",function(e){if(13===e.keyCode&&zmStreamsApp.GroupManageApp.validateIncludeEmail()){var t=a.find(".emailBox");s.toggleClass("off").toggleClass("on"),s.hasClass("on")?(s.find(o).text(C.groupSubscription.createGrp.yes),s.find(d).attr("style","left:40px")):(s.find(o).text(C.groupSubscription.createGrp.no),s.find(d).removeAttr("style")),t.toggle(),t.is(":visible")?(r.find(".userName").attr("tabindex",14),r.find(L).attr("tabindex",15),i.attr("tabindex",16),r.find(".userName").focus()):i.attr("tabindex",14)}}),$.e(i).unbind("keydown").bind("keydown",function(e){9===e.keyCode?($.e(r.find(".imgLogo")).focus(),e.preventDefault()):13===e.keyCode&&t(r)})},n=function(e){var t=S.imageInput[0].files[0],a=zmAttachComponent.utility.createObjectURL(t);e.removeClass().addClass("SC_avtr imgLogo");var r=S.template.addImageDiv();_zm.clearHTML(e[0]),e[0].appendChild(r),$.e(r).removeAttr("style"),e.find(".logoImg")[0].src=a,e.appendDOM(S.template.editImageDiv())},p=function(r,e,i){S.imageInput.change(function(){var t,e,a;$.e(this).val()&&(t=r,e=i,"success"===(a=zmStreamsApp.GroupManageApp.checkLogo(S.imageInput)).type?e?(_zm.succErrMsg("s",C.groupSubscription.editGrp.uploading),e(S.imageInput[0].files[0]).done(function(e){e||(_zm.succErrMsg("s",C.groupSubscription.editGrp.uploaded),n(t))})):n(t):_zm.succErrMsg("e",a.message))})};S.bindGroupLogo=function(e,t){var a=e.find(".imgLogo");S.imageInput=$.e(S.template.groupLogo()),$.e(a).unbind("click").bind("click",function(){S.imageInput.click()}),$.e(a).unbind("keydown").bind("keydown",function(e){13===e.keyCode&&S.imageInput.click()}),p(a,e.find(".logoImg"),t)};var P=function(a){var e,n;e=a.find(N),n=a,e.unbind("focusin").bind("focusin",function(){$.e(this).parent().addClass("flBoxF")}).unbind("focusout").bind("focusout",function(){if(zmStreamsApp.GroupManageApp.checkGroupName($.e(this),M.lists.toJSON())&&!n.find(".logoImg")[0].src){var e=n.find(".SC_avtr"),t=$.e(this).val(),a=zmStreamsApp.util.generateAvatarTemp(t);$.e(a).addClass("imgLogo"),$.e(a).insertDOMBefore($.e(e)),$.e(e[0]).remove();var r=S.template.addImageDiv();$.e(a).appendDOM(r),$.e(a).appendDOM(S.template.editImageDiv()),S.bindGroupLogo(n),m(n)}var i=n.find(".userName");if(i.length&&""===i.val()){var s=$.trim($.e(this).val());s=s.replace(/ /gi,"_"),i.val(s),i.parent().removeClass(l)}}),a.find(x).unbind("focusin").bind("focusin",function(){$.e(this).parent().addClass("flBoxF")}).unbind("focusout").bind("focusout",function(){zmStreamsApp.GroupManageApp.checkDescription($.e(this))}),s(a.find(D),a),S.bindGroupLogo(a),m(a),a.find(N).focus(),a.find(u).unbind("click").bind("click",function(){t(a)}),a.find(T).unbind("click").bind("click",function(){var e=$.e(this);e.toggleClass("off").toggleClass("on"),e.hasClass("on")?(e.find(o).text(C.groupSubscription.createGrp.yes),e.find(d).attr("style","left:40px")):(e.find(o).text(C.groupSubscription.createGrp.no),e.find(d).removeAttr("style"));var t=a.find(".emailBox");t.toggle(),t.is(":visible")?(a.find(".userName").attr("tabindex",14),a.find(L).attr("tabindex",15),a.find(u).attr("tabindex",16),a.find(".userName").focus()):a.find(u).attr("tabindex",14)}),a.find(".userName").unbind("focusin").bind("focusin",function(){$.e(this).parent().addClass("flBoxF")}).unbind("focusout").bind("focusout",function(){$.e(this).parent().removeClass("flBoxF");var e=$.trim($.e(this).val()),t=zmUtil.hasXSSChars(e);!e||t?$.e(this).parent().addClass(l):$.e(this).parent().removeClass(l)}),a.find(".addGrpMem").unbind("click").bind("click",function(){S.importMembersFromGroup(a)})},U=function(e,t){var a=$.e(e).width(),r=e.find(".zmMSL")[0],i=$.e(r).width()+40,s=a-i*t;0<s&&i<s?e.addClass("zmMSboxL"):e.removeClass("zmMSboxL")},W=function(e){var t=zmsuite.getCenter(A.groupWorkId)[0].$el.find(I);if(S.groupCount=e.length,S.groupCount){_zm.clearHTML(t[0]);var a,r,i=[],s=[],n=[];for(e.each(function(e){(r=e.get("isOwner"))&&e.get("streamsEnabled")?i.push(e):r?s.push(e):n.push(e)}),a=0;a<n.length;a++)B(n[a],t);for(a=0;a<s.length;a++)B(s[a],t);for(a=0;a<i.length;a++)B(i[a],t);U(t,S.groupCount)}else{_zm.clearHTML(t[0]),t.removeClass("zmMSboxL");var o=S.groupPermission;if(!_.size(o)||o.Org||o.personal){var d=$.e(zdom("a",null)).attr({href:"#",id:"addGroup"}).text(C.groupSubscription.creategrp),l=$.e(zdom("span",null)).text(C.groupSubscription.grpNtAvl+". ");t.appendDOM(l).appendDOM(d),$.q("#addGroup").click(function(){"-1"===zmail.zoid?window.open(zmStreamsApp.GroupManageApp.urls.groupUrl,"_blank"):S.constructCreateView()})}else{var m=$.e(zdom("span",null)).text(C.groupSubscription.errMsg.privilegeErr);t.appendDOM(m)}}var p=zmsuite.getCenter(A.groupWorkId)[0].getNodes()[1].$el.children()[0],u=$.e(p).find(E),c=S.groupCount?S.groupCount:C.groupSubscription.no;u.find(O).text(c+" "+C.groupSubscription.grp)},R=function(e,t){var r=[];switch(e){case"disabled":_.filter(t,function(e){e.streamsEnabled||-1===S.activeGroups.indexOf(e.id)||e.hidden||r.push(e)});break;case"enabled":_.filter(t,function(e){e.streamsEnabled&&!e.hidden&&r.push(e)});break;case"personal":_.filter(t,function(e){e.organizationGroup||r.push(e)});break;case"orgemail":_.filter(t,function(e){e.organizationGroup&&e.emailAddress&&r.push(e)});break;case"orgntemail":_.filter(t,function(e){e.organizationGroup&&!e.emailAddress&&r.push(e)});break;case"mod":_.filter(t,function(e){var t=_.pluck(e.moderators,"id"),a=e.createdBy;!(a&&a.id===zmail.zuid)&&t.includes(zmail.zuid)&&r.push(e)});break;case"mem":_.filter(t,function(e){e.isOwner||r.push(e)});break;case"owner":_.filter(t,function(e){var t=e.createdBy;t&&t.id===zmail.zuid&&r.push(e)});break;case"hidden":_.filter(t,function(e){e.hidden&&r.push(e)});break;case"streamsDis":_.filter(t,function(e){e.streamsEnabled||-1!==S.activeGroups.indexOf(e.id)||e.hidden||r.push(e)})}return r},F=function(e){if(_.size(e)){var a=zmsuite.getCenter(A.groupWorkId)[0].$el,t=a.find(I);S.removeGroupViews(t.find(".groupDom"),!0),_zm.clearHTML(t[0]);var r,i=M.lists,s=e.txt||"",n=function(){for(var e=M.lists.toJSON(),t=_zm.copyOf(e),a=["enabled","disabled","hidden","streamsDis"],r=0,i=[];r<S.dataViewList.length;r++)a.includes(S.dataViewList[r])?(i=i.concat(R(S.dataViewList[r],t)),e=_zm.copyOf(i)):(t=_zm.copyOf(e),e=R(S.dataViewList[r],t),t=_zm.copyOf(e));return e=_.pluck(e,"id"),_.uniq(e)}(),o=n.length;t.data("view",e.item);var d=zmsuite.getCenter(A.groupWorkId)[0].getNodes()[1].$el.children()[0],l=$.e(d).find(E),m=a.find(y),p=e.removeView;if(p)for(var u,c=0;c<p.length;c++)u=p[c],m.find("div[data-val="+u+"]").remove();if("all"!==e.item&&("AllType"!==e.item&&"AllRole"!==e.item||S.dataViewList.length))if(S.dataViewList.length){if(o){for(var g=0;g<o;g++)r=H(n[g]),B(r,t);U(t,o)}else _zm.clearHTML(t[0]),t[0].appendChild(zmInit.emptyRow(C.groupSubscription.nogrp)),t.removeClass("zmMSboxL");var f=n.length?n.length:C.groupSubscription.no;if(l.find(O).text(f+" "+C.groupSubscription.grp),p&&p.includes(e.item))return;if("AllType"!==e.item&&"AllRole"!==e.item){var v=S.template.constructTokenWrap(s,e.item);m.appendDOM(v);var z=["personal","orgemail","orgntemail"],h=["owner","mod","mem"],b=["enabled","disabled","hidden","streamsDis"];$.e(v).find(".closeIcon").off("click").on("click",function(){var e=$.e(this).parents(".tokenParent").data("val"),t=a.find(k);z.includes(e)?t.find("div[data-val=AllType]").click():h.includes(e)?t.find("div[data-val=AllRole]").click():b.includes(e)&&t.find("div[data-val="+e+"]").click()})}}else W(i),m.children().remove();else W(i),"all"===e.item&&m.children().remove()}},J=function(e){var t=zmsuite.getCenter(A.groupWorkId)[0].getNodes()[2].$el,a=t.find(k),r=C.streams.common.all;a&&(a.children().remove(),a.removeClass("zmHideD"),t.find(y).children().remove());for(var i=[{name:C.groupSubscription.type,value:[r,C.groupSubscription.perGrp,C.groupSubscription.orgEmail,C.groupSubscription.orgNtEmail],type:"radio",data:["AllType","personal","orgemail","orgntemail"],defValue:"AllType"},{name:C.groupSubscription.role,value:[r,C.common.labels.owner,C.common.labels.moderator,C.common.labels.member],type:"radio",data:["AllRole","owner","mod","mem"],defValue:"AllRole"},{name:C.groupSubscription.status,value:[C.groupSubscription.enGrp,C.groupSubscription.disGrp,C.groupSubscription.hiddenGrp].concat(babelHelpers.toConsumableArray(zmail.showFeature?[C.groupSubscription.streamsNtEn]:"")),data:["enabled","disabled","hidden","streamsDis"],type:"checklist"}],s="msi-option zmThmClr",n="msi-unoption",o=0;o<i.length;o++)a.appendDOM(S.template.constructRadioButtonList(i[o]));if(a.find(".expandCollapse").off("click").on("click",function(){$.e(this).next().slideToggle(),$.e(this).children("i").toggleClass("msi-prev msi-next")}),a.find(".radioButton").off("click").on("click",function(){var e=$.e(this);if(!e.find("i").hasClass(s)){e.parents(".parentClass").find("i").removeClass(s).addClass(n),e.find("i").removeClass(n).addClass(s);var t,a=e.data("val");switch(a){case"AllRole":S.dataViewList=_.without(S.dataViewList,"owner","mod","mem"),t=["owner","mod","mem"];break;case"owner":S.dataViewList=_.without(S.dataViewList,"mod","mem"),t=["mod","mem"],S.dataViewList.push(a);break;case"mod":S.dataViewList=_.without(S.dataViewList,"owner","mem"),t=["owner","mem"],S.dataViewList.push(a);break;case"mem":S.dataViewList=_.without(S.dataViewList,"owner","mod"),t=["owner","mod"],S.dataViewList.push(a);break;case"AllType":S.dataViewList=_.without(S.dataViewList,"personal","orgemail","orgntemail"),t=["personal","orgemail","orgntemail"];break;case"personal":S.dataViewList=_.without(S.dataViewList,"orgemail","orgntemail"),t=["orgemail","orgntemail"],S.dataViewList.push(a);break;case"orgemail":S.dataViewList=_.without(S.dataViewList,"personal","orgntemail"),t=["personal","orgntemail"],S.dataViewList.push(a);break;case"orgntemail":S.dataViewList=_.without(S.dataViewList,"personal","orgemail"),t=["personal","orgemail"],S.dataViewList.push(a)}F({item:a,txt:e.find("label").text(),removeView:t})}}),a.find(".checkList").off("click").on("click",function(){var e,t=$.e(this),a=t.data("val");t.find("i").toggleClass("msi-uncheck msi-check zmThmClr"),t.find("i").hasClass("msi-uncheck")?(S.dataViewList=_.without(S.dataViewList,a),e=[a]):S.dataViewList.push(a),F({item:a,txt:t.find("label").text(),removeView:e})}),e)for(var d,l=a.find(".typeData"),m=0;m<l.length;m++)if((d=$.e(l[m])).data("val")===e){if(d.hasClass("radioButton"))d.parents(".parentClass").find("i").removeClass(s).addClass(n),d.find("i").removeClass(n).addClass(s);else d.find("i").toggleClass("msi-uncheck msi-check zmThmClr");S.dataViewList.push(e),F({item:e,txt:d.find("label").text()})}},a=function(e){var t=A.groupWorkId,s=zmsuite.getCenter(t)[0].getNodes(),a=s[1].$el.children()[0],r=$.e(a).find(E);if(!r.length){var i=S.groupPermission,n=_.size(i)&&!(i.Org||i.personal),o=zdom("div",{className:"zmAHRow headerContainer"},zdom("div",{className:"zmAMB"})),d=[{type:"iconText",id:"groupName",callback:function(){var e,l,t,a,r,i=s.leftIcons.collection.get("groupName").$el;e=i,l=M.lists,t=l.toJSON(),a=$.e(e),r=[],"All"!==a.find(".gname").data("id")&&r.push({id:"All",name:C.streams.common.all,photo:zmStreamsApp.util.defaultGroupPhotoUrl()}),_.each(t,function(e){e&&e.id!==a.find(".gname").data("id")&&r.push(e)}),zmStreamsApp.util.showGroupDetails({groupInfo:r,elm:a,fn:function(e){var t,a=A.groupWorkId,r=zmsuite.getCenter(a)[0].$el,i=r.find(I),s=zmsuite.getCenter(a)[0].getNodes()[1].$el.children()[0],n=$.e(s).find(E);if(S.removeGroupViews(i.find(".groupDom"),!0),"All"===e.id)J(),W(l),$.e(n).find(c).remove(),$.e(n).find(".viewDot").remove(),t=(t=S.groupCount?S.groupCount:C.groupSubscription.no)+" "+C.groupSubscription.grp;else{r.find(k).children().remove(),r.find(k).addClass("zmHideD"),r.find(y).children().remove(),$.e(n).find(c).remove(),$.e(n).find(".viewDot").remove();var o=H(e.id);if(B(o,i),U(i,1),t="1 "+C.groupSubscription.grpSingular,!n.find(c).length){var d=S.template.viewBar(!0);$.e(d).find(".closeIcon").unbind().bind("click",function(){S.removeGroupViews(i.find(".groupDom"),!0),J(),W(M.lists),$.e(n).find(c).remove(),$.e(n).find(".viewDot").remove()}),$.e(n).appendDOM(d),$.e(n).find(".viewValue")[0].childNodes[0].textContent=e.name}}r.find(O).text(t),zmUtil.hideMenu()},showUnread:!1,viewDOM:zmsuite.getCenter(A.groupWorkId)[0].$el[0]})},disabled:!0,isBold:!0,text:C.streams.common.all,applybackgroundThemeColor:!1,menuWithArrow:!0},{type:"text",id:"viewGroups",haveThemeColor:!0,iconClass:"msi-goback",text:C.groupSubscription.viewGrp,callback:S.constructGroupView}];s.leftIcons=zmIconConstructor.createIcon({iconList:d,targetContainer:$.e(o).find(".zmAMB")[0]}),$.e(a).appendDOM(o),$.e(o).appendDOM(S.template.dotHtml("countClass"));var l=zdom("span",{className:"zmGreyClr groupCount"},zdom("text",null));$.e(o).appendDOM(l);var m=babelHelpers.toConsumableArray(n||"-1"===zmail.zoid?[]:[{type:"text",id:"createGroup",haveThemeColor:!0,iconClass:"msi-create",text:C.groupSubscription.addgrp,callback:S.constructCreateView}]);s.rightIcons=zmIconConstructor.createIcon({iconList:m,targetContainer:s[1].$el.children()[1]})}var p=s.leftIcons.collection,u=s.rightIcons.collection;e?(s[2].$el.find(v).addClass("greyBg"),r.find(O).removeClass("SC_dyn"),r.find(".countClass").removeClass("SC_dyn"),p.get("groupName").set("visible",!0),p.get("viewGroups").set("visible",!1),u.get("createGroup")&&u.get("createGroup").set("visible",!0)):(s[2].$el.find(v).removeClass("greyBg"),r.find(O).addClass("SC_dyn"),r.find(".countClass").addClass("SC_dyn"),p.get("groupName").set("visible",!1),p.get("viewGroups").set("visible",!0),u.get("createGroup")&&u.get("createGroup").set("visible",!1),$.e(r).find(c).remove(),$.e(r).find(".viewDot").remove())},q=function(e,t){t&&t.noHeader||a(e)};S.getAllOrgGroups=function(e){var a,r,i=$.Deferred();return M.lists||(M.lists=new M.listGroupCollection),a=M.lists,e&&_.size(a)&&i.resolve(),S.isRequestProgress||(S.isRequestProgress=!0,S.isRequestComplete=!1,G.sync("getAllGroups",a).done(function(e){if(S.isRequestProgress=!1,S.isRequestComplete=!0,e.data){e=e.data,r=e.groups,S.groupCount=r.length||0;for(var t=0;t<r.length;t++)(a=a||M.listCol).addModel(r[t])}i.resolve()}).fail(function(e){S.isRequestProgress=!1,S.isRequestComplete=!0,i.resolve("error")})),i.promise()};S.constructGroupView=function(e,t){S.groupMode=!0,S.createMode=!1,q(!0);var a=zmsuite.getCenter(A.groupWorkId)[0].getNodes(),r=a[2].$el.find(f),i=a[2].$el.find(I);r.addClass("SC_dyn"),i.removeClass("SC_dyn");var s=M.lists;$.e(a[2].$el).off("scroll").on("scroll",function(){zmStreamsApp.util.hideMenu(!0)}),S.isRequestComplete&&("function"==typeof e&&e(),t?J(t):(J(),W(s))),S.isOnboard&&"0"===zmAdHocSettings.getStreamsGroupMgmt()&&function(e){for(var t,a,r=e[2].$el,i=e[0].$el,s=r.find(".groupDom"),n=$.e(r.find(".groupDom")[0]),o=!1,d=0;d<s.length;d++)if(t=$.e(s[d]).data("id"),(a=H(t))&&a.get("isOwner")&&!a.get("streamsEnabled")){n=$.e(s[d]),o=!0;break}if(s.length&&o){n[0].scrollIntoView();var l=C.groupSubscription.onboarding,m=[{featureElement:n.find(".streamState"),content:l.enContent,title:l.enHeader},{featureElement:i.find(".addGroup"),content:l.createContent,title:l.createHeader}],p={actionPoints:[{targetElement:n.find(".streamState"),slides:m,autoTrigger:"click"}],hideActionPoint:!0,onend:function(){zmAdHocSettings.setStreamsGroupMgmt("1"),S.isOnboard=!1}};zmUtil.loadAppTour(p)}}(a)};S.constructCreateView=function(e){if("-1"!==zmail.zoid){if(S.isCreateAvailable()){q("",e),S.groupMode=!1,S.createMode=!0;var t=zmsuite.getCenter(A.groupWorkId)[0].getNodes(),a=t[2].$el.find(f),r=t[2].$el.find(I);if(t[2].$el.find(v).removeClass("greyBg"),t[2].$el.find(k).children().remove(),t[2].$el.find(k).addClass("zmHideD"),t[2].$el.find(y).children().remove(),r.addClass("SC_dyn"),a.removeClass("SC_dyn"),a.children().length)a.find(N).focus();else{var i=S.template.createGroup();a.appendDOM($.e(i)),P(a)}}}else window.open(zmStreamsApp.GroupManageApp.urls.groupUrl,"_blank")};S.isCreateAvailable=function(e){var t=S.groupPermission;return!(_.size(t)&&!t.Org&&!t.personal)||(e||zmUtil.succErrMsg("e",C.groupSubscription.errMsg.privilegeErr),!1)};var Z=function(){var e=!1,t=!(zmail.superAdmin||!zmail.isAdmin);if(S.isorgadmin){switch(r.organizationGroupCreation){case"SUPER_ADMIN":t&&(e=!0);break;case"ADMIN":zmail.isAdmin&&(e=!0);break;case"MEMBERS":e=!0;break;default:e=!1}S.groupPermission.Org=e}switch(e=!1,r.personalGroupCreation){case"SUPER_ADMIN":t&&(e=!0);break;case"ADMIN":zmail.isAdmin&&(e=!0);break;case"MEMBERS":e=!0;break;default:e=!1}S.groupPermission.personal=e};return S.assignFunction=function(e){var t=e.constructMemberPopup,a=e.resetMemberValues,r=e.addMemberDialog,i=e.memberText,s=e.getUserDetails,n=window.zmStreamsApp.GroupManageApp;n.constructMemberPopup=t,n.memberText=i,n.getUserDetails=s,n.resetMemberValues=a,n.addMember=r},S.init=function(g){if(!_zm.isStreamsEnabled())return zmUtil.succErrMsg("e",C.common.messages.streamsDisabled),!1;zmModules.getMemberViewModule().then(function(e){var t=e.constructMemberPopup,a=e.resetMemberValues,r=e.addMemberDialog,i=e.memberText,s=e.getUserDetails;S.assignFunction({constructMemberPopup:t,resetMemberValues:a,addMemberDialog:r,memberText:i,getUserDetails:s})}),new Promise(function(a,e){if(_.size(r)||"-1"===zmail.zoid)"-1"===zmail.zoid&&(r={personalGroupCreation:"MEMBERS"}),a();else{M.lists||(M.lists=new M.listGroupCollection);var t=M.lists;G.sync("isCreateAllowed",t).done(function(e){if(200===e.status.code){var t=e.data;r=_zm.copyOf(t)}a()}).fail(function(){r={},a()})}}).then(function(){var n;Z(),S.isOnboard=g.isOnboard,_.size(zmail.ContactBook.getGroups())||(S.isOnboard=!0),"-1"===zmail.zoid&&(g.groupManage=!0,g.createGroup=!1,S.isOnboard=!1);var o=S.isCreateAvailable(!g.createGroup);if(!g.createGroup||o){var e=function(e){var t=!1,a={appname:C.groupSubscription.managegrp,appId:A.groupWorkId,data:{CNodes:"3"},appIcon:"msi-manageGroup",faqKey:"Streams",onDelete:function(){return V(),!0},isNewHeader:!0,isNewPreview:!1,hashKey:"groups",hashChangeHandler:function(e){zmUtil.debugLog("groups management hash url changed",e,this)}};if(zmsuite.isWorkspaceAvailable(A.groupWorkId))e.isRestore&&zmsuite.isWorkspaceAvailable(A.groupWorkId)&&(zmsuite.resetWorkspace(A.groupWorkId,a),t=!0);else{if(!zmsuite.setWorkSpace(a))return{maxTab:!0};t=!0}return t&&(zmsuite.renderWorkSpace(),$.publish("zmail/SaveTabState",[{appId:A.groupWorkId,app:"groups",appObj:{appname:C.groupSubscription.managegrp,appIcon:"msi-manageGroup"},category:"group_app"}])),zmsuite.showWorkSpace(A.groupWorkId),t}(g);if(!e.maxTab){var d,t;if(S.isorgadmin=zmail.isAdmin,n=zmsuite.getCenter(A.groupWorkId)[0].getNodes(),e){var a=n[2].$el;"-1"===zmail.zoid&&(a.appendDOM(S.template.constructBanner()),a.find(".accountsHolder").find(".clickLink").off("click").on("click",function(){window.open(zmStreamsApp.GroupManageApp.urls.groupUrl,"_blank")})),a.addClass("zmFlexNS"),a.find(".SCmb").remove(),a.appendDOM(zdom("div",{className:"zmAppPageLHS grpMgmtFltrLHS filterLHS zmHideD"})),a.appendDOM(zdom("div",{className:"zmAppPageCont mainContainer greyBg"},zdom("div",{className:"zmGrpMgmtCont grpContainer"})));var r=a.find(v),i=r.find(".grpContainer");i.appendDOM(zdom("div",{className:"zmTokenWrapper roundToken filterList"})),i.appendDOM(zdom("div",{className:"zmMSWra zmMSbox groupHolder"})),r.appendDOM(zdom("div",{className:"zmMSgCreWra createGroup"}))}S.closeWorkspace=g.closeWorkspace,S.createCallback=g.createCallback,S.activeGroups=_.pluck(zmail.ContactBook.getGroups(),"id"),S.fromApp=g.app;var s=n[2].$el.find(f),l=n[2].$el.find(I),m=s.children(),p=l.find(".groupDom"),u=g.groupManage===S.groupMode,c=g.createGroup===S.createMode;if(!e&&m.length&&c||p.length&&u)u?g.view&&(q(!0),J(g.view)):s.find(N).focus();else{if(!e&&p.length&&g.groupManage&&S.createMode)return s.addClass("SC_dyn"),l.removeClass("SC_dyn"),S.groupMode=!0,S.createMode=!1,q(!0),void(g.view?J(g.view):(J(),F({item:"all"})));if(!e&&m.length&&g.createGroup&&S.groupMode)return s.removeClass("SC_dyn"),l.addClass("SC_dyn"),S.groupMode=!1,S.createMode=!0,q("",g),void s.find(N).focus();g.groupManage?(S.groupMode=!0,S.createMode=!1,S.removeGroupViews(l.find(".groupDom")),_zm.clearHTML(l[0]),s.addClass("SC_dyn"),l.removeClass("SC_dyn")):g.createGroup&&(S.groupMode=!1,S.createMode=!0,s.removeClass("SC_dyn"),l.addClass("SC_dyn"),S.isorgadmin&&(t=zmComponent.loadingBand({container:s[0],type:"pagination"}))),S.isRequestProgress||(d=zmComponent.loadingBand({container:l[0],type:"pagination"})),function(){var i=$.Deferred();if(S.isorgadmin&&!S.domainList){M.lists||(M.lists=new M.listGroupCollection);var e=M.lists;G.sync("getDomainList",e).done(function(e){S.domainList=e.data.domainVO||[];for(var t=S.domainList.length,a=0,r=0;r<t;r++)S.domainList[r].mailHostingEnabled||a++;S.isMailHostingEnabled=a!==t,i.resolve()}).fail(function(e){401===e.status||200===e.status?(S.domainList=[],i.resolve()):i.resolve("error")})}else i.resolve();return i.promise()}().done(function(e){t&&t(),S.createMode&&(e&&_zm.succErrMsg("e",C.groupSubscription.errMsg.err_fetchdomain),S.constructCreateView(g))}),(e||S.groupMode)&&S.getAllOrgGroups(S.createMode).done(function(e){if(e){zmUtil.debugLog(C.groupSubscription.errMsg.errgrp),S.groupMode&&_zm.succErrMsg("e",C.groupSubscription.grpLoadErr),d&&d(),_zm.clearHTML(l[0]),g.groupManage&&n[2].$el.find(v).addClass("greyBg"),l.removeClass("zmMSboxL");var t=$.e(zdom("span",null)).text(C.groupSubscription.grpNtAvl+". ");l.appendDOM(t)}else if(!g.isOnboard||g.groupManage||g.createGroup)S.groupMode&&S.constructGroupView(d,g.view,g.isOnboard);else{for(var a=M.lists.toJSON(),r=_.pluck(a,"isOwner"),i=!1,s=0;s<r.length;s++)if(r[s]){i=!0;break}a.length&&i||!o?S.constructGroupView(d,g.view,g.isOnboard):(d&&d(),S.constructCreateView(g))}})}}}})},S.changeToContacts=function(e){var t,a,r;t=_.pluck(e.members,"id"),a=_.pluck(e.moderators,"id");for(var i=[],s=[],n=[],o=0;o<e.moderators.length;o++)n=e.moderators[o],i.push({email:n.emailAddress,id:n.id,zoid:n.orgId});for(var d=0;d<e.members.length;d++)n=e.members[d],s.push({email:n.emailAddress,id:n.id,zoid:n.orgId});e.createdBy&&(r=e.createdBy.id);var l=e.mailDeliveryEnabled?e.emailAddress:"";return{name:e.name,desc:e.description,photo:e.photo,members:t,moderator:a,isOwner:e.isOwner,owner:r,eid:l,id:e.id,disabled:!e.streamsEnabled,isFav:e.favourite,totalMembers:e.totalMembers,memArr:s,modArr:i,createdBy:e.createdBy}},S.getGroupAppModel=function(e){return H(e)},S.addGroupToContacts=function(e){var t=S.changeToContacts(e);zmStreamsApp.util.addGroup(t)},S.editGroupDetails=function(e){var t=_zm.copyOf(e.changed),a=e.get("id");t.hasOwnProperty("streamsEnabled")&&(t.disabled=!t.streamsEnabled,delete t.streamsEnabled),t.hasOwnProperty("mailDeliveryEnabled")&&(t.eid=t.mailDeliveryEnabled?e.get("emailAddress"):"",t.hasOwnProperty("emailAddress")&&delete t.emailAddress,delete t.mailDeliveryEnabled),zmStreamsApp.util.editGroup(a,t)},S.isGroupMember=function(e,t){var a=H(t);return!!a&&-1!==_.pluck(a.get("members"),"id").indexOf(e)},S.getGroup=function(e){var t={};if(e){var a=H(e);a&&(a=a.toJSON(),t=S.changeToContacts(a))}else for(var r,i=M&&M.lists?M.lists.toJSON():{},s=0;s<i.length;s++)t[(r=i[s]).id]=S.changeToContacts(r);return t},S}(zmStreamsApp.GroupManageApp||Zmail.App.extend({})),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=function(e){var t=zmStreamsApp.constants.groupWorkId,o=zmText.get("streams");return e.removeGroupFromView=function(i){var s=zmsuite.getCenter(t)[0].$el,n=s.find(".groupHolder");_.each(i.attributes.views,function(e){var t=i.getView(e.cid);if(t&&$.e(t.$el[0]).hasClass("groupDom")){t.onClose(!0);var a=n.children().length,r=a;a||(n.removeClass("zmMSboxL"),_zm.clearHTML(n[0]),n[0].appendChild(zmInit.emptyRow(o.groupSubscription.nogrp))),r=r||o.groupSubscription.no,s.find(".groupCount").text(r+" "+o.groupSubscription.grp)}})},e}(zmStreamsApp.GroupManageApp||Zmail.App.extend({})),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=function(b){var S=zmStreamsApp.GroupManageApp,s=function(){var z=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=z.$contentWrapper.find(".grpSearch"),h=z.memberTextArea;$(t).unbind(),$(t).find("input").off("keyup").on("keyup",function(e){if(13===e.keyCode)return!1;!function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.textValue,a=zmail.ContactBook.getGroups(t,{containsSearch:!0,includeAllGroups:!0});if(a){var r=e.$content[0].querySelector(".grpListView");_zm.clearHTML(r),r.appendChild(S.template.constructGrpList(a))}}({$content:z.$content,textValue:$(t).find("input").val()})}),$(t).find("input").focusin(function(){$(this).parent().addClass("inputFocus")}).focusout(function(){$(this).parent().removeClass("inputFocus")}),$(t).find("input").focus(),z.$content.bind("click").bind("click",function(e){var t=$(e.target),a=t.closest(".grpSel");if(a.length)!function(s,e){e.$contentWrapper.addClass("zmSMMemLstShw"),e.$content[0].querySelector(".memContainer").appendChild(S.template.constructMemView(s));var n=e.$content.find(".memListUL");n.get(0).scrollHeight>n.height()&&e.$content.find(".userSearch").removeClass("SC_dyn");var t=e.$content.find(".userSearch"),a=t.find("input");t.unbind(),a.off("keyup").on("keyup",function(e){if(13===e.keyCode)return!1;var t=$(this).val(),a=[],r=zmStreamsApp.util.getGroupDetails(s);a=t?(a=zmStreamsApp.util.membersFilter(s,t),_.pluck(a,"zid")):r.members,_zm.clearHTML(n[0]),n.prev().remove(),n[0].appendChild(S.template.constructMemberList(a,r));var i=S.template.memSelAllList();$.e(i).insertDOMBefore(n)}),a.focusin(function(){$(this).parent().addClass("inputFocus")}).focusout(function(){$(this).parent().removeClass("inputFocus")}),a.focus()}($(a).data("gid"),z);else if(t.closest(".goToPrev").length)z.$contentWrapper.removeClass("zmSMMemLstShw"),_zm.clearHTML(z.$content.find(".memContainer")[0]);else if(t.closest(".selText").length){var r=t.closest(".selText"),i=$(this).find(".memListUL").children();if(r.hasClass("selAll")){i.addClass("sel"),r.text("Un Select All"),r.removeClass("selAll"),$(this).find(".buttonContainer").removeClass("zmHideD"),$(this).find(".memCount").parent().removeClass("zmHideD");var s=i.filter(".sel").length;$(this).find(".memCount").text(s+" member(s) selected")}else i.removeClass("sel"),r.text("Select All"),r.addClass("selAll"),$(this).find(".buttonContainer").addClass("zmHideD"),$(this).find(".memCount").parent().addClass("zmHideD")}else if(t.closest(".memListGrp").length){var n=t.closest(".memListGrp");n.toggleClass("sel");var o=n.parent().find(".sel").length;$(this).find(".memCount").text(o+" member(s) selected"),n.hasClass("sel")?($(this).find(".buttonContainer").removeClass("zmHideD"),$(this).find(".memCount").parent().removeClass("zmHideD")):n.siblings().hasClass("sel")||($(this).find(".buttonContainer").addClass("zmHideD"),$(this).find(".memCount").parent().addClass("zmHideD"));var d=$(this).find(".selText");o===n.siblings().length+1?(d.removeClass("selAll"),d.text("Un Select All")):(d.text("Select All"),d.addClass("selAll"))}else if(t.closest(".addMem").length){var l,m=$(z.$content).find(".memListUL").find(".sel"),p=h.find(".membersClass"),u=zmStreamsApp.GroupManageApp.getMembersAddress(h.find(".autoFilldata"));(u=u.length?u:[]).push(zmail.zuid);for(var c=h.find(".autoFilldata"),g=function(){$(this).parent(".dFill").remove(),c.children().length||(c.addClass("SC_dyn"),p.focus())},f=0;f<m.length;f++)if(l=$(m[f]).data("zid"),-1===u.indexOf(String(l))){var v=b.template.autoFillData(l);c[0].appendChild(v),1===c.children().length&&(c.removeClass("SC_dyn"),zmStreamsApp.GroupManageApp.checkMembers(p,c)),$(v).find(".closePopup").unbind("click").bind("click",g)}p.focus(),z.dialog.remove()}})};return b.importMembersFromGroup=function(i){var e={title:"Import Members from other groups",$content:"",dialogDidMount:function(e){var t=e.$els,a=$(t.$contentWrapper),r=$(t.$content);$(t.$positionWrapper).addClass("SC_PopTop"),$(t.$positionWrapper).css("top","40px"),r[0].appendChild(S.template.constructOuterContainer()),$.e(S.template.searchTextBox("",{placeHolder:"Search group",show:!1,customClass:"grpSearch"})).insertDOMBefore(r),r[0].querySelector(".grpListView").appendChild(S.template.constructGrpList()),r.css("min-height",.4*$(window).height()),r.css("max-height",.6*$(window).height()),r.get(0).scrollHeight>r.height()&&r.parent().find(".grpSearch").removeClass("SC_dyn"),s({$contentWrapper:a,$content:r,dialog:e,memberTextArea:i})}};Dialog.new(e)},b}(zmStreamsApp.GroupManageApp||Zmail.App.extend({})),zmStreamsApp.GroupManageApp.template=function(){var b=zmText.get("streams"),S={addImageDiv:function(e){return zdom("img",{className:"logoImg",style:e?{opacity:"0"}:{visibility:"hidden"}})},groupLogo:function(){return zdom("input",{type:"file",accept:"image/*"})},editImageDiv:function(){return zdom("span",{className:"zm_editImg updateLogo"},b.groupSubscription.createGrp.editImg)},dotHtml:function(e){return zdom("span",{className:"zmSDot "+e})},viewBar:function(e){return zdom("fragment",null,S.dotHtml("viewDot"),zdom("div",{className:"zmFCBub viewContainer"},e?zdom("span",{className:"zmFCBubLabel"},b.groupSubscription.grpSingular):[],zdom("span",{className:"zmFCBubValue viewValue"},zdom("text",null)),zdom("i",{className:"msi-close closeIcon"})))},constructRadioButtonList:function(){for(var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=[],r=t.value,i=t.data,s="",n=0;n<r.length;n++)s="radio"===t.type?(e=t.defValue===i[n]?"msi-option zmThmClr":"msi-unoption"," radioButton"):(e="msi-uncheck"," checkList"),a.push(zdom("div",{className:"zmLHSFltrOpt typeData"+s,"data-val":i[n]},zdom("i",{className:e}),zdom("label",null,r[n])));return zdom("div",{className:"zmLHSFltrGrp"},zdom("div",{className:"zmLHSFltrTitle expandCollapse"},zdom("span",null,t.name),zdom("i",{className:"msi-prev"})),zdom("div",{className:"zmLHSFltrOpts parentClass",style:{display:"block"}},a))},constructTokenWrap:function(e,t){return zdom("div",{className:"zmToken tokenParent","data-val":t},zdom("span",null,e),zdom("i",{className:"msi-closeSmall closeIcon"}))},autoFillData:function(e){var t,a=zmStreamsApp.util.getContactDetails([e])[e];return t=a&&a.avatar?a.avatar:zmStreamsApp.util.generateAvatarTemp(a.fn),zdom("div",{className:"zmMSgMbr dFill","data-zid":String(e)},t,a.fn,zdom("i",{className:"msi-close closePopup"}))},showNewActivity:function(){return zdom("span",{className:"SC_notify notify"})},createGroup:function(){var e=b.groupSubscription.createGrp,t=S.addImageDiv(!0),a=S.editImageDiv(),r=[],i=[];zmStreamsApp.GroupManageApp.groupPermission.Org&&zmStreamsApp.GroupManageApp.isMailHostingEnabled&&(r=zdom("div",{className:"zmMSgMail emailEn"},zdom("div",{className:"zmMSgSel",id:"zmMSgSel inclMail"},zdom("label",null,e.inclEmail,zdom("i",{className:"msi-info emailTip","data-tooltip":e.inclHelp,"data-tooltip-pos":"bottom"})),zdom("div",{className:"zmToggleBtn off toggleSel",style:{width:"56px"}},zdom("span",{className:"zmTBtxt textChange"},e.no),zdom("span",{className:"zmTBswitch switchTxt"})))),i=S.createEmailBox("",!0),$.e(i).hide());var s=[];return zmail.showFeature&&(s.push(zdom("font",{className:"zmSDot"})),s.push(zdom("font",{className:"zmLink addGrpMem"},"Add by groups"))),zdom("div",{className:"zmMSgCre"},zdom("div",{className:"zmMSgCIWra"},zdom("div",{className:"SCS_head"},zdom("div",{className:"SC_avtr imgLogo"},zdom("div",{className:"zmMSgCimg show"},zdom("i",{className:"msi-attimg"})),a,t),zdom("h3",null,e.headerName),zdom("p",null,e.headerContent)),zdom("div",{className:"SC_floatLabel flFLabel flBox"},zdom("input",{className:"groupClass",type:"text",placeholder:e.namePlh}),zdom("label",null,e.grpName,zdom("span",{className:"spanMsg"}))),zdom("div",{className:"SC_floatLabel flFLabel flBox"},zdom("input",{className:"membersClass",type:"text",placeholder:e.memPlh}),zdom("div",{className:"zmMSgMbrWra autoFilldata SC_dyn"}),zdom("label",null,e.addMem,s,zdom("span",{className:"spanMsg"}))),zdom("div",{className:"SC_floatLabel flFLabel flBox"},zdom("textarea",{className:"descClass",placeholder:e.descPlh}),zdom("label",null,e.grpDesc,zdom("span",{className:"spanMsg"}))),r,i),zdom("div",{className:"SC_PUbtm zmRightAlign"},zdom("span",{className:"createButton"},e.createBtn)))},constUlGroup:function(e,t,a){for(var r,i=0;i<t.length;i++){if(5<i&&!a){r=zdom("li",{className:"SC_more"},zdom("span",{className:"SC_lnk moreOpt"},b.common.labels.seeMore)),e.appendChild(r);break}r=zdom("li",null,zdom("div",null,t[i].name),zdom("img",{src:t[i].photo})),e.appendChild(r)}},getSimilarGroup:function(e){var t=zdom("div",{className:"SC_grpLst"},zdom("p",null,b.groupSubscription.createGrp.simGrpCont),zdom("ul",{className:"SC_Pr SC_PLst ulDom"})),a=t.querySelector("ul.ulDom");return S.constUlGroup(a,e),t},generateImage:function(e){var t,a=zmStreamsApp.util.getGroupDetails(e.id);return t=a&&a.avatar?a.avatar:zmStreamsApp.util.generateAvatarTemp(e.name),$.e(t).addClass("imgLogo"),e.isOwner&&(t.appendChild(S.addImageDiv()),t.appendChild(S.editImageDiv())),t},constUrlLink:function(e){var t=[];return e.emailAddress&&(t=zdom("span",{className:"SC_lnk opLink SC_frt"},b.groupSubscription.mreSetting)),t},editGroupProfile:function(e){var t=b.groupSubscription,a=e.moderators||[],r=-1===(a=_.pluck(a,"id")).indexOf(zmail.zuid),i=r?"SC_dyn":"",s=r?"pointerEventsNone ":"",n=zdom("div",{className:"zmMSgEdt zmMSgCre"}),o=zdom("div",{className:"SCS_head headerGroupElm zmRgtAvtr "+s},zdom("div",{className:"zmMSgCtit"},zdom("label",null,t.editGrp.grpName+" "," "),zdom("span",{className:"zm_msgCont SC_dyn"},zdom("small",{className:" messgName msgTxt "})),zdom("h3",{contentEditable:"false"},zdom("span",{className:"edtitle","data-plhr":t.createGrp.namePlh},e.name),zdom("small",{className:"zm_editLnk editName SC_lnk "+i},t.editGrp.edit)))),d=i.length?t.editGrp.noDesc:t.editGrp.descPlh,l=zdom("div",{className:"SCS_head SC_np descElm "+s},zdom("div",{className:"zmMSgCdesc"},zdom("label",null,t.editGrp.grpDesc+" "," "),zdom("span",{className:"zm_msgCont SC_dyn"},zdom("small",{className:" msgTxt messgDesc"})),zdom("p",null,zdom("span",{className:"edcont","data-plhr":d},e.description),zdom("small",{className:"zm_editLnk editDesc SC_lnk "+i},t.editGrp.edit)))),m=e.mailDeliveryEnabled&&e.streamsEnabled?"sel":"",p=e.streamsEnabled?"sel ":"",u=e.streamsEnabled?"":"disable",c=Boolean(e.emailAddress||zmStreamsApp.GroupManageApp.isorgadmin),g=e.organizationGroup&&c?zdom("div",{className:"zmMSgSel emailEn "+m+" "+u},zdom("i",{className:"msi-check emailEnabled "+s}),zdom("label",{className:"emailEnabled "+s},t.editGrp.inclEmail),zdom("i",{className:"msi-info emailTip"})):[];r&&!m.length&&$.e(g).length&&(g=[]);var f=zdom("div",{className:"zmMSgMail"},zdom("div",{className:"zmMSgSel "+p+s},zdom("i",{className:"msi-check streamEn"}),zdom("label",{className:"streamEn"},t.enState)),g),v=_.pluck(e.createdBy,"id"),z=e.organizationGroup&&(-1!==v.indexOf(zmail.zuid)||zmStreamsApp.GroupManageApp.isorgadmin)||!e.organizationGroup&&e.isOwner?zdom("div",{className:"zm_grpAction zm_CA"},zdom("div",{className:"zm_CATxt"},zdom("div",{className:"zm_CATitle"},t.editGrp.deleteHeader),zdom("p",null,t.editGrp.deleteContent)),zdom("div",{className:"zm_CABtn"},zdom("span",{className:"zmBtn thmBdrBtn deleteButton"},t.editGrp.deleteButton))):"";n.appendChild(o),n.appendChild(l),n.appendChild(f),z&&n.appendChild(z);var h=S.generateImage(e);return $.e(n).find(".headerGroupElm").prependDOM($.e(h)),n},constructMemberDOM:function(e,t){for(var a,r,i,s=e.members,n=_.size(s)?zdom("div",{className:"zmMSgMem viewMembers"}):[],o=!1,d=0,l=0;l<s.length;l++){if(3<d){var m="+"+(e.totalMembers-4);i=m=zmStreamsApp.util.generateAvatarTemp(m,!0,!0),n.appendChild(i),o=!0,$.e(i).addClass("memImg SC_thmCount"),e.isOwner?$.e(i).addClass("isAdd"):$.e(i).addClass("isView");break}a=s[l].id,i=(r=zmStreamsApp.util.getContactDetails([a])[a]).isDummyObj?(r=zmStreamsApp.GroupManageApp.getUserDetails(s[l]),zmStreamsApp.util.generateAvatarTemp(r.fn)):r.avatar?r.avatar:zmStreamsApp.util.generateAvatarTemp(r.fn),n.appendChild(i),$.e(i).attr("name",r.fn),$.e(i).addClass("memImg"),d++}!o&&e.isOwner&&(i=zdom("i",{className:"msi-plus borderPlus"}),n.appendChild(i),$.e(i).addClass("isAdd"),$.e(i).addClass("memImg")),$.e(t).find(".infoRole")[0]&&_zm.after($.e(t).find(".infoRole")[0],n)},constructActions:function(e){var t=b.groupSubscription,a=e.isOwner?"":"disable",r=e.streamsEnabled,i=r?"sel":"",s=e.isOwner?zdom("i",{className:"msi-check "}):[],n=!e.isOwner&&r?t.enState:t.disState;return n=e.isOwner?t.enState:n,zdom("div",{className:"zmMSgAct "+a+" "+i},zdom("span",{className:"streamState"},s,zdom("text",null,n)))},createEmailBox:function(e,t){for(var a,r=zmStreamsApp.GroupManageApp.domainList,i=document.createDocumentFragment(),s=t?[]:zdom("div",{className:"SC_hypBtn"},zdom("span",{className:"SC_green SC_lnk saveEmail"},b.streams.common.create),zdom("span",{className:"SC_gray SC_lnk cancelEmail"},b.streams.common.cancel)),n=0;n<r.length;n++)r[n].mailHostingEnabled&&(a=zdom("option",{value:r[n].domainName},r[n].domainName),i.appendChild(a));var o=zdom("div",{className:"zmMSgMOpt emailBox"},zdom("label",null,b.groupSubscription.createGrp.createEmail),zdom("div",{className:"SC_floatLabelRow fLCol2"},zdom("div",{className:"SC_floatLabel flFLabel flBox"},zdom("input",{type:"text",className:"hasDD userName"})),zdom("span",null,"@"),zdom("div",{className:"SC_floatLabel flFLabel flBox domainList"},zdom("select",null,i))),s);if(e&&""!==e){var d=e.name.toLowerCase();d=d.replace(/ /gi,"_"),$.e(o).find(".userName").val(d)}return o},searchTextBox:function(e,t){var a="";a=t?t.placeHolder:e?b.groupSubscription.memberActions.searchModerator:b.groupSubscription.memberActions.searchUser;var r=t&&t.show?"":"SC_dyn",i=t&&t.customClass?t.customClass:"";return zdom("div",{className:"SC_sch searchText "+r+" "+i},zdom("i",{className:"msi-search"}),zdom("input",{type:"text",placeholder:a,style:{width:"400px"}}))},constructOuterContainer:function(){var e=document.createDocumentFragment();return e.appendChild(zdom("div",{className:"zmSMGrpLst grpContainer"},zdom("ul",{className:"SC_P2r P2rBlkGery SC_PhrTxt grpListView"}))),e.appendChild(zdom("div",{className:"zmSMMemLst memContainer"})),e},memSelAllList:function(){return zdom("div",{className:"zmSMMemSelAll"},zdom("span",{className:"zmLink selText selAll"},"Select All"),zdom("span",{className:"SC_ldot zmHideD "},zdom("strong",{className:"memCount"})))},constructMemView:function(e){var t=document.createDocumentFragment(),a=zmStreamsApp.util.getGroupDetails(e),r=zdom("div",{className:"zmSMMemTitle"},zdom("div",{className:"SCmb zmSMMemBack"},zdom("ul",null,zdom("li",{className:"goToPrev"},zdom("b",null,zdom("div",{className:"SC_hd"}),zdom("span",{className:"SC_thm"},zdom("i",{className:"msi-goback"})))))),zdom("h3",null,a.name,zdom("small",{className:"zmGreyClr zmSMMemCount"},"("+a.members.length+" members)")));t.appendChild(r),t.appendChild(S.searchTextBox("",{placeHolder:"Search for members by name or email",show:!1,customClass:"userSearch"}));var i=S.memSelAllList();t.appendChild(i);var s=zdom("ul",{className:"SC_P2r P2rBlkGery memListUL SC_PhrTxt","data-gid":e});s.appendChild(S.constructMemberList(a.members,a)),t.appendChild(s);var n=zdom("div",{className:"SC_PUbtm buttonContainer zmHideD"},zdom("span",{className:"js-button-selector addMem","data-id":"0"},"Add Members"),zdom("span",{className:"js-button-selector goToPrev","data-id":"1","data-val":"Cancel"},"Cancel"));return t.appendChild(n),t},constructMemberList:function(e,t){var a,r,i,s=document.createDocumentFragment();if(!(e=_.without(e,zmail.zuid)).length){return s.appendChild(zdom("li",{className:"nohr",style:{"padding-left":"0px","text-align":"center","padding-right":"0px"}},zdom("span",null,"No members present"))),s}var n,o=[],d=[],l=[];for(var m in e)(n=e[m])===String(t.owner)?d.push(n):-1!==t.moderator.indexOf(n)?o.push(n):l.push(n);e=(e=[]).concat(d).concat(o).concat(l);for(var p=0;p<e.length;p++)a=(r=zmStreamsApp.util.getContactDetails([e[p]])[e[p]]).avatar?r.avatar:zmStreamsApp.util.generateAvatarTemp(r.name),i=-1!==t.moderator.indexOf(r.zid)?b.common.labels.moderator:"",s.appendChild(zdom("li",{"data-zid":r.zid,className:"zm_mem_post memListGrp"},a,zdom("div",null,zdom("strong",null,r.fn),zdom("i",{className:"SC_Otxt"},i),zdom("span",null,r.eid))));return s},constructGrpList:function(e){var t=document.createDocumentFragment(),a=_.size(e)?e:zmail.ContactBook.getGroups(),r=[];if(_.size(a)){var i,s;a=_.pluck(a,"attrs");for(var n=0;n<a.length;n++)i=(s=a[n]).avatar?s.avatar:zmStreamsApp.util.generateAvatarTemp(s.name),r=zdom("li",{className:"grpSel","data-gid":s.id},i,zdom("div",null,zdom("strong",null,s.name),zdom("span",null,s.members.length+" members"))),t.appendChild(r)}else{r=zdom("li",{className:"nohr",style:{"padding-left":"0px","text-align":"center","padding-right":"0px"}},zdom("span",null,"No groups present")),t.appendChild(r)}return t},constructTabs:function(e){for(var t,a=zdom("ul",{className:"SCS_tab tabSel"}),r=0;r<e.length;r++)t=zdom("li",{className:e[r].id},e[r].name),a.appendChild(t);return a},constructTabViews:function(e,t){var a="cal"===e.id?"zmGrpPolicy ":"",r=t&&-1!==["cal","task"].indexOf(e.id)?"pointerEventsNone":"";return zdom("div",{className:"zm_tabCont tabView "+e.id+" "+a+r})},streamStateAlert:function(e){return zdom("div",null,e)},getEditTemplate:function(){return zdom("div",{className:"zmMSgEdit editOpt"},zdom("div",{className:"SCmb"},zdom("ul",null,zdom("li",{"data-event":"msi-action"},zdom("b",null,zdom("div",{className:"SC_hd"}),zdom("span",null,zdom("i",{className:"msi-edit"})))))))},getMoreOpt:function(){return zdom("div",{className:"zmMSgEdit moreOpt"},zdom("div",{className:"SCmb"},zdom("ul",null,zdom("li",{"data-event":"msi-action"},zdom("b",null,zdom("div",{className:"SC_hd"}),zdom("span",null,zdom("i",{className:"msi-action"})))))))},constructBanner:function(){var e=b.groupSubscription;return zdom("div",{className:"zmInfoBox jcCenter zmMsgBox accountsHolder"},zdom("span",null,e.personalBanner,zdom("span",{className:"zmBlueLink clickLink"},e.personalBanner1),e.personalBanner2))},addGroupView:function(e){var t,a=[];if(e&&e.id){var r,i=zmStreamsApp.util.getGroupDetails(e.id);r=i&&i.avatar?i.avatar:zmStreamsApp.util.generateAvatarTemp(e.name);var s="",n="";if(e.createdBy&&e.createdBy.id===zmail.zuid)s=b.common.labels.owner,n="SC_urOwn";else{for(var o=e.moderators,d=!1,l=0;l<o.length;l++)if(zmail.zuid===o[l].id){d=!0;break}s=d?b.common.labels.moderator:b.common.labels.member,n=d?"SC_urMod":"SC_urMem"}var m=zdom("span",{className:"userRole "+n},s),p=zdom("div",{className:"zmMSgInfo infoRole"},zdom("strong",{className:"groupName"},e.name),zdom("div",null,zdom("div",{className:"SC_SDot"}),m));t=this.constructActions(e);var u=i&&!i.isDisabled?"SC_csr":"",c=e.hidden?"zmHMSL":"";a=zdom("div",{className:"zmMSL groupDom "+u+" "+c},r,zdom("div",{className:"zmMSDtl"},p,t));var g=this.getMoreOpt();$.e(a).prependDOM(g),$.e(r).addClass("grpImg"),this.constructMemberDOM(e,a)}return a}};return S}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=zmStreamsApp.GroupManageApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp.models=function(e){var c=zmStreamsApp.GroupManageApp.ajaxReq,g=zmText.get("streams");return e.listGroup=Zmail.Model.extend({url:"/api/streams/groups/",defaults:{name:"",desc:"",mzuid:[]},constructor:function(e,t){Zmail.Model.apply(this,arguments)},setView:function(e,t){var a=this.get("views")||{};a[e]=t,this.set("views",a)},getView:function(e){return(this.get("views")||{})[e]},removeView:function(e,t){var a=this.get("views")||{};delete a[e],_.isEmpty(a)&&!t&&this.trigger("destroy",this)},changeModerator:function(e,a){var t,r=e.mode,i=this,s=e.zuid,n={},o=_zm.copyOf(i.get("moderators")),d=_.pluck(o,"id"),l=_zm.copyOf(i.get("members")),m=_zm.copyOf(o),p=i.get("members").find(function(e){return e.id===s});if(t=zmStreamsApp.GroupManageApp.getUserDetails(p),"addModerator"===r)n={emailAddress:t.eid,name:t.fn,id:s,zoid:t.zoid},o.push(n),d.push(s),i.set("moderators",[s]);else{var u;for(u=0;u<o.length&&s!==o[u].id;u++);o.splice(u,1),d=_.without(d,s),i.set("members",[s])}c.sync("update",i).done(function(){"addModerator"===r||i.set("members",l),i.set("moderators",o);var e=zmStreamsApp.util.getGroupDetails(i.get("id"));if(e){var t=e.memArr.find(function(e){return e.id===s});zmStreamsApp.util.groupManagement({mode:r,groupId:i.get("id"),members:[t]})}a&&a()}).fail(function(e){e.length?(e=$.parseJSON(e),zmUtil.succErrMsg("e",e.status.description)):zmUtil.succErrMsg("e",g.groupSubscription.editGrp.roleErr),"addModerator"===r?i.set("moderators",m):i.set("members",l)})},removeMember:function(s,n){var o,d,l=this,m=_zm.copyOf(l.get("members")),p=_zm.copyOf(l.get("moderators")),e=_.pluck(m,"id"),u=_.pluck(p,"id");for(d=0;d<e.length;d++)e[d]===s&&(o=_zm.copyOf(m[d]),m.splice(d,1));l.set("removeMembers",[s]),c.sync("update",l).done(function(e){var t=l.get("totalMembers");t-=1,l.set("totalMembers",t),l.set("removeMembers",[]),l.set("members",m);var a=-1!==_.indexOf(u,s);if(a){for(d=0;d<u.length;d++)u[d]===s&&(o=_zm.copyOf(p[d]),p.splice(d,1));l.set("moderators",p)}var r=zmStreamsApp.util.getGroupDetails(l.get("id")),i={};r&&(i=r.memArr.find(function(e){return e.id===s}),a&&zmStreamsApp.util.groupManagement({mode:"removeModerator",groupId:l.get("id"),members:[i]}),zmStreamsApp.util.groupManagement({mode:"removeMember",groupId:l.get("id"),members:[i]})),zmsuite.isWorkspaceAvailable(zmStreamsApp.constants.groupWorkId)&&zmStreamsApp.GroupManageApp.groupMode&&l.trigger("change:memberList"),n&&n()}).fail(function(e){l.set("removeMembers",[]),e.length?(e=$.parseJSON(e),zmUtil.succErrMsg("e",e.status.description)):zmUtil.succErrMsg("e",g.groupSubscription.editGrp.remMemErr);var t=l.get("members");t.push(o),l.set("members",t)})},addMember:function(i,s,t){var n,o,d=this,l=_zm.copyOf(d.get("members"));d.set("addMembers",i),c.sync("update",d).done(function(e){d.set("addMembers",[]);var t=d.get("totalMembers");t+=i.length,d.set("totalMembers",t),i=_.isArray(i)?i:[i],o=zmStreamsApp.util.getContactDetails(i);var a=[];for(var r in o)n={id:o[r].zid,name:o[r].fn,emailAddress:o[r].eid},a.push({zoid:zmail.zoid,id:o[r].zid,email:o[r].eid}),l.push(n);d.set("members",l),zmStreamsApp.util.groupManagement({mode:"addMember",groupId:d.get("id"),members:a}),zmsuite.isWorkspaceAvailable(zmStreamsApp.constants.groupWorkId)&&zmStreamsApp.GroupManageApp.groupMode&&d.trigger("change:memberList"),s&&s()}).fail(function(e){d.set("addMembers",[]),e.length?(e=$.parseJSON(e),zmUtil.succErrMsg("e",e.status.description)):zmUtil.succErrMsg("e",g.groupSubscription.editGrp.addMemErr),t&&t()})},serialized:function(e,t,a){var r=this,i=null;if("update"===e){t.url+=r.id,i=r.changed;var s=r.get("removeMembers");r.changed.emailAddress?i.mailDeliveryEnabled=!0:s&&s.length?i.removeMembers=s:r.get("addMembers")&&r.get("addMembers").length&&(i.addMembers=r.get("addMembers")),t.header=!0,t.setSessionId=!0,t.type="PUT"}else if("getGroup"===e)t.url+=r.id,t.type="GET",t.header=!0;else if("createGroup"===e)i={name:r.get("name"),description:r.get("desc"),members:r.get("mzuid")},r.get("emailAddress")&&(i.emailAddress=r.get("emailAddress")),t.header=!0,t.setSessionId=!0;else if("deleteGrp"===e)t.url+=r.id,t.type="DELETE",t.header=!0,t.setSessionId=!0;else if("updateLogo"===e){t.url+=r.id+"/photo";var n=r.get("photo"),o=new FormData;o.append("photo",n),i=o,t.type="PUT",t.noStringify=!0,t.header=!0,t.setSessionId=!0}else"getMembers"===e?(t.url+=r.get("id")+"/members",t.type="GET",t.header=!0):"getGroupDetail"===e&&(t.url+=r.get("id"),t.type="GET",t.header=!0);return i}}),e.listGroupCollection=Zmail.Collection.extend({model:e.listGroup,url:"/api/streams/groups",addModel:function(e,t,a){var r=_.pluck(e.moderators,"id");e.isOwner=!1;for(var i=0;i<r.length;i++)if(String(r[i])===zmail.zuid){e.isOwner=!0;break}return e.createdBy&&String(e.createdBy.id)===zmail.zuid&&(e.isOwner=!0),this.remove(e,{silent:a}),this.add(e,{at:t,silent:a}),this._byId[e.id]},serialized:function(e,t){return"getAllGroups"===e?t.type="GET":"getDomainList"===e?(t.type="GET",t.url="/api/organization/"+zmail.zoid+"/domains"):"isCreateAllowed"===e&&(t.type="GET",t.url="/api/organization/"+zmail.zoid+"/privileges"),t.header=!0,null}}),e}(zmStreamsApp.GroupManageApp.models),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp=function(o){var e=zmText.get("streams","groupSubscription"),n=zmStreamsApp.constants.maxLimit,d={exists:e.errMsg.grpExists,empty:e.errMsg.grpEmpty,maxLength:e.errMsg.grpLimit,propName:e.errMsg.grpinvChar,nomemmesg:e.errMsg.memMin,descLength:e.errMsg.descLimit,propDesc:e.errMsg.descinvChar,sizeExceeds:e.errMsg.logoSize,memInvalid:e.errMsg.memInvalid},l={avl:e.errMsg.grpAvl};o.isGroupValid=function(e,t,a){var r,i,s;if(!e.trim())return{type:"error",message:d.empty};if(0===e.length||e.length>n.MAX_GROUP_NAME_LENGTH)return{type:"error",message:d.maxLength};for(i=0;i<t.length;i++)if(r=t[i],s=$.trim(r.name.toLowerCase())===e.toLowerCase(),r.isOwner&&s&&(!a||t[i].id!==a))return{type:"error",message:d.exists};return{type:"success",message:l.avl}};o.isGroupDescriptionValid=function(e){return!(e&&e.length>n.MAX_GROUP_DESC_LENGTH)||{type:"error",message:d.descLength}};return o.validateIncludeEmail=function(){return zmStreamsApp.GroupManageApp.domainList.length?!!zmStreamsApp.GroupManageApp.isMailHostingEnabled||(_zm.succErrMsg("e",e.errMsg.mailhost),!1):(_zm.succErrMsg("e",e.errMsg.nodomain),!1)},o.checkGroupName=function(e,t){var a=$.e(e).parent();a.removeClass("flBoxF"),a.removeClass("flVR vrFail vrSuccess vrWarning");var r=o.isGroupValid($.trim($.e(e).val()),t);return"error"===r.type?(a.addClass("flVR vrFail"),a.find(".spanMsg").text(r.message),!1):"success"===r.type||("warning"===r.type?(a.addClass("flVR vrWarning"),!1):void 0)},o.getMembersAddress=function(e){var t=e.children(".dFill");if(!t.length)return[];for(var a,r=[],i=0;i<t.length;i++)(a=$.e(t[i]).data("zid"))&&r.push(String(a));return r},o.checkMembers=function(e,t){var a=$.e(e).parent();a.removeClass("flBoxF");var r,i,s=o.getMembersAddress($.e(t)),n=(r=s,i=e,$.e(i).val()&&!r.length?{type:"error",message:d.memInvalid}:(!r||!r.length)&&{type:"error",message:d.nomemmesg});return"error"===n.type?(a.addClass("flVR vrFail"),a.find(".spanMsg").text(n.message),!1):(a.removeClass("flVR vrFail"),!0)},o.checkDescription=function(e){var t=$.e(e).parent(),a=o.isGroupDescriptionValid($.e(e).val());return $.e(e).parent().removeClass("flBoxF"),"error"===a.type?(t.addClass("flVR vrFail"),t.find(".spanMsg").text(a.message),!1):(t.removeClass("flVR vrFail"),!0)},o.checkLogo=function(e){var t;return t=e[0].files[0],Math.round(t.size/1024)>n.MAX_ALLOWED_IMAGE_SIZE?{type:"error",message:d.sizeExceeds}:{type:"success"}},o}(zmStreamsApp.GroupManageApp||Zmail.App.extend({})),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.GroupManageApp.views=function(e){var v=zmStreamsApp.GroupManageApp,z=zmStreamsApp.GroupManageApp.ajaxReq,c=zmStreamsApp.constants.groupWorkId,h=zmText.get("streams"),u=zmStreamsApp.constants,m="data-tooltip",p="data-tooltip-pos",b=".searchText",g=".viewMembers";return e.GroupManage=Zmail.View.extend({events:{click:function(){var e=this.model.toJSON(),t=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree"),a=zmStreamsApp.util.getGroupDetails(e.id);if(t&&t.el.length&&!a.isDisabled){this.$el.find(".notify").remove(),this.model.get("hidden")&&this.model.set("hiddenAt",(new Date).toString());var r={view:"all",gridview:"grid"===zmAdHocSettings.getStreamsListType(),addTitleHeader:!0};zmUtil.requireStreamsApp().done(function(){zmStreamsApp.PostApp.init("",e.id,r,!0)})}},"click .viewMembers":function(e){var t=this.model.toJSON().id;zmStreamsApp.GroupManageApp.triggerEditGroup(t,[{tab:"General"},{tab:"Calendar"},{tab:"Task"},{tab:"Members",default:!0}]),e.stopPropagation()},"click .moreOpt":function(a){var r=this;a.stopPropagation(),$.e(a.currentTarget).addClass("show"),$.e(a.currentTarget).find("b").addClass("active");var e=[],i=this.model,s=i.toJSON(),t=h.groupSubscription.grpInfo;s.isOwner&&(t=h.groupSubscription.editgrp),e.push({txt:t,data:"edit"});var n=s.hidden;if(s.streamsEnabled&&!s.isDisabled){var o=n?h.groupSubscription.showGrp:h.groupSubscription.hideGrp;e.push({txt:o,data:"hide"})}zmStreamsApp.util.createPopup({items:e,parent:$.e(a.currentTarget).find("li"),parentClass:"SC_Sopt",type:"oneLine",noArrow:!0,avoidScroll:!0,align:"pright",hoverElm:$.e(a.currentTarget).find("b"),onhide:function(){$.e(a.currentTarget).find("li").removeClass("show"),$.e(a.currentTarget).find("b").removeClass("active")},callback:function(e){zmStreamsApp.util.hideMenu(),$.e(a.currentTarget).find("b").removeClass("active"),"edit"===e.item?zmStreamsApp.GroupManageApp.triggerEditGroup(i.id,[{tab:"General",default:!0},{tab:"Calendar"},{tab:"Task"},{tab:"Members"}]):"hide"===e.item&&(i.set("hidden",!n),z.sync("update",i).done(function(){var e=n?zmText.applyArgs(h.groupSubscription.editGrp.showMsg,{gName:s.name}):zmText.applyArgs(h.groupSubscription.editGrp.hiddenMsg,{gName:s.name});if(zmUtil.succErrMsg("s",e),n?r.$el.removeClass("zmHMSL"):r.$el.addClass("zmHMSL"),$.e(a.currentTarget).removeClass("show"),zmStreamsApp.GroupManageApp.editGroupDetails(i),$.publish("group/showHideGroup",{id:s.id,hidden:!n}),zmStreamsApp.util.hideMenu(),zmTab.currentTab===c){var t=zmStreamsApp.GroupManageApp.dataViewList;n&&t.includes("hidden")&&zmStreamsApp.GroupManageApp.removeGroupFromView(i)}}).fail(function(e){e.length&&(e=$.parseJSON(e)),zmUtil.succErrMsg("e",e.status.description),i.set("hidden",n)}))}})},"click .streamState":"changeStreamState"},deleteAlert:function(t){var e=this.model.toJSON(),a=this,r={title:zmText.applyArgs(h.groupSubscription.editGrp.delAlertH,{gName:e.name}),$content:h.groupSubscription.editGrp.delAlertC,ignoreMouseDown:!1,buttons:[{name:h.groupSubscription.proceed,callback:function(e){a.deleteGroup(t),e.remove()}},{name:h.streams.common.cancel,isCancel:!0,callback:function(e){e.remove()}}]};Dialog.new(r)},deleteGroup:function(d){var l=this.model,m=l.toJSON().id,p=$.e(this.$el),e=$.e(d.$els.$content).find(".deleteButton");zmStreamsApp.util.sendRemove(e,"",h.groupSubscription.editGrp.deleting),z.sync("deleteGrp",l).done(function(){if(d.remove(),p.remove(),zmStreamsApp.GroupApp.removeGroup(m),zmStreamsApp.util.hideMenu(),zmTab.currentTab===c){var e,t=zmsuite.getCenter(u.groupWorkId)[0].$el,a=t.find(".groupView").hasClass("SC_dyn"),r=t.find(".groupHolder");if(e=zmStreamsApp.GroupManageApp.groupCount-1,zmStreamsApp.GroupManageApp.groupCount=e,_.each(l.attributes.views,function(e){l.getView(e.cid).onClose()}),zmStreamsApp.GroupManageApp.groupCount){if(!a){var i=r.children().length;(e=i)||(r.removeClass("zmMSboxL"),_zm.clearHTML(r[0]),r[0].appendChild(zmInit.emptyRow(h.groupSubscription.nogrp)))}}else if(r.removeClass("zmMSboxL"),a){_zm.clearHTML(r[0]);var s=$.e(zdom("a",null)).attr({href:"#",id:"addGroup"}).text(h.groupSubscription.creategrp),n=$.e(zdom("span",null)).text(h.groupSubscription.grpNtAvl+". ");r.appendDOM(n).appendDOM(s),$.q("#addGroup").click(function(){zmStreamsApp.GroupManageApp.constructCreateView()})}else _zm.clearHTML(r[0]),r[0].appendChild(zmInit.emptyRow(h.groupSubscription.nogrp));e=e||h.groupSubscription.no,t.find(".groupCount").text(e+" "+h.groupSubscription.grp)}if(zmsuite.isWorkspaceAvailable("zmStreamsApp")&&zmStreamsApp.GroupApp.getCurrentGroup()===m){var o={view:"all",gridview:"grid"===zmAdHocSettings.getStreamsListType(),addTitleHeader:!0};zmUtil.requireStreamsApp().done(function(){var e="zmStreamsApp"===zmTab.currentTab;zmStreamsApp.PostApp.init("",zmail.zuid,o,!0,!e,"")})}}).fail(function(){zmUtil.succErrMsg("e",h.groupSubscription.editGrp.delErr),zmStreamsApp.util.sendRemove(e,!0,h.groupSubscription.editGrp.deleteButton)})},viewMem:function(i,s,n,o,d){_zm.clearHTML(i[0]);var l=this;zmModules.getMemberViewModule().then(function(e){var t=e.resetMemberValues,a=e.constructMemberPopup;t();var r=l.model.id;a(i,r,n,s,{gid:r,callback:o,title:d})})},afterEdit:function(e,t,a,r){e.text(r),e.attr("contenteditable",!1),e.parent().removeClass("zm_setBorder"),e.css("display",""),t.removeClass("SC_dyn"),a&&a.parent().addClass("SC_dyn")},onEditTrigger:function(e,t,a){$.e(e).addClass("SC_dyn"),t.attr("contenteditable",!0),t.css("display","table-cell"),t.parent().addClass("zm_setBorder");var r,i=$.e(t).text().length;t.focus(),document.selection?((r=document.selection.createRange()).moveStart("character",i),r.select()):(r=window.getSelection()).collapse(t[0].firstChild,i),a&&(a.parent().removeClass("SC_dyn"),a.addClass("SC_green"),a.text(h.groupSubscription.editGrp.infoMsg))},constructTooltip:function(e,t){var a=e.find(".emailTip"),r=h.groupSubscription.editGrp;if(a.length){var i="",s=t.emailAddress;if(i=t.streamsEnabled?s?t.mailDeliveryEnabled?zmText.applyArgs(r.enMail1,{eid:s}):zmText.applyArgs(r.enMail2,{eid:s}):r.enMail3:r.enMail,a.attr(m,i).attr(p,"bottom"),s){var n=t.moderators||[],o=-1===(n=_.pluck(n,"id")).indexOf(zmail.zuid);if(!$.e(e).find(".opLink").length&&!o){var d=v.template.constUrlLink(t);$.e(d).insertDOMAfter(a),$.e(d).unbind("click").bind("click",function(){var e=window.location.protocol+"//mailadmin."+zmail.zohoUrl+"/cpanel/mailadmin.do?mode=gmlst&gid="+t.id;setTimeout(function(){window.open(e)},0)})}}}},constructEdit:function(s,n){var r,o,e=this.model.toJSON(),d=this,l=this.model,m=v.template.editGroupProfile(e);_zm.clearHTML(s[0]),s[0].appendChild(m);var p=$.e(m).find(".editName"),u=s.find(".edtitle"),i=s.find(".edcont"),c=s.find(".messgName"),g=s.find(".messgDesc"),f=$.e(m).find(".editDesc");this.constructTooltip(s,e),o=function(e){var t=$.Deferred(),a=d.model,r=a.get("photo");return a.set("photo",e),z.sync("updateLogo",a).done(function(e){200===e.status.code?(a.set("photo",e.data.photo),a.trigger("change:changepreview"),_zm.preloadimg(e.data.photo),t.resolve()):(zmUtil.succErrMsg("e",e.status.description),t.resolve(!0))}).fail(function(){a.set("photo",r),zmUtil.succErrMsg("e",h.groupSubscription.errMsg.errlogo),t.resolve(!0)}),t.promise()},zmStreamsApp.GroupManageApp.bindGroupLogo($.e(m),o),p.unbind("click").bind("click",function(){d.onEditTrigger(this,u,c);var e=l.get("description");d.afterEdit(i,f,g,e)}),u.unbind("keydown").bind("keydown",function(e){var t=l.get("name");if(13===e.keyCode){e.preventDefault();var a=$.trim(u.text()),r=zmStreamsApp.GroupManageApp.models.lists.toJSON(),i=zmStreamsApp.GroupManageApp.isGroupValid(a,r,l.get("id"));if("error"===i.type||"warning"===i.type)return c.text(i.message),c.addClass("SC_red"),void c.removeClass("SC_green");l.set("name",a),z.sync("update",l).done(function(){$.e(n.$els.$header).find("h3").text(a),d.afterEdit(u,p,c,a),zmUtil.succErrMsg("s",h.groupSubscription.editGrp.groupSaved),s.find(".headerGroupElm").children().first().remove(),s.find(".headerGroupElm").prependDOM($.e(v.template.generateImage(l.toJSON()))),zmStreamsApp.GroupManageApp.bindGroupLogo($.e(m),o),l.trigger("change:groupName")}).fail(function(e){e.length&&(e=$.parseJSON(e)),zmUtil.succErrMsg("e",e.status.description),l.set("name",t)})}else 27===e.keyCode&&d.afterEdit(u,p,c,t)}),f.unbind("click").bind("click",function(){d.onEditTrigger(this,i,g);var e=l.get("name");d.afterEdit(u,p,c,e)}),i.unbind("keydown").bind("keydown",function(e){var t=l.get("description");if(13===e.keyCode){e.preventDefault();var a=$.trim(i.text()),r=zmStreamsApp.GroupManageApp.isGroupDescriptionValid(a);if("error"===r.type)return g.text(r.message),void g.addClass("SC_red").removeClass("SC_green");l.set("description",a),z.sync("update",l).done(function(){d.afterEdit(i,f,g,a),zmUtil.succErrMsg("s",h.groupSubscription.editGrp.descSaved),zmStreamsApp.GroupManageApp.editGroupDetails(d.model)}).fail(function(e){e.length&&(e=$.parseJSON(e),zmUtil.succErrMsg("e",e.status.description)),zmUtil.succErrMsg("e",h.groupSubscription.editGrp.descErr),l.set("description",t)})}else 27===e.keyCode&&d.afterEdit(i,f,g,t)}),$.e(m).find(".streamEn").unbind("click").bind("click",function(e){var t=$.e(this).parent(),a=$.e(m).find(".emailEn");r=function(){var e=d.model.toJSON();d.constructTooltip(s,e),e.streamsEnabled?(t.addClass("sel"),a.removeClass("disable")):(t.removeClass("sel"),a.addClass("disable"),a.removeClass("sel"))},d.changeStreamState(e,r)}),$.e(m).find(".emailEnabled").unbind("click").bind("click",function(e){var t=$.e(this).parent();!1!==zmStreamsApp.GroupManageApp.isMailHostingEnabled?$.e(this).parent().hasClass("disabled")||(r=function(){var e=d.model.toJSON();d.constructTooltip(s,e),e.mailDeliveryEnabled?t.addClass("sel"):t.removeClass("sel"),zmStreamsApp.GroupManageApp.editGroupDetails(d.model)},d.changeEmailState(r,$.e(m))):_zm.succErrMsg("e",h.groupSubscription.errMsg.mailhost)}),$.e(m).find(".deleteButton").unbind("click").bind("click",function(){$.e(this).hasClass("zs_snd")||d.deleteAlert(n)})},bindContentWrap:function(l,m,p,u,c){var g=l.find(".tabSel").find("li"),f=this;g.click(function(e){var t=$.e(e.currentTarget),a=$.e(m).get(0).scrollHeight>$.e(m).height();if(l.find(b).addClass("SC_dyn"),t.hasClass("stSel"))t.hasClass("mem")&&((a||f.model.get("isOwner"))&&l.find(b).removeClass("SC_dyn"),l.find(b).find("input").focus());else{var r=f.model.toJSON();if(g.removeClass("stSel"),t.addClass("stSel"),m.find(".tabView").removeClass("shw"),m.find(".buttonBar").remove(),t.hasClass("mem")){var i=-1!==_.pluck(r.moderators,"id").indexOf(zmail.zuid);(a||f.model.get("isOwner")||i)&&l.find(b).removeClass("SC_dyn"),m.find(".mem").addClass("shw"),f.viewMem(m.find(".mem"),l.find(b),p,u,c)}else if(t.hasClass("gen")){var s=m.find(".gen");if(s.addClass("shw"),void 0!==r.organizationGroup)f.constructEdit(s,p);else{var n=zmComponent.loadingBand({container:s[0],type:"pagination"});z.sync("getGroup",f.model).done(function(e){n(),v.models.lists||(v.models.lists=new v.models.listGroupCollection);var t=e.data;r=v.models.lists.addModel(t),f.model.attributes=_zm.copyOf(r.attributes),f.constructEdit(s,p)})}}else if(t.hasClass("cal")){m.find(".cal").addClass("shw");var o=r.organizationGroup?1:0,d=ZCL_groupPolicy;d&&_.size(d)&&d.getGroupPolicy({grpId:r.id,type:o},m.find(".cal")[0])}else t.hasClass("task")&&(m.find(".task").addClass("shw"),zmUtil.requireTaskModule("taskSettings").done(function(e){var t=r.organizationGroup?1:0;e.mountTaskSettingsDOM({grpId:r.id,type:t},m.find(".task")[0])}))}})},editGroupLoad:function(e){var n,o=this.model.toJSON(),d=this,l="",m=[],p="gen",t="";for(var a in e){switch(e[a].tab){case"General":m.push({name:h.groupSubscription.editGrp.gen,id:"gen"}),t="gen";break;case"Calendar":m.push({name:h.groupSubscription.editGrp.calSetting,id:"cal"}),t="cal";break;case"Task":m.push({name:h.groupSubscription.editGrp.taskSetting,id:"task"}),t="task";break;case"Members":m.push({name:h.common.labels.members,id:"mem"}),t="mem",e[a].callback&&(l=e[a].callback),e[a].title&&(n=e[a].title)}e[a].default&&(p=t)}var r={title:o.name,ignoreMouseDown:!1,dialogDidMount:function(e){var t=e.$els;$.e(t.$positionWrapper).css("top","50px");var a=$.e(t.$contentWrapper),r=$.e(t.$content),i=-1!==_.pluck(o.moderators,"id").indexOf(zmail.zuid);o.id===zmail.zuid&&(i=!0),$.e(v.template.constructTabs(m)).insertDOMBefore(r),$.e(v.template.searchTextBox(i)).insertDOMBefore(r),r.css("width","550px");for(var s=0;s<m.length;s++)r.appendDOM(v.template.constructTabViews(m[s],!i));r.css("max-height",.7*$.e(window).height()),d.bindContentWrap(a,r,e,l,n),a.find(".tabSel").find("li."+p).click()},closeAction:function(){d.onClose()},positionWrapperClass:"SC_pe SC_PopTop",maskWrapperClass:"SC_Pop noanim",headerClass:"SC_PUtt"};Dialog.new(r)},emailStateChange:function(e){var t,a=this.model,r=a.toJSON();t=r.mailDeliveryEnabled,r.mailDeliveryEnabled=!t,a.set("mailDeliveryEnabled",r.mailDeliveryEnabled),z.sync("update",a).done(function(){e&&e()}).fail(function(){zmUtil.succErrMsg("e",h.groupSubscription.editGrp.errInclMail),a.set("mailDeliveryEnabled",t)})},changeEmailState:function(r,e){var t,i=this.model,a=this;if(i.get("emailAddress"))!1===i.get("mailDeliveryEnabled")?this.emailStateChange(r):(t={title:h.groupSubscription.editGrp.emailDisH,ignoreMouseDown:!1,$content:v.template.streamStateAlert(h.groupSubscription.editGrp.emailDisC),buttons:[{name:h.groupSubscription.Continue,callback:function(e){a.emailStateChange(r),e.remove()}},{name:h.streams.common.cancel,isCancel:!0,callback:function(e){e.remove()}}]},Dialog.new(t));else{var s=e.find(".emailBox");if(!s.length){if(s=v.template.createEmailBox(i.toJSON()),!zmStreamsApp.GroupManageApp.domainList.length)return void _zm.succErrMsg("e",h.groupSubscription.errMsg.nodomain);if(!zmStreamsApp.GroupManageApp.isMailHostingEnabled)return void _zm.succErrMsg("e",h.groupSubscription.errMsg.mailhost);if(e.find(".emailBox").length)return void $.e(s).find(".userName").focus();$.e(s).insertDOMBefore(e.find(".zm_grpAction"))}$.e(s).show(),$.e(s).find(".userName").focus();var n=e.find(".saveEmail");e.find(".cancelEmail").unbind("click").bind("click",function(){$.e(s).hide()}),n.unbind("click").bind("click",function(){if(!$.e(n).hasClass("zs_snd")){var e=$.e(s).find(".userName").val(),t=$.e(s).find(".domainList select").val();if(""===e.trim()||""===t.trim())return void zmUtil.succErrMsg("e",h.groupSubscription.editGrp.patternErr);var a=i.toJSON();a.emailAddress=e+"@"+t,a.mailDeliveryEnabled=!0,i.set("mailDeliveryEnabled",!0),i.set("emailAddress",a.emailAddress),zmStreamsApp.util.sendRemove($.e(n),"",h.groupSubscription.editGrp.creating),z.sync("update",i).done(function(){$.e(s).hide(),r&&r()}).fail(function(e){e.responseText&&(e=JSON.parse(e.responseText)),e&&e.data&&"PATTERN_NOT_MATCHED"===e.data.errorCode?zmUtil.succErrMsg("e",h.groupSubscription.editGrp.patternErr):e&&e.status?zmUtil.succErrMsg("e",e.status.description):zmUtil.succErrMsg("e",h.groupSubscription.editGrp.emailBoxErr),i.set("emailAddress",""),i.set("mailDeliveryEnabled",!1),zmStreamsApp.util.sendRemove($.e(n),!0,h.streams.common.create)})}})}},streamStateChange:function(e){var t,a=this.model,r=this,i=a.toJSON();t=i.streamsEnabled,i.streamsEnabled=!t,a.set("streamsEnabled",i.streamsEnabled),z.sync("update",a).done(function(){r.streamsState(),a.get("mailDeliveryEnabled")&&(a.set("mailDeliveryEnabled",!1),zmStreamsApp.GroupManageApp.editGroupDetails(a)),e&&e()}).fail(function(){zmUtil.succErrMsg("e",h.groupSubscription.editGrp.streamsErr),a.set("streamsEnabled",t)})},changeStreamState:function(e,t){if(!$.e(e.currentTarget).parent().hasClass("disable")){var a,r=this;!1===this.model.get("streamsEnabled")?r.streamStateChange(t):(a={title:h.groupSubscription.disGrpHeader,ignoreMouseDown:!1,$content:v.template.streamStateAlert(h.groupSubscription.disGrpCont),buttons:[{name:h.groupSubscription.Continue,callback:function(e){r.streamStateChange(t),e.remove()}},{name:h.streams.common.cancel,isCancel:!0,callback:function(e){e.remove()}}]},Dialog.new(a))}e.stopPropagation()},streamsState:function(){var e=this.$el,t=this.model,a=e.find(".streamState i"),r=t.get("streamsEnabled"),i=t.toJSON();!1===r?a.parent().parent().removeClass("sel"):a.parent().parent().addClass("sel");var s=zmail.ContactBook.getGroups(i.id,{includeAllGroups:!0});(s=s[0])?zmStreamsApp.GroupManageApp.editGroupDetails(t):zmStreamsApp.GroupManageApp.addGroupToContacts(i),$.publish(r?"group/streamsenabled":"group/streamsdisabled",{id:i.id,name:i.name,membercount:i.members.length,members:i.members});var n,o=zmStreamsApp.GroupManageApp.activeGroups,d=t.get("id");if(-1===o.indexOf(d)&&(o.push(d),zmStreamsApp.GroupManageApp.activeGroups=o,n=!0),zmTab.currentTab===c){var l=zmStreamsApp.GroupManageApp.dataViewList,m=l.includes("disabled"),p=l.includes("enabled"),u=l.includes("streamsDis");(p&&!m&&!r||m&&!p&&r||u&&n&&!p&&!m)&&zmStreamsApp.GroupManageApp.removeGroupFromView(t)}},emailState:function(){var e=this.$el.find(".emailState i");!0===this.model.get("mailDeliveryEnabled")?e.removeClass().addClass("msi-check"):e.removeClass().addClass("msi-uncheck"),zmStreamsApp.GroupManageApp.editGroupDetails(this.model)},updateLogo:function(){var e=this.$el.find(".grpImg"),t=$.e(e).has("img"),a=this.model.get("photo");if(t.length)$.e(e).find("img").attr("src",a);else{var r=zdom("img",null);$.e(r).attr("src",a),_zm.clearHTML(e[0]),$.e(e).appendDOM($.e(r))}zmStreamsApp.GroupManageApp.editGroupDetails(this.model)},onClose:function(e){this.model.removeView(this.cid,e),this.remove()},render:function(e){var t=this.model.toJSON();if(e&&e.editGroup)this.editGroupLoad(e.tabObj);else{var a,r=v.template.addGroupView(t);this.$el=$.e(r);var i,s=$.e(r).find(g);s=s.find(".memImg");for(var n=0;n<s.length;n++)a=(i=$.e(s[n])).attr("name"),i.length&&a?i.attr(m,a):i.hasClass("isAdd")?i.attr(m,h.groupSubscription.addVMem):i.hasClass("isView")&&i.attr(m,h.groupSubscription.viewMem),i.attr(p,"bottom");var o=$.e(r).find(".editOpt");_.size(o)&&o.attr(m,h.groupSubscription.editgrp).attr(p,"bottom");var d=$.e(r).find(".moreOpt");if(_.size(d)&&d.attr(m,h.groupSubscription.mreAct).attr(p,"bottom"),$.e(r).attr("data-groupviewid",this.cid).attr("data-id",this.model.get("id")).data("view",this),t.hidden){var l=new Date(t.hiddenAt);0<new Date(t.lastActivityAt)-l&&this.showActivity()}}this.model.setView(this.cid,this)},constMembers:function(){var e,t=this.$el;t.find(g).remove(),v.template.constructMemberDOM(this.model.toJSON(),t);var a,r=$.e(t).find(g);r=r.find(".memImg");for(var i=0;i<r.length;i++)e=(a=$.e(r[i])).attr("name"),a.length&&e?a.attr(m,e):a.hasClass("isAdd")?a.attr(m,h.groupSubscription.addVMem):a.hasClass("isView")&&a.attr(m,h.groupSubscription.viewMem),a.attr(p,"bottom")},changeRole:function(){var e=this.$el,t="",a=this.model.toJSON();if(a.createdBy&&a.createdBy.id===zmail.zuid)t=h.common.labels.owner;else{for(var r=a.moderators,i=!1,s=0;s<r.length;s++)if(zmail.zuid===r[s].id){i=!0;break}t=i?h.common.labels.moderator:h.common.labels.member}if(e.find(".userRole").text(t),e.find(".zmMSgAct").remove(),e.appendDOM(v.template.constructActions(a)),e.find(g).remove(),v.template.constructMemberDOM(a,e),!e.find(".moreOpt").length){var n=v.template.getMoreOpt();e.prependDOM(n)}},showActivity:function(){var e=this.$el,t=e.find(".notify");t.length||(e.find(".grpImg").appendDOM(v.template.showNewActivity()),(t=e.find(".notify")).length&&t.attr(m,h.common.labels.newActivity).attr(p,"bottom"))},changeGroupName:function(){var e=$.e(this.$el),t=this.model.toJSON();e&&e.find(".groupName").length&&(e.find(".groupName")[0].childNodes[0].textContent=t.name),zmStreamsApp.GroupManageApp.editGroupDetails(this.model)},initialize:function(e){var t=this,a=t.model;t.render(e),t.listenTo(a,"change:mail",t.emailState),t.listenTo(a,"change:changepreview",this.updateLogo),t.listenTo(a,"change:memberList",this.constMembers),t.listenTo(a,"change:deleteGroup",this.deleteGroup),t.listenTo(a,"change:memberRole",this.changeRole),t.listenTo(a,"change:groupName",this.changeGroupName),t.listenTo(a,"change:showActivity",this.showActivity),t.listenTo(a,"change:streamsEnabled",t.streamsState)}}),e}(zmStreamsApp.GroupManageApp.views);
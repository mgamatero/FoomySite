"use strict";define([],function(e){var a,t=e("zmComponent.keybindings"),n="navigatorScope",i=function e(t){if(a){var n,i,o=a.dom[a.focused]||{};o.onBlur&&o.onBlur(o),a.focused=t?(i=a.focused,i=++i%a.dom.length):(n=a.focused,(n-=1)<0&&(n=a.dom.length-1),n),function(e,t){if(e)return!(e.isValidToFocus&&!e.isValidToFocus(e,t)||!e.onFocus||(e.onFocus(e,t),0))}(o=a.dom[a.focused],t)||e(t)}},o=i,r=[{uid:"next_tab",keyStr:"tab",actions:[i.bind(null,!0)]},{uid:"previous_tab",keyStr:"shift+tab",actions:[o]},{uid:"clear",keyStr:"esc",actions:[function(){if(a){var e=a.dom[a.focused]||{};(!e.onEscape||e.onEscape(e))&&a.onEscape&&a.onEscape()}}]},{uid:"onEnter",keyStr:"enter",preventDefault:!0,actions:[function(){var e;a&&((e=a.dom[a.focused]||{}).isValidToEnter&&!e.isValidToEnter(e)||e.onEnter&&e.onEnter(e))}]}],l=function(e){e=e||{},this.dom=e.dom||[],this.focused=e.focused||-1,this.onEscape=e.onEscape,this.previousScope=void 0},s=l.prototype;return s.setThisAsCurrentNavigator=function(){(a=this).previousScope=t.getScope(),t.setScope(n)},s.clearTrace=function(){a===this&&(a.dom=[],a.focused=-1,t.getScope()===n&&a.previousScope&&(t.setScope(a.previousScope),a.previousScope=void 0),a=void 0)},t.registerAll({scope:n,allowDefaultScope:!1,shortcuts:r}),zmail.Navigator=l,zmail.Navigator}),define([],function(e,t){var o=function(e,t,n){return-1!==(n=n||e.indexOf(t))&&e.splice(n,1),e},i=function(e,t){o(e.stack,t,void 0).push(t)},n=function(e){e=e||{},this.idName=e.idName||"id",this.store=e.store||{},this.objectCount=0,this.containerSize=e.containerSize||500,this.evictCount=e.evictCount||Math.ceil(.05*this.containerSize),this.considerAsHitOnRetrieval=void 0!==e.considerAsHitOnRetrieval&&e.considerAsHitOnRetrieval,this.isObjectInUse=e.isObjectInUse||function(e){return!1},this.stack=[]},a=n.prototype;return a.addObject=function(e){var t,n=this.store;this.objectCount>=this.containerSize&&function(e){var t,n,i=e.store,o=e.isObjectInUse,a=e.stack,r=a.length,l=e.objectCount,s=e.evictCount,c=0,u={};for(s=s<=r?s:r,n=0;c<s&&n<r;n++)o(t=a[n])?(a.splice(n,1),a.push(t),r-=1):(delete i[t],u[t]=n,l-=1,c+=1);e.stack=function(e,t){var n,i,o=[],a=e.length;for(i=0;i<a;i++)(n=e[i])in t||o.push(n);return o}(a,u),e.objectCount=l}(this),(t=e[this.idName])in n||(this.objectCount+=1),this.store[t]=e,i(this,t)},a.rememberAsRecent=function(e){i(this,e)},a.addObjects=function(e){var t,n;for(n=0,t=e.length;n<t;n++)this.addObject(e[n])},a.getObject=function(e){var t=this.store[e];return t&&this.considerAsHitOnRetrieval&&i(this,e),t},a.removeObject=function(e){var t,n=this.store,i=n[e];return i&&(delete n[e],t=e,o(this.stack,t,void 0),this.objectCount-=1),i},a.removeObjects=function(e){var t,n=e.length;for(t=0;t<n;t++)this.removeObject(e[t])},a.filter=function(e){var t,n=this.store,i=[];for(t in n)e(n[t])&&i.push(t);return i},zmail.Container=n,zmail.Container}),define([],function(e){var t=e("zmail.Core.Namespaces"),h=e("zmail.Utils.DOM"),n=t.create("zmail.Components.AutoFill.Helper"),m=function(){var e=h.element(h.selector("#topBar"),!0),t=h.element(h.selector("#wmstoolbar"),!0),n=h.element(h.selector(".zsw-enclosure.shw"),!0),i=document.body.getBoundingClientRect(),o={top:i.top,right:i.right,bottom:i.bottom,left:i.left};return e&&(o.top=e.getBoundingClientRect().bottom),t&&h.element(t).is(":visible")&&(o.bottom=t.getBoundingClientRect().top),n&&(o.right=n.getBoundingClientRect().left),o},i=function(e){var t,n,i,o,a,r=null,l=null,s=null,c=null,u=0,d=!0;if(s={left:0,top:0},(r=(e=e||{}).dom)&&(l=e.anchor||h.getData(r,"anchor")),r=h.element(r,!0),l=h.element(l,!0),r&&l){var f=function(e){if(!e||"TEXTAREA"!==e.nodeName)return null;var t=e.getBoundingClientRect(),n=zmail.Utils.TextArea.findCursorPosition(e),i={top:t.top+n.top,right:t.left+n.left+n.width,left:t.left+n.left,bottom:t.top+n.top+n.height,height:n.height,width:n.width};return 0<e.scrollTop&&(i.top-=e.scrollTop,i.bottom-=e.scrollTop),i}(l);t=m(),c=l.getBoundingClientRect(),f&&(c=f),h.setStyle(r,{height:"auto"}),h.setStyle(h.selector(".content-wrapper",r),{height:"auto"}),n=r.getBoundingClientRect(),s.left=c.left,s.top=c.bottom,i=Math.abs(c.top-t.top),o=Math.abs(c.bottom-t.bottom),a=Math.abs(c.left-t.left),u=f?Math.abs(c.right-t.right):Math.abs(c.left-t.right),o<n.height&&o<i&&(s.top=c.top-n.height,s.top<t.top&&(s.top=t.top),d=!1),u<n.width&&u<a&&(s.left-=Math.abs(n.width-c.width));var p=h.element(r).outerHeight()-h.element(r).height();d&&o<n.height&&(h.setStyle(r,{height:o-p+"px"}),h.setStyle(h.selector(".content-wrapper",r),{height:o-p+"px"}),h.addClass(r,"scroll-active")),!d&&i<n.height&&(h.setStyle(r,{height:i-p+"px"}),h.setStyle(h.selector(".content-wrapper",r),{height:i-p+"px"}),h.addClass(r,"scroll-active")),h.setStyle(r,{top:s.top+"px",left:s.left+"px"}),e.hidden||h.addClass(r,"shw")}},o=function(e,t){i(t)};return n.init=function(){$.subscribe("autofill/open",o),$.subscribe("autofill/items/change",o)},n.getAutofillViewPort=m,n.positionMenu=i,n}),define([],function(S){var e=S("zmText"),t=S("zmail.Core.Namespaces"),O=S("zmMention"),x=S("zmConUtil"),w=S("_zm"),k=S("zmail.Utils.DOM"),_=t.create("zmAutoFill"),n=zmail.Components.AutoFill.Helper,M=e.get("commonComponents","autofill"),l={},z={},a={key:100},P=null,E=null,A=null,T=null,D=null,B=null,I=null,N=null,u=null,d=null,r=null,o="keypress.zmAutoFill",s=null,b=function(e,t,n,i){setTimeout(function(){$.publish("autofill/items/change",{dom:e,anchor:t,hidden:i})},0)},R=function(e,t){var n={code:51,shiftKey:!0};if(P(k.element(e)).hashTag){if(t&&(t.keyCode===n.code||t.which===n.code)&&t.shiftKey)return!0;var i=O.getCaretPosition(e),o=k.getValue(e).substring(0,i),a=o.lastIndexOf("#"),r=null===o.substring(a+1,o.length-1).match(/[ \n\r]+/gim),l=o.lastIndexOf(" ");if(0<=a&&l<=a&&r)return!0}return!1},p=function(e,t,n,i,o){o=o||{};var a,r=S("zmComp"),l="",s="",c=k.getAttribute(e,"data-ty")?k.getAttribute(e,"data-ty"):"",u=!0,d=P(k.element(e));if(d.callback)d.callback(t);else{if(!t){if(!E(e).length)return!1;l=$.trim(k.getValue(e));var f=x.splitncheck(l,"object",o);if(1<f.length)return void _.contactFill("",e,i,f);t=f[0],u=Boolean(t.photo),t.class+=u?"":" SC_np"}a=t.class||"SC_cs",l="1"!==String(d.OType)||t.gid?t.fn||t.name||t[d.display]||t.eid:(t.fn?t.fn:"")+(t.ln?" "+t.ln:"")||t.eid;var p,h,m={};if("1"===String(d.OType)&&(m["data-eid"]=t.eid),(t.zid||t.id||t.gid)&&(m["data-uid"]=t.zid?t.zid:t.id),p={attr:m,name:l,img:u,ph:t.photo,iclass:"msi-close",cls:a,eid:t.eid},"function"==typeof d.onBubbleDOMCreate&&(o.modifyDOM=d.onBubbleDOMCreate),s=x.bubbleUtil(p,o)){"string"==typeof s&&(s=k.__dangerouslyParseHTML(s));var g=(h="edit"===c?k.mountAfter(s,e):k.mountBefore(s,e)).find("img");g.on("error",function e(){g=k.element(this),setTimeout(function(){g.attr("src",zmResource.get("image","SC-Photo.png"))},100),g.off("error",e)});var v=A(e,t,k.getAttribute(e,"tabindex")),C=k.getData(e);k.setData(h,{store:C.store,afill:C.afill}),k.element(h).on({keydown:function(e){T(this,e)},dblclick:function(e){"1"===String(d.OType)&&(D(this),w.stopEvents(e))},click:function(e){B(e,k.element(h))}}).attr("tabindex",v),k.selector(".msi-close",h).click(function(e){I(h),w.stopEvents(e)});var y=void 0===d.drag||d.drag;"1"===String(d.OType)&&!h.hasClass("zmerr")&&y&&N(e,h)}var z=k.element(e).parent(),b=k.getAttribute(z,"id");"edit"===c&&(k.unmount(e,!0),e=k.show(k.selector("input",z))),b&&-1!==b.indexOf("Cmp")&&61<k.element(z).height()&&"1"===String(d.OType)&&(k.setStyle(z,{overflow:"auto",height:"61px"}),r.resetHeight(z)),d.maxLength&&d.maxLength===k.element(e).siblings(".SC_cs").length?k.hide(e):_.resizeInput(e),n=void 0===n||n,k.setValue(e,""),n&&setTimeout(function(){document.activeElement===k.element(e,!0)&&k.focus(e)},0),d.actionCallback&&!i&&d.actionCallback(k.element(e),{type:"add",data:t,elm:k.element(h)})}};P=function(e){var t=k.getData(e,"store");return!!t&&w.copyOf(a[t].data)};A=function(e,t,n,i){var o=$(e).data(),a=o.store,r=o.afill;if(l[a]||(l[a]=[]),l[a][r]||(l[a][r]=[]),!i)return n?l[a][r][n-1]=t:(l[a][r].push(t),n=l[a][r].length),n;l[a][r]=t};var f=function(e){var t=$(e).data(),n=$(e).attr("tabindex");return l[t.store][t.afill][n-1]},h=function(e){var t=$(e).data();return l[t.store]&&l[t.store][t.afill]?l[t.store][t.afill]:""},H=function(e,t,n,i,o){var a,r,l=[],s=e.length,c=t.length;for(a=0;a<s;a++){for(r=0;r<c;r++){if(!o&&t[r]&&e[a][t[r]]&&-1!==e[a][t[r]].toLowerCase().indexOf(n.toLowerCase())){l.push(e[a]);break}if(o&&t[r]&&e[a][t[r]]&&e[a][t[r]].toLowerCase().startsWith(n.toLowerCase())){l.push(e[a]);break}}if(10<l.length&&!i)break}return l},i={display:"inline-block",position:"absolute",right:"12px",top:"7px",fontSize:"16px"},c={marginRight:"20px"},F=function(){return zdom("i",{className:"msi-crm",title:"CRM",style:i})},V=function(){return zdom("i",{className:"msi-fav",title:"Primary email address",style:i})},U=function(){return zdom("li",{ref:"wrapper"},zdom("div",{ref:"nameContainer",style:c},zdom("span",{ref:"name","text-placeholder":!0}),zdom("span",null,zdom("span",{ref:"email","text-placeholder":!0}))),zdom("img",{ref:"photo"}))},q=function(){return zdom("li",{ref:"wrapper"},zdom("div",null,zdom("span",{ref:"name","text-placeholder":!0})),zdom("img",{ref:"photo"}))},m=function(){return zdom("li",{ref:"wrapper"},zdom("span",{ref:"name","text-placeholder":!0}))},g=function(e){return e=e||{},zmail.ContactBook.Templates.avatar({isValidPhoto:!1,initials:zmail.ContactBook.Utils.initials(e.name||""),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})},L=function(n,e,i){var o=null,a=function(){$(e).replaceWith(o)},t=(zmail.ContactBook.getGroups(n)||[])[0];return t?(o=t.avatar(),void a()):(zmail.ContactBook.getCategories(n)||[])[0]?(o=g({name:i}),void a()):!0===zmail.Utils.EmailValidator.validate(n).status?void zmail.ContactBook.get({eid:n}).done(function(e){var t=e[0];1<e.length&&(t=e.filter(function(e){return e.attrs.eid===n})[0]),o=t?t.avatar():g({name:i}),a()}):(o=g({name:i}),void a())},j=function(e,t,n,i,o){z=t;var a,r,l="",s=w("#","zm_afill"),c=s.querySelector("ul"),u=P($(e)),d=t.length;c.innerHTML="";var f=document.createDocumentFragment();for(a=0;a<d;a++){var p=$.e(m()),h=w.getDOMReferenceMap(p,!0);l=0===a&&"onDemand"!==u.selection?"sel":"",r=u.display||"name",$(h.wrapper).attr({id:"pos"+a}),l&&$(h.wrapper).addClass(l),$(h.name).replaceWith(document.createTextNode(t[a][r])),f.appendChild(p[0])}c.appendChild(f),b(s,e)};E=function(e){var t;return t="DIV"===e.tagName?$(e).text():$(e).val(),$.trim(t)};var v=function(e,t,n){var i,o,a;if(!t&&$.q("#zm_afill .sel").length&&(t=$.q("#zm_afill .sel")[0]),t){var r=t.id,l=r.slice(3,r.length),s=P($(e));i=z[l],s.text||R(e)?(R(e)?function(e,t){if(R(e)){var n=O.getCaretPosition(e),i=E(e).substring(0,n).lastIndexOf("#"),o=k.getValue(e).substring(0,i);k.setValue(e,o+"#"+t+" "+k.getValue(e).substr(n));var a=("#"+o+t+" ").length;O.setCaretPosition(e,a)}}(e,i.name):(o=$(e)[0],a=i.name,"DIV"===o.tagName?$(o).text(a):$(o).val(a)),$(e).data("uid",i.id)):p(e,i)}n&&n(i)},C=function(e){var t=$(e).siblings("input");$(e).remove(),$(t).show(),_.resizeInput($(t))};d=function(e,t,n,i){if(!$(i).hasClass("content-wrapper")){if(i=$(i).closest("li")[0],"1"===String(t))i?_.appContact(i,e):_.fillContacts(e,"zm_afill");else if("2"===String(t)||"3"===String(t)&&R(e))v(e,i,n);else if("3"===String(t)&&$.q("#zm_afill").is(":visible")){i||(i=$.q("#zm_afill .sel")[0]);var o=i.id,a=o.slice(3,o.length),r=P(e);O.getVal(e,i,z[a],r.aliasPlusForAt)}_.removeMenu()}};var K=function(t,e,n,i,o,a){var r=s;return r?$.e(r).find(".zmDDScroll.content-wrapper ul").removeClass().addClass(i).html(""):(r=$.e(zdom("div",{id:"zm_afill",className:"SC_dd SC_zi900"},zdom("div",{className:"content-wrapper zmDDScroll"},zdom("ul",null))),!0),$.e(r).find("ul").addClass(i),s=r),$(r).data({anchor:$(t)[0]}),$(r).off("mousedown").on("mousedown",function(e){d(t,n,o,e.target),setTimeout(function(){$(t).focus()},0),w.stopEvents(e,!0)}),$(document.body).append(r),b(r,t,0,!0),r},G=/\w/,W=function(e,t,n,i,o,a,r,l){var s,c,u,d,f,p=null,h="",m="SC_P2r";if(o=String(o),a=String(a),"3"!==String(a)||R(t)){h=E(t);var g=P($(t));g.eliminateAt&&("@"===h.charAt(0)||g.aliasPlusForAt&&"+"===h.charAt(0))?h=h.substring(1,h.length):R(t)&&(c=O.getCaretPosition(t),d=(u=E(t).substring(0,c)).lastIndexOf("#"),f=u.charAt(d-1),0!==d&&" "!==f&&"\n"!==f||(h=" "===(h=u.substr(d+1)).charAt(0)||"\n"===h.charAt(0)?"":h.trim()))}else{c=O.getCaretPosition(t),d=(u=E(t).substring(0,c)).lastIndexOf("@");var v=P(t);(f=u.charAt(d-1))&&" "!==f&&"\n"!==f&&(d=-1),d<0&&v.aliasPlusForAt&&(d=u.lastIndexOf("+")),f=u.charAt(d-1),0!==d&&" "!==f&&"\n"!==f||(h=" "===(h=u.substr(d+1)).charAt(0)||"\n"===h.charAt(0)?"":h.trim());var C=u.charAt(d-1);G.lastIndex=0;var y=null!==C.match(G);0<d&&y&&(h=""),n=function(e,t){for(var n=!0,i=[],o=e.length,a=t.length,r=0;r<o;r++){n=!0;for(var l=0;l<a;l++){var s=e[r].name?"name":"fn";String(e[r][s])===String(t[l][s])&&(n=!1)}!0===n&&i.push(e[r])}return i}(n,$(t).data("mentions"))}(s=i.length?H(n,i,h,"",l):function(e,t){t=t.replace(/\./gi,"\\.").replace(/\+/gi,"\\+");var n,i=[],o=new RegExp(t,"i"),a=e.length;for(n=0;n<a&&!(e[n].match(o)&&""!==e[n].match(o)&&(i.push(e[n]),10<i.length));n++);return i}(n,h)).length?(""!==$.trim(h)&&n.length&&("2"===o?m="SC_Phr":"3"===o&&(m="SC_Pr"),"1"===a?(p=K(t,0,a,m,r),$(p).removeClass("shw")):p=K(t,0,a,m,r),"1"===o?function(e,t,n,i){z=t=t||[];var o,a=P($(e)),r=t.length,l=w("#","zm_afill"),s="",c="",u="",d=l.querySelector("ul"),f=document.createDocumentFragment();d.innerHTML="";var p={};t.forEach(function(e){var t=e.contid?String(e.contid):null;t&&(p[t]=p[t]?p[t]+1:1)});for(var h=0;h<r;h++){var m,g=$.e(U()),v=w.getDOMReferenceMap(g,!0);s="",0===h&&"onDemand"!==a.selection&&(s="sel"),c=t[h][n[0]]?t[h][n[0]]:"",c+=" "+(t[h][n[1]]?t[h][n[1]]:""),u=t[h][n[3]]?t[h][n[3]]:"",o=t[h].photo?t[h].photo:zmResource.get("image","SC-Photo.png"),$(v.wrapper).attr({id:"pos"+h}),s&&$(v.wrapper).addClass(s),$(v.name).replaceWith(document.createTextNode(c)),$(v.email).replaceWith(document.createTextNode(u||" ")),m=v.photo,$(v.wrapper).data("cdata",{id:String(t[h].zid),fn:c,eid:u,photo:o}),$(m).hide(),L(u||t[h].zid,$(m),c);var C=t[h].contid?String(t[h].contid):null;t[h].isPrimary&&1<p[C]&&zmail.showFeature&&$.e(v.nameContainer).appendDOM($.e(V(),!0)),t[h].isCRMContact&&$.e(v.nameContainer).appendDOM($.e(F(),!0)),f.appendChild(g[0])}d.appendChild(f),b(l,e)}(t,s,i):"2"===o?j(t,s):"3"===o&&function(e,t,n,i){var o,a=P($(e)),r=(z=t).length,l=w("#","zm_afill"),s="",c="",u=l.querySelector("ul");u.innerHTML="";for(var d=document.createDocumentFragment(),f=0;f<r;f++){var p=$.e(q()),h=w.getDOMReferenceMap(p,!0);s="",0===f&&"onDemand"!==a.selection&&(s="sel"),o=t[f].eid||"",c=t[f][a.display]||t[f][n[0]],$(h.wrapper).attr({id:"pos"+f,title:o}),s&&$(h.wrapper).addClass(s),$(h.name).replaceWith(document.createTextNode(c));var m=h.photo;$(m).hide(),L(o||t[f].zid,$(m),c),d.appendChild(p[0])}u.appendChild(d),b(l,e)}(t,s,i)),b(p,t)):_.removeMenu(),null!==p&&$(p).find("li").off("mouseenter").on("mouseenter",function(e){$(this).one("mousemove",function(){$(this).parent().children().removeClass("sel"),$(this).addClass("sel")})}).off("mouseleave").on("mouseleave",function(e){$(this).removeClass("sel")})},X=function(e,t,n,i,o,a,r,l){var s=function(e,t,n,i){var o,a;if(40===t.keyCode||38===t.keyCode)return(o=$.q("#zm_afill li.sel")).removeClass("sel"),(a=40===t.keyCode?o.next().length?o.next():$.q("#zm_afill li").first():o.prev().length?o.prev():$.q("#zm_afill li").last()).addClass("sel"),$.q("#zm_afill").hasClass("scroll-active")&&($.q("#zm_afill")[0].scrollTop=Math.abs($.q("#zm_afill")[0].getBoundingClientRect().top-a[0].getBoundingClientRect().top)),!0;if(13===t.keyCode)return"searchByItem"===$.q("#zm_afill .sel").data("type")?u(t,e,P($(e)),"up",!0):(d(e,n,i),t.preventDefault(),t.stopImmediatePropagation()),!0;if(8===t.keyCode){if(!E(e).length&&("1"===String(n)||"2"===String(n)))return"1"===String($(e).attr("data-kydn"))?$(e).removeAttr("data-kydn"):($(e).prev(".SC_cs").addClass("zmfc").focus(),w.stopEvents(t)),!0}else if(!(39!==t.keyCode&&37!==t.keyCode||""!==E(e)||"1"!==String(n)&&"2"!==String(n)))return w.stopEvents(t,!1),T(e,t),!0;return!1}(t,e,a,r),c=w("#","zm_afill");E(t).length?s||W(0,t,n,i,o,a,r,l):_.removeMenu(),$(t).off("focusout.autofill").on("focusout.autofill",function(){_.removeMenu()}),b(c,t)},y=function(e,t){var n,i,o;n=e,i=t,o=a.key,$(i).data("store",o),a[o]={ele:i,data:n},a.key=o+1,1<i.length?$(i).each(function(e){$(this).data("afill",e)}):$(i).data("afill",0)},J=function(e,t,n){"3"===String(n)&&setTimeout(function(){O.updateElements(t)},100)},Q=function(e){var t=e.target;!0===$(t).data().contentPasted&&($(t).data({contentPasted:!1}),function(e){if(e){var t=e.value;(t=t||"").trim(),t=(t=(t=(t=t.replace(/\n+/gim,",")).replace(/\t+/gim,",")).replace(/(?!@[^@ ]+)( +)/gim," ")).replace(/([^@]+@[^@ ;,"]+)(?:(?: *, *)|(?: *; *)|(?: +))/gim,"$1, "),e.value=t}}(t));var n=P(t);if("keyup"===e.type){var i=e.which||e.keyCode;if(27===i&&"function"==typeof n.onEscKeyPress&&n.onEscKeyPress({event:e,elem:t}),-1!==[37,38,39,40,27,30,16,17,18,91,93].indexOf(i))return}var o=n.onInputChange,a=$(t).val();"function"==typeof o&&o({type:"change",event:e,elem:t,text:a,length:a.length,isEmpty:0===a.length})},Y=function(e,t){var n,i,o;if(t=t||{},e=$(e)[0]){n=t.height,i=t.maxHeight,(o=$(e).prev(".zm_mentionbg")).css({overflow:"hidden",height:n+"px","max-height":i+"px"});var a=function(){o.scrollTop(e.scrollTop)};a(),$(e).off("scroll.mentions").on("scroll.mentions",a)}},Z=function(t,e){if(e=e||{},zmail.Utils.TextAreaResizer.resize(t,{maxHeight:function(e){var t=$(e).parents(".cmntText");0===t.length&&(t=$(e).parents(".Stask_parent"));var n=$(e).parents(".zm_mention"),i=$(e).parents(".SCS_popUp"),o=0;if(i.length){var a=$(i).find(".SC_ptit");a.length&&(o=a[0].clientHeight)}if(!t.length||!n.length)return 0;var r=t.siblings(".cmntActions"),l=0;r.length&&(l=r[0].clientHeight);var s=t.find(".zms_rep"),c=0;s.length&&(c=s[0].clientHeight);var u=t.find(".showLink"),d=0;u.length&&(d=u[0].clientHeight);var f=window.parseInt(t.css("max-height"));f=window.isFinite(f)?f:0;var p=window.parseInt(n.css("padding-top"));p=window.isFinite(p)?p:0;var h=window.parseInt(n.css("padding-bottom"));return f-(p+(h=window.isFinite(h)?h:0)+c+d+o+l)}(t),onResize:function(e){Y((e=e||{}).element,{height:e.height,maxHeight:e.maxHeight,overflow:e.overflow,heightChange:e.change}),$(t).triggerHandler("resize")},heightPadding:e.heightPadding||0}),e.resizeMentionsBG){var n=t.getBoundingClientRect();Y(t,{height:n.height,maxHeight:n.height})}},ee=function(e,t,n){if(t=$(t),e&&t.length&&"1"===(n=String(n))){var i,o="onDemand"===P(t).selection;((i=e).which||i.keyCode)!==",".charCodeAt(0)||e.shiftKey||o||(e.preventDefault(),d(t,n))}},te=function(e,t,n){var i=e.keyCode||e.which;if("1"===(n=String(n))){if((e.ctrlKey||e.metaKey)&&e.shiftKey&&65===i)return $(t).parent().find(".SC_cs").addClass("zmfc").last().focus(),e.preventDefault(),void e.stopPropagation();1===$(t).val().length&&8===e.keyCode&&$(t).attr("data-kydn","1")}else if("2"===n)13===e.keyCode?e.preventDefault():1===$(t).val().length&&8===e.keyCode?$(t).attr("data-kydn","1"):34!==e.keyCode&&33!==e.keyCode||$(t).blur();else if("3"===n&&$.q("#zm_afill").length){var o,a;38===e.keyCode||40===e.keyCode?$.q("#zm_afill").length&&e.preventDefault():13===e.keyCode||32===e.keyCode||39===e.keyCode?(o=O.getCaretPosition(t),a=$(t).val(),"%EF%BB%BF"===encodeURIComponent(a.charAt(o))&&O.setCaretPosition(t,o+1),13===e.keyCode&&$.q("#zm_afill").length&&e.preventDefault()):37!==e.keyCode&&8!==e.keyCode||(o=O.getCaretPosition(t),a=$(t).val(),"%EF%BB%BF"===encodeURIComponent(a.charAt(o-1))&&O.setCaretPosition(t,o-1))}};u=function(e,t,n,i,o){var a,r=R(t,e);n=P(t),r&&((a=P(t)).contentArray=a.hashArray(),a.compare=["name"],a.LType="2",n=a);var l,s,c,u=[],d=n.contentArray,f=function(){"3"===String(n.OType)&&Z(t,{heightPadding:n.heightPadding||0})},p=function(){o?W(0,t,u,n.compare,n.LType,n.OType,n.callback):X(e,t,u,n.compare,n.LType,n.OType,n.callback,r)};if("3"!==String(n.OType)||O.isAtTyped(t)||n.aliasPlusForAt&&O.isPlusTyped(t)||r){if(d.length||"1"!==String(n.OType)){var h=(c=[],$(t).siblings(".SC_cs").each(function(){(s=$(this).data("uid"))&&c.push(s)}),c);h=n.restrict?h.concat(n.restrict):h;var m=E(t);if(n.eliminateAt&&"@"===m.charAt(0)&&(m=m.substring(1,m.length)),"org"===d){if("3"===String(n.OType)){var g=O.getCaretPosition(t),v=E(t).substring(0,g),C=v.lastIndexOf("@"),y=v.charAt(C-1);y&&" "!==y&&"\n"!==y&&(C=-1),C<0&&n.aliasPlusForAt&&(C=v.lastIndexOf("+")),y=v.charAt(C-1),0!==C&&" "!==y&&"\n"!==y||(m=" "===(m=v.substr(C+1)).charAt(0)||"\n"===m.charAt(0)?"":m.trim())}var z={org:!0,list:h,grpId:""};n.addtolist&&(z.addtolist=n.addtolist,z.groupId=n.groupId);var b=[];z.addtolist&&(b=!0===z.groupId?zmail.ContactBook.getGroups(m):zmail.ContactBook.getGroups(z.groupId));var S=[];if(!m.trim())return;return void $.Deferred().resolve(zmail.ContactBook.get({str:m,type:["org"],expected:10,exclude:h||[],excludeMe:!n.hasOwnProperty("excludeMe")||n.excludeMe,promise:!1})).promise().done(function(e){if(l=e.map(function(e,t){var n=$.extend({},e.attrs);return zmail.ContactBook.isGroup(e)&&(n.fn=n.name),n.photo=e.photo(!0),n}),b.length){zmUtil.isNewGroupUser()&&(b=b.filter(function(e){return!0!==e.get("disabled")}));for(var t=0,n=0;l.length<10&&t<b.length;){var i=$.extend({},b[t].attrs);i.fn=i.name,i.photo=b[t].photo(!0),i.zid=b[t].id,l.push(i),t++}b.forEach(function(e){S=e.attrs.members.concat(S)}),l.forEach(function(e,t){-1!==S.indexOf(e.zid)&&l.splice(n++,0,l.splice(t,1)[0])})}10<l.length&&(l=l.splice(0,10)),u=l||[],p(),f()})}if(parseInt(d))return void zmail.ContactBook.get({groupid:d}).done(function(e){u=e.map(function(e){var t=$.extend({},e.attrs);return t.photo=e.photo(!0),t}),p(),f()});if(-1!==d.indexOf("org")&&-1!==d.indexOf(":")){var x=d.substring(d.indexOf(":")+1,d.length),w=zmail.ContactBook.getGroups(x)[0],k=h||[];if(w&&(k=k.concat(w.attrs.members)),!m.trim())return;return void $.Deferred().resolve(zmail.ContactBook.get({str:m,type:["org"],expected:10,exclude:k,excludeMe:!n.hasOwnProperty("excludeMe")||n.excludeMe,promise:!1})).promise().done(function(e){10<(l=e.map(function(e){var t=$.extend({},e.attrs);return zmail.ContactBook.isGroup(e)&&(t.fn=t.name),t.photo=e.photo(!0),t})).length&&(l=l.splice(0,10)),u=l||[],p(),f()})}u=d}else if(E(t)){var A=["personal"];zmail.isCRMServiceUser&&zmail.IntegrationStatus.CRM&&A.push("crm");var T={str:E(t),includeEmailedGroups:!0,includeCategories:!0,expected:10,type:A,excludeOrgUsers:!0,excludeInactiveUsers:!0,sliceExpected:!0};return void zmail.ContactBook.get(T).done(function(e){var n,i,o;10<(l=(e=e||[]).map(function(e){var t=$.extend({},e.attrs),n=!1;return zmail.ContactBook.isCategory(e)?(t.fn=t.cname,t.eid="["+M.category+"]",n=!0):zmail.ContactBook.isGroup(e)&&(t.fn=t.name),t.photo=n?zmResource.get("image","SC-Photo.png"):e.photo(!0),"crm"===e.type&&(t.isCRMContact=!0),t})).length&&(l=l.splice(0,10)),i={},o=[],(n=u=l||[]).forEach(function(e,t){e?e.cid?o.push(e):i[e.eid]||(i[e.eid]=!0,o.push(e)):n.splice(t,1)}),u=o,p(),f()})}p()}else _.removeMenu();f()},B=function(e,t){if("IMG"===e.target.nodeName)return x.showContactCard({dom:$(t)[0],email:$(t).data("eid"),event:e,source:"compose"}),void w.stopEvents(e);if($(t).siblings("input").blur(),e.shiftKey)if($(t).siblings(".zmfc").length){var n=$(t).siblings(".zmfc").index(),i=$(t).index();i<n?$(t).parent().children().slice(i,n).addClass("zmfc"):$(t).parent().children().slice(n,i+1).addClass("zmfc")}else $(t).addClass("zmfc");else e.ctrlKey||e.metaKey?$(t).toggleClass("zmfc"):($(t).parent().children(".zmfc").removeClass("zmfc"),$(t).addClass("zmfc"));$(t).focus(),w.stopEvents(e)},D=function(e){$(e).siblings("input").hide();var t,n=$.e(zdom("input",{type:"text"})).insertDOMBefore(e),i=$(e).attr("tabindex"),o=f($(e));return t=x.constructContact({firstName:o.fn,lastName:o.ln,email:o.eid}),$(n).val(t).attr("size",t.length).attr("tabindex",i).data($(e).data()).on("keydown",function(e){r(this,e)}).on("focusout.autofill",function(e){_.fillContacts(n,"edit"),w.stopEvents(e)}).focus(),$(e).remove(),$(n)[0].setSelectionRange(0,0),$(n).select(),$(n)},r=function(t,e){13===e.keyCode&&(_.fillContacts(t,"edit"),w.stopEvents(e));var n=P($(t).siblings("input"));8===e.keyCode&&te(e,t,n.OType),""===$.trim($(t).val())&&(I($(t)),$(t).attr("data-ty","edit"),$(t).off("keyup").keyup(function(e){u(e,$(t),n,"up")}),$(t).off("keydown").keydown(function(e){te(e,$(t),"1")}),$(t).off(o).on(o,function(e){ee(e,$(t),"1")}),$(t).off("blur.autofill").on("blur.autofill",function(){_.fillContacts($(t),"edit")}))},T=function(e,t){var n,i=t.keyCode||t.which;if(13===t.keyCode)return w.stopEvents(t),void D(e);if((t.ctrlKey||t.metaKey)&&65===i)return $(e).parent().find(".SC_cs").addClass("zmfc"),void w.stopEvents(t);if((t.ctrlKey||t.metaKey)&&t.target&&"DIV"===t.target.tagName){var o=w("#","zmafill_hid");null===o&&(o=$.e(zdom("textarea",null)).attr({id:"zmafill_hid"})[0],$(o).css({opacity:0}),document.body.appendChild(o));var a,r=$(e).parent().find(".zmfc"),l=0,s=r.length||0,c="";for(l=0;l<s;l++)0!==l&&(c+=","),(a=f(r[l])).fn&&(c+=a.fn),c+="<"+a.eid+">";o.value=c,o.select();try{document.execCommand("copy")}catch(e){}setTimeout(function(){$(o).remove(),$(e).focus()},0)}else{if(39===t.keyCode){$(e).removeClass("zmfc");var u=$(e).next(".SC_cs");0===$(e).next(".SC_cs").length&&(u=$(e).next("input")),n=$(u).focus()}else if(37===t.keyCode)1===$(e).prev(".SC_cs").length&&$(e).removeClass("zmfc"),n=$(e).prev(".SC_cs");else if(8===t.keyCode){if("INPUT"===$(e)[0].tagName&&1===$(e).val().length)return $.q("#zm_afill").hide(),void w.stopEvents(t);var d=$(e).siblings("input");0===$(e).siblings(".SC_cs").length?($(d).focus(),n=$(d)):!(n=$(e).prev(".SC_cs")).length&&$(e).next(".SC_cs")&&(n=$(e).next(".SC_cs")),$(e).parent().children(".zmfc").each(function(){I($(this))}),w.stopEvents(t,!1)}$(n).hasClass("zm_sgst")||$(n).addClass("zmfc").focus(),t.ctrlKey||t.metaKey||w.stopEvents(t)}};N=function(e,t){var n=$(e).parent().attr("id"),i=n.substring(n.indexOf("Cmp")+3,n.length);$(t).draggable({revert:"invalid",containment:"#zmdArea_Cmp"+i+".zmdrop",scroll:!1,helper:function(){return $(this).clone().css({width:this.offsetWidth,position:"relative","z-index":"1"})[0]},addClasses:!1,drag:function(e,t){e.stopPropagation()},start:function(){$(this).hide()},stop:function(e,t){$(t.helper[0]).remove(),$(this).show()}}),$.q("#zmdArea_Cmp"+i+" .zmdrop").each(function(){$(this).droppable({drop:function(e,t){var n=t.draggable,i={};(i=f($(n))).class=$(n).attr("class"),p($(this).children("input"),i),I($(n)),w.stopEvents(e,!0)}})})};var ne={appContact:function(e,t){var n=$(e).data("cdata");if(n&&n.hasOwnProperty("crm"))p(t,n);else{var i=$(e).attr("id");i=i.substring(3,i.length);var o=z[i];o.cid?($(t).val(""),zmail.ContactBook.get({categoryid:o.cid,includeOnlyPrimary:!0}).done(function(e){e.forEach(function(e){p(t,e.attrs)})}).fail(function(){window.console.log("Error while fetching contacts for category !")})):p(t,o)}},fillContacts:function(t,e,n,i){var o,a=0;""===e&&(e="zm_afill");var r=P($(t));if(n)for(var l in n){Array.isArray(n[l])||(n[l]=[n[l]]),a=(o=n[l]).length;for(var s=0;s<a;s++)p(t,o[s],!1)}else if(!i)if(1===x.parseContacts($(t).val()).length||r.supressBlur)if("edit"!==e||$.q("#"+e).is(":visible"))if($.q("#"+e).is(":visible")){var c=$.q("#"+e+" .sel"),u=c.attr("id"),d=c.data("cdata");if(d&&d.hasOwnProperty("crm"))p(t,d);else if(r=P($(t)),u){u=u.substring(3,e.length);var f=z[u];f.cid?zmail.ContactBook.get({categoryid:String(f.cid),includeOnlyPrimary:!0}).done(function(e){e.forEach(function(e){p(t,e.attrs)})}).fail(function(){window.console.log("Error while fetching contacts for category !")}):p(t,f)}else r.callback&&r.callback()}else E($(t)[0])&&p(t);else""===$(t).val()&&(I($(t)),C($(t))),$(t).attr("data-ty","edit"),p(t);else"edit"===e&&""===$(t).val()?(I($(t)),C($(t))):_.contactFill($(t).val(),t);return $.q("#"+e).hide(),!0},getAddress:function(e,t,n){var i,o,a,r,l,s=h(e),c=[],u=0,d=s.length;if(a=0!==$(e).siblings(".zmerr").length,"String"!==t&&"id"!==t)return s;for(u=0;u<d;u++)r=s[u],"id"===t?(i=r.id?r.id:r.zid,c.push(i)):r.class&&-1!==r.class.indexOf("zmerr")||(l=x.constructContact({email:r.eid,firstName:r.fn,lastName:r.ln}),c.push(l));return o=(c=c||[]).join(","),n?{address:o,count:d,error:a}:o},clearData:function(e,t){var n,i,o;n=e,i=t,(o=k.getData(n))&&(l[o.store]&&l[o.store][o.afill]&&("reuse"===i?l[o.store][o.afill]=[]:delete l[o.store]),a[o.store]&&"reuse"!==i&&delete a[o.store])},clearView:function(e){$(e).parent().find(".SC_cs").remove()},resizeInput:function(e){(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).resetWidth&&$(e).css({width:"auto"});var t=$(e).parent(),n=$(t).width(),i=$(t).children(".SC_cs").length,o=0,a=0;$(t).children(":not(.SC_cs)").each(function(){$(e)[0]!==$(this)[0]&&(a+=$(this).width())});var r=!1;if(0<i){var l=$(t).children(".SC_cs:last"),s=$(t).offset().left,c=$(l).width(),u=$(l).offset().left;o=(r=n-(u-s+c)-a<50)?n-a-30:n-(u-s+c)-a-30}else o=n-a-30;return $(e).attr("placeholder")&&$(e).data("placeholder",$(e).attr("placeholder")),0===i&&$(e).data("placeholder")?$(e).attr("placeholder",$(e).data("placeholder")):$(e).attr("placeholder",""),61<=$(t).height()&&($(t).scrollTop($(t).scrollTop()+61),$(t).css({height:"61px","overflow-y":"auto"}),$(t)[0].scrollTop=$(t)[0].scrollHeight),0===$(t).scrollTop()&&$(t).height("auto"),$(e).width(o),{isNextLine:r}},mentionData:function(e,t){var n=null;return t?A(e,t,"",!0):(O.updateElements(e),n=h(e)),n},updateArray:function(e,t,n){var i=$(e).data("store");n&&(a[i].data.restrict=n),t&&(a[i].data.contentArray=t)},removeContact:I=function(e){var t,n,i,o=$(e).siblings("input"),a=P($(e)),r=(t=$(e),n=$(t).data(),i=$(t).attr("tabindex"),l[n.store][n.afill].splice([i-1],1));"INPUT"!==$(e)[0].tagName&&$(e).remove(),$(o).siblings(".SC_cs").each(function(e){$(this).attr("tabindex",e+1)}),a.maxLength&&a.maxLength>$(e).siblings(".SC_cs").length&&!$(o).is(":visible")&&$(o).show(),a.actionCallback&&a.actionCallback($(o),{type:"remove",data:r[0]}),_.resizeInput(o)},contactFill:function(e,t,n,i,o){var a,r,l;for(o=o||{},i=i||[],r=(a=!e&&i.length?i:("compose"===o.source&&(e=function(e){var t,n=e=e||{},i=/(?:@[^@>]+>) *(,{1})/gim,o=/(.*)(?=<)/i,a=null,r=[];for(a=i.exec(n);null!==a;)r.push(n.substr(0,a.index+a[0].length)),n=n.substr(a.index+a[0].length),i.lastIndex=0,a=i.exec(n);return(n=n.trim())&&r.push(n),e=(r=r.map(function(e){return o.lastIndex=0,(a=o.exec(e))&&(t=(a[0]||"").trim())&&'"'!==t.charAt(0)&&'"'!==t.charAt(t.length-1)&&(t='"'+(t=t.replace(/"/i,'\\"'))+'"',e=e.substr(a[0].length),e=t+" "+e),e})).join(" ")}(e)),x.splitncheck(e,"object",o))).length,l=0;l<r;l++)p(t,a[l],!1,n,o);_.resizeInput(t)},addGroupData:function(e,t){var n;for(n in t)p(e,t[n],!1);_.resizeInput(e)},setAutofill:function(i,t,e){e=e||{};var n=String(a.key-1);if(i.keyID=n,"1"===String(i.OType)&&($(t).on("paste.emailInput",function(e){var t;t=e.target,$(t).data({contentPasted:!0})}),$(t).on("keyup.emailInput",function(e){Q(e)}),$(t).on("change.emailInput",function(e){Q(e)}),$(t).on("focus.emailInput",function(e){var t=i.onInputFocusBlur;"function"==typeof t&&t({type:"focus",event:e,elem:e.target})}),$(t).on("blur.emailInput",function(e){var t=i.onInputFocusBlur;"function"==typeof t&&t({type:"blur",event:e,elem:e.target})})),"3"===String(i.OType)){if($(t).parent().hasClass("zm_mention"))return;$(t).wrap(zdom("div",{className:"zm_mention",style:{color:"transparent"}})),$(t).before(zdom("div",{className:"zm_mentionbg"})),$(t).on("change",function(){Z(this,{heightPadding:i.heightPadding||0})}),$(t).on("input",function(e){var t,n;t=this,n=i.OType,"3"===String(n)&&O.updateElements(t)}),$(t).on("paste.autofill",function(e){J(0,this,i.OType)}),i.resize&&$(t).focusin(function(){Z(this,{heightPadding:i.heightPadding||0})}),i.resize||$(t).on("focusout.autofill",function(){""===$(this).val().trim()&&$(this).removeAttr("style")}),$(t).on("paste",function(e){J(0,this,i.OType)})}else $(t).hasClass("zm_sgst")||$(t).addClass("zm_sgst");y(i,t);return $(t).off("keyup.autofill").on("keyup.autofill",function(e){u(e,this,i,"up")}),$(t).off("keydown.autofill").on("keydown.autofill",function(e){te(e,this,i.OType)}),"1"!==String(i.OType)||i.supressBlur||$(t).off("blur.autofill").on("blur.autofill",function(){_.fillContacts(this,"zm_afill",null)}),$(t).off(o).on(o,function(e){ee(e,this,i.OType),function(e,t,n,i){if("3"===String(n)&&(64===e.keyCode||64===e.which)&&(O.isAtPressed=!0,i))if(O.getMentions(t)&&O.getMentions(t).length)O.isAtPressed=!1;else{var o=t.value;O.getCaretPosition(t)<o.replace(/\s+$/,"").length&&(e.preventDefault(),w.succErrMsg("e",M.errors.placedNotAtEnd))}}(e,this,i.OType,i.oneMention),i.keyCallback&&i.keyCallback(i.keyParam),"3"!==String(i.OType)||13!==e.which&&13!==e.keyCode||(e.preventDefault(),function(e,t){t=t||{};var n,i=(e=$(e)[0]).value,o=e.selectionStart,a=e.selectionEnd;n=(i.substring(0,o)||"")+"\n"+(i.substring(a)||""),e.value=n;var r=Math.abs(n.length-1-i.length);e.selectionStart=a-r+1,e.selectionEnd=e.selectionStart,O.updateElements(e),Z(e,{heightPadding:t.heightPadding||0}),0<e.scrollTop&&e.scrollHeight>e.clientHeight&&e.selectionEnd===n.length&&(e.scrollTop=e.scrollHeight-e.clientHeight)}(t,{heightPadding:i.heightPadding||0}))}),a.key-1},removeAutoFill:function(e){var t,n=a[e];n&&(delete a[e],(t=n.ele)&&($(t).off("change input paste focusout keyup keydown blur"),$(t).off(o)))},filterArray:H,showAutoFill:function(e,t){K(e,t.contentArray,t.OType,"SC_Phr",t.callback),j(e,t.contentArray,t.compare,t.OType,t.callback)}};return ne._dataStore={cacheData:function(){return l},fillData:function(){return z},storeData:function(){return a}},ne.removeMenu=function(){s&&(k.unmount(s,!0),s=null)},ne.isVisible=function(){return Boolean(s)},ne.resizeTextArea=Z,n.init(),$.extend(!0,_,ne)}),define([],function(y){var e=y("zmail.Core.Namespaces"),z=zmail.Utils.DOM,d=e.create("zmMention"),b=function(e){return z.getData(e,"mentions")||[]},S=function(e,t){var n=y("_");t=t||[];var i=z.getData(e,"prevMentions")||[],o=t.length-i.length,a=!1,r=function(e){return e.zid},l=i.map(r),s=t.map(r),c=[];c=0<o?(a=!0,n.difference(s,l)):n.difference(l,s),o=Math.abs(o),z.setData(e,"mentions",t),0<o&&z.element(e).triggerHandler("mentions/change",{mode:a?"add":"remove",count:o,zidList:c}),z.setData(e,"prevMentions",[].concat(t))},t={isAtPressed:!1,getCaretPosition:function(e){var t=0;if(document.selection){e.focus();var n=document.selection.createRange();n.moveStart("character",-e.value.length),t=n.text.length}else(e.selectionStart||0===e.selectionStart)&&(t=e.selectionStart);return t},getSelection:function(e){var t={};return t.start=e.selectionStart,t.end=e.selectionEnd,t},setSelection:function(e,t){e.focus(),e.setSelectionRange(t.start,t.end)},insertAtCursor:function(e,t){if(document.selection)e.focus(),document.selection.createRange().text=t;else if(e.selectionStart||0===e.selectionStart){var n=e.selectionStart,i=e.selectionEnd;e.value=e.value.substring(0,n)+t+e.value.substring(i,e.value.length),e.selectionStart=n+t.length,e.selectionEnd=n+t.length}else e.value+=t},insertNodeAtCaret:function(e){var t=window.getSelection();if(t.rangeCount){var n=t.getRangeAt(0);n.collapse(!1),n.insertNode(e),n.selectNodeContents(e),n.collapse(!1),t.setSingleRange(n)}},getMentions:function(e){return b(e)},getUserText:function(e){return d.updateElements(e,!0)},setCaretPosition:function(e,t){if(null!==e)if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else void 0!==e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},isCharTyped:function(e,t){var n=d.getCaretPosition(t),i=$.trim(z.getValue(t)).substring(0,n),o=i.lastIndexOf(e),a=i.lastIndexOf(" "),r=i.lastIndexOf("\n");return 0<=o&&(a<=o||r<=o)},isAtTyped:function(e){return d.isCharTyped("@",e)},isPlusTyped:function(e){return d.isCharTyped("+",e)},getVal:function(e,t,n,i){!t&&z.selector(".SC_Psli").length&&(t=z.element(z.selector(".SC_Psli"),!0)),t&&function(e,t,n){var i=d.getCaretPosition(e),o=z.getValue(e).substring(0,i),a=o.lastIndexOf("@"),r=o.charAt(a-1);r&&" "!==r&&"\n"!==r&&(a=-1),a<0&&n&&(a=o.lastIndexOf("+")),(r=o.charAt(a-1))&&" "!==r&&"\n"!==r&&(a=-1);var l=t.name||t.fn;if(0<=a){var s=z.getValue(e).substring(0,a);z.setValue(e,s+l+"\ufeff"+z.getValue(e).substr(i));var c=(s+l+"\ufeff").length;d.setCaretPosition(e,c),t.from=s.length,t.to=c}var u=b(e);u.length&&u[0].from>=t.from?u.unshift(t):u.push(t),S(e,u),d.updateElements(e)}(e,n,i),d.isAtPressed=!1},placeCaretAfterNode:function(e){var t,n;window.getSelection&&(t=window.getSelection()).rangeCount&&((n=t.getRangeAt(0)).setStartAfter(e),n.setEndAfter(e),t.removeAllRanges(),t.addRange(n))},placeCaretBeforeNode:function(e){var t,n;window.getSelection&&(t=window.getSelection()).rangeCount&&((n=t.getRangeAt(0)).setStartBefore(e),n.setEndBefore(e),t.removeAllRanges(),t.addRange(n))},updateElements:function(e,t){var n,i,o,a,r,l=y("zmCont"),s=y("zmAutoFill"),c=z.getValue(e)||"",u=z.element(e).siblings(".zm_mentionbg"),d=b(e),f=0,p=[],h=[],m=[],g=[];for(f=0;f<d.length;f++)n=d[f].name||d[f].fn,i=d[f].id||d[f].zid;a=c.replace(/</g,"&lt;").replace(/>/g,"&gt;");var v=z.getData(e,"gid")||"",$="";for(f=0;f<d.length;f++){n=d[f].name||d[f].fn,i=d[f].id||d[f].zid,-1!==(r=c.indexOf(n+"\ufeff"))&&p.push(d[f]),$="zm_groupMember",v&&v!==d[f].zid&&($=l.isGroupMember(d[f].zid,v)?"zm_groupMember":"zm_otherMember"),o=r,h.push(o),m.push(o+n.length),g.push(i);var C=zdom("b",{className:$,z:i},n.replace(/\$/gim,"$$$$"));C=z.element(C,!0).outerHTML,a=a.replace(n+"\ufeff",C)}return h.length&&s.mentionData(z.element(e),{from:h,to:m,text:g}),"\n"===a.charAt(a.length-1)&&(a+=" "),z.__dangerouslySetInnerHTML(u,a),S(e,p),t?c.replace(/\uFEFF/gi," "):z.getValue(e)},clearMention:function(e){z.removeData(e,"mentions"),z.removeAttribute(e,"style"),z.clearHTML(z.element(e).siblings(".zm_mentionbg"))},resizeTArea:function(e,t,n){n||(e.style.height="auto");var i=e.offsetHeight-e.clientHeight,o=e.scrollHeight+i+"px";e.style.height=o,t||""!==z.getValue(e).trim()||z.removeAttribute(e,"style")}};return $.extend(!0,d,t)}),function(){var o,e=zmail.Core.Namespaces.create("zmComponent"),t="slideUp",n="/announcement/show",i="/announcement/hide",a=zmText.get("commonComponents","announcement"),r=function(e){var t="";"s"===e?t=n:"h"===e&&(t=i),setTimeout(function(){$.publish(t)},"200")},l=function(){$.e(o.wrapper).removeClass("show"),setTimeout(function(){$.e(o.wrapper).remove(),o=void 0,r("h")},300)},s=function(e){$.e(o.wrapper).hasClass(t)?($.e(o.wrapper).removeClass(t),r("s")):($.e(o.wrapper).addClass(t),r("h"))};e.showAnnouncementBanner=function(e){var t,n,i;e=e||{},o&&o.wrapper&&l(),t=_zm.getDOMReferenceMap(zdom("div",{ref:"wrapper",className:"zmTopAnnBan show"},zdom("div",{ref:"topbandWrapper",className:"zmTopAnnBanWra"},zdom("span",{ref:"contentArea",className:"zmTopAnnBanMsg"}),zdom("i",{ref:"slideUp",className:"msi-prev slideHit"}),zdom("span",{ref:"close",className:"zmBanDis"})),zdom("div",{ref:"toggler",className:"zmTopAnnBanTog"})),!0),"html"===e.contentType?($.e(t.contentArea).dangerouslySetInnerHTML(e.content),e.isWarning&&($.e(t.topbandWrapper).prependDOM(zdom("i",{className:"msi-warning zmDoubleIcon",style:{fontSize:"20px",verticalAlign:"middle",marginRight:"5px"}})),t.contentArea.className="",t.contentArea.style.color="white",t.contentArea.style.cursor="pointer",t.contentArea.style.lineHeight="36px")):"text"===e.contentType&&$.e(t.contentArea).text(e.content);n=t,(i=e).definedClose?$.e(n.close).text(i.definedCloseTxt):$.e(n.close).text(a.doNotShow),$.e(n.slideUp).on("click",s),$.e(n.close).on("click",function(e){l(),"function"==typeof i.closeAction&&i.closeAction()}),$.e(n.toggler).on("click",s),$.e(zmsuite.$el.zmBody).prependDOM(t.wrapper),r("s"),o=t}}();
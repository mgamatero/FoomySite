"use strict";define([],function(e){var t=zmail.Core.Namespaces,a=t.create("ZMail.listing"),i=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getUrl",value:function(){var e="".concat(zmail.conPath,"/ml.do");return zmail.isAgentReqEnabled&&zmail.ZMServerUrl?"//".concat(zmail.ZMServerUrl+e):e}},{key:"serialize",value:function(e){var t=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).attributes,a=2<arguments.length?arguments[2]:void 0,i={};switch(e){case"fetchMails":case"fetchThdList":case"fetchContent":case"doMailAction":case"fetchMailMeta":i=a.p;break;case"updThdInfo":i={accId:zmail.accId,tId:a.msgId,folderSpec:2,mode:"metadata"};break;case"fetchNDaysEmails":i={accId:zmail.accId,days:a.days||7,mode:"initialFetch",limit:500},a.fetchFromMId&&(i.msgId=a.fetchFromMId);break;case"getLatestChangeId":i={mode:"getLatestcid"};break;case"fetchNDaysChanges":i={accId:zmail.accId,mode:"offlineSync",limit:a.changesLimit,changeId:a.syncFromchangeId,days:a.days||7};break;case"fetchNDaysConvEmails":i={accId:zmail.accId,days:a.days||7,mode:"getThreadInfo",threadIds:a.threadIds,newFlow:!0};break;case"trustedSender":case"rejectedSender":case"phishingEmail":i={accountId:zmail.accId,messageId:a.msgId,isSpam:a.isSpam,mode:e},a.toBeAffectedEmailIds&&(i.emailId=a.toBeAffectedEmailIds.join());break;case"languageTranslation":i={accId:zmail.accId,accountId:zmail.accId,messageId:a.msgId,fromLang:a.fromLanguage,toLang:a.toLanguage,mode:"languageTranslation",loadExternalImage:a.loadExternalImage,split:!0,vfc:!0};var n=t.FD;n&&zmUtil.isSharedFolder(n)&&Object.assign(i,{shId:zmUtil.getShareId(n)}),t.newStreams&&Object.assign(i,{groupId:t.groupId,entityId:t.M,entityType:1,accId:t.accId,accountId:t.accId,streamsView:!0})}return i}},{key:"normalize",value:function(e,t,a){var i;switch(e){case"fetchMails":case"fetchContent":case"doMailAction":case"updThdInfo":case"fetchNDaysEmails":case"fetchNDaysChanges":case"fetchNDaysConvEmails":case"getLatestChangeId":case"fetchMailMeta":i=t;break;case"fetchThdList":i=t.tdata;break;default:i=t}return i}}]),t}(t.get("zmail.DataLayer").Adapter.HTTPAdapter);return a.HTTPAdapter=i,a}),define([],function(f){var e=zmail.Core.Namespaces,a=e.create("ZMail.listing.config"),t=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getBaseModelClass",value:function(){return a.model}},{key:"createListObj",value:function(e,t){t instanceof Array?this.listMap[e]={MO:t}:this.listMap[e]=t}},{key:"resetListMap",value:function(){this.listMap={}}},{key:"setListObj",value:function(e,t,a){this.listMap[e][t]=a}},{key:"getListObj",value:function(e,t,a){if(a)return this.listMap;var i=this.listMap[e];return t?i&&i[t]:i}},{key:"clearMap",value:function(e){delete this.listMap[e]}},{key:"clearMsgFromListMap",value:function(e,t){var a=this.getListObj(t,"MO")||[],i=a.indexOf(e);-1!==i&&a.splice(i,1)}},{key:"getValue",value:function(e){var t=e.key,a=e.keyPath;return a?_zm.getProperty(this,a):this[t]}},{key:"updateProperty",value:function(e){var t=e.keyPath,a=e.value,i=e.opType,n=this.getValue({keyPath:t});if("add"===i)n.push(a);else if("remove"===i){var r=n.indexOf(a);-1!==r&&n.splice(r,1)}}},{key:"setViewDetails",value:function(e,t){"string"==typeof t&&(t=$.parseJSON(t)),this.viewInfo[e]=t}},{key:"getViewDetails",value:function(e){return this.viewInfo[e]}},{key:"storeDMap",value:function(e,t){var a=this,i={MO:[],showNextPage:0},n=(t=t||{}).mapId,r=t.startIndex,s=t.overWrite;return e.forEach(function(e,t){e.M?(a.set(e,{parse:!0,parseData:{overWrite:s}}),i.MO.push(e.M)):void 0!==e.showNextPage?i.showNextPage=e.showNextPage:e.stateinfo?i.showNextPage=e.stateinfo.showNextPage:void 0!==e.showMore&&(i.showNextPage=e.showMore)}),n&&(a.listMap[n]&&r&&1!==r?(a.listMap[n].MO=a.listMap[n].MO.concat(i.MO),a.listMap[n].showNextPage=i.showNextPage):a.listMap[n]=i),i}},{key:"clearModel",value:function(e){var t=this.get(e);t&&this.remove(t)}},{key:"clearModels",value:function(i){var n=this,e=i.listId,t=n.listMap[e]||{};t=t.MO||[];var r,s,l,o,c,d=[];t.forEach(function(e){r=n.get(e)||{},l=r.attributes;var t=f("zmUtil"),a=f("zmList");!l||t.isMailContentInUse(e)||a.isMailListedInSearch(e)||t.isDraftMail(e)?l&&i.reinit&&l.TH&&(o=l.T,$.publish("/mail/threadUpdated",o)):l.TH?(o=l.T,(c=(c=n.listMap[o]||{}).MO||[]).length?(c.forEach(function(e){s=n.get(e),d.push(s)}),n.clearMap(o)):d.push(r)):d.push(r)}),n.remove(d)}},{key:"clearMapDModels",value:function(e){var t=this,a=f("zmUtil");t.clearMap("unread"),t.clearMap("all"),t.clearMap("flag");var i,n=t.getListObj("","",!0);for(i in n)(a.isFolderId(i)||a.isSharedFolder(i)||a.isLabelId(i))&&(e&&t.clearModels({listId:i,reinit:!0}),t.clearMap(i))}},{key:"fetchMailList",value:function(e){e.parse=!0;var n=new Promise(function(t){_zm.isOfflineLockAvailable()&&e.p&&e.p.folId?ZMail.IDB.fwInstance.fetchOfflineEmails({folId:e.p.folId}).then(function(e){return t(e)},function(){return t()}):t()});zmail.isAgentReqEnabled&&zmail.ZMServerUrl&&(e.ajaxProps={xhrFields:{withCredentials:!0}}),this.triggerAction("fetchMails",e).then(function(e){var t=e.opts,a=e.resp,i=t.ep;n.then(function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];e.length&&(i.hasOfflineEmails=!0,i.hasOnlineEmails=1<a.length?1:0,a=e.concat(a)),"function"==typeof t.fn&&t.fn(a,i)})},function(){e.efn()})}},{key:"doMailAction",value:function(e){if(!ZMail.utils.isROMode()){return this.triggerAction("doMailAction",e).then(function(e){var t=e.opts,a=e.resp;"function"==typeof t.fn&&t.fn(a,t.ep)},function(){e.efn()})}}},{key:"fetchThdList",value:function(e){var i=this;return e.parse=!0,e.url=e.u,i.triggerAction("fetchThdList",e).then(function(e){var t=e.opts,a=e.resp;a.hasOwnProperty("tdata")&&(a=a.tdata),i.storeDMap(a,{mapId:t.p.thId,startIndex:t.p.thdindex}),zmUtil.isInlineCompose()&&zmUtil.mapDraftId(t.p.thId),"function"==typeof t.fn&&t.fn(a,t.ep)},function(){e.efn()})}},{key:"fetchContent",value:function(e,t){var a=ZMail.listing.collection;return t.url=t.u,!0===_zm.getProperty(t,"ep.isOfflineEmail")&&(t.avoidCache=!0,t.adapterId="indexDB"),a.triggerAction("fetchContent",t).then(function(e){return e.resp})}},{key:"fetchMailMeta",value:function(e){var t=this;return new Promise(function(a,i){var n=t;return e.url=zmail.conPath+"/md.do",e.hideErrorMsg=!0,n.triggerAction("fetchMailMeta",e).then(function(e){var t=e.resp.msgMetaData;Array.isArray(t)&&(t=t[0]),!_.isEmpty(t)&&1<Object.keys(t).length?(n.set(t,{parse:!0}),a(t)):i()}).catch(function(){i()})})}},{key:"getLatestChangeId",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return e.url=zmail.conPath+ZMail.lConstants.apiPath.offline,e.hideErrorMsg=!0,this.triggerAction("getLatestChangeId",e)}},{key:"fetchNDaysEmails",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return e.url=zmail.conPath+ZMail.lConstants.apiPath.offline,e.setSessionId=!0,e.hideErrorMsg=!0,this.triggerAction("fetchNDaysEmails",e)}},{key:"fetchNDaysChanges",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return e.url=zmail.conPath+ZMail.lConstants.apiPath.offline,e.setSessionId=!0,e.hideErrorMsg=!0,this.triggerAction("fetchNDaysChanges",e)}},{key:"fetchNDaysConvEmails",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return e.url=zmail.conPath+ZMail.lConstants.apiPath.offline,e.setSessionId=!0,e.hideErrorMsg=!0,this.triggerAction("fetchNDaysConvEmails",e)}}]),t}(e.get("zmail.DataLayer").DSCollection);return a.collection=t,a}),define([],function(e){var t=zmail.Core.Namespaces,a=t.create("ZMail.listing.config"),i=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getIdAttribute",value:function(){return"M"}},{key:"parse",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},a=e.M,i=this._collection.get(a);if(!(i=i&&i.attributes))return e.opened=1,e;var n,r,s=0,l=i.PA;return e.opened=i.opened,e.TH&&(t.overWrite||(s=i.TC,e.DC=i.DC||e.DC,e.DMID=i.DMID,n=void 0===i.TS?void 0!==e.TS?e.TS:e.S:i.TS,e.TS=n,e.TI=i.TI||e.TI||!1,e.TM=i.TM||e.TM||!1,e.TF=i.TF||e.TF||!1,r=e.TSN!==i.TSN?i.SN:e.SN,e.SN=r,e.TSM=i.TSM||e.TSM||"",e.TSN=i.TSN||e.TSN||"",e.TTAGS=e.TTAGS||i.TTAGS||[],e.TSB=i.TSB||e.TSB||"",e.TA=i.TA||e.TA,e.TOADDR=i.TOADDR||e.TOADDR,e.TSNADDR=i.TSNADDR||"",0<e.TC&&(s=e.TC),e.TC=s),e.SM=i.SM||e.SM,e.TO=i.TO||e.TO),l&&(e.PA=l),e.opened+=1,0===e.TC&&(e.TC=1),void 0===e.FD&&e.TAG[0]&&(e.FD=e.TAG[0]),e}},{key:"updateThdProperties",value:function(a){var i=this;return a.url=zmail.conPath+"/getThdCount.do",i.triggerAction("updThdInfo",a).then(function(e){i._collection.set(e.resp,{parse:!0});var t=_zm.getProperty(a,"ep.deferredObj");t&&t.resolve()},function(e){})}},{key:"antiSpamAction",value:function(e){var t=e.msgId,a=e.mode,i=e.isSpam,n=e.toBeAffectedEmailIds,r=void 0===n?[]:n,s={url:zmail.conPath+"/antiSpam.do",msgId:t,isSpam:i};return r.length&&(s.toBeAffectedEmailIds=r),this.triggerAction(a,s)}},{key:"fetchTranslatedContent",value:function(e){var t=e.msgId,a=e.fromLanguage,i=e.toLanguage,n=e.loadExternalImage,r={url:zmail.conPath+"/parser",fromLanguage:a,toLanguage:i,msgId:t,hideErrorMsg:!0,loadExternalImage:n};return this.triggerAction("languageTranslation",r)}}]),t}(t.get("zmail.DataLayer").DSModel);return a.model=i,a}),define([],function(t){var e=zmail.Core.Namespaces,a=t("ZMail.listing"),i=e.create("ZMail.listing.init"),n=t("ZMStore");return i.registerCollection=function(){var e={adapters:[{id:"http-adapter",type:"default",classObj:a.HTTPAdapter}],default:"http-adapter"};_zm.isOfflineLockAvailable()&&e.adapters.push({id:"indexDB",type:"offline",classObj:ZMail.IDB.adapter}),a.collection=n.createInstance("mailListing",a.config.collection,{adapterConfig:e,offlineEnabled:_zm.isOfflineLockAvailable()}),Object.assign(a.collection,{listMap:{},viewInfo:{},antispam:{trustedSenders:[]}}),t("zmContentCache").getCacheStore()._fetchMethod=a.collection.fetchContent},i});
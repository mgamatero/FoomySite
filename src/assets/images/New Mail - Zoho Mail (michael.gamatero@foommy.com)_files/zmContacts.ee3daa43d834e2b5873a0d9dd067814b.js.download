"use strict";!function(e){var n=zmText.get("zmContacts"),U={},L={},u={},O={},I={},r=[],s=[],l=[],m={},c={},d=[],f=[],i=$.Deferred(),p=!1,z=!1,v=function(e,t){if((t=t||[]).constructor!==Array&&(t=[t]),e){U[e]=U[e]||[];var i=U[e];return t.forEach(function(o){o=o||{},i.forEach(function(e,t){var a=!1;(e=e||{}).eid&&o.eid===e.eid&&(a=!0),e.zid&&o.zid===e.zid&&(a=!0),a&&i.splice(t,1)})}),t=t.concat(i),U[e]=t,U[e]}},M=function(e){var t=e.substring(0,1).toLowerCase();return t.match(/[^a-z]$/)?"others":t},h=function(e){if(e=[e,""].join(""),U.catlist)for(var t=U.catlist.length,a=function(t){return function(e){return e.cid===U.catlist[t].cid}},o=0;o<t;o++){var i=U.catlist[o].cname,r=M(i);r=[r,""].join(""),U[r]||(U[r]=[]),U[r].filter(a(o))[0]||U[r].push({fn:i,eid:"["+n.common.label.category+"]",cid:U.catlist[o].cid})}},g=function(e,t){var a=e.clist,o=t.mode;!function(e,t){var a,o,i,r,n=t.clist;if("500"===(e=[e,""].join(""))){for(a in n)U[a]=v(a,n[a]);if(t.catlist){var s=t.catlist;L.catlist=1,U.catlist=s,h(e)}}else if("100"===e){for(a in L[e]=1,n)u[a]=(o=n[a],i=a,r=void 0,r=[],zmUtil.checktype(o,Array)?r[i]=o:(r[i]=[],void 0!==o&&r[i].push(o)),r[i]);O=t.zlist||{},zmCont.isGroupLoaded()}else L[e]=1,U[a]=v(e,n[e]),h(e)}(o,e),t.calbk?t.calbk(o,"callback"):"cat"===t.type&&zmAutoFill.fillContacts(t.obj,"",a)},j=function(e,t,a){var o=[];e=[e,""].join("");var i=[].concat(u[e]);if(e&&(1<e.length&&"others"!==e&&(e=e.substring(0,1)),void 0!==u[e]))if(o=[],u.val&&u.val===e&&!t)o=u.tmp;else{if(t){var r,n=t.length;for(r=0;r<n;r++)-1!==i.indexOf([t[r],""].join(""))&&i.splice(i.indexOf([t[r],""].join("")),1)}var s,l,m,c=[],d=function(){var e=[];if(!f.length){var t,a=_.pluck(zmCont.getGroup(),"members"),o=a.length;for(t=0;t<o;t++)e=e.concat(a[t]);f=_.uniq(e)}return f}();for(parseInt(a)&&(c=zmCont.getGroup(a).members),c=c.concat(d),l=0,l=s=(c=_.uniq(c)).length||0;0<=l;l--)-1!==(m=i.indexOf(c[l]))&&(i.splice(m,1),i.unshift(c[l]));for(s=i.length,l=0;l<s;l++)[i[l],""].join("")!==[zmail.zuid,""].join("")&&o.push(O[i[l]]);u.tmp=o,u.val=e}return o},C=function(e,t){var a=(e.clist[t]||{}).mode,o=t.eid.substring(0,1);a&&!$.isArray(a)&&(a=[a]),a&&a.length?(m[e.qry]&&delete m[e.qry],U[o]&&U[o].length||(U[o]=U[o]||[]),U[o]=U[o].concat(a)):m[e.qry]=1,t.callbk(e.clist,t)},N=function(e){return zmConUtil.getFormattedContactObj(e)},b=null,y={},A=function(e){var t,a=e.zuid||"",o=e.email||"",i=null,r=null,n=null,s=null;if(o){i="eid";var l=(r=o).charAt(0).toLowerCase();l=M(l),s=u[l]||[]}else a&&(i="zid",r=a,s=Object.keys(O));for(var m=0;m<s.length;m++){var c=s[m],d=O[c];if(d[i]===r){t=d;break}}return t&&((n=N(t))._json=t),n},o=function(e){var t=[],a=(e=e||{}).limit||null,o=(e.searchKey||"").trim(),i=e.caseSensitive||!1,r=e.sortKey||"",n=e.searchMiddleName||!1,s=e.searchNickName||!1,l=e.ignoreList||[],m={};if(l.forEach(function(e){m[e]=!0}),o){i||(o=o.toLowerCase());var c=[],d=O||{};Object.keys(d).forEach(function(e){c.push(d[e])});for(var u=0,f=c.length;u<f;u++){var p=c[u],z=p.fn||"";i||(z=z.toLowerCase());var v=p.mn||"";i||(v=v.toLowerCase());var h=p.ln||"";i||(h=h.toLowerCase());var g=p.nn||"";i||(g=g.toLowerCase());var C=p.eid||"";i||(C=C.toLowerCase());var N=p.chat||!1,b=0,y=z.indexOf(o);z&&-1!==y&&(b++,0===y&&(b+=10)),n&&v&&-1!==v.indexOf(o)&&b++;var A=h.indexOf(o);h&&-1!==A&&(b++,0===A&&(b+=5)),s&&g&&-1!==g.indexOf(o)&&b++;var S=C.indexOf(o);if(C&&-1!==S&&(b++,0===S&&(b+=8)),b&&N&&b++,b&&!m[p.zid]&&(t.push($.extend({_matchScore:b},p)),a&&t.length>=a))break}return"matchScore"===r&&(t=t.sort(function(e,t){return e._matchScore>t._matchScore?-1:e._matchScore<t._matchScore?1:0})),t}},S=zmail.Utils.DeferredCollection.create({keepDeferreds:!1}),t={getContactInfo:function(e){var t,a,o=(e=e||{}).zuid||"",i=e.email||"",r=e.gid||"",n=e.request||!1,s=e.org||!1;if(i){if(s)return A(e);var l=i.charAt(0).toLowerCase();if(l=M(l),(a=(a=(U[l]||[]).filter(function(e){return e.eid===i}))[0])&&a.eid?(t=N(a))._json=a:t=a=void 0,n&&!t)return function(o){if(y[o])return $.Deferred().reject().promise();if(b||(b=zmail.Utils.DeferredCollection.create({keepDeferreds:!1})),b.has(o))return b.get(o).promise();var i=b.get(o);return zmAjq.XHR({u:zmail.conPath+"/getContacts.do",p:{type:"d",email:o,mode:"200"},fn:function(e){var t=null;if((e=e||{}).clist=e.clist||{},(t=e.clist[200]||[]).constructor!==Array&&(t=[t]),setTimeout(function(){$.publish("contacts/insert",{contacts:t})},0),(t=t.filter(function(e){return e.eid===o}))[0]){var a=N(t[0]);a._json=t[0],i.resolve(a)}else i.reject()},efn:function(){i.reject()},t:"GET"}),i.fail(function(){y[o]=!0}),i.promise()}(i)}else if(o){if(s)return A(e);!(a=(a=zmCont.getOrgContacts(o)||{})[o])||a.isDummyObj?t=a=void 0:((t={zohoUserID:o,firstName:a.fn||"",nickName:a.nn||"",emailAddress:a.eid,photoURL:a.photo}).displayName=t.firstName||t.nickName||t.emailAddress,t._json=a)}else r&&(a=zmCont.getGroup(r))&&(t={groupID:r,displayName:a.name,photoURL:a.photo,emailAddress:a.eid},r===zmail.zuid&&(t.displayName=zmail.IAMFullName,t.photoURL=zmail.urls.accURL+"/file?fs=thumb&nocache="+Date.now(),t.emailAddress=zmail.user.loginName),t._json=a);if(!i&&t&&t.photoURL&&(t.photoURL+=(-1===t.photoURL.indexOf("?")?"?":"&")+"API=true"),n){var m=$.Deferred();t?m.resolve(t):m.reject(),t=m}return t},addGroupmember:function(t,e){(e||[]).forEach(function(e){zmCont.GroupAPI.addMember(t,e)})},contacts:function(e,t,a,o){var i,r,n,s=$.Deferred(),l=zmail.conPath+"/getContacts.do";if(e=[e,""].join(""),null==t||L[t]){if("1"===[L[t],""].join("")){var m={};return m.clist=U[t],void(a&&zmAutoFill.fillContacts(a,"",m))}i={mode:e},r={mode:e},"100"!==e||L[100]?"500"!==e&&"300"!==e&&("others"!==(n=e)&&(n=M(e)),i={mode:n},r={mode:n}):(l=zmail.conPath+"/orgContacts.do",i.mode="orgdata")}else i={mode:e,cId:t},r={mode:t,type:"cat",obj:a};return o&&(r.calbk=o),i.type="a",zmAjq.XHR({u:l,t:"GET",fn:function(){var e=Array.prototype.slice.apply(arguments);g.apply(this,e),s.resolve()},efn:s.reject,p:i,ep:r}),s.promise()},getContact:function(a,e,o,t,i){var r=[],n=[],s=0,l=0,m=0,c=a,d={},u=!1,f=!0,p="";"object"===babelHelpers.typeof(a)&&(void 0!==a.req&&(f=a.req),a.srch&&(p=a.srch),c=a=a.str),"others"!==a&&(c=a.substring(0,1),c=M(c)),i&&(u=i.org);if(void 0!==u&&u&&1===L[100]){var z=[];i.grpId&&i.grpId!==zmail.zuid&&I[i.grpId]&&(z=I[i.grpId].members),0<i.list.length?z=i.list.concat(z):0<z.length&&(z=z.concat(i.list));var v=i.addtolist?i.groupId:"";if(n=j(c,z,v),v){var h={};parseInt(v)?v=[v]:v.constructor!==Array&&(v=Object.keys(zmCont.getGroup())),v.forEach(function(e){var t=zmCont.getGroup(e);t&&(h[e]=t)});var g={},C={};for(var N in h)g={fn:(C=h[N]).name,nn:"",eid:C.eid,photo:C.photo,zid:N},n.push(g)}}else u&&!L[100]?zmCont.contacts(100):(n=U[c],!L[c]&&f&&(L[c]=2,s=1,zmCont.contacts(a,null,null,t)));"s"===(o=[o,""].join(""))&&1===a.length&&(o="f");var b=function(e){var t=a||"";return e=e||"",!(!t||!e)&&(t=t.toLowerCase(),e=e.toLowerCase(),"f"===o?('"'!==t.charAt(0)&&"'"!==t.charAt(0)||(t=t.substr(1)),0===e.indexOf(t)):-1!==e.indexOf(t))};if(n){var y,$,A,S,O,w;l=n.length;for(var x="",E=0;E<l&&m<e;E++)O=0,w=n[E].name?"name":"fn",""!==p&&b(n[E][p])?O=1:(y=n[E].eid,x=[$=n[E][w],A=n[E].ln,S=n[E].nn].join(" "),y&&b(y)?O=1:$&&b($)?O=1:A&&b(A)?O=1:S&&b(S)?O=1:b(x)&&(O=1)),1===O&&(n[E].cid||n[E].photo||(n[E].photo=zmResource.get("image","SC-Photo.png")),r.push(n[E]),m++)}return d.result=r,1===s&&(d.mc=s),d},consContact:function(e){var t="";return""!==e.fn&&(t+='"fn":"'+zmUtil.quotUnEscape(e.fn)+'"'),e.ln&&""!==e.ln&&(t+=',"ln":"'+zmUtil.quotUnEscape(e.ln)+'"'),e.nn&&""!==e.nn&&(t+=',"nn":"'+zmUtil.quotUnEscape(e.nn)+'"'),e.zid&&""!==e.zid&&(t+=',"zuid":"'+e.zid+'"'),e.photo&&""!==e.photo?t+=',"photo":"'+e.photo+'"':t+=',"photo":"'+zmResource.get("image","SC-Photo.png")+'"',""!==t&&(t+=","),t+='"eid":"'+e.eid+'"'},getCateDetails:function(e,t){if(U[e])return U[e];2!==L[e]&&"catlist"!==e&&(zmCont.contacts(300,e,null,t),L[e]=2)},isEmailExist:function(e,t,a){if(e){var o,i,r,n=e.substring(0,1),s={str:e,req:!1,srch:"eid"};if(o=zmCont.getContact(s,500,"f"),1===m[e])return{req:!1};if(L[n]||o.result.length||!t||(i={type:"d",email:e,mode:"200"},r={eid:e,callbk:t,mode:"200",elm:a},m[e]=0,d.indexOf(e)<0?(d.push(e),zmAjq.XHR({u:zmail.conPath+"/getContacts.do",t:"GET",fn:C,p:i,ep:r})):t({req:!1},r)),0!==o.result.length)return o.result[0]}},getOrgContacts:function(e,t){var a,o,i,r=e.split(","),n=r.length;for(a="Array"===t?[]:{},o=0;o<n;o++)i=O[r[o]]?O[r[o]]:{g:2,zid:"",nn:"",photo:zmResource.get("image","SC-Photo.png"),eid:"",fn:"",isDummyObj:!0},"string"===t?a[r[o]]="{"+zmCont.consContact(i)+"}":"Array"===t?a.push(i):a[r[o]]=i;return a},isGroupLoaded:function(e,t){var a="100";if(L[a]){if(e&&1===L[a])e.apply(null,t);else if(!e&&1===L[a]&&s.length){var o=0,i=s.length;for(o=0;o<i;o++)s[o].apply(null,l[o]);s=[],l=[]}}else zmail.trialUsers?zmail.ContactBook.fetchProcess.done(function(){L[a]=1,zmCont.isGroupLoaded()}):zmCont.contacts("100"),e&&(s.push(e),l.push(t))},getContactsForGroup:function(e){var t=[];return e&&(t=zmCont.getOrgContacts(zmCont.getGroup(e).members.join(","),"Array")),t},getGroup:function(e,t){var a={},o=!1;return void 0===e?(a=_zm.copyOf(I),o=!0):e===zmail.zuid?(a=_zm.copyOf(c),o=!0):I[e]&&(a=_zm.copyOf(I[e]),o=!0),t&&e!==zmail.zuid&&(a[zmail.zuid]=_zm.copyOf(c),o=!0),o||(a=void 0),a},getGroupOrder:function(){return _zm.copyOf(r)},isGroupMember:function(e,t){var a=I[t];return!(!a||-1===a.members.indexOf(e))},isGroup:function(e){return e&&void 0!==I[e]},getEmailEnabledGroup:function(){var e={},t=I,a=0,o=r.length,i=2;for(a=0;a<o;a++)(zmail.trialUsers||!zmail.trialUsers&&t[r[a]].eid)&&!t[r[a]].disabled&&(e[r[a]]=$.extend({},t[r[a]]),e[r[a]].order=i,i++,zmail.trialUsers&&(i=3===a?i+1:i,3<a&&(e[r[a]].hideNode=!0)));return e[c.id]=$.extend({},c),e[c.id].name=zmText.get("zmContacts","common.label.streamsSelfGroup"),e[c.id].order=1,zmail.trialUsers&&4<o&&(e.more={name:"More ..",id:"more",order:6,txtNodeClass:"SC_thm",rowTitle:"View all groups"},e.less={name:"Less ..",id:"less",order:i++,hideNode:!0,txtNodeClass:"SC_thm",rowTitle:"Hide groups"}),e},changeUnread:function(e,t,a){var o,i,r,n,s;i=t,r=a,((o=e)&&I[o]||zmail.zuid===o)&&(s=zmail.zuid===o?c:I[o],n=void 0!==r?parseInt(r):parseInt(s.scount),void 0!==r||(i?n++:n--),s.scount=n,$.publish("group/unread",{groupId:o,count:n,incFlag:i}))},addGroup:function(e,t){I[e]||(I[e]=t,r?r.unshift(e):r=[e],$.publish("group/added",{groupID:e}))},removeGroup:function(e){e&&(r.splice(r.indexOf(e),1),delete I[e])}},a={indices:function(){return U},orgIndices:function(){return u},zidList:function(){return O},tempcont:function(){return L},initialize:function(e){U=(e=e||{}).indices||{},u=e.orgIndices||{},L[100]=1,O=e.zidArr||{}}},w=function(e){(e=e||{}).contacts=e.contacts||[],e.contacts.constructor!==Array&&(e.contacts=[e.contacts]),e.contacts.forEach(function(e){if((e=e||{}).eid){var t=e.eid.charAt(0);t=M(t),v(t,[e])}})};t._store=a,t.loadContacts=function(){var e=i;if(p&&z)return e.promise();var t=$.Deferred().resolve(),a=zmCont.contacts(500);zmail.isOrg&&(t=zmCont.contacts(100));var o=function(){p&&z&&e.resolve()};return a.done(function(){p=!0,o()}).fail(function(){_zm.succErrMsg("e","Could not load Personal contacts"),e.reject()}),t.done(function(){z=!0,o()}).fail(function(){_zm.succErrMsg("e","Could not load Organisation contacts"),e.reject()}),e.promise()},t.getOrgContactInfo=A,t.searchORGContacts=o,t.searchORGContactsAsync=function(t){var a=$.Deferred();return setTimeout(function(){var e=o(t);a.resolve(e)},0),a},t.getContactsForEmailList=function(e,t){e=e||[],t=t||{};var i=$.Deferred(),r={},n=[],s=!t.hasOwnProperty("request")||t.request;return e.forEach(function(a){var o=$.Deferred();if(n.push(o),!zmail.Utils.EmailValidator.validate(a).status)return window.console.log("invalid email",a),window.console.trace(),void i.reject();zmCont.getContactInfo({email:a,request:s}).done(function(e){r[a]=e,o.resolve()}).fail(function(){var e=zmCont.getContactInfo({email:a,org:!0});if(e)r[a]=e;else{var t=zmail.Utils.EmailParser.parse(a)[0];r[a]={firstName:t.name,emailAddress:a,photoURL:zmail.zmResource.get("image","SC-Photo.png"),isPsuedoContact:!0}}o.resolve()})}),$.when.apply($,n).done(function(){i.resolve(e.map(function(e){var t=r[e],a=zmail.Utils.EmailParser.parse(t.firstName)[0];return a&&a.valid&&(t.firstName=a.name),t}))}),i.promise()},t.fetchContacts=function(e){var t=((e=e||{}).searchWord||"").trim().toLowerCase();if(!t)return $.Deferred().reject().promise();var a=t.charAt(0);if(a=M(a),1===L[a])return $.Deferred().reject().promise();var o=S.has(a),i=S.get(a);return o||zmAjq.XHR({u:zmail.conPath+"/getContacts.do",t:"GET",fn:function(e){var t=((e=e||{}).clist||{})[a]||[];v(a,t),L[a]=1,i.resolve()},efn:function(){i.reject()},p:{mode:a,type:"a"}}),i.promise()},t.insertContacts=w,t.fetchProcess=i.promise(),$.subscribe("compose/addToContacts",function(e,t){!function(e){var t=(e=e||{}).email,a=e.name||e.email,o=zmail.Utils.EmailValidator;if(t&&o.validate(t).status){var i=M(t);v(i,[{eid:t,fn:a}])}}({email:t.email,name:t.name})}),$.subscribe("contacts/insert",function(e,t){w(t)}),$.subscribe("group/member/removed",function(e,t){var a=(t=t||{}).group,o=t.member,i=I[a];i&&(String(i.owner)===String(o)&&(i.owner=-1),zmail.zuid===o&&(i.isOwner=!1))}),$.subscribe("group/moderator/removed",function(e,t){var a=(t=t||{}).group,o=t.moderator,i=I[a];i&&(String(i.owner)===String(o)&&(i.owner=-1),zmail.zuid===o&&(i.isOwner=!1))}),$.subscribe("group/moderator/added",function(e,t){var a=(t=t||{}).group,o=t.moderator,i=I[a];i&&zmail.zuid===o&&(i.isOwner=!0)}),t.initGroups=function(){I={},(zmail.ContactBook.getGroups()||[]).map(function(e){return e.attrs}).forEach(function(e){I[e.id]=e}),r=zmail.ContactBook.getGroupOrder()||[],c=zmail.ContactBook.getGroupsByID(zmail.zuid,{includeGroupHome:!0,includeAllGroups:!0})[0]||{}},t.GroupAPI={addMember:function(e,t){var a=I[e];return!!a&&(a.members=a.members||[],-1===a.members.indexOf(t)&&(a.members.push(t),$.publish("group/member/added",{group:e,member:t}),!0))},removeMember:function(e,t){var a=I[e];if(!a)return!1;a.members=a.members||[];var o=a.members.indexOf(t);return-1!==o&&(a.members.splice(o,1),$.publish("group/member/removed",{group:e,member:t}),!0)},addModerator:function(e,t){var a=I[e];return!!a&&(a.moderator=a.moderator||[],-1===a.moderator.indexOf(t)&&(a.moderator.push(t),$.publish("group/moderator/added",{group:e,moderator:t}),!0))},removeModerator:function(e,t){var a=I[e];if(!a)return!1;a.moderator=a.moderator||[];var o=a.moderator.indexOf(t);return-1!==o&&(a.moderator.splice(o,1),$.publish("group/moderator/removed",{group:e,moderator:t}),!0)}},e.zmCont=t}(window),function(e){var a=zmail.Utils.EmailValidator,R="data-contactcard",B="contact-card",i=function(e,t){t=t||{};var r=/(?:\(([^)]+)\))/gim;e=(e=e||"").trim(),t.keepHTMLEntity||(e=zmUtil.replaceHTMLEntities(e));return zmail.Utils.EmailParser.parse(e).map(function(e){var t=e.name;t=t.trim();var a=r.exec(t);a=a?a[1]:"";var o={fn:t=t.replace(r,""),eid:e.email,nn:a};if(e.valid){o.class="SC_cs";var i=zmail.ContactBook.get({promise:!1,eid:e.email,type:["personal","org"]})[0];i&&(o.photo=i.photo(!0))}else o.class="SC_cs zmerr",o.invalid=!0;return o})},r=function(e,i,r){return(e=e||[]).map(function(e){return a=i,o=r,(t=e)?("object"!==(a=a||"object")&&(t.ph=t.photo,t.name=t.fn,t.cls=t.class,t.attr={"data-eid":t.email},t=zmConUtil.bubbleUtil(t,a,o)),t):null;var t,a,o}),e},G=function(){return zdom("li",{ref:"wrapper"},zdom("div",null,zdom("span",{id:"crm_contactname"},zdom("b",{ref:"name",className:"contact-name"},zdom("i",{ref:"smimeEmail",className:"msi-verified zmDoubleIcon"}),zdom("span",{id:"conName",ref:"name"}))),zdom("span",{ref:"email",style:{display:"inline",verticalAlign:"middle"}})),zdom("div",{ref:"avatarWrapper",className:"avatar-wrapper"}))},q=function(){return zdom("li",{className:"SC_lne list-separator"})},F=function(){return zdom("li",{className:"list-item"})},t=function(e){var t,a,o=$.Deferred(),i=$.Deferred(),r=(e=e||{}).dom||e.anchor,n=e.email||"",s=e.zuid||"",l=e.gid||"",m=e.zid||"",c=function(e,t){$.e(e).find(".avatar-wrapper").html("").appendDOM(t)};if($.e(r).length&&"visible"===$.e(r).attr(R))return o.resolve({component:$.e(r).data(B),eventSource:r,replaceAvatar:function(e){c($.e(r).data(B).$el,e)}}),o.promise();(!n&&$.e(r).length&&(n=(n=$.e(r).attr("data-eid"))||""),!m&&$.e(r).length&&(m=(m=$.e(r).attr("data-uid")||$.e(r).attr("z")||$.e(r).attr("data-zid"))||""),m&&zmail.ContactBook.getGroups(m)[0]?l=m:s=m,s&&!n)&&((t=(t=zmail.ContactBook.get({promise:!1,zuid:s,type:["org"]})[0])?$.extend({emailAddress:t.attrs.eid},t.attrs):null)&&(n=t.emailAddress));l&&((a=(a=zmail.ContactBook.getGroups(l)[0])?$.extend({emailAddress:a.attrs.eid},a.attrs):null)&&(n=a.emailAddress));return n?zmail.ContactBook.get({eid:n}).always(i.resolve):i.resolve(),i.always(function(){var t=function(e){var t=(e=e||{}).dom||e.anchor,a=e.items||[],o=[],i=e.event,r=e.source||"",n=e.email||"",s=e.name||n||"",l=e.zuid||"",m=e.gid||"",c=l||m||e.zid||"";if(e.popupOpts=Object.assign({},e.popupOpts),i&&zmUtil.stopEvents(i),"string"==typeof t&&(t=$.q(t)[0],t=$.e(t)),$.e(t).length){!n&&$.e(t).length&&(n=(n=$.e(t).attr("data-eid"))||""),!c&&$.e(t).length&&(c=(c=$.e(t).attr("data-uid")||$.e(t).attr("z")||$.e(t).attr("data-zid"))||"");var d=null,u=null,f=null,p="",z={};if(l)z={zuid:l};else if(m)z={gid:m};else if(c){var v=!1;zmail.ContactBook.isGroup(c)&&zmail.zuid!==c&&(v=!0),v?(z={gid:c},m=c):(z={zuid:c},l=c)}else n&&(z={email:n});z.zuid?d=zmail.ContactBook.get({promise:!1,zuid:z.zuid,type:["personal","org"]})[0]:z.email?(d=zmail.ContactBook.get({promise:!1,eid:z.email,type:["personal"]})[0])||(d=zmail.ContactBook.get({promise:!1,eid:z.email,type:["org"]})[0]):z.gid&&(d=zmail.ContactBook.getGroups(z.gid)[0]),(u=d)&&(p=u.type),p=p||"personal",(d=d?$.extend({displayName:[d.attrs.fn,d.attrs.mn,d.attrs.ln,d.attrs.nn?"("+d.attrs.nn+")":""].join(" "),emailAddress:d.attrs.eid},d.attrs):null)?(d.found=!0,n=n||d.emailAddress):d={found:!1},d.personalContact="personal"===p,d=$.extend({displayName:s||n,fn:e.displayName||n,emailAddress:n},d),d=$.extend(d,{emailAddress:n,eid:n});var h=zmail.Utils.EmailParser.parse(d.displayName);h=h[0]||{},!d.found&&h.valid&&(d.displayName=e.displayName||h.name||d.displayName,s=d.displayName);var g=$.e(G()),C=_zm.getDOMReferenceMap(g,!0);$.e(C.name).text(" "+d.displayName),$.e(C.email).text(d.emailAddress||""),void 0===e.isSmimeVerifiedEmail||""===e.isSmimeVerifiedEmail?$.e(C.smimeEmail).remove():("unverified"===e.isSmimeVerifiedEmail&&$.e(C.smimeEmail).addClass("msi-unverified zmDoubleIcon"),$.e(C.smimeEmail).attr("data-tooltip",e.tooltip)),z.displayName=d.displayName,z.type="dom",z.email&&(z.email=d.emailAddress);var N=u?u.avatar():zmail.ContactBook.Templates.avatar({isValidPhoto:!1,initials:zmail.ContactBook.Utils.initials(d.displayName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()});$.Deferred().resolve(N).promise().done(function(e){f=$.e(e),$.e(C.avatarWrapper).prependDOM(f)}),zmail.wmsAPI.showPresence(d.emailAddress,$.e(C.avatarWrapper));var b=$.e(q());$.publish("contacts/openingCard",{source:r,insertItems:function(e){e=e||[],a=a.concat(e)}}),o.push(g[0]);var y=!1!==zmail.isPeopleUser&&zmail.isPeopleIntegEnabled&&(l||c||n);y&&o.push(zdom("li",{className:"nohr peopleLoading"},zdom("div",{className:"SC_ctpro",id:"peopleInfo"},zdom("div",{className:"loading_dots"},zdom("span",null),zdom("span",null),zdom("span",null),zdom("span",null)))).outerHTML);var A=l||c||d&&d.zid;A&&A!==zmail.zuid&&"undefined"!=typeof WebMessanger&&zmail.wmsAPI.addChatIcons(A,$.e(C.email).parent());var S=!zmail.isRebranded&&!zmail.isFuji&&window.zgssearch&&!e.hideGlobalSearchOption;(a.length||S)&&o.push(b[0]);var O=new zmDropDownMenu;if(a.forEach(function(e,t){if((e=e||{}).id=e.id||"opt_"+t,!1!==e.show&&d[e.show]===e.value){var a=$.e(F());a.attr({id:e.id}),a.text(e.htm),"function"==typeof e.clk&&(e.args=e.args||[],e.args.unshift(d),e.args.push(O),_zm.bind(a[0],"click",e.clk,e.args)),o.push(a[0])}}),S){var w=$.e(F());w=$.element(w);var x=zmText.get("zmContacts","contactCard.searchAcrossApps",{companyName:zmail.globalI18N.companyName});w.attr({id:"global-search"}),w.text(x),w.on("click",function(e){window.zgssearch.search(d.emailAddress),e.stopPropagation()}),o.push(w)}var E={par:t,showArrow:!0,liDom:o,ulClass:"SC_P2r",spanClass:"SC_ctdtl"};E=Object.assign(E,e.popupOpts),O.setDropObj(E),O.paint();var U=!1,L=!0;if($.events(O).on("removed",function(){$.e(t).removeAttr(R),$.e(t).removeData(B)}),$.e(t).attr(R,"visible"),$.e(t).data(B,O),e.hideOnBlur){var _=$.e(O.$el)[0],I=null,M=function(){I&&clearTimeout(I),I=setTimeout(function(){U||L||O.remove()},500)},j=function(){U=!0},k=function(){U=!1,M()},D=function(){L=!0},T=function(){L=!1,M()};$.events(O).on("removed",function(){$.e(_).off("mouseenter",j),$.e(_).off("mouseleave",k),$.e(t).off("mouseenter",D),$.e(t).off("mouseleave",T)}),$.e(_).on("mouseenter",j),$.e(_).on("mouseleave",k),$.e(t).on("mouseenter",D),$.e(t).on("mouseleave",T)}if((!n||d.found&&d.personalContact)&&$.q("#zms_add").hide(),c){var P=_zm("#","zm_dropDown");_zm.setAttr(P,{zid:c})}return y&&zmAppLoader.load("peopleinteg").done(function(){var i=function(){O.$el.find(".peopleLoading").remove(),e.disableReposition||setTimeout(function(){O.position()},200)},r={zuid:l||c,email:n};zmail.peopleInteg.util.getProfileInfo(r).done(function(){var e=r.zuid||zmail.peopleInteg.aliasZuid[n.toLowerCase()];if(e&&zmail.peopleInteg.peopleData[e]){var t=O.$el.find(".contact-name");O.$el.find("#peopleInfo").clearHTML().appendDOM(zmail.peopleInteg.view.contactCardView(e));var a="//people."+zmail.zohoUrl+"/hr#home/dashboard/profile-userId:"+zmail.peopleInteg.peopleData[e].erecno,o=zdom("a",{className:"SC_thm",target:"_blank",href:a,rel:"noopener noreferrer"},t.text());$.e(t).find("#conName").remove(),$.e(t).appendDOM(o),zmail.peopleInteg._core.getUserStatus(e).done(function(e){e&&e.result&&e.result[0]&&t.appendDOM(zmail.peopleInteg.view.userStatusView(e.result[0].att_status))})}else i()}).fail(function(){i()})}),O}}(e);o.resolve({component:t,eventSource:r,replaceAvatar:function(e){c(t.$el,e)}})}),o.promise()},l=function(t,a,e){var o={url:"/zm/addContact.do",data:{zmrcsr:zmAjq.getCookie("zmcsr"),mode:"addContact",cfN:t.firstName,cmN:t.middleName,clN:t.lastName,cnN:t.nickName,ceA:t.email,cpN:t.phone,cphT:t.phoneType,cmpN:t.cname},type:"POST",success:function(e){(e=(e=(e=e[1]||{}).contact||"").replace(/'/gim,""))?(a.resolve({contact:t}),zmail.ContactBook.addNewPersonalContact({eid:t.email,fn:t.firstName,mn:t.middleName,nn:t.nickName,ln:t.lastName})):a.reject({code:3,msg:zmText.get("zmContacts","utility.message.contactAvailable")})},error:function(){a.reject({code:2,msg:zmText.get("zmContacts","utility.message.addContactTryAgain")})}};$.ajax(o)},o=function(a,o){var e,t,i=zmText.get("zmContacts").utility.inputFields,r={},n={},s=(e=zmText.get("zmContacts").utility.inputFields,t=zdom("div",{ref:"parent"},zdom("div",{className:"SC_floatLabelRow fLCol2"},zdom("div",{className:"SC_floatLabel flFLabel flBox noMarginBot"},zdom("input",{type:"text",ref:"fName"}),zdom("label",null,e.fName)),zdom("div",{className:"SC_floatLabel flFLabel flBox noMarginBot"},zdom("input",{type:"text",ref:"mName"}),zdom("label",null,e.mName))),zdom("div",{className:"SC_floatLabelRow fLCol2"},zdom("div",{className:"SC_floatLabel flFLabel flBox noMarginBot"},zdom("input",{type:"text",ref:"lName"}),zdom("label",null,e.lName)),zdom("div",{className:"SC_floatLabel flFLabel flBox noMarginBot"},zdom("input",{type:"text",ref:"nName"}),zdom("label",null,e.nName))),zdom("div",{className:"SC_floatLabelRow"},zdom("div",{className:"SC_floatLabel flBox flFLabel flDisabled flBox noMarginBot"},zdom("input",{type:"email",ref:"email"}),zdom("label",null,e.email))),zdom("div",{className:"SC_floatLabelRow"},zdom("div",{className:"SC_floatLabel flBox flFLabel flBox noMarginBot"},zdom("input",{type:"text",ref:"cname"}),zdom("label",null,e.cname))),zdom("div",{className:"SC_floatLabelRow fLCol2"},zdom("div",{className:"SC_floatLabel flBox flFLabel noMarginBot"},zdom("input",{type:"text",ref:"pNumber",maxLength:"15"}),zdom("label",null,e.pNumber)),zdom("div",{className:"zmSelect flBox"},zdom("span",{className:"zmSelVal",ref:"pType"},"Mobile")))),_zm.getDOMReferenceMap(t,!0));r.$content=s.parent,r.title=i.title,r.buttons=[{name:i.save,callback:function(){var e={firstName:s.fName.value,lastName:s.lName.value,middleName:s.mName.value,nickName:s.nName.value,email:s.email.value,phone:s.pNumber.value,cname:s.cname.value,phoneType:s.pType.innerText};if(0<e.phone.length){if(!new RegExp("^[+]*[(]{0,1}[0-9]{1,4}[)]{0,1}[-s./0-9]*$").test(e.phone)){var t=zmText.get("zmContacts").utility.inputFields;return _zm.succErrMsg("e",t.invalid),s.pNumber.focus(),!1}l(e,o)}else l(e,o);n.remove()}},{name:i.cancel,isCancel:!0,callback:function(){n.remove(),o.resolve()}}],r.dialogDidMount=function(e,t){n=e,s.fName.value=a.firstName,s.mName.value=a.middleName,s.lName.value=a.lastName,s.nName.value=a.nickName,s.email.value=a.email,s.pNumber.value=a.phone,$.e(s.pType).on("click",function(){var t,e,a,o;t=s.pType,e=n.$el,a=zmText.get("zmContacts").utility.inputFields,o=[{htm:a.mobile,data:{action:"Mobile"}},{htm:a.home,data:{action:"Home"}},{htm:a.work,data:{action:"Work"}},{htm:a.fax,data:{action:"Fax"}},{htm:a.others,data:{action:"Others"}}],new zmDropDownMenu({par:t,list:o,align:"pleft",clk:function(e){t.innerText=e.action,zmUtil.hideMenu()},container:e,parWidth:!0}).paint()})},r.defaultNavigator=!1,r.ignoreMouseDown=!1,r.navigator=new zmail.Navigator({onEscape:function(){n.remove(),o.resolve()}}),Dialog.new(r)},n={splitncheck:function(e,t,a){var o=i(e);return r(o,t,a)},fillImgSrc:function(e,t){var a,o=[];if(t){$.isArray(t)?o=t:o.push(t),a=o.length;for(var i=0;i<a;i++)"IMG"===$.e(o[i]).get(0).tagName?$.e(o[i]).attr("src",e):$.e(o[i]).children("img").attr("src",e)}},fillContDet:function(e,t){var a,o=e[t.mode],i=t.eid,r=t.elm;if(void 0!==o){if($.publish("contacts/insert",{contacts:o}),$.isArray(o)){for(var n=0;n<o.length;n++)if(o[n].eid===i){a=o[n];break}}else a=o;a.photo&&""!==a.photo&&zmConUtil.fillImgSrc(a.photo,r)}},bubbleUtil:function(e,t){var a,o,i,r,n,s;if(t=t||{},(e=e||{}).cls=e.cls||"SC_cs",e.attr=e.attr||{},e.eid=e.eid||"",e.ph=e.ph||zmResource.get("image","SC-Photo.png"),e.name=e.name||"",e.iclass=e.iclass||"",e.img=e.img||!1,e.ret=e.ret||"string",r=(i=zdom("div",null,zdom("img",{src:""}),zdom("span",null),zdom("i",null))).childNodes[0],n=i.childNodes[1],s=i.childNodes[2],e.hasOwnProperty("smimeStatus")&&e.smimeStatus){var l=zdom("i",{className:"msi-verified zmDoubleIcon"});$.e(l).insertDOMBefore(n)}for(a in $.e(i).attr("class",e.cls),$.e(i).attr("title",e.eid),e.attr)$.e(i).attr(a,e.attr[a]);return o=zmUtil.replaceHTMLEntities(e.name),$.e(n).text(o),$.e(s).attr("class",e.iclass),e.img?$.e(r).attr("src",e.ph):$.e(r).remove(),e.iclass||$.e(s).remove(),"function"==typeof t.modifyDOM&&t.modifyDOM({contact:e,dom:i}),"dom"===e.ret?i:"string"===e.ret?i.outerHTML:void 0},loadCompose:function(e,t){zmUtil.hideMenu();var a="";e.fn&&(a+=e.fn),e.ln&&(a+=" "+e.ln),e.eid&&(a+="<"+e.eid+">"),zmUtil.isChildWindow()?zmUtil.composeWindow({to:a}):zmUtil.compose({TO:a}),_zm.stopEvents(t)},listMails:function(e){var t;e.eid&&(zmSearchUtil.isNewSearch()?(t=[{className:"Sender",value:e.eid}],zmail.Search.setContext(zmail.Search.Models.Contexts.mailSearchContext),zmail.Search.newSearch(t)):(t={searchQueryArr:[{lhs:"Sender",contains:!0,value:e.eid}]},zmSearch.setPrevAppSearch("m"),zmSearch.addSearch(t)),zmUtil.hideMenu())},listAttachment:function(e){e.eid&&(zmUtil.listAttachmentInAttSearchView({type:"s",srchStr:e.eid}),zmUtil.hideMenu())},createChat:function(e){var t;zmUtil.hideMenu(),"string"==typeof e?t=e:e.zid&&(t=e.zid),t&&zmAjq.XHR({u:zmail.conPath+"/util.do",t:"GET",p:{mode:"createChat",recipient:t}})},checkemail:function(e){e=e||"";var t=a.validate(e);return zmail.debug&&!t.status&&window.console.log("Invalid Email-Address - "+e+" - "+t.errorMessage),t.status},addToContacts:function(e){var t=$.Deferred();return(e=e||{}).firstName=e.firstName||"",e.middleName=e.middleName||"",e.lastName=e.lastName||"",e.nickName=e.nickName||"",e.email=e.email||"",e.phone=e.phone||"",e.phoneType={mobile:"MOBILE_ph",home:"HOME_ph",work:"WORK_ph",fax:"FAX_ph",others:"OTHERS_PH"}[e.phoneType]?e.phoneType:"others",e.email?(e.firstName||e.middleName||e.lastName||(e.firstName=e.email),e.phone||(e.phoneType=""),-1!==e.firstName.indexOf("@")&&(e.firstName=zmail.Utils.EmailParser.parse(e.firstName)[0].name),o(e,t)):t.reject({code:1,msg:zmText.get("zmContacts","utility.message.validEmailNeeded")}),t.promise()},handleAddToContact:function(e,i){e=e||{},_zm.succErrMsg("i",zmText.get("zmContacts","utility.message.addingContact"),{hideAfter:1e3}),zmConUtil.addToContacts({email:e.eid,firstName:e.fn}).done(function(e){var t=(e=e||{}).contact;t&&t.email&&($.publish("contacts/insert",{contacts:[{eid:t.email,fn:t.firstName}]}),_zm.succErrMsg("s",zmText.get("zmContacts","utility.message.addContactSuccess"))),$.e(i.target).fadeOut()}).fail(function(e){var t="e";3===(e=e||{}).code&&($.e(i.target).fadeOut(),t="i");var a=e.msg||zmText.get("zmContacts","utility.error.unknownError"),o=zmText.get("zmContacts","utility.message.addContactFail",{errorReason:a});_zm.succErrMsg(t,o)})},parseContacts:i,constructContact:function(e,t){t=t||{};var a="",o=(e=e||{}).firstName,i=e.lastName,r=e.nickName,n="",s=e.email||e.emailAddress;return(o=(o||"").trim())&&(n+=o),(i=(i||"").trim())&&(n+=" "+i),(r=(r||"").trim())&&(n+=" "+(r="("+r+")")),n=n.trim(),(s=(s||"").trim())&&(s="<"+s+">"),a=n?(n='"'+n+'"')+" "+s:s,t.keepHTMLEntity||(a=zmUtil.replaceHTMLEntities(a)),a},getFormattedContactObj:function(e){var t={emailAddress:(e=e||{}).eid,firstName:e.fn||"",lastName:e.ln||"",nickName:e.nn||"",photoURL:e.photo,zohoUserID:e.zid};return t&&t.photoURL&&(t.photoURL+=(-1===t.photoURL.indexOf("?")?"?":"&")+"API=true"),t.displayName=[t.firstName,t.lastName].join(" ").trim()||t.nickName||t.emailAddress,t._json=e,t}};n.showDet=t,n.showContactCard=t,e.zmConUtil=n}(window),function(){var e=zmail.Core.Namespaces.create("zmail.Integrations.CRM.Contacts"),l={},m=zmail.Utils.DeferredCollection.create({keepDeferreds:!1}),t=function(e,t){var a="";a=(e=e||"").trim().toLowerCase();var o,i,r=!m.has(a),n=m.get(a);if(!a||a.length<3)return $.Deferred().reject().promise();if(t&&(l[a]=null),l[a])return n.resolve(l[a]).promise();if(r){var s=l[a.substring(0,3).toLowerCase()];if(s&&!s.length)return l[a]=[],n.reject().promise();(o=a,i=$.Deferred(),zmail.isCRMServiceUser&&zmail.IntegrationStatus.CRM?($.ajax({url:"/integPlatform/zohocrmAction.do?action=EXECUTE_CRM_URL",type:"post",contentType:"application/json",dataType:"json",headers:{"X-ZCSRF-TOKEN":"zmrcsr="+zmAjq.getCookie("zmcsr")},data:JSON.stringify({data:{actionId:18,params:{searchWord:o},headers:{"X-ZOHO-SERVICE":"mail/webclient"}}}),success:function(e){if((e=e||[]).constructor!==Array){var t=e.response||{};t.error&&4102===t.error.code&&(!1,i.reject())}else i.resolve(e)},error:function(){i.reject()},beforeSend:function(e){e.setRequestHeader("X-ZOHO-SERVICE","mail/webclient")}}),i.promise()):i.reject().promise()).done(function(e){e=e||[],l[a]=e,n.resolve(e)}).fail(function(){l[a]=[],n.reject()})}return n.promise()};e.request=t,e._getCache=function(){return l}}(),zmail.wmsAPI=function(){var o=zmText.get("zmContacts","utility.chat")||{},l={1:o.available,4:o.idle,0:o.offline,3:o.busy,2:o.invisible,"-1":o.unapproved},m={1:"available",2:"invisible",3:"busy",4:"idle",0:"offline"},i=function(){return zmail.IntegrationStatus.CHAT&&"undefined"!=typeof WmsContacts},r=function(e){var a=$.Deferred();return(e=e||{}).email&&zmail.ContactBook.get({str:e.email,promise:!0}).always(function(e){var t=e.length?e[0].attrs:{};a.resolve(t)}),a.promise()},n=function(t){var e=(t=t||{}).status,a=t.zuid||t.gid||t.zid;if(void 0===e)try{e=WmsContacts.status(a)}catch(e){}var o={UNKNOWN:-2,UNAPPROVED:-1,OFFLINE:0,AVAILABLE:1,INVISIBLE:2,BUSY:3,IDLE:4};void 0!==e&&!1!==e||(e=o.UNKNOWN),e=String(e);var i=["statusIcon"],r=l[e],n=m[e]||"";i.push(n),i=i.join(" ");var s=$.e(zdom("i",null));return s.addClass(i),s.attr({title:r}),e!==[o.UNKNOWN,""].join("")&&e!==[o.UNAPPROVED,""].join("")||s.hide(),!1!==t.openChatOnClick?s.on("click",function(e){_zm.stopEvents(e),t.onChatStart&&t.onChatStart(),t.createChatViaWM?WebMessanger.chat(a):zmConUtil.createChat(a)}):s.css({cursor:"default"}),s[0]},s=function(e,t){var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return!(!e||"undefined"==typeof WebMessanger)&&("wp"===zmail.fromService?$.publish("mailsuite/createChat",{type:t,zuid:e}):"audio"===t?WebMessanger.startAudioCall(e):"video"===t?WebMessanger.startVideoCall(e):"chat"===t&&(!1!==a.createChatViaWM?WebMessanger.chat(e):zmConUtil.createChat(e)),!0)},c=function(e,t){var a;try{a=WmsContacts.status(e)}catch(e){}$.e(t).hasClass("SC_avtr")||(t=$.e(t).find(".SC_avtr"));var o=n({status:a,zid:e});t.length&&$.e(o).insertDOMAfter(t)};return{STATUS_CONSTANTS:{UNKNOWN:-2,UNAPPROVED:-1,OFFLINE:0,AVAILABLE:1,INVISIBLE:2,BUSY:3,IDLE:4},getPresenceAsync:r,getPresenceIcon:n,addChatIcons:function(t,e){if(e&&i()){var a=zdom("div",{className:"zmCCchatInteg"},zdom("i",{title:o.startChat,className:"msi-cliq zmThmHvrClr","data-type":"chat"}),zdom("div",{className:"SC_SDot"}),zdom("i",{title:o.audio,className:"msi-audioCall zmThmHvrClr","data-type":"audio"}),zdom("div",{className:"SC_SDot"}),zdom("i",{title:o.video,className:"msi-videoCall zmThmHvrClr","data-type":"video"}));$.e(e).appendDOM(a),$.e(a).click(function(e){zmUtil.hideMenu(),s(t,$.e(e.target).data("type"))})}},invokeChatActions:s,showPresence:function(e,t){if(e=(e||"").trim(),!i()||!e)return null;var a,o=zmail.Utils.EmailValidator.validate(e);o&&o.status?r({email:e}).done(function(e){e&&e.zid&&(a=e.zid,c(a,t))}):_zm.isNumeric(e)&&c(a=e,t)}}}();
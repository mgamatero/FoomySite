"use strict";!function(){var e=zmail.Settings.Modules,t=e.import("Platform.Components").SettingManager,s=e.import("Platform.System.Utils"),r="signature-reply-replyall",i={errors:function(e){return"Error occured ! Error Code = "+e},fetch:function(e){var t=s.makeDeferred();return s.debugLog("fetching mail-setting "+r,e),t.resolve(Boolean(zmail.userOptions.hideSignatureInReply)),t.promise()},save:function(e,t){var i=s.makeDeferred();s.debugLog("saving "+r,e,t);var a={settings:JSON.stringify({hideSignatureInReply:e}),mode:"viewVO"},n={value:e};return zmAjq.XHR({u:zmail.conPath+"/userSettings.do",t:"POST",fn:function(e,t){zmail.userOptions.hideSignatureInReply=t.value,void 0!==zmail.mailOpt.hideSignatureInReply&&(zmail.mailOpt.hideSignatureInReply=t.value),i.resolve(t.value)},p:a,csr:"s",ep:n}),i.promise()}},a=t.create(r,{props:{defaultValue:!0},persister:i,type:"boolean",category:"mail"});a.initialize();var o=function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=new FormData,t=zmAjq.getCookie("zmcsr");e.append("aId",zmail.accId),e.append("frm","s"),e.append("uploadMode","drop"),e.append("mode","composeSet"),e.append("zmrcsr",t),e.append("img_file",r.file,r.fileName);var l=new XMLHttpRequest;l.upload.addEventListener("loadstart",function(){"function"==typeof r.initMethod&&r.initMethod(r.uniqId)},!1),l.onreadystatechange=function(){if(4===l.readyState)if(200===l.status){var e,t=$.parseJSON(l.responseText),i=t.fileName,a=t.aId,n=t.storeName,s=t.frm;if(i&&a&&n&&s){e="/zm/ImageSignature?fileName="+i,e+="&accountId="+a+"&storeName="+n,"s"===s&&(e+="&frm=s"),r.successCallback(e,r.uniqId)}else r.failureCallback(r.extParam,r.uniqId)}else 500===l.status||l.status,r.failureCallback(r.extParam,r.uniqId)},l.open("POST",zmail.conPath+"/zeUploadImage.do",!0),l.send(e)},n=zmail.Settings.Modules.create("Apps.Signature.constants"),l=zmText.get("editorInteg","tooltip"),d=zmText.get("zm-settings-signature"),u=zmText.get("editorInteg"),m={GET_ALL:"read",ADD:"create",UPDATE:"update",DELETE:"delete",ASSOCIATE:"associate"},c={1:d.beforeQuote,0:d.afterQuote},g=[[["bold",u.tooltip.bold,"zei-bold"],["italic",u.tooltip.italic,"zei-italic"],["underline",u.tooltip.underline,"zei-underline"],["strikethrough",u.tooltip.strikethrough,"zei-strike"]],[["fontfamily",u.tooltip.font,"zeFFce"]],[["fontsize",u.tooltip.fontSize,["ze_pdl","zeFUce"].join(" ")]],[["forecolor",u.tooltip.fontColor,"zei-textclr"],["backcolor",u.tooltip.backgroundColor,"zei-bgclr"]],[["image",u.tooltip.insertImage,"zei-image"],["link",u.tooltip.insertLink,"zei-link"],["insertHTML",l.insertHtml,"zei-html"],["edithtml",u.tooltip.editHtml,"zei-editHtml"]],[["alignoptions",u.tooltip.alignOptions,"zei-textleft"],["listoptions",u.tooltip.listOptions,"zei-unorder"],["indentoptions",u.tooltip.indentOptions,"zei-outdent"],["directionoptions",u.tooltip.directionOptions,"zei-rtl"],["lineHeight",u.tooltip.lineHeight,"zei-lineHeight"]],[["quote",u.tooltip.insertQuote,"zei-quote"],["removeformat",u.tooltip.removeFormatting,"zei-removeformat"]],[["tableGrid",u.tooltip.table,"zei-table"],["inserthorizontalrule",u.tooltip.insertHR,"zei-line"]],[["smiley",u.tooltip.insertSmiley,"zei-smiley"]]],p={UPDATE_SIGNATURE_IMAGE:"UPDATE_SIGNATURE_IMAGE",FETCH_COMPLETED:"fetchCompleted",ADD:"SIGNATURE_ADDED",UPDATE:"SIGNATURE_UPDATED",DELETE:"SIGNATURE_DELETED",ASSOCIATE:"SIGNATURE_ASSOCIATED"};n.METHODS=m,n.POSITION=c,n.POSITION_STYLE={1:{borderTop:"solid thin"},0:{borderBottom:"solid thin"}},n.TOOL_BAR=g,n.EVENTS=p,n.ERROR_CODE_MAP={8001:!0,default:!1},n.IMG_LOADING_DELAY=1100;var f=void 0,I=zmail.Core.Namespaces.create("zmail.Signature.models"),S={},h=zmail.Settings.Modules,A=h.import("Platform.System.Base"),v=function(e,t,i){return zmText.get("zm-settings-signature",e,t,i)},z=function(e,t){$.publish(e,t)};I.getSendMailDetails=function(a){return I.mailIds&&I.mailDetails?_(I.mailIds).map(function(e){var t=I.mailDetails[e],i={id:t.id};return i.id=t.id,i.fromAddress=t.fromAddress,i.type="uncheck",void 0!==a&&t.signatureId===a&&ZMStore.getInstance("signature").get(a).attributes.sendMailIds.includes(i.id)&&(i.type="check"),i}):[]};I.adminAddedSignDetails=function(t){var i={},a=[],n=zmail.Signature.adminAddedSignId,s=I.mailDetails;return Object.keys(s).forEach(function(e){n.includes(s[e].signatureId)&&s[e].signatureId===t&&((i={}).id=s[e].id,i.fromAddress=s[e].fromAddress,i.type="check",a.push(i))}),a};I.getSignatureImgURL=function(e){return S[e]};I.updateSignatureImgURL=function(e){return S[e]="/zm/SignatureImage?signatureId="+e+"&xhr="+(new Date).getTime(),S[e]};I.getSendMailDetail=function(e){if(I.mailIds&&I.mailDetails)return I.mailDetails[e]};var D=function(e,t){if(I.mailDetails){var i=I.mailDetails[e];i&&(i.signatureId=t)}};I.updateSendMailDetail=D;var E=function(i){var a=[];return I.mailIds&&I.mailDetails&&_(I.mailIds).each(function(e){var t=I.mailDetails[e];t.signatureId===i&&a.push(t.id)}),a};I.getSendMailIdsOf=E;I.hasAssociation=function(e,t){if(I.mailDetails)return(I.mailDetails[e]||{}).signatureId===t};var M=function(e){var i=[];return I.mailDetails&&_(e).each(function(e){var t=I.mailDetails[e];void 0!==t.signatureId&&i.push(t.signatureId)}),i};I.getSignatureIdsOf=M;I.associateMailId=function(e,t){var i=E(e);return i.includes(t)||i.push(t),i};I.disassociateMailId=function(e,t){var i=E(e);return i.splice(i.indexOf(t),1),i};I.cloneAttributes=function(){var e=f.attributes;return{id:f.id,name:e.name,content:e.content,position:e.position,sendMailIds:e.sendMailIds&&e.sendMailIds.slice()}};I.addNewModel=function(e,t){return ZMStore.createRecord("signature",e,t).then(function(e){var t=I.models.models,i=t.indexOf(e.model);return t.splice(i,1),t.unshift(e.model),e},function(e){return e})};I.validate=function(e){var t,i=(e=e||{}).attrs||{},a=i.name,n=i.id,s={invalidName:!0};if(!a||!a.trim())throw new A.Error(v("dispMsg.emptyName"),s);if(25<a.length)throw new A.Error(v("dispMsg.longName"),s);if(I.isSignatureNameExist(a,n))throw new A.Error(v("dispMsg.alreadyExists"),s);if(!(t=i.content)||!t.trim())throw new A.Error(v("dispMsg.emptySignature"))};I.isSignatureNameExist=function(e,t){if(I.models.get(t)&&!I.models.get(t).isNew&&e===I.models.get(t).attributes.name)return!1;var i=_(I.models.pluck("name")).map(function(e){return e.toLowerCase()});return e=e.toLowerCase(),-1!==i.indexOf(e)};I.save=function(e){var t,i,a=h.create("Apps.Signature.views"),n=p.UPDATE,s=e.opts,r=e.resp;t=s.attrs?""===s.attrs.attrs.mailIds?[]:s.attrs.attrs.mailIds.split(","):""===s.mailIds?[]:s.mailIds.split(","),e.isNew?n=p.ADD:i=""===s.attrs.attrs.mailIdsWithNoSignature?[]:s.attrs.attrs.mailIdsWithNoSignature.split(",");var l=[],o=[],d=I.getSignatureIdsOf(t);t.forEach(function(e){l.push(I.mailDetails[e].fromAddress),I.updateSendMailDetail(e,r.id)}),i&&_(i).each(function(e){o.push(I.mailDetails[e].fromAddress),I.updateSendMailDetail(e,void 0)}),e.model._collection?e.model._collection.updatesendMailId(d):I.models&&I.models.length&&e.model.updateSendMailId(d),e.model.updateSendMailId&&e.model.updateSendMailId(),z(n,e.model.cloneAttributes()),a.trigger(p.UPDATE),z(p.ASSOCIATE,{id:e.model.get("id"),mailIds:l,mailIdsWithNoSignature:o})},$.subscribe("FROM_ADDRESS/ADD",function(e,t){if(t.attr.isEnabled){var i=zmail.Signature.models.mailDetails,a={fromAddress:t.emailId,id:t.id};i&&(i[t.id]=a)}}),$.subscribe("FROM_ADDRESS/REMOVE",function(e,t){var i=zmail.Signature.models.mailDetails;i&&i[t.id]&&delete i[t.id]});var b=zmail.Core.Namespaces,O=b.get("zmail.DataLayer").DSModel,T=b.create("zmail.Signature.models"),N=function(e,t){$.publish(e,t)},y=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"defaults",value:function(){return{name:"",id:"",content:"",position:1,sendMailIds:[]}}},{key:"getIdAttribute",value:function(){return"id"}},{key:"parse",value:function(e){var t=[],i={name:e.name,id:e.id,content:e.content,position:e.position};return e.sendMailIds&&(t=e.sendMailIds,i.sendMailIds=t),i}},{key:"savePosition",value:function(t){var e={attrs:{id:this.id,position:t}},i=this;return this.triggerAction(m.UPDATE,e).then(function(e){i.set("position",t),N(p.UPDATE,i.cloneAttributes())},function(e){e.err&&e.err.hasOwnProperty("respObj")&&_zm.succErrMsg("e",e.err.respObj.error)})}},{key:"associateSignature",value:function(a,n){var s=this,r=this.id,e={attrs:{mailIds:a,mailIdsWithNoSignature:n}};return this.triggerAction(m.ASSOCIATE,e).then(function(){var e=M(a),t=[],i=[];_(a).each(function(e){t.push(T.mailDetails[e].fromAddress),D(e,r)}),_(n).each(function(e){i.push(T.mailDetails[e].fromAddress),D(e,void 0)}),s.updateSendMailIds(),s._collection.updatesendMailId(e),N(p.ASSOCIATE,{id:r,mailIds:t,mailIdsWithNoSignature:i})})}},{key:"updateSendMailIds",value:function(){this.set("sendMailIds",E(this.id))}},{key:"cloneAttributes",value:function(){var e=this.attributes;return{id:this.id,name:e.name,content:e.content,position:e.position,sendMailIds:e.sendMailIds&&e.sendMailIds.slice()}}}]),t}(O),C=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getBaseModelClass",value:function(){return y}},{key:"updatesendMailId",value:function(e){var i=this;_(e).each(function(e){var t=i.get(e);t&&t.updateSendMailIds()})}}]),t}(zmail.Core.Namespaces.get("zmail.DataLayer").DSCollection),P=zmail.Core.Namespaces,k=P.get("zmail.DataLayer").Adapter.HTTPAdapter,w=P.get("zmail.Signature"),R=P.create("zmail.Signature.models"),U={0:1,1:0},G=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getUrl",value:function(){return"/zm/signature.do"}},{key:"getDefaultRequestMethods",value:function(){return{create:"POST",update:"POST",patch:"POST",delete:"POST",read:"GET"}}},{key:"serialize",value:function(e,t,i){var a=null,n=i.attrs;return"delete"===e?a={mode:"delete",id:t.get(t.getIdAttribute())}:"fetchAll"===e?a={mode:"getAll"}:"associate"===e?(a={mode:"associate",id:t.get(t.getIdAttribute())},0<n.mailIds.length?a.set=n.mailIds[0]:0<i.attrs.mailIdsWithNoSignature.length&&(a.unset=n.mailIdsWithNoSignature[0])):"update"===e?(a={mode:"update",id:t.get(t.getIdAttribute()),position:U[t.get("position")]},null!==n&&n.attrs?(a={mode:"update",name:n.attrs.name,id:n.attrs.id,content:n.attrs.content,position:n.attrs.position},n.attrs.hasOwnProperty("mailIds")&&0<n.attrs.mailIds.length&&(a.set=n.attrs.mailIds),n.attrs.hasOwnProperty("mailIdsWithNoSignature")&&0<n.attrs.mailIdsWithNoSignature.length&&(a.unset=n.attrs.mailIdsWithNoSignature)):null===i.attrs&&(a={mode:"add",content:i.content,name:i.name,position:i.position},0<i.mailIds.length&&(a.set=i.mailIds),0<i.mailIdsWithNoSignature.length&&(a.unset=i.mailIdsWithNoSignature))):"create"===e&&(a={mode:"add",content:i.content,name:i.name,position:i.position},0<i.mailIds.length&&(a.set=i.mailIds)),a}},{key:"normalize",value:function(e,t,i){var a={},n=i.attrs;if("fetchAll"===e){var s,r=[];if(t.signatures){w.adminAddedAcc=[],w.adminSignSendMailId=[],w.adminAddedSignId=[],R.mailDetails=t.mailDetails,R.mailIds=t.mailIds;for(var l=t.signaturesOrder.length,o=0;o<l;o++){s=[];for(var d=t.signaturesOrder[o],u=0;u<t.mailIds.length;u++)t.mailDetails[t.mailIds[u]].hasOwnProperty("signatureId")&&t.mailDetails[t.mailIds[u]].signatureId===d&&s.push(t.mailIds[u]);t.signatures[t.signaturesOrder[o]].sendMailIds=s,r.push(t.signatures[t.signaturesOrder[o]])}for(var m=0;m<R.mailIds.length;m++)if(R.mailDetails[R.mailIds[m]].hasOwnProperty("isAdminAdded")&&!0===R.mailDetails[R.mailIds[m]].isAdminAdded){var c=R.mailDetails[R.mailIds[m]];w.adminAddedAcc.push(c.fromAddress),w.adminSignSendMailId.push(c.id)}for(var g=0;g<l;g++)if(t.signatures[t.signaturesOrder[g]].hasOwnProperty("isAdminAdded")&&!0===t.signatures[t.signaturesOrder[g]].isAdminAdded){var p=t.signatures[t.signaturesOrder[g]];w.adminAddedSignId.push(p.id)}return r}}else if("associate"===e){if(t)return a={content:t.content,id:t.id,position:t.position,name:t.name},0<n.mailIds.length?a.set=i.attrs.mailIds[0]:0<n.mailIdsWithNoSignature.length&&(a.unset=i.attrs.mailIdsWithNoSignature[0]),a}else if("delete"===e){if(t)return a}else if("update"===e){if(t)return a={id:t.id,position:t.position,sendMailIds:[]},null!==n&&n.attrs?(a={name:t.name,id:t.id,content:t.content,position:t.position},n.attrs.hasOwnProperty("mailIds")&&0<n.attrs.mailIds.length&&(a.set=n.attrs.mailIds,a.sendMailIds=n.attrs.mailIds.split(","))):null===n&&(a={name:t.name,id:t.id,content:t.content,position:t.position},i.hasOwnProperty("mailIds")&&0<i.mailIds.length&&(a.set=i.mailIds,a.sendMailIds=i.mailIds.split(","))),a}else if("create"===e)return a={content:i.content,name:i.name,set:i.mailIds,id:i.resp.id,position:i.position},i.hasOwnProperty("mailIds")&&0<i.mailIds.length&&(a.set=i.mailIds,a.sendMailIds=i.mailIds.split(",")),a}}]),t}(k);w.Adapter=G;var H=zmail.Core.Namespaces,L=null,x=H.get("zmail.Signature.models"),B=$.Deferred(),W=function(){var e={adapters:[{id:"http-adapter",type:"default",classObj:G}],default:"http-adapter"};return ZMStore.getInstance("signature")?L=ZMStore.getInstance("signature"):(L=ZMStore.createInstance("signature",C,{adapterConfig:e})).fetchAll().then(function(){x.models=L,B.resolve()}),B.promise()};W();var q=zmail.Settings.Platform.UI.Utils,j=zmail.Settings.Modules,J=zmail.Core.Namespaces,Z=j.create("Apps.Signature"),F=j.create("MailSuite.Apps.Signature.replySetting"),V=J.get("zmail.Signature.models"),Q=J.create("zmail.Signature");F.Setting=a,Z.inlineImage=function(n,e,s,r,l,t){var i;"file"===t?zmAttachComponent.imageEditTool.init({file:n.file,onAttach:function(e){n.file=e.blob,i()},onClose:function(){},handBckObj:function(){}}):"source"===t&&zmAttachComponent.imageEditTool.init({source:n,onAttach:function(e){(n={}).file=e.blob,i()},onClose:function(){},handBckObj:function(){}}),n.dataURI&&(n.file=zmCUtil.dataURItoBlob(n.dataURI)),i=function(){if(n.file){var e,t=(new Date).getTime()+".png",i=0;if(n&&n.file&&(n.file&&(e=n.file,n.file.name&&(t=n.file.name)),-1!==t.lastIndexOf(".")?"png"!==t.substr(t.lastIndexOf("."))&&(t+=".png"):t+=".png",n.file.size&&(i=n.file.size)),3145728<i){var a=zmText.get("zm-settings-signature").imageupload_size_exceeds;Dialog.alert(a)}o({file:e,fileName:t,uniqId:"pastImg",successCallback:r,failureCallback:l,initMethod:s})}}},Z.convertBase64ToImg=function(i,a,n){Object.keys(i).forEach(function(t){_zm.b64toBlob(i[t],function(e){o({file:e,fileName:t+".png",uniqId:t,successCallback:a,failureCallback:n,extParam:i})},function(e){})})},Q.Signature=y,Q.signatureCollection=C,Q.Adapter=G,Q.initialize=W,V.createNewModel=function(e){var t=new zmail.Signature.Signature({attrs:e.attrs});return I.addNewModel(t,e.attrs).then(function(e){var t=h.create("Apps.Signature.views"),i=e.id||e.opts.resp.id;e.isNew=!0,I.save(e),"function"==typeof t.trigger&&(t.trigger(p.UPDATE_SIGNATURE_IMAGE,i),self.props.onSave&&self.props.onSave())})},zmComponent.notifier.addHandler("mail",function(e,t){if("SIGNATURE_ASSOCIATE"===t.data.act){var i=ZMStore.getInstance("signature"),a=[];if(i){var n=t.data.data.SENDMAILID,s=t.data.data.SIGNID;if("null"===s){if(void 0===(s=zmail.Signature.models.mailDetails[n].signatureId))return;a=zmail.Signature.models.disassociateMailId(s,n)}else a=zmail.Signature.models.associateMailId(s,n);var r=i.get(s);zmail.Signature.models.updateSendMailDetail(n,r.id),r.set({sendMailIds:a}),zmail.Signature.models.updateSendMailDetail(n,r.id),zmail.Settings.Apps.Signature.views.trigger(zmail.Settings.Apps.Signature.constants.EVENTS.UPDATE)}}else if("SIGNATURE_ADD"===t.data.act){var l=ZMStore.getInstance("signature");t.data.data.SIGNOBJ.sendMailIds=[],l&&(l.add(t.data.data.SIGNOBJ),zmail.Settings.Apps.Signature.views.trigger(zmail.Settings.Apps.Signature.constants.EVENTS.UPDATE))}else if("SIGNATURE_DELETE"===t.data.act){var o=ZMStore.getInstance("signature"),d=t.data.data.SIGNID,u=zmail.Settings.Apps.Signature.constants.EVENTS.UPDATE,m=zmail.Settings.Apps.Signature.views;o.remove(o.get(d)),q.showSuccessMessage(zmText.get("zm-settings-signature","dispMsg.deleteSuccess")),m.trigger(u)}else if("SIGNATURE_UPDATE"===t.data.act){var c=ZMStore.getInstance("signature");if(c.models){var g=t.data.data.SIGNOBJ.content,p=t.data.data.SIGNOBJ.isAdminAdded,f=t.data.data.SIGNOBJ.name,I=t.data.data.SIGNOBJ.id,S=t.data.data.SIGNOBJ.position,h=c.get(I);zmail.Signature.models.updateSendMailDetail(),h.set({content:g,name:f,isAdminAdded:p,position:S}),zmail.Settings.Apps.Signature.views.trigger(zmail.Settings.Apps.Signature.constants.EVENTS.UPDATE_SIGNATURE_IMAGE,I)}}})}(),window.__rollupModule=void 0;
"use strict";!function(){var e,s,t,n=zmail.Search.Dependencies,g=n.ExternalDependency,p=n.MailDependency,i=zmail.ValueTypeInferrer,a=i.TYPES,l=i.TYPE_NAMES,r=zmail,o=r.Traverser,u=r.Paginator,y=r.Commander,C=r.ValueTypeInferrer,c=zmail.Utils.DOM,h=zmail.SearchComponents.ListView,d=zmail.Maps.Map,f="SEARCH_INIT",v="SEARCH_TAB_CLOSED",m="SEARCH_PAGINATION",S="SEARCH_FILTER_ADD",k="SEARCH_FILTER_REMOVE",b="SEARCH_ACTIVE_FRAMEWORK_INSTANCE",x="VIEW_CHANGE_FILTER_ADD",w="VIEW_CHANGE_FILTER_REMOVE",E=8,I=9,F=27,O=13,T=40,A=37,N=39,V=function(){},D=$.publish,_=zmsuite,P=p.getLoadingBand,M={getUniqueAppId:(e=0,function(){return"zm_srch"+(e+=1)})},z=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,t),this.afterInit=V,this.onDelete=V,this.onWorkSpaceConstruction=V,this.onWorkSpaceDestruction=V,this.init(e)}return babelHelpers.createClass(t,[{key:"defaults",value:function(){var e=this;return{tooltip:p.getI18n("search"),tabInfo:{appname:p.getI18n("search"),appId:M.getUniqueAppId(),data:{CNodes:"3"},appIcon:"msi-search",hashKey:"Search",hashChangeHandler:function(e){zmUtil.debugLog("New-Search hashUrl changed",e)},onDelete:function(){return!(e.__tabOpen=!1)}},__tabOpen:!1,__paginationBinded:!1,paginateScrollPercentage:60}}},{key:"overRideDefaultConfig",value:function(e){return e}},{key:"getDefaultConfig",value:function(){var t=this;return this.overRideDefaultConfig({listingAction:{obj:{left:[],right:[]},eventListeners:[]},listingHeader:{obj:{left:[],right:[]},eventListeners:[]},previewHeader:{obj:{rIcons:[[{tooltip:p.getI18n("close"),iconClass:"msi-close",data:"close"}]]},eventListeners:[{event:"click",callback:function(e){"close"===e&&t.closePreview()}}]}})}},{key:"init",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};Object.assign(this,this.defaults(),e);var t=this.tabInfo.onDelete,n=this;return this.tabInfo.onDelete=function(){if(this.__tabOpen=!1,g.isFunction(t)&&t())return n.onDelete(),n.removeLoadingBand(),n.unbindFrameWorkEvents(),n.onWorkSpaceDestruction(),D(v,{tabId:arguments[0],retainWorkspace:!0}),!0},this.handlePagination=this.handlePagination.bind(this),this.afterInit(),this}},{key:"initializeFrameWorkNodes",value:function(e){this.listing=e[0];var t=this.listing.getNodes();this.listingAction=t[0],this.listingHeader=t[1],this.listingCenter=t[2],this.preview=e[1];var n=this.preview.getNodes();return this.previewHeader=n[0],this.previewContent=n[1],this}},{key:"handlePagination",value:function(){var e=this.getListingCenterDOM(),t=Math.round(100*(e[0].scrollTop+e.height())/e[0].scrollHeight);p.onWorkspacePaginate(),t>=this.paginateScrollPercentage&&D(m)}},{key:"customScrollTrigger",value:function(){var e=this.getListingCenterDOM();e[0].scrollHeight<e.height()&&D(m)}},{key:"bindPagination",value:function(){this.__paginationBinded||(this.__paginationBinded=!0,this.getListingCenterDOM().on("scroll",this.handlePagination));return this}},{key:"unbindPagination",value:function(){this.__paginationBinded&&(this.__paginationBinded=!1,this.getListingCenterDOM().off("scroll",this.handlePagination));return this}},{key:"bindFrameWorkEvents",value:function(e){var t,n,i=function(e){g.isFunction(t.setListener)&&t.setListener(e.event,e.callback)};for(var a in e)t=this[a]||{},n=e[a]||{},g.isFunction(t.push)&&n.obj&&t.push(n.obj),(n.eventListeners||[]).forEach(i);return this}},{key:"unbindFrameWorkEvents",value:function(){this.unbindPagination()}},{key:"constructWorkSpace",value:function(){return this.tabInfo.isSearch=!0,_.setWorkSpace(this.tabInfo)&&(this.initializeFrameWorkNodes(_.getCenter()),this.tabInfo.isNewHeader?(this.constructNewHeader(this.listing.getNodes()),this.tabInfo.newHeaderOnly&&this.bindFrameWorkEvents(this.getDefaultConfig())):this.bindFrameWorkEvents(this.getDefaultConfig()),this.bindPagination(),_.renderWorkSpace(),this.onWorkSpaceConstruction(),this.customScrollTrigger()),this}},{key:"isTabOpen",value:function(){return _.isWorkspaceAvailable(this.tabInfo.appId)}},{key:"showWorkSpace",value:function(){return _.isWorkspaceAvailable(this.tabInfo.appId)||this.constructWorkSpace(),_.showWorkSpace(this.tabInfo.appId),this.__tabOpen=!0,this}},{key:"isWorkspaceAlreadyShown",value:function(){return this.tabInfo&&this.tabInfo.appId===zmTab.currentTab}},{key:"closeWorkspace",value:function(){return _.isWorkspaceAvailable(this.tabInfo.appId)&&_.closeWorkspace(this.tabInfo.appId),this.__tabOpen=!1,this}},{key:"addLoadingBand",value:function(e){var t=this.getListingCenterDOM();return t&&void 0===this.loadingBandRemover&&e&&(this.loadingBandRemover=P({container:t[0],notToSetInnerHTML:!0,addAtFirst:!e,type:e?"pagination":"listing"})),this}},{key:"removeLoadingBand",value:function(){return this.loadingBandRemover&&(this.loadingBandRemover(),this.loadingBandRemover=void 0),this}},{key:"isPreviewVisible",value:function(){return this.preview.$el.hasClass("shw")}},{key:"getPreviewDOM",value:function(){return this.preview&&this.preview.$el}},{key:"getPreviewContentDOM",value:function(){return this.previewContent&&this.previewContent.$el}},{key:"getListingCenterDOM",value:function(){return this.listingCenter&&this.listingCenter.$el}},{key:"getAppId",value:function(){return this.tabInfo.appId}},{key:"showPreview",value:function(){return this.preview.show(),this}},{key:"closePreview",value:function(){return this.preview.close(),this}}]),t}(),R=zmail.Utils.DOM,W=function(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},B=function(e){return zmail.Utils.EmailValidator.validate(e).status},L=(s=function(e,t,n){return e=(e||"").toLowerCase(),n?0<=e.indexOf(t):0===e.indexOf(t)},function(n,i,e,a){return i=(i||"").toLowerCase(),g.isString(n)?s(n,i,a):(e=e||Object.keys(n),g.underscoreJSWrapper(e).any(function(e){var t=n[e];return g.isString(t)?s(t,i,a):g.isArray(t)?g.underscoreJSWrapper(t).any(function(e){return s(e,i,a)}):void 0}))}),H=(t=1,function(){return++t}),j=function(e,t){var n,i;if(document.createRange){if((n=document.createRange()).selectNodeContents(e),n.collapse(t),0<(i=window.getSelection()).rangeCount)i.getRangeAt(0).getClientRects().length&&i.removeAllRanges();i.addRange(n)}else document.selection&&((n=document.body.createTextRange()).moveToElementText(e),n.collapse(t),n.select())},U=function(e){var t;if(document.body.createTextRange)(t=document.body.createTextRange()).moveToElementText(e),t.select();else if(window.getSelection){var n=window.getSelection();(t=document.createRange()).selectNodeContents(e),n.removeAllRanges(),n.addRange(t)}},q=function(e){var t,n,i=R.element(e);if("selectionStart"in e)return{position:parseInt(e.selectionStart),length:e.value.length};if(document.selection){var a=(n=document.selection.createRange()).text.length;return n.moveStart("character",-i.val().length),{position:t=n.text.length-a,length:t+a}}if(void 0!==window.getSelection){var s=(n=window.getSelection().getRangeAt(0)).startContainer&&n.startContainer.textContent,l=e.textContent;if(s===l){var r=n.startOffset;return n.startContainer.tagName&&(r=l.length),{position:r,length:l.length}}}},J=[],K=191,Q={"!":"shift+1","@":"shift+2","#":"shift+3",$:"shift+4","%":"shift+5","^":"shift+6","&":"shift+7","*":"shift+8","(":"shift+9",")":"shift+0","{":"shift+openBracket","}":"shift+closeBracket","|":"shift+backSlash","/":"forwardSlash","\\":"backSlash","[":"openBracket","]":"closeBracket","`":"backtick","~":"shift+backtick","'":"singleQuote",'"':"shift+singleQuote",";":"semiColon",":":"shift+semiColon",".":"period",",":"comma","=":"equalTo","+":"shift+equalTo","-":"minus",_:"shift+minus"},G=function(e){return String("<"+e+">")},Y=g.keys(Q),Z=g.values(Q),X=function(e){return p.isShortcutSettingEnabled()&&e?"search_across_zoho"===e?(t=[],-1<window.navigator.appVersion.toLowerCase().indexOf("mac")?t.push(G("Cmd")):t.push(G("Ctrl")),t.push("forwardSlash"),t.join("/")):e&&"function"==typeof p.getShortcutKeyString&&p.getShortcutKeyString("default",e)||"":"";var t},ee=function(e){var t=X(e).split("/"),i=[];return t.forEach(function(e){var t=Z.indexOf(e),n=0<=t?Y[t]:e;n=function(e){for(var t=["ctrl","cmd","alt"],n=0;n<t.length;++n)if(-1<e.toLowerCase().indexOf(t[n]))return!0;return!1}(n)?n:n.toLowerCase(),i.push(n)}),i},te=function(e){if(!p.isShortcutSettingEnabled())return"";if(!e)return"";var t=ee(e);return t.length?["  ( ",t.join(" + ")," )"].join(""):""},ne=p.getDefaultShortcutPlaceholderText,ie=function(e){return e.className||e.prototype&&e.prototype.className},ae=function(e,t){var n;return g.isFunction(e)?n=new e(t):(n=Object.create(e),g.isFunction(n.init)&&n.init(t)),ie(n)||(n.className=ie(e)),n},se=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return t.__isClass=!0,ae(e,t)},le={viewClassName:"Filter",viewClass:void 0,spellcheck:!1,setOnAutofillVisible:!1,nullableOnly:!1,removable:!0,filterValues:!0,filterProps:[],autofillSelectionIndex:-1,autofillForElementDebounceTime:0,cssSelectionClass:"sel",cssCompletedStateClass:"zmSBC",cssInCompletedStateClass:"zmSBC",cssInValidStateClass:"zmSBErr",cssAutofillUlClass:"",cssAutofillWrapperClass:"",autofillPageSize:10,autofillOnlyAfter:[],autofillOnlyAfterOperator:"all",autofillNotAfter:[],autofillNotAfterOperator:"any",removeDependentFilters:[],dependedOn:[],deferRemovingOnMultipleInstance:!0,autoComplete:!0,getName:function(){return g.isString(this.name)?this.name:""},getValue:function(){return g.isString(this.value)?this.value:""},autofillDOM:function(e){},autofillText:function(e){return e},onAutofillSelection:function(e,t){this.set(e,{autofillSelection:!0}),t.setValueBasedOnModel().selectEndOfText()}},re={multipleInstance:!0,restrictedToValues:!1,regexp:void 0,nullable:!1,validateOnSet:!1,validate:function(e){if(!e&&(this.nullableOnly||this.nullable))return!0;if(this.restrictedToValues){var t=this.getValues();if(g.isArray(t))return g.underscoreJSWrapper(t).contains(e)}else if(this.regexp instanceof RegExp)return this.regex.test(e);return Boolean(e)}},oe=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(babelHelpers.classCallCheck(this,t),!(this instanceof t))return new t(e);Object.assign(this,this.defaults()),this.extendMixins(),this.init(e)}return babelHelpers.createClass(t,[{key:"defaults",value:function(){return{className:"BaseFilter",name:void 0,description:"",valueType:void 0,validateValueType:!1,notifyingInterval:800,delayNotifyingChange:!0,notifyImmediatelyOnAutoFillSelection:!0,value:void 0,defaultValue:void 0,previousValue:void 0,values:void 0,mixins:[re,le]}}},{key:"overrideDefaults",value:function(){return this.restrictedToValues&&-1===this.autofillSelectionIndex&&(this.autofillSelectionIndex=0),this}},{key:"extendMixins",value:function(){var e=this.mixins||[];return delete this.mixins,e.reduce(function(e,t){return Object.assign(e,t),e},this)}},{key:"init",value:function(e){var t=(e=e||{}).__isClass;return delete e.__isClass,Object.assign(this,e),this.extendMixins(),t||(Object.assign(this,g.BackboneEvents),this.id=H(),this.notifyChangeImmediately=this.notifyChangeImmediately.bind(this),this.overrideDefaults().afterInit()),this}},{key:"afterInit",value:function(){}},{key:"onSet",value:function(){}},{key:"parse",value:function(e){return e}},{key:"set",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(void 0===e||e===this.value)return this;if(!this.validateOnSet||this.validate(e)){if(this.previousValue=this.value,this.value=this.parse(e),!t.silent){var n=this.notifyImmediatelyOnAutoFillSelection&&t.autofillSelection;this.notifyChange(n,t)}this.onSet(e,t)}return this}},{key:"isValid",value:function(){return this.validate(this.value)}},{key:"equals",value:function(e){return void 0!==e&&this.className===e.className&&this.toString()===e.toString()}},{key:"filter",value:function(e,t){var n=this.filterProps||[];return(e=e||[]).filter(function(e){return L(e,t,n)})}},{key:"getDefaultValue",value:function(){return g.isFunction(this.defaultValue)?this.defaultValue():this.defaultValue}},{key:"getValues",value:function(t,e){t=t||"";var n=g.isFunction(this.values)?this.values(t,e):this.values;if(t&&this.filterValues){var i=$.Deferred(),a=this;return $.when(n).then(function(e){i.resolve(a.filter(e,t))}),i.promise()}return n}},{key:"toJSON",value:function(){return{name:this.getName(),value:this.getValue(),className:this.className,actualValue:this.value,id:this.id,suggestForEmailQuery:this.suggestForEmailQuery,obj:this.value}}},{key:"toString",value:function(){var e=this.toJSON();return[e.className,e.name,e.value].join(":")}},{key:"remove",value:function(e){this.trigger("remove",this,e),this.off("")}},{key:"notifyChangeImmediately",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};clearTimeout(this._timeoutId),this._timeoutId=void 0,this.trigger("change",this.value,this.previousValue,this,e)}},{key:"notifyChange",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.delayNotifyingChange&&!e?(clearTimeout(this._timeoutId),this._timeoutId=setTimeout(this.notifyChangeImmediately.bind(this,t),this.notifyingInterval)):this.notifyChangeImmediately(t)}}]),t}(),ue=new(function(){function e(){babelHelpers.classCallCheck(this,e),this.stack={}}return babelHelpers.createClass(e,[{key:"get",value:function(e){for(var t=e.split("."),n=this.stack,i=t.length,a=0;a<i;++a){if(void 0===n[t[a]])return;n=n[t[a]]}return n}},{key:"set",value:function(e,t){for(var n=e.split("."),i=this.stack,a=n.length,s=0;s<a;++s){if(s+1===a){i[n[s]]=t;break}i[n[s]]=void 0===i[n[s]]?{}:i[n[s]],i=i[n[s]]}}}]),e}()),ce=["mail","streams","calendar","task","notes","attachment","bookmarks","contacts","quick access","search across zoho"],he=ae(oe,{className:"ContextFilter",name:p.getI18n("filters.in"),delayNotifyingChange:!1,validateOnSet:!0,autoComplete:!1,reOrderContexts:function(){var n=[],i=this.values;ce.forEach(function(t){var e=g.underscoreJSWrapper(i).find(function(e){return(e.contextID||e.contextName).toLowerCase()===t});e&&n.push(e)}),this.values=n,this.traverser.set({list:this.values})},setValueBasedOnTab:function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=this.values[0];if(t.openTabContextID)e=g.underscoreJSWrapper(this.values).find(function(e){return e.contextID===t.openTabContextID});else{var i=p.getCurrentTab();e=g.underscoreJSWrapper(this.values).find(function(e){return e.tabRegexp instanceof RegExp&&e.tabRegexp.test(i)})}e||(e=this.value||n),this.set(e)},getContextNames:function(){return g.underscoreJSWrapper(this.values).map(function(e){return e.contextName})},getContextIDs:function(){return g.underscoreJSWrapper(this.values).map(function(e){return e.contextID})},getContextOf:function(t){return g.underscoreJSWrapper(this.values).filter(function(e){return e.contextID===t})[0]},afterInit:function(){this.traverser=new o({list:this.values,startIndex:0}),this.setValueBasedOnTab()},onSet:function(e){this.traverser.setIndexOf(e)},select:function(e){var t=this.traverser.traverse(e).value();return this.set(t),this},removable:!1,values:[],autofillSelectionIndex:0,restrictedToValues:!0,filterProps:["contextName"],cssAutofillWrapperClass:"appSwitchDD",autofillDOM:function(e){var t=c.element(document.createDocumentFragment());if(t.__isZohoOneSearch=e.__isZohoOneSearch,t.__specialIconClass=e.__specialIconClass,t.templateType=t.__isZohoOneSearch?"zohoOneSearch":"",c.mountAtStart(zdom("i",{className:e.contextIcon}),t),e.__specialIconClass&&c.mount(zdom("i",{className:e.__specialIconClass+" SC_frt"}),t),c.mount(document.createTextNode(e.contextName),t),e.shortcutId&&p.isShortcutSettingEnabled()){var n=ee(e.shortcutId);e.shortcutText=Array.isArray(n)?n:[n];var i=c.element(zdom("span",{className:"SC_frt"}));n.forEach(function(e){e&&c.mount(zdom("strong",{className:"zmKey smallKey"},e),i)}),c.mountAtStart(i,t)}return t},autofillText:function(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).contextName||""},getValue:function(){return(this.value||{}).contextName||""}}),de=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return he.set(e,t)},fe=se(oe,{name:p.getI18n("filters.string"),className:"StringFilter",viewClassName:"StringFilter",valueType:a.String.name,validate:function(e){return g.isString(e)},getValue:function(){return this.value},autofillText:function(e){if(g.isString(e))return e}}),ve=p.getContactBook(),me=se(fe,{name:p.getI18n("filters.contact"),className:"ContactFilter",valueType:a.Contact.name,filterValues:!1,values:function(e,t){if(g.isEmpty(e))return ve.getMostUsedContacts();var n={includeEmailedGroups:!0,str:e,type:["personal","org","crm"]};return ve.get(n)},validate:function(e){return ve.isContact(e)||ve.isGroup(e)||(t=e,!("object"!==babelHelpers.typeof(t)||!t.validatedEmail)||fe.validate(t)&&p.emailValidation(t))||fe.validate(e);var t},getValue:function(){var e=this.value||"";return g.isString(e)?e:ve.isContact(e)?e.get("eid")||e.name:ve.isGroup(e)?e.get("eid")||e.get("name"):ve.isCategory(e)?e.get("cname"):e.notPresentInContacts?e.validatedEmail||e.value:void 0},autofillText:function(e,t){if(g.isString(e))return e;if(ve.isContact(e)){var n=t&&t.query;return e.getMatchingName(n)||e.name}return ve.isGroup(e)?e.get("eid")||e.get("name"):ve.isCategory(e)?e.get("cname"):e.notPresentInContacts?e.validatedEmail||e.value:void 0},autofillDOM:function(e,t){return e.view(t&&t.query)}}),ge=se(oe,{name:p.getI18n("filters.number"),className:"NumberFilter",viewClassName:"NumberFilter",valueType:a.Number.name,validate:function(e){return g.isNumber(e)},getValue:function(){return this.value},autofillText:function(e){if(g.isNumber(e))return e}}),pe=se(oe,{name:p.getI18n("filters.date"),spellcheck:!1,className:"DateFilter",description:p.getI18n("filters.aDate"),viewClassName:"DateFilter",value:void 0,multipleInstance:!0,validateOnSet:!0,validate:function(e){if(e)return e instanceof Date||e.__date},getValue:function(){return this.value instanceof Date?this.value.getDateBy(p.getUserDateFormat()):this.value&&this.value.__date?this.value.display:void 0},toJSON:function(){var e=this.value;return e&&e.__date&&(e=a.Date.toDate(e)),{name:this.getName(),value:this.getValue(),className:this.className,actualValue:e,obj:e}}}),ye=p.getCurrentDate(),Ce=se(pe,{name:p.getI18n("filters.fromDate"),className:"FromDateFilter",description:p.getI18n("search-base","filters.fromThisDate"),multipleInstance:!1,valueType:a.Date.name,range:["",ye],validate:function(e){if(pe.validate(e)){var t=ue.get("Environment");if(t&&t.has("ToDateFilter")){var n=t.get("ToDateFilter")[0].toJSON().actualValue;return!!pe.validate(n)&&a.Date.toDate(e).getTime()<n.getTime()}return!0}return!1},autofillText:function(e){return e.display}}),Se=se(pe,{name:p.getI18n("filters.tillDate"),className:"ToDateFilter",description:p.getI18n("filters.tillThisDate"),multipleInstance:!1,valueType:a.Date.name,range:["",p.getCurrentDate()],validate:function(e){if(pe.validate(e)){var t=ue.get("Environment");if(t.has("FromDateFilter")){var n=t.get("FromDateFilter")[0].toJSON().actualValue;return!!pe.validate(n)&&a.Date.toDate(e).getTime()>n.getTime()}return!0}return!1},autofillText:function(e){return e.display}}),ke=function(){},be=new(function(){function t(e){if(babelHelpers.classCallCheck(this,t),!(this instanceof t))return new t(e);this.init(e)}return babelHelpers.createClass(t,[{key:"defaults",value:function(){var n=this;return Object.assign({},["onSelect","onUnselect","onAdd","onRemove","beforeRemove","onViewChange","onAutofillSelection","onEnter","onNameClick","onNameSelect"].reduce(function(e,t){return e[t]=n[t]||ke,e},{}),{isCollection:!0,list:[],classNameList:{},map:{},traverser:new o})}},{key:"init",value:function(){Object.assign(this,this.defaults(),g.BackboneEvents),this.removeInstance=this.removeInstance.bind(this),this.notifyChange=this.notifyChange.bind(this)}},{key:"getList",value:function(e){if(!e)return this.list||[];g.isArray(e)||(e=[e]);var n=this.classNameList;return e.reduce(function(e,t){return e.concat(n[t]||[])},[])}},{key:"getLength",value:function(){return this.list.length}},{key:"add",value:function(e,n){return void 0===e||(g.isArray(e)||(e=[e]),n=n||{},e.reduce(function(i,t){var e=i.classNameList[t.className]||[];return(i.classNameList[t.className]=e).push(t.id),i.list.push(t.id),(i.map[t.id]=t).on("change",i.notifyChange),t.on("remove",i.removeInstance),t.on("remove",function(){var n=ue.get("SearchWatcher").getCurrentContext(),e=t.removeDependentFilters;(g.isEmpty(e)||!g.isArray(e)||t.deferRemovingOnMultipleInstance)&&i.has(t.className)||(n&&(e=e.filter(function(e){var t=n.getFilterClass(e);return!(t&&!g.isEmpty(t.dependedOn))||g.underscoreJSWrapper(t.dependedOn).all(function(e){return!i.has(e)})})),g.isEmpty(e)||i.remove(e))}),i.trigger("add",t,n),i},this),this.trigger(x,e,n),n.silent||this.trigger(S,e,n)),this}},{key:"removeInstance",value:function(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=this.classNameList[e.className],a={};return g.isEmpty(i)||-1!==(t=i.indexOf(e.id))&&(a.classsName=i.splice(t,1)),g.isEmpty(this.list)||-1!==(t=this.list.indexOf(e.id))&&(a.list=this.list.splice(t,1)),a.mappedData=this.map[e.id],a.instance=e,n.removedInstanceDetails=a,delete this.map[e.id],this.trigger("remove",e,this),n.retainWorkspace=g.isEmpty(this.list),n.silent||(this.trigger(w,this,n),this.trigger(k,this,n)),this}},{key:"remove",value:function(e,i){var t=this.getList(e).slice();return i=i||{},t.reduce(function(e,t){var n=e.map[t];return n&&n.remove(g.jQueryExtend({},i,{silent:!0})),e},this),t&&t.length&&(this.trigger(w,this,i),i.silent||this.trigger(k,this,i)),this}},{key:"isEmpty",value:function(){return 0===this.getLength()}},{key:"has",value:function(e){return!g.isEmpty(this.classNameList[e])}},{key:"get",value:function(e){var n=this;return this.getList(e).reduce(function(e,t){return e.push(n.map[t]),e},[])}},{key:"toJSON",value:function(e){return this.get(e).reduce(function(e,t){return t.isValid()&&e.push(t.toJSON()),e},[])}},{key:"hash",value:function(){return this.toJSON().map(function(e){return[e.className,e.name,e.value].join(":")}).join("::")}},{key:"isHashChanged",value:function(e){var t=this.hash();return void 0!==t&&t!==e}},{key:"notifyChange",value:function(e,t,n){this.trigger("change",e,t,n)}}]),t}());ue.set("Environment",be);var xe,we,$e={SEARCH:"SEARCH",COMMANDS:"COMMANDS",COMMAND_EXECUTION:"COMMAND_EXECUTION"},Ee={previousMode:void 0};Object.assign(Ee,g.BackboneEvents),Object.defineProperty(Ee,"mode",{get:function(){return xe},set:function(e){e in $e&&e!==xe&&(we=Ee.previousMode=xe,xe=e,Ee.trigger("change",e,we))},enumerable:!1,configurable:!1});var Ie=Ee,Fe=!1,Oe=g.eventPublisher,Te=g.WHEN,Ae=g.eventUnSubscriber,Ne=g.eventSubscriber,Ve=new(function(){function e(){babelHelpers.classCallCheck(this,e),this.history=[],this.server=[],this.frameworks=[],this.__bindable=["handleContextChange","handleTabClose","handleTabSwitch","handleLabelDeletion","handleLabelUpdation","handleActiveFrameworkInstance","handleAccountSwitch","handlePagination"],this.forceSearch=g.debounce(this.forceSearch.bind(this),2e3,!0)}return babelHelpers.createClass(e,[{key:"init",value:function(){this.bindFunctions().beginWatch()}},{key:"userChangedContext",value:function(){return Fe=!0,this}},{key:"setUserChangedContext",value:function(e){return Fe=e,this}},{key:"getUserChangedContext",value:function(){return Fe}},{key:"bindFunctions",value:function(){return this.__bindable.reduce(function(e,t){return e[t]=e[t].bind(e),e},this)}},{key:"addToHistory",value:function(e){return this.getCurrentContext().history.unshift(e),this}},{key:"removeFromHistory",value:function(e){return this.getCurrentContext().history.splice(e,1),this}},{key:"addToServer",value:function(e){return this.server.push(e),this}},{key:"removeFromServer",value:function(e){return this.server.splice(e,1),this}},{key:"getCurrentContext",value:function(){return he.value}},{key:"getPreviousContext",value:function(){return he.previousValue}},{key:"getUsableFilters",value:function(){var i=this.getCurrentContext();return be.toJSON().reduce(function(e,t){var n=i.getFilterClass(t.name);return n&&n.validate(t.value)&&e.push(i.createFilter({name:t.name,value:t.value})),e},[])}},{key:"handleContextChange",value:function(e,t,n){var i=this,a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},s=this.getPreviousContext(),l=this.getUsableFilters();s&&be.remove(void 0,{retainWorkspace:!0});var r=this.getCurrentContext();if(r){r.active();var o=function(){var e=r.getFrameworkInstance();e&&i.frameworks.indexOf(e)<0&&i.frameworks.push(e),l.length&&!a.ignoreUsableFilters&&(be.add(l),g.defer(function(){ue.get("ViewInstance.SearchBox").resetAutofill().hideAutofill()}))};"pending"===r.dependencyPromise.state()?r.dependencyPromise.then(o,function(){throw arguments}):o()}}},{key:"getCurrentActiveFrameworkInstance",value:function(){return this.activeFrameworkInstance}},{key:"getOpenTabContextID",value:function(){var e=this.getCurrentActiveFrameworkInstance();if(e&&e.isTabOpen())return e.contextID}},{key:"getTabElements",value:function(){var e={};return this.activeFrameworkInstance&&(e.$previewDOM=this.activeFrameworkInstance.getPreviewDOM(),e.$previewContentDOM=this.activeFrameworkInstance.getPreviewContentDOM(),e.$listingCenterDOM=this.activeFrameworkInstance.getListingCenterDOM()),e}},{key:"handleActiveFrameworkInstance",value:function(e,n){var i=this.frameworks,a=this,t=i.slice();this.activeFrameworkInstance=n,t.forEach(function(e){if(e!==n){e.closeWorkspace();var t=i.indexOf(e);i.splice(t,1)}else a.activeFrameworkInstance=e})}},{key:"handleTabSwitch",value:function(e,t,n){var i=-1<(t||p.getCurrentTab()).indexOf("zm_srch");be.isEmpty()&&!Fe&&he.setValueBasedOnTab({openTabContextID:i?this.getOpenTabContextID():""}),Fe=!1,Oe("mailsuite/searchShrink",i?{mode:"remove"}:{mode:"add"})}},{key:"handleAccountSwitch",value:function(e,t){var n=this.getCurrentContext();n&&t&&n.onAccountSwitch(t.accountID)}},{key:"search",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(e.data=be.toJSON(),ue.get("ViewInstance.FilterCollectionView").validateFiltersStateClass(),e.data.length){var t=this.getCurrentContext();if(e.paginate)return void t.paginate(e);var n=ue.get("ViewInstance.SearchBoxContainer");n.showLoading(),Te(t.search(e)).always(function(){n.hideLoading();var e=ue.get("ViewInstance.SearchBox");be.isEmpty()&&e.isEmpty()?n.hideCloseIcon():n.showCloseIcon()})}}},{key:"forceSearch",value:function(){this.search({forceSearch:!0})}},{key:"handlePagination",value:function(){this.search({paginate:!0})}},{key:"handleTabClose",value:function(e){var t=this.getCurrentContext();t&&t.reset()}},{key:"handleLabelUpdation",value:function(e,t){t.label}},{key:"handleLabelDeletion",value:function(e,t){for(var n=t.labelID,i=be.toJSON(),a=i.length,s=0;a;){var l=i[s];(l&&(l.actualValue||l.obj||{})).id===n&&be.remove("TagFilter",{disableSearchFocus:!0}),++s,--a}setTimeout(function(){Oe("mailsuite/searchClose")},300)}},{key:"beginWatch",value:function(){var a=this;he.on("change",this.handleContextChange),Ne("/apps/tabSwitched",this.handleTabSwitch),Ne("/mail/accountSwitch",this.handleAccountSwitch),Ne(b,this.handleActiveFrameworkInstance),Ne("label/renamed",this.handleLabelUpdation),Ne("label/deleted",this.handleLabelDeletion),be.on(S,function(e){var t=a.getCurrentContext();t&&(t.onAdd(e),t.searchOnFilterAdd&&a.search())}),be.on(k,g.debounce(function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=a.getCurrentContext();n&&(n.onRemove(e,t),n.searchOnFilterRemove&&!be.isEmpty()&&a.search(),be.isEmpty()&&!t.retainWorkspace&&n.reset())},2e3,!0)),be.on("change",function(e,t,n){var i=a.getCurrentContext();i&&(i.onChange(n),i.searchOnFilterChange&&a.search())}),Ne(m,this.handlePagination),Ne(v,this.handleTabClose)}},{key:"unbindEvents",value:function(){he.off("change",this.handleContextChange),be.off(S).off(k).off("change"),Ae(v,this.handleTabClose),Ae(m,this.handlePagination),Ae("/apps/tabSwitched",this.handleTabSwitch),Ae("/mail/accountSwitch",this.handleAccountSwitch),Ae(b,this.handleActiveFrameworkInstance),Ae("label/deleted",this.handleLabelDeletion),Ae("label/updated",this.handleLabelUpdation)}}]),e}());ue.set("SearchWatcher",Ve);var De=function(){},_e="default",Pe="ViewInstance.SearchBoxContainer",Me=function(){function t(e){if(babelHelpers.classCallCheck(this,t),!(this instanceof t))return new t(e);this.init(e)}return babelHelpers.createClass(t,[{key:"defaults",value:function(){var n=this;return Object.assign({},["handleBlur","placeholder","onSelect","onUnselect","onBackspace","autoSize","next","previous","onChange"].reduce(function(e,t){return e[t]=n[t]||De,e},{}),{modeHandlers:{},stringHandlers:{},defaultMaxWidth:500,minWidth:50,maxWidth:500,__bindable:["handleKeyDownEvent","handleClickEvent","handleKeyUpEvent","handleInputChangeEvent","ignoreMouseDownEvent","handleModeChange","autoSize"]})}},{key:"bindFunctions",value:function(){return this.__bindable.reduce(function(e,t){return e[t]=e[t].bind(e),e},this)}},{key:"init",value:function(e){return Object.assign(this,this.defaults(),e),Object.defineProperty(this,"autofill",{get:function(){var e=this.modeHandlers[Ie.mode]||{};return g.isFunction(e.autofill)&&e.autofill()}}),this.bindFunctions().bindEvents().bindAutofill().setPlaceholder()}},{key:"parser",value:function(e,t){return!1}},{key:"delegate",value:function(e,t){var n=this.stringHandlers[e];return!(!n||!0!==g.result(n,"isSafe"))&&(n.action(t,this),!0)}},{key:"registerStringHandler",value:function(e,t){return this.stringHandlers[e]=t,this}},{key:"registerModeHandler",value:function(e,t){return this.modeHandlers[e]=t,this}},{key:"getWidth",value:function(){return this.$el[0]?this.$el[0].offsetWidth:10}},{key:"calculateMaxWidth",value:function(){var e=ue.get("ViewInstance.SearchBoxContainer.$els.$el");return e&&e[0]&&(this.maxWidth=e.width()-50,this.maxWidth=this.maxWidth<=500?this.maxWidth:500,this.maxWidth=this.maxWidth<=0?350:this.maxWidth),this}},{key:"setWidth",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.maxWidth;return this.maxWidth=this.maxWidth<=0?350:this.maxWidth,e=e<=0?this.maxWidth:e,this.$el.css("width",e+"px"),this}},{key:"resize",value:function(){return this.setWidth(this.maxWidth)}},{key:"isActiveElement",value:function(){var e=document.activeElement;return void 0!==e&&e===this.$el[0]}},{key:"setPlaceholder",value:function(e){if(void 0===e){var t=this.modeHandlers[Ie.mode]||{},n=g.result(t,"placeholder");void 0!==n&&this.$el.attr("placeholder",n)}else this.$el.attr("placeholder",e);return this}},{key:"getText",value:function(){return this.$el.val()}},{key:"isEmpty",value:function(){return g.isEmpty(this.getText())}},{key:"setText",value:function(e){return this.$el.val(e),this}},{key:"clearText",value:function(){return this.setText("")}},{key:"focusElement",value:function(){return this.$el&&this.$el[0]}},{key:"focus",value:function(){var e=this;setTimeout(function(){return e.$el.focus()}),this.onSelect(this)}},{key:"blur",value:function(){this.$el.blur(),this.onUnselect(this)}},{key:"select",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return this.$el&&(this._autofill&&this._autofill.hide(),this.autofill&&!e.disableAutofill&&this.autofill.change((this.$el.val()||"").trim(),e),e.disableSearchBoxFocus||this.focus()),this}},{key:"selectAllText",value:function(){return this}},{key:"selectEndOfText",value:function(){return this}},{key:"unselect",value:function(){return this.autofill&&(this.resetAutofill(),this.autofill.hide()),this.blur(),this}},{key:"stopEvent",value:function(e){return e.stopPropagation(),e.stopImmediatePropagation(),this}},{key:"preventEvent",value:function(e){return e.preventDefault(),this}},{key:"handleModeChange",value:function(){var e=ue.get(Pe),t=ue.get("Environment");return e&&"function"==typeof e.hideCloseIcon&&t&&t.isEmpty&&t.isEmpty()&&e.hideCloseIcon(),this.clearText().setPlaceholder().unbindPreviousAutofill().bindAutofill().resetAutofill()}},{key:"handleInputChangeEvent",value:function(e){this.isActiveElement()&&this.parser(this.getText())&&this.stopEvent(e),this.onChange()}},{key:"ignoreMouseDownEvent",value:function(e){return e.target===this.$el[0]}},{key:"handleClickEvent",value:function(e){p.onSearchBoxContainerClickEvent(),this.select(),e.stopPropagation(),e.stopImmediatePropagation()}},{key:"getCaretPosition",value:function(){return q(this.$el[0])}},{key:"handleKeyDownEvent",value:function(e){var t,n=e.keyCode,i=this.$el.val()||"";if(n!==E||i)if(n!==T||this.isAutoFillVisible()){if(n===O)i=i.trim(),this.isAutoFillVisible()||(this.delegate(_e,{value:i}),this.preventEvent(e).stopEvent(e));else if(n===N)(t=this.getCaretPosition())&&t.position===t.length&&(e.preventDefault(),this.next());else if(n===A)(t=this.getCaretPosition())&&0===t.position&&(e.preventDefault(),this.previous());else if(n===F&&Ie.mode===$e.COMMANDS){var a=ue.get(Pe);this.isEmpty()?a.collapseSearch():a.removeFocusClass(),this.blur()}}else this.autofill.change(this.$el.val()),this.stopEvent(e);else this.onBackspace(),this.preventEvent(e).stopEvent(e)}},{key:"handleKeyUpEvent",value:function(e){var t=$.trim(this.$el.val());t!==_e&&this.delegate(t,t)&&this.preventEvent(e).stopEvent(e)}},{key:"isAutoFillVisible",value:function(){return this.autofill&&this.autofill.isVisible()}},{key:"isAutoFillSelected",value:function(){return this.autofill&&this.autofill.isSelected()}},{key:"hideAutofill",value:function(){return this.isAutoFillVisible()&&this.autofill.hide(),this}},{key:"resetAutofill",value:function(){return this.autofill&&this.autofill.reset(),this}},{key:"bindAutofill",value:function(){var e=this.modeHandlers[Ie.mode];return e&&e.autofill().bind(),this}},{key:"unbindAutofill",value:function(){var e=this.modeHandlers[Ie.mode];return e&&e.autofill().unbind(),this}},{key:"unbindPreviousAutofill",value:function(){var e=this.modeHandlers[Ie.previousMode];return e&&e.autofill().unbind(),this}},{key:"handleFocus",value:function(e){ue.get(Pe).hasFocusClass()||this.onSelect(this)}},{key:"bindEvents",value:function(){return this.$el&&(this.$el.on("keydown",this.handleKeyDownEvent).on("keyup",this.handleKeyUpEvent).on("mousedown",this.handleClickEvent).on("change input",this.handleInputChangeEvent).on("focus",this.handleFocus.bind(this)).on("blur",this.handleBlur),Ie.on("change",this.handleModeChange)),this}},{key:"unbindEvents",value:function(){return this.$el&&(this.$el.off("keydown",this.handleKeyDownEvent).off("keyup",this.handleKeyUpEvent).off("mousedown",this.handleClickEvent).off("change input",this.handleInputChangeEvent).off("focus",this.handleFocus).off("blur",this.handleBlur),Ie.off("change",this.handleModeChange)),this}}]),t}(),ze=function(){},Re=/msie|trident|edge/i.test(navigator.userAgent),We={66:1,73:1,85:1},Be=function(){function t(e){if(babelHelpers.classCallCheck(this,t),!(this instanceof t))return new t(e);this.init(e)}return babelHelpers.createClass(t,[{key:"getDefaults",value:function(){var e=this;return Object.assign({},["afterInit","onShow","onHide","onSelect","onUnselect","onAutofillSelection","onShowingAutofill","beforeRemove","onRemove","onViewChange","onEnter","onNameSelect","next","previous"].reduce(function(e,t){return e[t]=e[t]||ze,e},e),{__userInput:!1,__updateTimeoutId:void 0,paginateAutofill:!0,nameAutofill:!1,__bindable:["handleKeyEvent","handleInputAndChangeEvent","handleClickEvent","handleDoubleClickEvent","handleClickEventOnCloseIcon","handleClickEventOnName","handleFocus","triggerChangeEvent","handlePasteEvent","addStateClass","setValueBasedOnModel","removeUI"]})}},{key:"bindFunctions",value:function(){return this.__bindable.reduce(function(e,t){return e[t]=e[t].bind(e),e},this)}},{key:"init",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.__isClass;return delete e.__isClass,Object.assign(this,this.getDefaults(),e),t||this.bindFunctions().compileTemplate().mount(e.$before).bindNameAutofill().bindAutofill().bindEvents().addStateClass().afterInit(),this}},{key:"compileTemplate",value:function(){return this.$els=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=c.element(zdom("div",{className:"zmSearchBub"},zdom("span",{className:"js-fname",tabIndex:"-1"}),zdom("span",{className:"js-fvalue",contentEditable:"true"}),zdom("i",{className:"msi-close"}))),n=t.find(".js-fname");n.text(e.name||"");var i=t.find(".js-fvalue");return i.text(e.value||""),{$el:t,$name:n,$value:i,$close:t.find(".msi-close")}}(this.filter.toJSON()),this.filter.nullableOnly&&this.$els.$el.addClass("zmSBoB"),!this.filter.spellcheck&&this.$els.$value&&this.$els.$value.attr("spellcheck",!1),this}},{key:"mount",value:function(e){return(e||this.$parent)&&this.$els&&(e||(e=this.$parent.find("input")),c.mountBefore(this.$els.$el,e)),this}},{key:"isVisible",value:function(){return this.$els.$el.is(":visible")}},{key:"isAutoFillVisible",value:function(){if(this.autofill)return this.autofill.isVisible()}},{key:"isAutoFillSelected",value:function(){if(this.autofill)return this.autofill.isSelected()}},{key:"getCaretPosition",value:function(){return q(this.$els.$value[0])}},{key:"getWidth",value:function(){return this.isVisible()?this.$els.$el.outerWidth(!0):0}},{key:"getTop",value:function(){return this.isVisible()?this.$els.$el.offset().top:0}},{key:"focusElement",value:function(){return this.$els.$value&&this.$els.$value[0]}},{key:"getViewElement",value:function(){return this.$els.$el}},{key:"getValue",value:function(){return this.$els.$value?this.$els.$value.text().trim():""}},{key:"setValue",value:function(e){return this.$els.$value&&this.$els.$value.text(e),this}},{key:"setValueBasedOnModel",value:function(){return this.setValue(this.filter.getValue())}},{key:"listenForUser",value:function(){return clearTimeout(this.__updateTimeoutId),this.__updateTimeoutId=void 0,this}},{key:"updateModel",value:function(){var e=this;return this.listenForUser().__updateTimeoutId=setTimeout(function(){e.__userInput&&(e.__userInput=!1,e.filter.set(e.getValue()))},300),this}},{key:"selectAllText",value:function(){return this.$els.$value&&U(this.$els.$value[0]),this}},{key:"selectEndOfText",value:function(){return this.$els.$value&&j(this.$els.$value[0]),this}},{key:"show",value:function(){return this.$els.$el.show(),this.onShow(),this}},{key:"hide",value:function(){return this.$els.$el.hide(),this.autofill&&this.autofill.hide(),this._autofill&&this._autofill.hide(),this.onHide(),this}},{key:"addStateClass",value:function(){var e=this.filter,t=this.$els.$el;return t.removeClass([e.cssCompletedStateClass,e.cssInCompletedStateClass,e.cssInValidStateClass].join(" ")),void 0!==e.value&&e.value?e.isValid()?t.addClass(e.cssCompletedStateClass):t.addClass([e.cssInCompletedStateClass,e.cssInValidStateClass].join(" ")):e.nullableOnly?t.addClass(e.cssCompletedStateClass):t.addClass(e.cssInCompletedStateClass),this}},{key:"isValid",value:function(){return this.filter.isValid()}},{key:"select",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.$els.$el.addClass(this.filter.cssSelectionClass);var t=this,n=this.getValue();return n||this.setValue(""),this._autofill&&this._autofill.reset().hide(),this.autofill&&(!g.isString(this.filter.value)&&this.isValid()&&(n=""),this.autofill.change(n)),this.$els.$value&&!e.disableFilterFocus&&setTimeout(function(){t.$els.$value.focus()},0),this.onSelect(this),this}},{key:"unselect",value:function(){return this.$els.$el.removeClass(this.filter.cssSelectionClass),this.autofill&&this.autofill.reset().hide(),this._autofill&&this._autofill.reset().hide(),this.onUnselect(this),this}},{key:"handleNavigation",value:function(e,t){var n=this.getCaretPosition();-1===e&&n&&0===n.position?(t.preventDefault(),this.previous()):1===e&&n&&n.position===n.length&&(t.preventDefault(),this.next())}},{key:"handleFocus",value:function(){if(Re){var e=this.$els.$value;e.data("before",c.element(e,!0).outerHTML)}}},{key:"triggerChangeEvent",value:function(){if(Re){var e=this.$els.$value,t=c.element(e,!0).outerHTML;e.data("before")!==t&&(e.data("before",t),e.trigger("change"))}}},{key:"preventFormatting",value:function(e){e.keyCode in We&&(e.ctrlKey||e.metaKey)&&e.preventDefault()}},{key:"handleKeyEvent",value:function(e){this.preventFormatting(e);var t=e.keyCode;if(t===O)this.autofill&&this.autofill.isSelected()||(e.stopPropagation(),this.onEnter()),e.preventDefault();else if(t===T)this.autofill&&!this.autofill.isVisible()&&this.autofill.change(this.getValue());else if(t===E){if(this.isFilterNonEditable)e.preventDefault();else $.trim(this.getValue())||(this.remove({backspaceKey:!0}),e.preventDefault());e.stopPropagation(),e.stopImmediatePropagation()}else t===N?this.handleNavigation(1,e):t===A&&this.handleNavigation(-1,e);var n=ue.get("ViewInstance.SearchBoxContainer");n&&!n.hasFocusClass()&&n.expandSearch(),this.filter.nullableOnly&&e.preventDefault()}},{key:"handleClickEvent",value:function(e){p.onFilterClickEvent(),this.select(),this.filter.nullableOnly?(this.selectAllText(),e.preventDefault()):this.selectEndOfText(),e.stopPropagation(),e.stopImmediatePropagation()}},{key:"handleClickEventOnCloseIcon",value:function(e){this.remove({mouse:!0})}},{key:"handleClickEventOnName",value:function(e){e.stopImmediatePropagation(),e.stopPropagation();var t=ue.get("SearchWatcher").getCurrentContext(),n={value:this.filter.value,unique:{}};if(n.unique[this.filter.name]=!0,t.getFilterNamesBasedOnValue(n).length){this.autofill&&this.autofill.reset().hide(),this._autofill&&(this.$els.$name.focus(),this._autofill.change());var i=ue.get("ViewInstance.SearchBoxContainer");i.hasFocusClass()||i.expandSearch()}}},{key:"handleDoubleClickEvent",value:function(){this.selectAllText()}},{key:"handleInputAndChangeEvent",value:function(e){if(this.filter.nullableOnly)return e.preventDefault(),!1;this.__userInput=!0,this.updateModel(),this.onViewChange()}},{key:"parsePasteContent",value:function(e){return g.isString(e)?e.replace(/\n/g," "):e}},{key:"handlePasteEvent",value:function(e){var t,n=e.originalEvent||e;n.clipboardData?(t=n.clipboardData.getData("text/plain"),document.execCommand("insertText",!1,this.parsePasteContent(t)),e.preventDefault()):window.clipboardData&&(t=window.clipboardData.getData("Text"),t=this.parsePasteContent(t),document.selection.createRange().pasteHTML(t),e.preventDefault())}},{key:"resetAutofill",value:function(){return this.autofill&&this.autofill.reset(),this._autofill&&this._autofill.reset(),this}},{key:"bindAutofill",value:function(){var t=this.filter,e=this.$els,n=this;return t.nullableOnly||(this.autofill=new h({___callingInstance:this,doPaginate:this.paginateAutofill,$for:e.$value,opts:g.jQueryExtend({},this.opts,{from:"bindAutofill"}),$parent:this.$autofillParent,$top:this.$autofillParent,stopInitPagination:this.stopInitPagination,text:t.autofillText.bind(t),dom:t.autofillDOM.bind(t),forElementDebounceTime:t.autofillForElementDebounceTime,selectionStartIndex:t.autofillSelectionIndex,hideOnRemove:!t.removable,removeOnSelect:!1,removeOnEscape:!1,removeOnMouseDown:!1,autoComplete:this.filter.autoComplete,paginator:new u({pageSize:t.autofillPageSize,provider:function(e){return t.getValues(e.query,e)}}),onSelect:function(e){n.__userInput=!1,t.onAutofillSelection(e,n),n.onViewChange(),n.onAutofillSelection(e,n)},onShow:function(){n.listenForUser(),n.onShowingAutofill()},onHide:function(){n.__userInput&&n.updateModel()},ulClass:t.cssAutofillUlClass,wrapperClass:t.cssAutofillWrapperClass}).hide()),this}},{key:"bindNameAutofill",value:function(){var n=this;return!this.filter.nullableOnly&&this.nameAutofill&&(this._autofill=new h({___callingInstance:this,$parent:this.$autofillParent,$top:this.$autofillParent,stopInitPagination:!0,hideOnRemove:!0,opts:{from:"bindNameAutofill"},onHide:function(){n.resetAutofill()},onSelect:function(e){n.resetAutofill(),n.onNameSelect(e,n)},paginator:new u({pageSize:15,provider:function(){var e=ue.get("SearchWatcher").getCurrentContext();if(e){var t={value:n.filter.value,unique:{}};return t.unique[n.filter.name]=!0,e.getFilterNamesBasedOnValue(t)}return[]}})}).hide()),this}},{key:"bindEvents",value:function(){return this.filter.on("change",this.addStateClass).on("remove",this.removeUI),this.$els.$el.on("mousedown",this.handleClickEvent).on("dblclick",this.handleDoubleClickEvent),!this.filter.nullableOnly&&this.nameAutofill&&this.$els.$name.on("mousedown",this.handleClickEventOnName),this.$els.$value&&(this.$els.$value.on("keydown",this.handleKeyEvent).on("paste",this.handlePasteEvent).on("change input",this.handleInputAndChangeEvent),Re&&this.$els.$value.on("focus",this.handleFocus).on("keyup paste input",this.triggerChangeEvent)),this.$els.$close&&this.$els.$close.on("mousedown",this.handleClickEventOnCloseIcon),this}},{key:"unbindEvents",value:function(){return this.filter.off("change",this.addStateClass).off("remove",this.removeUI),this.$els.$el.off("mousedown",this.handleClickEvent).off("dblclick",this.handleDoubleClickEvent),!this.filter.nullableOnly&&this.nameAutofill&&this.$els.$name.off("mousedown",this.handleClickEventOnName),this.$els.$value&&(this.$els.$value.off("keydown",this.handleKeyEvent).off("paste",this.handlePasteEvent).off("change input",this.handleInputAndChangeEvent),Re&&this.$els.$value.off("focus",this.handleFocus).off("keyup paste input",this.triggerChangeEvent)),this.$els.$close&&this.$els.$close.off("mousedown",this.handleClickEventOnCloseIcon),this}},{key:"removeUI",value:function(){return this.unbindEvents(),this.autofill&&this.autofill.remove(),this._autofill&&this._autofill.remove(),this.$els.$el.remove(),this.onRemove(),this}},{key:"remove",value:function(e){return this.filter.removable?(this.beforeRemove(e),this.removeUI().filter.remove(e)):this.hide(),this}}]),t}(),Le=function(){},He=p.require,je=function(){function t(e){if(babelHelpers.classCallCheck(this,t),!(this instanceof t))return new t(e);this.init(e)}return babelHelpers.createClass(t,[{key:"defaults",value:function(){var n=this;return Object.assign({},["onSelect","onUnselect","onAdd","onRemove","beforeRemove","onViewChange","onAutofillSelection","onEnter","onNameClick","onNameSelect"].reduce(function(e,t){return e[t]=n[t]||Le,e},{}),{isCollection:!0,list:[],__bindable:["add","remove","handleViewSelection"],map:{},traverser:new o})}},{key:"bindFunctions",value:function(){return this.__bindable.reduce(function(e,t){return e[t]=e[t].bind(e),e},this)}},{key:"init",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return Object.assign(this,this.defaults(),e),this.traverser.set({list:this.list}),this.bindFunctions().bindEvents()}},{key:"bindEvents",value:function(){this.model.on("add",this.add).on(x,this.onAdd).on("remove",this.remove).on(w,this.onRemove)}},{key:"unbindEvents",value:function(){this.model.off("add",this.add).off(S,this.onAdd).off("remove",this.remove).off(k,this.onRemove)}},{key:"getIndexOf",value:function(e){return this.list.indexOf(e)}},{key:"getViewElement",value:function(e){if(void 0!==e&&e<this.getLength()){var t=this.list[e];if(t)return t.getViewElement()}}},{key:"getViewInstance",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=e.viewClass;if(!n){var i=e.viewClassName;n=He(i)||He("zmail.Search.Views."+i)||Be}return ae(n,{nameAutofill:!0,filter:e,$parent:this.$parent,$before:this.getViewElement(t.position),$autofillParent:this.$autofillParent,onEnter:this.onEnter,onSelect:this.handleViewSelection,onViewChange:this.onViewChange,onAutofillSelection:this.onAutofillSelection,beforeRemove:this.beforeRemove,previous:this.previous,next:this.next,onNameSelect:this.onNameSelect,stopInitPagination:e.stopInitPagination||t.stopInitPagination})}},{key:"getView",value:function(e){return this.map[e]}},{key:"getSelectedView",value:function(){return this.traverser.value()}},{key:"add",value:function(e){var i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return g.isArray(e)||(e=[e]),e.reduce(function(e,t){var n=e.getViewInstance(t,i);return i.disableSelectionOfText||n.selectEndOfText(),e.traverser.add(n),e.map[t.id]=n,e},this)}},{key:"remove",value:function(e){return g.isArray(e)||(e=[e]),e.reduce(function(e,t){var n=e.map[t.id];return n&&(delete e.map[t.id],e.traverser.remove(n)),e},this)}},{key:"getWidth",value:function(){var a;return(this.list||[]).reduce(function(e,t){var n=t.getWidth();if(0<n){var i=t.getTop();i!==a?e=n:e+=n,a=i}return e},0)}},{key:"getLength",value:function(){return this.list.length}},{key:"isEmpty",value:function(){return 0===this.getLength()}},{key:"isSelected",value:function(){return-1!==this.traverser.index}},{key:"isVisible",value:function(){return!this.isEmpty()}},{key:"isAutoFillVisible",value:function(){var e=this.getSelectedView();return e&&e.isAutoFillVisible()}},{key:"isAutoFillSelected",value:function(){var e=this.getSelectedView();return e&&e.isAutoFillSelected()}},{key:"handleViewSelection",value:function(e){var t=this.traverser.value();t!==e&&(this.traverser.setIndexOf(e),t&&t.unselect()),this.onSelect(this)}},{key:"unselectView",value:function(){var e=this.traverser.value();return e&&e.unselect(),this}},{key:"selectView",value:function(e){return(e=this.map[e]||e)&&e.select(),this}},{key:"unselect",value:function(){return this.unselectView().traverser.resetIndex(),this.onUnselect(this),this}},{key:"focusElement",value:function(){var e=this.traverser.value();return e&&e.focusElement()}},{key:"select",value:function(e){return this.unselectView(),this.selectView(this.traverser.traverse(e).value()),this.onSelect(this),this}},{key:"selectAllText",value:function(){var e=this.traverser.value();return e&&e.selectAllText&&e.selectAllText(),this}},{key:"selectEndOfText",value:function(){var e=this.traverser.value();return e&&e.selectEndOfText(),this}},{key:"selectPrevious",value:function(){return this.select(-1)}},{key:"selectNext",value:function(e){return this.select(1)}},{key:"selectFirst",value:function(){return this.selectView(this.traverser.first().value())}},{key:"isFirstSelected",value:function(){return this.traverser.value()===this.list[0]}},{key:"selectLast",value:function(){return this.selectView(this.traverser.last().value())}},{key:"isLastSelected",value:function(){return this.traverser.value()===this.list[this.list.length-1]}},{key:"validateFiltersStateClass",value:function(){(this.list||[]).forEach(function(e,t,n){e.addStateClass()},this)}}]),t}(),Ue={DISPLAY_NONE:{display:"none"}},qe="ZMAIL_MOUSE_DOWN_EVENT",Je="ViewInstance.SearchBox",Ke=function(){},Qe=g.eventPublisher,Ge=function(){function t(e){if(babelHelpers.classCallCheck(this,t),!(this instanceof t))return new t(e);this.init(e)}return babelHelpers.createClass(t,[{key:"defaults",value:function(){return{$parent:c.selector("#ztb-container"),list:[],traverser:new o,__bindable:["handleMouseDownEvent","handleKeyEvent","handleViewSelection","handleExpandCollapse"],handleCloseIconClickEvent:Ke,onMouseDown:Ke}}},{key:"setVisiblity",value:function(e){this.$els.$el.css("visibility",e?"visible":"hidden")}},{key:"setRightPosition",value:function(){return this}},{key:"removeShrinkClass",value:function(){return this.$els.$el.removeClass("zmSRna"),this}},{key:"addShrinkClass",value:function(){return this.$els.$el.addClass("zmSRna"),ue.get(Je).blur(),this}},{key:"hasShrinkClass",value:function(){return this.$els.$el.hasClass("zmSRna")}},{key:"removeFocusClass",value:function(){return this.$els.$el.removeClass("zmSFocus"),this}},{key:"removeActiveClass",value:function(){return this.$els.$el.removeClass("zmSActive"),this}},{key:"hasFocusClass",value:function(){return this.$els.$el.hasClass("zmSFocus")}},{key:"reRenderFilters",value:function(){var i=this.$els.$filters,a=this.$els.$el,s=function(e){var t=e.autofill||e._autofill;t&&t.unbind().unbindEvents().bind().bindEvents()};i&&(i.remove(),setTimeout(function(){var e,t,n;a&&(a.prependDOM(i),e=ue.get(["ViewInstance","FilterCollectionView"].join(".")),t=ue.get(["ViewInstance","SearchBox"].join(".")),n=ue.get(["ViewInstance","ContextFilterView"].join(".")),t.unbindEvents().bindEvents(),s(t),n.unbindEvents().bindEvents(),s(n),e.list.forEach(function(e){e.unbindEvents().bindEvents(),s(e)}))},50))}},{key:"addInlineTransition",value:function(){this.$els.$el.css("opacity","0")}},{key:"removeInlineTransition",value:function(){this.$els.$el.css("opacity","1")}},{key:"flashFocus",value:function(){var e=this;setTimeout(function(){e.$els.$el.addClass("zmSFocus"),e.$els.$wrapperEl.addClass("zmSSOn"),setTimeout(function(){e.$els.$el.removeClass("zmSFocus"),e.$els.$wrapperEl.removeClass("zmSSOn")},100)},100)}},{key:"isItInInitialState",value:function(){return this.$els.$el.hasClass("zmSearch")&&!this.$els.$el.hasClass("zmSActive")&&!this.$els.$el.hasClass("zmSFocus")}},{key:"addTabIndex",value:function(e){return e=void 0===e?"-1":e,this.$els.$el.attr("tabindex",e)}},{key:"removeTabIndex",value:function(){return this.$els.$el.removeAttr("tabindex")}},{key:"setActiveState",value:function(){return(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).disableFlashFocus||this.flashFocus(),this.$els.$el.addClass("zmSActive"),ue.get(Je).blur(),c.blur(document.activeElement),p.onSearchBoxContainerActiveState(),this}},{key:"expandSearch",value:function(){var e=this;return this.$els.$el.hasClass("zmSFocus")||(this.$els.$el.addClass("zmSFocus").addClass("zmSActive"),this.$els.$wrapperEl.addClass("zmSSOn"),p.onSearchExpandWithFocus(),g.eventPublisher("/streams/closePopOut"),g.eventPublisher("/mail/menuCreated",{menuHandler:function(){return e.$els.$el.hasClass("zmSFocus")&&e.handleExpandCollapse()}})),p.onSearchExpand(this),Qe("mailsuite/searchTabIndex/set"),this}},{key:"collapseSearch",value:function(){var e=ue.get("ViewInstance.FilterCollectionView").getLength(),t=ue.get(Je);return this.$els.$el.hasClass("zmSFocus")&&(this.$els.$el.removeClass("zmSFocus"),this.$els.$wrapperEl.removeClass("zmSSOn"),e||""!==t.getText()||(this.$els.$el.removeClass("zmSActive"),"function"==typeof t.autoSize&&t.autoSize()),t.blur(),p.onSearchCollapseWithFocus()),p.onSearchCollapse(this),Qe("mailsuite/searchTabIndex/unset"),this}},{key:"focusElement",value:function(){return this.$els.$el[0]}},{key:"handleExpandCollapse",value:function(e,t,n){if(n)this.expandSearch();else{n=this.traverser.value();var i=this.focusElement(),a=n&&n.focusElement(),s=t&&t.target||e&&e.target;void 0===(s=s||document.activeElement)||s!==a&&s!==i?(this.collapseSearch(),this.unselect()):this.expandSearch()}return this}},{key:"bindFunctions",value:function(){return this.__bindable.reduce(function(e,t){return e[t]=e[t].bind(e),e},this)}},{key:"init",value:function(e){return Object.assign(this,this.defaults(),e),this.traverser.set({list:this.list}),this.bindFunctions().compileTemplate().mount().bindEvents().hideCloseIcon()}},{key:"add",value:function(e){return e.onSelect=this.handleViewSelection,this.traverser.add(e),this}},{key:"compileTemplate",value:function(){var e;return this.$els=(e=zdom("div",{className:"zmSearchWra"},zdom("div",{className:"zmSearch","data-disableshortcuts":"true"},zdom("div",{className:"js-filters zmSBWrapper"},zdom("input",{type:"text",className:"zmSearchTB js-searchbox"})),zdom("i",{className:"msi-plus zmSClear"}),zdom("span",{className:"js-loading zmSpinLoader",style:Ue.DISPLAY_NONE}))),e=c.element(e),p.onSearchBoxContainerCreation(e),{$wrapperEl:e,$el:e.find(".zmSearch"),$filters:e.find(".js-filters"),$searchbox:e.find(".js-searchbox"),$close:e.find(".msi-plus"),$loading:e.find(".js-loading")}),this}},{key:"mount",value:function(){0!==$.q(".zmTopNav").length?$.e(this.$els.$wrapperEl).insertDOMBefore($.q(".zmTopNav")):c.mount(this.$els.$wrapperEl,c.selector(".zmTopBar"));var e=this;return p.onCSSLoad().then(function(){e.setRightPosition()}),this}},{key:"getOffsetWidth",value:function(){return this.$els.$el.outerWidth(!0)}},{key:"getWidth",value:function(n){var e=this.list||[];return n=n||[],e.reduce(function(e,t){return-1===n.indexOf(t)&&(e+=t.getWidth()),e},0)}},{key:"getSelectedView",value:function(){var e=this.traverser.value();return e&&e.isCollection?e.getSelectedView():e}},{key:"isAutoFillVisible",value:function(){var e=this.getSelectedView();return e&&e.isAutoFillVisible()}},{key:"isAutoFillSelected",value:function(){var e=this.getSelectedView();return e&&e.isAutoFillSelected()}},{key:"hasChildren",value:function(){return 0<this.traverser.list.length}},{key:"selectView",value:function(e,t){return!(!e||!e.select||void 0!==e.isVisible&&!e.isVisible())&&(e.select(t),1!==t&&e.selectEndOfText(),!0)}},{key:"unselect",value:function(){var e=this.traverser.value();return e&&e.unselect(),this}},{key:"getView",value:function(e){return this.traverser.traverse(e).value()}},{key:"select",value:function(e){var t=this.traverser.value();if(t&&t.isCollection&&(-1===e&&!t.isFirstSelected()||1===e&&!t.isLastSelected()))return this.selectView(t,e),this;t&&t.unselect();var n=this.traverser.traverse(e).value();return this.hasChildren()&&!this.selectView(n,e)&&this.select(e),this}},{key:"selectAllText",value:function(){var e=this.traverser.value();return e&&e.selectAllText&&e.selectAllText(),this}},{key:"handleKeyEvent",value:function(e){e.keyCode!==I||this.isAutoFillSelected()||(this.select(e.shiftKey?-1:1),e.preventDefault())}},{key:"handleMouseDownEvent",value:function(e){e.shiftKey||this.onMouseDown(),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()}},{key:"showCloseIcon",value:function(){return this.$els.$loading.is(":visible")||this.$els.$close.show(),this}},{key:"hideCloseIcon",value:function(){return this.$els.$close.hide(),this}},{key:"hideLoading",value:function(){return this.$els.$loading.hide(),this}},{key:"showLoading",value:function(){return this.$els.$loading.show(),this.hideCloseIcon()}},{key:"handleViewSelection",value:function(e){var t=this.traverser.value();t!==e&&(this.traverser.setIndexOf(e),t&&t.unselect()),this.handleExpandCollapse(void 0,void 0,e)}},{key:"bindEvents",value:function(){return this.$els.$el.on("keydown",this.handleKeyEvent).on("mousedown",this.handleMouseDownEvent).on("focus blur",this.handleExpandCollapse),this.$els.$close.on("click",this.handleCloseIconClickEvent),g.eventSubscriber(qe,this.handleExpandCollapse),this}},{key:"unbindEvents",value:function(){return this.$els.$el.off("keydown",this.handleKeyEvent).off("mousedown",this.handleMouseDownEvent).off("focus blur",this.handleExpandCollapse),this.$els.$close.off("click",this.handleCloseIconClickEvent),g.eventUnSubscriber(qe,this.handleExpandCollapse),this}}]),t}(),Ye=function(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0];return ue.set("SearchSettings.disableCommandMode",e)},Ze=function(){return Ye(!0)},Xe=function(){return ue.get("SearchSettings.disableCommandMode")},et=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.value?": ":"",n=e.nameClass?e.nameClass:"",i=c.element(zdom("div",null,zdom("span",{className:n},e.name+t)));if(e.value){var a=e.valueClass?e.valueClass:"",s=c.element(zdom("span",{className:a}));c.setText(s,e.value),c.mount(s,i)}return i},tt=g.once(function(){var t=y.Views,n=ue.get("ViewInstance.SearchBox"),e=ue.get("ViewInstance.SearchBoxContainer");n.registerModeHandler($e.COMMANDS,{_autofill:void 0,action:function(e){e.__command&&(y.execute(e.command,e.value),t.reset())},placeholder:function(){var e=ue.get("SearchWatcher").getCurrentContext()||{};return(g.result(e,"placeholder")||"")+(te(e.shortcutId)||"")},autofill:function(){return this._autofill||(this._autofill=new h({___callingInstance:this,forElementDebounceTime:0,$for:n.$el,$parent:e.$els.$el,$top:e.$els.$el,hideOnRemove:!0,opts:{from:"COMMAND_MODE_HANDLER"},selectionStartIndex:0,onSelect:function(e){n.delegate("default",e)},text:function(e,t){return e.description},paginator:new u({pageSize:10,provider:function(e){var t=C.infer(e.query);return y.getCommandsBasedOnTypes(t).concat(y.get(e.query||""))}}),dom:function(e){if(y.isSerializedCommand(e))return et({name:e.description,value:e.displayValue})}}).unbind()),this._autofill}})}),nt=function(e){var n=c.element(zdom("div",null)),i=e.length-1;return e.forEach(function(e,t){c.mount(function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.value?": ":"",n=e.nameClass?e.nameClass:"greyText",i=c.element(zdom("span",{key:e.name+t},zdom("span",{className:n},e.name+t)));if(e.value){var a=e.valueClass?e.valueClass:"",s=c.element(zdom("span",{className:a}));s.text(e.value),c.mount(s,i)}return i}(e),n),t!==i&&c.mount(zdom("span",{className:"greyText"},", "),n)}),n},it=g.once(function(){var f=ue.get("ViewInstance.SearchBox"),e=ue.get("ViewInstance.SearchBoxContainer"),v=ue.get("ViewInstance.ContextFilterView"),m=ue.get("ViewInstance.FilterCollectionView"),n=ue.get("System"),i=function(){var e=[],t=function(){var e=Ve.getCurrentContext();if(e){var t=e.prioritizedFilterClass;return(t=g.isEmpty(t)?e.filterClass.slice(0,3):t).map(function(e){return{name:e.name,value:e.getDefaultValue()}})}return[]}();t.length&&(e.push({templateType:"separator"}),(e=e.concat(t)).push({templateType:"moreFilters",str:String(p.getI18n("more")+"...")}));var n,i=(n=Ve.getCurrentContext())?(n.history||[]).slice(0,10).map(function(e){return{type:"history",value:e}}):[];return 0<i.length&&(e.push({templateType:"separator"}),e.push({templateType:"header",str:p.getI18n("history")}),e=e.concat(i)),e},a=function(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i=Ve.getCurrentContext(),a=[],s=[],l=[],r=[],o=[];if(i){var u=e.query||"";if(function(t){var e=Ve.getCurrentContext();if(e&&0<=t.indexOf(":")&&(t=t.replace(":",""),e.getFilterNamesList().filter(function(e){return e===t})[0]))return!0;return!1}(u=u.trim())){var c=t=(t=u.toLowerCase().split(":"))&&t[0]||void 0,h=i.createFilter({name:c});return be.add(h),v.setValueBasedOnModel(),g.defer(function(){m.selectView(h.id)}),f.setPlaceholder().clearText().autoSize(),[]}a=i.applyRules(i.getFilterNames(u));var d=C.infer(u);return s=i.applyRules(i.getFilterValues(d)),be.isEmpty()&&Xe()&&(o=(o=y.getCommandsBasedOnTypes(d)).concat(y.get(u).slice(0,5))).length&&(o.unshift({templateType:"header",str:p.getI18n("quickAccess")}),(a.length||s.length)&&o.unshift({templateType:"separator"}),a=a.slice(0,5),s=s.slice(0,15)),a.length&&s.length&&s.unshift({templateType:"separator"}),n.showFilters&&r.push({templateType:"lessFilters",str:String(p.getI18n("less")+"...")}),l=l.concat(a,s,o,r)}return[]};f.registerModeHandler($e.SEARCH,{_autofill:void 0,action:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{value:f.getText()};if("history"===e.type)Ve.getCurrentContext().reset(),n.newSearch(e.value.map(function(e){return{className:e.className,value:e.actualValue}}),{disableSearchContainerFocus:!0}),setTimeout(function(){return f.select()});else{if(y.isSerializedCommand(e))return Ve.setUserChangedContext(!1),y.execute(e.command,e.value),void f.clearText().autoSize();if(g.isString(e)||e.value||e.name||e.className){var t=Ve.getCurrentContext().createFilter(e);be.add(t,e),v.setValueBasedOnModel(),g.defer(function(){t.nullableOnly||e.value?f.select():m.selectView(t.id)})}else e&&(e.value||e.name||e.className)||Ve.forceSearch()}f.setPlaceholder().clearText().autoSize()},placeholder:function(){return be.isEmpty()&&ne()||""},autofill:function(){return this._autofill||(this._autofill=new h({___callingInstance:this,forElementDebounceTime:0,$for:f.$el,$parent:e.$els.$el,$top:e.$els.$el,hideOnRemove:!0,opts:{from:"SEARCH_MODE_HANDLER"},onSelect:function(e){f.delegate("default",e)},ignoreMouseDownEvent:f.ignoreMouseDownEvent,paginator:new u({pageSize:15,provider:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return e.query||!be.isEmpty()||"more"===t.showFilters?a(e,t):i()}}),dom:function(e,t){if(e.templateType)return e;if(y.isSerializedCommand(e))return et({name:e.description,value:e.displayValue});if("history"===e.type){var n=e.value.slice();return n.unshift({name:p.getI18n("filters.in"),value:Ve.getCurrentContext().contextName}),nt(n)}var i=Ve.getCurrentContext().serializedFilterJSON(e,t);return i?(i.value?i.nameClass="greyText":(i.value=i.description,i.valueClass="greyText"),et(i)):void 0}}).unbind()),this._autofill}})}),at={},st=y.Views,lt=g.eventSubscriber,rt=g.eventPublisher;ue.set("System",at);var ot,ut,ct,ht,dt,ft,vt,mt=/zm-settings|settings/i;at.addToSearch=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};g.isArray(e)||(e=[e]);var n=he.value,i=function(){Ie.mode=$e.SEARCH,Ve.getCurrentContext().reset(),t.newSearch&&be.remove(),t.stopInitPagination=t.stopInitPagination||!0,be.add(e.reduce(function(e,t){return e.push(n.createFilter(t)),e},[]),t),t.disableAutofill=t.disableAutofill||!0,t.disableSearchBoxFocus=t.disableSearchBoxFocus||!0,t.disableFlashFocus=t.disableFlashFocus||!1,at.focusSearchBox(t),t.disableSearchContainerFocus||at.focusSearchContainer(t),at.setTraverserIndexToLastFilter(t),p.onAddToSearch(),t.addShrinkClass&&setTimeout(function(){ut(void 0,{mode:"add"})}),setTimeout(function(){at.blurSearchBox(),t.disableSearchBoxFocus&&setTimeout(function(){return $.e(document.activeElement).blur()},300)})};"pending"===n.dependencyPromise.state()?n.dependencyPromise.then(i,function(){throw arguments}):i()},at.newSearch=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};t.newSearch=!0,at.addToSearch(e,t)},at.setTraverserIndexToLastFilter=function(){var e=ht.traverser;e.index=1,e.list[1].traverser.index=e.list[1].traverser.list.length-1},at.focusSearchContainer=function(e){ht.setActiveState(e)},at.focusSearchBox=function(e){Ie.mode=$e.SEARCH,g.defer(function(){return ct.select(e)})},at.focusCommandBox=function(e){Ie.mode=$e.COMMANDS,g.defer(function(){return ct.select(e)})},at.blurSearchBox=function(e){ct.blur(e)},at.reRenderFilters=function(e){ht.reRenderFilters(e)},at.disableCommandModeSetting=function(){return Ye(!1)},at.enableCommandModeSetting=Ze,at.getCommandModeSetting=Xe,Ze();var gt=function(e){return e.map(function(e){return[e.name,e.value].join(":")}).join("::")},pt=function(){},yt=function(){function t(e){if(babelHelpers.classCallCheck(this,t),!(this instanceof t))return new t(e);Object.assign(this,this.defaults()),this.init(e)}return babelHelpers.createClass(t,[{key:"defaults",value:function(){var n=this;return Object.assign({},["onReset","beforeSearch","beforePaginate","afterSearch","afterPaginate","onAdd","onChange","onRemove"].reduce(function(e,t){return e[t]=n[t]||pt,e},{}),{onAccountSwitch:this.onAccountSwitch||pt,dependencyPromise:g.jQueryDeferred(),contextName:void 0,contextIcon:void 0,defaultFilterClass:void 0,filterClass:[],prioritizedFilterClass:[],names:[],filterNamesWithDefaultValues:[],classNames:[],classes:[],classMap:{},classNameMap:{},valueTypeMap:new d,history:[],url:void 0,requestMethod:"post",tabRegexp:void 0,placeholder:"",pageNo:0,pageSize:20,paginationRequestSent:!1,queryHash:void 0,searchOnFilterAdd:!0,searchOnFilterRemove:!0,searchOnFilterChange:!0,showLoadingBandOnRequest:!0})}},{key:"init",value:function(e){return Object.assign(this,e),this.afterRequest=this.afterRequest.bind(this),this.registerFilterClasses(this.filterClass).afterInit(),this}},{key:"addHistory",value:function(e){var t=gt(e),n={};if(this.history.forEach(function(e,t){n[gt(e)]=t}),t in n){var i=n[t];this.history.splice(i,1)}return this.history.unshift(e),this}},{key:"isDependencyLoaded",value:function(){return"resolved"===this.dependencyPromise.state()}},{key:"registerFilterClasses",value:function(e){return(e=e||[]).reduce(function(e,t){var n=ae(t).toJSON();return e.names.push(n.name),e.classNames.push(n.className),e.emailSuggestionNamesIndex=e.emailSuggestionNamesIndex||[],n.suggestForEmailQuery&&e.emailSuggestionNamesIndex.push(n.name),e.classNameMap[n.name.toLowerCase()]=n.className,e.classMap[n.name.toLowerCase()]=t,e.classMap[n.name]=t,e.classMap[n.className.toLowerCase()]=t,e.classMap[n.className]=t,e.classes.push(t),t.valueType&&e.valueTypeMap.add(t.valueType,t),t.allowFilterNameDefaultValue&&e.filterNamesWithDefaultValues.push(n.name),e},this)}},{key:"getFilterValues",value:function(i){var a=this;return l.reduce(function(e,t){var n=i[t];return n?e.concat(a.valueTypeMap.get(t).reduce(function(e,t){return t.validateValueType&&!t.validate(n)||e.push({className:t.name,value:n}),e},[])):e},[])}},{key:"serializedFilterJSON",value:function(e,t){g.isString(e)&&(e={className:e});var n,i=e.className||e.name,a=this.classMap[i],s="";return a&&(e.value?n=a.autofillText(e.value,t):t&&g.isEmpty(t.query)&&(n=(n=a.getDefaultValue())&&a.autofillText(n,t)),s=a.description),{name:i,value:n,description:s}}},{key:"getDescription",value:function(e){if(g.isString(e))return(this.classMap[e.toLowerCase()]||{}).description}},{key:"afterInit",value:function(){}},{key:"getFilterClassNames",value:function(){return this.classNames}},{key:"getFilterClass",value:function(e){return e=e.toLowerCase(),this.classMap[e]}},{key:"getFilterNamesBasedOnValue",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=e.value,i=e.unique||{};return n?this.applyRules(this.classes.reduce(function(e,t){return t.nullableOnly||t.name in i||!t.validate(n)||(i[t.name]=!0,e.push(t.name)),e},[])):[]}},{key:"getFilterNamesList",value:function(){return this.names}},{key:"getDefaultFilterNameValue",value:function(e){var t=this.filterNamesWithDefaultValues.indexOf(e),n=this.classMap[e];return 0<=t?{name:n.name,value:n.getDefaultValue()}:void 0}},{key:"getFilterNames",value:function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",n=[],i=!1;(t=t.toLowerCase())&&(e=new RegExp("\\s+"+W(t),"i"),i=B(t)||{});for(var a,s,l,r,o=0,u=this.names.length;u;)s=a=this.names[o],a=a.toLowerCase(),l=this.getDefaultFilterNameValue(s),(r=0===a.indexOf(t)||i.status&&-1<this.emailSuggestionNamesIndex.indexOf(a)||0===t.indexOf(a)||e&&a.match(e))&&l?n.push(l):r&&n.push(s),--u,++o;return n}},{key:"applyRules",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],s=this;return e.filter(function(e){var t=e;g.isString(e)||(t=e.name||e.className),t=t.toLowerCase();var n=s.getFilterClass(t);if(!n)return!1;if(!1===n.multipleInstance&&be.has(n.className))return!1;var i=!0,a=function(e){if(be.has(e.className)){if("value"in e&&!g.isEmpty(e.value)){var t=be.get(e.className)[0];return g.isArray(e.value)?g.underscoreJSWrapper(e.value).contains(t.value):t.value===e.value}return!0}};return g.isEmpty(n.autofillNotAfter)||(i=!g.underscoreJSWrapper(n.autofillNotAfter)[n.autofillNotAfterOperator](a)),i&&!g.isEmpty(n.autofillOnlyAfter)&&(i=g.underscoreJSWrapper(n.autofillOnlyAfter)[[n.autofillOnlyAfterOperator]](a)),i})}},{key:"createFilter",value:function(e,t){g.isObject(e)&&(e=(t=e).className||t.name,delete t.className,delete t.name,delete t.description),e=(e||"").toLowerCase();var n=this.classMap[e]||this.defaultFilterClass;return ae(n,t)}},{key:"getUrl",value:function(){return g.isFunction(this.url)?this.url():this.url}},{key:"ajax",value:function(e){return g.BackboneAjax({type:this.requestMethod,url:this.getUrl(),data:e})}},{key:"beforeRequest",value:function(t){var n=this;if(t.paginate)this.beforePaginate();else{this.beforeSearch();var e=ue.get("SearchWatcher").getPreviousContext();if(e){var i=e.getFrameworkInstance();i&&i.isTabOpen()&&i.closeWorkspace()}}if(this.showLoadingBandOnRequest){var a=function(){var e=n.getFrameworkInstance();g.eventPublisher(b,e),e.isWorkspaceAlreadyShown()||e.showWorkSpace(),e.addLoadingBand(t.paginate)};"pending"===this.dependencyPromise.state()?this.dependencyPromise.then(a):a()}}},{key:"afterRequest",value:function(e,t){e.paginate?this.afterPaginate(e,t):this.afterSearch(e,t)}},{key:"isHashChanged",value:function(e){return!g.isEmpty(e)&&e!==this.queryHash}},{key:"hash",value:function(n){return g.isEmpty(n)||g.isString(n)?n:g.isObject(n)?g.underscoreJSWrapper(n).keys().sort().reduce(function(e,t){return e.push([t,JSON.stringify(n[t])].join(":")),e},[]).join("::"):void 0}},{key:"sendRequest",value:function(){var n=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},i=g.jQueryDeferred(),e=this.searchQuery(t),a=this.hash(e);return e&&(t.forceSearch||t.paginate||this.isHashChanged(a))?(t.paginate||(this.paginationRequestSent=!1),this.queryHash=a,t.envHash=be.hash(),this.beforeRequest(t),this.ajax(e).always(function(e){var t=function(){return n.getFrameworkInstance().removeLoadingBand()};"pending"===n.dependencyPromise.state()?n.dependencyPromise.then(t):t()}).then(function(e){be.isHashChanged(t.envHash)?i.reject():(n.afterRequest(t,e),i.resolve(e))},i.reject),i.promise()):i.reject().promise()}},{key:"search",value:function(t){var n=this;return this.sendRequest(t).then(function(e){n.addHistory(t.data),t.response=e,n.mountView(t),n.getFrameworkInstance().customScrollTrigger()},function(){be.isEmpty()&&n.closeWorkspace()})}},{key:"paginate",value:function(e){var t=this;return!this.paginationRequestSent&&this.hasPagination()?(this.pageNo+=1,e.paginate=!0,e.pageNo=this.pageNo,e.pageSize=this.pageSize,this.paginationRequestSent=!0,this.search(e).always(function(){t.paginationRequestSent=!1})):$.Deferred().reject().promise()}},{key:"mountView",value:function(n){var i=this,a=this.getFrameworkInstance();this.dependencyPromise.then(function(){a.showWorkSpace();var e=a.getListingCenterDOM();n.paginate||(i.resetPage(),e.empty());var t=i.getView(n);c.mount(t,e)},function(){throw arguments})}},{key:"searchQuery",value:function(e){return e.data}},{key:"parseHistory",value:function(e){return e}},{key:"getView",value:function(){}},{key:"hasPagination",value:function(){}},{key:"getFrameworkInstance",value:function(){return void 0===this.frameworkInstance&&(this.frameworkInstance=new z({contextID:this.contextID})),this.frameworkInstance}},{key:"active",value:function(){this.dependencyPromise.resolve()}},{key:"inactive",value:function(){this.reset()}},{key:"resetPage",value:function(){this.pageNo=0}},{key:"closeWorkspace",value:function(){var e=this.getFrameworkInstance();return e&&e.closeWorkspace(),this}},{key:"reset",value:function(){this.resetPage(),this.paginationRequestSent=!1,this.queryHash=void 0,this.onReset()}}]),t}(),Ct=g.once(function(){c.selector("#zm-search").remove(),p.searchDependencyLoader().then(function(){Ve.init(),function(){ht=new Ge({handleCloseIconClickEvent:function(e){be.remove(void 0,{retainWorkspace:!0,clearAllFilters:!0}),ct.clearText(),ht.removeFocusClass().removeShrinkClass().removeActiveClass().addShrinkClass().hideCloseIcon(),e.shiftKey||ct.select({onThen:ct.resetAutofill})},onMouseDown:function(){ct.focus()}}),ct=new Me({$el:ht.$els.$searchbox,$leftParent:ht.$els.$searchbox,$topParent:ht.$els.$el,maxWidth:ht.$els.$el.width()-50,next:function(){ht.select(1)},previous:function(){ht.select(-1)},parser:function(e){},autoSize:function(){return this.resize()},onBackspace:function(){be.isEmpty()||ht.select(-1).selectAllText()},onChange:function(){this.isEmpty()&&be.isEmpty()?ht.hideCloseIcon():ht.showCloseIcon()}}),ue.set("ViewInstance.SearchBoxContainer",ht),ue.set("ViewInstance.SearchBox",ct),g.eventPublisher("/search/constructview/init",{SearchBoxContainer:ht,SearchBox:ct}),st.init(),ft=new Be({$autofillParent:ht.$els.$el,filter:he,$parent:ht.$els.$filters,opts:{isContextFilter:!0},onShow:ct.autoSize,paginateAutofill:!1,handleNavigation:function(e){ht.select(e)},onAutofillSelection:function(){g.defer(function(){return ct.select()}),Ie.mode===$e.COMMANDS&&g.defer(function(){return ct.focus()})},onShowingAutofill:function(){this.autofill&&this.autofill.traverser.setIndexOf(Ve.getCurrentContext())},select:function(){return this.$els.$el.addClass(this.filter.cssSelectionClass),this.$els.$value&&this.$els.$value.focus(),this.autofill.change(""),this.onSelect(this),this},setValue:function(e){return this.$els.$name&&e&&this.$els.$name.text(e),this},isAutoFillSelected:function(){return!1},addTabIndex:function(e){return e=void 0===e?"-1":e,this.$els&&this.$els.$el.attr("tabindex",e)},removeTabIndex:function(){return this.$els&&this.$els.$el.removeAttr("tabindex")},compileTemplate:function(){var e=this.filter.toJSON(),t=zdom("span",{className:"zmSearchAppSwitch","data-disableshortcuts":"true"},zdom("i",{className:"msi-search"}),zdom("span",{className:"js-fname"}),zdom("i",{className:"msi-barrow"})),n=(t=c.element(t)).find(".js-fname");return n.text(e.value||""),this.$els={$el:t,$name:n,$value:t},this}}).setValueBasedOnModel(),ue.set("ViewInstance.ContextFilterView",ft),dt=new je({model:be,$parent:ht.$els.$filters,$autofillParent:ht.$els.$el,onViewChange:ct.autoSize,next:function(){ht.select(1)},previous:function(){ht.select(-1)},onEnter:function(){ct.setPlaceholder().resetAutofill().focus(),Ve.forceSearch()},onAutofillSelection:function(){ct.setPlaceholder().resetAutofill().focus()},onAdd:function(){ft.setValueBasedOnModel(),ht.showCloseIcon(),ct.autoSize().resetAutofill().setPlaceholder()},onRemove:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};ct.setPlaceholder().autoSize().resetAutofill(),dt.isEmpty()&&(t.clearAllFilters||ct.select({onThen:ct.resetAutofill}),ht.hideLoading(),ct.isEmpty()&&ht.hideCloseIcon(),Ve.userChangedContext(),t.retainWorkspace||Ve.getCurrentContext().closeWorkspace())},beforeRemove:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};e.mouse?ct.focus():e.backspaceKey&&1===be.getLength()?at.setTraverserIndexToLastFilter():ht.select(-1).selectAllText()},onNameSelect:function(e,t){var n=Ve.getCurrentContext().createFilter({name:g.isObject(e)?e.className||e.name:e,value:t.filter.value}),i=dt.getIndexOf(t);t.remove({silent:!0}),be.add(n,{position:i}),g.defer(function(){dt.getView(n.id).selectAllText().select()})}}),ue.set("ViewInstance.FilterCollectionView",dt),ht.add(ft).add(dt).add(ct),he.on("change",function(e){e.__isCommand?Ie.mode=$e.COMMANDS:Ie.mode=$e.SEARCH,ft.setValueBasedOnModel(),ct.setPlaceholder().resetAutofill().autoSize()}),ct.registerStringHandler("default",{isSafe:!0,action:function(e){var t=ct.modeHandlers[Ie.mode];t&&g.isFunction(t.action)&&t.action(e)}}),it(),tt(),vt=function(e){mt.test(e)&&be.isEmpty()?Ie.mode=$e.COMMANDS:Ve.getCurrentContext()&&!Ve.getCurrentContext().__isCommand&&(Ie.mode=$e.SEARCH)},lt("/apps/tabSwitched",function(){vt(p.getCurrentTab())}),lt("mailsuite/appOpened",function(e,t){vt(t)});ot=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};ht&&ht.expandSearch(),t.context&&de(t.context),Ie.mode===$e.COMMANDS?at.focusCommandBox(t):at.focusSearchBox(t)},lt("mailsuite/searchTabIndex/set",function(){ht&&ht.addTabIndex(),ft&&ft.addTabIndex()}),lt("mailsuite/searchTabIndex/unset",function(){ht&&ht.removeTabIndex(),ft&&ft.removeTabIndex()}),lt("mailsuite/searchOpen",ot),lt("mailsuite/searchClose",function(e){ht&&ht.collapseSearch()}),lt("mailsuite/searchClear",function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};be.remove(void 0,t),ct.clearText().resetAutofill().select({disableSearchBoxFocus:!0,disableAutofill:!0}),t.blur&&ct.blur(),ht.hideCloseIcon(),p.onSearchClear()}),lt("mailsuite/searchShrink",ut=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=ht.hasShrinkClass();"remove"===t.mode&&n?ht.removeShrinkClass():n||ht.addShrinkClass(),p.onSearchShrink({SearchBoxContainer:ht,mode:t.mode})}),lt("mailsuite/updatePlaceholder",function(e){return ct.setPlaceholder()}),Ie.mode=$e.SEARCH,ct.handleModeChange(),rt(f)}(),p.getCSSDeferred().then(function(){p.isInitialSearchBoxResizeAllowed()&&ue.get("ViewInstance.SearchBox").calculateMaxWidth().autoSize(),$.e(document.activeElement).blur()}),$.e(document.activeElement).blur()})}),St=p.DatePicker,kt=se(Be,{isFilterNonEditable:!0,afterInit:function(){this.bindDatePicker()},bindDatePicker:function(){var e=this;this.picker=St.create({$el:this.$els.$value,type:"date",dateFormat:p.getUserDateFormat().toUpperCase(),range:this.filter.range,events:[{name:"dateclick",callback:function(){e.filter.set(this.getDate()),e.setValue(e.filter.getValue()).selectEndOfText().addStateClass().onViewChange(),e.onAutofillSelection()}}]});var t=this.$els.$value[0];return t.value="",this.picker._refer=t,St.bind(this.picker),this},showPicker:function(){this.picker||this.bindDatePicker(),this.$els.$value.trigger("mousedown")},hidePicker:function(){return this.picker&&(St.remove(this.picker),this.picker=void 0),this}}),bt=se(Be,{updateModel:function(){return this.filter.set(this.getValue(),{silent:!0}),this.addStateClass(),this}}),xt=zmail.Core.Namespaces.create("zmail.Search"),wt={CommonUtil:{escapeRegExp:W,isValidEmail:B,isStartsWith:L,getUniqueId:H,selectEndOfNode:j,selectAllText:U,getCaretPosition:q},ShortcutUtil:{getShortcutOf:X,decodeShortcut:ee,handleIfShortcut:function(e){if((i=e)&&("keydown"===i.type||"keyup"===i.type||"keypress"===i.type)){var t=!1,n=e.keyCode||e.which;J.pop()!==K&&n!==K||(t=!0),J.push(n),t&&p.handleShortcutEvent(e,{tempIncludeEventHandling:!0})}var i},getShortcutPlaceholderText:te,getDefaultShortcutPlaceholderText:ne},TypeCreator:{newType:se}},$t={Framework:z},Et={BaseFilter:oe,ContextFilter:he,ContactFilter:me,StringFilter:fe,NumberFilter:ge,DateFilter:pe,FromDateFilter:Ce,ToDateFilter:Se},It={SearchContext:yt},Ft={DateFilter:kt,StringFilter:bt,Filter:Be};Ie.MODES=$e,Object.assign(xt,at,{registerContext:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(p.isSearchContextAllowed(e,t)&&(he.values.push(e),he.reOrderContexts(),!t.silent)){var n=ue.get("Environment"),i=ue.get("ViewInstance.SearchBox");n&&n.isEmpty()&&i&&i.isEmpty()&&he.setValueBasedOnTab()}},getContext:function(e){return he.getContextOf(e)},setContext:de,init:Ct,ModeKeeper:Ie,SearchWatcher:Ve,Environment:be,Integrators:$t,Models:{Filters:Et,Contexts:It},Utils:wt,Views:Ft}),g.eventSubscriber("/search/constructview/init",function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};xt.ViewInstance=t})}(),window.__rollupModule=void 0;
//$Id$
/**
 * IMPORTANT NOTE: This compressed javascript includes thirdparty javascripts
 * listed at http://video.zoho.com/html/thirdparty.html
 * The original javascript sources are available in the above location.
 */
function VideoChatUtil(){}function WMSTP(){}function NetworkAPI(){}function VideoChatWebRTC(videoChatDivId){this.zuid=!1,this.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,this.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,this.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,this.peerConnectionInfoList=new Array,this.activeConnectionId=!1,this.chatAnswered=!1,this.renegotiatingUser=!1,this.isPreviousPeerConnectionInfoListCleared=!1,this.reconnectionTime=0,this.reconnectionId=0,this.processedReconnectionIdList=new Array,this.webrtcFailed=!1,this.audioCtx=!1,this.sourceNode=!1,this.scriptNode=!1,this.destNode=!1,this.remoteSourceNode=!1,this.remoteAnalyser=!1,this.remoteFrequency="",this.currentRemoteFrequency=0,this.videoChatAPI=VideoChatContainer.getVideoChatAPI(videoChatDivId),this.videoChatDiv=Drizzle("[id="+videoChatDivId+"]")[0],this.reconnectionState=!1,this.processedMsgIdList=new Array,this.disconnectNotifyTimer=!1,this.remoteVideoEnabled=!1,this.packetInfoPromiseRejected=!1,this.currentParticipant=this.videoChatAPI.currentParticipant,this.peerConnectionPacketsInfo=new Array,this.remoteUserAgent=!1,this.isOffer=!1,this.remoteDevice={},this.isSpeakerOff=!1}function VideoChatAPI(videoChatDivId){this.sessionId=!1,this.callingZuid=!1,this.calledZuid=!1,this.type=!1,this.waitingsound=!1,this.endsound=!1,this.feedbacksound=!1,this.disconnectsound=!1,this.REQUESTCHAT_TIMEOUT_FUNC=!1,this.chatStarted=!1,this.chatAnswered=!1,this.videoChatDivId=videoChatDivId,this.videoChatDiv=Drizzle("[id="+videoChatDivId+"]")[0],this.otherServiceProps=!1,this.videoChatHandler=!1,this.localMicStatus=1,this.localCameraStatus=1,this.chatLogs=!1,this.isVideoEnabled=!1,this.isScreenEnabled=!1,this.appName=!1,this.addingMode=!1,this.remoteParticipants=new Array,this.currentParticipant=!1,this.contacts=null,this.orgUsers=null,this.connectedParticipants=new Array,this.ownerZuid=!1,this.groupChatEnabled=!1}function VideoChatScreenShare(videoChatDivId){this.zuid=!1,this.peerConnectionInfo={},this.videoChatAPI=VideoChatContainer.getVideoChatAPI(videoChatDivId),this.RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,this.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,this.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,this.firstScreenShareUser=!1,this.processedMsgIdList=new Array,this.renegotiatingUser=!1,this.remoteScreenStream=!1,this.reconnectionId=0,this.reconnectionTime=0,this.reconnectionState=!1,this.processedReconnectionIdList=new Array,this.disconnectNotifyTimer=!1,this.isPreviousPeerConnectionInfoCleared=!1,this.removeScreenSharePending=!1,this.currentParticipant=this.videoChatAPI.currentParticipant,this.sender=!1,this.remoteUserScreenEnabledTimes=0}function VideoChatLocalParticipant(videoChatDivId){this.zuid=!1,this.username=!1,this.photoURL=!1,this.iceServers=!1,this.permissionPending=!1,this.permissionState=!1,this.constraints=!1,navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia,this.localStream=!1,this.localAudioCtx=!1,this.localSourceNode=!1,this.localDestNode=!1,this.localAnalyser=!1,this.localFrequency="",this.currentLocalFrequency=0,this.isExtAvailable=!1,this.sourceId=!1,this.screenCallback=!1,this.chromeExtensionAvailable=!1,this.localScreenStream=!1,this.handler=!1,this.screenShareAvailable=!1,this.screenIceServers=!1,this.extCheckCount=0,this.isMonitoring=!1,this.inBuildChromeScreenAPI=!1,this.videoChatAPI=VideoChatContainer.getVideoChatAPI(videoChatDivId),this.localUserScreenEnabledTimes=0}function VideoChatRemoteParticipant(videoChatDivId){this.zuid=!1,this.username=!1,this.photoURL=!1,this.chatRunningTime=!1,this.updateRunningTimeStarted=!1,this.localConnected=!1,this.remoteConnected=!1,this.fromDevice=!1,this.chatReceived=!1,this.chatAnswered=!1,this.switchMode=!1,this.screenMode=!1,this.connectionId=!1,this.remoteMicStatus=1,this.remoteHoldStatus=0,this.remoteCameraStatus=1,this.videoChatAPI=VideoChatContainer.getVideoChatAPI(videoChatDivId),this.videoChatWebRTC=!1,this.videoChatScreenShare=!1,this.videoChatWebRTC=new VideoChatWebRTC(videoChatDivId),this.videoChatScreenShare=new VideoChatScreenShare(videoChatDivId),"video"!=this.videoChatAPI.getChatType()&&(this.remoteCameraStatus=0)}!function(){var objPattExpr=/^\[(id|name|tag|class)=([\w\-\$]*)\]$/,Drizzle=function(selector,context){return new Drizzle.prototype.init(selector,context)};Drizzle.helper={findEach:function(element,attributeName,name,elements){var nodes,i;for(element.getAttribute(attributeName)===name&&elements.push(element),nodes=element.childNodes,i=0;i<nodes.length;i++)1===nodes[i].nodeType&&Drizzle.helper.findEach(nodes[i],attributeName,name,elements)},trim:function(value){return value.replace(/^\s+|\s+$/g,"")},getEventHandler:function(elem,type){var eventObj,i;for(i=0;i<Drizzle.events.length;i++)if(eventObj=Drizzle.events[i],eventObj.target===elem&&eventObj.type===type)return eventObj;return{}},eventDispatch:function(event){var eventObj,fn,i;if(event||(event=window.event),eventObj=Drizzle.helper.getEventHandler(this,event.type),eventObj.func)for(i=0;i<eventObj.func.length;i++)fn=eventObj.func[i],fn.apply(this,arguments)},attachEvent:function(elem,type,eventHandle){elem.addEventListener?elem.addEventListener(type,eventHandle,!1):elem.attachEvent&&elem.attachEvent("on"+type,eventHandle)},removeEvent:function(elem,type,eventHandle){elem.removeEventListener?elem.removeEventListener(type,eventHandle,!1):elem.detachEvent&&elem.detachEvent("on"+type,eventHandle)},indexOf:function(arr,element){var i;for(i=0;i<arr.length;i++)if(arr[i]===element)return i;return-1},findHeightAndWidth:function(obj,name){var ret,displayProp,key,elem,old={};if(0==obj.length)return 0;if(elem=obj[0],elem===document){var body=elem.body,docElement=elem.documentElement;return ret="Width"===name?Math.max(body.scrollWidth,docElement.scrollWidth,body.offsetWidth,docElement.offsetWidth,body.clientWidth,docElement.clientWidth):Math.max(body.scrollHeight,docElement.scrollHeight,body.offsetHeight,docElement.offsetHeight,body.clientHeight,docElement.clientHeight)}if(elem===window)return ret="BackCompat"===document.compatMode?elem.document.body["client"+name]:elem.document.documentElement["client"+name];displayProp=obj.css("display"),"none"==displayProp&&(old.visibility=elem.style.visibility,old.display=elem.style.display,elem.style.visibility="hidden",elem.style.display="block"),ret="Width"===name?elem.offsetWidth:elem.offsetHeight;for(key in old)elem.style[key]=old[key];return ret}},Drizzle.prototype={length:0,cssNumber:{left:!0,right:!0,top:!0,bottom:!0,width:!0,height:!0},init:function(selector,context){var match,elem,i,elements;if(!selector)return this;if(selector==document||selector==window||selector==document.body)return this.length=1,this[0]=selector,this;if(selector.constructor===Array){for(this.length=selector.length,i=0;i<selector.length;i++)this[i]=selector[i];return this}if(selector.nodeType&&1===selector.nodeType)return this.length=1,this[0]=selector,this;if("string"!=typeof selector)return this;if(match=objPattExpr.exec(selector),!match)return this;if(context||(context=document),"id"===match[1])if(context.getElementById)elem=context.getElementById(match[2]),elem&&elem.parentNode&&(this.length=1,this[0]=elem);else for(elements=new Array,Drizzle.helper.findEach(context,match[1],match[2],elements),this.length=elements.length,i=0;i<elements.length;i++)this[i]=elements[i];else if("name"===match[1])if(context.getElementsByName)for(elem=context.getElementsByName(match[2]),this.length=elem.length,i=0;i<elem.length;i++)this[i]=elem[i];else for(elements=new Array,Drizzle.helper.findEach(context,match[1],match[2],elements),this.length=elements.length,i=0;i<elements.length;i++)this[i]=elements[i];else if("tag"===match[1])for(elem=context.getElementsByTagName(match[2]),this.length=elem.length,i=0;i<elem.length;i++)this[i]=elem[i];else if("class"===match[1])for(elem=context.getElementsByClassName(match[2]),this.length=elem.length,i=0;i<elem.length;i++)this[i]=elem[i]},find:function(selector){return new Drizzle.prototype.init(selector,this[0])},css:function(cssObject){var i,style,name,value,type,obj;if("string"==typeof cssObject){var styleProp;return this[0]?(window.getComputedStyle?styleProp=window.getComputedStyle(this[0],null):document.documentElement.currentStyle&&(styleProp=this[0].currentStyle),value=styleProp[cssObject],(null==value||""==value)&&(value=this[0].style[cssObject]),""===value?"auto":value):this[0]}for(i=0;i<this.length;i++){style=this[i].style;for(obj in cssObject){name=obj,value=cssObject[name],type=typeof value,"number"===type&&this.cssNumber[name]&&(value+="px");try{style[name]=value}catch(e){}}}return this},addClass:function(value){var i,elem,searchClass;if(value&&"string"==typeof value)for(i=0;i<this.length;i++)elem=this[i],1===elem.nodeType&&(elem.className?(searchClass=" "+elem.className+" ",searchClass.indexOf(" "+value+" ")<0&&(elem.className+=" "+value+" ")):elem.className=value);return this},removeClass:function(value){var i,elem,className;for(i=0;i<this.length;i++)if(elem=this[i],value&&"string"==typeof value){if(1===elem.nodeType&&elem.className){for(className=" "+elem.className+" ";className.indexOf(" "+value+" ")>=0;)className=className.replace(" "+value+" "," ");elem.className=className}}else elem.className="";return this},findClass:function(value){var i,elem,className;if(value&&"string"==typeof value)for(i=0;i<this.length;i++)if(elem=this[i],1===elem.nodeType){if(!elem.className)return!1;if(className=" "+elem.className+" ",className.indexOf(" "+value+" ")>=0)return!0}return!1},append:function(html){var fragement,dive,elem,i,j,nodes,arr=[];for(fragement=document.createDocumentFragment(),dive=document.createElement("div"),fragement.appendChild(dive),dive.innerHTML=html,nodes=dive.childNodes,dive.parentNode.removeChild(dive),j=0;j<nodes.length;j++)arr.push(nodes[j]);for(i=0;i<this.length;i++)for(elem=this[i],j=0;j<arr.length;j++)elem.appendChild(arr[j]);return this},show:function(){return this.css({display:"block"})},hide:function(){return this.css({display:"none"})},html:function(html){var elem,i;for(i=0;i<this.length;i++)elem=this[i],elem.innerHTML=html;return this},remove:function(){var elem,i;for(i=0;i<this.length;i++)elem=this[i],elem.parentNode&&elem.parentNode.removeChild(elem);return this.length=0,this},toArray:function(callback){var arr=[],j=0;for(i=0;i<this.length;i++)callback&&callback(this[i])!==!0||(arr[j++]=this[i]);return arr},bind:function(type,handle){var elem,eventObj,i;for(i=0;i<this.length;i++)if(elem=this[i],eventObj=Drizzle.helper.getEventHandler(elem,type),eventObj.target)eventObj.func.push(handle);else{var eventHandle=function(){return Drizzle.helper.eventDispatch.apply(elem,arguments)},func=new Array;func.push(handle),eventObj={target:elem,type:type,handlerFunc:eventHandle,func:func},Drizzle.events.push(eventObj),Drizzle.helper.attachEvent(elem,type,eventHandle)}return this},unbind:function(type,handle){var elem,eventObj,i,j;for(i=0;i<this.length;i++)elem=this[i],eventObj=Drizzle.helper.getEventHandler(elem,type),eventObj.target&&(handle&&(j=Drizzle.helper.indexOf(eventObj.func,handle),eventObj.func.splice(j,1)),handle&&0!=eventObj.func.length||(j=Drizzle.helper.indexOf(Drizzle.events,eventObj),Drizzle.events.splice(j,1),Drizzle.helper.removeEvent(elem,type,eventObj.handlerFunc)));return this},load:function(handle){return this.bind("load",handle)},resize:function(handle){return this.bind("resize",handle)},attr:function(name,value){var elem,i;for(i=0;i<this.length;i++)elem=this[i],elem.setAttribute(name,value+"");return this},removeAttr:function(name){var elem,i;for(i=0;i<this.length;i++)elem=this[i],elem.removeAttribute(name);return this},width:function(){return Drizzle.helper.findHeightAndWidth(this,"Width")},height:function(){return Drizzle.helper.findHeightAndWidth(this,"Height")},scrollTop:function(){var elem;return 0==this.length?0:(elem=this[0],elem!=window?0:"undefined"!=typeof window.pageYOffset?window.pageYOffset:document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0)},scrollLeft:function(){var elem;return 0==this.length?0:(elem=this[0],elem!=window?0:"undefined"!=typeof window.pageXOffset?window.pageXOffset:document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft?document.body.scrollLeft:0)},drag:function(handler){var parent;if(0==handler.length||0==this.length)return!1;for(parent=handler[0];parent&&parent!=this[0];)parent=parent.parentNode;if(!parent)return!1;var that=this;this.moveOptions={},this.moveOptions.handler=handler,this.moveOptions.mouseDownHandler=function(event){return that.mouseDown(event)},this.bind("mousedown",this.moveOptions.mouseDownHandler)},destroyDrag:function(){this.unbind("mousedown"),this.moveOptions={},Drizzle(document).unbind("mousemove"),Drizzle(document).unbind("mouseup")},mouseDown:function(event){var target,parent,that=this;for(target=event.srcElement?event.srcElement:event.target,parent=target;parent&&parent!=this.moveOptions.handler[0];)parent=parent.parentNode;return parent?(event.pageX?(this.moveOptions.leftoffset=event.pageX-parseInt(this.css("left")),this.moveOptions.topoffset=event.pageY-parseInt(this.css("top"))):(this.moveOptions.leftoffset=event.clientX-parseInt(this.css("left")),this.moveOptions.topoffset=event.clientY-parseInt(this.css("top"))),this.moveOptions.windowWidth=Drizzle(window).width(),this.moveOptions.windowHeight=Drizzle(window).height(),this.moveOptions.elemWidth=this.width(),this.moveOptions.elemHeight=this.height(),this.moveOptions.mouseMoveHandler=function(event){return that.mouseDrag(event)},Drizzle(document).bind("mousemove",this.moveOptions.mouseMoveHandler),this.moveOptions.mouseUpHandler=function(event){return that.mouseUp(event)},Drizzle(document).bind("mouseup",this.moveOptions.mouseUpHandler),event.preventDefault?event.preventDefault():event.returnValue=!1,!1):!1},mouseDrag:function(event){var x,y,scrollLeft=0,scrollTop=0;return"absolute"==this.css("position")&&(scrollLeft=Drizzle(window).scrollLeft(),scrollTop=Drizzle(window).scrollTop()),event.pageX?(x=event.pageX-this.moveOptions.leftoffset,y=event.pageY-this.moveOptions.topoffset):(x=event.clientX-this.moveOptions.leftoffset,y=event.clientY-this.moveOptions.topoffset),x+this.moveOptions.elemWidth>this.moveOptions.windowWidth+scrollLeft&&(x=this.moveOptions.windowWidth-this.moveOptions.elemWidth+scrollLeft),y+this.moveOptions.elemHeight>this.moveOptions.windowHeight+scrollTop&&(y=this.moveOptions.windowHeight-this.moveOptions.elemHeight+scrollTop),scrollLeft>x&&(x=scrollLeft),scrollTop>y&&(y=scrollTop),this.css({top:y,left:x}),event.preventDefault?event.preventDefault():event.returnValue=!1,!0},mouseUp:function(event){this.mouseDrag(event),Drizzle(document).unbind("mousemove",this.moveOptions.mouseMoveHandler),Drizzle(document).unbind("mouseup",this.moveOptions.mouseUpHandler)}},Drizzle.prototype.init.prototype=Drizzle.prototype,window.Drizzle=Drizzle,Drizzle.events=new Array}(),function(){Drizzle.findBrowser=function(userAgent){void 0==userAgent&&(userAgent=navigator.userAgent.toLowerCase());var offset,i,fullVersion,version,browser={},browserName=!1;if(browser.opera=!1,browser.msie=!1,browser.chrome=!1,browser.safari=!1,browser.mozilla=!1,browser.webkit=!1,browser.edge=!1,browser.ios=!1,browser.android=!1,-1!=(offset=userAgent.indexOf("opera")))browserName="opera",fullVersion=userAgent.substring(offset+6),-1!=(offset=userAgent.indexOf("version"))&&(fullVersion=userAgent.substring(offset+8));else if(-1!=(offset=userAgent.indexOf("msie")))browserName="msie",fullVersion=userAgent.substring(offset+5);else if(-1!=userAgent.indexOf("trident/"))browserName="msie",offset=userAgent.indexOf("rv:"),fullVersion=userAgent.substring(offset+3);else if(-1!=(offset=userAgent.indexOf("edge")))browserName="edge",fullVersion=userAgent.substring(offset+5);else if(-1!=(offset=userAgent.indexOf("chrome")))browserName="chrome",fullVersion=userAgent.substring(offset+7),browser.webkit=!0;else if(-1!=(offset=userAgent.indexOf("safari")))browserName="safari",fullVersion=userAgent.substring(offset+7),-1!=(offset=userAgent.indexOf("version"))&&(fullVersion=userAgent.substring(offset+8)),browser.webkit=!0;else if(-1!=(offset=userAgent.indexOf("firefox")))browserName="mozilla",fullVersion=userAgent.substring(offset+8);else{if(-1!=(offset=userAgent.indexOf("ios"))&&-1!=(offset=userAgent.indexOf("zohotalk")))return browser.ios=!0,browser.version=0,browser;if(-1!=(offset=userAgent.indexOf("com.zoho.chat/zohovideolibandroid")))return browser.android=!0,browser.version=0,browser}return-1!=(i=fullVersion.indexOf(";"))&&(fullVersion=fullVersion.substring(0,i)),-1!=(i=fullVersion.indexOf(" "))&&(fullVersion=fullVersion.substring(0,i)),version=parseInt(""+fullVersion,10),isNaN(version)&&(version=parseInt(navigator.appVersion,10)),browser[browserName]=!0,browser.version=version,browser},Drizzle.browser=Drizzle.findBrowser()}(),function(){Drizzle.findOS=function(){var osName,platform=navigator.platform.toLowerCase(),os={};return os.win=!1,os.mac=!1,os.linux=!1,/win/i.test(platform)?osName="win":/mac/i.test(platform)?osName="mac":/linux/i.test(platform)&&(osName="linux"),os[osName]=!0,os},Drizzle.os=Drizzle.findOS()}(),VideoChatUtil.showFullScreen=function(element){var fullScreenEnabled=document.mozFullScreenEnabled||document.webkitFullscreenEnabled,fullScreenElemet=document.fullscreenElemet||document.mozFullScreenElement||document.webkitFullscreenElement,func=element.requestFullScreen||element.mozRequestFullScreen||element.webkitRequestFullscreen;fullScreenEnabled&&(fullScreenElemet||func&&func.call(element))},VideoChatUtil.exitFullScreen=function(){var fullScreenEnabled=document.mozFullScreenEnabled||document.webkitFullscreenEnabled,fullScreenElemet=document.fullscreenElemet||document.mozFullScreenElement||document.webkitFullscreenElement,func=document.exitFullScreen||document.mozCancelFullScreen||document.webkitCancelFullScreen;fullScreenEnabled&&fullScreenElemet&&func&&func.call(document)},VideoChatUtil.isWebRTCAvailable=function(){if(Drizzle.browser.mozilla&&Drizzle.browser.version<33)return!1;if(Drizzle.browser.chrome&&Drizzle.browser.version<38)return!1;var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;return navigator.getUserMedia=navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,navigator.getUserMedia instanceof Function&&RTCPeerConnection instanceof Function&&RTCSessionDescription instanceof Function&&RTCIceCandidate instanceof Function},VideoChatUtil.parseJSON=function(data){return window.JSON.parse(data)},VideoChatUtil.stringifyJSON=function(data){return window.JSON.stringify(data)},VideoChatUtil.decodeString=function(str){return DOMParser&&(str=(new DOMParser).parseFromString(str,"text/html").body.textContent),str};var VideoCallReceiver=function(){function init(dcName){var currentDomain=window.location.host;if(null!=currentDomain.match(/^[a-zA-Z0-9\-]+.csez.zohocorpin.com/))location=window.location.protocol+"//"+currentDomain;else if(null!=currentDomain.match(/^[a-zA-Z0-9]+(.localzoho.com)$/))location=window.location.protocol+"//video.localzoho.com";else if(null!=currentDomain.match(/^(pre[a-zA-Z0-9]+)(.zoho.com)$/))location=window.location.protocol+"//prevideo.zoho.com";else if(null!=currentDomain.match(/^(eu-pre[a-zA-Z0-9]+)(.zoho.com)$/))location=window.location.protocol+"//eu-prevideo.zoho.com";else if(null!=currentDomain.match(/^[a-zA-Z0-9]+(.zoho.com)$/))location=window.location.protocol+"//video.zoho.com";else if(null!=currentDomain.match(/^(eu-[a-zA-Z0-9]+)(.zoho.com)$/))location=window.location.protocol+"//eu-video.zoho.com";else if(null!=currentDomain.match(/^(pre[a-zA-Z0-9]+)(.zoho.eu)$/))location=window.location.protocol+"//prevideo.zoho.eu";else if(null!=currentDomain.match(/^[a-zA-Z0-9]+(.zoho.eu)$/))location=window.location.protocol+"//video.zoho.eu";else if(null!=currentDomain.match(/^(pre[a-zA-Z0-9]+)(.zoho.in)$/))location=window.location.protocol+"//prevideo.zoho.in";else if(null!=currentDomain.match(/[a-zA-Z0-9]+.zoho.in/))location=window.location.protocol+"//video.zoho.in";else if(null!=currentDomain.match(/^(pre[a-zA-Z0-9]+)(.zoho.com.cn)$/))location=window.location.protocol+"//prevideo.zoho.com.cn";else if(null!=currentDomain.match(/^[a-zA-Z0-9]+(.zoho.com.cn)$/))location=window.location.protocol+"//video.zoho.com.cn";else if(null!=currentDomain.match(/^[a-zA-Z0-9]+(.baihui.com)$/))location=window.location.protocol+"//video.baihui.com";else if(null!=currentDomain.match(/^(pre[a-zA-Z0-9]+)(.zoho.com.au)$/))location=window.location.protocol+"//prevideo.zoho.com.au";else if(null!=currentDomain.match(/^[a-zA-Z0-9]+(.zoho.com.au)$/))location=window.location.protocol+"//video.zoho.com.au";else if(WebMessanger||WmsLite)if(void 0==dcName){var jsDomain=null;WebMessanger?jsDomain=WebMessanger.jsstaticdomain:WmsLite&&(jsDomain=WmsLite.jsstaticdomain);var jsDomainSplit=jsDomain.split(".");location="localjs"==jsDomainSplit[0]?window.location.protocol+"//video.localzoho.com":"eu"==jsDomainSplit[2]?window.location.protocol+"//video.zoho.eu":"in"==jsDomainSplit[2]?window.location.protocol+"//video.zoho.in":"com"==jsDomainSplit[2]&&"cn"==jsDomainSplit[3]?window.location.protocol+"//video.zoho.com.cn":window.location.protocol+"//video.zoho.com"}else location="local"==dcName?window.location.protocol+"//video.localzoho.com":"eu"==dcName?window.location.protocol+"//video.zoho.eu":"cn"==dcName?window.location.protocol+"//video.zoho.com.cn":"in"==dcName?window.location.protocol+"//video.zoho.in":"au"==dcName?window.location.protocol+"//video.zoho.com.au":window.location.protocol+"//video.zoho.com";else location=window.location.protocol+"//video.zoho.com";if(VideoChatContainer.setVideoServerLocation(location),updateExistingWMSChatWindow(),window.postMessage&&(localStorageSupportedInCrossOriginIFrame=!0),localStorageSupportedInCrossOriginIFrame){var currentTime=(new Date).getTime(),parentLocation=VideoChatContainer.getLocation(),dataStreamUrl=location+"/pages/callreceiver.jsp?frameorigin="+parentLocation+"&nocache="+currentTime+"&location="+parentLocation,ua=navigator.userAgent.toLowerCase();-1!=ua.indexOf("zohomail-nativedesktop")&&(dataStreamUrl=location+"/api/callreceiver?frameorigin="+parentLocation+"&nocache="+currentTime+"&location="+parentLocation);var subframe=document.createElement("iframe");subframe.id="zv_callreceiverframe",subframe.src=dataStreamUrl,subframe.style.display="none",subframe.style.visibility="hidden",document.body.appendChild(subframe),Drizzle(window).bind("message",this.receiveMessage)}if("undefined"!=typeof VideoChatMessageNotifier&&1==VideoChatMessageNotifier.handleVideoChat()&&(isNewWindowChat=!1),nocache=(new Date).getTime(),jsURL){var regex="/zohovideo/v(.+?)/js/zvaschat.js",arr=jsURL.match(regex);null!=arr&&arr.length>1&&(nocache=arr[1])}loadRingtone(),Drizzle.browser.safari===!0&&-1==navigator.userAgent.toLowerCase().indexOf("iphone")&&Drizzle(window).bind("click",function(){var silent=document.createElement("audio");silent.src=location+"/sound/silent.mp3?nocache="+nocache,silent.play(),Drizzle(window).unbind("click")})}function updateExistingWMSChatWindow(){if(window.WindowHandler&&WindowHandler.getChatCount&&WindowHandler.exist){var winCount=0;winCount=WindowHandler.getChatCount();for(var i=0;winCount>i;i++){var chatWindow=WindowHandler.exist[i];if(chatWindow&&chatWindow.getInnerObject){var obj=chatWindow.getInnerObject("wmstvideo","IMG");obj&&(obj.style.display="block"),obj=chatWindow.getInnerObject("wmstvoice","IMG"),obj&&(obj.style.display="block")}}}}function handleVideoMessage(msg){var mailAppLocation=VideoChatContainer.getMailAppLocation();if(this.getCurrentUserZuid()!==!1){for(var i=0;i<callWindows.length;i++)try{var callWindow=callWindows[i];try{if(callWindow.location.origin!=location&&(0==mailAppLocation||callWindow.location.origin!=mailAppLocation))continue}catch(e){}null!=callWindow.location?0!=mailAppLocation?callWindow.postMessage(window.JSON.stringify(msg),mailAppLocation):callWindow.postMessage(window.JSON.stringify(msg),location):(callWindows.splice(i,1),i--)}catch(err){}var action=msg.ACTION;if(0==isNewWindowChat&&"CHAT_REQUEST"!==msg.ACTION&&VideoChatContainer.handleMessage(msg),sessionId!==!1){if(sessionId!==msg.SESSION_ID)return}else if("CHAT_REQUEST"!==action&&"JOIN_REQUEST"!==action)return;if("CHAT_REQUEST"===action||"JOIN_REQUEST"===action){if("JOIN_REQUEST"===action){if(msg.CALLED_ZUID!=this.getCurrentUserZuid())return;if(0==isNewWindowChat)return;isJoinRequest=!0,ownerZuid=msg.OWNER_ZUID;var usersInfoList=new Array;participants=msg.PARTICIPANTS;for(var i=0;i<participants.length;i++){var p=participants[i];p.USER_STATUS&&usersInfoList.push(p.USER_STATUS)}usersInfo=VideoChatUtil.stringifyJSON(usersInfoList)}else ownerZuid=msg.CALLING_ZUID;callingZuid=msg.CALLING_ZUID,callingUserName=msg.CALLING_USER_NAME,type=msg.TYPE,msg.ORIGINAL_TYPE&&(type=msg.ORIGINAL_TYPE),sessionId=msg.SESSION_ID,remoteUserAgent=msg.USER_AGENT,iceServers[sessionId.toString()]=msg.ICE_SERVERS;var otherServiceProps=msg.OTHER_SERVICE_PROPS;msg.ICE_SERVERS=VideoChatUtil.parseJSON(msg.ICE_SERVERS),msg.OTHER_SERVICE_PROPS&&(msg.OTHER_SERVICE_PROPS=VideoChatUtil.parseJSON(msg.OTHER_SERVICE_PROPS)),log="";var logMessage="[PARENT] "+VideoChatContainer.getLocation()+"\\n[WMS_MESSAGE] "+VideoChatUtil.stringifyJSON(msg);updateLogMessage(logMessage),0==isNewWindowChat?isJoinRequest?VideoChatMessageNotifier.handleJoinRequest&&(VideoChatMessageNotifier.handleJoinRequest(msg.OWNER_ZUID,msg.SESSION_ID,msg.CALLING_ZUID,msg.CALLING_USER_NAME,msg.CALLING_USERS,msg.TYPE,msg.OTHER_SERVICE_PROPS),notifyCallReceived()):(VideoChatMessageNotifier.handleChatRequest(msg.CALLING_ZUID,msg.CALLING_USER_NAME,msg.SESSION_ID,msg.TYPE,otherServiceProps,msg.ORIGINAL_TYPE),notifyCallReceived()):(this.start(msg),notifyCallReceived())}else"MESSAGE_SIGNALING"!==action&&(0==isNewWindowChat?"CLOSE_REQUEST"===action?VideoChatMessageNotifier.handleCloseRequest(msg.SESSION_ID,msg.REASON):"CHAT_ANSWERED"===action&&VideoChatMessageNotifier.handleChatAnswered(msg.SESSION_ID):this.stop())}}function notifyCallReceived(){var param="callingzuid="+ownerZuid+"&sessionid="+sessionId+"&from=browser",jsonData={};jsonData.action="POST_REQUEST",jsonData.sub_action="CHAT_RECEIVED",jsonData.params=param;var message=VideoChatUtil.stringifyJSON(jsonData);sessionId&&(sendMessageToCallReceiverFrame(message),updateLogMessage("[REQUEST] /chatreceived.do?"+param))}function sendMessageToCallReceiverFrame(message){var subframe=document.getElementById("zv_callreceiverframe"),frameWindow=subframe.contentWindow;0==VideoChatContainer.getMailAppLocation()?frameWindow.postMessage(message,location):frameWindow.postMessage(message,VideoChatContainer.getMailAppLocation())}function start(msg){var count=30,rejectMsg=msg.REJECT_MSG;homeTitle=document.title,window.Collaboration&&Collaboration.getPageTitle&&Collaboration.getPageTitle()!==!1&&void 0!==Collaboration.getPageTitle()&&(homeTitle=Collaboration.getPageTitle());var callTitle=msg.TITLE_MSG;if(localStorageSupportedInCrossOriginIFrame&&isNewWindowChat){var jsonData=msg;jsonData.action="IS_PREFERED_WINDOW";var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message)}var dialog=getVideoReceiverDialog();dialog=isJoinRequest?getString(dialog,msg.PHOTO_URL,msg.CALLING_MSG,msg.CALLING_USERS,msg.REJECT_MSG,msg.ANSWER_MSG,msg.IGNORE_MSG):getString(dialog,msg.PHOTO_URL,msg.CALLING_MSG,msg.CALLING_USER_NAME,msg.REJECT_MSG,msg.ANSWER_MSG,msg.IGNORE_MSG),Drizzle(document.body).append(dialog),ring===!1&&Drizzle("[id=zv_videoReceiver]").find("[name=zv_speakerOff]").hide(),setTimeout(function(){Drizzle("[id=zv_bigNotifier]").addClass("stepIn")},500),Drizzle("[id=zv_videoReceiver]").bind("click",handleCallReceiverEvents);var localTime=(new Date).getTime(),func=function(){document.title=document.title===homeTitle?callTitle:homeTitle;var currentTime=(new Date).getTime();count=30-Math.round((currentTime-localTime)/1e3);var timeMsg="00:";return 10>count&&(timeMsg+="0"),timeMsg+=count,Drizzle("[id=zv_rejectMsg]").html(getString(rejectMsg,timeMsg)),0>=count?void this.stop():void(TIMEOUT_FUNC=setTimeout(func,1e3))}.bind(this);func()}function getString(){var ag=arguments,al=ag.length;if(0===al)return!1;if(1===al)return ag[0];var mg=ag[0];return mg.replace(/\{[0-9]*\}/g,function(_1){return _1=_1.replace(/[\{\}]/g,""),ag[parseInt(_1)]})}function handleCallReceiverEvents(_event){var event=_event||window.event,target=event.target||event.srcElement,elementName=target.getAttribute("name");elementName&&("zv_speakerOff"===elementName?VideoCallReceiver.speakerOff():"zv_speakerOn"===elementName?VideoCallReceiver.speakerOn():"zv_answerBut"===elementName?(VideoCallReceiver.answerChat(callingZuid,sessionId,type),VideoCallReceiver.stop(!0)):"zv_ignoreBut"===elementName?(VideoCallReceiver.ignoreChat(callingZuid,sessionId,VideoConstants.REJECTED),VideoCallReceiver.stop()):"zv_minimize"===elementName?(Drizzle("[id=zv_bigNotifier]").removeClass("stepIn"),Drizzle("[id=zv_tinyNotifier]").addClass("active")):"zv_callerName"===elementName&&(Drizzle("[id=zv_bigNotifier]").addClass("stepIn"),Drizzle("[id=zv_tinyNotifier]").removeClass("active")))}function getVideoReceiverDialog(){var dialog='<div id="zv_videoReceiver" class="videoreceiver"> 		<section id="zv_bigNotifier" class="incomingCallNotifier zv-notifierBody">   		<div class="photoContainer"> <img src="{1}" class="callerPhoto" />   		<div class="mediaControls">    	 	<button name="zv_speakerOff" class="muteCallIndicator"></button>      	<button name="zv_minimize" class="minimizeNotifier"></button>    		</div>   		</div>   		<div class="textContainer">    		 <div class="callTypeMessage">{2}</div>     	<h3 class="callerName">{3}</h3>     	<p id="zv_rejectMsg" class="autoRejectTimer">{4}</p>     	<div class="responder clearfix">       	<button name="zv_answerBut" class="callResponseBtn btn-answer">{5}</button>       	<button name="zv_ignoreBut" class="callResponseBtn btn-ignore">{6}</button>     	</div>   		</div> 		</section> 		<section id="zv_tinyNotifier" class="tinyNotifier"> 			<div class="containerTiny clearfix">         	<span name="zv_callerName" class="callerNameTiny">{3}</span>         	<span class="responderTiny">         	<button name="zv_answerBut" class="answerTiny"></button>         	<button name="zv_ignoreBut" class="declineTiny"></button>         	</span>     		</div> 		</section></div>';return dialog}function answerChat(_callingZuid,_sessionId,_type,videoChatHandler){var chatURL=location+"/";0!=VideoChatContainer.getMailAppLocation()&&(chatURL=location+"/api/"),chatURL+="video"===type?"videocall":"voicewhivi"===type?"audiowhivicall":"screen"===type?"screencall":"audiocall",chatURL+="/"+callingZuid+"/"+sessionId;var params={};if(params.iceservers=iceServers[sessionId.toString()],params.logmessage=log,params.remoteuseragent=remoteUserAgent,isJoinRequest&&(params.ownerzuid=ownerZuid,0!=usersInfo&&(params.usersinfo=usersInfo)),0==VideoChatContainer.getMailAppLocation()&&(params[csrfParam]=csrfValue),0==isNewWindowChat){if(VideoChatUtil.isWebRTCAvailable()===!1)return VideoChatMessageNotifier.handleBrowserNotSupported(_type),VideoCallReceiver.ignoreChat(_callingZuid,_sessionId,VideoConstants.NO_WEBRTC),!1;var param="callingzuid="+ownerZuid+"&sessionid="+_sessionId;VideoChatContainer.postRequest("CHAT_ANSWERED",param),updateLogMessage("[REQUEST] /chatanswered.do?"+param);var chatUserName=!1,otherServiceProps=!1,videoChatAPI=VideoChatContainer.createVideoChatAPI(_callingZuid,this.getCurrentUserZuid(),_type,chatUserName,iceServers[_sessionId.toString()],otherServiceProps,videoChatHandler,log);isJoinRequest?(videoChatAPI.setOwnerZuid(ownerZuid),0!=usersInfo&&videoChatAPI.setUsersInfo(VideoChatUtil.parseJSON(usersInfo)),0!=participants&&videoChatAPI.setParticipants(VideoChatUtil.stringifyJSON(participants))):videoChatAPI.setOwnerZuid(_callingZuid),videoChatAPI.setSessionId(_sessionId),videoChatAPI.setRemoteUserAgent(remoteUserAgent,_callingZuid),VideoChatContainer.checkUnhandledMessage(_callingZuid+"_"+this.getCurrentUserZuid(),_sessionId),videoChatAPI.acceptCall()}else openChatWindow(chatURL,params)}function openChatWindow(chatURL,params){var windowProps=getWindowProps(),props="toolbar=no, scrollbars=yes, resizable=yes";props=props+", top="+windowProps.top+", left="+windowProps.left+", width="+windowProps.width+", height="+windowProps.height;var ua=navigator.userAgent.toLowerCase();if(-1==ua.indexOf("zohoconnect")&&-1==ua.indexOf("zohomail-desktop")&&-1==ua.indexOf("zohomail-nativedesktop"))openWindowWithPost(chatURL,props,"ZohoVideo"+(new Date).getTime(),params);else{chatURL+="?frameorigin="+VideoChatContainer.getLocation();var iframeProps={width:windowProps.iframeWidth,height:windowProps.iframeHeight};openChatIframe(chatURL,iframeProps,"ZohoVideo"+(new Date).getTime(),params)}}function openChatIframe(chatURL,windowoption,windowname,params){var form=document.createElement("form");form.setAttribute("method","post"),form.setAttribute("action",chatURL),form.setAttribute("target",windowname);for(var i in params)if(params.hasOwnProperty(i)){var input=document.createElement("input");input.type="hidden",input.name=i,input.value=params[i],form.appendChild(input)}document.body.appendChild(form);var chatIframe=document.getElementById("zohovideo");if(null==chatIframe){chatIframe=document.createElement("iframe"),chatIframe.name=windowname,chatIframe.id="zohovideo",chatIframe.style.position="fixed",chatIframe.style.width=windowoption.width,chatIframe.style.height=windowoption.height,chatIframe.style.zIndex="999",chatIframe.style.top="50%",chatIframe.style.left="50%",chatIframe.style.transform="translate(-50%,-50%)";var allowMediaDevice="microphone "+location+"; camera "+location;chatIframe.setAttribute("allow",allowMediaDevice),document.body.appendChild(chatIframe)}else form.setAttribute("target",chatIframe.name);form.submit(),document.body.removeChild(form),window.postMessage&&(v=chatIframe.contentWindow,callWindows.push(v))}function openWindowWithPost(chatURL,windowoption,windowname,params){var form=document.createElement("form");form.setAttribute("method","post"),form.setAttribute("action",chatURL),form.setAttribute("target",windowname);for(var i in params)if(params.hasOwnProperty(i)){var input=document.createElement("input");input.type="hidden",input.name=i,input.value=params[i],form.appendChild(input)}document.body.appendChild(form);var v=!1;v=Drizzle.browser.chrome===!0?window.open("",windowname):window.open("",windowname,windowoption),form.submit(),document.body.removeChild(form),window.postMessage&&callWindows.push(v)}function ignoreChat(_callingZuid,_sessionId,reason){var param="callingzuid="+ownerZuid+"&calledzuid="+this.getCurrentUserZuid()+"&status="+reason+"&sessionid="+_sessionId+"&leavingzuid="+this.getCurrentUserZuid(),jsonData={};jsonData.action="POST_REQUEST",jsonData.sub_action="STOP_CHAT",jsonData.params=param;var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message),updateLogMessage("[REQUEST] /stopchat.do?"+param),log=log.replace(/\\n/g,"\n");var callingName=VideoChatUtil.decodeString(callingUserName),currentUserName=VideoChatUtil.decodeString(VideoChatContainer.getCurrentUserName()),subject="[AT] [REJECTED] ["+_sessionId+"] ["+callingName+":"+_callingZuid+"] ["+currentUserName+":"+this.getCurrentUserZuid()+"]";VideoChatContainer.sendFeedback(subject,!1,log,_sessionId)}function stop(isCallAnswered){clearTimeout(TIMEOUT_FUNC),homeTitle!==!1&&(document.title=homeTitle),ring&&(ring.pause(),ring.currentTime=0),notification&&notification.close();var obj=Drizzle("[id=zv_videoReceiver]");if(obj.length>0&&(Drizzle("[id=zv_bigNotifier]").removeClass("stepIn"),Drizzle("[id=zv_tinyNotifier]").removeClass("active"),setTimeout(function(){Drizzle("[id=zv_videoReceiver]").remove()},500)),callingZuid=sessionId=type=homeTitle=notification=callingUserName=!1,isJoinRequest=ownerZuid=participants=!1,TIMEOUT_FUNC=!1,log="",void 0==isCallAnswered&&VideoChatContainer.getMailAppLocation()){var msg={action:"CLOSE_WEBVIEW"};window.postMessage(VideoChatUtil.stringifyJSON(msg),VideoChatContainer.getMailAppLocation())}}function createConference(title,zuids,callback,connectScopeID,startTime){var param="";zuids.length>0&&(param="zuids="+zuids[0]);for(var i=1;i<zuids.length;i++)param+="&zuids="+zuids[i];if(title&&(param+="&name="+title),connectScopeID&&(param+="&connect_scopeid="+connectScopeID),startTime){var currentTime=(new Date).getTime();startTime>currentTime&&(param+="&starttime="+startTime)}VideoChatContainer.postRequest("CREATE_CONFERENCE",param,callback)}function inviteParticipants(sessionId,zuids,callback){for(var param="sessionid="+sessionId,i=0;i<zuids.length;i++)param+="&zuids="+zuids[i];VideoChatContainer.postRequest("INVITE_PARTICIPANT",param,callback)}function updateConferenceStartTime(sessionId,startTime){var param="sessionid="+sessionId;if(startTime){var currentTime=(new Date).getTime();startTime>currentTime&&(param+="&starttime="+startTime,VideoChatContainer.postRequest("UPDATE_CONF_START_TIME",param))}}function updateLogMessage(message){var time=new Date;time=time.getFullYear()+"-"+(time.getMonth()+1)+"-"+time.getDate()+" "+time.getHours()+":"+time.getMinutes()+":"+time.getSeconds()+"."+time.getMilliseconds(),message="["+time+"] "+message+"\\n",log+=message}function getWindowProps(){var x=y=factor=winWidth=winHeight=0,top=left=0,width=screen.width,height=screen.height,aspectRatio_16_9={xRatio:16,yRatio:9,maxWidth:1280,maxHeight:720},aspectRatio=aspectRatio_16_9;winWidth=width,winHeight=height,x=winWidth/aspectRatio.xRatio,y=winHeight/aspectRatio.yRatio,factor=y>x?x:y,winWidth=factor*aspectRatio.xRatio,winHeight=factor*aspectRatio.yRatio,(winWidth>aspectRatio.maxWidth||winHeight>aspectRatio.maxHeight)&&(winWidth=aspectRatio.maxWidth,winHeight=aspectRatio.maxHeight),left=(width-winWidth)/2,top=(height-winHeight)/2,top>100&&(top=100);var iframeWidth=winWidth/width*100+"%",iframeHeight=winHeight/height*100+"%",windowProps={width:winWidth,height:winHeight,left:left,top:top,iframeWidth:iframeWidth,iframeHeight:iframeHeight};return windowProps}function loadRingtone(){var errorCallback=function(){ring=!1},loadedDataCallback=function(){ring=ringTemp,ring.loop=!0},ringTemp=document.createElement("audio");Drizzle.browser.safari===!0?(Drizzle(ringTemp).bind("error",errorCallback),Drizzle(ringTemp).bind("loadeddata",loadedDataCallback)):(ringTemp.onerror=errorCallback,ringTemp.onloadeddata=loadedDataCallback),ringTemp.src=location+"/sound/ringtone.mp3?nocache="+nocache,ringTemp.preload="auto"}var callingZuid=!1,sessionId=!1,type=!1,homeTitle=!1,callingUserName=!1,location=!1,ring=!1,jsURL=!1,csrfParam=!1,csrfValue=!1,TIMEOUT_FUNC=!1,callWindows=new Array,notification=!1,localStorageSupportedInCrossOriginIFrame=!1,iceServers=new Array,isNewWindowChat=!0,log="",nocache=!1,remoteUserAgent=!1,isJoinRequest=!1,usersInfo=!1,ownerZuid=!1,participants=!1;return function(){document.currentScript&&document.currentScript.src&&(jsURL=document.currentScript.src)}(),{init:init,handleVideoMessage:handleVideoMessage,answerChat:answerChat,ignoreChat:ignoreChat,stop:stop,start:start,notifyCallReceived:notifyCallReceived,createConference:createConference,inviteParticipants:inviteParticipants,updateConferenceStartTime:updateConferenceStartTime,getCurrentUserZuid:function(){return window.WebMessanger?WebMessanger.getZuid():window.WmsImpl?WmsImpl.getZuid():!1},startChat:function(chatUserId,_type,otherServiceProps,videoChatHandler){log="",updateLogMessage("[PARENT] "+VideoChatContainer.getLocation());var chatURL=location+"/";0!=VideoChatContainer.getMailAppLocation()&&(chatURL=location+"/api/"),chatURL+="video"===_type?"videocall":"voicewhivi"===_type?"audiowhivicall":"screen"===_type?"screencall":"audiocall",chatURL+="/"+chatUserId;var params={};if(params.logmessage=log,0==VideoChatContainer.getMailAppLocation()&&(params[csrfParam]=csrfValue),isNewWindowChat)openChatWindow(chatURL,params);else{if(VideoChatUtil.isWebRTCAvailable()===!1)return VideoChatMessageNotifier.handleBrowserNotSupported(_type),!1;var iceServers={},chatUserName=!1,videoChatAPI=VideoChatContainer.createVideoChatAPI(this.getCurrentUserZuid(),chatUserId,_type,chatUserName,iceServers,otherServiceProps,videoChatHandler,log);videoChatAPI.startCall()}},playSound:function(){if(ring){ring.muted=!1,ring.currentTime=0;var playPromise=ring.play();void 0!==playPromise&&playPromise.then(function(){}).catch(function(){})}},receiveMessage:function(event){var mailAppLocation=VideoChatContainer.getMailAppLocation();if((event.origin===location||0!=mailAppLocation&&event.origin==mailAppLocation)&&"object"!=typeof event.data){var data=!1;try{data=VideoChatUtil.parseJSON(event.data)}catch(e){return}var action=data.action;if("CLOSE_IFRAME"===action){var chatIframe=Drizzle("[id=zohovideo]")[0];chatIframe&&chatIframe.remove()}else if("SHOW_FULLSCREEN"===action){var chatIframe=Drizzle("[id=zohovideo]")[0];chatIframe&&(chatIframe.style.width="100%",chatIframe.style.height="100%")}else if("EXIT_FULLSCREEN"===action){var chatIframe=Drizzle("[id=zohovideo]")[0];if(chatIframe){var props=getWindowProps();chatIframe.style.width=props.iframeWidth,chatIframe.style.height=props.iframeHeight}}else if("IS_PREFERED_WINDOW"===action)"YES"==data.result&&VideoCallReceiver.showDesktopNotification(data);else if("MUTE_STATUS_CHANGE"===action){if(sessionId===!1)return;var status=data.status;status?VideoCallReceiver.mute():VideoCallReceiver.unmute()}else if("CURRENT_USER_INFO"===action)csrfParam=data.csrfParam,csrfValue=data.csrfValue,VideoChatContainer.init(data.currentUserZuid,data.currentUserName,data.wmsJSURL);else if("CSRF_DATA"===action)VideoChatContainer.invokeCallback(data.callbackId,data.csrf);else if("AJAX_RESPONSE"===action){var msg=!1;data.message&&(msg=data.message),"undefined"!=typeof data.callbackId&&VideoChatContainer.invokeCallback(data.callbackId,data.message)}}},showDesktopNotification:function(msg){window.Notification&&"granted"===Notification.permission&&(notification=new Notification(msg.TITLE_MSG,{icon:msg.PHOTO_URL,body:VideoChatUtil.decodeString(msg.CALLING_USER_MSG),silent:!0}),notification.onclick=function(){sessionId!==!1&&setTimeout(function(){VideoCallReceiver.answerChat(callingZuid,sessionId,type),VideoCallReceiver.stop()},0)})},mute:function(){if(ring){ring.muted=!0;var elementObj=Drizzle("[id=zv_videoReceiver]").find("[name=zv_speakerOff]");if(0==elementObj.length)return;var element=elementObj[0];elementObj.addClass("active"),element.setAttribute("name","zv_speakerOn")}},unmute:function(){if(ring){ring.muted=!1;var elementObj=Drizzle("[id=zv_videoReceiver]").find("[name=zv_speakerOn]");if(0==elementObj.length)return;var element=elementObj[0];elementObj.removeClass("active"),element.setAttribute("name","zv_speakerOff")}},speakerOff:function(){if(localStorageSupportedInCrossOriginIFrame){var jsonData={};jsonData.action="MUTE_STATUS_CHANGE",jsonData.status=!0;var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message)}else VideoCallReceiver.mute()},speakerOn:function(){if(localStorageSupportedInCrossOriginIFrame){var jsonData={};jsonData.action="MUTE_STATUS_CHANGE",jsonData.status=!1;var message=VideoChatUtil.stringifyJSON(jsonData);sendMessageToCallReceiverFrame(message)}else VideoCallReceiver.unmute()},setNewWindow:function(value){isNewWindowChat=value}}}();WMSTP.isVideoEnabled=function(){return!0},WMSTP.isAudioEnabled=function(){return!0},WMSTP.handleNewVideo=function(ownerZuid,chatUserId){VideoCallReceiver.startChat(chatUserId,"video")},WMSTP.handleNewAudio=function(ownerZuid,chatUserId){VideoCallReceiver.startChat(chatUserId,"voicewhivi")},WMSTP.handleNewAudioWHivi=function(ownerZuid,chatUserId){VideoCallReceiver.startChat(chatUserId,"voicewhivi")},WMSTP.handleNewScreenCall=function(ownerZuid,chatUserId){VideoCallReceiver.startChat(chatUserId,"screen")},WMSTP.handleAVMessage=function(msgObj){VideoCallReceiver.handleVideoMessage(msgObj)};var MediaFrameWorkAPI=VideoCallReceiver;NetworkAPI.getXMLHttp=function(){var xmlHttp=!1;try{xmlHttp=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{xmlHttp=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){xmlHttp=!1}}return xmlHttp||"undefined"==typeof XMLHttpRequest||(xmlHttp=new XMLHttpRequest),xmlHttp},NetworkAPI.getRequest=function(urlKey,callbackId){var xmlHttp=this.getXMLHttp();if(xmlHttp!==!1){var url=!1;switch(urlKey){case"GET_CONTACTS":url="/getcontacts.do";break;case"GET_ORGUSERS":url="/getorgusers.do"}0!=url&&(0!=VideoChatContainer.getMailAppLocation()&&(url=url.substring(0,url.indexOf(".")),url=VideoChatContainer.getVideoServerLocation()+"/api"+url),xmlHttp.open("GET",url,!0),xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),xmlHttp.send(),xmlHttp.onreadystatechange=function(){if(4===xmlHttp.readyState&&callbackId){var data=VideoChatUtil.parseJSON(xmlHttp.responseText);VideoChatContainer.invokeCallback(callbackId,data)}})}},NetworkAPI.postRequest=function(urlKey,param,callbackId){var xmlHttp=this.getXMLHttp(),mailAppLocation=VideoChatContainer.getMailAppLocation();if("undefined"!=typeof VideoCallReceiver){var subframe=Drizzle("[id=zv_callreceiverframe]")[0],frameWindow=subframe.contentWindow,jsonData={};jsonData.action="POST_REQUEST",jsonData.sub_action=urlKey,jsonData.params=param,jsonData.callbackId=callbackId;var message=VideoChatUtil.stringifyJSON(jsonData);return void(0==mailAppLocation?frameWindow.postMessage(message,VideoChatContainer.getVideoServerLocation()):frameWindow.postMessage(message,mailAppLocation))}if(xmlHttp!==!1){var url=!1;switch(urlKey){case"CHAT_REQUEST":url="/requestchat.do";break;case"CHAT_RECEIVED":url="/chatreceived.do";break;case"CHAT_ANSWERED":url="/chatanswered.do";break;case"START_CHAT":url="/startchat.do";break;case"MESSAGE_SIGNALING":url="/messagesignaling.do";break;case"CONNECT_NOTIFY":url="/connectnotify.do";break;case"STOP_CHAT":url="/stopchat.do";break;case"DISCONNECT_NOTIFY":url="/disconnectnotify.do";break;case"DISCONNECT_ACKNOWLEDGEMENT":url="/sendacknowledgement.do";break;case"SEND_FEEDBACK":url="/sendfeedback.do";break;case"CONNECTION_DETAILS":url="/sendconnectiondetails.do";break;case"JOIN_REQUEST":url="/joinrequest.do";break;case"UPDATE_CONNECTION_STATS":url="/updateconnectionstats.do"}0!=url&&(0!=mailAppLocation?(url=url.substring(0,url.indexOf(".")),url=VideoChatContainer.getVideoServerLocation()+"/api"+url):param+="&"+VideoChatContainer.getCSRF(),xmlHttp.open("POST",url,!0),xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),xmlHttp.send(param),xmlHttp.onreadystatechange=function(){if(4===xmlHttp.readyState&&callbackId){var data=VideoChatUtil.parseJSON(xmlHttp.responseText);VideoChatContainer.invokeCallback(callbackId,data)}})}};var _VideoConstants=function(){this.ERROR=0,this.NOT_STARTED=1,this.STARTED=2,this.COMPLETED=3,this.CANCELLED=4,this.REJECTED=5,this.NO_RESPONSE=6,this.NO_WEBRTC=13,this.NO_DEVICE_SUPPORT=14,this.MESSAGE_CHAT_MSG=1,this.MESSAGE_ACTION_MSG=2,this.MESSAGE_WEBRTC_MSG=3,this.MESSAGE_STATUS_MSG=4,this.MESSAGE_WEBRTC_RENEGOTIATION=5,this.MESSAGE_SCREENSHARE_WEBRTC_MSG=6,this.MESSAGE_SCREENSHARE_WEBRTC_RENEGOTIATION=7,this.MESSAGE_SCREENSHARE_STATUS_MSG=8,this.BUSY_ON_ANOTHER_CALL=15,this.ROOM_FULL=16},VideoConstants=new _VideoConstants;VideoChatWebRTC.prototype.startChat=function(connectionId){var peerConnectionInfo={};this.peerConnectionInfoList.push(peerConnectionInfo),peerConnectionInfo.connectionId=connectionId,peerConnectionInfo.localCandidates=new Array,peerConnectionInfo.remoteCandidates=new Array,peerConnectionInfo.localDesc=!1,peerConnectionInfo.remoteDesc=!1,peerConnectionInfo.endICE=!1,peerConnectionInfo.isWebrtcConnected=!1,peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=!1,peerConnectionInfo.remoteStream=new MediaStream;var onicecandidateCallback=function(evt){return this.videoChatAPI.updateLogMessage("[WEBRTC] [ICE_CANDIDATE] "+(null!=evt.candidate?VideoChatUtil.stringifyJSON(evt.candidate):"candidate is null")),this.renegotiatingUser?void 0:null===evt.candidate?void(peerConnectionInfo.endICE=!0):void(""!=evt.candidate.candidate&&peerConnectionInfo.localCandidates.push(VideoChatUtil.stringifyJSON(evt.candidate)))}.bind(this),oniceconnectionstatechangeCallback=function(){if(this.videoChatAPI.updateLogMessage("[WEBRTC] [ICE_CONNECTION_STATE] id: "+connectionId+" "+(0!=pc?pc.iceConnectionState:"pc is false")),pc!==!1)if("connected"===pc.iceConnectionState||"completed"===pc.iceConnectionState){if(this.webrtcFailed=!1,0!=this.reconnectionState&&(this.reconnectionState="connected",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState,this.zuid)),peerConnectionInfo.isWebrtcConnected===!1)if(this.chatAnswered===!0){if(this.videoChatAPI.sendlocalUserConnectedRequest(this.zuid),this.reconnectionId>0||this.currentParticipant.isMicOff()||this.currentParticipant.isCameraOff()){var micState=this.currentParticipant.isMicOff()?"0":"1",msg={micStatus:micState,action:VideoConstants.MESSAGE_STATUS_MSG.toString()};if(1==this.videoChatAPI.isVideoEnabled){var cameraState=this.currentParticipant.isCameraOff()?"0":"1";msg.cameraStatus=cameraState}this.videoChatAPI.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON(msg),this.zuid)}}else Drizzle.browser.chrome&&Drizzle.browser.version<=71?pc.removeStream(this.currentParticipant.getLocalStream()):1==this.videoChatAPI.getRemoteParticipants().length&&this.currentParticipant.micOff();peerConnectionInfo.isWebrtcConnected=!0,(0==Drizzle.browser.chrome||Drizzle.browser.version<73)&&clearTimeout(peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION)}else"disconnected"===pc.iceConnectionState?this.chatAnswered===!0&&this.activeConnectionId==peerConnectionInfo.connectionId&&(this.webrtcFailed=!0,this.reconnectionState="checking",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState)):"failed"===pc.iceConnectionState?this.chatAnswered===!0&&this.activeConnectionId==peerConnectionInfo.connectionId&&this.previousPeerConnectionInfoClearedAndSendDisconnectNotify(peerConnectionInfo):"closed"===pc.iceConnectionState&&(pc=!1)}.bind(this),onconnectionstatechangeCallback=function(){if(this.videoChatAPI.updateLogMessage("[WEBRTC] [CONNECTION_STATE] id: "+connectionId+" "+(0!=pc?pc.connectionState:"pc is false")),pc!==!1)if("connected"===pc.connectionState||"completed"===pc.connectionState){if(this.webrtcFailed=!1,0!=this.reconnectionState&&(this.reconnectionState="connected",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState,this.zuid)),peerConnectionInfo.isWebrtcConnected===!1)if(this.chatAnswered===!0){if(this.videoChatAPI.sendlocalUserConnectedRequest(this.zuid),this.reconnectionId>0||this.currentParticipant.isMicOff()||this.currentParticipant.isCameraOff()){var micState=this.currentParticipant.isMicOff()?"0":"1",msg={micStatus:micState,action:VideoConstants.MESSAGE_STATUS_MSG.toString()};if(1==this.videoChatAPI.isVideoEnabled){var cameraState=this.currentParticipant.isCameraOff()?"0":"1";msg.cameraStatus=cameraState}this.videoChatAPI.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON(msg),this.zuid)}}else Drizzle.browser.chrome&&Drizzle.browser.version<=71?pc.removeStream(this.currentParticipant.getLocalStream()):1==this.videoChatAPI.getRemoteParticipants().length&&this.currentParticipant.micOff();peerConnectionInfo.isWebrtcConnected=!0,(0==Drizzle.browser.chrome||Drizzle.browser.version<73)&&clearTimeout(peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION)}else"disconnected"===pc.connectionState?this.chatAnswered===!0&&this.activeConnectionId==peerConnectionInfo.connectionId&&(this.webrtcFailed=!0,this.reconnectionState="checking",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState)):"failed"===pc.connectionState?this.chatAnswered===!0&&this.activeConnectionId==peerConnectionInfo.connectionId&&this.previousPeerConnectionInfoClearedAndSendDisconnectNotify(peerConnectionInfo):"closed"===pc.connectionState&&(pc=!1)}.bind(this),onSignalingStateChangeCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] [SIGNALING_STATE] "+(void 0!=pc.signalingState?pc.signalingState:"undefined")),"closed"==pc.signalingState&&this.chatAnswered===!0&&this.activeConnectionId==peerConnectionInfo.connectionId&&(this.webrtcFailed=!0,this.previousPeerConnectionInfoClearedAndSendDisconnectNotify(peerConnectionInfo))}.bind(this),onAddTrackCallback=function(evt){this.videoChatAPI.updateLogMessage("[WEBRTC] onAddTrackCallback : track kind = "+evt.track.kind),Drizzle.browser.chrome&&"video"===evt.track.kind&&this.completeRenegotiation("completed")}.bind(this),onAddStreamCallback=function(evt){var stream=!1;if(evt.streams){if(0==evt.streams.length)return;stream=evt.streams[0]}else stream=evt.stream;this.videoChatAPI.updateLogMessage("[WEBRTC] onAddStreamCallback : stream = "+VideoChatUtil.stringifyJSON(stream)),"video"!=this.videoChatAPI.getChatType()&&0!=this.remoteUserAgent&&this.remoteDevice.mozilla||0!=this.remoteUserAgent&&this.remoteDevice.chrome&&this.remoteDevice.version>=72?stream.getTracks().forEach(function(track){peerConnectionInfo.remoteStream.addTrack(track,stream)}):peerConnectionInfo.remoteStream=stream,"video"!=this.videoChatAPI.getChatType()&&2==peerConnectionInfo.remoteStream.getTracks().length&&(this.remoteVideoEnabled=!0),this.videoChatAPI.videoChatHandler.handleRemoteStream(peerConnectionInfo.remoteStream,this.zuid),this.renegotiatingUser?this.completeRenegotiation("completed"):Drizzle.browser.chrome&&"video"!=this.videoChatAPI.getChatType()&&0==this.remoteVideoEnabled&&(peerConnectionInfo.remoteStream.onaddtrack=onAddTrackCallback)}.bind(this),errorCallback=function(err){this.videoChatAPI.sendStopChatRequest(this.zuid,VideoConstants.ERROR,"ErrorInCreateOffer : "+err)}.bind(this),createOfferSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[WebRTC] [LOCAL_DESC] "+VideoChatUtil.stringifyJSON(desc)),peerConnectionInfo.localDesc=desc,this.connect(peerConnectionInfo)}.bind(this),pc=new this.RTCPeerConnection(this.currentParticipant.getICEServers());peerConnectionInfo.pc=pc,pc.onicecandidate=onicecandidateCallback,Drizzle.browser.chrome&&Drizzle.browser.version>76?pc.onconnectionstatechange=onconnectionstatechangeCallback:(pc.oniceconnectionstatechange=oniceconnectionstatechangeCallback,pc.onsignalingstatechange=onSignalingStateChangeCallback),Drizzle.browser.mozilla&&Drizzle.browser.version>56||Drizzle.browser.safari?pc.ontrack=onAddStreamCallback:pc.onaddstream=onAddStreamCallback,Drizzle.browser.safari?this.currentParticipant.getLocalStream().getTracks().forEach(function(track){pc.addTrack(track,this.currentParticipant.getLocalStream())}.bind(this)):pc.addStream(this.currentParticipant.getLocalStream()),1==this.isOffer&&("video"!=this.videoChatAPI.getChatType()&&1==this.remoteVideoEnabled?Drizzle.browser.safari?pc.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then(createOfferSuccessCallback).catch(errorCallback):pc.createOffer(createOfferSuccessCallback,errorCallback,{offerToReceiveAudio:!0,offerToReceiveVideo:!0}):Drizzle.browser.safari?pc.createOffer().then(createOfferSuccessCallback).catch(errorCallback):pc.createOffer(createOfferSuccessCallback,errorCallback),this.chatAnswered=!0,this.activeConnectionId=connectionId)},VideoChatWebRTC.prototype.onMessage=function(obj,msgId){for(var i=0;i<this.processedMsgIdList.length;i++)if(this.processedMsgIdList[i]==msgId)return void this.videoChatAPI.updateLogMessage("[WMS_MESSAGE] Already proceesed Msg ID :"+msgId);this.processedMsgIdList.push(msgId),0==this.isOffer&&null===this.getPeerConnectionInfo(obj.connectionid)&&this.startChat(obj.connectionid);var peerConnectionInfo=this.getPeerConnectionInfo(obj.connectionid);if(null!=peerConnectionInfo&&peerConnectionInfo.pc!==!1){var errorCallback=function(err){this.videoChatAPI.updateLogMessage("[WEBRTC] onMessage errorCallback called : "+err),this.videoChatAPI.sendStopChatRequest(this.zuid,VideoConstants.ERROR,"ErrorInSetRemoteDescription : "+err)}.bind(this),addCandidates=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] addCandidates : "+VideoChatUtil.stringifyJSON(peerConnectionInfo.remoteCandidates));for(var addIceCandidateSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] Ice Candidates added successfully")}.bind(this),i=0;i<peerConnectionInfo.remoteCandidates.length;i++)peerConnectionInfo.pc.addIceCandidate(new this.RTCIceCandidate(VideoChatUtil.parseJSON(peerConnectionInfo.remoteCandidates[i])),addIceCandidateSuccessCallback,errorCallback);peerConnectionInfo.remoteCandidates=new Array}.bind(this);if(obj.sessiondesc){var localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] local description set successfully"),this.sendSignalsPeriodically(peerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_MSG)}.bind(this),createAnswerSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[WEBRTC] createAnswerSuccessCallback setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),peerConnectionInfo.localDesc=desc,Drizzle.browser.safari?peerConnectionInfo.pc.setLocalDescription(desc).then(localDescSuccessCallback).catch(errorCallback):peerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this),remoteDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] remote description set successfully"),"offer"===peerConnectionInfo.pc.remoteDescription.type&&(Drizzle.browser.safari?peerConnectionInfo.pc.createAnswer().then(createAnswerSuccessCallback).catch(errorCallback):peerConnectionInfo.pc.createAnswer(createAnswerSuccessCallback,errorCallback)),peerConnectionInfo.remoteCandidates.push.apply(peerConnectionInfo.remoteCandidates,obj.candidates),addCandidates()}.bind(this),rtcSessionDescriptionInit={};rtcSessionDescriptionInit.type=obj.sessiondesc.type,rtcSessionDescriptionInit.sdp=obj.sessiondesc.sdp;var desc=new this.RTCSessionDescription(rtcSessionDescriptionInit);Drizzle.browser.mozilla&&Drizzle.browser.version>56&&(desc={}),desc.sdp=obj.sessiondesc.sdp,desc.type=obj.sessiondesc.type,peerConnectionInfo.remoteDesc=desc,this.videoChatAPI.updateLogMessage("[WEBRTC] setRemoteDescription : "+VideoChatUtil.stringifyJSON(desc)),Drizzle.browser.safari?peerConnectionInfo.pc.setRemoteDescription(desc).then(remoteDescSuccessCallback).catch(errorCallback):peerConnectionInfo.pc.setRemoteDescription(desc,remoteDescSuccessCallback,errorCallback)}else obj.candidates&&(peerConnectionInfo.remoteCandidates.push.apply(peerConnectionInfo.remoteCandidates,obj.candidates),peerConnectionInfo.remoteDesc&&addCandidates())}},VideoChatWebRTC.prototype.previousPeerConnectionInfoClearedAndSendDisconnectNotify=function(peerConnectionInfo){if(this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState="started",this.zuid),0!=this.videoChatAPI.disconnectsound){var playPromise=this.videoChatAPI.disconnectsound.play();void 0!==playPromise&&playPromise.then(function(){}).catch(function(){})}this.reconnectionId=this.reconnectionId+1,this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState);var conn_id=peerConnectionInfo.connectionId;this.isPreviousPeerConnectionInfoListCleared===!1&&(peerConnectionInfo.pc.close(),this.peerConnectionInfoList=new Array,this.isPreviousPeerConnectionInfoListCleared=!0),this.tryToSendDisconnectNotify(conn_id,this.reconnectionId)},VideoChatWebRTC.prototype.sendSignalsPeriodically=function(peerConnectionInfo,action){var periodic=function(peerConnectionInfo,action){this.sendSignals(peerConnectionInfo,action),peerConnectionInfo.endICE!==!0&&(peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=setTimeout(function(){periodic(peerConnectionInfo,action)},200))}.bind(this);peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=setTimeout(function(){periodic(peerConnectionInfo,action)},200)},VideoChatWebRTC.prototype.sendSignals=function(peerConnectionInfo,action){var sendObj={};sendObj.action=action.toString(),sendObj.reconnectionid=this.reconnectionId.toString(),peerConnectionInfo.localDesc&&(sendObj.sessiondesc={},sendObj.sessiondesc.sdp=peerConnectionInfo.localDesc.sdp.replace(/IP6 ::/g,"IP4 0.0.0.0"),sendObj.sessiondesc.type=peerConnectionInfo.localDesc.type,delete peerConnectionInfo.localDesc),peerConnectionInfo.localCandidates.length>0&&(sendObj.candidates=peerConnectionInfo.localCandidates,peerConnectionInfo.localCandidates=new Array),peerConnectionInfo.renegotiate&&(sendObj.renegotiate=peerConnectionInfo.renegotiate,delete peerConnectionInfo.renegotiate),(sendObj.sessiondesc||sendObj.candidates||sendObj.renegotiate)&&(sendObj.connectionid=peerConnectionInfo.connectionId,this.videoChatAPI.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON(sendObj),this.zuid))},VideoChatWebRTC.prototype.tryToSendDisconnectNotify=function(connId,reconnection_id){if(this.reconnectionTime>=3e5)return this.reconnectionState="failed",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState,this.zuid),void this.videoChatAPI.sendStopChatRequest(this.zuid,VideoConstants.ERROR,"ErrorInReconnectionTimeout");var func=function(connId,reconnection_id){this.disconnectNotifyTimer=setTimeout(function(){if(this.videoChatAPI.disconnectsound&&"connected"!=this.reconnectionState){var playPromise=this.videoChatAPI.disconnectsound.play();void 0!==playPromise&&playPromise.then(function(){}).catch(function(){})}"started"==this.reconnectionState&&(this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState="in_progress",this.zuid),this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState)),0!=this.videoChatAPI.getSessionId()&&this.tryToSendDisconnectNotify(connId,reconnection_id),this.reconnectionTime=this.reconnectionTime+5e3}.bind(this),5e3)}.bind(this);navigator.onLine===!0&&VideoChatContainer.getWmsServerUpStatus()===!0?this.isAlreadyProcessedReconnectionId(reconnection_id)===!1&&(this.videoChatAPI.sendDisconnectNotify(this.zuid,reconnection_id),func(connId,reconnection_id)):func(connId,reconnection_id)},VideoChatWebRTC.prototype.stopDisconnectNotifyTimer=function(){0!=this.disconnectNotifyTimer&&(this.videoChatAPI.updateLogMessage("[RECONNECTION_STATE] reconnection stopped."),clearTimeout(this.disconnectNotifyTimer),this.disconnectNotifyTimer=!1)},VideoChatWebRTC.prototype.reconnection=function(connId,reconnection_id){if(this.videoChatAPI.updateLogMessage("[WEBRTC] reconnection : connectionId="+connId+",reconnectionId="+reconnection_id),this.processedReconnectionIdList.push(reconnection_id),this.reconnectionId=parseInt(reconnection_id),this.releaseAllMonitorRemoteStreamVariables(),this.isPreviousPeerConnectionInfoListCleared===!1){var peerconnectionInfo=this.getPeerConnectionInfo(connId);peerconnectionInfo.pc.close(),this.peerConnectionInfoList=new Array,this.isPreviousPeerConnectionInfoListCleared=!0}1==this.isOffer&&this.startChat(connId),this.isPreviousPeerConnectionInfoListCleared=!1,this.reconnectionTime=0},VideoChatWebRTC.prototype.getPeerConnectionInfo=function(connectionId){for(var i=0;i<this.peerConnectionInfoList.length;i++)if(this.peerConnectionInfoList[i].connectionId===connectionId)return this.peerConnectionInfoList[i];return null},VideoChatWebRTC.prototype.removeUselessPeerConnection=function(correctConnectionId){for(var i=0;i<this.peerConnectionInfoList.length;i++)this.peerConnectionInfoList[i].connectionId!==correctConnectionId&&(this.peerConnectionInfoList[i].pc.close(),this.peerConnectionInfoList[i].remoteStream=!1,this.peerConnectionInfoList[i].isWebrtcConnected=!1,this.peerConnectionInfoList.splice(i,1),i--)},VideoChatWebRTC.prototype.connect=function(peerConnectionInfo){var errorCallback=function(err){this.videoChatAPI.sendStopChatRequest(this.zuid,VideoConstants.ERROR,"ErrorInSetLocalDescription : "+err)}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] local description set successfully"),this.sendSignalsPeriodically(peerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_MSG)}.bind(this);peerConnectionInfo.localDesc!==!1&&(this.videoChatAPI.updateLogMessage("[WEBRTC] setLocalDescription : "+VideoChatUtil.stringifyJSON(peerConnectionInfo.localDesc)),Drizzle.browser.safari?peerConnectionInfo.pc.setLocalDescription(peerConnectionInfo.localDesc).then(localDescSuccessCallback).catch(errorCallback):peerConnectionInfo.pc.setLocalDescription(peerConnectionInfo.localDesc,localDescSuccessCallback,errorCallback))},VideoChatWebRTC.prototype.remoteUserAnswered=function(connectionId){this.activeConnectionId=connectionId,this.chatAnswered=!0,1==this.videoChatAPI.getRemoteParticipants().length&&this.currentParticipant.micOn();var peerConnectionInfo=this.getPeerConnectionInfo(connectionId);null!==peerConnectionInfo&&peerConnectionInfo.isWebrtcConnected===!0&&(Drizzle.browser.chrome&&Drizzle.browser.version<=71&&peerConnectionInfo.pc.addStream(this.currentParticipant.getLocalStream()),this.videoChatAPI.sendlocalUserConnectedRequest(this.zuid)),this.removeUselessPeerConnection(connectionId)},VideoChatWebRTC.prototype.stopChat=function(){for(var i=0;i<this.peerConnectionInfoList.length;i++)this.peerConnectionInfoList[i].pc.close(),this.peerConnectionInfoList[i].remoteStream=!1,this.peerConnectionInfoList[i].isWebrtcConnected=!1;if(this.releaseAllMonitorRemoteStreamVariables(),this.reconnectionState=!1,this.videoChatAPI.videoChatHandler.handleReconnect(!1,this.zuid),"screen"===this.videoChatAPI.type){var p=this.videoChatAPI.getParticipant(this.zuid);p.videoChatScreenShare.stopChat()}},VideoChatWebRTC.prototype.setSpeakerStatus=function(status){this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] speaker is "+(status?"off":"on")),this.isSpeakerOff=status},VideoChatWebRTC.prototype.getSpeakerStatus=function(){return this.isSpeakerOff},VideoChatWebRTC.prototype.switchDevices=function(switchType){if(this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] Inside switchDevices"),!this.renegotiatingUser){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);if(1!=Drizzle.browser.mozilla||"videoToScreen"!=switchType&&"screenToVideo"!=switchType)if(this.renegotiatingUser=VideoChatContainer.getCurrentUserZuid(),Drizzle.browser.chrome===!0||Drizzle.browser.safari===!0||Drizzle.browser.edge===!0?Drizzle.browser.safari?(activePeerConnectionInfo.pc.removeTrack(activePeerConnectionInfo.pc.getSenders()[0]),this.currentParticipant.getLocalStream().getTracks().forEach(function(track){activePeerConnectionInfo.pc.addTrack(track,this.currentParticipant.getLocalStream())}.bind(this))):(activePeerConnectionInfo.pc.removeStream(this.currentParticipant.getLocalStream()),activePeerConnectionInfo.pc.addStream(this.currentParticipant.getLocalStream())):this.currentParticipant.getLocalStream().getVideoTracks().forEach(function(track){activePeerConnectionInfo.pc.addTrack(track,this.currentParticipant.getLocalStream())}.bind(this)),1==this.isOffer){var renegotiate={};renegotiate.status="started",this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] "+renegotiate.status),this.videoChatAPI.videoChatHandler.handleSwitchingDevices(renegotiate.status,this.zuid),activePeerConnectionInfo.renegotiate=renegotiate,this.startRenegotiate()}else{var renegotiate={};renegotiate.status="start",this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] "+renegotiate.status),this.videoChatAPI.videoChatHandler.handleSwitchingDevices(renegotiate.status,this.zuid),activePeerConnectionInfo.renegotiate=renegotiate,this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}else{var videoTrack=this.currentParticipant.getLocalStream().getVideoTracks()[0];activePeerConnectionInfo.pc.getSenders().forEach(function(rtpSender){rtpSender.track instanceof VideoStreamTrack&&rtpSender.replaceTrack(videoTrack)}),this.videoChatAPI.videoChatHandler.handleSwitchingDevices("start",this.zuid)}}},VideoChatWebRTC.prototype.startRenegotiate=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] Inside startRenegotiate");var mediaConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!0};"voice"==this.videoChatAPI.getChatType()&&(mediaConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!1});var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId),errorCallback=function(err){this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] Renegotiation failed. "+err),delete activePeerConnectionInfo.localDesc,this.completeRenegotiation("failed")}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] local description set successfully"),this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}.bind(this),createOfferSuccessCallback=function(desc){if(Drizzle.browser.edge){for(var protocol=window.location.protocol.replace("s",""),string="a=extmap:1 "+protocol+"//www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\n",re=new RegExp(string,"g"),count=desc.sdp.match(re).length,removeString="",i=0;count-1>i;i++)removeString+=string;desc.sdp=desc.sdp.replace(removeString,string)}this.videoChatAPI.updateLogMessage("[WEBRTC] Create Offer Success. setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),activePeerConnectionInfo.localDesc=desc,Drizzle.browser.safari?activePeerConnectionInfo.pc.setLocalDescription(desc).then(localDescSuccessCallback).catch(errorCallback):activePeerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this);Drizzle.browser.safari===!0&&(activePeerConnectionInfo.pc.addTransceiver("audio"),activePeerConnectionInfo.pc.addTransceiver("video")),Drizzle.browser.safari?activePeerConnectionInfo.pc.createOffer(mediaConstraints).then(createOfferSuccessCallback).catch(errorCallback):activePeerConnectionInfo.pc.createOffer(createOfferSuccessCallback,errorCallback,mediaConstraints)},VideoChatWebRTC.prototype.onRenegotiate=function(obj){if(this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] Inside onRenegotiate"),obj.renegotiate)if("start"==obj.renegotiate.status)this.renegotiatingUser=this.zuid,this.startRenegotiate();else if("started"==obj.renegotiate.status)this.renegotiatingUser=this.zuid;else if("completed"==obj.renegotiate.status)this.renegotiatingUser=!1;else if("failed"==obj.renegotiate.status)return this.renegotiatingUser===VideoChatContainer.getCurrentUserZuid()&&(this.currentParticipant.cameraOff(),this.videoChatAPI.videoChatHandler.handleSwitchingDevices(obj.renegotiate.status,this.zuid)),void(this.renegotiatingUser=!1);if(obj.sessiondesc){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId),errorCallback=function(err){this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] renegotiation failed. "+err),delete activePeerConnectionInfo.localDesc,this.completeRenegotiation("failed")}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] local description set successfully"),this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}.bind(this),createAnswerSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[WEBRTC] Create Answer success. setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),activePeerConnectionInfo.localDesc=desc,Drizzle.browser.safari?activePeerConnectionInfo.pc.setLocalDescription(desc).then(localDescSuccessCallback).catch(errorCallback):activePeerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this),remoteDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[WEBRTC] Remote description set successfully"),"offer"===activePeerConnectionInfo.pc.remoteDescription.type&&(Drizzle.browser.safari?activePeerConnectionInfo.pc.createAnswer().then(createAnswerSuccessCallback).catch(errorCallback):activePeerConnectionInfo.pc.createAnswer(createAnswerSuccessCallback,errorCallback))}.bind(this),rtcSessionDescriptionInit={};rtcSessionDescriptionInit.type=obj.sessiondesc.type,rtcSessionDescriptionInit.sdp=obj.sessiondesc.sdp;var desc=new this.RTCSessionDescription(rtcSessionDescriptionInit);Drizzle.browser.mozilla&&Drizzle.browser.version>56&&(desc={}),desc.sdp=obj.sessiondesc.sdp,desc.type=obj.sessiondesc.type,activePeerConnectionInfo.remoteDesc=desc,this.videoChatAPI.updateLogMessage("[WEBRTC] [REMOTE_DESC] "+VideoChatUtil.stringifyJSON(desc)),Drizzle.browser.safari?activePeerConnectionInfo.pc.setRemoteDescription(desc).then(remoteDescSuccessCallback).catch(errorCallback):activePeerConnectionInfo.pc.setRemoteDescription(desc,remoteDescSuccessCallback,errorCallback)}},VideoChatWebRTC.prototype.completeRenegotiation=function(status){this.videoChatAPI.updateLogMessage("[WEBRTC] [RENEGOTIATION] "+status);var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);if("completed"==status){if(this.videoChatAPI.videoChatHandler.handleSwitchingDevices(status,this.zuid),this.renegotiatingUser!=VideoChatContainer.getCurrentUserZuid()){this.renegotiatingUser=!1;var renegotiate={};renegotiate.status="completed",activePeerConnectionInfo.renegotiate=renegotiate,this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}}else if("failed"==status){this.renegotiatingUser===VideoChatContainer.getCurrentUserZuid()&&(this.currentParticipant.cameraOff(),this.videoChatAPI.videoChatHandler.handleSwitchingDevices(status,this.zuid)),this.renegotiatingUser=!1;var renegotiate={};renegotiate.status="failed",activePeerConnectionInfo.renegotiate=renegotiate,this.sendSignals(activePeerConnectionInfo,VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)}},VideoChatWebRTC.prototype.releaseAllMonitorRemoteStreamVariables=function(){this.audioCtx&&(this.audioCtx.close(),this.audioCtx=!1),this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=!1),this.scriptNode&&(this.scriptNode.disconnect(),this.scriptNode=!1),this.remoteSourceNode&&(this.remoteSourceNode.disconnect(),this.remoteSourceNode=!1),this.remoteAnalyser&&(this.remoteAnalyser.disconnect(),this.remoteAnalyser=!1)},VideoChatWebRTC.prototype.isAlreadyProcessedReconnectionId=function(reconnection_id){for(var i=0;i<this.processedReconnectionIdList.length;i++)if(this.processedReconnectionIdList[i]==reconnection_id)return!0;return!1},VideoChatWebRTC.prototype.monitorAudioFrequency=function(){var updateAudioFrequency=function(){if(this.remoteAnalyser){var value=0!=this.currentRemoteFrequency?"T":0==this.videoChatAPI.getRemoteMicStatus(this.zuid)?"F":"-";this.remoteFrequency+=value,setTimeout(updateAudioFrequency,2e3)}}.bind(this),monitorFrequency=function(){if(this.remoteAnalyser){var remoteByteData=new Uint8Array(this.remoteAnalyser.frequencyBinCount);this.remoteAnalyser.getByteFrequencyData(remoteByteData);var maxRemoteFreq=Math.max.apply(null,remoteByteData);this.currentRemoteFrequency=maxRemoteFreq,requestAnimationFrame(monitorFrequency)}}.bind(this),activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);this.remoteSourceNode=this.audioCtx.createMediaStreamSource(activePeerConnectionInfo.remoteStream),this.remoteAnalyser=this.audioCtx.createAnalyser(),this.remoteSourceNode.connect(this.remoteAnalyser),this.remoteAnalyser.connect(this.destNode),setTimeout(function(){monitorFrequency(),updateAudioFrequency()},1e3)},VideoChatWebRTC.prototype.monitorRemoteStream=function(){var func=function(){var emptyDataTime=0,activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.sourceNode=this.audioCtx.createMediaStreamSource(activePeerConnectionInfo.remoteStream),this.scriptNode=this.audioCtx.createScriptProcessor(16384,this.sourceNode.channelCount,this.sourceNode.channelCount),this.destNode=this.audioCtx.createMediaStreamDestination(),this.sourceNode.connect(this.scriptNode),this.scriptNode.connect(this.destNode),this.monitorAudioFrequency();var time=(new Date).getTime();this.scriptNode.onaudioprocess=function(evt){for(var currentTime=(new Date).getTime(),inputBuffer=evt.inputBuffer,emptyData=!0,i=0;i<inputBuffer.numberOfChannels;i++){for(var inputData=inputBuffer.getChannelData(i),j=0;j<inputBuffer.length;j++)if(0!=inputData[j]){this.webrtcFailed===!1&&0!=this.reconnectionState&&"connected"!=this.reconnectionState&&(this.reconnectionState="connected",this.videoChatAPI.updateLogMessage("[WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleReconnect(this.reconnectionState,this.zuid)),time=currentTime,emptyData=!1,emptyDataTime=0;break}if(!emptyData)break}}.bind(this)}.bind(this);setTimeout(func,1e3)},VideoChatWebRTC.prototype.getRemoteSrc=function(){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);return activePeerConnectionInfo.remoteStream?window.URL.createObjectURL(activePeerConnectionInfo.remoteStream):!1},VideoChatWebRTC.prototype.getRemoteStream=function(){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);return activePeerConnectionInfo.remoteStream},VideoChatWebRTC.prototype.getReconnectionId=function(){return this.reconnectionId},VideoChatWebRTC.prototype.getAndSendConnectionDetails=function(){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId),peerConnection=activePeerConnectionInfo.pc,connectionDetails={},connectionPromise=!1;if(Drizzle.browser.chrome){var reqFields=["googLocalAddress","googLocalCandidateType","googRemoteAddress","googRemoteCandidateType"],filtered=!1;connectionPromise=new Promise(function(resolve,reject){function getActiveConnection(e){return(0==e.id.indexOf("Conn-audio")||0==e.id.indexOf("Conn-sdparta")||0==e.id.indexOf("Conn-0"))&&"true"==e.stat("googActiveConnection")}function callback(stats){if(filtered=stats.result().filter(getActiveConnection)[0],!filtered)return void reject(connectionDetails);for(var i=0;i<reqFields.length;i++)connectionDetails[reqFields[i].replace("goog","")]=filtered.stat(reqFields[i]);resolve(connectionDetails)}peerConnection.getStats(callback)})}else{var selectedCandidatePair=!1;connectionPromise=new Promise(function(resolve,reject){peerConnection.getStats(null).then(function(stats){if(stats.forEach(function(stat){void 0!=stat.selected&&1==stat.selected&&(selectedCandidatePair=stat)}),!selectedCandidatePair)return void reject(connectionDetails);var localICEObjectId=selectedCandidatePair.localCandidateId,remoteICEObjectId=selectedCandidatePair.remoteCandidateId;stats.forEach(function(stat){var ip=stat.ipAddress||stat.address,port=stat.portNumber||stat.port;stat.id==localICEObjectId?(connectionDetails.LocalAddress=ip+":"+port,connectionDetails.LocalCandidateType=stat.candidateType):stat.id==remoteICEObjectId&&(connectionDetails.RemoteAddress=ip+":"+port,connectionDetails.RemoteCandidateType=stat.candidateType)}),resolve(connectionDetails)})})}var videochatapiObject=this.videoChatAPI,videowebrtcObject=this;connectionPromise.then(function(val){videochatapiObject.sendConnectionDetails(val,videowebrtcObject.reconnectionId)},function(){videowebrtcObject.getAndSendConnectionDetails()})},VideoChatWebRTC.prototype.printFrequency=function(){this.videoChatAPI.updateLogMessage("[REMOTE_FREQUENCY] zuid="+this.zuid+" "+this.remoteFrequency)},VideoChatWebRTC.prototype.getPeerconnectionPacketsInfo=function(){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);if(0!=this.videoChatAPI.getSessionId()&&null!=activePeerConnectionInfo){var peerConnection=activePeerConnectionInfo.pc,connectionPromise=!1,packetsDetails={};if(Drizzle.browser.chrome)connectionPromise=new Promise(function(resolve,reject){function getActiveConnection(e){return(0==e.id.indexOf("Conn-audio")||0==e.id.indexOf("Conn-sdparta")||0==e.id.indexOf("Conn-0"))&&"true"==e.stat("googActiveConnection")}function callback(stats){var filtered=stats.result().filter(getActiveConnection)[0];return filtered?(packetsDetails.time=(new Date).getTime(),packetsDetails.bytesReceived=filtered.stat("bytesReceived"),packetsDetails.bytesSent=filtered.stat("bytesSent"),void resolve(packetsDetails)):void reject(packetsDetails)}peerConnection.getStats(callback)});else{var selectedCandidatePair=!1;connectionPromise=new Promise(function(resolve,reject){peerConnection.getStats(null).then(function(stats){return stats.forEach(function(stat){void 0!=stat.selected&&1==stat.selected&&(selectedCandidatePair=stat)}),selectedCandidatePair?(packetsDetails.time=(new Date).getTime(),packetsDetails.bytesReceived=selectedCandidatePair.bytesReceived,packetsDetails.bytesSent=selectedCandidatePair.bytesSent,receivers=peerConnection.getReceivers(),void resolve(packetsDetails)):void reject(packetsDetails)})})}var videochatapiObject=this.videoChatAPI,videowebrtcObject=this;connectionPromise.then(function(val){videowebrtcObject.addPeerConnectionPacketsInfo(val),setTimeout(videowebrtcObject.getPeerconnectionPacketsInfo.bind(videowebrtcObject),1e4)},function(){videochatapiObject.updateLogMessage("[PACKET_INFO] Packect promise Rejected"),0==videowebrtcObject.packetInfoPromiseRejected&&(setTimeout(videowebrtcObject.getPeerconnectionPacketsInfo.bind(videowebrtcObject),1e4),videowebrtcObject.packetInfoPromiseRejected=!0)})}},VideoChatWebRTC.prototype.getPeerconnectionStats=function(){var activePeerConnectionInfo=this.getPeerConnectionInfo(this.activeConnectionId);if(0!=this.videoChatAPI.getSessionId()&&null!=activePeerConnectionInfo){var peerConnection=activePeerConnectionInfo.pc;"undefined"!=typeof ZVPStatsGatherer&&ZVPStatsGatherer.intiateStatsPolling(peerConnection,this.videoChatAPI.getSessionId())}},VideoChatWebRTC.prototype.addPeerConnectionPacketsInfo=function(value){this.peerConnectionPacketsInfo.push(value)},VideoChatWebRTC.prototype.getRemoteVideoEnabled=function(){return this.remoteVideoEnabled},VideoChatWebRTC.prototype.setRemoteVideoEnabled=function(value){this.remoteVideoEnabled=value},VideoChatAPI.prototype.setOwnerZuid=function(zuid){this.ownerZuid=zuid},VideoChatAPI.prototype.getOwnerZuid=function(){return this.ownerZuid?this.ownerZuid:this.callingZuid},VideoChatAPI.prototype.isGroupChatEnabled=function(){return this.groupChatEnabled},VideoChatAPI.prototype.setGroupChatEnabled=function(value){this.groupChatEnabled=value},VideoChatAPI.prototype.init=function(_callingZuid,_calledZuid,_type,_chatUserName,_iceServers,_otherServiceProps,_videoChatHandler,log){this.callingZuid=_callingZuid,this.calledZuid=_calledZuid,this.type=_type,this.currentParticipant=new VideoChatLocalParticipant(this.videoChatDivId),this.currentParticipant.init();var remoteParticipant=new VideoChatRemoteParticipant(this.videoChatDivId);remoteParticipant.setZuid(this.getChatUserId()),0==this.isLoggedInUserIsOwner()&&(remoteParticipant.videoChatWebRTC.isOffer=!0),remoteParticipant.videoChatWebRTC.zuid=remoteParticipant.getZuid(),remoteParticipant.videoChatScreenShare.zuid=remoteParticipant.getZuid(),remoteParticipant.setUserName(_chatUserName),this.addParticipant(remoteParticipant),"video"==this.type&&(this.isVideoEnabled=!0),this.videoChatHandler=_videoChatHandler,this.chatLogs="",void 0!=log&&0!=log&&(this.chatLogs=log,this.chatLogs=this.chatLogs.replace(/\\n/g,"\n")),0!=_otherServiceProps&&(this.otherServiceProps=VideoChatUtil.stringifyJSON(_otherServiceProps));var func=function(){this.stopChatSendBeacon()}.bind(this);Drizzle(window).bind("unload",func),this.currentParticipant.setICEServers(_iceServers);var nocache=(new Date).getTime();this.feedbacksound=document.createElement("audio"),this.feedbacksound.id="feedbacksound",this.feedbacksound.src=VideoChatContainer.getVideoServerLocation()+"/sound/feedback.mp3?nocache="+nocache,this.feedbacksound.loop=!0,this.waitingsound=document.createElement("audio"),this.waitingsound.id="waitingsound",this.waitingsound.src=VideoChatContainer.getVideoServerLocation()+"/sound/waiting.mp3?nocache="+nocache,this.waitingsound.loop=!0,this.endsound=document.createElement("audio"),this.endsound.id="endsound",this.endsound.src=VideoChatContainer.getVideoServerLocation()+"/sound/call_end.mp3?nocache="+nocache,this.disconnectsound=document.createElement("audio"),this.disconnectsound.id="reconnect",this.disconnectsound.src=VideoChatContainer.getVideoServerLocation()+"/sound/reconnect.mp3?nocache="+nocache,this.videoChatHandler.setVideoChatAPI(this),Drizzle.browser.safari===!0&&Drizzle(window).bind("click",function(){var silent=document.createElement("audio");silent.src=VideoChatContainer.getVideoServerLocation()+"/sound/silent.mp3?nocache="+nocache,silent.play(),Drizzle(window).unbind("click")}),"screen"==this.type&&(this.addingMode=!0),this.currentParticipant.printAvailableDevices();var callback=function(data,useragent){this.updateConnectionStats(data,useragent)}.bind(this);"undefined"!=typeof ZVPStatsGatherer&&0==this.otherServiceProps&&ZVPStatsGatherer.initialize(callback)},VideoChatAPI.prototype.startTimer=function(time,zuid){var func=function(){this.sendStopChatRequest(zuid,VideoConstants.NO_RESPONSE)}.bind(this);this.REQUESTCHAT_TIMEOUT_FUNC=setTimeout(func,time)},VideoChatAPI.prototype.stopTimer=function(){clearTimeout(this.REQUESTCHAT_TIMEOUT_FUNC)},VideoChatAPI.prototype.sendRequestChatRequest=function(){var p=this.getParticipant(this.calledZuid),callback=function(obj){if(this.updateLogMessage("[RESPONSE] [CHAT_REQUEST] "+VideoChatUtil.stringifyJSON(obj)),"ERROR"===obj.STATUS||"INVALID"===obj.STATUS||"NO_ACCOUNT"===obj.STATUS)return this.waitingsound&&this.waitingsound.pause(),this.feedbacksound&&this.feedbacksound.pause(),this.sendFeedback(VideoConstants.ERROR,"ErrorInRequestChat"),"screen"===this.type&&this.currentParticipant.screenStopChat(),void this.videoChatHandler.handleVideoError(obj.STATUS,obj.REASON,obj.MESSAGE);if(this.waitingsound&&p.isChatReceived()===!1){var playPromise=this.waitingsound.play();void 0!==playPromise&&playPromise.then(function(){}).catch(function(){})}this.chatStarted=!0,this.currentParticipant.setICEServers(obj.ICE_SERVERS),this.setSessionId(obj.SESSION_ID),VideoChatContainer.getUseWebSocket()===!0&&VideoChatWebSocket.setSessionId(obj.SESSION_ID),0==this.getLocalStream()&&this.sendStopChatRequest(VideoChatContainer.getCurrentUserZuid(),VideoConstants.CANCELLED),this.videoChatHandler.handleSessionId(obj.SESSION_ID),VideoChatContainer.checkUnhandledMessage(this.videoChatDivId,obj.SESSION_ID)}.bind(this),params="calledzuid="+this.calledZuid+"&type="+this.type;if(this.otherServiceProps&&(params=params+"&otherserviceprops="+this.otherServiceProps),this.appName&&(params=params+"&appname="+this.appName),this.updateLogMessage("[REQUEST] /requestchat.do?"+params),VideoChatContainer.postRequest("CHAT_REQUEST",params,callback),0!=this.feedbacksound&&p.isChatReceived()===!0){var playPromise=this.feedbacksound.play();void 0!==playPromise&&playPromise.then(function(){}).catch(function(){})}},VideoChatAPI.prototype.sendStartChatRequest=function(){for(var connectionsInfo=new Array,participants=this.getRemoteParticipants(),i=0;i<participants.length;i++){var p=participants[i],connection={};connection.zuid=p.getZuid(),connection.connectionId=p.getConnectionId(),connectionsInfo.push(connection)}if(VideoChatContainer.getUseWebSocket()===!0&&1==VideoChatWebSocket.getWebSocketUpStatus()){var sendmsg={};sendmsg.ACTION="START_CHAT",sendmsg.CALLINGZUID=this.getOwnerZuid(),sendmsg.SESSIONID=this.sessionId,sendmsg.CALLEDZUID=this.calledZuid,sendmsg.USERAGENT=navigator.userAgent,sendmsg.MSGID=(new Date).getTime(),sendmsg.CONNECTIONS_INFO=VideoChatUtil.stringifyJSON(connectionsInfo),VideoChatWebSocket.sendMessage(sendmsg)}else{var callback=function(obj){return this.updateLogMessage("[RESPONSE] [START_CHAT]"+VideoChatUtil.stringifyJSON(obj)),"SUCCESS"!==obj.STATUS?(this.sendFeedback(VideoConstants.ERROR,"ErrorInStartChat"),"INVALID"===obj.STATUS?void this.stop(VideoConstants.ERROR):void this.videoChatHandler.handleVideoError(obj.STATUS)):void 0}.bind(this),params="callingzuid="+this.getOwnerZuid()+"&sessionid="+this.sessionId+"&connectionsinfo="+VideoChatUtil.stringifyJSON(connectionsInfo);this.updateLogMessage("[REQUEST] /startchat.do?"+params),VideoChatContainer.postRequest("START_CHAT",params,callback)}},VideoChatAPI.prototype.stopChatSendBeacon=function(){var remoteParticipants=this.getRemoteParticipants(),currentZuid=VideoChatContainer.getCurrentUserZuid(),reason=VideoConstants.COMPLETED;if(this.chatStarted!==!1){0==this.chatAnswered&&(reason=this.isLoggedInUserIsOwner()&&remoteParticipants.length<=1?VideoConstants.CANCELLED:VideoConstants.REJECTED),this.updateLogMessage("[BEACON] Chat Window closed");var ua=navigator.userAgent.toLowerCase();if(navigator.sendBeacon&&-1==ua.indexOf("zohomail-nativedesktop")){this.chatStarted=!1;var fd=new FormData,csrfSplit=VideoChatContainer.getCSRF().split("=");fd.append(csrfSplit[0],csrfSplit[1]),fd.append("callingzuid",this.getOwnerZuid()),fd.append("calledzuid",this.calledZuid),fd.append("status",reason),fd.append("sessionid",this.sessionId),fd.append("leavingzuid",currentZuid),this.printFrequency(),this.updateLogMessage("[REQUEST] /stopchat.do?callingzuid="+this.callingZuid+"&calledzuid="+this.calledZuid+"&status="+reason+"&sessionid="+this.sessionId),navigator.sendBeacon("/stopchat.do",fd),fd=new FormData,reason==VideoConstants.COMPLETED&&0==this.getChatRunningTime()&&(reason=VideoConstants.ERROR);var subject=this.getSubject(reason),description=this.getDescription(reason,!1);description=description?description:"Chat window closed",fd.append(csrfSplit[0],csrfSplit[1]),fd.append("subject",subject),fd.append("message",description),fd.append("logmessage",this.chatLogs),fd.append("criticalrequest",2),fd.append("sessionid",this.sessionId);var p=this.getRemoteParticipants()[0];p.videoChatWebRTC.peerConnectionPacketsInfo.length>0&&fd.append("packetsinfo",VideoChatUtil.stringifyJSON(p.videoChatWebRTC.peerConnectionPacketsInfo)),navigator.sendBeacon("/sendfeedback.do",fd)}else this.sendStopChatRequest(currentZuid,reason)}},VideoChatAPI.prototype.isConnectedParticipant=function(zuid){for(var i=0;i<this.connectedParticipants.length;i++)if(this.connectedParticipants[i]==zuid)return!0;return!1},VideoChatAPI.prototype.sendStopChatRequest=function(zuid,reason,error_status){var params="callingzuid="+this.getOwnerZuid()+"&calledzuid="+this.calledZuid+"&status="+reason+"&sessionid="+this.sessionId+"&leavingzuid="+zuid;void 0!=error_status&&(params=params+"&errorstatus="+error_status),0!=this.sessionId&&(this.updateLogMessage("[REQUEST] /stopchat.do?"+params),VideoChatContainer.postRequest("STOP_CHAT",params));var closeSession=!0;if(this.getRemoteParticipants().length<=1||VideoChatContainer.getCurrentUserZuid()==zuid?closeSession=!0:(this.getConnectedParticipants().length>1||0==this.isConnectedParticipant(zuid))&&(closeSession=!1),1==closeSession){if(this.chatStarted===!1&&reason!==VideoConstants.NO_WEBRTC){this.currentParticipant.stopChat();for(var i=0;i<this.remoteParticipants.length;i++)this.remoteParticipants[i].videoChatWebRTC.stopChat();return}this.chatStarted=!1,this.printFrequency(),this.sendFeedback(reason,error_status),this.stop(reason)}else this.removeParticipant(zuid,reason)},VideoChatAPI.prototype.removeParticipant=function(zuid,reason){this.videoChatHandler.handleCloseRequest(reason,zuid);var p=this.getParticipant(zuid);p.videoChatWebRTC.printFrequency(),p.setTimerStarted(!1),this.removeConnectedParticipant(zuid),this.stopTimer();for(var i=0;i<this.remoteParticipants.length;i++)if(this.remoteParticipants[i].getZuid()==zuid){this.remoteParticipants[i].videoChatWebRTC.stopChat(),this.remoteParticipants[i].videoChatScreenShare.stopChat(),this.remoteParticipants[i].clear(),this.remoteParticipants.splice(i,1);break}this.waitingsound&&this.waitingsound.pause(),this.feedbacksound&&this.feedbacksound.pause()},VideoChatAPI.prototype.sendMessageSignalingRequest=function(msg,zuid){if(0!=this.sessionId)if(VideoChatContainer.getUseWebSocket()===!0&&1==VideoChatWebSocket.getWebSocketUpStatus()){var sendmsg={};sendmsg.ACTION="MESSAGE_SIGNALING",zuid&&(sendmsg.INFORMZUID=zuid),sendmsg.CALLINGZUID=this.getOwnerZuid(),sendmsg.SESSIONID=this.sessionId,sendmsg.MSG=msg,sendmsg.MSGID=(new Date).getTime(),VideoChatWebSocket.sendMessage(sendmsg)}else{var params="msg="+encodeURIComponent(msg)+"&callingzuid="+this.getOwnerZuid()+"&sessionid="+this.sessionId;zuid&&(params+="&informzuid="+zuid),this.updateLogMessage("[REQUEST] /messagesignaling.do?"+params),VideoChatContainer.postRequest("MESSAGE_SIGNALING",params)}},VideoChatAPI.prototype.sendConnectionDetails=function(msg,reconnectionId){msg=VideoChatUtil.stringifyJSON(msg);var params="sessionid="+this.sessionId+"&msg="+encodeURIComponent(msg)+"&reconnectionid="+reconnectionId;this.updateLogMessage("[REQUEST] /sendconnectiondetails.do?"+params),VideoChatContainer.postRequest("CONNECTION_DETAILS",params)},VideoChatAPI.prototype.remoteUserAnswered=function(connectionId,zuid){this.chatAnswered=!0;var p=this.getParticipant(zuid);p.setChatAnswered(!0),this.stopTimer(),this.waitingsound&&this.waitingsound.pause(),p.videoChatWebRTC.remoteUserAnswered(connectionId)},VideoChatAPI.prototype.handleChatAnswered=function(zuid){this.chatAnswered=!0,this.waitingsound&&this.waitingsound.pause(),this.stopTimer();var p=this.getParticipant(zuid);0==p.videoChatWebRTC.activeConnectionId&&this.startTimer(2e4,zuid),p.setChatAnswered(!0)},VideoChatAPI.prototype.displayRemote=function(zuid){var p=this.getParticipant(zuid);p.isLocalConnected()===!0&&p.isRemoteConnected()===!0&&(this.updateConnectedParticipants(zuid),this.videoChatHandler.handleRemoteStream(this.getRemoteStream(zuid),zuid),this.videoChatHandler.handleConnectNotify(zuid),0==p.isTimerStarted()&&(p.setTimerStarted(!0),this.updateChatRunningTime(p)),1!=Drizzle.browser.edge&&(this.currentParticipant.initLocalMonitor(),this.currentParticipant.monitorAudioFrequency(),p.videoChatWebRTC.monitorRemoteStream()),this.isLoggedInUserIsOwner()===!0&&this.getRemoteParticipants().length<=1&&1!=Drizzle.browser.safari&&1!=Drizzle.browser.edge&&setTimeout(function(){p.videoChatWebRTC.getAndSendConnectionDetails()}.bind(this),1e3),1!=Drizzle.browser.safari&&1!=Drizzle.browser.edge&&(p.videoChatWebRTC.getPeerconnectionPacketsInfo(),0==this.otherServiceProps&&p.videoChatWebRTC.getPeerconnectionStats()))},VideoChatAPI.prototype.sendlocalUserConnectedRequest=function(zuid){var p=this.getParticipant(zuid);if(p.setLocalConnected(!0),VideoChatContainer.getUseWebSocket()===!0&&1==VideoChatWebSocket.getWebSocketUpStatus()){var sendmsg={};sendmsg.ACTION="CONNECT_NOTIFY",sendmsg.INFORMZUID=zuid,sendmsg.CALLINGZUID=this.getOwnerZuid(),sendmsg.SESSIONID=this.sessionId,sendmsg.CONNECTIONID=p.getConnectionId(),sendmsg.PLATFORM="browser",sendmsg.MSGID=(new Date).getTime(),VideoChatWebSocket.sendMessage(sendmsg)}else params="informzuid="+zuid+"&callingzuid="+this.getOwnerZuid()+"&sessionid="+this.sessionId+"&connectionid="+p.getConnectionId(),this.updateLogMessage("[REQUEST] /connectnotify.do?"+params),VideoChatContainer.postRequest("CONNECT_NOTIFY",params);this.displayRemote(zuid)},VideoChatAPI.prototype.remoteUserConnected=function(zuid){this.feedbacksound&&this.feedbacksound.pause();var p=this.getParticipant(zuid);p.setRemoteConnected(!0),this.displayRemote(zuid)},VideoChatAPI.prototype.handleMessage=function(msg){this.updateLogMessage("[WMS_MESSAGE] "+VideoChatUtil.stringifyJSON(msg));var action=msg.ACTION;if("CHAT_ANSWERED"===action){if(VideoChatContainer.getCurrentUserZuid()==msg.SENDER_ID)return;var p=this.getParticipant(msg.SENDER_ID);this.setRemoteUserAgent(msg.USER_AGENT,p.getZuid()),this.videoChatHandler.handleChatAnswered(p.getZuid()),this.handleChatAnswered(p.getZuid()),("screen"===this.type||0!=this.getLocalScreenShareStream())&&setTimeout(function(){0===Object.keys(p.videoChatScreenShare.peerConnectionInfo).length&&p.videoChatScreenShare.setFirstScreenShareUser(!0),p.videoChatScreenShare.startScreenSharing()}.bind(this),2e3)}else if("CHAT_RECEIVED"===action){var p=this.getParticipant(msg.SENDER_ID);if(0==p)return;if(0!=p.getFromDevice()||0!=p.isChatAnswered()||"ios"!=msg.FROM&&"android"!=msg.FROM||(p.setFromDevice(msg.FROM),this.stopTimer(),this.startTimer(35e3,p.getZuid())),this.videoChatHandler.handleChatReceived(msg.SESSION_ID,p.getZuid()),!p.isChatAnswered()&&!p.isChatReceived()&&(this.waitingsound&&this.waitingsound.pause(),1==this.getRemoteParticipants().length&&this.feedbacksound)){var playPromise=this.feedbacksound.play();void 0!==playPromise&&playPromise.then(function(){}).catch(function(){})}p.setChatReceived(!0)}else if("START_CHAT_RESPONSE"===action){if("SUCCESS"!==msg.STATUS)return this.sendFeedback(VideoConstants.ERROR,"ErrorInStartChat"),"INVALID"===msg.STATUS?void this.stop(VideoConstants.ERROR):void this.videoChatHandler.handleVideoError(msg.STATUS)}else if("CONNECT_MEDIA"===action){var p=this.getParticipant(msg.SENDER_ID);p.setConnectionId(msg.CONNECTION_ID),this.remoteUserAnswered(msg.CONNECTION_ID,msg.SENDER_ID)}else if("CLOSE_REQUEST"===action){var zuid=msg.LEAVING_ZUID,closeSession=!0;if(this.getRemoteParticipants().length>1&&(this.getConnectedParticipants().length>1||0==this.isConnectedParticipant(zuid))&&(closeSession=!1),0==closeSession)return void(msg.NEW_REASON?this.removeParticipant(zuid,msg.NEW_REASON):this.removeParticipant(zuid,msg.REASON));0!=this.sessionId&&(this.removeConnectedParticipant(zuid),this.printFrequency(),msg.NEW_REASON?(this.sendFeedback(msg.NEW_REASON,!1),this.stop(msg.NEW_REASON)):(this.sendFeedback(msg.REASON,!1),this.stop(msg.REASON))),0==this.getRemoteParticipants().length&&this.endsound&&setTimeout(function(){var playPromise=this.endsound.play();void 0!==playPromise&&playPromise.then(function(){}).catch(function(){}),this.endsound=!1}.bind(this),500)}else if("CONNECT_NOTIFY"===action){var p=this.getParticipant(msg.SENDER_ID);p.setSwitchMode(msg.SWITCH_MODE),p.setScreenMode(msg.SCREEN_MODE),this.updateLogMessage("[MODE_DETAILS] zuid : "+p.getZuid()+" switchMode : "+p.getSwitchMode()+"    screenMode : "+p.getScreenMode()),this.remoteUserConnected(msg.SENDER_ID)}else if("MESSAGE_SIGNALING"===action){var p=this.getParticipant(msg.SENDER_ID),jsonObj=VideoChatUtil.parseJSON(msg.MESSAGE);if(jsonObj.action==VideoConstants.MESSAGE_WEBRTC_MSG){var msgId=msg.MSG_ID;if(0!=p.videoChatWebRTC.activeConnectionId&&jsonObj.connectionid!=p.videoChatWebRTC.activeConnectionId)return void this.updateLogMessage("[MESSAGE_WEBRTC_MSG] ConnectionId mismatched: active connectionId= "+p.videoChatWebRTC.activeConnectionId+" incoming connectionid = "+jsonObj.connectionid);p.videoChatWebRTC.onMessage(jsonObj,msgId)}else if(jsonObj.action==VideoConstants.MESSAGE_WEBRTC_RENEGOTIATION)p.videoChatWebRTC.onRenegotiate(jsonObj);else if(jsonObj.action==VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_MSG){var msgId=msg.MSG_ID;p.videoChatScreenShare.onMessage(jsonObj,msgId)}else jsonObj.action==VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_RENEGOTIATION?p.videoChatScreenShare.onRenegotiate(jsonObj):jsonObj.action==VideoConstants.MESSAGE_STATUS_MSG?(jsonObj.micStatus&&(this.updateLogMessage("[REMOTE_MEDIA_STATUS] Remote user's mic is "+(0==jsonObj.micStatus?"off":"on")),p.setRemoteMicStatus(jsonObj.micStatus),this.videoChatHandler.handleRemoteMediaStatus("mic",jsonObj.micStatus,p.getZuid())),jsonObj.cameraStatus&&(this.updateLogMessage("[REMOTE_MEDIA_STATUS] Remote user's camera is "+(0==jsonObj.cameraStatus?"off":"on")),p.setRemoteCameraStatus(jsonObj.cameraStatus),this.videoChatHandler.handleRemoteMediaStatus("camera",jsonObj.cameraStatus,p.getZuid())),jsonObj.holdStatus&&(p.setRemoteHoldStatus(jsonObj.holdStatus),1==jsonObj.holdStatus?(this.currentParticipant.micOff(),"voice"!=this.type&&this.currentParticipant.cameraOff(),this.updateLogMessage("[CHAT_STATUS] Call holded."),this.videoChatHandler.handleVideoChatStatus("hold",p.getZuid())):(1==this.localMicStatus&&this.currentParticipant.micOn(),"voice"!=this.type&&1==this.localCameraStatus&&this.currentParticipant.cameraOn(),this.updateLogMessage("[CHAT_STATUS] Call unholded."),this.videoChatHandler.handleVideoChatStatus("unhold",p.getZuid())))):jsonObj.action==VideoConstants.MESSAGE_SCREENSHARE_STATUS_MSG&&(this.videoChatHandler.handleRemoteScreenShareStreamRemoved(p.getZuid()),p.videoChatScreenShare.setRemoteScreenStream(!1))}else if("DISCONNECT_NOTIFY"===action){var p=this.getParticipant(msg.SENDER_ID);if("screenshare"!=msg.CONNECTION_ID){if(0!=p.videoChatWebRTC.activeConnectionId&&msg.CONNECTION_ID!=p.videoChatWebRTC.activeConnectionId)return void this.updateLogMessage("[DISCONNECT_NOTIFY] ConnectionId mismatched: active connectionId= "+p.videoChatWebRTC.activeConnectionId+" incoming connectionid = "+msg.CONNECTION_ID);this.sendAcknowledgement(p.getZuid(),msg.CONNECTION_ID,msg.RECONNECTION_ID),p.videoChatWebRTC.isAlreadyProcessedReconnectionId(msg.RECONNECTION_ID)===!1&&(this.currentParticipant.setICEServers(msg.ICE_SERVERS),p.videoChatWebRTC.reconnection(msg.CONNECTION_ID,msg.RECONNECTION_ID),p.setLocalConnected(!1),p.setRemoteConnected(!1))}else this.sendAcknowledgement(p.getZuid(),msg.CONNECTION_ID,msg.RECONNECTION_ID,this.currentParticipant.getScreenShareAvailable()),p.videoChatScreenShare.isAlreadyProcessedReconnectionId(msg.RECONNECTION_ID)===!1&&(this.currentParticipant.setScreenICEServers(msg.ICE_SERVERS),p.videoChatScreenShare.reconnection(msg.CONNECTION_ID,msg.RECONNECTION_ID,msg.SCREEN_SHARE_AVAILABLE))}else if("DISCONNECT_ACKNOWLEDGEMENT"===action){var p=this.getParticipant(msg.SENDER_ID);"screenshare"!=msg.CONNECTION_ID?p.videoChatWebRTC.isAlreadyProcessedReconnectionId(msg.RECONNECTION_ID)===!1&&(p.videoChatWebRTC.reconnection(msg.CONNECTION_ID,msg.RECONNECTION_ID),p.setLocalConnected(!1),p.setRemoteConnected(!1)):p.videoChatScreenShare.isAlreadyProcessedReconnectionId(msg.RECONNECTION_ID)===!1&&p.videoChatScreenShare.reconnection(msg.CONNECTION_ID,msg.RECONNECTION_ID,msg.SCREEN_SHARE_AVAILABLE)}else if("JOIN_REQUEST"===action){var zuid=msg.CALLED_ZUID,p=this.getParticipant(zuid);0==p&&(p=new VideoChatRemoteParticipant(this.videoChatDivId),p.setZuid(msg.CALLED_ZUID),p.setUserName(msg.CALLED_USER_NAME),p.setPhotoURL(msg.CALLED_PHOTO_URL),p.videoChatWebRTC.zuid=p.getZuid(),p.videoChatScreenShare.zuid=p.getZuid(),this.addParticipant(p),this.videoChatHandler.handleJoinRequest&&this.videoChatHandler.handleJoinRequest(msg.CALLING_ZUID,p.getZuid()))}},VideoChatAPI.prototype.startCall=function(){var successCallback=function(evt){this.currentParticipant.permissionDialogSuccessCallback(this.type,evt),this.updateLogMessage("[CHAT_STATUS] Calling"),this.videoChatHandler.handleVideoChatStatus("calling",this.calledZuid),this.sendRequestChatRequest(),this.startTimer(35e3,this.calledZuid)}.bind(this),errorCallback=function(){this.sendStopChatRequest(VideoChatContainer.getCurrentUserZuid(),VideoConstants.ERROR,"ErrorInPermission")}.bind(this),screenSuccessCallback=function(){setTimeout(function(){this.currentParticipant.showPermissionDialog(this.type,successCallback,errorCallback)}.bind(this),500),this.videoChatHandler.handleScreenOnButton()}.bind(this),screenErrorCallback=function(){this.videoChatHandler.handleMediaPermission("denied","screen"),this.sendStopChatRequest(VideoChatContainer.getCurrentUserZuid(),VideoConstants.ERROR,"ErrorInPermission")}.bind(this);if("screen"!=this.type)setTimeout(function(){this.currentParticipant.showPermissionDialog(this.type,successCallback,errorCallback)}.bind(this),500);else if(Drizzle.browser.chrome)if(this.otherServiceProps){var otherPropsJson=VideoChatUtil.parseJSON(this.otherServiceProps);if(otherPropsJson.extAvailable===!0)this.setChromeExtensionAvailable(!0),this.addScreenShare(screenSuccessCallback,screenErrorCallback,!0);else if(otherPropsJson.extAvailable===!1){var installSuccessCallback=function(){this.setChromeExtensionAvailable(!0),this.videoChatHandler.handleExtInstallSuccess(),setTimeout(function(){this.addScreenShare(screenSuccessCallback,screenErrorCallback,!0)}.bind(this),2e3)}.bind(this),installErrorcallback=function(){this.videoChatHandler.handleMediaPermission("denied","screen"),this.sendStopChatRequest(VideoChatContainer.getCurrentUserZuid(),VideoConstants.ERROR,"ErrorInPermission")}.bind(this);if("undefined"!=typeof chrome){var llink=document.createElement("link");llink.rel="chrome-webstore-item",llink.href="https://chrome.google.com/webstore/detail/amdlbhchbncikhefhcbmcdcgadlggdlb",document.head.appendChild(llink),chrome.webstore.install(null,installSuccessCallback,installErrorcallback)}}}else setTimeout(function(){this.addScreenShare(screenSuccessCallback,screenErrorCallback,!0)}.bind(this),3e3);else this.addScreenShare(screenSuccessCallback,screenErrorCallback,!0)},VideoChatAPI.prototype.stop=function(reason){this.videoChatHandler.handleCloseRequest(reason,VideoChatContainer.getCurrentUserZuid()),this.waitingsound&&this.waitingsound.pause(),this.feedbacksound&&this.feedbacksound.pause();for(var ps=this.getRemoteParticipants(),i=0;i<ps.length;i++)ps[i].videoChatWebRTC.stopDisconnectNotifyTimer();this.stopTimer(),this.currentParticipant.releaseLocalMonitor(),this.currentParticipant.stopChat(),this.currentParticipant.screenStopChat();for(var i=0;i<this.remoteParticipants.length;i++)this.remoteParticipants[i].videoChatWebRTC.stopChat(),this.remoteParticipants[i].videoChatScreenShare.stopChat(),this.remoteParticipants[i].clear();this.sessionId=this.callingZuid=this.calledZuid=this.type=this.ownerZuid=!1,this.waitingsound=this.feedbacksound=this.disconnectsound=!1,this.REQUESTCHAT_TIMEOUT_FUNC=!1,this.chatStarted=!1,this.chatAnswered=!1,this.remoteParticipants=!1,this.contacts=this.orgUsers=null,VideoChatContainer.clearVideoChatAPI(this.videoChatDivId)},VideoChatAPI.prototype.acceptCall=function(){this.chatStarted=!0;var successCallback=function(evt){if(this.chatAnswered=!0,this.currentParticipant.permissionDialogSuccessCallback(this.type,evt),this.chatStarted!==!1){this.updateLogMessage("[CHAT_STATUS] Connecting");for(var connectionId=(new Date).getTime(),participants=this.getRemoteParticipants(),i=0;i<participants.length;i++){var p=participants[i];this.videoChatHandler.handleVideoChatStatus("connecting",p.getZuid()),p.setConnectionId(connectionId+i),p.setChatAnswered(!0),p.videoChatWebRTC.isOffer=!0,p.videoChatWebRTC.startChat(p.getConnectionId().toString())}this.sendStartChatRequest()}else{this.currentParticipant.stopChat();for(var i=0;i<this.remoteParticipants().length;i++)this.remoteParticipants[i].videoChatWebRTC.stopChat()}}.bind(this),errorCallback=function(){this.sendStopChatRequest(VideoChatContainer.getCurrentUserZuid(),VideoConstants.ERROR,"ErrorInPermission")}.bind(this);setTimeout(function(){this.currentParticipant.showPermissionDialog(this.type,successCallback,errorCallback)}.bind(this),500)},VideoChatAPI.prototype.updateChatRunningTime=function(p){var min=0,sec=-1,func=function(){var timeMsg="";sec++,60===sec&&(sec=0,min++),10>min&&(timeMsg+="0"),timeMsg+=min,timeMsg+=" : ",10>sec&&(timeMsg+="0"),timeMsg+=sec,this.chatStarted===!0&&p.isTimerStarted()&&(p.setChatRunningTime(timeMsg),this.videoChatHandler.handleChatRunningTime(p.getChatRunningTime(),p.getZuid()),setTimeout(func,1e3))}.bind(this);setTimeout(func,0)},VideoChatAPI.prototype.initializeCall=function(){0==this.sessionId?this.startCall():this.acceptCall()},VideoChatAPI.prototype.sendDisconnectNotify=function(zuid,reconnection_id,screenShareAvailable){var p=this.getParticipant(zuid),connId=p.videoChatWebRTC.activeConnectionId;void 0!=screenShareAvailable&&(connId="screenshare");var callback=function(obj){return this.updateLogMessage("[RESPONSE] [DISCONNECT_NOTIFY]"+VideoChatUtil.stringifyJSON(obj)),"INVALID"===obj.STATUS||"ERROR"===obj.STATUS?(this.sendFeedback(VideoConstants.ERROR,"ErrorInDisconnectNotify"),void this.stop(VideoConstants.ERROR)):void(void 0!=screenShareAvailable?this.currentParticipant.setScreenICEServers(obj.ICE_SERVERS):this.currentParticipant.setICEServers(obj.ICE_SERVERS))}.bind(this),params="informzuid="+p.getZuid()+"&callingzuid="+this.getOwnerZuid()+"&sessionid="+this.sessionId+"&connectionid="+connId+"&reconnectionid="+reconnection_id;void 0!=screenShareAvailable&&(params=params+"&screenshare="+screenShareAvailable),this.updateLogMessage("[REQUEST] /disconnectnotify.do?"+params),VideoChatContainer.postRequest("DISCONNECT_NOTIFY",params,callback)},VideoChatAPI.prototype.sendAcknowledgement=function(zuid,connId,reconnection_id,screenShareAvailable){var params="informzuid="+zuid+"&callingzuid="+this.getOwnerZuid()+"&sessionid="+this.sessionId+"&connectionid="+connId+"&reconnectionid="+reconnection_id;void 0!=screenShareAvailable&&(params=params+"&screenshare="+screenShareAvailable),this.updateLogMessage("[REQUEST] /sendacknowledgement.do?"+params),VideoChatContainer.postRequest("DISCONNECT_ACKNOWLEDGEMENT",params)},VideoChatAPI.prototype.setSessionId=function(_sessionId){this.sessionId=_sessionId},VideoChatAPI.prototype.getSessionId=function(){return this.sessionId},VideoChatAPI.prototype.getChatUserId=function(){return VideoChatContainer.getCurrentUserZuid()===this.callingZuid?this.calledZuid:this.callingZuid},VideoChatAPI.prototype.isLoggedInUserIsOwner=function(){return VideoChatContainer.getCurrentUserZuid()===this.getOwnerZuid()},VideoChatAPI.prototype.getChatType=function(){return this.type},VideoChatAPI.prototype.getRemoteMicStatus=function(zuid){var p=this.getParticipant(zuid);return p.getRemoteMicStatus()},VideoChatAPI.prototype.getRemoteCameraStatus=function(zuid){var p=this.getParticipant(zuid);return p.getRemoteCameraStatus()},VideoChatAPI.prototype.getRemoteHoldStatus=function(zuid){var p=this.getParticipant(zuid);return p.getRemoteHoldStatus()},VideoChatAPI.prototype.getCallingZuid=function(){return this.callingZuid},VideoChatAPI.prototype.getCalledZuid=function(){return this.calledZuid},VideoChatAPI.prototype.getChatRunningTime=function(zuid){if(zuid){var p=this.getParticipant(zuid);return p.getChatRunningTime()}return this.getRemoteParticipants()[0].getChatRunningTime()},VideoChatAPI.prototype.getSwitchMode=function(zuid){if(zuid){var p=this.getParticipant(zuid);return p.getSwitchMode()}return this.getRemoteParticipants()[0].getSwitchMode()},VideoChatAPI.prototype.getScreenMode=function(zuid){if(zuid){var p=this.getParticipant(zuid);return p.getScreenMode()}return this.getRemoteParticipants()[0].getScreenMode()},VideoChatAPI.prototype.stopChat=function(zuid){if(0!=this.chatStarted){var reason=VideoConstants.COMPLETED;0==this.chatAnswered&&(reason=this.isLoggedInUserIsOwner()&&this.getRemoteParticipants().length<=1?VideoConstants.CANCELLED:VideoConstants.REJECTED),void 0==zuid&&(zuid=VideoChatContainer.getCurrentUserZuid()),this.sendStopChatRequest(zuid,reason)}else{this.currentParticipant.stopChat();for(var i=0;i<this.remoteParticipants.length;i++)this.remoteParticipants[i].videoChatWebRTC.stopChat()}},VideoChatAPI.prototype.micOn=function(){return 1==this.currentParticipant.micOn()?(this.localMicStatus=1,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({micStatus:"1",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),!0):!1},VideoChatAPI.prototype.micOff=function(){return 1==this.currentParticipant.micOff()?(this.localMicStatus=0,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({micStatus:"0",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),!0):!1},VideoChatAPI.prototype.cameraOn=function(callback1,callback2){if(1!=this.isScreenEnabled&&0!=this.isVideoEnabled)return 1==this.currentParticipant.cameraOn()?(callback1&&callback1(),this.localCameraStatus=1,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({cameraStatus:"1",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),!0):!1;var switchType=this.isScreenEnabled?"screenToVideo":"video",successCallback=function(){this.isScreenEnabled=!1,this.isVideoEnabled=!0,this.videoChatHandler.handleCameraOn("success"),this.localCameraStatus=1;for(var ps=this.getRemoteParticipants(),i=0;i<ps.length;i++)ps[i].videoChatWebRTC.switchDevices(switchType);this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({cameraStatus:"1",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),callback1&&callback1()}.bind(this),errorCallback=function(){this.videoChatHandler.handleCameraOn("failure"),callback2&&callback2()}.bind(this);this.currentParticipant.showSwitchDialog(switchType,successCallback,errorCallback)},VideoChatAPI.prototype.cameraOff=function(){return 1==this.currentParticipant.cameraOff()?(this.localCameraStatus=0,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({cameraStatus:"0",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),!0):!1},VideoChatAPI.prototype.screenOn=function(callback1,callback2){if(this.updateLogMessage("[SWITCH_MODE] screenOn called"),1==this.isScreenEnabled&&1==this.currentParticipant.cameraOn())return this.localCameraStatus=1,this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({cameraStatus:"1",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),callback1&&callback1(),!0;var switchType=this.isVideoEnabled?"videoToScreen":"screen",successCallback=function(){this.isScreenEnabled=!0,this.isVideoEnabled=!1,callback1&&callback1();for(var ps=this.getRemoteParticipants(),i=0;i<ps.length;i++)ps[i].videoChatWebRTC.switchDevices(switchType);this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({cameraStatus:"1",action:VideoConstants.MESSAGE_STATUS_MSG.toString()})),this.videoChatHandler.handleScreenOn("success")}.bind(this),errorCallback=function(){this.videoChatHandler.handleScreenOn("failure"),callback2&&callback2()}.bind(this);this.currentParticipant.showSwitchDialog(switchType,successCallback,errorCallback)},VideoChatAPI.prototype.screenOff=function(switchToCamera){if(this.updateLogMessage("[SWITCH_MODE] screenOff called : "+switchToCamera),void 0==switchToCamera||0==switchToCamera){if(this.cameraOff(),1==Drizzle.browser.chrome){for(var track=this.getLocalStream().getVideoTracks(),i=0;i<track.length;i++)track[i].stop(),this.getLocalStream().removeTrack(track[i]);this.isScreenEnabled=!1}}else this.cameraOn()},VideoChatAPI.prototype.addScreenShare=function(callback1,callback2,later){this.updateLogMessage("[SCREEN_SHARE] addScreenShare called");var successCallback=function(){this.currentParticipant.localUserScreenEnabledTimes=this.currentParticipant.localUserScreenEnabledTimes+1;for(var ps=this.getRemoteParticipants(),i=0;i<ps.length;i++){var p=ps[i];0===Object.keys(p.videoChatScreenShare.peerConnectionInfo).length&&p.videoChatScreenShare.setFirstScreenShareUser(!0)}if(callback1&&callback1(),void 0===later)for(var ps=this.getRemoteParticipants(),i=0;i<ps.length;i++){var p=ps[i];p.videoChatScreenShare.startScreenSharing(p.getZuid())}}.bind(this),errorCallback=function(){this.videoChatHandler.handleScreenOn("failure"),callback2&&callback2()}.bind(this);this.currentParticipant.showScreenSharePermission(successCallback,errorCallback)},VideoChatAPI.prototype.removeScreenShare=function(zuid){this.updateLogMessage("[SCREEN_SHARE] removeScreenShare called for zuid "+zuid),zuid?this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({screenShareStatus:"0",action:VideoConstants.MESSAGE_SCREENSHARE_STATUS_MSG.toString()}),zuid):(this.currentParticipant.removeScreenShare(),this.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON({screenShareStatus:"0",action:VideoConstants.MESSAGE_SCREENSHARE_STATUS_MSG.toString()}))),this.videoChatHandler.handleStopSharing()},VideoChatAPI.prototype.removeRemoteScreenShare=function(zuid){var p=this.getParticipant(zuid);this.videoChatHandler.handleRemoteScreenShareStreamRemoved(p.getZuid()),p.videoChatScreenShare.setRemoteScreenStream(!1)},VideoChatAPI.prototype.isCameraOff=function(){return this.currentParticipant.isCameraOff()},VideoChatAPI.prototype.isMicOff=function(){return this.currentParticipant.isMicOff()},VideoChatAPI.prototype.setSpeakerStatus=function(status,zuid){zuid?this.getParticipant(zuid).videoChatWebRTC.setSpeakerStatus(status):this.getRemoteParticipants()[0].videoChatWebRTC.setSpeakerStatus(status)},VideoChatAPI.prototype.getSpeakerStatus=function(zuid){return zuid?this.getParticipant(zuid).videoChatWebRTC.getSpeakerStatus():this.getRemoteParticipants()[0].videoChatWebRTC.getSpeakerStatus()},VideoChatAPI.prototype.getLocalSrc=function(){return this.currentParticipant.getLocalSrc()},VideoChatAPI.prototype.getRemoteSrc=function(zuid){var p=this.getParticipant(zuid);return p.videoChatWebRTC.getRemoteSrc()},VideoChatAPI.prototype.setWmsServerUpStatus=function(status){VideoChatContainer.setWmsServerUpStatus(status)},VideoChatAPI.prototype.getLocalStream=function(){return this.currentParticipant.getLocalStream()},VideoChatAPI.prototype.getRemoteStream=function(zuid){var p=this.getParticipant(zuid);return p.videoChatWebRTC.getRemoteStream()},VideoChatAPI.prototype.getLocalScreenShareStream=function(){return this.currentParticipant.getLocalScreenStream()},VideoChatAPI.prototype.setChatUserName=function(name,zuid){zuid?this.getParticipant(zuid).setUserName(name):this.getRemoteParticipants()[0].setUserName(name)},VideoChatAPI.prototype.updateLogMessage=function(message){var time=new Date;time=time.getFullYear()+"-"+(time.getMonth()+1)+"-"+time.getDate()+" "+time.getHours()+":"+time.getMinutes()+":"+time.getSeconds()+"."+time.getMilliseconds(),message="["+time+"] "+message+"\n",this.chatLogs+=message},VideoChatAPI.prototype.getSubject=function(reason){var reasonString=VideoChatContainer.getReasonInString(reason),callingUserName=VideoChatContainer.getCurrentUserName(),calledUserName=this.getRemoteParticipants()[0].getUserName();VideoChatContainer.getCurrentUserZuid()!=this.callingZuid&&(callingUserName=this.getRemoteParticipants()[0].getUserName(),calledUserName=VideoChatContainer.getCurrentUserName()),callingUserName=VideoChatUtil.decodeString(callingUserName),calledUserName=VideoChatUtil.decodeString(calledUserName);var sessionId=this.sessionId?this.sessionId:"N/A",subject="[AT] ["+reasonString+"] ["+sessionId+"] ["+this.getOwnerZuid()+"] ["+callingUserName+":"+this.callingZuid+"] ["+calledUserName+":"+this.calledZuid+"]";return subject},VideoChatAPI.prototype.getDescription=function(reason,errorStatus){var description=!1;return reason==VideoConstants.ERROR?description=0!=errorStatus?errorStatus:"Call not connected":reason==VideoConstants.COMPLETED&&(description=0!=this.getChatRunningTime()?this.getChatRunningTime():"Call time 0 Sec"),description},VideoChatAPI.prototype.sendFeedback=function(reason,errorStatus){if(0!=this.callingZuid||0!=this.calledZuid){var subject=this.getSubject(reason),description=this.getDescription(reason,errorStatus),p=this.getRemoteParticipants()[0];VideoChatContainer.sendFeedback(subject,description,this.chatLogs,this.sessionId,p.videoChatWebRTC.peerConnectionPacketsInfo)}},VideoChatAPI.prototype.customiseDevices=function(devices){this.setDevices(devices);var errorCallback=function(){this.updateLogMessage("[CUSTOMISE_DEVICE] error in switching devices")}.bind(this),successCallback=function(){for(var ps=this.getRemoteParticipants(),i=0;i<ps.length;i++)ps[i].videoChatWebRTC.switchDevices(this.type)}.bind(this);this.currentParticipant.showSwitchDialog(this.type,successCallback,errorCallback)},VideoChatAPI.prototype.setSpeakerDevice=function(device,videoElement){this.updateLogMessage("[SET_SPEAKER] deviceId="+device.deviceId),videoElement&&VideoChatContainer.setSpeakerDevice(videoElement,device),this.waitingsound&&VideoChatContainer.setSpeakerDevice(this.waitingsound,device),this.feedbacksound&&VideoChatContainer.setSpeakerDevice(this.feedbacksound,device),this.endsound&&VideoChatContainer.setSpeakerDevice(this.endsound,device),this.disconnectsound&&VideoChatContainer.setSpeakerDevice(this.disconnectsound,device)},VideoChatAPI.prototype.setDevices=function(devices){this.currentParticipant.setDevices(devices)},VideoChatAPI.prototype.setAppName=function(name){this.appName=name},VideoChatAPI.prototype.setAddingMode=function(value){this.addingMode=value},VideoChatAPI.prototype.setRemoteUserAgent=function(value,zuid){zuid?(this.getParticipant(zuid).videoChatWebRTC.remoteUserAgent=value,this.getParticipant(zuid).videoChatWebRTC.remoteDevice=Drizzle.findBrowser(value)):(this.getRemoteParticipants()[0].videoChatWebRTC.remoteUserAgent=value,this.getRemoteParticipants()[0].videoChatWebRTC.remoteDevice=Drizzle.findBrowser(value))},VideoChatAPI.prototype.setChromeExtensionAvailable=function(value){this.currentParticipant.setChromeExtensionAvailable(value)},VideoChatAPI.prototype.addParticipant=function(p){0==this.getParticipant(p.getZuid())&&this.remoteParticipants.push(p)},VideoChatAPI.prototype.getParticipant=function(zuid){for(var i=0;i<this.remoteParticipants.length;i++)if(this.remoteParticipants[i].getZuid()==zuid)return this.remoteParticipants[i];return!1},VideoChatAPI.prototype.getRemoteParticipants=function(){return this.remoteParticipants},VideoChatAPI.prototype.printFrequency=function(){this.currentParticipant.printFrequency();for(var remoteParticipants=this.getRemoteParticipants(),i=0;i<remoteParticipants.length;i++)remoteParticipants[i].videoChatWebRTC.printFrequency()},VideoChatAPI.prototype.setParticipants=function(participants){for(var participantsList=VideoChatUtil.parseJSON(participants),i=0;i<participantsList.length;i++){var participantInfo=participantsList[i],p=this.getParticipant(participantInfo.ZUID);0==p&&(p=new VideoChatRemoteParticipant(this.videoChatDivId),p.setZuid(participantInfo.ZUID),p.videoChatWebRTC.zuid=p.getZuid(),p.videoChatScreenShare.zuid=p.getZuid(),this.addParticipant(p)),p.setUserName(participantInfo.NAME),p.setPhotoURL(participantInfo.PHOTO_URL),p.videoChatWebRTC.isOffer=!0}},VideoChatAPI.prototype.setUsersInfo=function(usersInfo){for(var usersInfoList=usersInfo,i=0;i<usersInfoList.length;i++){var userInfo=usersInfoList[i],p=this.getParticipant(userInfo.zuid);0!=p&&(p.setRemoteMicStatus(userInfo.micStatus),p.setRemoteCameraStatus(userInfo.cameraStatus),p.setRemoteVideoEnabled(1==userInfo.videoEnabled?!0:!1))}},VideoChatAPI.prototype.isExistingUser=function(zuid){for(var participants=this.getRemoteParticipants(),i=0;i<participants.length;i++)if(participants[i].getZuid()==zuid)return!0;return!1},VideoChatAPI.prototype.sendJoinRequest=function(zuid){if(this.isExistingUser(zuid))return void this.videoChatHandler.handleExistingUser(zuid);var callback=function(obj){if(this.updateLogMessage("[RESPONSE] [JOIN_REQUEST] "+VideoChatUtil.stringifyJSON(obj)),"SUCCESS"!==obj.STATUS)return void("ROOM_FULL"===obj.STATUS?this.removeParticipant(zuid,VideoConstants.ROOM_FULL):this.removeParticipant(zuid,VideoConstants.ERROR));var p=this.getParticipant(zuid);p.setUserName(obj.CALLED_USER_NAME),p.setPhotoURL(obj.CALLED_PHOTO_URL),this.videoChatHandler.handleJoinRequest(VideoChatContainer.getCurrentUserZuid(),zuid)}.bind(this),p=this.getParticipant(zuid);if(0==p){p=new VideoChatRemoteParticipant(this.videoChatDivId),p.setZuid(zuid),p.videoChatWebRTC.zuid=p.getZuid(),p.videoChatScreenShare.zuid=p.getZuid(),this.addParticipant(p),this.startTimer(35e3,zuid);var params="sessionid="+this.sessionId+"&ownerzuid="+this.getOwnerZuid()+"&calledzuid="+zuid;this.otherServiceProps&&(params=params+"&otherserviceprops="+this.otherServiceProps);var usersInfoList=new Array,micState=this.currentParticipant.isMicOff()?"0":"1",cameraState=this.currentParticipant.isCameraOff()?"0":"1",videoEnabledState=this.isVideoEnabled?"1":"0",userInfo={zuid:VideoChatContainer.getCurrentUserZuid(),micStatus:micState,cameraStatus:cameraState,videoEnabled:videoEnabledState};usersInfoList.push(userInfo);for(var i=0;i<this.remoteParticipants.length;i++){var p=this.remoteParticipants[i];p.getZuid()!=zuid&&(micState=p.getRemoteMicStatus(),cameraState=p.getRemoteCameraStatus(),videoEnabledState=p.getRemoteVideoEnabled()?"1":"0",userInfo={zuid:p.getZuid(),micStatus:micState,cameraStatus:cameraState,videoEnabled:videoEnabledState},usersInfoList.push(userInfo))}params=params+"&usersinfo="+VideoChatUtil.stringifyJSON(usersInfoList),this.updateLogMessage("[REQUEST] /joinrequest.do?"+params),VideoChatContainer.postRequest("JOIN_REQUEST",params,callback)}},VideoChatAPI.prototype.updateConnectedParticipants=function(zuid){for(var i=0;i<this.connectedParticipants.length;i++)if(this.connectedParticipants[i]==zuid)return;this.connectedParticipants.push(zuid)},VideoChatAPI.prototype.removeConnectedParticipant=function(zuid){for(var i=0;i<this.connectedParticipants.length;i++)this.connectedParticipants[i]==zuid&&(this.connectedParticipants.splice(i,1),i--)},VideoChatAPI.prototype.getConnectedParticipants=function(){return this.connectedParticipants},VideoChatAPI.prototype.setContacts=function(){var callback=function(obj){if(this.updateLogMessage("[RESPONSE] [GET_CONTACTS]"+obj.STATUS),"SUCCESS"===obj.STATUS&&obj.CONTACTS){var contactsJSON=obj.CONTACTS;this.contacts=contactsJSON.USER_DETAILS}}.bind(this);VideoChatContainer.getRequest("GET_CONTACTS",callback)},VideoChatAPI.prototype.setOrgUsers=function(){var callback=function(obj){if(this.updateLogMessage("[RESPONSE] [GET_ORGUSERS]"+obj.STATUS),"SUCCESS"===obj.STATUS&&obj.ORG_USERS){var orgJSON=obj.ORG_USERS;this.orgUsers=orgJSON.USER_DETAILS}this.videoChatHandler.handleOrgUsers&&this.videoChatHandler.handleOrgUsers(this.orgUsers)}.bind(this);VideoChatContainer.getRequest("GET_ORGUSERS",callback)},VideoChatAPI.prototype.getContacts=function(){return this.contacts},VideoChatAPI.prototype.getOrgUsers=function(){return this.orgUsers},VideoChatAPI.prototype.updateConnectionStats=function(data,useragent){stats=VideoChatUtil.stringifyJSON(data);var params="sessionid="+this.sessionId+"&useragent="+useragent+"&connectionstats="+encodeURIComponent(stats);this.sessionId&&VideoChatContainer.postRequest("UPDATE_CONNECTION_STATS",params)};var VideoChatContainer=function(){function init(_currentUserZuid,_currentUserName,_wmsJSURL){currentUserZuid=_currentUserZuid,currentUserName=_currentUserName,wmsJSURL=_wmsJSURL}function createVideoChatAPI(callingZuid,calledZuid,type,chatUserName,iceServers,otherServiceProps,videoChatHandler,logMessage){return videoChatAPIs[callingZuid+"_"+calledZuid]=new VideoChatAPI(callingZuid+"_"+calledZuid),videoChatAPIs[callingZuid+"_"+calledZuid].init(callingZuid,calledZuid,type,chatUserName,iceServers,otherServiceProps,videoChatHandler,logMessage),videoChatAPIs[callingZuid+"_"+calledZuid]}function getVideoChatAPI(videoChatDivId){return videoChatAPIs[videoChatDivId]}function handleMessage(msg){if("CHAT_REQUEST"===msg.ACTION&&0!=Object.keys(videoChatAPIs).length)return void VideoChatMessageNotifier.handleChatRequest(msg.CALLING_ZUID,msg.CALLING_USER_NAME,msg.SESSION_ID,msg.TYPE,msg.OTHER_SERVICE_PROPS);if(0!=Object.keys(videoChatAPIs).length)for(var i in videoChatAPIs){if(videoChatAPIs.hasOwnProperty(i)&&videoChatAPIs[i].getSessionId()==msg.SESSION_ID)return void videoChatAPIs[i].handleMessage(msg);if("JOIN_REQUEST"===msg.ACTION)return void(VideoChatMessageNotifier.handleJoinRequest&&VideoChatMessageNotifier.handleJoinRequest(msg.OWNER_ZUID,msg.SESSION_ID,msg.CALLING_ZUID,msg.CALLING_USER_NAME,msg.CALLING_USERS,msg.TYPE,msg.OTHER_SERVICE_PROPS))}unhandledMessages.push(msg)}function checkUnhandledMessage(videoChatDivId,sessionId){for(var i=0;i<unhandledMessages.length;i++){var msg=unhandledMessages[i];msg.SESSION_ID==sessionId&&videoChatAPIs[videoChatDivId]&&(videoChatAPIs[videoChatDivId].handleMessage(msg),unhandledMessages.splice(i,1),i-=1)}}function initWMS(){var callback=function(){WmsliteImpl.handleMessage=function(a,b){29==a&&(updateLogMessage("[WMS_MESSAGE] Message sent by WMS "+VideoChatUtil.stringifyJSON(b)),handleMessage(b))},WmsliteImpl.serverup=function(){if(updateLogMessage("[WMS] Serverup"),Drizzle(window).unbind("message"),!(0!=location||window.opener&&window.postMessage))for(var i in videoChatAPIs)videoChatAPIs.hasOwnProperty(i)&&videoChatAPIs[i].initializeCall();wmsServerUp=!0},WmsliteImpl.serverdown=function(){updateLogMessage("[WMS] Serverdown"),wmsServerUp=!1};var currentDomain=window.location.host;-1!=currentDomain.indexOf("csez.zohocorpin.com")?WmsLite.jsstaticdomain="localjs.zohostatic.com":-1!=currentDomain.indexOf("localzoho.com")&&(WmsLite.jsstaticdomain="localjs.zohostatic.com"),WmsLite.setWmsContext("_wms"),WmsLite.setNoDomainChange(),WmsLite.registerZuid("VI",currentUserZuid,currentUserName)},script=document.createElement("script");script.src=window.location.protocol+"//"+wmsJSURL,script.onload=callback,document.head.appendChild(script)}function clearVideoChatAPI(videoChatDivId){delete videoChatAPIs[videoChatDivId]}function getWmsServerUpStatus(){return useWebsocket===!1?wmsServerUp:VideoChatWebSocket.getWebSocketUpStatus()}function postRequest(urlKey,param,callback){callback?(callbackId+=1,callbacks[callbackId.toString()]=callback,NetworkAPI.postRequest(urlKey,param,callbackId.toString())):NetworkAPI.postRequest(urlKey,param)}function getRequest(urlKey,callback){callbackId+=1,callbacks[callbackId.toString()]=callback,NetworkAPI.getRequest(urlKey,callbackId.toString())}function invokeCallback(callbackId,responseText){callbacks[callbackId](responseText),delete callbacks[callbackId]}function receiveMessage(event){if("object"!=typeof event.data){var data=VideoChatUtil.parseJSON(event.data);updateLogMessage("[WMS_MESSAGE] Message sent from Opener Window "+VideoChatUtil.stringifyJSON(data)),handleMessage(data)}}function getCurrentUserZuid(){return currentUserZuid}function getLocation(){return location}function getCSRF(callback){if(!callback){var csrfCookieValue=!1;return csrfCookieName&&(csrfCookieValue=getCookie(csrfCookieName)),csrfParamName+"="+csrfCookieValue}callbackId+=1,callbacks[callbackId.toString()]=callback;var jsonData={};jsonData.action="CSRF_DATA",jsonData.callbackId=callbackId;var message=VideoChatUtil.stringifyJSON(jsonData),subframe=document.getElementById("zv_callreceiverframe"),frameWindow=subframe.contentWindow;frameWindow.postMessage(message,VideoChatContainer.getVideoServerLocation())}function getCurrentUserZuid(){return currentUserZuid}function getCurrentUserName(){return currentUserName}function getVideoServerLocation(){return videoServerLocation}function setVideoServerLocation(location){videoServerLocation=location}function getParentLocation(){return parentLocation}function setParentLocation(location){parentLocation=location}function setI18NMessages(_i18nMessages){I18N.init(_i18nMessages)}function setUseWebSocket(iswebsocket){updateLogMessage("[WEBSOCKET_USER] "+(iswebsocket?"yes":"no")),useWebsocket=iswebsocket}function setWmsServerUpStatus(status){updateLogMessage("[WMS] Server"+(status?"up":"down")),wmsServerUp=status}function getUseWebSocket(){return useWebsocket}function updateLogMessage(message){for(var i in videoChatAPIs)videoChatAPIs.hasOwnProperty(i)&&videoChatAPIs[i].updateLogMessage(message)}function getReasonInString(reason){var reasonString=!1;switch(reason=parseInt(reason)){case VideoConstants.ERROR:reasonString="ERROR";break;case VideoConstants.CANCELLED:reasonString="CANCELLED";break;case VideoConstants.REJECTED:reasonString="REJECTED";break;case VideoConstants.NO_RESPONSE:reasonString="NO_RESPONSE";break;case VideoConstants.NO_WEBRTC:reasonString="NO_WEBRTC";break;case VideoConstants.BUSY_ON_ANOTHER_CALL:reasonString="BUSY_ON_ANOTHER_CALL";break;default:reasonString="COMPLETED"}return reasonString}function sendFeedback(subject,description,logMessage,sessionId,peerConnectionPacketsInfo){subject=encodeURIComponent(subject),logMessage=encodeURIComponent(logMessage);var criticalRequest=2;description=description?description:"This is a system generated log email, no need to reply.",params="subject="+subject+"&message="+description+"&logmessage="+logMessage+"&criticalrequest="+criticalRequest,0!=sessionId&&(params=params+"&sessionid="+sessionId),void 0!=peerConnectionPacketsInfo&&peerConnectionPacketsInfo.length>0&&(params=params+"&packetsinfo="+VideoChatUtil.stringifyJSON(peerConnectionPacketsInfo)),VideoChatContainer.postRequest("SEND_FEEDBACK",params)}function getDevices(deviceKind,callback1,callback2){var devicesList=new Array;if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices){var errorMsg="navigator.mediaDevices.enumerateDevices is not available";callback2(errorMsg)}navigator.mediaDevices.enumerateDevices().then(function(devices){devices.forEach(function(device){device.kind==deviceKind&&devicesList.push(device)}),callback1(devicesList)}).catch(function(err){var errorMsg=err.name+": "+err.message;callback2(errorMsg)})}function setSpeakerDevice(videoElement,device){device&&"audiooutput"==device.kind&&videoElement.setSinkId instanceof Function&&videoElement.setSinkId(device.deviceId)}function setCsrfData(data){csrfParamName=data.csrfParam,csrfCookieName=data.csrfCookieName}function getCookie(cName){for(var c=document.cookie.split("; "),i=0;i<c.length;i++){var cookie=c[i].split("=");if(cookie[0]==cName)return cookie[1]}return!1}function getMailAppLocation(){return mailAppLocation}var location=window.location.protocol+"//"+window.location.host,parentLocation=!1,videoServerLocation=!1,currentUserZuid=!1,currentUserName=!1,wmsJSURL=!1,videoChatAPIs=new Array,wmsServerUp=!1,callbacks=new Array,callbackId=0,unhandledMessages=new Array,useWebsocket=!1,csrfParamName=!1,csrfCookieName=!1,mailAppLocation=!1,ua=navigator.userAgent.toLowerCase();return-1!=ua.indexOf("zohomail-nativedesktop")&&(mailAppLocation=window.location.protocol+"//"+window.location.host),{init:init,createVideoChatAPI:createVideoChatAPI,getVideoChatAPI:getVideoChatAPI,initWMS:initWMS,clearVideoChatAPI:clearVideoChatAPI,getWmsServerUpStatus:getWmsServerUpStatus,handleMessage:handleMessage,postRequest:postRequest,invokeCallback:invokeCallback,getCurrentUserZuid:getCurrentUserZuid,checkUnhandledMessage:checkUnhandledMessage,getLocation:getLocation,getCSRF:getCSRF,getCurrentUserName:getCurrentUserName,getVideoServerLocation:getVideoServerLocation,setVideoServerLocation:setVideoServerLocation,getParentLocation:getParentLocation,setParentLocation:setParentLocation,setI18NMessages:setI18NMessages,receiveMessage:receiveMessage,setUseWebSocket:setUseWebSocket,setWmsServerUpStatus:setWmsServerUpStatus,getUseWebSocket:getUseWebSocket,sendFeedback:sendFeedback,getReasonInString:getReasonInString,updateLogMessage:updateLogMessage,getDevices:getDevices,setSpeakerDevice:setSpeakerDevice,setCsrfData:setCsrfData,getRequest:getRequest,getMailAppLocation:getMailAppLocation}}();VideoChatScreenShare.prototype.startScreenSharing=function(){if(0!=Object.keys(this.peerConnectionInfo).length&&(0!=this.currentParticipant.getLocalScreenStream()||0!=this.peerConnectionInfo.remoteScreenStream)){var renegotiate={};return Drizzle.browser.mozilla||Drizzle.browser.chrome&&Drizzle.browser.version>=72?this.sender=this.peerConnectionInfo.pc.addTrack(this.currentParticipant.getLocalScreenStream().getVideoTracks()[0],this.currentParticipant.getLocalScreenStream()):this.peerConnectionInfo.pc.addStream(this.currentParticipant.getLocalScreenStream()),this.currentParticipant.setScreenShareAvailable(!0),this.renegotiatingUser=VideoChatContainer.getCurrentUserZuid(),void(this.firstScreenShareUser===!1?(renegotiate.status="start",this.peerConnectionInfo.renegotiate=renegotiate,this.sendSignals(this.peerConnectionInfo,VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_RENEGOTIATION)):(renegotiate.status="started",this.peerConnectionInfo.renegotiate=renegotiate,this.startRenegotiate()))}this.peerConnectionInfo.localCandidates=new Array,this.peerConnectionInfo.remoteCandidates=new Array,this.peerConnectionInfo.localDesc=!1,this.peerConnectionInfo.remoteDesc=!1,this.peerConnectionInfo.endICE=!1,this.peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=!1,this.peerConnectionInfo.connectionId="screenshare",this.isPreviousPeerConnectionInfoCleared=!1;var onicecandidateCallback=function(evt){return this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [ICE_CANDIDATE] "+(null!=evt.candidate?VideoChatUtil.stringifyJSON(evt.candidate):"candidate is null")),this.renegotiatingUser?void 0:null===evt.candidate?void(this.peerConnectionInfo.endICE=!0):void this.peerConnectionInfo.localCandidates.push(VideoChatUtil.stringifyJSON(evt.candidate))}.bind(this),oniceconnectionstatechangeCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [ICE_CONNECTION_STATE] "+(0!=pc?pc.iceConnectionState:"pc is false")),pc!==!1&&("connected"===pc.iceConnectionState||"completed"===pc.iceConnectionState?(0!=this.reconnectionState&&(this.reconnectionState="connected",this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleScreenShareReconnect(this.reconnectionState,this.zuid)),(0==Drizzle.browser.chrome||Drizzle.browser.version<73)&&clearTimeout(this.peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION)):"disconnected"===pc.iceConnectionState?(this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] disconnected called"),this.reconnectionState="checking",this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState)):"failed"===pc.iceConnectionState?(this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] failed called"),this.isPreviousPeerConnectionInfoCleared===!1&&(this.peerConnectionInfo.pc.close(),this.peerConnectionInfo.remoteScreenStream=!1,this.peerConnectionInfo={},this.isPreviousPeerConnectionInfoCleared=!0),(1==this.currentParticipant.getScreenShareAvailable()||0!=this.remoteScreenStream)&&this.sendDisconnectNotify()):"closed"===pc.iceConnectionState&&(pc=!1))}.bind(this),onconnectionstatechangeCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [CONNECTION_STATE] "+(0!=pc?pc.iceConnectionState:"pc is false")),pc!==!1&&("connected"===pc.connectionState||"completed"===pc.connectionState?(0!=this.reconnectionState&&(this.reconnectionState="connected",this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),this.videoChatAPI.videoChatHandler.handleScreenShareReconnect(this.reconnectionState,this.zuid)),(0==Drizzle.browser.chrome||Drizzle.browser.version<73)&&clearTimeout(this.peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION)):"disconnected"===pc.connectionState?(this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] disconnected called"),this.reconnectionState="checking",this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState)):"failed"===pc.connectionState?(this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] failed called"),this.isPreviousPeerConnectionInfoCleared===!1&&(this.peerConnectionInfo.pc.close(),this.peerConnectionInfo.remoteScreenStream=!1,this.peerConnectionInfo={},this.isPreviousPeerConnectionInfoCleared=!0),(1==this.currentParticipant.getScreenShareAvailable()||0!=this.remoteScreenStream)&&this.sendDisconnectNotify()):"closed"===pc.connectionState&&(pc=!1))}.bind(this),onSignalingStateChangeCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [SIGNALING_STATE] "+(void 0!=pc.signalingState?pc.signalingState:"undefined")),"closed"==pc.signalingState&&this.handleFailureCase()}.bind(this),onAddTrackCallback=function(evt){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] onAddTrackCallback : track kind = "+evt.track.kind),Drizzle.browser.chrome&&"video"===evt.track.kind&&this.completeRenegotiation("completed")}.bind(this),onAddStreamCallback=function(evt){this.remoteUserScreenEnabledTimes=this.remoteUserScreenEnabledTimes+1,this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] onAddStreamCallback called");var stream=!1;stream=evt.streams?evt.streams[0]:evt.stream,this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] onAddStreamCallback : stream = "+VideoChatUtil.stringifyJSON(stream)),this.peerConnectionInfo.remoteScreenStream=stream,this.remoteScreenStream=stream,this.videoChatAPI.videoChatHandler.handleRemoteScreenShareStreamAdded(stream,this.zuid),this.renegotiatingUser?this.completeRenegotiation("completed"):Drizzle.browser.chrome&&(this.peerConnectionInfo.remoteScreenStream.onaddtrack=onAddTrackCallback)}.bind(this),errorCallback=function(err){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] ErrorCallback in  createOffer "+err),this.videoChatAPI.videoChatHandler.handleScreenOn("failure")}.bind(this),createOfferSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("SCREENSHARE_WEBRTC [LOCAL_DESC] "+VideoChatUtil.stringifyJSON(desc)),this.peerConnectionInfo.localDesc=desc,this.connect(this.peerConnectionInfo)}.bind(this),pc=new this.RTCPeerConnection(this.currentParticipant.getScreenICEServers());this.peerConnectionInfo.pc=pc,pc.onicecandidate=onicecandidateCallback,Drizzle.browser.chrome&&Drizzle.browser.version>76?pc.onconnectionstatechange=onconnectionstatechangeCallback:(pc.oniceconnectionstatechange=oniceconnectionstatechangeCallback,pc.onsignalingstatechange=onSignalingStateChangeCallback),Drizzle.browser.mozilla&&Drizzle.browser.version>56||Drizzle.browser.chrome&&Drizzle.browser.version>=72?pc.ontrack=onAddStreamCallback:pc.onaddstream=onAddStreamCallback,0!=this.currentParticipant.getLocalScreenStream()&&(Drizzle.browser.mozilla&&Drizzle.browser.version>56||Drizzle.browser.chrome&&Drizzle.browser.version>=72?this.sender=pc.addTrack(this.currentParticipant.getLocalScreenStream().getVideoTracks()[0],this.currentParticipant.getLocalScreenStream()):pc.addStream(this.currentParticipant.getLocalScreenStream()),this.currentParticipant.setScreenShareAvailable(!0)),this.firstScreenShareUser===!0&&pc.createOffer(createOfferSuccessCallback,errorCallback)},VideoChatScreenShare.prototype.connect=function(peerConnectionInfo){var errorCallback=function(err){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] ErrorInSetLocalDescription "+err),this.videoChatAPI.videoChatHandler.handleScreenOn("failure")}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] local description set successfully"),this.sendSignalsPeriodically(this.peerConnectionInfo,VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_MSG)}.bind(this);peerConnectionInfo.localDesc!==!1&&(this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] setLocalDescription : "+VideoChatUtil.stringifyJSON(peerConnectionInfo.localDesc)),this.peerConnectionInfo.pc.setLocalDescription(peerConnectionInfo.localDesc,localDescSuccessCallback,errorCallback))},VideoChatScreenShare.prototype.sendSignalsPeriodically=function(peerConnectionInfo,action){var periodic=function(peerConnectionInfo,action){this.sendSignals(peerConnectionInfo,action),peerConnectionInfo.endICE!==!0&&(peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=setTimeout(function(){periodic(peerConnectionInfo,action)},200))}.bind(this);peerConnectionInfo.SENDSIGNALSTIMEOUTFUNCTION=setTimeout(function(){periodic(peerConnectionInfo,action)},200)},VideoChatScreenShare.prototype.sendSignals=function(peerConnectionInfo,action){var sendObj={};sendObj.action=action.toString(),sendObj.reconnectionid=this.reconnectionId.toString(),peerConnectionInfo.localDesc&&(sendObj.sessiondesc={},sendObj.sessiondesc.sdp=peerConnectionInfo.localDesc.sdp.replace(/IP6 ::/g,"IP4 0.0.0.0"),sendObj.sessiondesc.type=peerConnectionInfo.localDesc.type,delete peerConnectionInfo.localDesc),peerConnectionInfo.localCandidates.length>0&&(sendObj.candidates=peerConnectionInfo.localCandidates,peerConnectionInfo.localCandidates=new Array),peerConnectionInfo.renegotiate&&(sendObj.renegotiate=peerConnectionInfo.renegotiate,delete peerConnectionInfo.renegotiate),(sendObj.sessiondesc||sendObj.candidates||sendObj.renegotiate)&&(sendObj.connectionid=peerConnectionInfo.connectionId,this.videoChatAPI.sendMessageSignalingRequest(VideoChatUtil.stringifyJSON(sendObj),this.zuid))},VideoChatScreenShare.prototype.onMessage=function(obj,msgId){for(var i=0;i<this.processedMsgIdList.length;i++)if(this.processedMsgIdList[i]==msgId)return void this.videoChatAPI.updateLogMessage("[WMS_MESSAGE] Already proceesed Msg ID :"+msgId);if(this.processedMsgIdList.push(msgId),this.firstScreenShareUser===!1&&0===Object.keys(this.peerConnectionInfo).length&&this.startScreenSharing(),null!=this.peerConnectionInfo&&this.peerConnectionInfo.pc!==!1){var errorCallback=function(err){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] ErrorInSetRemoteDescription "+err),1==this.firstScreenShareUser&&this.videoChatAPI.videoChatHandler.handleScreenOn("failure")}.bind(this),addCandidates=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] addCandidates : "+VideoChatUtil.stringifyJSON(this.peerConnectionInfo.remoteCandidates));for(var addIceCandidateSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] Ice Candidates added successfully")}.bind(this),i=0;i<this.peerConnectionInfo.remoteCandidates.length;i++)this.peerConnectionInfo.pc.addIceCandidate(new this.RTCIceCandidate(VideoChatUtil.parseJSON(this.peerConnectionInfo.remoteCandidates[i])),addIceCandidateSuccessCallback,errorCallback);this.peerConnectionInfo.remoteCandidates=new Array}.bind(this);if(obj.sessiondesc){var localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] local description set successfully"),this.sendSignalsPeriodically(this.peerConnectionInfo,VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_MSG)}.bind(this),createAnswerSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] createAnswerSuccessCallback setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),this.peerConnectionInfo.localDesc=desc,this.peerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this),remoteDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] remote description set successfully"),"offer"===this.peerConnectionInfo.pc.remoteDescription.type&&this.peerConnectionInfo.pc.createAnswer(createAnswerSuccessCallback,errorCallback),this.peerConnectionInfo.remoteCandidates.push.apply(this.peerConnectionInfo.remoteCandidates,obj.candidates),addCandidates()}.bind(this),rtcSessionDescriptionInit={};rtcSessionDescriptionInit.type=obj.sessiondesc.type,rtcSessionDescriptionInit.sdp=obj.sessiondesc.sdp;var desc=new this.RTCSessionDescription(rtcSessionDescriptionInit);Drizzle.browser.mozilla&&Drizzle.browser.version>56&&(desc={}),desc.sdp=obj.sessiondesc.sdp,desc.type=obj.sessiondesc.type,this.peerConnectionInfo.remoteDesc=desc,this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] setRemoteDescription : "+VideoChatUtil.stringifyJSON(desc)),this.peerConnectionInfo.pc.setRemoteDescription(desc,remoteDescSuccessCallback,errorCallback)}else obj.candidates&&(this.peerConnectionInfo.remoteCandidates.push.apply(this.peerConnectionInfo.remoteCandidates,obj.candidates),this.peerConnectionInfo.remoteDesc&&addCandidates())}},VideoChatScreenShare.prototype.startRenegotiate=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RENEGOTIATION] Inside startRenegotiate");var mediaConstraints={offerToReceiveAudio:!1,offerToReceiveVideo:!0},errorCallback=function(err){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RENEGOTIATION] Renegotiation failed. "+err),delete this.peerConnectionInfo.localDesc,this.completeRenegotiation("failed")}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] local description set successfully"),this.sendSignals(this.peerConnectionInfo,VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_RENEGOTIATION)}.bind(this),createOfferSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] Create Offer Success. setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),this.peerConnectionInfo.localDesc=desc,this.peerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this);if((Drizzle.browser.mozilla||Drizzle.browser.chrome&&Drizzle.browser.version>=72)&&this.remoteUserScreenEnabledTimes>=this.currentParticipant.localUserScreenEnabledTimes){var transceiver=this.peerConnectionInfo.pc.addTransceiver("video");transceiver.direction="recvonly"}this.peerConnectionInfo.pc.createOffer(createOfferSuccessCallback,errorCallback,mediaConstraints)},VideoChatScreenShare.prototype.onRenegotiate=function(obj){if(this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RENEGOTIATION] Inside onRenegotiate"),obj.renegotiate)if("start"==obj.renegotiate.status)this.renegotiatingUser=this.zuid,this.startRenegotiate();else if("started"==obj.renegotiate.status)this.renegotiatingUser=this.zuid;else if("completed"==obj.renegotiate.status)this.renegotiatingUser=!1;else if("failed"==obj.renegotiate.status)return this.renegotiatingUser=!1,void this.handleFailureCase();if(obj.sessiondesc){var errorCallback=function(err){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RENEGOTIATION] renegotiation failed. "+err),delete this.peerConnectionInfo.localDesc,this.completeRenegotiation("failed")}.bind(this),localDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] local description set successfully"),this.sendSignals(this.peerConnectionInfo,VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_RENEGOTIATION)}.bind(this),createAnswerSuccessCallback=function(desc){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] Create Answer success. setLocalDescription : "+VideoChatUtil.stringifyJSON(desc)),this.peerConnectionInfo.localDesc=desc,this.peerConnectionInfo.pc.setLocalDescription(desc,localDescSuccessCallback,errorCallback)}.bind(this),remoteDescSuccessCallback=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] Remote description set successfully"),"offer"===this.peerConnectionInfo.pc.remoteDescription.type&&this.peerConnectionInfo.pc.createAnswer(createAnswerSuccessCallback,errorCallback)}.bind(this),rtcSessionDescriptionInit={};rtcSessionDescriptionInit.type=obj.sessiondesc.type,rtcSessionDescriptionInit.sdp=obj.sessiondesc.sdp;var desc=new this.RTCSessionDescription(rtcSessionDescriptionInit);Drizzle.browser.mozilla&&Drizzle.browser.version>56&&(desc={}),desc.sdp=obj.sessiondesc.sdp,desc.type=obj.sessiondesc.type,this.peerConnectionInfo.remoteDesc=desc,this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [REMOTE_DESC] "+VideoChatUtil.stringifyJSON(desc)),this.peerConnectionInfo.pc.setRemoteDescription(desc,remoteDescSuccessCallback,errorCallback)}},VideoChatScreenShare.prototype.completeRenegotiation=function(status){if(this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RENEGOTIATION] "+status),"completed"==status){this.renegotiatingUser=!1;var renegotiate={};renegotiate.status="completed",this.peerConnectionInfo.renegotiate=renegotiate,this.sendSignals(this.peerConnectionInfo,VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_RENEGOTIATION)}else if("failed"==status){this.renegotiatingUser=!1;var renegotiate={};renegotiate.status="failed",this.peerConnectionInfo.renegotiate=renegotiate,this.sendSignals(this.peerConnectionInfo,VideoConstants.MESSAGE_SCREENSHARE_WEBRTC_RENEGOTIATION)}},VideoChatScreenShare.prototype.setFirstScreenShareUser=function(value){this.firstScreenShareUser=value},VideoChatScreenShare.prototype.getRemoteScreenStream=function(){return this.peerConnectionInfo.remoteScreenStream},VideoChatScreenShare.prototype.setRemoteScreenStream=function(value){if(this.remoteScreenStream=value,this.remoteScreenStream.getTracks)for(var track=this.remoteScreenStream.getTracks(),i=0;i<track.length;i++)track[i].stop();0!=Object.keys(this.peerConnectionInfo).length&&(this.peerConnectionInfo.remoteScreenStream=!1)},VideoChatScreenShare.prototype.handleFailureCase=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] handleFailureCase called"),0!=this.currentParticipant.getLocalScreenStream()&&this.videoChatAPI.removeScreenShare(),0!=this.remoteScreenStream&&this.videoChatAPI.removeRemoteScreenShare(this.zuid),this.currentParticipant.screenStopChat("failure_case"),this.stopChat("failure_case")},VideoChatScreenShare.prototype.stopChat=function(){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] stopChat called"),0!=Object.keys(this.peerConnectionInfo).length&&(this.peerConnectionInfo.pc.close(),this.peerConnectionInfo.remoteScreenStream=!1,this.peerConnectionInfo={}),this.reconnectionState=!1,this.remoteScreenStream=!1,this.firstScreenShareUser=!1,0!=this.disconnectNotifyTimer&&(clearTimeout(this.disconnectNotifyTimer),this.disconnectNotifyTimer=!1)},VideoChatScreenShare.prototype.sendDisconnectNotify=function(){this.videoChatAPI.videoChatHandler.handleScreenShareReconnect(this.reconnectionState="started",this.zuid),this.reconnectionId=this.reconnectionId+1,this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState);var conn_id="screenshare";this.tryToSendDisconnectNotify(conn_id,this.reconnectionId)},VideoChatScreenShare.prototype.tryToSendDisconnectNotify=function(connId,reconnection_id){if(this.reconnectionTime>=3e5)return this.reconnectionState="failed",this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState),void this.videoChatAPI.videoChatHandler.handleScreenShareReconnect(this.reconnectionState,this.zuid);var func=function(connId,reconnection_id){this.disconnectNotifyTimer=setTimeout(function(){"started"==this.reconnectionState&&(this.videoChatAPI.videoChatHandler.handleScreenShareReconnect(this.reconnectionState="in_progress",this.zuid),this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] [RECONNECTION_STATE] id: "+this.reconnectionId+" "+this.reconnectionState)),0!=this.videoChatAPI.getSessionId()&&this.tryToSendDisconnectNotify(connId,reconnection_id),this.reconnectionTime=this.reconnectionTime+5e3}.bind(this),5e3)}.bind(this);navigator.onLine===!0&&VideoChatContainer.getWmsServerUpStatus()===!0?this.isAlreadyProcessedReconnectionId(reconnection_id)===!1&&(this.videoChatAPI.sendDisconnectNotify(this.zuid,reconnection_id,this.currentParticipant.getScreenShareAvailable()),func(connId,reconnection_id)):func(connId,reconnection_id)},VideoChatScreenShare.prototype.isAlreadyProcessedReconnectionId=function(reconnection_id){for(var i=0;i<this.processedReconnectionIdList.length;i++)if(this.processedReconnectionIdList[i]==reconnection_id)return!0;return!1},VideoChatScreenShare.prototype.reconnection=function(connId,reconnection_id,otherSideScreenShareAvailable){this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] reconnection : connectionId="+connId+",reconnectionId="+reconnection_id),this.processedReconnectionIdList.push(reconnection_id),this.reconnectionId=parseInt(reconnection_id),this.isPreviousPeerConnectionInfoCleared===!1&&(this.peerConnectionInfo.pc.close(),this.peerConnectionInfo.remoteScreenStream=!1,this.peerConnectionInfo={},this.isPreviousPeerConnectionInfoCleared=!0),this.removeScreenSharePending===!0&&(this.videoChatAPI.removeScreenShare(this.zuid),this.removeScreenSharePending=!1),(this.currentParticipant.getScreenShareAvailable(!0)||1==otherSideScreenShareAvailable)&&this.startScreenSharing(),this.isPreviousPeerConnectionInfoCleared=!1,this.reconnectionTime=0},VideoChatLocalParticipant.prototype.init=function(){this.zuid=VideoChatContainer.getCurrentUserZuid(),this.username=VideoChatContainer.getCurrentUserName(),Drizzle.browser.chrome&&navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia&&(this.chromeExtensionAvailable=!0,this.inBuildChromeScreenAPI=!0),this.handler=function(event){this.receiveMessage(event)}.bind(this),window.addEventListener("message",this.handler),0==this.chromeExtensionAvailable&&this.checkChromeExtAvailable()},VideoChatLocalParticipant.prototype.getZuid=function(){return this.zuid},VideoChatLocalParticipant.prototype.getUserName=function(){return this.username},VideoChatLocalParticipant.prototype.getPhotoURL=function(){return this.photoURL},VideoChatLocalParticipant.prototype.getPermissionState=function(){return this.permissionState},VideoChatLocalParticipant.prototype.getPermissionPending=function(){return this.permissionPending},VideoChatLocalParticipant.prototype.getLocalSrc=function(){return this.getLocalStream()?window.URL.createObjectURL(this.getLocalStream()):!1},VideoChatLocalParticipant.prototype.getLocalStream=function(){return this.localStream},VideoChatLocalParticipant.prototype.getLocalScreenStream=function(){return this.localScreenStream},VideoChatLocalParticipant.prototype.getScreenShareAvailable=function(){return this.screenShareAvailable},VideoChatLocalParticipant.prototype.getICEServers=function(){return this.iceServers},VideoChatLocalParticipant.prototype.getScreenICEServers=function(){return 0==this.screenIceServers?this.getICEServers():this.screenIceServers},VideoChatLocalParticipant.prototype.getLocalFrequency=function(){return this.localFrequency},VideoChatLocalParticipant.prototype.setPhotoURL=function(userPhoto){this.photoURL=userPhoto},VideoChatLocalParticipant.prototype.setScreenShareAvailable=function(value){this.screenShareAvailable=value},VideoChatLocalParticipant.prototype.setICEServers=function(servers){if("string"==typeof servers){this.iceServers=VideoChatUtil.parseJSON(servers);var iceservers=this.iceServers.iceServers;if(iceservers)for(var i in iceservers)iceservers[i].username&&(iceservers[i].credential=decodeURIComponent(iceservers[i].credential),iceservers[i].credential=iceservers[i].credential.replace(/%S2F/g,"/"))}else this.iceServers="object"==typeof servers?servers:null;if(null!=this.iceServers&&(Drizzle.browser.safari===!0||Drizzle.browser.mozilla&&Drizzle.browser.version>56))for(var i in iceservers)iceservers[i].urls=iceservers[i].url,delete iceservers[i].url},VideoChatLocalParticipant.prototype.setScreenICEServers=function(servers){if("string"==typeof servers){this.screenIceServers=VideoChatUtil.parseJSON(servers);var iceservers=this.screenIceServers.iceServers;if(iceservers)for(var i in iceservers)iceservers[i].username&&(iceservers[i].credential=decodeURIComponent(iceservers[i].credential),iceservers[i].credential=iceservers[i].credential.replace(/%S2F/g,"/"))}else this.screenIceServers="object"==typeof servers?servers:null;if(null!=this.screenIceServers&&(Drizzle.browser.safari===!0||Drizzle.browser.mozilla&&Drizzle.browser.version>56))for(var i in iceservers)iceservers[i].urls=iceservers[i].url,delete iceservers[i].url},VideoChatLocalParticipant.prototype.checkChromeExtAvailable=function(){setTimeout(function(){var isAvaiableCallback=function(result){this.isExtAvailable=result}.bind(this);this.isChromeExtensionAvailable(isAvaiableCallback)}.bind(this),2e3)},VideoChatLocalParticipant.prototype.setDevices=function(devices){var type=this.videoChatAPI.getChatType();if(0==this.constraints&&("video"===type||"voicewhivi"===type&&1===window.voicewhiviapproach?(this.constraints={audio:!0,video:{mandatory:{minFrameRate:"10",maxFrameRate:"10"},optional:[]}},Drizzle.browser.chrome&&Drizzle.browser.version>=59&&(this.constraints={audio:!0,video:{frameRate:"10"}})):this.constraints={video:!1,audio:!0}),devices instanceof Array)for(var i=0;i<devices.length;i++){var device=devices[i];"audioinput"==device.kind?this.constraints.audio={deviceId:{exact:device.deviceId}}:"videoinput"==device.kind?this.constraints.video.mandatory?this.constraints.video.mandatory.sourceId=device.deviceId:this.constraints.video&&(this.constraints.video.deviceId={exact:device.deviceId}):"audiooutput"==device.kind&&this.videoChatAPI.setSpeakerDevice(device)}this.videoChatAPI.updateLogMessage("[CONSTRAINT] "+VideoChatUtil.stringifyJSON(this.constraints))},VideoChatLocalParticipant.prototype.showPermissionDialog=function(type,callback1,callback2,switchMode){var PERMISSION_DIALOG_TIMEOUT_FUNC=!1;this.permissionPending=!0,this.permissionState=!1;var captureConstraints=this.constraints;switchMode&&(Drizzle.browser.mozilla||Drizzle.browser.chrome===!0&&Drizzle.browser.version>=72)&&("screen"==type||"videoToScreen"==type?captureConstraints={audio:!1,video:{mediaSource:"screen"}}:("video"==type||"screenToVideo"==type)&&(captureConstraints={audio:!1,video:this.constraints.video}));var timeDelay=200,errorCallback=function(err){"granted"!=this.permissionState&&"denied"!=this.permissionState&&(this.permissionState=0==this.permissionState?"blocked":"denied",this.videoChatAPI.updateLogMessage("[PERMISSION_STATE] "+this.permissionState+" Reason : "+err),this.videoChatAPI.videoChatHandler.handleMediaPermission(this.permissionState),this.permissionPending=!1,clearTimeout(PERMISSION_DIALOG_TIMEOUT_FUNC),Drizzle(document).unbind("click"),Drizzle(document).unbind("focus"),callback2&&callback2())}.bind(this),successCallback=function(stream){if((0!=this.videoChatAPI.isLoggedInUserIsOwner()||0!=this.videoChatAPI.getSessionId())&&"granted"!=this.permissionState&&"denied"!=this.permissionState&&(this.permissionState="granted",this.videoChatAPI.updateLogMessage("[PERMISSION_STATE] "+this.permissionState),this.videoChatAPI.videoChatHandler.handleMediaPermission(this.permissionState),this.permissionPending=!1,clearTimeout(PERMISSION_DIALOG_TIMEOUT_FUNC),Drizzle(document).unbind("click"),Drizzle(document).unbind("focus"),callback1)){var evt={};if(evt.stream=stream,0!=this.localStream&&1==this.isMicOff())for(var audioTrack=stream.getAudioTracks(),i=0;i<audioTrack.length;i++)audioTrack[i].enabled=!1;callback1(evt)}}.bind(this),func=function(){if(this.permissionPending===!0)if(Drizzle.browser.mozilla&&Drizzle.browser.version>56||Drizzle.browser.safari&&Drizzle.browser.version>11?navigator.mediaDevices.getUserMedia(captureConstraints).then(successCallback).catch(errorCallback):navigator.getUserMedia(captureConstraints,successCallback,errorCallback),Drizzle.browser.mozilla===!0){var callback1=function(){Drizzle(document).unbind("click"),Drizzle(document).unbind("focus");var remoteParticipant=this.videoChatAPI.getRemoteParticipants()[0];remoteParticipant&&1!=remoteParticipant.videoChatWebRTC.chatAnswered&&setTimeout(func,1500)}.bind(this);Drizzle(document).bind("click",callback1),Drizzle(document).bind("focus",callback1),timeDelay=500}else Drizzle.browser.chrome===!0&&(timeDelay=200)}.bind(this);func();var func1=function(){this.permissionPending===!0&&(this.permissionState="pending",this.videoChatAPI.updateLogMessage("[PERMISSION_STATE] "+this.permissionState),this.videoChatAPI.videoChatHandler.handleMediaPermission(this.permissionState))}.bind(this);PERMISSION_DIALOG_TIMEOUT_FUNC=setTimeout(func1,timeDelay)},VideoChatLocalParticipant.prototype.permissionDialogSuccessCallback=function(type,evt){this.localStream=evt.stream,this.printLocalTracks(),this.videoChatAPI.videoChatHandler.handleLocalStream(this.localStream),"voicewhivi"===type&&1===window.voicewhiviapproach&&this.cameraOff()},VideoChatLocalParticipant.prototype.printFrequency=function(){this.videoChatAPI.updateLogMessage("[LOCAL_FREQUENCY] "+this.localFrequency)},VideoChatLocalParticipant.prototype.micOn=function(){if(this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] mic is on"),this.getLocalStream()){for(var audioTrack=this.getLocalStream().getAudioTracks(),i=0;i<audioTrack.length;i++)audioTrack[i].enabled=!0;return!0}return!1},VideoChatLocalParticipant.prototype.micOff=function(){if(this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] mic is off"),this.getLocalStream()){for(var audioTrack=this.getLocalStream().getAudioTracks(),i=0;i<audioTrack.length;i++)audioTrack[i].enabled=!1;return!0}return!1},VideoChatLocalParticipant.prototype.isMicOff=function(){if(this.getLocalStream())for(var audioTrack=this.getLocalStream().getAudioTracks(),i=0;i<audioTrack.length;i++)if(audioTrack[i].enabled)return!1;return!0},VideoChatLocalParticipant.prototype.cameraOff=function(){if(this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] camera is off"),this.getLocalStream()){for(var videoTrack=this.getLocalStream().getVideoTracks(),i=0;i<videoTrack.length;i++)videoTrack[i].enabled=!1;return!0}return!1},VideoChatLocalParticipant.prototype.isCameraOff=function(){if(this.getLocalStream())for(var videoTrack=this.getLocalStream().getVideoTracks(),i=0;i<videoTrack.length;i++)if(videoTrack[i].enabled)return!1;return!0},VideoChatLocalParticipant.prototype.cameraOn=function(){if(this.videoChatAPI.updateLogMessage("[MEDIA_STATUS] camera is on"),this.getLocalStream()){for(var videoTrack=this.getLocalStream().getVideoTracks(),i=0;i<videoTrack.length;i++)videoTrack[i].enabled=!0;return!0}return!1},VideoChatLocalParticipant.prototype.showSwitchDialog=function(switchType,callback1,callback2){var errorCallback=function(){for(var ps=this.videoChatAPI.getRemoteParticipants(),i=0;i<ps.length;i++)ps[i].videoChatWebRTC.renegotiatingUser=!1;callback2&&callback2()}.bind(this),successCallback=function(evt){if((Drizzle.browser.chrome===!0&&Drizzle.browser.version<=71||Drizzle.browser.safari===!0||Drizzle.browser.edge===!0)&&this.getLocalStream().getTracks)for(var track=this.getLocalStream().getTracks(),i=0;i<track.length;i++)track[i].stop(),this.getLocalStream().removeTrack(track[i]);(Drizzle.browser.mozilla||Drizzle.browser.chrome===!0&&Drizzle.browser.version>=72)&&evt.stream.addTrack(this.getLocalStream().getAudioTracks()[0]),this.localStream=evt.stream,this.printLocalTracks(),this.releaseLocalMonitor(),this.initLocalMonitor(),callback1&&callback1()}.bind(this);!Drizzle.browser.chrome||"screen"!=switchType&&"videoToScreen"!=switchType?("video"!=switchType&&"screenToVideo"!=switchType||0!=this.constraints.video||(this.constraints.video={mandatory:{minFrameRate:"10",maxFrameRate:"10"},optional:[]},Drizzle.browser.chrome&&Drizzle.browser.version>=59&&(this.constraints.video={frameRate:"10"})),this.showPermissionDialog(switchType,successCallback,errorCallback,!0)):this.showScreenShareDialog(successCallback,errorCallback)},VideoChatLocalParticipant.prototype.showScreenShareDialog=function(callback1,callback2){if(1==this.isExtAvailable){var screenContraintscallback=function(screen_constraints){var successcallback=function(stream){var screenStream=stream,chromeScreenShareStopCallback=function(){this.videoChatAPI.videoChatHandler.handleStopSharing(),this.videoChatAPI.isScreenEnabled=!1}.bind(this);screenStream.getVideoTracks()[0].onended=chromeScreenShareStopCallback;var audioSucesscallback=function(audioStream){if(1==this.isMicOff())for(var audioTrack=audioStream.getAudioTracks(),i=0;i<audioTrack.length;i++)audioTrack[i].enabled=!1;stream.addTrack(audioStream.getAudioTracks()[0]);var evt={};evt.stream=stream,callback1(evt)}.bind(this),auidoErrorCallback=function(){}.bind(this);navigator.getUserMedia({audio:!0},audioSucesscallback,auidoErrorCallback)}.bind(this),errorcallback=function(){callback2&&callback2()}.bind(this);navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia({audio:!1,video:screen_constraints},successcallback,errorcallback)}.bind(this);this.getScreenConstraints(screenContraintscallback)}else{var successcallback=function(){this.isExtAvailable=!0,setTimeout(function(){this.showScreenShareDialog(callback1,callback2)}.bind(this),2e3)}.bind(this),errorcallback=function(){callback2&&callback2()};if("undefined"!=typeof chrome){var llink=document.createElement("link");llink.rel="chrome-webstore-item",llink.href="https://chrome.google.com/webstore/detail/amdlbhchbncikhefhcbmcdcgadlggdlb",document.head.appendChild(llink),chrome.webstore.install(null,successcallback,errorcallback)}}},VideoChatLocalParticipant.prototype.initLocalMonitor=function(){0==this.localAudioCtx&&(this.localAudioCtx=new(window.AudioContext||window.webkitAudioContext),this.localSourceNode=this.localAudioCtx.createMediaStreamSource(this.getLocalStream()),this.localDestNode=this.localAudioCtx.createMediaStreamDestination(),this.localAnalyser=this.localAudioCtx.createAnalyser(),this.localSourceNode.connect(this.localAnalyser),this.localAnalyser.connect(this.localDestNode))},VideoChatLocalParticipant.prototype.releaseLocalMonitor=function(){this.localAudioCtx&&(this.localAudioCtx.close(),this.localAudioCtx=!1),this.localSourceNode&&(this.localSourceNode.disconnect(),this.localSourceNode=!1),this.localDestNode&&(this.localDestNode.disconnect(),this.localDestNode=!1),this.localAnalyser&&(this.localAnalyser.disconnect(),this.localAnalyser=!1),this.isMonitoring=!1},VideoChatLocalParticipant.prototype.monitorAudioFrequency=function(){if(1!=this.isMonitoring){this.isMonitoring=!0;var updateAudioFrequency=function(){if(this.localAnalyser){var value=0!=this.currentLocalFrequency?"T":this.isMicOff()?"F":"-";this.localFrequency+=value,setTimeout(updateAudioFrequency,2e3)}}.bind(this),monitorFrequency=function(){if(this.localAnalyser){var localByteData=new Uint8Array(this.localAnalyser.frequencyBinCount);this.localAnalyser.getByteFrequencyData(localByteData);var maxLocalFreq=Math.max.apply(null,localByteData);this.currentLocalFrequency=maxLocalFreq,requestAnimationFrame(monitorFrequency)}}.bind(this);setTimeout(function(){monitorFrequency(),updateAudioFrequency()},1e3)}},VideoChatLocalParticipant.prototype.printAvailableDevices=function(){var printDevices=function(devices){for(var i=(this.videoChatAPI.getChatType(),0);i<devices.length;i++){var d=devices[i];this.videoChatAPI.updateLogMessage("[DEVICE_INFO] kind="+d.kind+", label="+d.label+", deviceId="+d.deviceId)}}.bind(this);navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices&&navigator.mediaDevices.enumerateDevices().then(printDevices)},VideoChatLocalParticipant.prototype.printLocalTracks=function(){for(var tracks=this.getLocalStream().getTracks(),i=0;i<tracks.length;i++)this.videoChatAPI.updateLogMessage("[LOCAL_TRACKS] kind="+tracks[i].kind+", label="+tracks[i].label)},VideoChatLocalParticipant.prototype.receiveMessage=function(event){event.origin===window.location.origin&&"String"!=event.data&&"ZOHOCLIQ-EXTENSION"==event.data.source&&("extn_check"==event.data.requestId?this.chromeExtensionAvailable=!0:"get_sourceId"==event.data.requestId&&0!=this.screenCallback&&this.screenCallback(this.sourceId=event.data.message.data))},VideoChatLocalParticipant.prototype.getSourceId=function(callback){this.screenCallback=callback,window.postMessage({requestId:"get_sourceId",message:"ZOHOCLIQ-GET-SCREEN-SOURCEID"},"*")},VideoChatLocalParticipant.prototype.getScreenConstraints=function(screencontraintscallback){var screen_constraints={mandatory:{chromeMediaSource:"desktop"}},callback=function(id){screen_constraints.mandatory.chromeMediaSourceId=id,screencontraintscallback(screen_constraints)};this.getSourceId(callback)},VideoChatLocalParticipant.prototype.isChromeExtensionAvailable=function(callback){1==this.chromeExtensionAvailable&&callback(!0),window.postMessage({requestId:"extn_check",message:"ZOHOCLIQ-EXTN-CHECK"},"*"),setTimeout(function(){callback(0==this.chromeExtensionAvailable?!1:!0)}.bind(this),2e3)},VideoChatLocalParticipant.prototype.showScreenSharePermission=function(callback1,callback2){if(Drizzle.browser.chrome)if(1==this.chromeExtensionAvailable){var successcallback=function(stream){this.localScreenStream=stream,callback1&&callback1();var chromeScreenShareStopCallback=function(){this.setScreenShareAvailable(!1),this.videoChatAPI.removeScreenShare(),this.localScreenStream=!1}.bind(this);this.localScreenStream.getVideoTracks()[0].onended=chromeScreenShareStopCallback}.bind(this),errorcallback=function(){callback2&&callback2()}.bind(this),screenContraintscallback=function(screen_constraints){navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia,navigator.getUserMedia({audio:!1,video:screen_constraints},successcallback,errorcallback)}.bind(this);0==this.inBuildChromeScreenAPI?this.getScreenConstraints(screenContraintscallback):navigator.mediaDevices.getDisplayMedia({video:!0}).then(successcallback).catch(errorcallback)}else callback2&&callback2(),this.videoChatAPI.videoChatHandler.handleChromeExtNotAvailable();else if(Drizzle.browser.mozilla){var captureConstraints={audio:!1,video:{mediaSource:"screen"}},successCallback=function(stream){this.localScreenStream=stream,callback1&&callback1()}.bind(this),errorCallback=function(){callback2&&callback2()}.bind(this);Drizzle.browser.mozilla&&Drizzle.browser.version>56?navigator.mediaDevices.getUserMedia(captureConstraints).then(successCallback).catch(errorCallback):navigator.getUserMedia(captureConstraints,successCallback,errorCallback)}},VideoChatLocalParticipant.prototype.addExtInstall=function(){return window.open("https://chrome.google.com/webstore/detail/zoho-cliq/amdlbhchbncikhefhcbmcdcgadlggdlb/","ext-page"),this.extCheckCount>0?void(this.extCheckCount=0):void setTimeout(function(){var isAvaiableCallback=function(result){0==result?this.extCheckCount<60&&setTimeout(function(){this.isChromeExtensionAvailable(isAvaiableCallback),this.extCheckCount=this.extCheckCount+1}.bind(this),2e3):(this.videoChatAPI.addScreenShare(),this.videoChatAPI.videoChatHandler.handleScreenOnButton())}.bind(this);this.isChromeExtensionAvailable(isAvaiableCallback)}.bind(this),2e3)},VideoChatLocalParticipant.prototype.removeScreenShare=function(){for(var participants=this.videoChatAPI.getRemoteParticipants(),i=0;i<participants.length;i++){var p=participants[i];("started"==p.videoChatScreenShare.reconnectionState||"in_progress"==p.videoChatScreenShare.reconnectionState)&&(p.videoChatScreenShare.removeScreenSharePending=!0)}if(this.setScreenShareAvailable(!1),this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] removeScreenShare called"),this.videoChatAPI.chatAnswered===!1)return void this.videoChatAPI.stopChat();if(0!=this.getLocalScreenStream()){if(this.getLocalScreenStream().getTracks)for(var track=this.getLocalScreenStream().getTracks(),i=0;i<track.length;i++)track[i].stop(),this.getLocalScreenStream().removeTrack(track[i]);for(var i=0;i<participants.length;i++){var p=participants[i];p.videoChatScreenShare.peerConnectionInfo.pc&&(Drizzle.browser.chrome===!0&&Drizzle.browser.version<=71||Drizzle.browser.safari===!0||Drizzle.browser.edge===!0?p.videoChatScreenShare.peerConnectionInfo.pc.removeStream(this.getLocalScreenStream()):(p.videoChatScreenShare.peerConnectionInfo.pc.removeTrack(p.videoChatScreenShare.sender),p.videoChatScreenShare.sender=!1))}}this.localScreenStream=!1},VideoChatLocalParticipant.prototype.stopChat=function(){if(this.getLocalStream()&&this.getLocalStream().getTracks)for(var track=this.getLocalStream().getTracks(),i=0;i<track.length;i++)track[i].stop();this.zuid=this.username=this.photoURL=!1,this.iceServers=this.permissionPending=this.permissionState=this.constraints=!1,this.localStream=this.localAudioCtx=this.localSourceNode=this.localDestNode=this.localAnalyser=!1,this.isExtAvailable=this.sourceId=this.screenCallback=this.chromeExtensionAvailable=!1,this.screenIceServers=this.isMonitoring=!1,this.localFrequency="",this.currentLocalFrequency=0,this.extCheckCount=0},VideoChatLocalParticipant.prototype.screenStopChat=function(reason){if(this.videoChatAPI.updateLogMessage("[SCREENSHARE_WEBRTC] screenStopChat called"),this.getLocalScreenStream()&&this.getLocalScreenStream().getTracks)for(var track=this.getLocalScreenStream().getTracks(),i=0;i<track.length;i++)track[i].stop();this.screenShareAvailable=!1,this.localScreenStream=!1,void 0===reason&&window.removeEventListener("message",this.handler)},VideoChatLocalParticipant.prototype.setChromeExtensionAvailable=function(value){this.chromeExtensionAvailable=value},VideoChatRemoteParticipant.prototype.clear=function(){this.zuid=this.username=this.photoURL=this.chatRunningTime=this.updateRunningTimeStarted=this.localConnected=this.remoteConnected=!1,this.fromDevice=this.chatReceived=this.chatAnswered=this.switchMode=this.screenMode=this.connectionId=!1,this.remoteMicStatus=1,this.remoteHoldStatus=0,this.remoteCameraStatus=1},VideoChatRemoteParticipant.prototype.getZuid=function(){return this.zuid},VideoChatRemoteParticipant.prototype.getUserName=function(){return this.username},VideoChatRemoteParticipant.prototype.getPhotoURL=function(){return this.photoURL},VideoChatRemoteParticipant.prototype.getChatRunningTime=function(){return this.chatRunningTime},VideoChatRemoteParticipant.prototype.isTimerStarted=function(){return this.updateRunningTimeStarted},VideoChatRemoteParticipant.prototype.isLocalConnected=function(){return this.localConnected},VideoChatRemoteParticipant.prototype.isRemoteConnected=function(){return this.remoteConnected},VideoChatRemoteParticipant.prototype.getFromDevice=function(){return this.fromDevice},VideoChatRemoteParticipant.prototype.isChatAnswered=function(){return this.chatAnswered},VideoChatRemoteParticipant.prototype.isChatReceived=function(){return this.chatReceived},VideoChatRemoteParticipant.prototype.getSwitchMode=function(){return this.switchMode},VideoChatRemoteParticipant.prototype.getScreenMode=function(){return this.screenMode},VideoChatRemoteParticipant.prototype.getConnectionId=function(){return this.connectionId},VideoChatRemoteParticipant.prototype.getRemoteMicStatus=function(){return this.remoteMicStatus},VideoChatRemoteParticipant.prototype.getRemoteCameraStatus=function(){return this.remoteCameraStatus},VideoChatRemoteParticipant.prototype.getRemoteHoldStatus=function(){return this.remoteHoldStatus},VideoChatRemoteParticipant.prototype.setZuid=function(id){this.zuid=id},VideoChatRemoteParticipant.prototype.setUserName=function(name){this.username=name},VideoChatRemoteParticipant.prototype.setPhotoURL=function(url){this.photoURL=url},VideoChatRemoteParticipant.prototype.setChatRunningTime=function(time){this.chatRunningTime=time},VideoChatRemoteParticipant.prototype.setTimerStarted=function(value){this.updateRunningTimeStarted=value},VideoChatRemoteParticipant.prototype.setLocalConnected=function(value){this.localConnected=value},VideoChatRemoteParticipant.prototype.setRemoteConnected=function(value){this.remoteConnected=value},VideoChatRemoteParticipant.prototype.setFromDevice=function(device){this.fromDevice=device},VideoChatRemoteParticipant.prototype.setChatAnswered=function(value){this.chatAnswered=value},VideoChatRemoteParticipant.prototype.setChatReceived=function(value){this.chatReceived=value},VideoChatRemoteParticipant.prototype.setSwitchMode=function(value){this.switchMode=value},VideoChatRemoteParticipant.prototype.setScreenMode=function(value){this.screenMode=value},VideoChatRemoteParticipant.prototype.setConnectionId=function(connId){this.connectionId=connId},VideoChatRemoteParticipant.prototype.setRemoteMicStatus=function(value){this.remoteMicStatus=value},VideoChatRemoteParticipant.prototype.setRemoteCameraStatus=function(value){this.remoteCameraStatus=value},VideoChatRemoteParticipant.prototype.setRemoteHoldStatus=function(value){this.remoteHoldStatus=value},VideoChatRemoteParticipant.prototype.getRemoteVideoEnabled=function(){return this.videoChatWebRTC.getRemoteVideoEnabled()},VideoChatRemoteParticipant.prototype.setRemoteVideoEnabled=function(value){this.videoChatWebRTC.setRemoteVideoEnabled(value)};
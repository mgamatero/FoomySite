"use strict";window.zmStreamsApp=window.zmStreamsApp||{},window.zmStreamsApp.CommentModule=function(z){var C=z.models,k=z.views,g=zmStreamsApp.constants.notifications,S=function(t){var e,i;return e=t.group?t.group.id?t.group.id:t.group:zmail.zuid,t.eid&&-1===t.eid.indexOf("#")&&e&&(t.eid=e+"#"+t.eid),C&&C.comments&&(i=_.find(C.comments.models,function(e){return e.id===t.eid})),i};z.updateInvitees=function(e){var t=S(e);if(t){var i="",a="";"addInvitee"===e.type?i=e.inviteeList:a=e.inviteeList,t.trigger("change:inviteeList",i,a)}},z.removeViews=function(e){var i;_.each(e,function(e){i=$.e(e).data();var t=S({eid:i.id});t&&t.getView(i.commentviewid).onClose()})},z.retainComment=function(e){var t=$.e(e).find(".sc_cmdv.SCS_cmnt");if(t.length){var i,a=$.e(t[0]).data(),n=S({eid:a.id});if(n&&(i=n.getView(a.commentviewid))){var s=e.getElementsByTagName("TEXTAREA")[0];s&&i.saveUnpost(s)}}},"undefined"!=typeof zmComponent&&zmComponent.notifier&&zmComponent.notifier.addHandler("streams",function(e,t){t=t.data||{},"string"==typeof(t=_zm.copyOf(t)).group&&(t.group=$.parseJSON(t.group));var i=t.ntype;if(i!==g.bulk_delete){(i===g.add_comment||i===g.comment_group_mention||i===g.comment_mention)&&function(e,t){var i=t.gid+"#"+t.pid;if(-1!==["commentAdd"].indexOf(t.key)&&C.comments){var a=_.find(C.comments.models,function(e){return e.id===t.pid});a||(a=_.find(C.comments.models,function(e){return e.id===i})),a&&(t.data&&t.data.cmnt?a.updateModel({comment:t.data.cmnt},a,"add"):a.getsinglecomment(t.cid,"","update"))}}(0,{key:"commentAdd",pid:t.eid,cid:t.commentuuid,gid:t.group.id});var a=S(t);if(a){var n=i===g.like_comment,s=i===g.unlike_comment;if(n||s){var o=a.pickComment(t.commentuuid).index,m=_zm.copyOf(a.get("comments"));if(-1!==o){var r=m[o].liked;t.nby===zmail.zuid&&r!==n&&(m[o].liked=n);var l=m[o].likes;l=n?l+1:l-1,m[o].likes=l;var d=m[o].likeList||{},c=m[o].likeZidList||[],p=d.hasOwnProperty(t.nby);if(n)if(p)_.size(d)&&(m[o].likes=l-1);else{var h=(_.isArray(t.nBy)?t.nBy[0]:JSON.parse(t.nBy)[0])[t.nby]||"";d[t.nby]=h,c.unshift(parseInt(t.nby))}else s&&(p?(delete d[t.nby],c=_.without(c,t.nby)):_.size(d)&&(m[o].likes=l+1));m[o].likeList=d,m[o].likeZidList=c,a.set("comments",m),a.trigger("change:like",t.commentuuid)}}if(i===g.add_private_comment){var u={parentuuid:t.parentuuid,by:t.nby};a.getsinglecomment(t.commentuuid,"","wmsprivatecomment",u)}if(i===g.delete_comment){var v=_zm.copyOf(t.commentuuid);if(_.isArray(v))for(var f=0;f<v.length;f++)-1!==a.pickComment(v[f]).index&&(t.commentuuid=v[f],a.updateModel({comment:t},a,"del"));else-1!==a.pickComment(t.commentuuid).index&&a.updateModel({comment:t},a,"del")}i===g.delete_post&&a.set("isDeleted",!0),i===g.delete_private_comment&&a.updateModel({comment:t},a,"deletePrivate")}}});return z.init=function(e,t,i){void 0!==zmStreamsApp.GroupApp&&zmStreamsApp.GroupApp.fetchHashTags(),C.comments||(C.comments=new C.CommentCollection({})),z.resizeFn=e.resizeComment,e.parentElm=t;var a,n,s,o,m,r,l,d,c=e.isNewCollabUser,p=e.hideComponent,h=S({eid:e.id,group:e.groupId});if(h){n=h,a=zmStreamsApp.CommentModule.parseInput(e,!0),n.set("attachIndex",a.attachIndex+1);var u=a.comments;if(h.set({privateToOwner:a.privateToOwner,mention:a.mention,inviteeList:a.inviteeList,group:a.group,allowInvite:a.allowInvite}),a.groupsMention&&h.set("groupsMention",a.groupsMention),e.cached)a=void 0;else if(u.length>h.get("comments").length||a.total!==h.get("total"))h.set({comments:u,total:a.total});else if(u.length){for(var v,f=_zm.copyOf(h.get("comments")),g=0;g<u.length;g++)-1!==(v=h.pickComment(u[g].id)).index&&(f[v.index]=_zm.copyOf(u[g]));h.set("comments",f)}}else n=new C.Comments(e,{parse:!0}),C.comments.add(n);return n.get("fetchData")&&n.listAll(),s=n,o=t,m=i,r=a,l=c,d=p,new k.Comment({model:s,postElm:o,highlightComment:m,viewJSON:r,isNewCollabUser:l,hideComponent:d}).$el},z.getCommentTemplate=function(e){var t=z.templates.comments(e);$.e(e.elm).appendDOM(t)},z.sendPrivateToOwner=function(t,e){var i=_.find(C.comments.models,function(e){return e.id===t}),a=$.e(e).data("commentviewid");if(a){var n=i.getView(a);n&&n.addNewPrivate(e)}},z.disableComments=function(t,e){var i=_.find(C.comments.models,function(e){return e.id===t});i.set("disableComment",e),i.trigger("change:disableComment",e)},z.setMentions=function(t,e){var i=_.find(C.comments.models,function(e){return e.id===t});i.set("mention",e,{silent:!0}),"org"!==e&&(e=_.without(e,zmail.zuid)),i.trigger("change:mentionData",e)},z.getLockValue=function(t){var e;C&&C.comments&&(e=_.find(C.comments.models,function(e){return e.id===t}));var i=!1;return e&&(i=e.get("lockInvites")),i},$.subscribe("/mail/selectMail",function(e,t){var i=$.e(t.containerDOM).find(".sc_cmdv.SCS_cmnt").data(),a=S({eid:i.id});if(a){var n=a.getView(i.commentviewid);n&&(zmUtil.hideCommentBox()&&$.e(t.containerDOM).find(".SCS_postWra").show().find(".SCS_cmnt").show(),n.selectMail(t.mailID,t.mode))}}),z}(zmStreamsApp.CommentModule||Zmail.App.extend({})),function(){var e,a,n=zmText.get("streams");window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule=zmStreamsApp.CommentModule||Zmail.App.extend({}),zmStreamsApp.CommentModule.unPost={},zmStreamsApp.CommentModule.models=(e=zmStreamsApp.CommentModule.models,a=zmStreamsApp.CommentModule,e.Comments=Zmail.Model.extend({defaults:{eid:0},url:zmail.conPath+"/comment.do",serialized:function(e,t){var i,a={},n=this,s=t.mentions,o=t.commentId,m=this.get("shId"),r=t.parent;switch(t.callback=this.updateModel,e){case"addComment":if(a={mode:"add",mentions:s.mention,comments:t.text,actionType:"addComment"},t.replyTo&&(a.replyTo=t.replyTo),s.mention.length&&!t.rte){var l=s.offset;a.offsetstarts=l.from,a.offsetends=l.to,a.offsettexts=l.text}t.rte&&(a.rtf=t.rte),t.attTmpObj&&(a.attTmpObj=t.attTmpObj),t.attEntObj&&(a.attEntObj=t.attEntObj),t.cloudAttList&&(a.cloudAttList=t.cloudAttList),t.linkData&&zmStreamsApp.linkPreview.addDataToParams(t.linkData,a),this.get("isSharedFolder")&&(a.shId=m),t.reqTimeout=5e4;break;case"likeComment":a={mode:"like",like:t.like,actionType:t.actionType,authorZuid:t.author,commentId:o},t.setSessionId=!0;break;case"getAllComments":this.get("fetchData")?(a={accId:zmail.accId,comments:!0},t.url=zmail.conPath+"/mailComments.do"):(a={mode:"list",start:o,actionType:this.get("actionType"),count:11},t.extraParamObj={elm:t.elm});break;case"delete":a={mode:"del",actionType:"deleteComment",commentId:o},this.get("isSharedFolder")&&(a.shId=m),t.setSessionId=!0;break;case"addPrivate":a={mode:"add",actionType:"addComment",comments:t.comment,privateZuid:t.toZid,parentId:r},r&&"undefined"!==r||(a.isPrivateToPost=!0),t.setSessionId=!0;break;case"getLikes":a={mode:"like",actionType:"viewGroupEntity",commentId:o},t.extraParamObj={elm:t.elm};break;case"getsinglecomment":a={mode:"singlecomment",actionType:"viewGroupEntity",commentId:o},t.error=function(){};break;case"getRecipientsForMail":a={mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList",mode:"getMailShareData"},t.url=zmail.conPath+"/mailCollab.do"}return-1===t.url.indexOf("mailComments.do")?a.streamsView=!0:i="list",t.success=function(e){t.callback(e,n,i,t.ep)},-1===t.url.indexOf("mailCollab.do")&&(a.groupId=this.get("groupId"),a.entityType=this.get("etype"),a.entityId=this.getUnparsedId()),a},getUnparsedId:function(){var e=this.id;return e&&-1!==e.indexOf("#")&&(e=e.substring(e.indexOf("#")+1,e.length)),e},setView:function(e,t){var i=this.get("views")||{};i[e]=t,this.set("views",i)},getView:function(e){return(this.get("views")||{})[e]},removeView:function(e){var t=this.get("views")||{};delete t[e],_.isEmpty(t)&&this.trigger("destroy",this)},sendPrivate:function(e,t,i,a){this.sync("addPrivate",this,{parent:t,comment:e,toZid:i,error:a})},listAll:function(e,t,i){var a=this.pickComment(e).index,n=this.get("total");if(e&&-1!==a&&t!==n){var s=this.get("comments").length;if(s===n&&t+(n<t+11?n-t:11)<=s)return void this.trigger("change:listAll",e,i,!0)}return this.sync("getAllComments",this,{commentId:e,elm:i,error:function(e){_zm.succErrMsg("e",e.msg),i.removeClass("zmLock")}})},remove:function(e,t,i){return this.sync("delete",this,{commentId:e,isPrivate:t,parentId:i})},NewComment:function(t){var e=this,i=e.get("createEntityDeferredCallback");(t=t||{}).error=t.error||t.efn||function(){},"function"==typeof i?(e.set("lockInvites",t.lockInvites),i({mentions:t.sharedMailInvitees||t.mentions.mention,includeRecipients:t.includeRecipients,lockInvites:t.lockInvites,selectedMailIds:t.selectedMailIds}).done(function(){e.set("sharedApiCall",!1),e.set("createEntityDeferredCallback",void 0),e.set("entityExists",!0),e.get("isDraftShare")&&$.publish("/streams/draftShared",{draftId:e.getUnparsedId()}),e.sync("addComment",e,t)}).fail(function(e){(e=e||{}).error=e.error||{},e.error.message=e.error.message||n.common.labels.unknown,e.error.messageOpts=e.error.messageOpts||{},e.error.suppress=e.error.suppress||!1,e.error.messageOpts.suppress=e.error.suppress,t.error({message:e.error.message||n.common.labels.createCommentFail},e.error.messageOpts)})):e.sync("addComment",e,t)},pickComment:function(e){var t=this.get("comments"),i=_.pluck(t,"id").indexOf(e);return{commentObj:t[i],index:i}},getsinglecomment:function(e,t,i,a){var n=this.pickComment(e),s=this.get("replyTo"),o=_.pluck(s,"id").indexOf(e);if(-1!==n.index)return n.commentObj;if("popup"===i&&-1!==o)return s[o];if("wmsprivatecomment"===i){var m=this.getPvtComments(a.parentuuid);a.parentuuid&&(m=m.private);var r=[];for(var l in m)r=r.concat(m[l]);if(-1!==(o=_.pluck(r,"id").indexOf(e)))return m[o]}this.sync("getsinglecomment",this,{commentId:e,ep:{elm:t,type:i,dataObj:a}})},likeComment:function(e,t){var i=this.pickComment(e).commentObj,a=!i.liked,n=i.by,s=a?"likecomment":"unlikecomment";return this.sync("likeComment",this,{commentId:e,like:a,author:n,actionType:s,error:function(){t.removeClass("zmLockLike")}})},getRecipientsForMail:function(){var e=this.get("recipientList");if(e)return e[0].orgUsers||[];this.sync("getRecipientsForMail",this,{mailID:this.getUnparsedId(),useConversation:!1,zohoID:zmail.zuid,accountID:zmail.accId,requiredData:"recipientList"})},getPvtComments:function(e){return e?this.pickComment(e).commentObj:this.get("privateToOwner")},updateModel:function(e,t,i,a){if(i=i||this.data.mode,this.data){var n=this.data.mode;i="add"===n&&this.data.privateZuid||a&&"wmsprivatecomment"===a.type?"addPrivate":n,i="like"===n&&void 0===this.data.like?"getLikes":i}a&&"wmsprivatecomment"===a.type&&(this.data.parentId=a.dataObj.parentuuid,this.data.privateZuid=a.dataObj.by),"deletePrivate"===i&&(this.isPrivate=!0,i="del");var s,o=_zm.copyOf(t.get("comments")),m=this.data?this.data.commentId:"",r=t.get("miscData"),l=r&&r.mailID?r.mailID:"";switch(i){case"add":var d=e.comment,c=o;s=t.get("total"),c.push(d),s=isNaN(s)?c.length:s+1,t.set({total:s,comments:c}),$.publish("/streams/comment",{mode:"add",entityId:t.getUnparsedId(),etype:t.get("etype"),total:s,mailID:l}),t.get("sharedCall")||d.by!==zmail.zuid||t.get("isSharedFolder")||zmStreamsApp.PostApp.watchPost({gid:t.get("groupId"),pid:t.get("id")}),t.trigger("change:add");break;case"like":var p=t.pickComment(m).index,h=t.get("comments");h[p].liked=this.data.like;var u=h[p].likeList||{},v=h[p].likeZidList||[],f=u.hasOwnProperty(zmail.zuid),g=this.data.like;if(g&&!f||!g&&f){var z=h[p].likes;if(z=g?z+1:z-1,h[p].likes=z,g){var C=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];u[zmail.zuid]=C.fn,v.unshift(parseInt(zmail.zuid))}else delete u[zmail.zuid],v=_.without(v,parseInt(zmail.zuid));h[p].likeList=u}t.set("comments",h),t.trigger("change:like",m);break;case"list":var k=o,S=(e=e.comment?e.comment:e).order,y=e.comments,b=_(S).map(function(e,t){var i=y[e];return i.sequence=t+1,i});for(var x in k)-1===S.indexOf(k[x].id)&&b.push(k[x]);t.set("comments",b,{silent:!0}),t.trigger("change:listAll",m,this.extraParamObj.elm);break;case"del":var w,A,I=m;!m&&e.comment&&(I=e.comment.commentuuid,w=e.comment.parentuuid);var T=t.pickComment(I).index,D=this.isPrivate,M=this.parentId||w;if(-1!==T)s=t.get("total"),(c=o).splice(T,1),s=isNaN(s)?c.length:s-1,t.set({total:s,comments:c}),$.publish("/streams/comment",{mode:"delete",entityId:t.getUnparsedId(),total:s,etype:t.get("etype"),mailID:l});else if(D){var N,O,L=o,P=(A=!M)?{}:t.pickComment(M),U=A?t.get("privateToOwner"):P.commentObj.private;for(var E in U)if(N=$.isArray(U[E])?U[E]:[U[E]],-1!==(O=_.pluck(N,"id").indexOf(I))){N.splice(O,1),A?N.length?U[E]=N:delete U[E]:N.length?L[P.index].private[E]=N:delete L[P.index].private[E],t.set("comments",L);break}}t.trigger("change:removeComment",I,D,A);break;case"addPrivate":var B,F,R,H,G,j=e.comment.isprivateToPost,V="private";if(j?(B=t.get("privateToOwner")||{},F=t.get("owner")===zmail.zuid?this.data.privateZuid:zmail.zuid):(G=this.data.parentId,F=(H=t.pickComment(G)).commentObj.by===zmail.zuid?String(this.data.privateZuid):zmail.zuid,B=H.commentObj[V]||{}),R=$.isEmptyObject(B))B[F]=[],B[F].push(e.comment),j||(c=o,H.commentObj[V]=B,c[H.index]=H.commentObj,t.set("comments",c));else{if(!$.isArray(B[F])){var q=B[F];B[F]=void 0===q?[]:[q]}B[F].push(e.comment)}j&&t.set("privateToOwner",B),t.trigger("add:privateComment",j,e.comment,this.data.parentId,R,F);break;case"getLikes":var Z=t.pickComment(m).index,W=t.get("comments"),J=W[Z].likeList||{},K=e.list,X=e.users;J&&_.size(J)&&$.extend(X,J),W[Z].likeList=X,W[Z].likeZidList=K,W[Z].likes=_.size(X),t.set("comments",W),t.trigger("change:getLikes",m,this.extraParamObj.elm);break;case"singlecomment":var Q=e.comment;if("popup"===a.type)(c=t.get("replyTo")||[]).push(Q),t.set({replyTo:c});else if(-1===t.pickComment(Q.id).index){(c=o).push(Q);var Y=t.get("total");t.set({comments:c,total:Y+1}),$.publish("/streams/comment",{mode:"add",entityId:t.getUnparsedId(),etype:t.get("etype"),total:t.get("total"),mailID:l})}t.trigger("change:singlecomment",m,a);break;case"getMailShareData":t.set("recipientList",e.recipientList)}},parse:function(e){var t=e.id;-1===t.indexOf("#")&&(e.id=e.groupId+"#"+t);var i=a.parseInput(e,!0);return i.attachIndex=0,i}}),e.CommentCollection=Zmail.Collection.extend({model:e.Comments,url:"/zm/stream.do",addModel:function(e,t,i){return this.remove(e,{silent:i}),this.add(e,{at:t,silent:i}),this}}),e)}(),zmStreamsApp.CommentModule.parseInput=function(e,t){var i=e.comments||{},a=i.comments,n=i.order||[],s=_(n).map(function(e,t){var i=a[e];return i.sequence=t+1,i});void 0===e.streamsEnabled&&(e.streamsEnabled=!0);var o={total:i.total||n.length||e.total,parentElement:e.parentElm,id:e.id,groupId:e.groupId,mention:e.mentions,etype:e.etype,owner:e.owner,privateToOwner:e.privateToOwner,actionType:e.actionType||"viewGroupEntity",sharedCall:e.sharedCall||!1,groupsMention:e.groupsMention||!1,placeHolder:e.placeHolder,isSharedFolder:e.isSharedFolder,shId:e.shId,disableComment:e.disableComment,fixedComment:e.fixedComment||!1,fixedElement:e.fixedElement,miscData:e.miscData||{},sharedApiCall:e.sharedApiCall||!1,createEntityDeferredCallback:e.createEntityDeferredCallback,isDraftShare:e.isDraftShare||!1,entityExists:e.entityExists||!1,fetchData:void 0===e.comments,shGroup:e.shGroup||[],shOwner:e.shOwner,inviteeList:e.inviteeList,recipientList:e.recipientList,openedId:e.openedId,sharedFolderUsers:e.sharedUsers,streamsEnabled:e.streamsEnabled,sharedToMe:e.sharedToMe,cloudAttPopup:e.cloudAttPopup,group:e.group,allowInvite:e.allowInvite};return s&&t&&(o.comments=s),o},window.zmStreamsApp=window.zmStreamsApp||{},zmStreamsApp.CommentModule.templates=function(){var g,k={},J=zmStreamsApp.template,K=zmText.get("streams"),z=!0;return k.comments=function(e,t,i,a){var n=e.id,s=e.comments,o=e.fixedComment||!1,m=e.isShare||!1,r=e.disableComment||!1,l=e.placeHolder;z=e.streamsEnabled,g=e.etype;var d=zdom("ul",{className:"Stcmt cmnt_ul","data-type":o?"fixedComment":"","data-sharedview":e.sharedCall});if(e.notifyId=i,k.commentList(e,d),!o&&!r&&!e.isDisableAdd&&_zm.isStreamsEnabled()){var c=k.newcomment({cid:n,sharedCall:e.sharedCall,sharedApiCall:e.sharedApiCall,entityExists:e.entityExists,isDraftShare:e.isDraftShare,attId:t,placeHolder:l,fixedComment:!1,isShare:m});d.appendChild(c)}var p=s.length,h=e.total-p,u=zdom("div",{className:"sc_cmdv SCS_cmnt"});if((e.sharedCall||e.isSharedFolder)&&p&&!e.isDraftShare&&u.appendChild(k.commentHeader()),e.privateToOwner){var v=k.privateToOwner(e.privateToOwner,e.owner,i,e.disableComment,e.parentElement);u.appendChild(v)}if(e.isDraftShare&&!p&&a&&(e.entityExists?u.appendChild(k.draftNoComment()):u.appendChild(k.addInvComment())),h){var f=e.comments[0]?e.comments[0].id:"";u.appendChild(k.viewmore(zmText.applyArgs(K.common.labels.viewMoreComments,{count:h}),f,p))}return u.appendChild(d),u},k.draftNoComment=function(){return zdom("div",{className:"zmNoCmnt greyText"},zdom("i",{className:"msi-comment"}),zdom("div",null,K.common.labels.nocomments))},k.addInvComment=function(){return zdom("div",{className:"zmNoCmnt greyText"},zdom("i",{className:"msi-addgroup"}),zdom("div",null,K.common.labels.draftShare),zdom("div",null,K.common.labels.draftShareMsg))},k.commentHeader=function(){return zdom("div",{className:"cmntLabel"},K.common.labels.comments)},k.commentList=function(e,t){for(var i,a=e.comments,n=e.notifyId,s=e.disableComment||!1,o=0;o<a.length;o++)if((i=a[o]).user)t.appendChild(k.comment(i,e)),i.private&&!e.isPrint&&k.privateCommentBlock(t,i,"","",n,s);else{var m=i.by||"",r=i.name||(zmStreamsApp.util.getContactDetails([m])[m]||{}).fn||K.common.labels.unknown,l=i.text||"";t.appendChild(k.systemComment(r,l))}},k.quotedCommentList=function(e,t,i){for(var a,n=0;n<e.length;n++)a=e[n],t.appendChild(k.quoteComment(a,e,i))},k.fixedComment=function(e){var t=e.isNewCollabUser?"":zdom("ul",{className:"Stcmt"}),i=e.isNewCollabUser?" zmCmntFixed inputFocus":"";i=0<e.totalCount?"".concat(i," cmntInfoWra inputFocus"):i;var a=zdom("div",{className:"SCS_cmnt zms_fixed".concat(i),type:"notification"},t),n=k.newcomment(e);if(e.isNewCollabUser){0<e.totalCount&&a.appendChild(k.commentInfo(e.totalCount)),a.appendChild(n);var s=k.commentActions(e);if(s.style.display="none",a.appendChild(s),!zmUtil.isChildWindow()&&!e.isDraftShare){var o,m=parseInt(zmAdHocSettings.getMailPreviewSize());o=zmsuite.getCenter()[0].$el.width(),m=zmsuite.getCenter()[1].$el.hasClass("SC_w100")?100:m,a.style.width="".concat(o*m/100-20,"px")}}else{var r=$.e(a).find(".Stcmt");$.e(r).appendDOM(n)}return a},k.commentInfo=function(e){return zdom("div",{className:"cmntInfo"},zdom("i",{className:"msi-comment zm_shrnk"}),zdom("span",{className:"StCnt zm_dIB"},e))},k.commentActions=function(e){var t=e.entityExists||e.isDraftShare||e.isShare?"":zdom("span",{className:"zm_dIB zm_inclr zm_shrnk SC_dyn"},zdom("i",{className:"msi-uncheck zm_shrnk"}),K.common.labels.includeEveryoneNew),i={},a=e.entityExists?"":zdom("b",{className:"lockClass mailSharedLock zm_shrnk"},zdom("i",{className:"msi-Ainvitee inviteeColor zm_shrnk"})),n=e.totalCount?k.commentInfo(e.totalCount):[],s="function"==typeof(i=e.entityExists?{}:e.placeHolder).button?i.button():i.button;s=s||K.streams.common.comment;var o,m=e.isShare?e.sharedFolderUsers:e.inviteeList,r=(m=m||[])?m.length:0,l=r?k.addInviteeList(zmStreamsApp.util.getContactDetails(m)):[],d=k.getInviteeFontDOM(r);return o=_zm.isTeamDriveEnabled()?zdom("div",{className:"SCmb zmst_attach"},zdom("ul",null,zdom("li",null,zdom("b",{className:"gdrop"},zdom("div",{className:"SC_hd"}),zdom("span",{className:"dropdown"},zdom("i",{className:"msi-attachment zm_shrnk"}),zdom("i",{className:"msi-barrow zm_shrnk"})))))):zdom("i",{className:"msi-attachment zmst_attach zm_shrnk"}),zdom("div",{className:"cmntActions"},zdom("div",{className:"SC_flt"},zdom("div",{className:"SCS_postAct zm_dIB"},zdom("div",{className:"cmAct"},zdom("div",{className:"mailAct"},o,zdom("div",{className:"SC_SLine"}),n,zdom("ul",{className:"inviteeList invitedList zm_shrnk"},l),d,zdom("div",{className:"SC_SDot SC_dyn"}),t)))),zdom("div",{className:"SC_frt"},zdom("font",{className:"zmMarkDown mailAct","data-tooltip":K.common.tooltips.markdown},zdom("i",{className:"msi-markdown"})),zdom("div",{className:"zm_dIB zm_slc"},zdom("div",{className:"SC_SDot",style:{display:"none"}}),a),zdom("div",{className:"SC_PUbtm zm_dIB"},zdom("span",{className:"sel addcomnt zm_shrnk"},s))))},k.privateCommentBlock=function(e,t,i,a,n,s,o,m,r){var l,d=zdom("li",{className:"pvtMsg"});o?$.e(d).insertDOMAfter(e):e.appendChild(d);var c=i?t:t.private,p=i?a:t.by,h=i?"":t.id,u="",v={};for(u in c)c[u]&&(v.recepient=u,v.replyTo=zmail.zuid===u?p:u,d.appendChild(k.private_comments(h,v,c[u],!1,i,n,s)));var f=!1;if(n)for(var g in c)if(c[g]instanceof Array){for(var z=0,C=c[g].length;z<C;z++)if(c[g][z].id===n){f=!0;break}}else if(c[g].id===n){f=!0;break}if(m||f)if(i&&r)(l=$.e(r).find(".ShwPrv")).length&&(l[0].childNodes[1].textContent=K.common.labels.hidePrivateComments);else{if((l=$.e(e).find(".zms_comment")).length)$.e(l[l.length-1]).find(".ShwPrv")[0].childNodes[1].textContent=K.common.labels.hidePrivateComments}else i?$.e(d).parent("ul.pvtOwn")[0].style.display="none":d.style.display="none"},k.newcomment=function(e){var t=e.cid,i=e.attId,a=e.fixedComment,n=e.placeHolder,s=e.entityExists,o=e.sharedApiCall,m=e.isDraftShare,r=e.isShare,l=e.isNewCollabUser,d=a?"fixed":"";i=(i="p".concat(t).concat(i)).substring(i.indexOf("#")+1,i.length),(n=(n=s?{}:n)||{}).button=n.button||K.streams.common.comment,n.textArea=n.textArea||K.common.labels.writeComment;var c="function"==typeof n.button?n.button():n.button,p="function"==typeof n.textArea?n.textArea():n.textArea,h=[],u=[];_zm.isTeamDriveEnabled()?h=r?"":zdom("div",{className:"SCmb zmFL zmst_attach zmHideD"},zdom("ul",null,zdom("li",null,zdom("b",{className:"gdrop"},zdom("div",{className:"SC_hd"}),zdom("span",{className:"dropdown"},zdom("i",{className:"msi-attachment SC_flt zm_shrnk"}),zdom("i",{className:"msi-barrow"})))))):u=r?"":zdom("i",{className:"msi-attachment zmst_attach SC_flt zm_shrnk"});var v=l?{}:{display:"none"},f=!l||s||m?"":zdom("div",{className:"zm_inclr zm_dIB"},zdom("i",{className:"msi-uncheck"}),zdom("div",{className:"zm_dIB"},K.common.labels.includeEveryone)),g=o||m&&!s?zdom("div",{className:"SCmb mailSharedLock"},zdom("ul",null,zdom("li",{className:"SC_lbr"},zdom("b",{className:"lockClass"},zdom("i",{className:"msi-Ainvitee inviteeColor zm_shrnk"}),zdom("div",{className:"SC_hd"}))))):"",z=!a||!l||m||zmUtil.isChildWindow()||e.sharedToMe?"":zdom("div",{className:"zmCmntSC"},zdom("i",{className:"msi-comment mailCmnt zm_shrnk",style:{display:"none"}}),zdom("i",{className:"msi-notes noteCmnt zm_shrnk"}),zdom("i",{className:"msi-task taskcmnt zm_shrnk"})),C=zdom("div",{className:"cmntText"},zdom("textarea",{id:"comnt_".concat(t),autoCapitalize:"off",autoCorrect:"off",className:"zms_cmTxt",autoComplete:"off",placeholder:p,"data-attach":i,"data-type":d}),z,zdom("i",{className:"msi-smiley zm_shrnk"})),k=zdom("li",{className:"zms_txtLI",type:"commentbox"},zdom("div",{className:"zmImg"}),C,h,zdom("div",{className:"SC_PUbtm",style:v},u,f,g,zdom("font",{className:"zmMarkDown","data-tooltip":K.common.tooltips.markdown},zdom("i",{className:"msi-markdown"})),zdom("span",{className:"addcomnt sel"},c)));if(a&&l)k=C;else{var S=$.e(k).find(".zmImg"),y=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];if(y.isDummyObj){var b=zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(zmail.IAMFullName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0];$.e(b).insertDOMAfter(S[0])}else $.e(y.avatar).insertDOMAfter(S[0]);$.e(S[0]).remove()}return k},k.groupDom=function(){return zdom("div",{className:"SCmb zm_dIB appGroup","data-grp":String(zmail.zuid)},zdom("ul",null,zdom("li",{className:"SCtxt"},zdom("b",null,zdom("div",{className:"SC_hd"}),zdom("span",{className:"zm_grptxt zm_shrnk"},K.common.labels.selectGroup,zdom("i",{className:"msi-barrow"}))))))},k.getInviteeFontDOM=function(e){return e=e||0,zmStreamsApp.PostActions.template.getFontDOM(e,!0,!1,"inviteeList")},k.addInviteeList=function(e,t){var i,a=zdom("li",null),n=Object.keys(e).length,s=0;if(!$.isEmptyObject(e))for(i in e)s<3&&(a.appendChild(zdom("img",{src:e[i].photo,"data-tooltip":e[i].fn})),s++);if(!t)return a;t=t.querySelector(".zms_fixed .inviteeList"),$.e(t).clearHTML(),t.appendChild(a),$.e(t).siblings("font.fontClass").remove(),$.e(k.getInviteeFontDOM(n)).insertDOMAfter(t)},k.viewmore=function(e,t,i){return zdom("div",{className:"cmntMore","data-cid":t,"data-count":i},zdom("i",{className:"msi-comment"}),e)},k.createPrivate=function(e,t,i,a){var n=zmStreamsApp.util.getContactDetails([String(t)])[String(t)].fn,s=zmText.applyArgs(K.streams.post.pvtReply,{userName:n}),o={display:"none"},m={};i||(m={display:"none"},o={});var r=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid],l=document.createDocumentFragment();l.appendChild(zdom("li",{className:"pvtRlyLi",style:m},zdom("div",{className:"zmImg"},zdom("img",{src:r.photo})),zdom("div",null,zdom("div",{className:"cmntText"},zdom("input",{autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",className:"sfocus",placeholder:s,"data-z":t,"data-cid":e}))))),l.appendChild(zdom("li",{className:"pvtRlyLink",style:o},zdom("span",{className:"SndPrvRep"},K.common.labels.reply)));var d=$.e(l).children().find(".zmImg");if(r.isDummyObj){var c=zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(zmail.IAMFullName),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0];$.e(c).insertDOMAfter(d[0])}else $.e(r.avatar).insertDOMAfter(d[0]);$.e(d[0]).remove();var p,h=l;if(i){if(h=p=zdom("li",{className:"pvtMsg"},zdom("ul",{className:"pvtOwn"})),a){var u=zdom("ul",{className:"pvtOwn"});u.appendChild(p),h=u}p.children[0].appendChild(l)}return h},k.comment=function(e,t){var i,a=e.id,n=e.tags,s=e.by,o=zmStreamsApp.util.getContactDetails([String(s)])[s],m=e.text,r=o.zid===zmail.zuid?K.common.labels.me:o.fn||e.name,l=_zm.isStreamsEnabled(),d=t.notifyId,c=t.shOwner,p=t.isShare,h=t.id,u=t.groupId,v="",f=":",g="";if("13"===t.etype&&e.commentType||e.RTF){if(e.RTF){g=n.length?zmStreamsApp.template.richTextOffSet({text:e.RTFText,offset:n}):e.RTFText,g=e.replyTo?zdom("div",{className:"zmsPCcontent",dangerouslySetInnerHTML:g}):zdom("span",{className:"zmsPCcontent",dangerouslySetInnerHTML:g}),$.e(g).find("blockquote").addClass("SC_quote"),g=zmUtil.parseHtmlURLS(g);var z,C,k=_zm(".","zms_mention",g),S=[];t.shGroup&&t.shGroup.length&&(S=_.pluck(t.shGroup,"id"));for(var y=0,b=k.length;y<b;y++)C="zms_mention",z=String($.e(k[y]).data("zid")),(zmUtil.isGroup(z)||-1!==S.indexOf(z))&&(C+=" cursorDefault",k[y].removeAttribute("data-zid")),u&&-1===C.indexOf("cursorDefault")&&(zmUtil.isGroup(u)||_.size(t.inviteeList)&&-1!==t.inviteeList.indexOf(z))&&!zmUtil.isGroupMember(z,u)&&(C+=" inviteeColor"),k[y].className=C;$.e(g).find("img").on("load",function(){zmComponent.markdown.bestFitWidth(g,this)})}}else i={text:m,offset:n,group:h,span:e.replyTo,shGroup:t.shGroup,inviteeList:t.inviteeList},g=J.setOffsetValues(i);if(e.replyTo){var x=e.replyToDisplayName+K.common.labels.apostrophes||"";e.replyToZuid===zmail.zuid&&(x=K.common.labels.your);v=zdom("span",null,"".concat(K.common.labels.repliedTo," ").concat(x," "),zdom("span",{style:{textDecoration:"underline",cursor:"pointer"},className:"zm_replyto","data-cid":e.replyTo},K.common.labels.commentSmall),g),f="",o.zid===zmail.zuid&&(r=K.common.labels.you)}else v=g;if("13"===t.etype&&e.commentType){f="",i={text:m,offset:n},g=zmStreamsApp.twitter.setOffsetValues(i),o.zid===zmail.zuid&&(r=K.common.labels.you);var w="";1===e.commentType?(w=o.zid===zmail.zuid?K.twitter.retweetText:K.twitter.retweeted,m.length&&(w=o.zid===zmail.zuid?K.twitter.quoteTweet:K.twitter.quotedTweet)):2===e.commentType&&(w=o.zid===zmail.zuid?K.twitter.replyText:K.twitter.replied),(v=zdom("span",null,w)).appendChild(g)}var A=e.on,I=K.common.labels.sendPrivateReply,T=[],D=[],M=[],N=[],O=[];if(!p&&!t.isSharedFolder){M=t.disableComment?"":zdom("span",{className:"SndRep","data-cid":a,"data-z":s},K.common.labels.reply),M=l?M:"";var L=!e.likes&&!t.streamsEnabled&&"1"!==t.etype&&l,P=!1===t.streamsEnabled?"pointerEventsNone":"";N=L?"":zdom("i",{className:"msi-love zmcnt ".concat(P),"data-cmid":a}),O=zdom("font",{style:e.likes?{}:{display:"none"},"data-cid":a,className:"zm_lcnt"},e.likes?e.likes:""),T=t.disableComment?"":zdom("span",{className:"SndPrv SndPrvCmt","data-cid":a,style:e.private?{display:"none"}:{},"data-z":s},I),D=zdom("span",{className:"SndPrv ShwPrv zmShowV",style:e.private?{}:{display:"none"},"data-z":s},zdom("i",{className:"msi-comment"}),K.common.labels.showPrivateComments)}var U,E="";t.isSharedFolder&&c===zmail.zuid&&(U=!0),p||t.isSharedFolder||e.by!==zmail.zuid||(U=!0),"13"===t.etype&&e.commentType&&e.by===zmail.zuid&&(U=!1),U&&(t.streamsEnabled||"1"===t.etype)&&(M=T="",E=zdom("i",{className:"msi-trash delCmnt","data-cid":a}));var B=-1!==h.indexOf("#")?h.substring(h.indexOf("#")+1,h.length):h,F="".concat(zmail.conPath,"/#stream/tab/").concat(t.groupId,"/").concat(B,"/").concat(t.etype,"/").concat(t.actionType,"/").concat(e.id),R=t.isSharedFolder?A:zdom("a",{href:F,target:"_blank",rel:"noopener noreferrer",className:"dateTime",title:zmStreamsApp.util.getFullDateFormat(parseInt(e.time))},A),H=(e.likes?" contentLiked":"")+(e.liked?" contentILiked":""),G=zdom("div",{className:"cmntDet".concat(H)},zdom("span",{className:"time"},R),zdom("div",{className:"SC_SDot"}),N,O,zdom("div",{className:"SC_SDot",style:M?{}:{display:"none"}}),M,T,D),j=zdom("li",{className:d===a?"zms_comment highlightClass":"zms_comment","data-cid":a},E,zdom("div",{className:"SC_avtr"}),zdom("div",{className:"cmntMsg"},zdom("strong",{className:"zm_susr","data-zid":s},r+f)));$.e(j).find(".cmntMsg").appendDOM(v);var V=zmStreamsApp.util.getContactDetails([e.by])[e.by],q=$.e(j).find(".SC_avtr");if(V.isDummyObj){var Z=zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(e.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0];$.e(Z).insertDOMAfter(q[0])}else $.e(V.avatar).insertDOMAfter(q[0]);if($.e(q[0]).remove(),e.attachments){var W=J.RenderAttachment({attArr:e.attachments,groupId:u,pid:h,type:t.etype,actionType:t.actionType});j.appendChild(W)}return e.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(e,j,h),j.appendChild(G),j},k.quoteComment=function(e,t,i){var a,n=e.id,s=e.by,o=zmStreamsApp.util.getContactDetails([String(s)])[s],m=e.text,r=o.zid===zmail.zuid?K.common.labels.me:o.fn||e.name,l=e.tags||[],d=t.id,c=t.notifyId,p=t.groupId,h="",u=":";if(e.RTF){a=l.length?zmStreamsApp.template.richTextOffSet({text:e.RTFText,offset:l}):e.RTFText,a=zdom("span",{className:"zmsPCcontent",dangerouslySetInnerHTML:a}),$.e(a).find("blockquote").addClass("SC_quote"),a=zmUtil.parseHtmlURLS(a);var v,f,g=_zm(".","zms_mention",a),z=[];t.shGroup&&t.shGroup.length&&(z=_.pluck(t.shGroup,"id"));for(var C=0,k=g.length;C<k;C++)f="zms_mention",v=String($.e(g[C]).data("zid")),(zmUtil.isGroup(v)||-1!==z.indexOf(v))&&(f+=" cursorDefault",g[C].removeAttribute("data-zid")),p&&-1===f.indexOf("cursorDefault")&&(zmUtil.isGroup(p)||_.size(t.inviteeList)&&-1!==t.inviteeList.indexOf(v))&&!zmUtil.isGroupMember(v,p)&&(f+=" inviteeColor"),g[C].className=f}else{var S={text:m,offset:l,group:d,span:e.replyTo};a=J.setOffsetValues(S)}if(e.replyTo){h=zdom("span",null," - ".concat(K.common.labels.repliedTo," "),zdom("span",{style:{textDecoration:"underline",cursor:"pointer"},className:"zm_replyto","data-cid":e.replyTo},K.common.labels.commentSmall),a),u=""}else h=a;var y=e.on,b=(e.likes?" contentLiked":"")+(e.liked?" contentILiked":""),x=zdom("div",{className:"cmntDet".concat(b)},zdom("span",null,y)),w=zdom("li",{className:c===n?"highlightClass":"","data-cid":n},zdom("div",{className:"SC_avtr"}),zdom("div",{className:"cmntMsg"},zdom("strong",{className:"zm_susr","data-zid":s},r+u),h)),A=zmStreamsApp.util.getContactDetails([e.by])[e.by],I=$.e(w).find(".SC_avtr");if(A.isDummyObj){var T=zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(e.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0];$.e(T).insertDOMAfter(I[0])}else $.e(A.avatar).insertDOMAfter(I[0]);$.e(I[0]).remove();var D=i.gnrl;if(e.attachments){var M=J.RenderAttachment({attArr:e.attachments,groupId:D.group.id,pid:D.id,type:D.type,actionType:zmStreamsApp.events.getActionType(D.group)});w.appendChild(M)}return e.link&&zmStreamsApp.linkPreview.addLinkPreviewToComment(e,w,d),w.appendChild(x),w},k.systemComment=function(e,t){return t=(t||"").replace(/\\n/gim,"\n"),zdom("li",{className:"Sactvty"},zdom("div",{title:K.common.labels.systemComment},zdom("b",null,e)," : ",zdom("span",{style:{wordBreak:"break-all",whiteSpace:"pre-wrap"}},t)))},k.selectMailDOM=function(e){return zdom("span",{className:"selMail zm_shrnk",style:{cursor:"pointer"}},zdom("span",{className:"StCnt zm_dIB"},e),zdom("span",{className:"zm_dIB mailSelec zm_shrnk"},K.common.labels.mailsSelected))},k.privateToOwner=function(e,t,i,a,n,s){var o=zdom("ul",{className:"pvtOwn"});return k.privateCommentBlock(o,e,!0,t,i,a,void 0,s,n),o},k.private_comments=function(e,t,i,a,n,s,o,m){var r,l=n?"pvtOwn":"",d=a?zdom("li",{className:"pvtMsg"},zdom("ul",{className:"Spvt ".concat(l),"data-zid":t.recepient})):zdom("ul",{className:"Spvt ".concat(l),"data-zid":t.recepient}),c=a?d.children[0]:d;if(i instanceof Array)for(var p=0,h=i.length;p<h;p++)r=k.private_comments.comment(i[p]),i[p].id===s&&$.e(r).addClass("highlightClass"),c.appendChild(r);else r=k.private_comments.comment(i,o),i.id===s&&$.e(r).addClass("highlightClass"),c.appendChild(r);if(!o&&!m){var u=k.createPrivate(e,t.replyTo,a,n);c.appendChild(u)}return a?d:c},k.replyComment=function(e,t){return zdom("div",{"data-cid":e,className:"zms_rep"},zmText.applyArgs(K.common.labels.replyToUser,{userName:t}),zdom("i",{className:"msi-close"}))},k.private_comments.comment=function(e){var t,i=zmStreamsApp.util.getContactDetails([e.by])[e.by];if(i){var a=i.zid===zmail.zuid?K.common.labels.me:i.fn,n={text:e.text,offset:[]},s=J.setOffsetValues(n),o=e.on,m=zmStreamsApp.util.updateTime(parseInt(e.time));m&&(o=m);var r="";e.by!==zmail.zuid||!z&&"1"!==g||(r=zdom("i",{className:"msi-trash delCmnt delPvtCmnt","data-cid":e.id})),t=zdom("li",{"data-cid":e.id},r,zdom("div",{className:"SC_avtr"}),zdom("div",{className:"cmntMsg"},zdom("strong",null,"".concat(a,":")),s),zdom("div",{className:"cmntDet"},zdom("span",{title:zmStreamsApp.util.getFullDateFormat(parseInt(e.time))},o)))}var l=$.e(t).find(".SC_avtr");if(i.isDummyObj){var d=zmail.ContactBook.Templates.avatar({isValidPhoto:!1,photo:void 0,initials:zmail.ContactBook.Utils.initials(e.name),avatarBgColor:zmail.ContactBook.Utils.colorClasses()})[0];$.e(d).insertDOMAfter(l[0])}else $.e(i.avatar).insertDOMAfter(l[0]);return $.e(l[0]).remove(),t},k}(),window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),zmStreamsApp.CommentModule.views=function(e){var r,n,l,t,y=zmText.get("streams"),i=y.streams.common,b=i.comment,x=i.commenting,d=zmStreamsApp.CommentModule,c=zmail.Streams.Components.StreamsEditor,w=zmStreamsApp.util,A=".sc_cmdv.SCS_cmnt",u="zmst_attach",p="zms_comment",I="lockClass",f="cmntActions",h="zmCmntFixed",g="cmntLabel",v="msi-smiley",z="msi-comment",C="zm_mention";return e.Comment=Zmail.View.extend({attCmpRef:"",saveContent:!0,template:d.templates,isBlurTrigger:!0,loadingDiv:"",events:{"click .zmcnt.msi-love":"like","focus textArea.zms_cmTxt":function(){var e=this.$el.find(".SC_PUbtm");$.e(e).show(),this.fixedComment&&this.isNewCollabUser&&this.expandCommentBox(),$.e(this.$el).find("."+u).removeClass("zmHideD"),this.attCmpRef||this.addAttachment(!0),this.reSize()},"keydown textArea.zms_cmTxt":function(e){zmail.mailOpt.isKey&&e.ctrlKey&&13===e.keyCode&&(e.preventDefault(),this.publish(e))},"click .addcomnt":"publish","click .cmntMore":function(e){var t=$.e(e.currentTarget);if(!t.hasClass("zmLock")&&!t.hasClass("postCmnt")){t.addClass("zmLock"),this.loadingDiv=zmComponent.loadingBand({container:t[0],type:"pagination"});var i=t.data("cid"),a=t.siblings("."+p).length;this.model.listAll(i,a,t)}},"click .SndRep":"attachReplyTo","mousedown .SndRep":function(){this.isBlurTrigger=!1},"click .delCmnt":function(e){var t=$.e(e.currentTarget),i=t.hasClass("delPvtCmnt"),a=$.e(t).parents(".pvtMsg").prev("."+p);this.model.remove(t.data("cid"),i,$.e(a).data("cid"))},"click .SndPrvCmt":function(e){var t=e.currentTarget;$.e(t).hide(),this.addNewPrivate(t)},"click .zms_comment .zm_susr,.zms_comment .zms_mention":"showUserPost","mouseover .zms_comment .zm_susr,.zms_comment .zms_mention":"showUserDropdown","mouseout .zms_comment .zm_susr,.zms_comment .zms_mention":function(e){var t=e.currentTarget;clearTimeout(zmStreamsApp.events.cardTime),$.e(t).data("show","false")},"click .zms_comment .zm_HTag":"showHashTag","click .ShwPrv":"showHidePrivateComment","click .zms_rep .msi-close":function(e){var t=$.e(e.currentTarget).parent();$.e(this.textAreaInstance.textarea).data("cid",""),t.remove();var i=this.model.get("id");zmStreamsApp.util.storeUnposted(i,{replyTo:{}}),this.reSize()},"click .zmst_attach":"addAttachment","keypress .pvtRlyLi input":function(e){13===e.keyCode&&this.sendPrivate(e)},"click .SndPrvRep":function(e){var t=e.currentTarget;$.e(t).parent().hide().siblings(".pvtRlyLi").show().find("input").focus()},"click .zm_lcnt":function(e){var t=e.currentTarget,i=this.model,a=$.e(t).data("cid"),n=i.pickComment(a).commentObj,s=n.likeList||{},o=_.size(s);o&&n.likes===o?this.showCommentLikes(a,t):i.sync("getLikes",this.model,{commentId:a,elm:t})},"click .zm_inclr i":function(e){var t=e.currentTarget;$.e(t).removeClass("zm_shrnk").toggleClass("msi-check msi-uncheck").addClass("zm_shrnk"),this.model.get("sharedCall")&&this.fixedComment&&this.updateInviteeList("recipientList")},"click .zm_inclr .zm_dIB":function(e){var t=e.currentTarget;$.e(t).parent().find("i").trigger("click")},"click .zm_replyto":function(e){this.showSingleComment(e.currentTarget)},"click .lockClass":function(e){var t=$.e(e.currentTarget).filter("."+I),i=$.e(t).find("i"),a="";a=i.hasClass("msi-Ainvitee")?(i.removeClass().addClass("msi-Dinvitee"),y.common.labels.allowInvites):(i.removeClass().addClass("msi-Ainvitee inviteeColor"),y.common.labels.denyInvites),t.attr({"data-tooltip":a,"data-tooltip-pos":"bottom"})},"mousedown .zmCmntFixed":function(e){var t=$.e(e.target).hasClass("zmMarkDown")||$.e(e.target).parents(".zmMarkDown").length;$.e(e.target).hasClass("msi-close")||$.e(e.target).hasClass("zms_rep")||$.e(e.target).hasClass("SndRep")||t?this.isBlurTrigger=!1:this.isBlurTrigger=!0;var i=this.textAreaInstance;if($.e(i.textarea).data("shrinkValue",!0),this.isNewCollabUser&&!$.trim(i.getText())){var a=$.e(e.target);$.e(a).hasClass("zm_shrnk")&&$.e(i.textarea).data("shrinkValue",!1)}},"focusout textArea.zms_cmTxt":function(e){if(this.saveUnpost(e),this.isBlurTrigger){var t=this.textAreaInstance;if(this.isNewCollabUser&&!$.trim(t.getText())){if(t.setText(""),!1===$.e(t.textarea).data("shrinkValue"))return;var i=this.$el;i.find("."+f).hide();var a=i.find(".cmntInfo"),n=this.model.get("comments").length;a.length&&n&&(i.find(".cmntInfo").removeClass("zmHideD"),i.find("."+h).addClass("cmntInfoWra")),$.publish("comments/focus",{elem:i,focus:!1}),this.setBottom()}}},"click .cmntInfo":function(){zmUtil.setPreviewScroll($.e(this.$el).find("."+g)[0],this.$el.parents(".SC_Twpr")[0])},"click .inviteeList":"showInviteeList","click .taskcmnt":"convertTaskComment","click .noteCmnt":"convertNoteComment","click .appGroup":"showGroupDropdown","click .mailCmnt":function(){this.switchBackMail()},"click .selMail":"scrollSelectedMail","click .zmMarkDown":function(e){t||(t=new zmComponent.markdown.UI),t.init({par:e.currentTarget})}},expandCommentBox:function(){var e=$.e(this.$el);e.find(".cmntInfoWra").removeClass("cmntInfoWra").children(".cmntInfo").addClass("zmHideD"),e.find("."+f).show(),this.model.get("sharedCall")&&this.model.getRecipientsForMail(),this.setBottom(),$.publish("comments/focus",{elem:e,focus:!0})},saveUnpost:function(e){var t=e.currentTarget||e;if(this.saveContent&&this.textAreaInstance){var i={},a=$.e(t).parent().siblings(".zms_rep");if(a.length){var n=a.data("cid"),s="",o=this.model.pickComment(n);o.commentObj&&(s=o.commentObj.name);var m={id:n,name:s};i.replyTo=m}var r=this.textAreaInstance.getText(),l=this.textAreaInstance.getMetaBlocks();i.text=r,l&&l.length&&(i.mentions=l);var d=this.model.get("id");zmStreamsApp.util.storeUnposted(d,i)}},getMentionObj:function(n,s){var o=this;return{input:n,inputInstance:o.textAreaInstance,exclude:function(){for(var e=o.textAreaInstance.getMetaBlocks(),t=[],i=0,a=e.length;i<a;i++)zmUtil.isGroup(e[i].id)&&t.push(e[i].id);return t},onSelect:function(e,t){t=t.item.attributes;var i=!zmUtil.isGroupMember(t.zid,s);zmUtil.isGroup(t.zid)&&(i=t.zid!==n);var a={id:t.zid,text:t.firstName,isInvitee:i};this.inputInstance.replaceCurrentWordWithMention(a,this.trigger.currentText)},contactType:"org",setDebounce:0,prioritizeAllGroupMembers:!0,hideEmailId:!0}},convertTaskComment:function(e){var t=this;if(t.expandCommentBox(),this.$el.find(".mailAct").hide(),$.e(e.currentTarget).parent().siblings("."+v).hide(),$.e(e.currentTarget).siblings("."+z).show().siblings(".taskcmnt").hide().siblings(".noteCmnt").show(),$.e(this.$el).find(".addcomnt").text(y.common.labels.addTask).addClass("addTsk"),!$.e(this.$el).find(".appGroup").show().length){var i=this.template.groupDom();this.$el.find(".cmAct").appendDOM(i)}$.e(this.$el).find(".ms_note").hide(),$.e(this.$el).find("."+C).show();var a=this.textAreaInstance.textarea;a.placeholder=y.common.labels.taskPlaceholder,this.ComSmiley.disable=!0,this.hashTagInstance.disable=!0;var n=t.model.get("groupId");!zmUtil.isGroup(n)&&t.model.get("shGroup").length&&(n=t.model.get("shGroup")[0].id);var s=zmUtil.isGroup(n)?n:"";if(!this.mentionsInstance&&this.isNewCollabUser&&this.model.get("isSharedFolder")&&!this.model.get("sharedToMe")){var o=t.getMentionObj(a,s);t.mentionsInstance=zmContactsAutoComplete.autoComplete(o)}t.mentionsInstance&&(t.mentionsInstance.excludeMe=!1,t.mentionsInstance.disable=!1),this.$el.find(".zms_aAtt").hide(),zmUtil.requireTaskModule("taskUtil").done(function(i){$.e(a).on("keypress",function(e){var t={mentionObj:zmStreamsApp.util.getMentionsFromTextArea(a),position:zmStreamsApp.util.getCaretPosition(a),fromMail:!0};i.extendMention(a,e,void 0,t)})})},convertNoteComment:function(e){var t=this.$el;this.expandCommentBox(),t.find(".mailAct").hide();var i=this.textAreaInstance;if(t.find(".ms_note").length)t.find(".ms_note").show();else{$.e(zdom("div",{className:"ms_note"})).insertDOMBefore(t.find(".zms_fixed").children(":eq(0)"));var a=this,n=$.e(i.textarea).focus().data("selMailIds"),s=$.isEmptyObject(n)?this.model.get("openedId"):n[0];s||(s=zmUtil.getSelectedMails()[0],Array.isArray(s)&&(s=s[0]));var o=zmUtil.getMailObj(s).F;zmUtil.loadNotes("commentNote",{groupId:zmail.zuid,desc:_zm.escapeTags(i.getText()),addparams:{msgid:s,accid:zmail.defAccId,senderid:o}},{ele:t.find(".ms_note"),callback:function(e){e&&(a.noteAddCallback=e).onHeightChange($.e(a.$el).find(".cmntText").css("maxHeight"),function(){a.setBottom()}),a.setBottom()}})}t.find("."+C).hide(),t.find(".addcomnt").text(y.common.labels.addNote).addClass("addNote").removeClass("addTsk");var m=t.find(".zmCmntSC");if(m.children(".taskcmnt").show(),m.children("."+z).show(),m.children(".noteCmnt").hide(),m.siblings("."+v).hide(),!t.find(".appGroup").show().length){var r=this.template.groupDom();t.find(".cmAct").appendDOM(r)}t.find(".zms_aAtt").hide()},hideMailIcons:function(){var e=$.e(this.$el).find(".zmCmntSC");e.siblings("."+v).hide(),e.children("."+z).show()},showHashTag:function(e){var t=e.currentTarget,i=$.e(t).text();zmUtil.publishCloseNotif(),0===i.indexOf("#")&&(i=i.substring(1,i.length));var a=this.model.get("groupId");zmStreamsApp.events.listHashTags({tag:i,gid:a})},showUserDropdown:function(e){var t=e.currentTarget,i=String($.e(t).data("zid")),a=this.model.get("groupId");zmUtil.isGroup(i)||zmStreamsApp.events.showContactCard({zid:i,elm:t,groupId:a,eType:this.model.get("etype")})},showUserPost:function(e){var t=e.currentTarget,i=String($.e(t).data("zid")),a=this.model.get("groupId");zmUtil.isGroupMember(i,a)&&zmStreamsApp.events.listUserPosts(void 0,{zid:i,gid:a,name:$.e(t).text(),data:"post"})},showGroupDropdown:function(e){var t=[],i=$.e(this.$el).find(".appGroup");String($.e(i).data("grp"))!==zmail.zuid&&t.push({name:y.common.labels.myStream,id:zmail.zuid,photo:zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid].photo}),t=t.concat(_.toArray(zmStreamsApp.util.getGroupDetails())),zmStreamsApp.util.showGroupDetails({groupInfo:t,elm:$.e(i).find("b"),fn:function(e){$.e(i).data("grp",e.id),$.e(i).find(".zm_grptxt").text(e.name),zmUtil.hideMenu()},showUnread:!1},{type:"popup"})},scrollSelectedMail:function(){var e=this.$el.parents(".SC_Twpr")[0];zmUtil.setPreviewScroll($.e(e).find(".js-shareicon")[0],e)},hasAttachment:function(){var e=!1,t=this.attCmpRef;return void 0!==t&&""!==t&&!(e=Boolean(t.getAllAttachedList().length))&&t.cloudAttRef&&(e=Boolean(t.cloudAttRef.getCloudAttachments().length)),e},attachFiles:function(e){var t=this;if(t.attCmpRef)t.attCmpRef.configJSON.eleId=e,t.attCmpRef.init();else{var i=this.callAttachment(e);zmUtil.initAttachComponent(i,function(e){t.attCmpRef=e})}},callAttachment:function(){var e=this,t=e.model.get("id"),i=zmStreamsApp.util.retrieveUnposted(t).attachment||[],a=$.e(e.$el).parents(".zmNotiPopUp")||[];e.model.get("etype")===zmStreamsApp.constants.streamTypeName.mail&&$.e(e.$el).hasClass("zmNotiPopUp")&&(a=$.e(e.$el));var n={componentId:"streams",isNewImp:!0,attachFrom:["desktop","myAttachchment","zDocs","otherCloud"],currentAttachedSize:0,eleId:e.$el.find(".zmCAt"),preAttachedFile:i,renameSupport:!0,onAddAttachment:e.saveAttachment,onRemoveAttachment:e.saveAttachment,updateAttachment:e.saveAttachment,onAddElement:function(){e.reSize()},onRemoveElement:function(){e.reSize()},deferredUpload:!0};return zmUtil.isNettyUploadEnabled()&&(n.updateVirus=e.saveAttachment),_zm.isTeamDriveEnabled()&&(n.$actionEle=e.$el.find(".zmst_attach .gdrop"),n.autoLaunch=!1,(a.length||e.model.get("cloudAttPopup")||zmUtil.isChildWindow())&&(n.appTypePopup=!0)),e.model.get("isDraftShare")&&(n.onAddElement=function(){d.resizeFn(),e.reSize()},n.onRemoveElement=function(){d.resizeFn(),e.reSize()}),n},saveAttachment:function(){var e=[];this.cloudAttRef&&(e=e.concat(this.cloudAttRef.getCloudAttachments())),e=e.concat(this.getAllAttachedList());var t=r.get("id");zmStreamsApp.util.storeUnposted(t,{attachment:e})},like:function(e){var t=e.currentTarget,i=$.e(t).data("cmid"),a="",n=$.e(t).next().text();if(!$.e(t).hasClass("zmLockLike")&&!$.e(t).hasClass("pointerEventsNone")){$.e(t).addClass("zmLockLike"),""!==n&&(n=parseInt(n));var s=_zm.copyOf(this.model.get("comments")),o=this.model.pickComment(i).index,m=s[o].likeList||{},r=s[o].likeZidList||[],l=s[o].likes;if($.e(t).parent().hasClass("contentILiked"))$.e(t).parent().removeClass("contentILiked"),a=y.streams.tooltip.likeComment,0!==(n-=1)&&""!==n||$.e(t).parent().removeClass("contentLiked"),delete m[zmail.zuid],r=_.without(r,parseInt(zmail.zuid)),n<=0&&(n=""),l-=1;else{$.e(t).parent().addClass("contentILiked"),a=y.streams.tooltip.unlikeComment,0!==n&&""!==n||$.e(t).parent().addClass("contentLiked");var d=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid];m[zmail.zuid]=d.fn,r.unshift(parseInt(zmail.zuid)),n+=1,l+=1}1===n?$.e(t).parent().addClass("contentLiked"):0!==n&&""!==n||$.e(t).parent().removeClass("contentLiked"),s[o].likeList=m,s[o].likeZidList=r,s[o].likes=l,this.model.set("comments",s),$.e(t).next().show().text(n<=0?"":n),$.e(t).attr({"data-tooltip":a,"data-tooltip-pos":"bottom"}),this.model.likeComment(i,$.e(t))}},showCommentLikes:function(e,t){var i=$.e(this.$el).find(".zm_lcnt[data-cid='"+e+"']"),a=this.model.pickComment(e).commentObj,n=a.likeList||{},s=a.likeZidList||[];if($.e(t).is(i)){for(var o,m=[],r=0;r<s.length;r++){var l=s[r];(o=zmStreamsApp.util.getContactDetails([l])[l]).isDummyObj&&(o.fn=n[l]),m.push(o)}m.length?(w.createPopup({items:m,parent:i,ulclass:"SC_Pr",parentClass:"SC_Slke",type:"oneLine"}),$.e(t).text(m.length)):$.e(t).text("")}},sendPrivate:function(e){var t=e.currentTarget,i=this.model,a=$.e(t).val();if(""!==$.trim(a)&&!$.e(t).hasClass("zm_snd")){var n=$.e(t).data("cid"),s=$.e(t).addClass("zm_snd").data("z");i.sendPrivate(a,n,s,function(e){i.get("isDeleted")?_zm.succErrMsg("e",y.common.messages.deletedPost):e.msg&&_zm.succErrMsg("e",e.msg),$.e(t).removeClass("zm_snd")})}},showHidePrivateComment:function(e){var t=e.currentTarget,i=$.e(t).parents("."+p);if(i.length){var a=$.e(i[0]).next("li.pvtMsg");a.length&&("none"===a[0].style.display?(a[0].style.display="",t.childNodes[1].textContent=y.common.labels.hidePrivateComments):(a[0].style.display="none",t.childNodes[1].textContent=y.common.labels.showPrivateComments))}},showSingleComment:function(e){var t=$.e(e).data("cid"),i=this.model.getsinglecomment(t,e,"popup");i&&w.createPopup({items:i,type:"comment",parent:e,ulclass:"rplyCmnt"})},addNewPrivate:function(e){var t=$.e(e).data("cid"),i=!t,a=i?this.model.get("owner"):$.e(e).data("z"),n=this.template.createPrivate(t,a,!0,i);i?$.e(e).children().first().hasClass("pvtRlyLi")||$.e(n).insertDOMBefore($.e(e).children().first()):$.e(n).insertDOMAfter($.e(e).parents("li")),$.e(n).find("input").focus(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))},attachReplyTo:function(e){e.stopPropagation();var t=$.e(e.currentTarget).data("cid"),i=String($.e(e.currentTarget).data("z")),a=zmStreamsApp.util.getContactDetails([i])[i].fn;this.model.get("etype")===zmStreamsApp.constants.streamTypeName.mail&&this.$el.show().find(".SCS_cmnt").show();var n=this.template.replyComment(t,a),s=this.textAreaInstance;s&&(s=$.e(s.textarea),$.e(n).insertDOMBefore(s.parent()),$.e(n).data("setHeight",!0).siblings(".zms_rep").remove(),s.data("cid",t).focus(),this.reSize())},updateLike:function(e){var t=this.$el.find('.msi-love[data-cmid="'+e+'"]'),i=this.model.pickComment(e).commentObj,a="";t.removeClass("zmLockLike");var n=i.likes?parseInt(i.likes):0;n<0&&(n=0),i.liked!==t.parent().hasClass("contentILiked")&&(a=i.liked?(t.parent().addClass("contentILiked"),y.streams.tooltip.unlikeComment):(t.parent().removeClass("contentILiked"),y.streams.tooltip.likeComment),t.length&&t.attr({"data-tooltip":a,"data-tooltip-pos":"bottom"})),1===n?$.e(t).parent().addClass("contentLiked"):0!==n&&""!==n||($.e(t).parent().removeClass("contentLiked"),n=""),t.next().show().text(n)},setBottom:function(){if(this.isNewCollabUser){var e=this.$el,t=$.e(e).find("."+h)[0];if(t&&$.e(t).is(":visible")){var i=t.getBoundingClientRect().height+10;$.e(e).parents(".SC_Twpr").css("bottom",i+"px")}}},updPrivateComment:function(e,t,i,a,n){var s,o,m,r,l,d,c=this.$el,p={recepient:n};if(i=i||"",s=this.model.getPvtComments(i),o=e?(r=this.model.get("owner"),l=$.e(c),$.e(l).find('ul.pvtOwn[data-zid="'+n+'"]')[0]):(r=s.by,l=(d=$.e(c).find('.zms_comment[data-cid="'+i+'"]')).next(),$.e(l).find('ul.Spvt[data-zid="'+n+'"]')[0]),p.replyTo=n===zmail.zuid?r:n,a)if(e){var h=this.template.privateToOwner(s,this.model.get("owner"),"",this.model.get("disableComment"),void 0,!0);o=$.e(l).find(".cmntMore").length?$.e(l).find(".cmntMore"):$.e(l).find(".cmnt_ul"),$.e(l).find(".pvtOwn").length&&$.e(l).find(".pvtOwn").remove(),$.e(h).insertDOMBefore(o);var u=zmStreamsApp.PostActions.fetchModel({eid:this.model.get("id")});u&&u.trigger("privateComment/added")}else{l.hasClass("pvtMsg")&&l.remove(),this.template.privateCommentBlock(d,s,!1,"","",this.model.get("disableComment"),!0,a),$.e(d).find(".SndPrvCmt").hide(),$.e(d).find(".ShwPrv").show()[0].childNodes[1].textContent=y.common.labels.hidePrivateComments}else if(o){var v,f,g,z;z=$.e(o).find(".pvtRlyLi"),t.by!==zmail.zuid&&z.length&&(f="none"!==z[0].style.display,g=$.e(o).find(".pvtRlyLink")),v=e?s[n]:s.private[n],m=this.template.private_comments(i,p,v,a,e,"",this.model.get("disableComment"),f),f&&$.e(m).appendDOM(z[0]).appendDOM(g[0]),$.e(m).insertDOMAfter(o),$.e(o).remove(),$.e(z).find("INPUT").focus()}else m=this.template.private_comments(i,p,[t],a,e,"",this.model.get("disableComment")),e?$.e(l).find("ul.pvtOwn").find("li.pvtMsg").appendDOM(m):$.e(l).appendDOM(m)},updateMentions:function(e){this.mentionsInstance&&(this.mentionsInstance.includeOnly=e)},reSize:function(){var e=this.$el,t=$.e(e).find(".cmnt_ul"),i=this.model.get("disableComment");if("fixedComment"===$.e(t).data("type")&&!i){var a=this.textAreaInstance,n=zmStreamsApp.events.commentBoxMaxHeight(a.textarea),s=a.textarea.scrollHeight;0<n&&(s<n?a.resetMaxHeight():a.setMaxHeight({maxHeight:n}));var o=$.e(e).find(".SCS_cmnt").last(),m="SCS_postWra",r=this.isNewCollabUser?$.e(e).filter("."+m):$.e(e).find("."+m);r.parent().hasClass("SCS_postMail")&&(r=r.parent()),zmStreamsApp.events.setMaxHeight($.e(e),o[0],r[0])}this.model.get("isDraftShare")&&d.resizeFn&&d.resizeFn()},showHideRecipient:function(){var e=this.model.getRecipientsForMail();e&&e.length&&$.e(this.$el).find(".zm_inclr").removeClass("SC_dyn").prev().removeClass("SC_dyn")},initialize:function(e){var t=this,i=t.model;t.render(e.postElm,e.highlightComment,e.viewJSON,e.isNewCollabUser,e.hideComponent),t.listenTo(i,"change:add",t.addNew),t.listenTo(i,"change:recipientList",t.showHideRecipient),t.listenTo(i,"change:like",t.updateLike,t),t.listenTo(i,"change:listAll",t.listAll),t.listenTo(i,"change:removeComment",t.removeComment),t.listenTo(i,"add:privateComment",t.updPrivateComment),t.listenTo(i,"change:getLikes",t.showCommentLikes),t.listenTo(i,"change:singlecomment",t.singlecomment),t.listenTo(i,"change:disableComment",t.disableCommentUpdate),t.listenTo(i,"change:mentionData",t.updateMentions),e.isNewCollabUser&&t.listenTo(i,"change:inviteeList",t.addInviteeForMail)},addUnposted:function(e,t){if(this.textAreaInstance){var i=this.model.id,a=this.textAreaInstance.textarea,n=zmStreamsApp.util.retrieveUnposted(i),s=n.replyTo||"",o=n.text||"",m=n.mentions||[],r=n.attachment||[],l=!1,d=this.$el.find(".SC_PUbtm");if(s&&s.id){var c=s.id,p=s.name,h=this.template.replyComment(c,p);$.e(h).insertDOMBefore($.e(a).data("cid",c).parent()),e&&$.e(a).focus(),l=!0}o.trim()&&(this.fixedComment&&this.textAreaInstance.setMaxHeight({maxHeight:200}),this.textAreaInstance.setText(o),this.textAreaInstance.setMetaBlocks(m),e&&(this.isNewCollabUser?(this.updateInviteeList("mention"),setTimeout(function(){$.e(a).focus()},300)):$.e(a).focus()),l=!0),r&&0<r.length&&(this.addAttachment(!0),l=!0),l&&($.e(d).show(),$.e(this.$el).find("."+u).removeClass("zmHideD"))}},render:function(e,t,i,a,n){var s=this.model;t&&$.isArray(t)&&(t=t[0]);var o,m,r=s.id,l=s.get("attachIndex"),d=i||s.toJSON(),c=this.template.comments(d,l,t,a),p=d.fixedComment;this.fixedComment=p||!1,e?$.e(e).appendDOM(c):e=c,a&&(this.isNewCollabUser=!0),p?(m=a?$.e(e):$.e(e).parent().parent(),o=this.template.fixedComment({cid:r,sharedCall:d.sharedCall,isNewCollabUser:a,sharedApiCall:d.sharedApiCall,entityExists:d.entityExists,totalCount:d.total,isDraftShare:d.isDraftShare,attId:l,isShare:d.isSharedFolder,placeHolder:d.placeHolder||{},fixedComment:!0,inviteeList:d.inviteeList,sharedFolderUsers:d.sharedFolderUsers,sharedToMe:d.sharedToMe}),d.isSharedFolder&&d.sharedFolderUsers&&d.sharedFolderUsers.length<3&&$.e(o).find("font.inviteeList").remove(),d.disableComment||($.e(m).find(".zms_fixed.zmCmntFixed").remove(),$.e(m).appendDOM(o)),this.$el=$.e(m),e.parent().hasClass("SCS_postMail")&&(e=e.parent())):this.$el=$.e(c);var h=d.comments;void 0!==h&&this.setToolTip(h),this.setDefaultEvents(o);var u=this;if(p?u.addUnposted(p,m):setTimeout(function(){u.addUnposted(p,m)},0),t&&this.$el.find(".highlightClass").length){var v=this.$el;setTimeout(function(){var e=v.find(".highlightClass")[0];e&&e.scrollIntoView(!1)},500)}p&&!n&&zmStreamsApp.events.setMaxHeight(m,o,e[0],a,!0);for(var f=$.e(c).find(".zmsPCcontent"),g=s.get("groupId"),z=0;z<f.length;z++)zmUtil.addSelectMenu({applyDOM:f[z]},{groupId:g});return $.e(c).attr("data-commentviewid",this.cid).attr("data-id",s.id),s.setView(this.cid,this),n&&(p?($.e(o).hide(),$.e(c).parent().hide()):$.e(c).hide()),this},onClose:function(){var e=this;e.model.removeView(e.cid),e.fixedComment&&(e.noteAddCallback&&zmUtil.removeComponentsFromView("removeNoteFromView",{mountingElem:e.$el.find(".ms_note")[0]}),e.undelegateEvents(),e.unbind(),e.stopListening(),e.$el.find("div.sc_cmdv").remove(),e.model.get("sharedCall")&&e.$el.find(".zms_fixed").remove()),e.destroyTextArea(),e.remove()},destroyTextArea:function(){var e=this;e.textAreaInstance&&(e.textAreaInstance.destroy(),e.textAreaInstance=null,e.mentionsInstance&&(e.mentionsInstance.destroy(),e.mentionsInstance=null),e.hashTagInstance&&(e.hashTagInstance.destroy(),e.hashTagInstance=null),e.ComSmiley&&(e.ComSmiley.destroy(),e.ComSmiley=null))},removeComment:function(e,t,i){var a,n,s=this.$el,o=s.find('.delCmnt[data-cid="'+e+'"]'),m=$.e(o).closest("li"),r=$.e(s).hasClass("SCS_cmnt")||$.e(s).find(".SCS_cmnt").length;if((!o.length&&r&&((m=s.find('.zms_comment[data-cid="'+e+'"]')).length||(m=s.find('li[data-cid="'+e+'"]'))),a=$.e(m).next(),t&&2===$.e(m).siblings().length)&&(m=$.e(m).parent("ul.Spvt"),0===$.e(m).siblings().length))if(m=$.e(m).parent("li.pvtMsg"),i){m=$.e(m).parent("ul.pvtOwn"),n=$.e(m).parents(A).siblings();var l=zmStreamsApp.PostActions.fetchModel({eid:this.model.get("id")});l&&l.trigger("privateComment/deleted")}else(n=$.e(m).prev()).find(".SndPrv").show(),n.find(".ShwPrv").hide();$.e(m).hasClass(p)&&$.e(a).hasClass("pvtMsg")&&a.remove(),m.remove(),this.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"));var d=this.model.get("comments").length;if(this.model.get("sharedCall")&&this.fixedComment&&(d?this.$el.find(".StCnt").text(d):($.e(this.$el).find("."+g).hide(),this.$el.find(".cmntInfo").addClass("zmHideD"),this.$el.find(".cmntInfoWra").removeClass("cmntInfoWra"))),this.model.get("isDraftShare")&&!d){var c=this.template.draftNoComment();this.$el.find(".sc_cmdv").appendDOM(c)}this.isNewCollabUser&&this.setBottom()},disableCommentUpdate:function(){var e=this,t=e.model,i=e.$el,a=e.template,n=t.get("attachIndex");if(e.fixedComment){if(t.get("disableComment"))$.e(i).children(".SCS_cmnt").remove();else if($.e(i).find(".SCS_cmnt").length<=1){var s=a.fixedComment(t.toJSON());$.e(i).appendDOM(s)}}else{var o=a.comments(t.toJSON(),n);$.e(i).empty().appendDOM(o.children)}t.get("disableComment")?e.destroyTextArea():e.setDefaultEvents(i)},showMarkDownPreview:function(e){var t=this,i=t.textAreaInstance,a=i.getText().replace(/\s+$/,""),n=zmStreamsApp.util.getMentionDataEditor(i.getMetaBlocks());a=zmStreamsApp.template.getRTEContent(a,{mentions:n.offset});var s=zdom("div",{className:"zmDDScroll",style:{maxHeight:"500px"}},zdom("div",{className:"zmDDMDPrev",dangerouslySetInnerHTML:a}));$.e(s).find("blockquote").addClass("SC_quote"),s=zmUtil.parseHtmlURLS(s),$.e(s).find("a").addClass("pointerEventsNone");var o,m,r=_zm(".","zms_mention",s),l=t.model.toJSON(),d=l.groupId,c=[];l.shGroup&&l.shGroup.length&&(c=_.pluck(l.shGroup,"id"));for(var p=0,h=r.length;p<h;p++)m="zms_mention pointerEventsNone",o=String($.e(r[p]).data("zid")),(zmUtil.isGroup(o)||-1!==c.indexOf(o))&&(m+=" cursorDefault",r[p].removeAttribute("data-zid")),d&&-1===m.indexOf("cursorDefault")&&(zmUtil.isGroup(d)||_.size(l.inviteeList)&&-1!==l.inviteeList.indexOf(o))&&!zmUtil.isGroupMember(o,d)&&(m+=" inviteeColor"),r[p].className=m;$.e(s).find("img").on("load",function(){zmComponent.markdown.bestFitWidth(s,this),t.markDownPreviewDropDown&&t.markDownPreviewDropDown.position()}),t.markDownPreviewDropDown=zmStreamsApp.util.showDropdown({par:e.currentTarget,showArrow:!0,liDom:$.e(s),removeLi:!0})},setDefaultEvents:function(n){var s=this;n=n||s.$el;var t=$.e(n).find("textArea"),e=s.model.get("groupId");!zmUtil.isGroup(e)&&s.model.get("shGroup").length&&(e=s.model.get("shGroup")[0].id);var i=zmUtil.isGroup(e)?e:"";if(t.length){s.textAreaInstance=new c,s.textAreaInstance.init({textarea:t[0]}),$.e(s.textAreaInstance).on("HEIGHT_CHANGED",function(){s.reSize(),s.model.get("isDraftShare")&&zmStreamsApp.events.publishKeyEvent(s.model.get("miscData")),s.isNewCollabUser&&setTimeout(function(){s.reSize(),s.setBottom()},300)}),t=s.textAreaInstance.textarea;var o=$.e(t).parent("."+C)[0];$.e(s.textAreaInstance).on("TEXT_CHANGED",function(){if(s.textAreaInstance){var e=s.textAreaInstance.getText(),t=!1,i=$.e(n).find(".zmMarkDownPreview"),a=_zm.hasClass(o,"zmMentionOn");e.length?(a||(_zm.addClass(o,"zmMentionOn"),t=!0),e.trim().length&&!i.length?((i=zdom("font",{className:"zmMarkDownPreview mailAct",id:"mdPreview","data-tooltip":y.common.labels.preview},zdom("i",{className:"msi-preview"}))).onclick=function(e){s.showMarkDownPreview(e)},$.e(i).insertDOMBefore($.e(n).find(".zmMarkDown")[0])):e.trim().length||(s.markDownPreviewDropDown&&s.markDownPreviewDropDown.hide(),i.remove())):(a&&(_zm.removeClass(o,"zmMentionOn"),t=!0),s.markDownPreviewDropDown&&s.markDownPreviewDropDown.hide(),i.remove()),t&&s.fixedComment&&s.reSize()}});var a=s.getMentionObj(t,i);if(a.excludeMe=!0,s.model.get("isSharedFolder")){var m=s.model.get("sharedFolderUsers");(m=m.length?m.toString().split(","):[]).push(s.model.get("shOwner")),m=_.without(m,zmail.zuid),Array.isArray(m)&&m.length&&(a.includeOnly=m),s.mentionsInstance=zmContactsAutoComplete.autoComplete(a)}else{s.model.get("groupsMention")?a.includeAllGroups=!0:i&&(a.showGroup=i);var r=s.model.get("mention");r?(Array.isArray(r)&&r.length&&(a.includeOnly=r),s.mentionsInstance=zmContactsAutoComplete.autoComplete(a)):zmStreamsApp.util.getMentionList({group:s.model.get("group"),inviteeList:s.model.get("inviteeList"),shGroup:s.model.get("shGroup"),id:s.model.get("id"),type:s.model.get("etype")}).then(function(e){s.model.set("mention",e),!s.model.get("allowInvite")&&Array.isArray(e)&&e.length&&(a.includeOnly=e),s.mentionsInstance=zmContactsAutoComplete.autoComplete(a)})}s.model.get("sharedCall")&&s.fixedComment&&s.isNewCollabUser&&!s.model.get("entityExists")&&($.e(s.textAreaInstance).on("MENTION_REMOVED",function(){s.updateInviteeList("mention")}),$.e(s.textAreaInstance).on("MENTION_ADDED",function(){s.updateInviteeList("mention")})),s.hashTagInstance=zmHashTagAutoComplete.HashTagAutoComplete({input:t,inputInstance:s.textAreaInstance,onSelect:function(e,t){var i=t.item.attributes,a=this.userInput.getCurrentTypingWord();this.inputInstance.replaceTextBeforeCursorWith(a,"#"+i.text+" ")}}),s.ComSmiley=zmSmiley.SmileyAutoComplete({input:t,inputInstance:s.textAreaInstance,onSelect:function(e,t){var i=t.item.attributes.id+" ",a=this.userInput.getCurrentTypingWord();this.inputInstance.replaceTextBeforeCursorWith(a,i)}}),$.e(n).find("."+v).click(function(e){zmSmiley.showList(t,this,e,s.textAreaInstance)});var l=$.e(n).find(".cmntText")[0];if(s.linkPreview=zmLinks.PreviewManager(t).setComponentReadyCallback(function(e){$.e(l).appendDOM(e.getDOM()),s.reSize()}).setProgressDisplayDOM(l),$.e(window).resize(function(){s.model.get("isDraftShare")&&($.e(n).parents(".zmScMask")[0]||s.reSize());s.markDownPreviewDropDown&&(s.markDownPreviewDropDown.hide(),s.markDownPreviewDropDown=null)}),s.model.get("isDraftShare")){var d=$.e(s.$el).find(".msi-addgroup");d.length&&(d.mousedown(function(e){e.preventDefault()}),d.click(function(){t.focus();var e=$.e(s.$el).find("."+h);_zm.hasClass(e[0],"highlightClass")&&_zm.hasClass(o,"highlightClass")||(e.addClass("highlightClass"),_zm.addClass(o,"highlightClass"),setTimeout(function(){e.removeClass("highlightClass"),_zm.removeClass(o,"highlightClass")},5e3))}))}}},getInviteesListForMail:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this.sharedMailInvitees,i=e.refreshData||"all",a="all"===e.refreshData||!t,n=this.textAreaInstance,s=n.textarea;if(!t||a||i){if(t=t||{},a||"mention"===i){var o=zmStreamsApp.util.getMentionDataEditor(n.getMetaBlocks());t.mentions=o.offset.text}if(a||"recipientList"===i){var m=this.$el.find(".zm_inclr .msi-check").length?_zm.copyOf(this.model.getRecipientsForMail()):[];m&&(t.recipientList=m)}if(a||"inviteePop"===i){var r=$.e(s).data("dzids");t.dzids||(t.dzids=[]),t.dzids=_.uniq(t.dzids.concat(r||[])),$.e(s).data("dzids","")}t.inviteeList=[],this.model.get("entityExists")&&this.model.get("inviteeList")&&(t.inviteeList=this.model.get("inviteeList")),this.sharedMailInvitees=t}if(e.removeIds){for(var l,d=e.removeIds,c=0;c<d.length;c++)l=String(d[c]),t.mentions&&-1!==t.mentions.indexOf(l)&&(t.mentions.splice(t.mentions.indexOf(l),1),""!==n.getText().trim()&&n.removeMetaBlock(l)),t.recipientList&&-1!==t.recipientList.indexOf(l)&&t.recipientList.splice(t.recipientList.indexOf(l),1),t.dzids&&-1!==t.dzids.indexOf(l)&&t.dzids.splice(t.dzids.indexOf(l),1),t.inviteeList&&-1!==t.inviteeList.indexOf(l)&&t.inviteeList.splice(t.inviteeList.indexOf(l),1);this.sharedMailInvitees=t}return[].concat(t.inviteeList,t.mentions,t.recipientList,t.dzids)},updateInviteeList:function(e,t){if("mention"!==e||!this.model.get("entityExists")){t&&"string"==typeof t&&(t=[t]);var i=this.getInviteesListForMail({removeIds:t,refreshData:e}),a={};i&&i.length&&(a=zmStreamsApp.util.getContactDetails(i)),this.template.addInviteeList(a,this.$el[0])}},invCloseAction:function(e,t,i){var a=$.e(e.$els.$contentWrapper).find("input").data("removedZid")||[];i.length&&t.model.get("entityExists")&&zmStreamsApp.PostActions.updateInviteeForMail({type:"addInvitee",inviteeList:i,eid:t.model.id}),!i&&!a||t.model.get("entityExists")||t.addInviteeForMail(i,a)},showInviteeList:function(){if(this.model.get("isSharedFolder"))this.$el.parent().find(".SCShowinvite").click();else{var e=this.getInviteesListForMail(),t={};_.each(e,function(e){t[e]=String(zmail.zuid)});var i=function(){zmStreamsApp.util.hideMenu(),n&&(n.destroy(),n=void 0),l&&(l.destroy(),l=void 0)},a={items:t,isOwner:!0,showInvite:!0,type:"invitee_popup",invite:!0,closeAction:i},m=this;a.buttons=[{name:y.common.labels.invite,callback:function(e){for(var t=$.e(e.$els.$contentWrapper).find("input"),i=l.model.attributes.tokens.models,a=[],n=i.length,s=0;s<n;s++)a.push(i[s].attributes.zid);if(a.length)m.invCloseAction(e,m,a),w.hideMenu(),e.remove();else{var o=t.val().trim();_zm.succErrMsg("e",o.length?y.common.messages.addInvitee:y.common.messages.emptyInvite)}}},{name:y.common.labels.cancel,callback:function(e){e.remove(),i()},isCancel:!0}],a.dialogDidMount=function(e){m.bindInvitee(m,e.$els.$contentWrapper)},w.createDialog(a)}},addInviteeForMail:function(e,t){var i=this.textAreaInstance.textarea;(t.length||e.length)&&(e&&e.length&&(Array.isArray(e)||(e=e.split(",")),$.e(i).data("dzids",e)),this.updateInviteeList("inviteePop",t))},bindInvitee:function(o,e){var m=$.e(e).find(".addInv"),r=o.getInviteesListForMail(),t={tokenInput:m[0],autofillInput:e,exclude:function(){return r},onAdd:function(e){r.push(e.attributes.zid)},onRemove:function(e){r=_.without(r,e.attributes.zid)}};o.model.get("groupsMention")&&(t.includeAllGroups=!0),zmStreamsApp.util.bindInviteeDialogAutofill(t).then(function(e){l=e.tokenComponent,n=e.autoComplete}),$.e(e).find(".SC_cs .msi-close").click(function(){var e=$.e(this).parent(),t=$.e(e).data("uid");$.e(e).parent().remove();var i=m.data("removedZid")||[];if(i.push(t),r=_.without(r,String(t)),o.model.get("entityExists"))zmStreamsApp.PostActions.updateInviteeForMail({type:"removeInvitee",inviteeList:t,eid:o.model.id});else{o.updateInviteeList("inviteePop",i);var a=$.e(o.$el).find(".zm_inclr i");if(a.length&&a.hasClass("msi-check")||!1){var n=o.model.getRecipientsForMail(),s=o.getInviteesListForMail();n.every(function(e){return s.includes(e)})||a.click(),o.addInviteeForMail(s,i)}}m.data("removedZid",i)})},switchBackMail:function(e){var t=this.$el,i=this.textAreaInstance;$.e(t).find(".zmBTCmnt").removeClass("zmBTCmnt");var a=!this.model.get("entityExists")&&this.model.get("placeHolder")?this.model.get("placeHolder").button:y.common.labels.comment,n=$.e(t).find(".addcomnt"),s=n.hasClass("addTsk"),o=n.hasClass("addNote"),m=!this.model.get("entityExists")&&this.model.get("placeHolder")?this.model.get("placeHolder").textArea:y.common.labels.writeComment;if($.e(t).find(".mailAct").show().siblings(".appGroup").hide(),e&&this.clearText(!0),o){var r=$.trim(this.noteAddCallback.getNoteValues().textContent);$.e(t).find(".ms_note").hide(),n.text(a).removeClass("addNote"),$.e(t).find(".noteCmnt").show(),$.e(t).find("."+C).show(),r&&i.setText(r),i.textarea.placeholder=m}s&&(this.ComSmiley.disable=!1,this.hashTagInstance.disable=!1,$.e(i.textarea).off("keypress"),$.e(t).find(".taskcmnt").show(),i.textarea.placeholder=m,n.text(a).removeClass("addTsk")),this.mentionsInstance&&(this.mentionsInstance.excludeMe=!0,this.isNewCollabUser&&this.model.get("isSharedFolder")&&!this.model.get("sharedToMe")&&(this.mentionsInstance.disable=!0)),t.find("."+v).show(),t.find(".zmCmntSC .msi-comment").hide(),t.find(".zms_aAtt").show(),this.setBottom()},publishNote:function(){var e=$.e(this.$el).find(".appGroup").data("grp"),t=this.noteAddCallback;t.handleGroupChange(e);var i=this;t.quickAddList().then(function(){t.clearValues(),i.setBottom(),i.switchBackMail(!0),zmStreamsApp.util.removeUnposted(i.model.get("id"))})},publish:function(e){var c=this,p=c.model,t=(c.$el.hasClass("sc_cmdv")?c.$el:$.e(c.$el).find(A)).data("id");if(this.model.get("sharedCall")||this.fixedComment){if(p.id!==t)return;if(this.model.get("sharedCall")&&!1===this.model.get("entityExists")&&!this.model.get("isDraftShare")){var i=this.model.get("miscData");if(!zmUtil.isChildWindow()&&"undefined"!=typeof zmPrev&&!zmPrev.isEntityOpenedInPreview(i.mailID,i.openedTab))return}}c.linkPreview&&c.linkPreview.removeLoadingBar();var a=c.$el,n=this.textAreaInstance,h=n.textarea,u=n.getText().replace(/\s+$/,""),v=zmStreamsApp.util.getMentionDataEditor(n.getMetaBlocks()),f=$.e(a).find(".addcomnt");c.saveContent=!1,a.length||(a=p.get("fixedElement"));var s=a.find("."+I),g="";s.length&&(g=s.find("i").hasClass("msi-Dinvitee"));var z=$.e(h).data("selMailIds");if(this.isNewCollabUser&&$.e(e.currentTarget).hasClass("addTsk")){if($.e(f).hasClass("taskSel"))return void zmUtil.succErrMsg("e","Previous request in progress");if(!u)return void zmUtil.succErrMsg("e","Task cannot be empty");var o=$.e(this.$el).find(".appGroup").data("grp"),m="",r=u;if(!$.isEmptyObject(v.offset)){var l=v.offset;m=l.text[0],r=r.substring(0,l.from[0])}var d=$.isEmptyObject(z)?this.model.get("openedId"):z[0];d=d||zmUtil.getSelectedMails()[0];var C={title:r,groupId:o,taction:"addTaskSubtask",actionType:"addEntity"};C.assignee=m||zmail.zuid,g&&(C.lockinvites=g);var k=zmUtil.getMailObj(d);if(d&&k){var S=k.F;C.msgid=d,C.accid=zmail.defAccId,C.senderid=S,C.summary=k.SM||""}return $.e(f).addClass("taskSel"),void zmUtil.requireTaskModule("taskReq").done(function(e){e.taskReq(C,C,function(e,t){zmStreamsApp.util.removeUnposted(p.get("id")),$.e(f).removeClass("taskSel"),(e?e.TASKID:"")&&(zmUtil.succErrMsg("s","Task added successfully"),c.switchBackMail(!0),$.publish("/zm/task/addTask",[e,t]))},!0)})}this.isNewCollabUser&&$.e(e.currentTarget).hasClass("addNote")?this.publishNote():w.getAttachments(this.attCmpRef,!0).done(function(e){var t=c.hasAttachment();if(1e5<u.length){_zm.succErrMsg("e",y.common.messages.commentMaxSize);var i=b;p.get("sharedCall")&&(i=!0===p.get("entityExists")?b:p.get("placeHolder").button),w.sendRemove(f,!0,i)}else if(!u&&!t||$.e(f).hasClass("zs_snd")){if(""===u&&!t){_zm.succErrMsg("e",y.common.messages.emptyComment);var a=b;p.get("sharedCall")&&(a=!0===p.get("entityExists")?b:p.get("placeHolder").button),w.sendRemove(f,!0,a)}}else{var n=!0===p.get("entityExists")?{}:p.get("placeHolder");$.isEmptyObject(n)?w.sendRemove(f,!1,x):w.sendRemove(f,!1,n.changeText);var s=new Date;if(e.error)return 11===e.errorCode?_zm.succErrMsg("e",y.common.messages.commentVirusFound):12===e.errorCode?_zm.succErrMsg("i",y.common.messages.virusPending):13===e.errorCode&&_zm.succErrMsg("e",y.common.messages.virusFailed),w.sendRemove(f,!0,b),!1;if(e&&(100<e.attTmpObjCnt||100<e.attEntObjCnt||100<e.cloudAttListCnt))return _zm.succErrMsg("e",y.common.messages.maxAttachment),w.sendRemove(f,!0,b),!1;u=zmStreamsApp.template.getRTEContent(u,{mentions:v.offset});var o=$.e(c.$el).find(".zm_inclr i"),m=o.length&&o.hasClass("msi-check")||!1,r="";c.isNewCollabUser&&(r=(r=c.getInviteesListForMail())&&r.length?r.join(","):"");var l=zmStreamsApp.linkPreview.getLinkInfoFromComponentData(zmLinks.PreviewManager(h).getPreviewData());zmStreamsApp.util.removeUnposted(p.get("id"));var d={text:u,rte:!0,mentions:v,replyTo:$.e(h).data("cid"),includeRecipients:m,linkData:l,lockInvites:g,selectedMailIds:z,sharedMailInvitees:r,efn:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(!t.suppress&&!p.get("isDeleted")){var i=e.message||e.msg||y.common.messages.networkUnreachable;zmUtil.succErrMsg("e",i,t)}p.get("isDeleted")&&zmUtil.succErrMsg("e",y.common.messages.deletedPost);var a=b;p.get("sharedCall")&&(a=!0===p.get("entityExists")?b:p.get("placeHolder").button),w.sendRemove(f,!0,a),zmStreamsApp.util.logger&&zmStreamsApp.util.logger.push("streams/addComment/error",{msg:e,startTime:s,id:p.get("id")})}};e&&e.attTmpObj&&(d.attTmpObj=e.attTmpObj),e&&e.attEntObj&&(d.attEntObj=e.attEntObj),e&&e.cloudAttList&&(d.cloudAttList=e.cloudAttList),c.model.NewComment(d)}}).fail(function(e){_zm.succErrMsg("e",e.msg);var t=b;p.get("sharedCall")&&(t=!0===p.get("entityExists")?b:p.get("placeHolder").button),w.sendRemove(f,!0,t)})},clearText:function(e){var t=this.textAreaInstance,i=t.textarea;$.e(i).data("cid",""),this.saveContent=!0,t.setText(""),t.setMetaBlocks();var a=$.e(i).parents(".zms_txtLI");if(a.length||(a=$.e(i).parents(".cmntText").siblings("."+f)),e||(w.sendRemove($.e(a).find(".addcomnt"),!0,b),this.$el.find(".zms_rep").remove(),$.e(a).find(".zm_inclr").remove(),$.e(a).find(".mailSharedLock").remove(),this.clearAttachment(i,"attach"),zmLinks.PreviewManager(i).reset()),this.isNewCollabUser){var n=this;setTimeout(function(){n.setBottom()},400)}},clearAttachment:function(e){var t=$.e(e).parents("li.zms_txtLI");t.length||(t=$.e(e).parents(".SCS_cmnt")),$.e(t).find(".zms_aAtt .zmL").remove(),this.clearFiles()},clearFiles:function(){void 0!==this.attCmpRef&&""!==this.attCmpRef&&this.attCmpRef.clearStoreAttachments()},addNew:function(e){var t,i,a,n,s=_.last(this.model.get("comments")),o=this.model.get("comments").length,m=this.$el;t=this.template.comment(s,this.model.toJSON());var r=$.e(t).attr("data-cid");if(i=$.e(m).find(".cmnt_ul"),a=this.textAreaInstance,n=$.e(i).find(".addcomnt"),"fixedComment"===$.e(i).data("type"))$.e(i).last().children().last().attr("data-cid")!==r&&$.e(i).appendDOM(t);else{var l=$.e(i).children();$.e(l).eq($.e(l).length-2).attr("data-cid")!==r&&$.e(t).insertDOMBefore($.e(l).last())}!a.getText()&&!$.e(m).find(".zms_aAtt .zmL").length||e||this.clearText();var d=!0===this.model.get("entityExists")?{}:this.model.get("placeHolder");if((d=d||{}).textArea=d.textArea||y.common.labels.writeComment,d.button=d.button||y.common.comment,$.e(a.textarea).attr("placeholder",d.textArea),n.text(d.button),1!==o||this.model.get("isDraftShare")||$.e(i).siblings("."+g).length||!this.model.get("sharedCall")&&!this.model.isSharedFolder||$.e(i).parent().prependDOM(this.template.commentHeader()),this.setToolTip([s]),this.model.get("isDraftShare")&&(this.$el.find(".zmNoCmnt").remove(),zmStreamsApp.events.publishKeyEvent(this.model.get("miscData"))),s.tags.length){var c=_.pluck(s.tags,"type"),p=c.indexOf("HASHTAG");-1!==c.indexOf("HASHTAG")&&zmStreamsApp.GroupApp.updateHashTag(s.tags[p])}if(this.fixedComment&&this.isNewCollabUser){this.$el.find(".selMail").next().remove(),this.$el.find(".selMail").remove();var h=this.model.get("comments").length;if(this.$el.find(".cmntInfo").length)this.$el.find(".StCnt").text(h);else{var u=this.template.commentInfo(h);$.e(u).insertDOMBefore(this.$el.find("ul.inviteeList"));var v=this.template.commentInfo(h);$.e(v).addClass("zmHideD"),$.e(v).insertDOMBefore(this.$el.find(".cmntText"))}1===h&&($.e(this.$el).find("."+g).show(),this.$el.find("."+f).find(".cmntInfo").removeClass("zmHideD"))}},addAttachment:function(e){var t=this,i=t.$el,a=$.e(i).find(A).data("id");if(!this.isNewCollabUser||t.model.id===a){r=t.model;var n=i.find("textArea").data("attach");if(!i.find(".zms_aAtt").length){var s=$.e(i).find(".zms_txtLI .cmntText");s.length||(s=$.e(i).find(".cmntText")),$.e(zmStreamsApp.template.addAttachment(n)).insertDOMAfter(s)}var o={id:n};if(t.model.get("isDraftShare")&&(o.share_draft=!0,o.draftID=t.model.get("id"),o.onComponentChange=(t.model.get("miscData")||{}).uploadCallback),!0!==e)o.accId=zmUtil.getDefaultAccountID(),t.attachFiles(n);else{o.accId=zmUtil.getDefaultAccountID();var m=t.callAttachment(n);m.autoLaunch=!1,zmUtil.initAttachComponent(m,function(e){t.attCmpRef=e})}}},setToolTip:function(e){var t,i,a,n,s=this.$el;if((e=$.isArray(e)?e:[e]).length)for(var o in e)t=e[o],(i=s.find('.msi-love[data-cmid="'+t.id+'"]')).length&&(a=t.liked?y.streams.tooltip.unlikeComment:y.streams.tooltip.likeComment,i.attr({"data-tooltip":a,"data-tooltip-pos":"bottom"})),(n=s.find('.msi-trash[data-cid="'+t.id+'"]')).length&&n.attr({"data-tooltip":y.streams.tooltip.delComm,"data-tooltip-pos":"bottom"});if(this.isNewCollabUser&&s.find(".zmCmntSC").length){var m=s.find(".zmCmntSC");m.find(".msi-notes").attr({"data-tooltip":y.common.labels.noteComment,"data-tooltip-pos":"top"}),m.find(".msi-task").attr({"data-tooltip":y.common.labels.taskComment,"data-tooltip-pos":"top"}),m.find("."+z).attr({"data-tooltip":y.common.labels.commentIcon,"data-tooltip-pos":"top"})}s.find("."+I).length&&s.find("."+I).attr({"data-tooltip":y.common.labels.denyInvites,"data-tooltip-pos":"bottom"});var r=s.find("."+u);r.length&&r.attr({"data-tooltip":y.streams.tooltip.addattachmentComm})},selectMail:function(e,t){var i=$.e(this.textAreaInstance.textarea),a=i.data("selMailIds");a=a||[];var n="",s=this.model;"add"===t?a.push(e):a.splice(a.indexOf(e),1),i.data("selMailIds",a);var o=this.$el.find(".selMail");if(o.length)a.length?(o.show().find(".StCnt").text(a.length),n=zmText.applyArgs(y.streams.common.shareEmails,{num:a.length}),o.next().show(),i.trigger("focus").trigger("change")):(n=y.streams.common.shareConvo,o.hide().next().hide());else{var m=this.template.selectMailDOM(a.length);i.trigger("focus").trigger("change"),n=zmText.applyArgs(y.streams.common.shareEmails,{num:a.length}),this.$el.find(".zm_slc").prependDOM(m),$.e(m).next().show()}var r=this.$el.find(".addcomnt");!r||r.hasClass("addTsk")||r.hasClass("addNote")||r.text(n);var l=s.get("placeHolder");l.button=n,s.set("placeHolder",l),this.switchBackMail()},listAll:function(e,t,i){var a=this.$el,n=a.find(".cmntMore");if(n.removeClass("zmLock"),this.loadingDiv&&this.loadingDiv(),$.e(t).is(n)){var s=_zm.copyOf(this.model.get("comments")),o=a.find(".zms_txtLI"),m=a.find("ul.Stcmt"),r=this.fixedComment,l=o.parents(".SCS_cmnt"),d=m.parents(".SCS_postWra"),c=d.parents(".SCS_popUp");r?$.e(m[0]).empty():this.model.get("disableComment")?$.e(m).children().remove():(o.siblings().remove(),o=o.detach());var p,h,u=this.model.toJSON(),v=n.data("count"),f=s.length;if(v+10<f&&(s=s.slice(f-(v+10),f)),i)for(var g in s)p=s[g].time,(h=w.updateTime(parseInt(p)))&&(s[g].on=h);if(u.comments=s,this.template.commentList(u,m[0]),r?zmStreamsApp.events.setMaxHeight(c,l[0],d[0]):m.appendDOM(o),s.length<10)n.remove();else{var z=this.model.get("total")-s.length;if(0===z)n.remove();else a.find(".cmntMore").parent().find(".cmntMore").remove(),$.e(m[0]).prependDOM(this.template.viewmore(zmText.applyArgs(y.common.labels.viewMoreComments,{count:z}),s[0].id,s.length))}this.setToolTip(s)}},singlecomment:function(e,t){var i=t.type,a=t.elm;"popup"===i?this.showSingleComment(a):"update"===i&&this.addNew(!0)}}),e}(zmStreamsApp.CommentModule.views);
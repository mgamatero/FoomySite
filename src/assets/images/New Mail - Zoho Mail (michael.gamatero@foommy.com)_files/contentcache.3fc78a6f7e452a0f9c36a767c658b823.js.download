"use strict";define([],function(){var e=zmail.Core.Namespaces.create("zmail.Components.ContentCache.Utils"),t=function(){function e(){babelHelpers.classCallCheck(this,e);this.map={},this._length=0}return babelHelpers.createClass(e,[{key:"clear",value:function(){var e=this;delete e.map,e.map={},e._length=0}},{key:"add",value:function(e,t){this.map[e]=t,this._length+=1}},{key:"isPresent",value:function(e){return!!this.map.hasOwnProperty(e)}},{key:"get",value:function(e){return this.map[e]}},{key:"update",value:function(e,t){this.map[e]=t}},{key:"remove",value:function(e){delete this.map[e],this._length-=1}},{key:"getLength",value:function(){return this._length}}]),e}();return e.SimpleMap=t}),define([],function(){var e=zmail.Core.Namespaces.get("zmail.Components.ContentCache.Utils"),a=function(e){var t="";t+="Freq set: "+e.getCounter()+" ";for(var a,n=e._head;n;)t+=(a=void 0,a="",a+=n.key+"---\x3e "),n=n.next;window.console.log(t)},t=function(e){var t=e.getCacheLib().head;for(window.console.log("#####START LIST#####");t;)a(t),window.console.log("-------"),t=t.next;window.console.log("#####END LIST#####")};return e.PaintList=t}),define([],function(e){var t=zmail.Core.Namespaces.create("zmail.Components.ContentCache"),a=function(){function a(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,a);var t=this;t.prev=e.prev||null,t.next=e.next||null,t.key=e.key}return babelHelpers.createClass(a,[{key:"getNext",value:function(){return this.next}},{key:"getPrev",value:function(){return this.prev}},{key:"getKey",value:function(){return this.key}}]),a}();return t.NodeEntity=a}),define([],function(r){var e=zmail.Core.Namespaces.create("zmail.Components.ContentCache"),n=e.NodeEntity,t=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,t);this._counter=e.counter||0,this.next=e.next||null,this.prev=e.prev||null,this._items={},this._head=null,this._tail=null,this._length=0}return babelHelpers.createClass(t,[{key:"getCounter",value:function(){return this._counter}},{key:"add",value:function(e){var t=this;if(!this._items[e]){var a=new n({key:e,next:t._head});t._head?t._head.prev=a:t._tail=a,t._head=a,t._items[e]=a,t._length+=1}}},{key:"remove",value:function(e){var t=this._items[e];if(t){var a=t.prev,n=t.next;a?a.next=n:this._head=n,n?n.prev=a:this._tail=a,r("zmUtil").debugLog("Node to be removed: "+e),delete this._items[e],this._length-=1}}},{key:"getHead",value:function(){return this._head}},{key:"getTail",value:function(){return this._tail}},{key:"isEmpty",value:function(){return 0===this._length}}]),t}();return e.FrameSet=t}),define([],function(e){var t=zmail.Core.Namespaces.create("zmail.Components.ContentCache"),a=t.Utils.SimpleMap,i=t.NodeEntity,n=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.maxSize=e.maxSize||100,this.head=this.tail=null,this.map=new a}return babelHelpers.createClass(t,[{key:"setThresholdLimit",value:function(e){this.threshold=e}},{key:"clear",value:function(){this.map.clear(),this.head=this.tail=null}},{key:"getKeys",value:function(){}},{key:"hasKey",value:function(e){return this.map.isPresent(e)}},{key:"get",value:function(e){var t=this.map;if(!t.isPresent(e))return!1;var a=t.get(e).value,n=new i({key:e});return this.remove(e),this._setHead(n),this.map.add(e,{value:a,set:n}),a}},{key:"_setHead",value:function(e){var t=this;e.next=t.head,(e.prev=null)!==t.head&&(t.head.prev=e),t.head=e,null===t.tail&&(t.tail=e)}},{key:"add",value:function(e,t){var a=this,n=a.map;if(void 0===e&&void 0===t)return!1;n.isPresent(e)||a.map.getLength()!==a.maxSize||a.evict(),n.isPresent(e)&&a.remove(e);var r=new i({key:e});a._setHead(r),a.map.add(e,{value:t,set:r})}},{key:"remove",value:function(e){var t=this.map;if(!t.isPresent(e))return!1;var a=t.get(e).set;null!==a.prev?a.prev.next=a.next:this.head=a.next,null!==a.next?a.next.prev=a.prev:this.tail=a.prev,this.map.remove(e)}},{key:"evict",value:function(){var e=this.tail;this.remove(e.key)}},{key:"toString",value:function(){for(var e=this.head;null!==e;)window.console.log(e.key+" ---\x3e "),e=e.next}}]),t}();return t.LRUCacheSystem=n}),define([],function(n){var e=zmail.Core.Namespaces.create("zmail.Components.ContentCache"),a=e.Utils.SimpleMap,s=e.FrameSet,t=function(){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.maxSize=e.maxSize||100,this.head=this.tail=new s,this.map=new a}return babelHelpers.createClass(t,[{key:"setThresholdLimit",value:function(e){this.threshold=e}},{key:"clear",value:function(){this.map.clear(),this.head=this.tail=new s}},{key:"getKeys",value:function(){}},{key:"hasKey",value:function(e){return this.map.isPresent(e)}},{key:"get",value:function(e){var t=this.map.get(e);if(!t)return!1;var a=t.set,n=a.next;return n&&n.getCounter()===a.getCounter()+1||(n=new s({counter:a.getCounter()+1,prev:a,next:a.next}),a.next&&(a.next.prev=n),a.next=n,a===this.tail&&(this.tail=n)),a.remove(e),n.add(e),t.set=n,a.isEmpty()&&this._removeFrameSet(a),t.value}},{key:"add",value:function(e,t){var a,n=this,r=n.map;if(void 0===e||void 0===t)return!1;if(r.isPresent(e))return(a=n.map.get(e)).value=t,void n.map.update(e,a);n.map.getLength()===n.maxSize&&n.evict();var i=n.head;0<n.head.getCounter()&&(n.head=new s({next:i}),i.prev=this.head),n.head.add(e),n.map.add(e,{value:t,set:n.head})}},{key:"_removeFrameSet",value:function(e){var t=this;n("zmUtil").debugLog("Freq Frame set to be removed"+e.getCounter());var a=e.next;e===t.head?null===a?t.head=t.tail=new s:(a.prev=null,t.head=a):e===t.tail?(t.tail=e.prev,e.prev.next=null):(e.prev.next=e.next,e.next.prev=e.prev)}},{key:"remove",value:function(e){var t=this.map;if(void 0===e&&!t.isPresent(e))return!1;var a=t.get(e);if(!a)return!1;this.map.remove(e),a.set.remove(e),a.set.isEmpty()&&this._removeFrameSet(a.set)}},{key:"evict",value:function(){}}]),t}();return e.BaseReplacementCacheSystem=t}),define([],function(e){var t=zmail.Core.Namespaces.create("zmail.Components.ContentCache"),a=function(e){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"evict",value:function(){var e=this.head;if(e){var t=e.getTail();if(t){var a=this.map.get(t.key);a&&(this.map.remove(t.key),a.set.remove(t.key),a.set.isEmpty()&&this._removeFrameSet(a.set))}}}}]),t}(t.BaseReplacementCacheSystem);return t.LFUCacheSystem=a}),define([],function(){var e=zmail.Core.Namespaces.create("zmail.Components.ContentCache"),t=function(e){function t(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"evict",value:function(){var e=this.tail;if(e){var t=e.getTail();if(t){var a=this.map.get(t.key);a&&(this.map.remove(t.key),a.set.remove(t.key),a.set.isEmpty()&&this._removeFrameSet(a.set))}}}}]),t}(e.BaseReplacementCacheSystem);return e.MFUCacheSystem=t}),define([],function(){var a=zmail.Core.Namespaces.create("zmail.Components.ContentCache"),e=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,[{key:"getCacheSystem",value:function(e,t){return new("LRU"===e?a.LRUCacheSystem:"MFU"===e?a.MFUCacheSystem:a.LFUCacheSystem)(t)}}]),e}();return a.CacheSystemFactory=e}),define([],function(i){var r,s=i("$"),e=zmail.Core.Namespaces.get("zmail.Components.ContentCache"),o=function(){return s.Deferred()},t=function(){function n(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,n);var t=this,a=e.type||"MFU";delete e.type,t.keyParam=e.keyParam,delete e.keyParam,t._requestURI=e.requestURI,delete e.requestURI,t._requestType=e.requestType,delete e.requestType,t._defaultParams=e.defaultParams||{},t._cacheLib=r.getCacheSystem(a,e),e.fetchMethod&&"function"==typeof e.fetchMethod&&(t._fetchMethod=e.fetchMethod),t._hooks={},t._hooks.beforeAdd=e.beforeAdd}return babelHelpers.createClass(n,[{key:"_fetch",value:function(e,t){var a,n=this,r=s.extend({},n._defaultParams,e.p);if(n._fetchMethod)return n._fetchMethod(r,e).then(t.success,t.error);a={p:r,onerror:t.error,fn:t.success,u:n._requestURI,t:n._requestType},a=s.extend({},e,a),i("zmAjq").XHR(a)}},{key:"_getSingleItem",value:function(a,n){var r=this._cacheLib,i=o(),s=this._hooks,l=function(e){a=e},e={success:function(e){var t;"function"==typeof s.beforeAdd&&(e=s.beforeAdd(e,a,{updateKey:l})),e?(t=n.avoidCache?e:(r.add(a,e),r.get(a)),i.resolve(t)):i.resolve(e)},failure:function(e){i.reject(e)}};return r.hasKey(a)&&!n.forceFetch?i.resolve(r.get(a)):this._fetch(n,e),i.promise()}},{key:"_getMultipleItems",value:function(e,a){var n=o(),r=this._cacheLib,i=this._hooks,s={},l=[],t={success:function(e){Object.keys(e).forEach(function(t){"function"==typeof i.beforeAdd&&(e[t]=i.beforeAdd(e[t],t,{updateKey:function(e){t=e}})),a.avoidCache?s[t]=e[t]:(r.add(t,e[t]),s[t]=r.get(t))}),n.resolve(s)},failure:function(e){var t={};0<s.length&&(t.type="partial"),t.result=s,n.reject(e,t)}};return e.forEach(function(e,t,a){r.hasKey(e)?s[e]=r.get(e):l.push(e)}),(e=l).length?(a.p[this.keyParam]=e.join(","),this._fetch(a,t)):n.resolve(s),n.promise()}},{key:"get",value:function(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=this,n=t.p,r=a._getSingleItem.bind(a);return 1===(e=(e=n[a.keyParam]).split(",")).length?e=e[0]:r=a._getMultipleItems.bind(a),r(e,t)}},{key:"put",value:function(e,t){this._cacheLib.add(e,t)}},{key:"clear",value:function(){this._cacheLib.clear()}},{key:"remove",value:function(e){this._cacheLib.remove(e)}},{key:"getCacheLib",value:function(){return this._cacheLib}}]),n}();return r=new e.CacheSystemFactory,e.ContentCacheComp=t});
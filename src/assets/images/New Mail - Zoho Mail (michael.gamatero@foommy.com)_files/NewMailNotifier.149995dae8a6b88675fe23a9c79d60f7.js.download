"use strict";!function(){var w=zmail.Core.Namespaces.create("zmail.Listing.Notifier"),N=ZMail.lConstants,F=N.cls,r=function(i){var e=0,t=zmList.getListObj(i),a=(t=t&&t.MO||[]).length,l=0;if(zmUtil.isInlineCompose())for(l=0;l<a;l++)zmList.getMailObj(t[l]).DMID&&e++;else for(l=0;l<a;l++)zmList.getMailObj(t[l]).FD===zmail.folId.dId&&e++;return e},j=function(i,e){var t=zmList.getMailObj(i),a=zmList.getMailObj(e);if(t&&a){0===a.S?a.TS=0:a.TS=void 0!==t.TS?t.TS:t.S,a.TC=t.TC||1,a.TTAGS=t.TTAGS||t.TAG,a.TSB=a.TSB||t.TSB||t.SB,a.FD===zmail.folId.sId?a.TSM=t.TSM||t.SM:a.TSM=a.TSM||t.TSM||t.SM,a.TSN=a.TSN||t.TSN||t.SN,a.TI=t.TI||!1,a.TF=t.TF||!1,a.TM=t.TM||!1,a.AT?a.TA=1:a.TA=void 0!==t.TA?t.TA:t.AT;var l=t.NFG?parseInt(t.NFG):0;if(!a.TI&&!a.TF&&!a.TM&&0!==l)switch(l){case 1:a.TI=!0;break;case 2:a.TM=!0;break;case 3:a.TF=!0}a.NFG&&(1===parseInt(a.NFG)?a.TI=!0:2===parseInt(a.NFG)?a.TM=!0:3===parseInt(a.NFG)&&(a.TF=!0)),a.FD===zmail.folId.dId&&(a.DC=r(a.T)),a.CMT=t.CMT,a.CT=t.CT}},A=function(i){var e=i.length,t=1,a=i[t];for(t=1;t<e;t++)if(zmList.getMailObj(i[t]).FD!==zmail.folId.sId){a=i[t];break}return a},b=function(i,e){var t=$(zmail.mailCenter.listElem).find("#"+i),a="",l=zmInit.getThreadSubject(e.M);if(e.FD!==zmail.folId.dId&&(zmail.mailOpt.isshowSummary&&e.TSM&&e.TSM.trim()&&(a=e.TSM),t.find("."+F.from+" ."+F.sender).text(e.TSN),t.find("."+F.subject).html(ZMail.lView.constTemplate("subject",{subject:l})),t.find("."+F.summary).html(ZMail.lView.constTemplate("summary",{summary:a}))),0<e.TC){var d=t.find("."+F.tc);d.length&&e.FD!==zmail.folId.dId?d.text(e.TC):d.length||t.find("."+F.tcOuter).html(ZMail.lView.constTemplate("threadCount",{count:e.TC}))}var m=i;if(0===i.indexOf("t")&&(m=i.substring(1)),e.FD===zmail.folId.dId){var s=r(e.T)||1,n=zmList.getMailObj(m);n&&(n.DC=s)}if(e.TS2){var o=t.find(".msi-mail,.msi-rpd,.msi-fwd,.msi-fwdRpd");o.length&&(o.removeClass(),o.addClass(["","msi-rpd","msi-fwd","msi-fwdRpd"][e.TS2]+" zmLTicon"),o.html(""),o.append(zdom("i",{className:"path"})))}};w.getNewMessage=function(i,e,t,a){var l,d;if(l=t.AID,d=t.data){var m=t.hasOwnProperty("SHID"),s=zmail.accId;if(s===l||m){var n=d[N.meta.id],o=d[N.meta.fId],r=zmList.getMailObj(n);r&&r.FD===zmail.folId.dId&&(d.PA=r.PA),d.DT=d.RDT||d.DT,d.SN=d.NSN||d.SN;var I=d[N.meta.read],z=d[N.meta.archive];m&&(d.SHID=t.SHID),r||(m||I||z||(d.FD===zmail.folId.spId||d.FD===zmail.folId.tId?ZMail.utils.updateCount({fId:o,mode:"inc",count:1,isHighlight:!1}):ZMail.utils.updateCount({fId:o,mode:"inc",count:1,isHighlight:!0})),zmail.folId.teId===o?ZMail.utils.updateCount({fId:zmail.folId.teId,mode:"inc",state:"read"}):zmail.folId.dId===o&&"NEW_MAIL"===t.act&&ZMail.utils.updateCount({fId:zmail.folId.dId,mode:"inc",state:"read"})),zmUtil.addMailData(d,d.M),$.publish("/maction/newm",[[d]])}else{0===d[N.meta.read]&&zmUtil.updateCountForAcc(l,"inc",1)}s===zmail.defAccId&&l===zmail.defAccId&&zmInit.updateIDB({transactType:"create",data:{meta:d,content:a.CONTENT}})}},w.reviewMailNotification=function(i,e){i=zmUtil.getMailObj(i.M);var t,a,l=zmUtil.getFolId(),d=zmInit.getListingDetObj(),m=!1,s=!1,n=!1,o=!1,r=zmUtil.getMLConversionValue(l);l===zmail.folId.sId||l===zmail.folId.tId?r=0:2===r&&l===zmail.folId.spId&&(r=1);var I,z,f,T=i.T,M=T&&zmList.getListObj(T),p=T&&zmList.getMailObj(T);if(T){i.FD===zmail.folId.dId&&zmUtil.isInlineCompose()||zmCache.updateObj({mode:"insert",msgId:i.M,rt:i.R,folId:T,type:"newm"});var g=zmList.getMailObj(i.PA);i.FD===zmail.folId.dId&&zmUtil.isInlineCompose()&&g&&(g.DMID=i.M,0===r&&(g.DC=zmList.updateModel("DC",g.DC+1||1,i.PA))),p&&0===p.TH&&(p.TH=1,p.T=T,p.TC=1,M?M.MO?1===zmail.convSortOrder?M.MO.unshift(i.M):M.MO.push(i.M):i.FD===zmail.folId.dId&&zmUtil.isInlineCompose()?M.MO=[T]:1===zmail.convSortOrder?M.MO=[T,i.M]:M.MO=[i.M,T]:i.FD===zmail.folId.dId&&zmUtil.isInlineCompose()?(p.DC=1,zmUtil.createListMap(T,{MO:[T]})):(i.FD===zmail.folId.dId&&zmList.updateModel("DC",1,T),1===zmail.convSortOrder?zmUtil.createListMap(T,{MO:[T,i.M]}):zmUtil.createListMap(T,{MO:[i.M,T]})),$.publish("mail/threadCreated",{conversationID:T}))}if(!(i.FD===zmail.folId.spId&&l!==zmail.folId.spId||i.FD===zmail.folId.tId&&l!==zmail.folId.tId)){(d.fId&&l===i.FD||!d.fId&&!i.SHID)&&(n=!0);var c=i.NFG&&d.flag&&("-1"===d.flag&&0!==parseInt(i.NFG)||parseInt(d.flag)===parseInt(i.NFG)),u=d.label&&i.TAG&&("-1"===d.label||-1!==i.TAG.indexOf(d.label));("unread"===d.view&&0===i.S||"1"===d.attach&&i.AT||c||u||"archive"===d.view&&i.AR||(d.fId&&l===i.FD||!d.fId&&"all"===l)&&!d.flag&&!d.label&&!d.attach&&"unread"!==d.view&&!i.AR)&&(s=!0);var C=zmList.getListObj(i.FD),h=zmList.getListObj(l);if((C&&-1===C.MO.indexOf(i.M)||h&&-1===h.MO.indexOf(i.M))&&(o=!0),n&&s&&o&&(m=!0,i.TH&&0!==r)){var D=zmList.getDupThdRowId(i.M,l);D?j(D,i.M):M&&0<(a=zmList.getViewBasedMsgList(i.T,d,!0)).length&&(i.FD===zmail.folId.dId?j(i.M,i.M):zmList.getMailObj(a[1]).FD===zmail.folId.sId?(t=A(a),j(t,i.M)):j(a[1],i.M))}}!m&&0!==r&&i.TH&&l!==zmail.folId.spId&&l!==zmail.folId.tId&&(M?0<(a=zmList.getMailSummaryList(d,i.T)).length&&(a=zmList.getViewBasedMsgList(i.T,d,!0),i.FD===zmail.folId.dId?j(i.M,i.M):zmList.getMailObj(a[1]).FD===zmail.folId.sId?(t=A(a),j(t,i.M)):j(a[1],i.M),m=!0):(I=i.M,z=l,m=!!(f=zmList.getDupThdRowId(I,z))&&(j(f,I),!0))),m&&w.updateForNewMail(i,e,s);var v=[zmail.folId.spId,zmail.folId.tId,zmail.folId.dId],L=i.hasOwnProperty("SHID"),O=i[N.meta.fId];if("zmailReconnect"!==e&&(L&&zmfolAction.isDeskNotificationEnabled({SHID:O})||!L&&-1===v.indexOf(O)&&0===i.S&&!zmInit.isNotificationSuppressed(O))){zmInit.mNotifier.push(i);var S={tag:"Mail",title:i.SN||i.F||"",msg:zmUtil.replaceHTMLEntities(i.SB)||""},F=null,b=zmResource.get("image","SC-Photo.png");(F=zmail.ContactBook.get({promise:!1,eid:i.F,type:["personal","org"]})[0])&&(b=F.photo(!1)),S.imgUrl=b,S.callback=function(){zmList.getMailData({msgId:i.M,opentype:2,type:"lt",src:"external",eprm:{accId:zmail.accId}})},_zm.pushDesktopNotification(S)}},w.updateForNewMail=function(e,i,t){var a,l,d,m,s,n,o,r,I,z,f,T,M,p=!1,g=!1,c=!1,u=[],C="",h=!0,D="",v=zmUtil.getMLConversionValue();if(l=e.FD,a=zmInit.getListingDetObj(),d=zmUtil.getFolId(),e.AR||(e.AR=0),e.NFG||(e.NFG="0"),"zmailReconnect"!==i&&e.FD!==zmail.folId.sId&&e.FD!==zmail.folId.dId||(h=!1),d===zmail.folId.sId||d===zmail.folId.tId?v=0:2===v&&d===zmail.folId.spId&&(v=1),e.T&&0!==v){D="zm_tabt"+e.T,0!==e.S||e.TS||(e.TS=0),zmsuite.isWorkspaceAvailable(D)&&(c=!0);var L=$(zmail.mailCenter.prevElem);if(L.hasClass("shw")&&(m=L.attr("data-mid"),(s=zmList.getMailObj(m)).T===e.T||m===e.T)){p=g=!0,"th"===L.attr("data-ty")?(m=C=(C=zmCenterListing.mailObjectAPI.getViewParentOf("c"+m))&&C.id||m,s=zmList.getMailObj(m)):C=m;var O=$(zmail.mailCenter.listElem).find("#"+C);!(n=$(zmail.mailCenter.listElem).find("#thd"+C)).length&&O.length?(C="t"+C,O.attr("id",C)):(C="t"+C,O=$(zmail.mailCenter.listElem).find("#"+C))}}else 0===v&&e.TH&&(e.TC=-1);if(g||(0===v||(2===v||1===v&&t)&&d===zmail.folId.sId==(e.FD===zmail.folId.sId)&&d===zmail.folId.dId==(e.FD===zmail.folId.dId)?0!==v&&e.TH&&!p?$.when(function(i,e){var t,a,l,d,m=i.T,s=!1,n=!1,o=$.Deferred();if(i.TC=i.TC||1,a=zmList.getViewBasedMsgList(m,e,!0),t=zmUtil.getFolId(),0<a.length&&(n=!0,d=$(zmail.mailCenter.listElem).find("#t"+a[1])),n&&i.FD!==zmail.folId.dId&&d.length)i.TC=a.length,d.remove(),$(zmail.mailCenter.listElem).find("#thd"+a[1]).remove(),s=!0,l=a[1];else if(l=zmList.getDupThdRowId(i.M,t)){var r=zmList.getMailObj(l);$.publish("mail/updateRead",{msgId:i.M,oldMId:l,newMailWS:!0}),r.T?($(zmail.mailCenter.listElem).find("#"+l).remove(),$(zmail.mailCenter.listElem).find("#t"+l).remove(),$(zmail.mailCenter.listElem).find("#thd"+l).remove()):(r.TC=1,r.TH=1,r.T=l,$(zmail.mailCenter.listElem).find("#"+l).remove()),i.FD!==zmail.folId.dId?i.TC=r.TC+1:i.TC=r.TC,s=!0}if(s){var I=zmList.getListObj(t),z=I&&I.MO.indexOf(l);-1!==z&&I.MO.splice(z,1),o.resolve()}else zmList.getThreadCount({msgId:i.M,viewObj:e,deferredObj:o});return o}(e,a)).then(function(){var i=!0;"unread"===a.view&&1===e.TS&&(i=!1),i&&w.addMailsToListing(e,d),zmCache.updateObj({mode:"insert",msgId:e.M,rt:e.R,folId:d}),$.publish("mail/updateRead",{msgId:e.M,newMailWS:!0}),zmPrev.updatePvNtforNewMails()}):(w.addMailsToListing(e,d),p||(zmCache.updateObj({mode:"insert",msgId:e.M,rt:e.R,folId:l}),""===a.fId&&zmCache.updateObj({mode:"insert",msgId:e.M,rt:e.R,folId:d})),zmPrev.updatePvNtforNewMails()):(r=v,I=t,(o=e).TC=o.TC||1,z=zmUtil.getFolId(),f=zmList.getDupThdRowId(o.M,z),M=zmList.getMailObj(f)||{},f&&(T=$(zmail.mailCenter.listElem).find("#t"+f),M.T||(M.TC=1,M.TH=1,M.T=f),o.FD===zmail.folId.sId&&(2===r||1===r&&I)?(o.TC=M.TC+1,M.TC+=1):o.TC=M.TC||o.TC,o.DT=M.DT||o.DT,T.length?(b("t"+f,o),$(zmail.mailCenter.listElem).find("#thd"+f).remove()):(T=$(zmail.mailCenter.listElem).find("#"+f)).length&&b(f,o)))),h||(g?u=zmPreviewTemplate.getMissingMailList(e.T,"P"):c&&(u=zmPreviewTemplate.getMissingMailList(e.T,"T"))),g&&(h?zmPreviewTemplate.showNotifBand({targetElem:zmsuite.getCenter("zm_Container")[1].getNodes()[1].$el,thdId:e.T,opentype:4===zmail.mailOpt.isPopup?4:0}):$.publish("/mail/updatemailview",[{list:u,opentype:4===zmail.mailOpt.isPopup?4:0}]),"archive"!==a.view&&(e.FD!==zmail.folId.sId||e.FD===zmail.folId.sId&&!zmList.excludeSent)&&(2===v||1===v&&(t||e.FD===zmail.folId.dId)))){if(e.FD!==zmail.folId.dId){if($(zmail.mailCenter.listElem).find("#thd"+m).length){var S=document.createDocumentFragment();S.appendChild(zmList.constructThreadChildRow(e.M,!1)[0]),zmail.convSortOrder?n.append(S):n.prepend(S)}s?(s.TC+=1,e.TC=s.TC):e.TC+=1,0===e.TS&&C&&e.FD!==zmail.folId.dId&&$("#"+C).addClass(F.unread)}b(C,e)}c&&(h?zmPreviewTemplate.showNotifBand({targetElem:zmsuite.getCenter(D)[1].getNodes()[1].$el,thdId:e.T,opentype:2}):$.publish("/mail/updatemailview",[{list:u,opentype:2}]))},w.addMailsToListing=function(i,e){var t;if(t=$.e(zmail.mailCenter.listElem),zmail.mailOpt.isshowSummary||(i.SM=""),!t.closest(".SC_streams").length){if(zmList.isAllListingChecked(t))ZMail.utils.getHeaderRef({tabId:"zm_Container",partName:"menuBar"}).find("."+F.checkBox).removeClass().addClass("msi-uncheck msi-partcheck");var a=$(zmInit.constructMailRow(e,[i.M]));t.find("#nomails").length&&t.html(a);var l=zmfolAction.getSortProperties(e,"type");0===l?t.prepend(a):1===l&&0===zmList.getListObj(e).showNextPage&&t.append(a),zmInit.listingBand.SpamTrashBand.setBand()}}}();
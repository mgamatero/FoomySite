"use strict";!function(){var i=zmail.Core.Namespaces.create("zmState"),a={},t={},s=!1,n="/apps/tabSwitched",r="session/dataChanged";i.rightInfo=i.rightInfo||{},i.centerInfo=i.rightInfo||{};i.setSpecificLandingPage=function(e){var t=e.app,a=t.currApp;i.appHandlers[a]?i.appHandlers[a](t):(zmApp.showApp("m"),1===zmInit.lPageType()?zmList.showMailListing({fId:zmail.folId.iId}):zmList.showMailListing({fId:"zm_unread"}))},i.sendRequestToSaveState=function(){if("none"!==zmAdHocSettings.getLPageType()&&"undefined"!=typeof zmApp&&"undefined"!=typeof zmTab){var e=zmAdHocSettings.getUiState();_.isEqual(e,i.getCurrentStateSnapshot())||zmAdHocSettings.setUiState(i.getCurrentStateSnapshot())}},i.getAndStoreSettingsValue=function(){a=zmAdHocSettings.getUiState()};i.getStoredSessionState=function(){return a},i.getCurrentStateObject=function(){return t},i.getCurrentStateSnapshot=function(){var e={},t={},a={},n=zmsuite.getCurrentAppObjId();return t.app=function n(e){var r={};return _.each(e,function(e,t){if("object"===babelHelpers.typeof(e)){var a=n(e);0<Object.keys(a).length&&(r[t]=a)}else e&&(r[t]=e)}),r}(i.appInfo.getDataToSave()),t.app.currApp=zmApp.currentApp,a.list=i.tabInfo.getTabData(),zmTab.currentTab!==n&&(a.selected=zmTab.currentTab),t.tab=a,e.data=t,e.type="restore",{state:e}},i.setStoredLandingPageData=function(){var e;0<arguments.length&&void 0!==arguments[0]&&arguments[0];if(a&&a.state&&a.state.data)switch(e=a.state.data,a.state.type){case"specific":i.setSpecificLandingPage(e);break;case"restore":i.restoreSessionFromData(e)}},i.restoreSessionFromData=function(e){var t,a=e.app,n=a.currApp,r=!0,o=$.Deferred();i.appHandlers[n]?(s=!0,t=zmComponent.loadingMasks({maskText:"Restoring Session"}),r=!e.tab.selected,i.appHandlers[n](a,{avoidShow:r,deferred:o}),o.done(function(){t.remove(),i.tabInfo.setSavedTabInfo(e.tab)})):(zmApp.showApp("m"),1===zmInit.lPageType()?zmList.showMailListing({fId:zmail.folId.iId}):zmList.showMailListing({fId:"zm_unread"}))},i.saveTabState=function(e,t){this.tabInfo.updateTabState(e,t),this.sendRequestToSaveState()},i.restoreTabs=function(){if(s)return!1;s=!0;var e=a&&a.state||{};if("restore"===e.type&&e.data){var t=e.data;t.tab&&1<t.tab.list.length&&i.tabInfo.setSavedTabInfo(t.tab,{avoidDefaultSelect:!0})}},i.appHandlers={},i.registerAppHandlers=function(e,t){i.appHandlers[e]=t},i.init=function(){i.tabInfo.init(),i.leftStateInfo.init();var e=zmAdHocSettings.getLPageType();"specific"!==e&&"restore"!==e||(i.getAndStoreSettingsValue(),"restore"===e&&zmAdHocSettings.setUiState({})),window.onbeforeunload=function(){"restore"===zmAdHocSettings.getLPageType()&&i.sendRequestToSaveState()},t={data:{app:{},tab:i.tabInfo.getTabInfo}},zmail.postJsDeffered.promise.then(function(){$.subscribe(r,function(){i.sendRequestToSaveState()}),$.subscribe(n,function(){setTimeout(function(){i.sendRequestToSaveState()},0)})}),i.registerAppHandlers("m",function(e,t){zmUtil.restoreLeftState(e,t)}),i.registerAppHandlers("stream",function(e,t){zmUtil.restoreLeftState(e,t)}),i.registerAppHandlers("t",function(e,t){zmUtil.requireTaskModule().done(function(){zmTaskRestore.restoreTaskSession(e,t)})}),i.registerAppHandlers("n",function(t,a){zmModules.notes.getNotesRestore().then(function(e){e.notesRestore.restore(t,a)})})},i.appsKeyMap={zm_Container:"m",zm_link:"l",zm_task:"t",zm_notes:"n",zcal_Container:"c",zm_Contacts:"cn"}}(),define([],function(e){var t=zmail.Core.Namespaces,n=e("zmAdHocSettings"),r=e("_"),o=",",i="__",a=t.get("zmState"),s=t.create("zmState.leftStateInfo"),p=a.appsKeyMap,f=Object.keys(p).sort(),u={},c=function(){var e=t.get("zmUtil.debugLog");void 0!==e&&e(u)},d=function(){var t=[];return f.forEach(function(e){var a;e=p[e],t=t.concat(r(u[a=e]).map(function(e,t){return a+i+t}))}),t.join(o)||"--"},l=function(){var e=d(),t=n.getLeftLayerState();t.collapsedState=e,n.setLeftLayerState(t)},m=function(e,t){u.hasOwnProperty(e)||(u[e]={});var a=u[e];return!a.hasOwnProperty(t)&&(a[t]=!0,c(),!0)},g={checkForPresence:function(e,t){return function(e,t){if(!p.hasOwnProperty(t))return!1;var a=p[t],n=u[a];return!!n&&n.hasOwnProperty(e)}(e,t)},getKeyFromAppId:function(e){for(var t in p)if(p.hasOwnProperty(t)&&e===p[t])return t}};return s.updateAdhocValues=l,s.getDataToStore=d,s.printData=c,s.addEntry=function(e,t){var a,n;return!!p.hasOwnProperty(e)&&(a=p[e],(n=m(a,t))&&l(),n)},s.removeEntry=function(e,t){var a;if(!p.hasOwnProperty(e))return!1;a=p[e];var n=u[a];return!(!n||!n.hasOwnProperty(t)||(delete n[t],l(),c(),0))},s.appsKeyMap=p,s.utils=r.extend({},g),s.init=function(){var e,t,a=n.getLeftLayerState().collapsedState||"--";n.getLeftLayerState().expandedState&&(delete(e=n.getLeftLayerState()).expandedState,n.setLeftLayerState(e)),"--"!==a&&a.split(o).forEach(function(e){t=e.split(i),m(t[0],t[1])})},s}),define([],function(o){var i=zmail.Core.Namespaces,e=i.get("zmState"),t=i.create("zmState.appInfo"),s=e.appsKeyMap,p={};return t.getDataToSave=function(){var e,t,a=o("zmsuite"),n=i.get("zmApp"),r={};return"object"===babelHelpers.typeof(n)&&(t=a.getCurrentAppObjId(),s.hasOwnProperty(t)&&(e=s[t]),r.selInfo={id:a.getAppLeft().selId||"",layerId:a.getAppLeft().selLayerId||""},r.data=e&&p[e]||{}),r},t.addNew=function(e,t,a){var n;return!(!s.hasOwnProperty(e)||(n=s[e],p.hasOwnProperty(n)&&!a||(p[n]=t,0)))},t}),define([],function(z){var e=zmail.Core.Namespaces,r=e.get("zmState"),n=e.create("zmState.tabInfo"),I={},o={},t={},a={m:function(e){z("zmRestore").restoreTabs(e)},stream:function(e,t){z("zmRestore").restoreTabs(e,t)},cmp:function(e,t){z("zmUtil").cmpRestore(e,t)},t:function(e){z("zmUtil").requireTaskModule("taskPreview").done(function(){z("zmTaskRestore").restoreTab(e)})},n:function(t){zmModules.notes.getNotesRestore().then(function(e){e.notesRestore.restoreTab(t)})},groups:function(e){z("zmUtil").loadGroupManagement().then(function(){z("zmStreamsApp").GroupManageApp.init({groupManage:!0,isRestore:!0})})}},c=function(){return o.list},v=function(e,t){var a,n=c();for(a=0;a<n.length;a+=1)if(n[a].appId===e)return n[a]=t,void(n[a].appId=t.appId||e);t.appId=e,n.push(t)},i=function(e,t){for(var a=0;a<t.length;a++)if(t[a].appId===e)return a;return-1},h=function(e,t){a[e.app]&&a[e.app](e,t)};return n.reorder=function(){for(var e=c(),t=[],a=0;a<zmTab.tabArr.length;a++){var n=i(zmTab.tabArr[a].appId,e);0<=n&&t.push(e[n])}o.list=t,r.sendRequestToSaveState()},n.getTabDataInfo=function(e){if(t[e])return t[e](e)},n.getTabInfo=function(){return o},n.getTabData=c,n.setSavedTabInfo=function(e){var t,a,n,r,o,i,s,p,f,u,c,d,l,m,g=z("zmsuite"),S=e.selected,b=!1;for(r=0;r<e.list.length;r+=1)S===e.list[r].appId&&(b=!0),"compose_tab"===e.list[r].category&&(l=e.list[r],m=void 0,"function"==typeof(m=z("zmUtil")).modifyComposeObj&&m.modifyComposeObj(l)),e.list[r].appObj,o=e.list[r],i=o.appObj,s=i.appId,p=void 0===s?o.appId:s,f=i.appname,u=void 0===f?"Untitled":f,c=i.appIcon,d=i.data,t={appId:p,appname:u,appIcon:c,data:void 0===d?{}:d},g.isWorkspaceAvailable(t.appId)||(g.createWorkspace(t),v(e.list[r].appId,e.list[r]),I[e.list[r].appId]=e.list[r]),b&&!a&&(a=e.list[r].appId,n=e.list[r]);S&&a&&I[a]&&(I[a]="",g.showWorkSpace(a),h(n,a))},n.syncAndInsert=function(e,t){var a,n,r=zmTab.tabArr,o=r.length,i=c(),s=-1;if(-1===(a=_.map(i,function(e){return e.appId})).indexOf(e)){for(n=0;n<o;n++)if(r[n].appId===e){s=n;break}var p,f=s-1,u=s+1;if(t.appId=e,0===s)r.splice(0,t);else if(s===length-1)r.splice(length-1,t);else for(;-1<f||u<length;){if(-1!==(p=a.indexOf(zmTab.tabArr[f].appId))){r.splice(p+1,t);break}if(-1!==(p=a.indexOf(zmTab.tabArr[u].appId))){r.splice(p-1,t);break}f--,u++}}else v(e,t)},n.updateTabState=v,n.callIfStillPending=function(e){if(I[e]){var t=I[e];return I[e]="",h(t),!0}return!1},n.init=function(){o={list:[]},$.subscribe("/apps/tabSwitching",function(e,t,a){t!==a&&n.callIfStillPending(a)}),$.subscribe("mailsuite/appClosed",function(e,t){!function(e){var t,a=c();for(t=0;t<a.length;t+=1)if(a[t].appId===e)return Array.prototype.splice.call(a,t,1)}(t.appID),r.sendRequestToSaveState()})},n});
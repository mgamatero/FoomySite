var ZAppUtil=function(e){var t;function n(){}function i(e){this.name="AuthenticationError",this.message=e,this.stack=(new Error).stack}return n.prototype.Info=function(){(e.isDevMode()||e.isLogEnabled())&&console.info.apply(console,arguments)},n.prototype.Error=function(){console.log.apply(console,arguments),console.error(new Error)},(i.prototype=Object.create(Error.prototype)).constructor=i,e.getPatchedString=function(e,t){var n={};if(!e||"string"!=typeof e)throw new Error("Invalid String");return Array.isArray(t)?t.forEach(function(e){n[e.name]=e.value}):n=t,e.replace(/\$\{\w{1,}\}/g,function(e){var t=e.replace(/[${}]/g,"");return n[t]})},e.getURLOrigin=function(e){var t=e||document.location.href,n=document.createElement("a");return n.setAttribute("href",t),n.protocol+"//"+n.host},e.getQueryParams=function(e){var n={},t=e||window.location.href,i=document.createElement("a");i.setAttribute("href",t);var r="string"==typeof i.search?i.search.substr(1):t.substr(t.indexOf("?")+1);return(1<r.length?r.split("&"):[]).forEach(function(e){var t=e.split("=");n[t[0]]=t[1]}),n},e.isURL=function(e){return-1!==e.indexOf("http")},e.isDevMode=function(){return localStorage&&!!localStorage.getItem("isDevMode")},e.isLogEnabled=function(){return localStorage&&!!localStorage.getItem("isLogEnabled")},e.getLogger=function(){return t&&t instanceof n||(t=new n),t},e.constructQueryParamsString=function(e){var t=[];for(var n in e)n&&e[n]&&t.push(n+"="+e[n]);return t.join("&")},e.AuthenticationError=i,e}(window.ZAppUtil||{});function ZWidgetRuntime(e){this.__WIDGET__=e,this._hasLoaded=!1,this._isActive=!1,this._bindedEvents={},this._hasRegistered=!1,this._origin,this._type}ZWidgetRuntime.prototype.getWidgetInfo=function(){return{url:this.getURL(),location:this.getLocation(),widgetID:this.getUniqueID(),name:this.getProp("name")}},ZWidgetRuntime.prototype.hasLoaded=function(){return!!this._hasLoaded},ZWidgetRuntime.prototype.isActive=function(){return this._isActive},ZWidgetRuntime.prototype.getOrigin=function(){return this._origin},ZWidgetRuntime.prototype.activate=function(e){return this._isActive=!0,this._isActive},ZWidgetRuntime.prototype.deActivate=function(e){return this._isActive=!1,this._isActive},ZWidgetRuntime.prototype.getConfig=function(){return this.__WIDGET__&&this.__WIDGET__.config},ZWidgetRuntime.prototype.getURL=function(){return this.__WIDGET__.url},ZWidgetRuntime.prototype.getLocation=function(){return this.__WIDGET__.location},ZWidgetRuntime.prototype.getExtensionID=function(){return this.__WIDGET__&&this.__WIDGET__.extension_id},ZWidgetRuntime.prototype.getExtensionVersion=function(){return this.__WIDGET__&&this.__WIDGET__.extension_version},ZWidgetRuntime.prototype.getZAppID=function(){return this.__WIDGET__&&this.__WIDGET__.zappid},ZWidgetRuntime.prototype.getResolvedURL=function(){return this._resolvedURL},ZWidgetRuntime.prototype.getUniqueID=function(){return this._uniqueID},ZWidgetRuntime.prototype.getProp=function(e){return this.__WIDGET__&&this.__WIDGET__[e]},ZWidgetRuntime.prototype.getIFrame=function(){return document.getElementById(this._uniqueID)},ZWidgetRuntime.prototype.getWindow=function(){var e=document.getElementById(this._uniqueID);return e&&e.contentWindow},ZWidgetRuntime.prototype.SendEvent=function(e,t,n){var i,r={type:"__EVENT__",data:t,uniqueID:this.getUniqueID(),widgetID:this.getUniqueID(),eventName:e,isPromise:n},o=this._bindedEvents[e],a=[];if(void 0!==o)for(var s in o)o.hasOwnProperty(s)&&(i=ZApp.GetWidgetInstance(s))&&i.isActive()&&(n?a.push(MessageManager.SendMessage(i,r)):MessageManager.SendMessage(i,r));if(n)return a},ZWidgetRuntime.prototype.addEventInfo=function(){},ZWidgetRuntime.prototype.removeEventInfo=function(){},ZWidgetRuntime.prototype.getEvents=function(){return Object.keys(this._bindedEvents)};var MessageManager=function(n){var m,I=ZAppUtil.getLogger(),s=100,h={};function y(e,t){var n,i=t.isPromise;i&&(n="Promise"+s++,t.promiseID=n);var r,o=A(e.getResolvedURL()),a=e.getWindow();{if(a&&o)return t.__time__=(new Date).getTime(),a.postMessage(t,o),i?(r=n,new Promise(function(e,t){h[r]={resolve:e,reject:t,time:(new Date).getTime()}})):void 0;I.Error("Invalid IFrame object. Can't send Message to Widget")}}function o(e,t){e||I.Info("Invalid WidgetInstance passed"),e._hasLoaded=!0,e.activate(),y(e,t),"__MODAL__"===e.getLocation()&&setTimeout(function(){e.SendEvent("modal.opened")},0),"function"==typeof e.getProp("onload")&&setTimeout(e.getProp("onload").bind(null,[e.getConfig()]),e.AppOnLoadDelay||0)}function D(e,t){var n=t.uniqueID,i=ZApp.GetWidgetInstance(n),r={extension_id:i.getExtensionID(),extension_version:i.getExtensionVersion()};for(var o in t.options)t.options.hasOwnProperty(o)&&(r[o]=t.options[o]);var a={type:"__EVENT_RESPONSE__",eventName:"__INVOKE_MODAL__",promiseID:t.promiseID,time:(new Date).getTime()};try{var s=new ZWidgetRuntime(r);m.RenderWidget(r.location,s),a.isSuccess=!0,a.data=s.getWidgetInfo()}catch(e){a.isSuccess=!1,a.data=e.message}y(i,a)}function R(e,t){var n=t.uniqueID,i=ZApp.GetWidgetInstance(n),r=i.getExtensionID(),o=[],a={type:"__EVENT_RESPONSE__",eventName:"__WIDGETS_INFO__",promiseID:t.promiseID,time:(new Date).getTime()};try{var s=ZApp.GetAllWidgetInstance();for(var c in s)if(s.hasOwnProperty(c)){var u=s[c];u&&u.getUniqueID()!==n&&u.getExtensionID()===r&&u.isActive()&&o.push(u.getWidgetInfo())}a.isSuccess=!0,a.data=o}catch(e){I.Error(e.message),a.isSuccess=!1}y(i,a)}function w(e,t,n,i,r){y(e,{type:"__EVENT_RESPONSE__",eventName:"eventName",promiseID:t,time:(new Date).getTime(),data:r,isSuccess:i})}function W(e,t){var n=t.options,i=t.promiseID,r=t.uniqueID,o={resolve:a.bind(null,r,e.origin,i,!0),reject:a.bind(null,r,e.origin,i,!1)};m.ProcessGetRequest(i,r,n,o)}function a(e,t,n,i,r){var o=ZApp.GetWidgetInstance(e).getWindow(),a={type:"__EVENT_RESPONSE__",eventName:"__HTTP__",data:r,time:(new Date).getTime(),promiseID:n,isSuccess:i};setTimeout(function(){o.postMessage(a,t)},0)}function A(e){var t=document.createElement("a");return t.setAttribute("href",e),t.protocol+"//"+t.host+t.pathname}return n.Init=function(e,t){if(!e||"object"!=typeof e)throw Error("Invalid Context object passed");if(t&&"object"!=typeof t)throw Error("Invalid Configuration Passed to MessageHandler");return m=e,function(t){var n;try{n="string"==typeof t.data?JSON.parse(t.data):t.data}catch(e){n=t.data}var e,i,r,o,a,s,c,u,d,p,g,f,l,v,_,E=n.type;try{if(-1!==["__REGISTER__","__DEREGISTER__"].indexOf(E)||function(e,t){var n=m.GetWidgetInstance(t.uniqueID),i=n&&n.getWindow();if("string"!=typeof t.uniqueID&&!i)throw new ZAppUtil.AuthenticationError("Message from Invalid window from received");var r=A(n.getResolvedURL()),o=n.getUniqueID(),a=e.source,s=t.uniqueID,c=A(decodeURIComponent(t.widgetOrigin));if(i===a&&r===c&&o===s)return!0;throw new Error("Message from UnAuthorized Source")}(t,n))switch(E){case"__REGISTER__":!function(e,t){var n=e.source,i=e.origin,r=t.uniqueID,o=m.GetWidgetInstance(r);if(!o||o&&n!==o.getWindow())return I.Error("Message from Invalid IFrame arrived.");o._origin=i,o._isActive=!0,o._hasRegistered=!0}(t,n);break;case"__DEREGISTER__":_=n,m.DeleteWidgetInstance(_.uniqueID);break;case"__EVENT_BIND__":i=(e=n).uniqueID,r=e.widgetID,o=e.eventName,(a=ZApp.GetWidgetInstance(r))&&!a._bindedEvents[o]&&(a._bindedEvents[o]={}),a._bindedEvents[o][i]=e.count;break;case"__EMIT__":p=(d=n).widgetID,g=d.eventName,f={widgetID:p,data:d.data,eventName:g,type:"__EMIT__"},l=ZApp.GetWidgetInstance(p),v=l._bindedEvents[g]&&Object.keys(l._bindedEvents[g]),Array.isArray(v)&&v.forEach(function(e){var t=ZApp.GetWidgetInstance(e);t&&t.isActive()&&y(t,f)});break;case"__EVENT_RESPONSE__":c=(s=n).promiseID,u=s.data,h.hasOwnProperty(c)&&(h[c].resolve(u),h[c]=void 0,delete h[c]);break;default:!function(e,t){var n={__HTTP__:W,__WIDGETS_INFO__:R,__CREATE_INSTANCE__:D}[t.eventName];if(n)return n(e,t);!function(e,t){var n=t.eventName,i=t.promiseID,r=t.data,o=t.uniqueID,a=m.GetWidgetInstance(o),s=a.getConfig(),c=a.getExtensionID();I.Info("Event from SDK => Eventname : ",n,", Time : ",t.time,", Eventpayload : ",r);var u={data:r,config:s,iframe:a.getIFrame()};if(i){var d={resolve:w.bind(null,a,i,n,!0),reject:w.bind(null,a,i,n,!1)};u.promise=d}void 0!==c&&(u.extension_id=c,u.widgetID=o),m.TriggerEventListeners(n,u)}(0,t)}(t,n)}}catch(e){e instanceof ZAppUtil.AuthenticationError||I.Error("[MessageHandler] => ",e.stack)}}.bind(n)},n.SendMessage=y,n.BroadcastEvent=function(e,t,n){var i,r=m.GetAllWidgetInstance(),o=[];for(var a in r)if(r.hasOwnProperty(a)&&(i=r[a])&&i.isActive()){var s=i.SendEvent(e,t,n);if(n&&s)for(var c=0;c<s.length;c++)o.push(s[c])}return n?o:Promise.resolve()},n.WidgetLoadHandler=function(t){var e=t.getIFrame()&&t.getIFrame().getAttribute("data-location"),n=m.GetMeta(e),i=t.getExtensionID(),r={type:"__REGISTER__",uniqueID:t.getUniqueID(),data:{meta:n,uniqueID:t.getUniqueID(),extensionID:i,location:t.getLocation()}};m.FetchLocaleResource(i).then(function(e){void 0!==e&&(r.data.locale=e.locale,r.data.localeResource=e.content),o(t,r)}).catch(function(e){I.Info("Error occured while fetching I18NResource ",e),o(t,r)})},n}(window.MessageManager||{}),DefaultRenderHandlers=function(e){return e.WidgetHandler=function(e){var t,n=e.location,i=e.resolvedURL;return n&&"string"==typeof n&&(n=t=document.getElementById(n)),n instanceof HTMLIFrameElement&&(t=n).setAttribute("src",i),t},e}(window.DefaultRenderHandlers||{}),ZApp=function(c){var u=ZAppUtil.getLogger();try{var s=15e3,e=window.location.origin.split(".").pop().toLowerCase();"cn"===e?e="com.cn":"au"===e&&(e="com.au");var d,p,g,f,l,v=!1,_=!1,o={},E={devHost:{host:"127.0.0.1",port:"5000",path:""},zappsHost:{host:"{{zappid}}.zappsusercontent."+e,port:"",path:"/appfiles/{{zappid}}/{{version}}/{{hashkey}}"}},a={},m=[],I={},r=[],t={},h={};function y(e){return t[e]}function D(e){return I[e]}function R(){return I}function w(e){return a[e]}function W(e,t){var n=document.getElementById(e);t?(I[e]=void 0,delete I[e],n&&n.parentElement.removeChild(n)):n||(I[e]=void 0,delete I[e])}function A(e,t){try{var n=(a=(new Date).getTime(),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"===e?t:3&t|8).toString(16)}));t._uniqueID=n,t._resolvedURL=function(e){var t,n=e.getURL(),i=ZAppUtil.getURLOrigin(),r={serviceOrigin:encodeURIComponent(i),isDevMode:x(),isLogEnabled:ZAppUtil.isLogEnabled()},o=ZAppUtil.constructQueryParamsString(r),a=x()?E.devHost.frameOrigin:E.zappsHost.frameOrigin;null!=a&&(o=o+"&"+a);if(ZAppUtil.isURL(n))t=n;else{var s=e.getExtensionID(),c=T(s);t=c+n}var u=t.indexOf("?");if(-1===u){var d=t.indexOf("#");-1===d?t+="?"+o:t=t.slice(0,d)+"?"+o+t.slice(d)}else u+=1,t=t.slice(0,u)+o+"&"+t.slice(u);return t}(t),L(d,t);var i=f.WidgetHandler(e,t);if(i instanceof HTMLIFrameElement){i.setAttribute("data-location",e),i.setAttribute("id",n),I[n]=t;var r=document.getElementById(n);null!==r&&r.addEventListener("DOMNodeRemovedFromDocument",function(){I[n]=void 0,delete I[n]}),i.onload=MessageManager.WidgetLoadHandler.bind(null,t),o=n,setTimeout(function(){var e=I[o];e&&e._hasLoaded&&!e._hasRegistered&&(I[o]=void 0,delete I[o])},s),L(p,t)}else u.Info("[windowRef] is not an IFrameElement."+e+" , "+t.getURL())}catch(e){throw e}var o,a;return t}function x(){return _}function L(e,t){if(e&&"function"==typeof e)return e(t)}function n(e,t){var n={};if(!e||"string"!=typeof e)throw new Error("Invalid String");return Array.isArray(t)?t.forEach(function(e){n[e.name]=e.value}):n=t,e.replace(/\{\{\w{1,}\}\}/g,function(e){var t=e.replace(/[{{}}]/g,"");return n[t]})}function T(e){return function(e){e.zappid&&-1<e.zappid.indexOf("-")?E.zappsHost.path="/appfiles/v2/{{zappid}}/{{version}}/{{hashkey}}":E.zappsHost.path="/appfiles/{{zappid}}/{{version}}/{{hashkey}}";var t=E.zappsHost;return x()&&(t=E.devHost),(t.protocol?t.protocol:window.location.protocol)+"//"+n(t.host,e)+(t.port?":"+t.port:"")+(t.path&&n(t.path,e))}("string"==typeof e?w(e):e)}var G={};function Z(e){return o[e]}function M(e,t){return e.filter(function(e){return!(e.extension_id===t)})}function O(e,t,n,i){try{if(u.Info("ProcessGetRequest : PromiseID: ",e,", Options: ",n),n.contentType=n&&n.contentType?n.contentType:"application/text",n.dataType=n&&n.dataType?n.dataType:"text",n.widgetID=t,"function"!=typeof l)throw new Error("Provide Request handler implementation in the Bootstrap.");l(n,i)}catch(e){u.Error("ProcessGetRequest : Error => ",e)}}function S(e,t){var n=G[e];if(Array.isArray(n))for(var i=0;i<n.length;i++)n[i](t)}function b(o){return new Promise(function(t,n){var e=a[o];if(e&&void 0===e.locale)n();else if(e&&void 0!==e.localeResource)t({locale:e.locale,content:e.localeResource});else{var i=e.locale,r=T(o)+"/app/translations/"+i+".json";P(r,i).then(function(e){t(e)}).catch(function(){i!==g?P(r=T(o)+"/app/translations/"+g+".json",g).then(function(e){t(e)}).catch(function(e){n(e)}):n()})}})}function P(e,r){return new Promise(function(t,n){try{var i=new XMLHttpRequest;i.onreadystatechange=function(){if(i.readyState===XMLHttpRequest.DONE&&200===i.status){var e;try{e=JSON.parse(i.responseText)}catch(e){n(e)}t({locale:r,content:e})}else i.readyState===XMLHttpRequest.DONE&&n(i.status)},i.open("GET",e),i.send()}catch(e){n()}})}return c.Bootstrap=function(s){return new Promise(function(e,t){var n,i,r;try{if(!s||"object"!=typeof s)throw new Error("Invalid configurations passed to Bootstrap.");for(var o in f=s.RenderHandlers||DefaultRenderHandlers,l=s.RequestHandler,d=s.preRenderApp,p=s.postRenderApp,_=Boolean(s.isDevMode),s.serverConfig)E.hasOwnProperty(o)&&(E[o]=s.serverConfig[o]);g=s.defaultLocale||"en",h.defaultLocale=g,h.ProcessGetRequest=O,h.Logger=u,h.GetWidgetInstance=D,h.GetAllWidgetInstance=R,h.GetExtensionInstance=w,h.DeleteWidgetInstance=W,h.GetWidgetRegisterCallback=y,h.GetMeta=Z,h.TriggerEventListeners=S,h.FetchLocaleResource=b,h.RenderWidget=A;var a=s.EventListeners||{};for(o in a)a.hasOwnProperty(o)&&(r=a[i=o],G.hasOwnProperty(i)||(G[i]=[]),G[i].push(r));n=MessageManager.Init(h),window.addEventListener("message",n),v=!0,u.Info("Running in Dev Mode : ",x()),e(c)}catch(e){t(e.message)}})},c.isInitialized=function(){return v},c.LoadExtension=function(e){return ZApp.isInitialized()||u.Error("Bootstrap not yet initialized."),function(e){try{var t="string"==typeof e?JSON.parse(e):e;if("object"!=typeof t)return void u.Error("Invalid extension config passed");var n=t.modules;void 0===n&&u.Error("Invalid modules properties"),function(e,t){if(Array.isArray(t))for(var n=0,i=t.length;n<i;n++)t[n].extension_id=e.id,t[n].extension_version=e.version,m.push(t[n])}(t,n.widgets),function(e,t){if(Array.isArray(t)){for(var n=0,i=t.length;n<i;n++)t[n].extension_id=e.id,t[n].extension_version=e.version;r=r.concat(t)}}(t,t.connectors),t.config=(i=t.config,x()?i:Array.isArray(i)?i.filter(function(e){return!Boolean(e.secure)}):void 0),t.modules.widgets=void 0,t.connectors=void 0,t.modules=void 0,delete t.modules,delete t.connectors,a[t.id]=t}catch(e){u.Error("Error in Loading App Data ",e)}var i}(e)},c.LoadWidget=function(e){if(ZApp.isInitialized()){u.Info("Load App : [ "+e.url+","+e.location+"]"),e.ondemand||m.push(e),o[e.location]=e.meta;var t=new ZWidgetRuntime(e);return A(e.location,t)}u.Error("Bootstrap not yet initialized.")},c.GetMeta=Z,c.RenderWidgets=function(e,t){u.Info("Render Apps with LocationID => ",e),o[e]=t;for(var n=0;n<m.length;n++){var i=m[n];try{var r=i.location;if(Array.isArray(r)&&-1===r.indexOf(e)||r!==e)continue;A(e,new ZWidgetRuntime(i))}catch(e){u.Error("Exception while Rendering Widget ==> ",e)}}},c.GetWidgetInstance=D,c.GetWidgetsByEvent=function(e){var t=R(),n=[];for(var i in t)t.hasOwnProperty(i)&&void 0!==t[i]._bindedEvents[e]&&n.push(i);return n},c.GetAllWidgetInstance=R,c.DeleteWidgetInstance=W,c.GetExtensionInstance=w,c.GetExtensionConfig=function(e){var t=w(e);return t&&t.config},c.GetConnectors=function(t){return r.filter(function(e){return e.extension_id&&e.extension_id===t})},c.isDevMode=x,c.toggleDevMode=function(){_=!_},c.changeDevHost=function(e){e&&(E.devHost=e)},c.BroadcastEvent=function(e,t,n){return MessageManager.BroadcastEvent(e,t,n)},c.DeleteAllExtensions=function(){var e=R();for(var t in e)if(e.hasOwnProperty(t)){var n=document.getElementById(t);n&&n.parentNode&&n.parentNode.removeChild(n)}a={},m=[],I={},r=[]},c.DeleteExtension=function(e){var t=R();for(var n in t)if(t.hasOwnProperty(n)&&t[n].getExtensionID()===e){var i=document.getElementById(n);i.parentNode.removeChild(i),I[n]=void 0,delete I[n]}m=M(m,e),r=M(r,e),a[e]=void 0,delete a[e]},c.getLogger=ZAppUtil.getLogger,c.GetExtensionBaseURL=T,c}catch(e){u.Error("Error Occured ",e.message)}}(window.ZApp||{});
"use strict";!function(){var w,V,q,G,r={},d=zmail.Core.Namespaces.create("zmAttach"),B=zmText.get("attachmentUtil"),R={},l="msi-atteml",m="msi-attdoc",T="msi-attpdf",s="msi-atthtml",o="msi-attimg",c=function(t){var e=zmUtil.getMailObj(t,"FD");return e&&zmUtil.isSharedFolder(e)},A=function(){return zmail.Utils.FeatureUtil.isAppAvailable("notes")},I=function(){return zmail.Utils.FeatureUtil.isAppAvailable("task")},X=function(e){if(!e.selInfo.iList.length||e.selInfo.iList.length===e.attList.length)return e.attList;var a=[];return e.selInfo.iList.forEach(function(t){a.push(e.attList[t])}),a},Z=function(t){var e;if(e=function(t){try{var e=zmUtil.getMailObj(t,"SB");return e&&zmUtil.replaceHtmlInSubject(e)}catch(t){return!1}}(t))return e=(e=e.substring(0,75)).replace(/\s/g,"_")},u={openLinkedMail:{text:B.attachmentmenu.linkedMail,elem:function(){return zdom("span",{"data-msg":"linkedMail"},B.attachmentmenu.linkedMail)}},addEvent:{text:B.attachmentmenu.addevent,elem:function(t){return"addEvent"===t?zdom("span",{"data-msg":"addEvent"},B.attachmentmenu.addevent):zdom("span",{"data-msg":"importToCal"},B.attachmentmenu.importToCalendar)}},download:{text:B.attachmentmenu.download,elem:function(){return zdom("span",{"data-msg":"download"},B.attachmentmenu.download)}},view:{elem:function(){return zdom("span",{"data-msg":"view"},B.attachmentmenu.view)},text:B.attachmentmenu.view},delete:{elem:function(){return zdom("span",{"data-msg":"delete"},B.attachmentmenu.delete)},text:B.attachmentmenu.delete},cloud:{elem:function(){return zdom("span",{"data-msg":"addtocloud"},B.attachmentmenu.addtocloud)},workDriveElem:function(){return zdom("span",{"data-msg":"addtoTeamDrive"},B.attachmentmenu.addToTeamDrive)},subMenuElem:function(){return zdom("fragment",null,B.attachmentmenu.addtocloud,zdom("i",{className:"msi-rarrow"}))},text:B.attachmentmenu.addtocloud,otheCloudTxt:B.attachmentmenu.addToOtherCloud},newMail:{elem:function(){return zdom("span",{"data-msg":"newMail"},B.attachmentmenu.attachInMail)},text:B.attachmentmenu.attachInMail},noteAtt:{elem:function(){return zdom("span",{"data-msg":"newPost"},B.attachmentmenu.attachToNotes)},text:B.attachmentmenu.attachToNotes},taskAtt:{elem:function(){return zdom("span",{"data-msg":"newPost"},B.attachmentmenu.attachToTask)},text:B.attachmentmenu.attachToTask},tag:{icon:function(){return zdom("span",{className:"SC_ldot zm_lbl"},zdom("i",{className:"msi-label",title:B.attachmentmenu.addTag,"data-msg":"addTag"}))}},saveAsHtml:{elem:function(){return zdom("span",{"data-msg":"saveAsHtml"},zmText.applyArgs(B.attachmentmenu.save,{format:"HTML"}))},text:zmText.applyArgs(B.attachmentmenu.save,{format:"HTML"})},selectIcon:{elem:function(){return zdom("i",{className:"msi-tick",title:"Select","data-msg":"select"})}},dragTemplate:{elem:function(){return zdom("div",{className:"zm_dragger"},zdom("div",{className:"zm_dragCount dragtheme"}),zdom("div",{className:"zm_dragTxt"}))}}};_zm.isStreamsEnabled()&&(u.newPost={elem:function(){return zdom("span",{"data-msg":"newPost"},B.attachmentmenu.attachInPost)},text:B.attachmentmenu.attachInPost});var C=[{getElem:function(t){return u.download.elem()}},{action:"view",getElem:function(t){var e=t.fileExtn,a=t.filename;if(!(w.isEmlView&&e===l||e!==m&&e!==l&&"msi-attppt"!==e&&e!==s&&"msi-attsheet"!==e&&e!==T&&e!==o&&"msi-attaudio"!==e&&("msi-attothers"!==e||-1===a.indexOf(".txt")&&-1===a.indexOf(".htm")&&-1===a.indexOf(".xml"))))return"more"===t.from?u.view.text:u.view.elem()}},{action:"addEvent",getElem:function(t){var e=t.filename,a=t.entityType,n=t.entityId;if(-1!==e.indexOf(".ics")&&zmail.Utils.FeatureUtil.isAppAvailable("calendar")){var i="";if(1===a){var l=zmContentCache.get(n);if(!_.isEmpty(l)){var m=l.CALOBJ;m?!1===m.isAdded&&(i="addEvent"):i="importToCal"}}else i="importToCal";return i&&u.addEvent.elem(i)}}},{action:"delete",getElem:function(t){if("task"===V.appName&&w.delete)return"more"===t.from?u.delete.text:u.delete.elem()}},{action:"linkedMail",getElem:function(t){if(V&&"ML_popup"===V.appName&&V.entityInfo.isThd)return"more"===t.from?u.openLinkedMail.text:u.openLinkedMail.elem()}},{action:"addtoTeamDrive",getElem:function(t){if(!w.isEmlView&&zmUtil.isAddToCloudAllowed()){if("more"!==t.from)return _zm.isTeamDriveEnabled()?u.cloud.workDriveElem():void 0;if(!_zm.isTeamDriveEnabled())return;return{htm:u.cloud.subMenuElem(),child:function(){return n=t.attData,{list:[{htm:B.attachmentmenu.addToTeamDrive,data:{action:"addtoTeamDrive"}},{htm:B.attachmentmenu.otherCloud,data:{action:"addtocloud"}}],clk:function(t,e,a){zmUtil.hideMenu(),t.attData=n,G(e,t)},divId:"addToCloudOpts"};var n},align:"cleft"}}}},{action:"addtocloud",getElem:function(t){if(!w.isEmlView&&zmUtil.isAddToCloudAllowed()){var e;if("more"!==t.from)return u.cloud.elem();if(_zm.isTeamDriveEnabled())"6"===t.processIndex&&(e=u.cloud.otheCloudTxt);else e=u.cloud.text;return e}}}].concat(babelHelpers.toConsumableArray(_zm.isStreamsEnabled()?[{action:"newPost",getElem:function(t){if(!zmUtil.isChildWindow()&&!w.isEmlView)return"more"===t.from?u.newPost.text:u.newPost.elem()}}]:[]),[{action:"newMail",getElem:function(t){if(!zmUtil.isChildWindow()&&!w.isEmlView)return"more"===t.from?u.newMail.text:u.newMail.elem()}}],babelHelpers.toConsumableArray(A()?[{action:"noteAtt",getElem:function(t){if(!zmUtil.isChildWindow()&&!w.isEmlView&&zmail.Utils.FeatureUtil.isAppAvailable("notes"))return"more"===t.from?u.noteAtt.text:u.noteAtt.elem()}}]:[]),babelHelpers.toConsumableArray(I()?[{action:"taskAtt",getElem:function(t){if(!zmUtil.isChildWindow()&&!w.isEmlView&&zmail.Utils.FeatureUtil.isAppAvailable("task"))return"more"===t.from?u.taskAtt.text:u.taskAtt.elem()}}]:[]),[{action:"saveAsHtml",getElem:function(t){var e=zmUtil.fileTyp(w.fn)[2];if(!w.isEmlView&&!_zm.isSecureDownloadEnabled()&&("eml"===e||"msg"===e)&&zmComponent.downloadAsFile.isSupported())return"more"===t.from?u.saveAsHtml.text:u.saveAsHtml.elem()}}]);R.save=function(t,e,a){t&&a&&zmComponent.downloadAsFile.download(t.outerHTML,{contentType:"text",fileType:"html",fileName:a})},R.removeMAct=function(){Object.getOwnPropertyNames(r).forEach(function(t){r[t].remove(),delete r[t]}),$.publish("hugeAtt/dropRemove"),$.publish("cloudAtt/dropRemove")},R.getEMLContent=function(t,e){var a={attachId:t.Id,entityType:t.et,entityId:t.e};1!==t.et||void 0!==t.gId&&t.gId!==zmail.zuid||(a.partId=t.p,void 0===t.sid&&(a.accId=zmail.accId)),t.sid?(a.groupId=t.sid,t.gId===zmail.zuid?a.actionType="viewSelfData":a.actionType="viewGroupEntity",a.streamsView=!0):t.type?(a.groupId=t.gId,a.actionType=t.type,a.streamsView=!0):t.gId&&t.gId!==zmail.zuid&&(a.groupId=t.gId,a.actionType="viewGroupData",a.streamsView=!0),t.shId?a.shId=t.shId:c(t.e)&&(a.shId=zmUtil.getShareId(zmUtil.getMailObj(t.e,"FD"))),zmAjq.XHR({u:zmail.conPath+"/FileDownload?mode=mailview",t:"GET",fn:e,p:a,ep:{msgId:t.Id+t.e}})},R.constMailFromEml=function(t,i){var l,m=t.Id+t.e,s=function(t,e){var a,n=zmPreviewTemplate.getTemplate("content",{data:e,prms:{opentype:2,type:"plainContent"}}),i=$.e(zdom("div",null,$.dangerouslyParseHTML(n)));return zmPreviewTemplate.showImageDisplayElem(e.msgId,i,{prefix:"T"}),zmPreviewTemplate.showProfilePhoto({msgId:e.msgId,type:"lt"},i),e.NEWATT&&e.NEWATT.length&&(a=d.build({appName:"mail",attList:e.NEWATT,zipType:"",showMOpt:!1,showTag:!1,supportDrag:!0,attClass:"zmAch",attListClass:"zmPAtt",fileNameLen:23,entityInfo:{id:t}})),a&&$.e(a).insertDOMAfter(i.find(".zmPCnt")),i};zmUtil.getMailObj(m)&&zmContentCache.isCached(m)?setTimeout(function(){l=zmContentCache.get(m),i(s(m,l))},100):R.getEMLContent(t,function(t,e){var a;(l=t.mdata).RDT=l.DATE,delete l.DATE,l.NEWATT&&l.NEWATT.length&&(l.NEWATT.forEach(function(t){t.parentEId=e.msgId,t.isEmlView=!0}),a=1);var n=e.msgId;zmUtil.addMailData({M:m,FD:"",T:"",TAG:"",NFG:"",SM:"",SB:"",TH:0,AT:a},m),l.msgId=n,zmUtil.prevCache(m,t),i(s(n,l))})};var J=function(t,a){R.removeMAct();var e=[].concat(babelHelpers.toConsumableArray(_zm.isStreamsEnabled()?[{data:{action:"attachInStreams"},txt:B.attachmentmenu.attachAllToPost}]:[]),[{data:{action:"attachInMail"},txt:B.attachmentmenu.attachAllToMail}]);A()&&e.push({data:{action:"attachInNote"},txt:B.attachmentmenu.attachAllToNotes}),I()&&e.push({data:{action:"attachInTask"},txt:B.attachmentmenu.attachAllToTask});var n={divId:"moreoptions",par:t=t.hasClass("msi-rarrow")?t:t.find(".msi-rarrow"),list:e,direction:"left",onHide:function(){t.removeClass("SC_ddn")},showArrow:!0,clk:function(t,e){zmUtil.hideMenu(),function(t,e,a){var n=t.action;if(r.attachall.remove(),delete r.attachall,a)switch(n){case"attachInStreams":zmUtil.loadNewPostDialog("",a);break;case"attachInMail":zmUtil.openComposeWithAtt(a),zmUtil.publishCloseNotif();break;case"attachInNote":zmUtil.loadNotes("popup",{attEntObj:a});break;case"attachInTask":zmUtil.loadTask({action:"addCTask",tasks:{attEntObj:a}})}}(t,0,X(a))}};r.attachall=zmsuite.showMenu(n)},K=function(s,o){if(!zmUtil.isNettyDownloadEnabled()||s.isEmlView||-1===["dwn","tmpdwn","downloadall","downloadconv"].indexOf(o))zmUtil.secureDownloader().then(function(t){var e,a="",n={},i=zmUtil.getMailObj(s.e||s.id),l=t.password;if(i&&zmUtil.isSharedFolder(i.FD)&&(e=zmUtil.getShareId(i.FD)),"dwn"===o)n={accId:zmail.accId,attachId:s.Id,entityType:s.et,entityId:s.e,partId:s.p},s.isEmlView&&(n.internalAttachId=s.IId||s.Id,o="mvAttachDwn"),a+=zmail.conPath+"/FileDownload?mode="+o,101===s.ft&&(n.isImg=!0);else if("downloadall"===o||"downloadconv"===o){a+=zmail.conPath+"/FileDownload?mode="+o,n={accId:zmail.accId,entityId:s.e||s.id,entityType:s.et||1,mode:o};var m=Z(s.e||s.id);m&&(n.fName=m)}else"tmpdwn"===o&&(a+=zmail.conPath+"/FileDownload?mode=tmpdwn",n={accId:zmail.accId,fpath:s.fP,fstorename:s.sN,entityType:s.et});l&&"mvAttachDwn"!==o&&(n.pswd=l),a.length&&(e&&(n.shId=e),i?i.streams&&(delete n.accId,n.streamsView=!0,n.groupId=i.groupId,n.actionType="viewGroupEntity"):"streams"===V.appName?("1"===s.et&&delete n.accId,n.streamsView="2"!==s.et||"Notes",n.groupId=s.groupId,n.actionType=s.actionType,n.fName="Attachments"):"task"===V.appName&&(n.fName="Attachments")),zmAjq.formSubmit(n,a,"")},function(){});else{var t;switch(o){case"dwn":t="download";break;case"tmpdwn":t="tempDownload";break;case"downloadconv":t="downloadAsZip",V.threadedAtt=!0;break;case"downloadall":t="downloadAsZip"}zmAppLoader.load("download").then(function(){zmDownload.downloadApp({mode:t},s,V)})}},p=function(t,e,a,n){var i,l;!zmUtil.isChildWindow()||"eml"!==a&&"msg"!==a?("view"===e?i="OpenDocument":"web"===e&&(i="FileDownload"),(l=zmUtil.getTheSrc(i,t)).length&&window.open(l)):$.e(n).find(".zmImg").trigger("click")},h=function(d,t,e){var a,r,n,c=_zm.escapeTags(d.fn),i="zm_viewatt_"+d.Id+d.e,u="",l=zmUtil.fileTyp(d.fn);if(d.isEmlView&&(i+=i+d.IId),zmsuite.isWorkspaceAvailable(i)&&"restore"!==d.src)r=zmsuite.getCenter(i),zmsuite.showWorkSpace(i);else{e=e||l[1],zmUtil.publishCloseNotif();var m={appname:c,appId:i,faqKey:"attach",data:{CNodes:"3"},appIcon:e};if("Windows"===_zm.getOSType()&&_zm.is_opera&&e===T){var s=function(t){if(zmTab.currentTab===i){var e=zmsuite.getCenter(i)[0].$el.find("iframe")[0];e&&(e.height="99.9%",setTimeout(function(){e.height="100%"},0))}};$.subscribe("/apps/tabSwitched",s),m.onDelete=function(){return $.unsubscribe("/apps/tabSwitched",s),!0}}var o=$.extend({},m),p=[];"restore"!==d.src&&zmsuite.setWorkSpace(m);var h,f=(r=zmsuite.getCenter(i))[0].getNodes(),z="eml"===l[2]||"msg"===l[2];if(h=z&&!_zm.isSecureDownloadEnabled()&&zmComponent&&zmComponent.downloadAsFile.isSupported()?"eml"===l[2]?"eml-down":"msg-down":"download",d.isEmlView||(_zm.isTeamDriveEnabled()&&p.push({iconList:["msi-workDrive"],data:"workDrive",tooltip:B.attachmentmenu.addToTeamDrive}),p.push({iconList:["msi-addcloud"],data:"addcloud",tooltip:B.attachmentmenu.addtocloud},{iconList:["msi-download"],data:h,tooltip:B.attachmentmenu.download})),z||"FileDownload"===zmUtil.isPreviewAvailable(d.fn).apiName)zmUtil.fileTyp(d.fn)[1]!==T&&p.push({iconList:["msi-print"],data:z?"printEML":"print",tooltip:B.attachmentmenu.print});d.isEmlView||p.push({iconList:["msi-action"],data:"more",tooltip:B.attachmentmenu.moreact});var g={list:{left:[],right:[{actionArr:p}]},clk:function(t,e,a){if("download"===a)zmUtil.downloadAttachment(d);else if("addcloud"===a)zmUtil.cloudUploader(d);else if("workDrive"===a)zmUtil.attachToWorkDrive({attachments:[d]});else if("print"===a){var n=r[0].getNodes()[2].$el.find("iframe")[0];"visible"===n.style.visibility&&n.contentWindow.print()}else if("more"===a){var i=$.e(t.target||t.srcElement).closest("li"),l=[{txt:B.attachmentmenu.attachInMail,data:{action:"send email"}},{txt:B.attachmentmenu.attachInPost,data:{action:"share"}}];A()&&l.push({txt:B.attachmentmenu.attachToNotes,data:{action:"addNote"}}),I()&&l.push({txt:B.attachmentmenu.attachToTask,data:{action:"addTask"}}),i.find("b").addClass("SC_ddn"),zmsuite.showMenu({par:i,list:l,clk:function(t){zmUtil.hideMenu(),"send email"===t.action?zmUtil.openComposeWithAtt([d]):"share"===t.action?zmUtil.loadNewPostDialog("",[d]):"addNote"===t.action?zmUtil.loadNotes("popup",{attEntObj:[d]}):"addTask"===t.action&&zmUtil.loadTask({action:"addCTask",tasks:{attEntObj:[d]}})}})}else if("eml-down"===a||"msg-down"===a){var m=$.e(t.target||t.srcElement).closest("li"),s="eml-down"===a?"EML":"MSG",o=[{htm:s=zmText.applyArgs(B.attachmentmenu.save,{format:s}),data:{action:"eml"}},{htm:zmText.applyArgs(B.attachmentmenu.save,{format:"HTML"}),data:{action:"html"}}];m.find("b").addClass("SC_ddn"),zmsuite.showMenu({par:m,list:o,clk:function(t){if("eml"===t.action)zmUtil.downloadAttachment(d);else if("html"===t.action){var e=d.fn,a=u.find(".jsConTent")[0];e=e.substring(0,e.lastIndexOf(".")),R.save(a,"html",e)}zmUtil.hideMenu()}})}else"printEML"===a&&zmail.Printer.print({title:c,content:u[0].innerHTML})}},v={list:{left:{leftText:c,centerAlign:!0}}};if(f[0].push(g.list),f[0].setListener("click",g.clk),f[1].push(v.list),z)n=zmComponent.loadingBand({container:f[2].$el[0],type:"loading"}),R.constMailFromEml(d,function(t){n(),u=t,f[2].$el.appendDOM(u)});else{var w;"view"===t?w="OpenDocument":"web"===t&&(w="FileDownload"),a=zmUtil.getTheSrc(w,d);u=$.e(zdom("iframe",{style:{background:"white",visibility:"hidden"},frameBorder:"0",width:"100%",height:"100%",scrolling:"auto",src:a})),"OpenDocument"===w&&u.attr("allowfullscreen","true"),n=zmComponent.loadingBand({container:f[2].$el[0],type:"loading"}),(window.ActiveXObject||"ActiveXObject"in window)&&"msi-attpdf"===zmUtil.fileTyp(d.fn)[1]?window.setTimeout(function(){n(),u.css("visibility","visible")},2e3):u.on("load",function(){n(),u.css("visibility","visible")})}zmsuite.renderCenter(),zmsuite.showWorkSpace(i),u&&f[2].$el.appendDOM(u),$.publish("zmail/SaveTabState",[{appId:i,app:"m",appObj:o,category:"mail_attachment",data:{attObj:d,fileExtn:e,mode:t}}])}r[0].$el.addClass("SC_attachviewer")},f=function(t,e){var a,n=zmUtil.fileTyp(e.fn),i={txt:!0,js:!0,java:!0,css:!0,jsp:!0,jspf:!0,c:!0,cpp:!0,html:!0,htm:!0,xml:!0,go:!0,eml:!0,msg:!0,sh:!0,bat:!0,log:!0};if(n[1]!==o&&zmUtil.hideMenu(),e){if(_zm.isOfflineSyncActive()){return-1===["jpg","jpeg","gif","html","htm","png","bmp","heic","txt","js","java","css","jsp","jspf","c","cpp","xml","go","sh","log","pdf"].indexOf(n[2])?(zmUtil.succErrMsg("e",B.attachmentmenu.offlineError),!1):void $.e(t).find(".zmImg").trigger("click")}if(n[1]!==m&&"msi-attppt"!==n[1]&&"msi-attsheet"!==n[1]&&n[1]!==l||i[n[2]]||"xml"===n[2])if(n[1]===T||(n[1]===m||n[1]===l||"msi-attothers"===n[1]||n[1]===s)&&i[n[2]]){if((window.ActiveXObject||"ActiveXObject"in window)&&{xml:!0,js:!0,css:!0}[n[2]])$.e(t).find(".zmImg").trigger("click");else a="web",zmUtil.isChildWindow()?p(e,a,n[2],t):h(e,a,n[1])}else n[1]===s&&-1!==n[2].indexOf("htm")||n[1]===m&&"xml"===n[2]?function(e){zmUtil.isNettyViewEnabled()&&zmAppLoader.load("download").then(function(){var t=zmDownload.viewDocument({returnUrl:!0,mode:"view"},e);window.open(t)});var t="";t+=zmail.conPath+"/FileDownload",t+="?mode=view&accId="+zmail.accId+"&attachId="+e.Id+"&entityType="+e.et,t+="&entityId="+e.e+"&partId="+e.p,c(e.e)&&(t+="&shId="+zmUtil.getShareId(zmUtil.getMailObj(e.e,"FD"))),window.open(t)}(e):n[1]!==o&&"msi-attaudio"!==n[1]&&"msi-attvideo"!==n[1]||$.e(t).find(".zmImg").trigger("click");else a="view",zmUtil.isChildWindow()?p(e,a,n[2],t):h(e,a,n[1])}},z=function(t,e,a){e=e||t.e;var n={entityId:t.e,attachId:t.Id,entityType:t.et},i=zmUtil.getMailObj(e);i?(i.streams?(n.groupId=i.groupId,n.streamsView=!0,n.actionType="viewGroupEntity"):n.accId=zmail.accId,zmUtil.isSharedFolder(i.FD)&&(n.shId=zmUtil.getShareId(i.FD))):n.accId=zmail.accId,"importToCal"===a&&(n.isImportCalCall=!0);zmAjq.XHR({u:zmail.conPath+"/OpenDocument",t:"GET",fn:function(t){var e={added:B.attachmentmenu.eventadded,exist:B.attachmentmenu.eventupdated,error:B.attachmentmenu.eventerror};"error"===t.msg?zmUtil.succErrMsg("e",e[t.msg]):t.msg&&zmUtil.succErrMsg("s",e[t.msg]||t.msg)},p:n,ep:{}})},g=function(e,t,a){var n=e.e;zmContentCache.isCached(n)&&(zmContentCache.get(n).NEWATT.find(function(t){return t.Id===e.Id})[t]=a);var i=zmUtil.getMailObj(n),l=i&&i.T||i&&n;!zmUtil.isChildWindow()&&l&&zmail.mailAttachments[l]&&(zmail.mailAttachments[l].data.attData[n].attData.find(function(t){return t.Id===e.Id})[t]=a)};$.subscribe("attachment/addLabel",function(t,e){var a,n,i,l,m;n=(a=e).attObj,i=a.labId,l=n.Id+n.e,(m=$.q("div[data-refId='"+l+"']")).length&&m.each(function(t,e){$.e(e).find(".zmLblGrp").appendDOM(zmsTemplates.constructTagListHTML([i],!1,"","",{constructOuterDiv:!1,getDOM:!0}))}),n.l.push(i),1===n.et&&g(n,"l",n.l)}),$.subscribe("attachment/removeLabel",function(t,e){var a,n,i,l,m,s,o;n=(a=e).attObj,i=a.labId,l=n.l,m=l.indexOf(i),s=n.Id+n.e,o=$.q("div[data-refId='"+s+"']"),l.splice(m,1),1===n.et&&g(n,"l",l),o.each(function(t,e){$.e(o).find(".zm_lbl").find("div[data-mid='"+i+"']").remove()})});var Q={updateOptHeader:function(t){if(t.elem.headerElem){var e=t.selInfo.iList.length,a=t.elem.headerElem,n=1===e?B.attachmentmenu.singleAttSelection:"";e?e<t.attList.length?(a.querySelector("#count").textContent=n||zmText.applyArgs(B.attachmentmenu.attachSelMsg,{count:e}),a.querySelector(".msi-tick").className="msi-tick partcheck"):e===t.attList.length&&(a.querySelector("#count").textContent=n||zmText.applyArgs(B.attachmentmenu.attachSelMsg,{count:t.attList.length}),a.querySelector(".msi-tick").className="msi-tick SC_check"):(a.querySelector("#count").textContent=n||zmText.applyArgs(B.attachmentmenu.attachcount,{count:t.attList.length}),a.querySelector(".msi-tick").className="msi-tick")}},select:function(t,e,a){t.classList.add("SC_check"),e.selInfo.iList.push(t.dataset.detail),e.selInfo.refList.push(t),a||Q.updateOptHeader(e)},unSelct:function(t,e){var a;t.classList.remove("SC_check"),a=e.selInfo.iList.indexOf(t.dataset.detail),e.selInfo.iList.splice(a,1),e.selInfo.refList.splice(a,1),Q.updateOptHeader(e)},selectAll:function(t){var e,a,n;for(n=(a=t.elem.attElem.childNodes||[]).length,t.selInfo.iList=[],e=0;e<n;e++)Q.select(a[e],t);Q.updateOptHeader(t)},unSelectAll:function(t){t.selInfo.refList.forEach(function(t){t.classList.remove("SC_check")}),t.selInfo.iList=[],t.selInfo.refList=[],Q.updateOptHeader(t)}},Y={addMask:function(t,e){t.selInfo.iList.length?t.selInfo.refList.forEach(function(t){t.classList.add("zm_drag")}):e.classList.add("zm_drag")},removeMask:function(t,e){t.selInfo.iList.length?t.selInfo.refList.forEach(function(t){t.classList.remove("zm_drag")}):e.classList.remove("zm_drag")}};Y.onDragStart=function(t,e){var a,n,i,l={serviceName:"zmail_attachment"};return(!_zm.isOfflineEnabled()||!ZMStore.isOffline())&&(t.selInfo.iList.length?(l.allowDrag=!0,l.type={attList:X(t),accId:zmail.accId},l.element=t.elem.attElem):(l.allowDrag=!0,l.type={attList:[t.attList[e.dataset.detail]],accId:zmail.accId},l.element=e),l.id="draggingAtt",l.html=(a=t,n=zdom("div",null),i=a.selInfo.iList.length||1,n.appendChild(u.dragTemplate.elem()),n.querySelector(".zm_dragCount").textContent=i,n.querySelector(".zm_dragTxt").textContent=1===i?B.attachmentmenu.dragMsg:zmText.applyArgs(B.attachmentmenu.attachSelMsg,{count:""}),n.innerHTML),l.cursorPosition="left",Y.addMask(t,e),$.publish("mail/draggingStarted",{text:B.attachmentmenu.dropMsg,type:"attachment"}),l)},Y.onDragEnd=function(t,e){Y.removeMask(t,e),$.publish("mail/draggingEnded",{})},Y.init=function(e){var t=new zmail.dndComp.dragSourceSibling;t.init(e.elem.attElem,{onDragStart:function(t){return Y.onDragStart(e,t)},onDragEnd:function(t){return Y.onDragEnd(e,t)},setDragInstance:function(t){var e=t.target,a=$.e(e).closest(".zmAch");return a.length?{element:a[0],setDrag:!0}:{setDrag:!1}}}),e.dragInstance=t},G=function(t,n){var e,a=t.srcElement||t.target||t,i=$.e(a).attr("data-msg")||n.action;if(i){var l,m;if(l=n.attData?n.attData:(e=$.e(a).closest(".zmAch"),m=$.e(e).attr("data-detail"),n.attList[m]),"imgView"!==i&&"view"!==i&&_zm.isOfflineSyncActive())return zmUtil.succErrMsg("e",B.attachmentmenu.offlineError),!1;switch(i){case"imgView":var s={attObjList:n.attList,startIndex:Number(m),hideIcons:["msi-send","msi-mail","msi-attsearch"]};zmUtil.isChildWindow()&&(s.hideIcons=["msi-send","msi-mail","msi-attsearch"]),zmUtil.initAttSlideShow(s);break;case"download":l&&("streams"===n.appName||"task"===n.appName?zmUtil.downloadAttachment(l):K(l,"dwn"));break;case"addtocloud":l&&zmUtil.cloudUploader(l);break;case"view":f($.e(a).closest(".zmAch"),l);break;case"addEvent":case"importToCal":"streams"===n.appName?l.et===zmStreamsApp.constants.streamTypeName.mail?z(l,l.eId,i):zmUtil.addEventsToCal(l,i):z(l,"",i);break;case"linkedMail":zmList.getMailData({msgId:l.e,opentype:2,type:"th",src:"external"});break;case"showMore":!function(t,e,a){$.e(t).closest(".zmL, ."+q).addClass("sel"),$.e(t).addClass("active"),R.removeMAct();var n,i=$.e(t).attr("data-showFrom")||$.e(t.children).attr("data-showFrom"),l=C.slice(i,C.length),m=[];for(n in w=e,l){var s=l[n].getElem({from:"more",attData:e,processIndex:i});s&&("object"===babelHelpers.typeof(s)?m.push(s):m.push({txt:s,data:{attData:e,action:l[n].action}}))}var o={divId:"moreAttachMenu",par:t,showArrow:!0,list:m,onHide:function(){$.e(t).parents(".zmL.zmAch").removeClass("sel"),$.e(t).removeClass("active")},clk:function(t,e){t.data=a,G(e,t),r.moreOpt&&(r.moreOpt.remove(),delete r.moreOpt)}};if(zmUtil.isChildWindow()){var d=new zmDropDownMenu;d.setDropObj(o),d.paint(),r.moreOpt=d}else r.moreOpt=zmsuite.showMenu(o)}(a,l,n);break;case"newMail":zmUtil.openComposeWithAtt([l]),zmUtil.publishCloseNotif();break;case"newPost":zmUtil.loadNewPostDialog("",[l]);break;case"noteAtt":zmUtil.loadNotes("popup",{attEntObj:[l]});break;case"taskAtt":zmUtil.loadTask({action:"addCTask",tasks:{attEntObj:[l]}});break;case"close":zmUtil.hideMenu();break;case"addTag":!function(t,e){if(zmUtil.isZohoAccount(zmail.accId)){R.removeMAct(),$.e(t).closest(".zmL, ."+q).addClass("sel");var a=zmAttachUtility.showLabelPopup(t,e,"",function(t){$.e(t).closest(".zmL, ."+q).removeClass("sel")});r.tagRef=a}}(a,l);break;case"delete":if(n.data&&n.data.deleteAttachment)return void n.data.deleteAttachment(l);var o=$.e(n.data.attListElem).find("div[data-refid='"+l.Id+l.e+"']");zmTask.Util.deleteTaskAttachment(l,function(){var t=$.e(o).data("detail");n.data.attList.splice(t,1);var e=$.e(n.data.attListElem).parents(".zmAttWrapper");if(n.data.attList.length){var a=d.build(n.data);$.e(a).insertDOMAfter(e),e.remove()}else e.remove()});break;case"saveAsHtml":R.constMailFromEml(l,function(t){var e=t[0].innerHTML,a=l.fn;a=a.substring(0,a.lastIndexOf(".")),R.save(e,"html",a)});break;case"select":e.hasClass("SC_check")?Q.unSelct(e[0],n):Q.select(e[0],n),R.removeMAct();break;case"addtoTeamDrive":zmUtil.attachToWorkDrive({attachments:[l]})}}else R.removeMAct()};var tt=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return t.className=q,zmCloudAtt.core.getPreviewContent(t)},et=function(t,e){var a=t.fn,n=a.lastIndexOf("."),i=a,l="";-1!==n&&(i=a.substring(0,n),l=a.substring(n,a.length));var m,s,o,d,r=V.entityInfo.isThd?"zmAchLbl":"",c=zmUtil.fileTyp(t.fn)[1],u=zmUtil.sizeValueUnround(t.fs)||"",p=t.fn.toLowerCase(),h=[];if(w=t,!V.hideOptions){for(o in C)if((s=C[o].getElem({filename:p,fileExtn:c,entityType:t.et,entityId:t.e}))&&h.push(s),2<h.length)break;if(2<h.length){h=h.slice(0,2);var f=zdom("i",{className:"msi-action","data-msg":"showMore",title:B.attachmentmenu.more,"data-showFrom":o});h.push(f)}}m=zdom("div",{"data-refId":t.Id+t.e,className:"zmL "+q+" "+r,"data-detail":String(e)},zdom("div",{className:"zmLst"}));var z=_zm(".","zmLst",m)[0];V.showChkBox&&z.appendChild(zdom("div",{className:"zmFlt"},zdom("i",{className:"msi-tick",title:"Select","data-msg":"select"})));var g=zdom("div",{className:"zmDtl"});"ML_popup"===V.appName&&t.ts&&g.appendChild(zdom("div",{className:"zmDate"},zdom("span",null,t.ts))),t.thn?g.appendChild(zdom("div",{"data-msg":"imgView",className:"zmImg"},zdom("img",{src:t.thn,"data-msg":"imgView"}))):g.appendChild(zdom("div",{"data-msg":"imgView",className:"zmImg"},zdom("i",{className:c+" zm-attIcn","data-msg":"imgView"}))),d=zdom("div",{className:"zmFrm"});var v="reader"===V.appName?"imgView":"view";return d.appendChild(zdom("span",{title:t.fn,className:"zmAttTitle"},zdom("span",{"data-msg":v}," ",i," "),zdom("span",{"data-msg":v}," ",l," "))),"ML_popup"===V.appName&&t.dn&&d.appendChild(zdom("div",{className:"zmAtt_sender"},t.dn)),g.appendChild(d),h.length&&(d=zdom("div",{className:"zmSub"}),$.e(d).appendDOM($.e(h)),g.appendChild(d)),g.appendChild(zdom("div",{className:"zmSze"},zdom("span",{className:"sum"},u))),V.showTag&&!t.isEmlView&&((d=zdom("span",{className:"SC_ldot zm_lbl"},zdom("i",{className:"msi-label",title:B.attachmentmenu.addTag,"data-msg":"addTag"}))).insertAdjacentHTML("beforeend",zmsTemplates.constructTagListHTML(t.l,!1,"","",{constructOuterDiv:!0})),g.appendChild(d)),z.appendChild(g),m},at=function(t){var e=$.e(t.currentTarget).parents(".zmPAtt");e.toggleClass("collapsed"),e.find(".zmAttGrp").slideToggle()};R.viewAttachment=h,d.build=function(e){try{if(!Array.isArray(e.attList))return;var t,a,n,i=zdom("div",{className:"zmAttDivision"}),l=!1,m=[],s=!0,o=!1,d=[];V=e||{},e.entityInfo=e.entityInfo||{},e.elem={},q=e.attClass||"zmAch";var r,c,u,p,h,f=document.createDocumentFragment(),z={},g=e.attList.length;(t=zdom("div",null)).className=e.attListClass||"zmPAtt";var v=!1,w=g;if(g){var T=_.pluck(e.attList,"attType");if(l=-1!==T.indexOf(4),o=-1!==T.indexOf(5),1<_.uniq(T).length&&(v=!0),l){if(zmUtil.loadHugeAttachComponent(),(a=zdom("div",null)).className=e.attListClass||"zmPAtt",(m=_.filter(e.attList,function(t){return 4===t.attType})).length===g)s=!1;else{var A=_.filter(e.attList,function(t){return 4!==t.attType});e.attList=_zm.copyOf(A),g=e.attList.length}r=document.createDocumentFragment()}if(o&&(zmUtil.cloudAttachmentComponent(),(n=zdom("div",null)).className=e.attListClass||"zmPAtt",(d=_.filter(e.attList,function(t){return 5===t.attType})).length===g&&(s=!1),c=document.createDocumentFragment()),s){var I=_.filter(e.attList,function(t){return 5!==t.attType&&4!==t.attType});e.attList=_zm.copyOf(I),g=e.attList.length}}if(1<e.attList.length&&e.supportDrag&&(e.showChkBox=!0),e.selInfo={iList:[],refList:[]},e&&e.zipType){if(l){var C=(H=m.length,F=e,W=zmAttachComponent.hugeAttachment.constructHugeAttHeader(H,F),$.e(W).find(".expandCollapse").unbind().bind("click",at),W);e.elem.hugeHeaderElem=C,a.appendChild(C)}if(o){var b=(S=d.length,j=e,P=zmCloudAtt.core.getPreviewHeader(S,j),$.e(P).find(".expandCollapse").unbind().bind("click",at),P);e.elem.cloudHeaderElem=b,n.appendChild(b)}s&&((p=function(t){var e=t.attList.length,a="";t.showMOpt&&1<e&&!zmUtil.isChildWindow()&&(a=zdom("fragment",null,zdom("span",{className:"zmSDot"}),zdom("span",{className:"zmLink","data-msg":"moreOptions"},B.attachmentmenu.addTo,zdom("i",{className:"msi-rarrow SC_thm","data-msg":"moreOptions"}))));var n,i=t.showChkBox?zdom("i",{className:"msi-tick","data-msg":"selAll"}):zdom("fragment",null);n=e&&1<e?zmText.applyArgs(B.attachmentmenu.attachcount,{count:e}):B.attachmentmenu.oneAttachment;var l="";t.zipType&&"none"!==t.zipType&&(l=zdom("fragment",null,zdom("span",{className:"zmSDot"}),zdom("span",{className:"zmLink","data-msg":t.zipType},B.attachmentmenu.downloadaszip)));var m="";return t.showToggleOpt&&(m=zdom("i",{className:"msi-zmPle"})).addEventListener("click",function(){$.e(t.elem.attElem).slideToggle(),$.e(t.elem.attElem).parent().toggleClass("collapsed")}),zdom("div",{className:"zmAttHdr"},m,i,zdom("b",null,zdom("span",{id:"count"},n)),l,a)}(e)).addEventListener("click",function(t){(function(t,e){var a=t.target||t.srcElement,n=$.e(a).attr("data-msg");if("downloadall"===n||"downloadconv"===n){if(e.selInfo&&e.selInfo.iList.length&&e.selInfo.iList.length<e.attList.length){var i=X(e);return zmUtil.downloadSelected(i,{fName:Z(e.entityInfo.id||e.entityInfo.e)})}K(e.entityInfo,n)}else"moreOptions"===n?J($.e(a),e):("selAll"===n&&(a.classList.contains("SC_check")||a.classList.contains("partcheck")?Q.unSelectAll(e):Q.selectAll(e)),R.removeMAct())})(t,V=e),_zm.stopEvents(t)}),e.elem.headerElem=p,t.appendChild(p))}if(l){for(h=0;h<m.length;h++)z=m[h],r.appendChild((O=z,zmAttachComponent.hugeAttachment.constructHugeAttList({name:O.fn,size:O.fs,digest:O.digest,attObj:O,className:q})));e.elem.hugeAttListElm=r;var L=zdom("div",{className:"zmAttGrp hugeListMap"});L.appendChild(r),i.appendChild(a),a.appendChild(L)}if(o){for(h=0;h<d.length;h++)z=d[h],c.appendChild(tt(z));e.elem.cloudAttListElm=c;var E=zdom("div",{className:"zmAttGrp cloudListMap"});E.appendChild(c),i.appendChild(n),n.appendChild(E)}if(s){for(h=0;h<g;h++){z=e.attList[h];var y=et(z,h);f.appendChild(y)}(u=zdom("div",null)).className="zmAttGrp",$.e(u).appendDOM($.e(f)),u.addEventListener("click",function(t){(V=e).attListElem=u,G(t,e),"streams"!==e.appName&&_zm.stopEvents(t)}),e.elem.attElem=u,t.appendChild(u),e.supportDrag&&zmAppLoader.load("dragNDropUtil").then(function(){Y.init(e)}),i.appendChild(t)}var k="zmAttWrapper";return e.showToggleOpt&&v&&(k="zmAttWrapper zmAttCollapse"),zdom("div",{className:k},e.showToggleOpt&&v?(M=(N={attachLen:w,attachDOM:i}).attachLen,U=N.attachDOM,(x=zdom("span",{className:"zmLink"},zdom("i",{className:"msi-tarrowD"})," ",zdom("span",{className:"jsToggleText"},B.attachmentmenu.collpase))).addEventListener("click",function(){$.e(x).find(".msi-tarrowD").toggleClass("zmShwAtt"),$.e(U).slideToggle(function(){var t=$.e(x).find(".jsToggleText");t.text()===B.attachmentmenu.collpase?t.text(B.attachmentmenu.expand):t.text(B.attachmentmenu.collpase)})}),D=1<M?M+" "+B.attachmentmenu.multipleAttachment:M+" "+B.attachmentmenu.singleAttachment,zdom("h3",{className:"zmAttCount"},zdom("i",{className:"msi-attachment zmThmClr"}),"  ",D,zdom("span",{className:"zmSDot"}),x)):"",i)}catch(t){zmUtil.debugLog(t)}var N,D,M,U,x,O,S,j,P,H,F,W},d.util=R}();
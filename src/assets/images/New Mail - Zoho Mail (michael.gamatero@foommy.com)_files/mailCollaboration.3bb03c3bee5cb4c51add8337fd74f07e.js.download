"use strict";!function(){window.zmMailCollab=window.zmMailCollab||{};var e=window.zmMailCollab,t=!1,m=function(){return"on"===zmAdHocSettings.getSuppressedMessagesState().conversationShareWarning},u=function(e,t){return zmText.get("mailCollaboration",e,t)};e.Interface={},e.Interface.Internal={createCommentEntity:function(n){var e=zmMailCollab.Util.DeferredCollection,t=zmMailCollab.Backend,i=["deferred",["interface","createCommentEntity",(n=n||{}).mailID,n.shareConversation,n.useConversation,n.inviteRecipients,n.lockInvites].join("_")].join("_"),a=e.get(i);if(n.mailID&&n.hasOwnProperty("shareConversation")&&n.hasOwnProperty("useConversation")&&n.hasOwnProperty("inviteRecipients")&&n.inviteesList)if(n.inviteRecipients||n.inviteesList.length){var o=zmMailCollab.Components.ConversationShareAlertDialog.create({senderList:n.senderList,mailCount:n.mailCount}),s=function(){t.createCommentEntity(n).done(function(e){(e=e||{}).success=!0,a.resolve(e)}).fail(function(e){a.reject({success:!1,error:{code:3,message:["Request failed",e].join(". ")}})})};!m()||1===n.mailCount||!n.shareConversation||n.mailList&&n.mailList.length?s():o.show().done(function(){s()}).fail(function(){a.reject({success:!1,error:{code:4,message:["User cancelled share"].join(""),suppress:!0}})})}else{var r=u,l=r("labels.mail");n.isDraftShare?l=r("labels.draft"):n.useConversation&&n.shareConversation&&(l=r("labels.conversation"));var c=r("messages.noMentionsError",{shareItemType:l});a.reject({success:!1,error:{code:2,message:c}})}else a.reject({success:!1,error:{code:1,message:"Invalid data"}});return a.done(function(e){e=e||{};var t=zmMailCollab.Event,i=zmMailCollab.EventConstants;t.publish(i.COMMENT_ENTITY_CREATED,{mailID:n.mailID,useConversation:n.useConversation,conversationID:e.conversationID,inviteesList:n.inviteesList,lockInvites:n.lockInvites,data:e})}),a.promise()},getCurrentZUID:function(){return zmail.zuid},getCurrentAccountID:function(){return zmail.accId},getDocumentBody:function(){return document.body},turnOffMailShareTip:function(){var e=zmAdHocSettings.getSuppressedMessagesState();return e.mailShareTip="off",zmAdHocSettings.setSuppressedMessagesState(e)},isShareWarningActive:m,turnOffShareWarning:function(){var e=zmAdHocSettings.getSuppressedMessagesState();return e.conversationShareWarning="off",zmAdHocSettings.setSuppressedMessagesState(e)},removeDialog:function(){return zmsDialog.remove()},createDialog:function(e,t){return zmsDialog.create(e,t)},isDialogOpen:function(){return zmsDialog.isOpen()},listenOnceDialogClose:function(e){return zmsDialog.listenOnceDialogClose(e)},createStreamsCommentComponent:function(e,t){return zmStreamsApp.CommentModule.init(e,$.e(t))},createStreamsPostActionComponent:function(e,t){zmStreamsApp.PostActions.init(e,t)},createLoadingBand:function(e){return zmComponent.loadingBand(e)},getMailShareTipState:function(){return zmAdHocSettings.getSuppressedMessagesState().mailShareTip},loadStreamsModule:function(){return zmUtil.requireStreamsComments()},isZohoAccount:function(e){return zmUtil.isZohoAccount(e)},isOrgAccount:function(){return t},isPopupWindow:function(){return zmUtil.isChildWindow()},isShareRestrictedFolder:function(e){return-1!==[zmail.folId.oId,zmail.folId.dId,zmail.folId.teId].indexOf(e)},isSharedFolder:function(e){return zmail.shrTree[0]&&zmail.shrTree[0][e]},getCurrentTabID:function(){return zmTab.currentTab},getCurrentAppContainer:function(){return $.e(zmsuite.getCenter()[0].$el)},getCurrentWindow:function(){return window},logConsole:function(){var e=Array.prototype.slice.apply(arguments);return zmUtil.debugLog.apply(zmUtil.debugLog,e)},createZMAjaxRequest:function(e){return zmAjq.XHR(e)},getContextPath:function(){return zmail.conPath},showZMSuccessErrorMessage:function(e,t,i){return _zm.succErrMsg(e,t,i)},switchToApp:function(e){zmsuite.isWorkspaceAvailable(e)&&zmTab.currentTab!==e&&zmsuite.showWorkSpace(e)},isPartialConversationView:function(){return zmUtil.getMLConversionValue()<2},getCurrentConversationViewType:function(){return{0:"SINGLE_MAILS",1:"FOLDER_MAILS",2:"ALL_MAILS"}[zmUtil.getMLConversionValue()]},replaceHTMLEntities:function(e){return e=e||"",zmUtil.replaceHTMLEntities(e)},getCollabVersion:function(){return zmail.collabVersion},invokeAfter:function(e,t){setTimeout(e,t)},getMailMetaData:function(e){return zmUtil.getMailObj(e)||{}},getFolderData:function(e){return zmUtil.getFolderObject(e)},isCurrentUserEmail:function(e){var t={},i=zmail.aInfo||{},n=(zmail.fromAddr||"").trim().toLowerCase();if(!(e=(e||"").trim().toLowerCase()))return!1;for(var a in i){var o=(i[a].mailId||"").trim().toLowerCase();o&&(t[o]=!0)}return n&&(t[n]=!0),void 0!==t[e]},getI18N:u},t=zmail.isOrg}(),function(){window.zmMailCollab=window.zmMailCollab||{};var n,e=window.zmMailCollab,l=zmMailCollab.Interface.Internal,s=function(){var e=zmMailCollab.Event,t=zmMailCollab.EventConstants,i=Array.prototype.slice.apply(arguments);i.unshift("zmMailCollab"),l.logConsole.apply(l.logConsole,i),e.publish(t.MAILSHAREDATA_LOG,i)},t=function(e){return void 0!==e&&e.constructor===Array},c=function(e){return void 0!==e&&("object"===babelHelpers.typeof(e)&&e instanceof Object&&!(e instanceof Array))},m=function(e){return void 0!==e&&e.constructor===Function},r=(n={},{get:function(e){var t,i;return n[e]?t=n[e]:(t=$.Deferred(),(n[e]=t).always((i=e,function(){n[i]=void 0,delete n[i]}))),t},has:function(e){return void 0!==n[e]}}),i=function(e,t){l.showZMSuccessErrorMessage(t.type,e,t)};e.Util={isObject:c,isArray:t,isPrimitive:function(e){return!e||!c(e)&&!t(e)},isFunction:m,copyOf:function(e,t){return $.extend(t,e)},isOwnProperty:function(e,t){return e.hasOwnProperty(t)},makeGetSetAPI:function(i,n,a){var e="",t="";if(c(i)){m(n)||(n=function(e){return i[e]}),m(a)||(a=function(e,t){i[e]=t});var o=function(t){return function(){var e=Array.prototype.slice.apply(arguments);return e.unshift(t),n.apply(this,e)}},s=function(t){return function(){var e=Array.prototype.slice.apply(arguments);return e.unshift(t),a.apply(this,e)}};for(var r in i)i.hasOwnProperty(r)&&(t="set"+(e=r.charAt(0).toUpperCase()+r.substr(1)),i["get"+e]=o(r),i[t]=s(r))}},log:s,isSharingValid:function(e){return(e=e||{}).accountID=e.accountID||l.getCurrentAccountID(),_zm.isStreamsEnabled()?l.isZohoAccount(e.accountID)?e.folderID&&l.isShareRestrictedFolder(e.folderID)?(s("SHARING_INVALID","O/D/T_MAIL"),!1):e.folderID&&l.isSharedFolder(e.folderID)?(s("SHARING_INVALID","UR_SF_MAIL"),!1):e.folderData&&void 0!==e.folderData.SH&&"-1"!==e.folderData.SH?(s("SHARING_INVALID","EXT_SF_MAIL"),!1):(e.containerDOM&&(e.containerDOM=$.e(e.containerDOM)),e.containerDOM&&(e.containerDOM.hasClass("SCS_postMail")||0<e.containerDOM.parent(".SCS_postMail").length)?(s("SHARING_INVALID","NOTIF_OPEN_MAIL"),!1):!("notification-popout"===e.openedBy||(zmUtil.isChildWindow()||"zm_stream"!==l.getCurrentTabID()&&"zmStreamsApp"!==l.getCurrentTabID()?!zmUtil.isChildWindow()&&l.getCurrentAppContainer().hasClass("zms_streams")?(s("SHARING_INVALID","STREAMS_LIST_MAIL"),1):e.containerDOM&&!e.suppressComponentCheck&&0!==e.containerDOM.find(".SCS_cmnt").length&&(s("SHARING_INVALID","CMTBX_AVAIL"),1):(s("SHARING_INVALID","STREAMS_MAIL"),1)))):(s("SHARING_INVALID","NON_ZOHO_ACCOUNT"),!1):(s("SHARING_INVALID","STREAMS_DISABLED"),!1)},DeferredCollection:r,ajaxPostRequest:function(e){var t=(e=e||{}).requestID||"ajaxpostreq_"+Date.now(),i=!r.has(t),n=r.get(t);if(i){var a=_zm.copyOf(e.data);"getMailShareData"!==a.mode&&(a.streamsView=!0);var o=l.createZMAjaxRequest({u:l.getContextPath()+e.url,p:a,t:"post",fn:function(e){n.resolve({state:"success",response:e})},efn:function(){s("Ajax request failed",arguments),n.reject({state:"fail",reason:"Request failed"})}});n.ajaxInstance=o}return n.promise()},showSuccessMessage:function(e,t){(t=t||{}).type="s",i(e,t)},showErrorMessage:function(e,t){(t=t||{}).type="e",i(e,t)},parseConversationData:function(e){var a=0,o={},s={},r=[];return(e=e||[]).forEach(function(e){if((e=e||{}).M&&!l.isShareRestrictedFolder(e.FD)){s[e.M]=e.R;var t=(e.F||"").trim(),i=(e.SN||"").trim(),n=[];i?(n.push(i),t&&n.push("<"+t+">")):t&&n.push(t),(n=(n.join(" ")||"").trim())&&(o[n]=""),a+=1,r.push(e.M)}}),o=Object.keys(o),{mailCount:a,senderList:o,mailReceiveTime:s,mailIds:r}},getI18N:function(e,t){return l.getI18N(e,t)},updateMailCache:function(e){e&&(zmUtil.getMailObj(e)&&"undefined"!=typeof zmCache&&(zmUtil.updateMailData("CT",1,e),s("Update Mail Listing Object")),zmUtil.isChildWindow()&&opener.zmail&&opener.zmCache&&opener.zmUtil.updateMailData("CT",1,e))},sortMailIds:function(e,t){for(var i=t.mailIds,n=[],a=0;a<i.length;a++)-1!==e.indexOf(i[a])&&n.push(i[a]);return n},resetBottom:function(e){if(e){var t=$.e(e).find(".SC_Twpr");t.length&&$.e(t).css("bottom")&&$.e(t).css("bottom","0px")}},getRecipients:function(e){var t=zmMailCollab.Collection.MailShareData.get(e);if($.isEmptyObject(t))return[];var i=t.getRecipientList();return $.isEmptyObject(i)?[]:t.getRecipientList()[0].orgUsers},isValidContainer:function(e,t){return 0===t.getOpenedBy()&&zmPrev.isEntityOpenedInPreview(t.mailID,t.getOpenedTab())||0!==t.getOpenedBy()},getCurrentTab:function(e){return zmUtil.isChildWindow()?"":e||zmTab.currentTab},isConversationFalse:function(e){var t=!1;return e&&(t=-1!==e.openedTab.indexOf("zm_srch")),zmUtil.isChildWindow()&&zmail.mailDataObj&&zmail.mailDataObj.thdId?t=zmail.showFullConv:t||(t=0===zmUtil.getMLConversionValue(e.folderID)),t},isCommentBoxHidden:function(){return zmUtil.hideCommentBox()}}}(),function(){window.zmMailCollab=window.zmMailCollab||{};var e=window.zmMailCollab,t=zmMailCollab.Util,i="/mail/collab/",n={publish:function(e,t){$.publish(i+e,t)},subscribe:function(e,t){$.subscribe(i+e,t)},unsubscribe:function(e,t){$.unsubscribe(i+e,t)}};e.Event=n,e.EventConstants=t.copyOf({MAILSHAREDATA_LOG:"log",MAILSHAREDATA_PROPERTY_CHANGED:"sharedata/property/changed",MAILSHAREDATA_INSTANCE_CREATED:"sharedata/instance/created",COLLABCOMPONENT_INSTANCE_CREATED:"component/instance/created",COLLABCOMPONENT_INSTANCE_DATA_SET:"component/instance/dataset",COLLABCOMPONENT_INSTANCE_RESIZE:"component/instance/resize",COMMENT_ENTITY_CREATED:"comment/entity/created",COLLABCOMPONENTCONTAINER_PROPERTY_CHANGED:"collabcontainer/property/changed",COLLECTION_COLLABCOMPONENT_INSTANCE_REMOVED:"collabcontainercollection/instance/removed",MAILSHAREDATA_SELECTMAIL:"/mail/selectMail",EXTERNAL_MAIL_FORWARD_EVENT:"/mail/forwardmail",EXTERNAL_COMPOSE_BCC_EVENT:"/compose/bccpresent",EXTERNAL_MAIL_OPENING_EVENT:"/mail/openingincontainer",EXTERNAL_MAIL_OPENED_EVENT:"/mail/openedincontainer",EXTERNAL_MAIL_VIEW_FOCUSCOMMENT:"/mail/view/focuscommentbox",EXTERNAL_MAILCOLLAB_SHARE_STATUS:"/mail/collab/share/status",EXTERNAL_MAIL_PREVIEW_UPDATE_SHARE:"/mail/preview/updateshare",EXTERNAL_MAIL_PREVIEW_UPDATE_SHAREICON:"/mail/collab/updateshareicon",EXTERNAL_DRAFT_OPENED_EVENT:"/draft/openedincompose",EXTERNAL_DRAFT_OPENING_EVENT:"/draft/openingincompose",EXTERNAL_DRAFT_COMMENT_CONSTRUCT_EVENT:"/draft/openCommentRHS",EXTERNAL_DRAFT_NOTIFY_UPDATES_EVENT:"/draft/sharing/notifyupdates",EXTERNAL_MAIL_CLOSE_PREVIEW:"/mail/previewclosed",EXTERNAL_MAIL_CHANGE_PREVIEW:"mail/preview/unload",EXTERNAL_COMMENT_COMPONENT_RESIZE:"zmstreamsapp/keyevent",EXTERNAL_MAIL_THREAD_CREATED:"mail/threadCreated"},{})}(),function(){window.zmMailCollab=window.zmMailCollab||{};var e=window.zmMailCollab,c=zmMailCollab.Interface.Internal;function o(e){e=e||{},this.mailID=e.mailID||void 0,this.useConversation=e.useConversation||!1,this.conversationID=e.conversationID||void 0,this.folderID=e.folderID||void 0,this.commentValue=e.commentValue,this.commentData=e.commentData||{},this.commentData.comments=this.commentData.comments||{},this.commentData.order=this.commentData.order||[],this.isDraftShare=e.isDraftShare||!1,this.likeList=e.likeList||[],this.inviteeList=e.inviteeList||[],this.lockInvites=e.lockInvites,this.entityExists=!1,this.sharedUptoTime=void 0,this.sharedMailIds=[],this.conversationData=e.conversationData||{},this.conversationData.mailCount=this.conversationData.mailCount||1,this.conversationData.senderList=this.conversationData.senderList||[],this.conversationData.mailReceiveTime=this.conversationData.mailReceiveTime||{},this.recipientList=[],this.openedBy=e.openType,this.openedTab=e.openedTab}var t=function(e){var t,i=zmMailCollab.Util,s=zmMailCollab.Event,r=zmMailCollab.EventConstants,n=new o(e=e||{}),a={},l=function(e){var t=zmMailCollab.Util,i=this[e];if(!t.isOwnProperty(this,e))throw new Error("No such property");return t.isArray(i)?t.copyOf(i,[]):t.isObject(i)?t.copyOf(i,{}):i};return i.makeGetSetAPI(n,l,function(e,t,i){var n=zmMailCollab.Util,a=t,o=l.apply(this,[e]);if(i=i||{},!n.isOwnProperty(this,e))throw new Error("No such property");return n.isArray(t)&&(a=n.copyOf(t,[])),n.isObject(t)&&(a=n.copyOf(t,{})),this[e]=a,t===o&&(i.suppress=!0),s.publish(r.MAILSHAREDATA_PROPERTY_CHANGED,{instance:this,property:e,oldValue:o,value:t}),t}),n.initialize=function(e){return a=i.copyOf(e,a),t||(t=function(i,e){var n=zmMailCollab.Util,t=zmMailCollab.Backend;e=e||{};var a=n.DeferredCollection.get("initMailShareData_"+i.mailID+"_"+i.useConversation),o=function(){t.getMailShareData({mailID:i.mailID,useConversation:i.useConversation,commentValue:i.commentValue,isDraftShare:i.isDraftShare,requiredData:["commentData","lastReceiveTime","likesList","inviteesList","conversationData","recipientList"]}).done(function(e){e=e||{},i.setLockInvites(e.lockInvites),i.setMailID(e.mailID||""),i.setUseConversation(e.useConversation||!1),i.setConversationID(e.conversationID),i.setFolderID(e.folderID),e.sharedMailIds&&i.setSharedMailIds(e.sharedMailIds),i.setRecipientList(e.recipientList),e.commentData=e.commentData||{};var t={comments:e.commentData.comments||{},order:e.commentData.order||[],totalCount:parseInt(e.commentData.totalCommentCount)||0};i.setCommentData(t),e.likesList=e.likesList||[],i.setLikeList(e.likesList),e.inviteesList=e.inviteesList||[],i.setInviteeList(e.inviteesList),i.setConversationData(n.parseConversationData(e.conversationData)),void 0===e.lastReceiveTime&&!1===e.useConversation&&e.entityExists&&(e.lastReceiveTime=i.conversationData.mailReceiveTime[e.mailID]),i.setSharedUptoTime(e.lastReceiveTime),i.setEntityExists(e.entityExists),a.resolve({instance:i})}).fail(function(){a.reject()})};return e.delay?c.invokeAfter(function(){e.cancel?a.reject({suppressError:!0}):o()},e.delay):o(),a.promise()}(n,a)),t},n.abortInit=function(){if(t)switch(t.state()){case"pending":a.cancel=!0,t.fail(function(){a={}});break;case"rejected":a={},t=void 0}},n};function n(e){e=e||{},this.mailID=e.mailID||"",this.useConversation=e.useConversation||!1,this.conversationID=e.conversationID||"",this.containerDOM=e.containerDOM,this.component=e.component,this.updateOperationPending=e.updateOperationPending||!1}var r,l,i,a,s,m,u,d,C,D=function(e){var t=zmMailCollab.Util,i=new n(e=e||{});return t.makeGetSetAPI(i,void 0,function(e,t,i){var n=zmMailCollab.Util,a=zmMailCollab.Event,o=zmMailCollab.EventConstants,s=t,r=this[e];if(i=i||{},!n.isOwnProperty(this,e))throw new Error("No such property");return this[e]=s,a.publish(o.COLLABCOMPONENTCONTAINER_PROPERTY_CHANGED,{instance:this,property:e,oldValue:r,value:t,suppress:i.suppress||!1}),t}),i},f=(r=zmMailCollab.Util,i=function(e,t,i){var n,a,o;if(!e||void 0===t)return r.log("mailsharedatacollection.finditem","invalid params"),{index:-1};if(!0===t&&void 0===i)return r.log("mailsharedatacollection.finditem","invalid params"),{index:-1};for(n=0,a=l.length;n<a;n++){o=l[n];var s=!1;if(t&&i&&o.conversationID===i&&o.conversationData.mailIds&&o.conversationData.mailIds.indexOf(e)?s=!0:o.mailID===e&&(s=!0),s)return{index:n,instance:o}}return{index:-1}},{get:function(e){var t=zmMailCollab.Util;if(a(e))return i(e.mailID,e.useConversation,e.conversationID).instance;t.log("mailsharedatacollection.getitem","Instance not found")},put:function(e,t){var i=zmMailCollab.Util;if((t=t||{}).overwrite)s(e);else if(a({mailID:e.mailID,useConversation:e.useConversation}))return i.log("mailsharedatacollection.putitem","Instance already added"),!1;return l.push(e),!0},has:a=function(e){return-1!==i((e=e||{}).mailID,e.useConversation,e.conversationID).index},remove:s=function(e){var t=i(e.mailID,e.useConversation,e.conversationID);return-1!==t.index&&(l.splice(t.index,1),!0)},collection:l=[]}),v={getWithDOM:function(t){t=t||{};var i=[];return m.forEach(function(e){e.getContainerDOM()===t.containerDOM&&i.push(e)}),i},getWithData:function(i){i=i||{};var n=[];return m.forEach(function(e){var t=!1;i.useConversation&&i.conversationID===e.getConversationID()?t=!0:i.mailID===e.getMailID()&&(t=!0),t&&n.push(e)}),n},put:function(e){return m.push(e),!0},remove:u=function(t){var i=zmMailCollab.Event,n=zmMailCollab.EventConstants,a=0;return m.forEach(function(e){if(e===t)return m.splice(a,1),i.publish(n.COLLECTION_COLLABCOMPONENT_INSTANCE_REMOVED,{instance:t}),!0;a++}),!1},removeAll:function(e){var t=0;return(e=e||[]).forEach(function(e){t+=u(e)?1:0}),t},collection:m=[]},p=function(e,t){var i;if(t=t||{},i=f.get({mailID:t.mailID,useConversation:t.useConversation,conversationID:t.conversationID})){var n=t.data||{},a=t.inviteesList;n.conversationID&&i.setConversationID(n.conversationID),n.folderID&&i.setFolderID(n.folderID),n.inviteeList&&Object.keys(n.inviteeList).length||(n.inviteeList={},a.forEach(function(e){n.inviteeList[e]=c.getCurrentZUID()})),i.setInviteeList(n.inviteeList),n.hasOwnProperty("useConversation")&&i.setUseConversation(n.useConversation),n.useConversation||t.conversationID||i.setSharedMailIds(t.mailID),n.sharedMailIds&&i.setSharedMailIds(n.sharedMailIds),n.lastReceiveTime&&i.setSharedUptoTime(n.lastReceiveTime),i.setEntityExists(!0)}},I=function(e,t){t=t||{};var i,n=zmMailCollab.Collection.CollabContainer;if(-1!==(i=["mailID","conversationID","useConversation"].indexOf(t.property))){var a=t.instance,o={};o.mailID=0===i?t.oldValue:a.getMailID(),o.conversationID=1===i?t.oldValue:a.getConversationID(),o.useConversation=2===i?t.oldValue:a.getUseConversation(),(n.getWithData(o)||[]).forEach(function(e){e.setMailID(a.getMailID()),e.setConversationID(a.getConversationID()),e.setUseConversation(a.getUseConversation())})}},h=function(e,t){var i=(t=t||{}).instance;if("sharedUptoTime"!==t.property&&i.entityExists&&void 0===i.sharedUptoTime&&!1===i.useConversation){var n=i.conversationData.mailReceiveTime[i.mailID];i.setSharedUptoTime(n)}};d=zmMailCollab.Event,C=zmMailCollab.EventConstants,d.subscribe(C.COMMENT_ENTITY_CREATED,p),d.subscribe(C.MAILSHAREDATA_PROPERTY_CHANGED,I),d.subscribe(C.MAILSHAREDATA_PROPERTY_CHANGED,h),e.Model={MailShareData:{create:t},CollabContainer:{create:D}},e.Collection={MailShareData:f,CollabContainer:v}}(),function(){window.zmMailCollab=window.zmMailCollab||{};var e=window.zmMailCollab,m="/mailCollab.do",u=zmMailCollab.Util,d=zmMailCollab.Util.DeferredCollection,C=zmMailCollab.Interface.Internal;e.Backend={getMailShareData:function(e){var t=["getMailShareData",(e=e||{}).mailID,e.useConversation,e.requiredData.join("_")].join("_"),i=["deferred",t].join("_"),n=!d.has(i),a=d.get(i);if(n){var o={mode:"getMailShareData",mailID:e.mailID,useConversation:e.useConversation,zohoID:C.getCurrentZUID(),accountID:C.getCurrentAccountID(),requiredData:e.requiredData.join(",")};e.conversationID&&(o.conversationID=e.conversationID),e.commentValue||e.conversationID||e.useConversation||e.isDraftShare?u.ajaxPostRequest({url:m,data:o,requestID:["ajax",t].join("_")}).always(function(e){"success"===(e=e||{}).state?a.resolve(e.response):a.reject(e.reason)}):a.resolve({mailID:e.mailID,folderID:e.folderID,useConversation:e.useConversation,entityExists:!1})}return a.promise()},createCommentEntity:function(e){var t=["createCommentEntity",(e=e||{}).mailID,e.shareConversation,e.useConversation,e.inviteRecipients,e.lockInvites,e.recipientList,e.inviteesList.join("_")].join("_"),i=["deferred",t].join("_"),n=!d.has(i),a=d.get(i),o=e.useConversation?e.useConversation:Boolean(C.getMailMetaData(e.mailID).T),s=e.mailList?e.mailList.join(","):"";o=!e.isDraftShare&&o;var r=e.isDraftShare?o:!s.length,l=e.inviteRecipients&&!e.inviteesList.length;if(n){var c={mode:"createCommentEntity",mailID:e.mailID,shareConversation:r,useConversation:o,zohoID:C.getCurrentZUID(),accountID:C.getCurrentAccountID(),inviteesList:e.inviteesList.join(","),lockInvites:e.lockInvites,mailList:s,inviteRecipients:l};u.ajaxPostRequest({url:m,data:c,requestID:["ajax",t].join("_")}).always(function(e){"success"===(e=e||{}).state?a.resolve(e.response):a.reject(e.reason)})}return a.promise()},updateConversationShare:function(e){var t=[(e=e||{}).mode,e.mailID].join(""),i=["deferred",t].join("_"),n=!d.has(i),a=d.get(i);if(n){var o={mode:e.mode,zohoID:C.getCurrentZUID(),accountID:C.getCurrentAccountID()};"unShareMailsInConversation"===e.mode?(e.conversationID&&(o.conversationID=e.conversationID),o.mailList=e.mailID):(o.mailID=e.mailID,o.shareType=!0),u.ajaxPostRequest({url:m,data:o,requestID:["ajax",t].join("_")}).always(function(e){"success"===(e=e||{}).state?a.resolve(e.response):a.reject(e.reason)})}return a.promise()},notifyDraftUpdate:function(e){var t=["notifyDraftUpdate",(e=e||{}).draftID].join(""),i=["deferred",t].join("_"),n=!d.has(i),a=d.get(i);if(n){var o={mode:"notifyDraftUpdate",draftID:e.draftID,zohoID:e.zohoID,accountID:e.accountID};u.ajaxPostRequest({url:m,data:o,requestID:["ajax",t].join("_")}).always(function(e){"success"===(e=e||{}).state?a.resolve(e.response):a.reject(e.reason)})}return a.promise()},unshareMails:function(e){var t=["unShareMailsInConversation",(e=e||{}).mailID].join(""),i=["deferred",t].join("_"),n=!d.has(i),a=d.get(i);if(n){var o={mode:"unShareMailsInConversation",mailID:e.mailID,zohoID:C.getCurrentZUID(),accountID:C.getCurrentAccountID(),conversationID:C.getConversationID()};u.ajaxPostRequest({url:m,data:o,requestID:["ajax",t].join("_")}).always(function(e){"success"===(e=e||{}).state?a.resolve(e.response):a.reject(e.reason)})}return a.promise()}}}(),function(){window.zmMailCollab=window.zmMailCollab||{};var i,e=window.zmMailCollab,L=zmMailCollab.Event,_=zmMailCollab.EventConstants,N=zmMailCollab.Util,y=zmMailCollab.Interface.Internal,R=y.getI18N,t=function(){return zdom("div",{className:"SCS_postWra js-collab-component"})},c=function(){var e=R("labels.dontShowAgain"),t=zdom("div",null,zdom("span",{"x-id":"message",className:"message"}),zdom("div",{style:{"margin-top":"20px"}},zdom("span",{"x-id":"checkbox-holder",style:{"margin-left":"5px",cursor:"pointer"}},zdom("i",{"x-id":"checkbox",className:"msi-uncheck",style:{"margin-right":"5px"}}),e)));return $.e(t).find(".message").dangerouslySetInnerHTML(R("messages.tipMessage")),t},o=function(){var e=R("messages.proceed"),t=R("labels.dontShowAgain");return zdom("div",null,zdom("div",{className:"paraDiv"},zdom("div",{"x-id":"message"}),zdom("div",null,e),zdom("div",null),zdom("div",null,zdom("span",{"x-id":"checkbox-holder",style:{cursor:"pointer"}},zdom("i",{"x-id":"checkbox",className:"msi-uncheck"}),t))))},w=(i={},{subscribe:function(e,t){$.unsubscribe(_.EXTERNAL_COMMENT_COMPONENT_RESIZE,i[e]),i[e]=t,$.subscribe(_.EXTERNAL_COMMENT_COMPONENT_RESIZE,t)}}),n=function(){var i,n=!1,e=$.e(c()),t=$.e(e).attr("id","share-mail-tip-dialog"),a=t.find("[x-id=checkbox]");t.find("[x-id]").removeAttr("x-id");var o=!1,s=function(e){o&&(y.turnOffMailShareTip(),o=!1,a.removeClass("msi-check").addClass("msi-uncheck")),e.remove()},r={title:R("labels.shareTipDialogTitle"),$content:t,closeAction:function(){n=!1},dialogWillMount:function(){a.off().on("click",function(){a.toggleClass("msi-check").toggleClass("msi-uncheck"),o=a.hasClass("msi-check")})}},l={default:[{name:R("labels.shareTipDialogOk"),callback:s}],forward:[{name:R("labels.shareTipDialogOk"),callback:s}]};return{show:function(e){if(i=e=e||{},!n){var t=i.mode||"default";"forward"!==t||i.containerDOM||(t="default"),r.buttons=l[t],Dialog.new(r)}}}}();e.Components={MailCollab:{create:function(M){M=M||{};var E={},g=$.e(t());M.isSmartCompose&&g.addClass("SC_DrftShr"),zmMailCollab.patch&&(!0!==M.isDraftShare?g.css("padding","10px 15px 0 20px"):g.css("padding","0"));var e,b,A,S=$.e((e=$.e(zdom("div",{className:"js-load-progress"})),y.createLoadingBand({container:e[0],type:"pagination"}),e[0]));$.e(g).appendDOM(S),S.hide();var T=!1,O=!1,z=function(){L.publish(_.COLLABCOMPONENT_INSTANCE_RESIZE,{instance:E})};return E.setData=function(e){e=e||{};for(var t,i,n,a,o,s,r,l,c,m,u=["zohoUserID","mailID","createEntity"],d=!1,C=0,D=u.length;C<D;C++){var f=u[C];if(!e.hasOwnProperty(f)){d=!0;break}}if(d)return N.log("Error","Required data missing for initialization",E,e),!1;if(e.createEntity)T=!1;else{if(!A){var v={by:(t=(t=e)||{}).zohoUserID,actionType:"viewSelfData",id:t.conversationID||t.mailID,etype:1,lockInvites:t.lockInvites,groupId:t.zohoUserID,showinvite:!0,like:t.selfLiked,invitee:Object.keys(t.inviteeIDList).length,likes:t.likeCount,privateToPost:!1,inviteeList:t.inviteeIDList,showInviteeList:!0,likeList:t.likeList,groupsMention:!0,mentionList:[],fixedComment:!0};A=zdom("div",null),g.prependDOM(A),y.createStreamsPostActionComponent(v,A),M.isDraftShare&&z()}T=!0}if(e.commentData){if(!b){e.resizeFn=z;var p=!0!==M.isDraftShare?(r=(s=(s=e)||{}).inviteeIDList?Object.keys(s.inviteeIDList):[],l=s.useConversation&&1<s.mailCount?R("labels.shareConversation"):R("labels.shareMail"),c=s.useConversation&&1<s.mailCount?R("placeholders.shareByMention"):R("placeholders.shareMailByMention"),(m={comments:s.commentData,total:s.commentData.totalCount,id:s.conversationID||s.mailID,isShare:!1,fixedComment:!1,mentions:[],groupsMention:!0,groupId:s.zohoUserID,etype:"1",owner:s.zohoUserID,sharedCall:!0,sharedApiCall:s.createEntity,hideComponent:N.isCommentBoxHidden(),placeHolder:{button:l,changeText:R("labels.sharing"),textArea:c},inviteeList:r,entityExists:!s.createEntity,miscData:{mailID:s.mailID,openedBy:s.openedBy,openedTab:s.openedTab},recipientList:s.recipientList,allowInvite:!s.lockInvites}).fixedComment=!0,m.fixedElement=$.e(s.parentElm).parent(),m.isNewCollabUser=!0,m.openedId=s.mailID,s.createEntity&&(m.createEntityDeferredCallback=s.createEntityDeferredCallback),m):(n=M,a=(i=e).inviteeIDList?Object.keys(i.inviteeIDList):[],o={isDraftShare:!0,comments:(i=i||{}).commentData,total:i.commentData.totalCount,id:i.mailID,isShare:!1,fixedComment:!1,mentions:[],groupsMention:!0,groupId:i.zohoUserID,etype:"1",owner:i.zohoUserID,sharedCall:!0,sharedApiCall:!1,placeHolder:{button:R("labels.shareDraft"),changeText:R("labels.sharing"),textArea:R("placeholders.shareDraftByMention")},entityExists:!i.createEntity,miscData:i.miscData||{mailID:i.mailID},resizeComment:i.resizeFn,inviteeList:a},n.isSmartCompose&&(o.fixedComment=!0,o.fixedElement=$.e(n.containerDOM).parent(),o.isNewCollabUser=!0),i.createEntity&&(o.createEntityDeferredCallback=i.createEntityDeferredCallback),o);if(!M.isDraftShare||M.isSmartCompose&&M.isDraftShare){(b=y.createStreamsCommentComponent(p,g)).find(".zms_fixed").addClass("zmCmntFixed ").data("openType",e.openedBy).data("openedTab",e.openedTab);var I=b.find("textarea.zms_cmTxt");M.isSmartCompose&&M.isDraftShare||!e.useConversation||!N.isConversationFalse(e)||!e.createEntity||1!==b.parent().find(".js-shareicon").length?M.isSmartCompose&&M.isDraftShare&&M.commentFocused&&I.focus(function(){M.commentFocused()}):(I.addClass("focusin"),I.focus(function(){!b.parent().find(".js-shareicon").hasClass("sld")&&I.hasClass("focusin")&&b.parent().find(".js-shareicon").click(),I.removeClass("focusin")}))}else b=$.e(y.createStreamsCommentComponent(p)),$.e(g).appendDOM(b),b.hide();zmMailCollab.patch&&(b.find(".zm_inclr").css("user-select","none"),b.find(".zm_inclr").css("-webkit-user-select","none"),b.find(".zm_inclr").css("vertical-align","middle"),b.find(".zm_inclr").find("i:first").css("vertical-align","middle").css("margin-right","3px"),b.find(".zm_inclr").find("div:first").css("vertical-align","middle").css("display","inline-block").css("cursor","pointer")),(zmMailCollab.globalPatch||zmMailCollab.patch)&&(b.find(".zm_inclr").find("div:first").on("click",function(){b.find(".zm_inclr").find("i:first").trigger("click")}),b.find(".zm_inclr").find("div:first").text(R("messages.includeRecipients"))),M.isDraftShare&&(w.subscribe(e.mailID,z),z(),g.find(".sc_cmdv").addClass("SCS_draftCmnt"))}O=!0}else O=!1;var h=!(T||O);return E.setProgress(h).done(function(){var e=[$.Deferred(),$.Deferred()];b&&(O?b.fadeIn(50,e[1].resolve):b.fadeOut(50,e[1].resolve)),M.isDraftShare&&(e[0].done(z),e[1].done(z))}),g.prependDOM(S),L.publish(_.COLLABCOMPONENT_INSTANCE_DATA_SET,{instance:E}),M.isDraftShare&&z(),!0},E.show=function(e){e=e||{};var t=$.Deferred();return!1===e.animation?(g.show(),t.resolve()):g.fadeIn(50,t.resolve),e.isDraftShare&&t.done(z),t},E.focus=function(e){(e=e||{}).suppressScroll||g[0].scrollIntoView(),g.focus(),g.find("textarea").focus()},E.highlight=function(){var e=g.find(".zmCmntFixed"),t=g.find("textarea").parent(".zm_mention")[0];_zm.hasClass(e[0],"highlightClass")&&_zm.hasClass(t,"highlightClass")||(e.addClass("highlightClass"),_zm.addClass(t,"highlightClass"),setTimeout(function(){e.removeClass("highlightClass"),_zm.removeClass(t,"highlightClass")},5e3))},E.hide=function(e){e=e||{};var t=$.Deferred();return!1===e.animation?(g.hide(),t.resolve()):g.fadeOut(50,t.resolve),e.isDraftShare&&t.done(z),t},E.remove=function(){g.remove(),M.isDraftShare&&z()},E.getDOM=function(){return g[0]},E.appendDOM=function(e){$.e(e).appendDOM(g),M.isDraftShare&&z()},E.setProgress=function(e){var t=$.Deferred();return!1===e?S.is(":visible")?S.fadeOut(50,t.resolve):(S.hide(),t.resolve()):!0===e&&S.fadeIn(50,t.resolve),M.isDraftShare&&t.done(z),t.promise()},E.hide(),L.publish(_.COLLABCOMPONENT_INSTANCE_CREATED,{instance:E}),E}},MailShareTipDialog:{show:n.show},ConversationShareAlertDialog:{create:function(c){c=c||{};var e=["conversation-share-alert-dialog",String(Date.now())].join("_"),m=$.Deferred(),t=$.e(o()).attr("id",e),u=t.find("[x-id=message]"),d=t.find("[x-id=checkbox-holder]"),C=t.find("[x-id=checkbox]"),i=!1;t.find("[x-id]").removeAttr("x-id");var n=function(e){e.remove()},a=function(){i&&(y.turnOffShareWarning(),i=!1,C.removeClass("msi-check").addClass("msi-uncheck"))},D=function(){C.toggleClass("msi-check").toggleClass("msi-uncheck"),i=C.hasClass("msi-check")},f={title:R("labels.shareDialogTitle"),closeAction:function(e){m.reject()},$content:t},v=[{name:R("labels.dialogOkay"),callback:function(e){a(),m.resolve(),n(e)}},{name:R("labels.dialogCancel"),callback:function(e){a(),m.reject(),n(e)},isCancel:!0}];return{show:function(){if(!c.mailCount||!c.senderList)return m.reject(),m.promise();var n=c.senderList||[],a=!1;if(n.forEach(function(e,t){var i=function(e){var t,i,n;if(e=(e||"").trim().toLowerCase())return i=e.indexOf("<"),n=e.indexOf(">"),-1<i&&-1<n&&(t=e.substring(i+1,n)),t}(e);y.isCurrentUserEmail(i)&&(a=!0,n.splice(t,1))}),a&&n.push(R("labels.yourself")),1<n.length){var e=n.splice(n.length-1,1)[0];n=[n=n.join(", "),"&",e].join(" ")}else 1===n.length&&(n=n[0]);n=y.replaceHTMLEntities(n||"");var t=R("messages.shareDialogMessage",{mailCount:c.mailCount,senderList:n}),i=$.e(zdom("div",null)).dangerouslySetInnerHTML(t),o="",s={SINGLE_MAILS:R("listingTypes.noConversations"),FOLDER_MAILS:R("listingTypes.folderSpecific"),ALL_MAILS:R("listingTypes.acrossFolder")},r="";if(y.isPartialConversationView()){var l=s[y.getCurrentConversationViewType()];r=R("messages.partialConversationView",{listingMode:l})}return u.appendDOM(i),r&&(o=$.e(zdom("div",null)).dangerouslySetInnerHTML(r),u.appendDOM(o)),d.hide(),C.hide(),d.off().on("click",D),f.buttons=v,Dialog.new(f),m.promise()}}}}}}(),function(){window.zmMailCollab=window.zmMailCollab||{};var e,t=window.zmMailCollab,i=zmMailCollab.EventConstants,d=zmMailCollab.Interface.Internal,n=zmMailCollab.Components.MailShareTipDialog,v=d.getI18N,a=function(e,t){if(t=t||{},"off"!==d.getMailShareTipState()){var i=d.getMailMetaData(t.mailID)||{};(t.mailID||"forward"!==t.mode)&&(t.suppressComponentCheck=!0,t.folderID=i.FD,t.folderData=d.getFolderData(t.folderID)||{},zmMailCollab.Util.isSharingValid(t)&&"-1"!==zmail.zoid&&n.show(t))}},C=function(e){if(e)return{zohoUserID:d.getCurrentZUID(),mailID:e.mailID,conversationID:e.useConversation&&e.conversationID?e.conversationID:e.mailID,useConversation:e.useConversation,createEntity:!e.entityExists,commentData:e.commentData,selfLiked:-1!==e.likeList.indexOf(d.getCurrentZUID()),likeCount:e.likeList.length,inviteeIDList:e.inviteeList,mailCount:e.conversationData.mailCount,lockInvites:e.lockInvites,likeList:e.likeList,recipientList:e.recipientList,openedBy:e.openedBy,openedTab:e.openedTab}},o=function(e,t){var n=(t=t||{}).deferred||$.Deferred(),a=zmMailCollab.Event,o=zmMailCollab.EventConstants;if(!t.draftID)return n.reject({code:0,message:"Invalid params"}),n.promise();if(t.suppressComments)return n.reject({code:1,message:"User suppressed",suppressError:!0}),n.promise();var i=zmMailCollab.Model.MailShareData,s=zmMailCollab.Collection.MailShareData,r=zmMailCollab.Components.MailCollab,l=i.create({mailID:t.draftID,useConversation:!1});l=s.get(l);var c=r.create({isDraftShare:!0,isSmartCompose:t.isSmartCompose,containerDOM:t.containerDOM});t.containerDOM?c.appendDOM(t.containerDOM):"function"==typeof t.appendCallback&&t.appendCallback({jqDOM:$.e(c.getDOM())});var m={mailID:t.draftID,uploadCallback:function(){"function"==typeof t.onResize&&t.onResize({draftID:t.draftID,context:t.context})}};return d.loadStreamsModule().then(function(){c.setProgress(!0),c.show();var i=C(l);i.createEntity&&(i.createEntityDeferredCallback=function(e){(e=e||{}).mentions=(e.mentions||"").trim();var t=e.mentions.length?e.mentions.split(","):[];return d.createCommentEntity({mailID:i.mailID,shareConversation:!1,useConversation:!1,inviteRecipients:!1,lockInvites:e.lockInvites,inviteesList:t,isDraftShare:!0}).promise()}),i.miscData=m,c.setData(i),a.subscribe(o.MAILSHAREDATA_PROPERTY_CHANGED,function(e,t){l===(t=t||{}).instance&&"entityExists"===t.property&&!0===t.value&&((i=C(l)).miscData=m,c.setData(i))}),n.resolve({focusComments:function(){c.focus({suppressScroll:!0})},jqDOM:$.e(c.getDOM())})}),n.promise()},s=function(e,t){var i=(t=t||{}).deferred||$.Deferred();if(!t.draftID)return i.reject({code:0,message:"Invalid params"}),i.promise();if(t.suppressComments)return i.reject({code:1,message:"User suppressed",suppressError:!0}),i.promise();var n=zmMailCollab.Model.MailShareData,a=zmMailCollab.Collection.MailShareData,o=n.create({mailID:t.draftID,useConversation:!1});a.put(o,{overwrite:!0}),o.initialize().done(function(){var e=o.getCommentData()||{};i.resolve({success:!0,entityExists:o.getEntityExists(),context:t.context,count:e.totalCount})})},r=function(e,t){t=t||{};var i=zmMailCollab.Util;if(!t.suppressComments)if(t.mailID||t.containerDOM){if(t.useConversation=!t.hasOwnProperty("useConversation")||t.useConversation,i.isSharingValid({containerDOM:t.containerDOM,folderID:t.folderID,folderData:t.mailID===t.conversationID&&d.getFolderData(t.folderID)||{}})){var n=zmMailCollab.Model.MailShareData,a=zmMailCollab.Collection.MailShareData,o=zmMailCollab.Collection.MailShareData.get(t);if(!o||t.commentValue!==o.commentValue||o.entityExists){var s=n.create({mailID:t.mailID,useConversation:t.useConversation,conversationID:t.conversationID,lockInvites:t.lockInvites,commentValue:t.commentValue,recipientList:t.recipientList});s.initialize(),a.put(s,{overwrite:!0})}}}else i.log("Invalid params")},l=function(e,t){var r=zmMailCollab.Util;if(r.isSharingValid({containerDOM:t.containerDOM,folderID:t.folderID,folderData:t.mailID===t.conversationID&&d.getFolderData(t.folderID)||{}})){var i=zmMailCollab.Collection.CollabContainer,n=zmMailCollab.Event,a=zmMailCollab.EventConstants,o=zmMailCollab.Model.MailShareData,l=zmMailCollab.Components.MailCollab.create(),s=zmMailCollab.Model.CollabContainer,c=i.getWithDOM({containerDOM:$.e(t.containerDOM)[0]}),m=s.create({mailID:t.mailID,useConversation:t.useConversation,conversationID:t.conversationID,containerDOM:$.e(t.containerDOM)[0],component:l,commentValue:t.commentValue,openType:t.openedBy,openedTab:t.openedTab});i.removeAll(c),i.put(m),d.loadStreamsModule().then(function(){l.setProgress(!0),l.appendDOM(t.containerDOM),l.show();var s=zmMailCollab.Collection.MailShareData.get(t),e=!0;s?s.mailID=t.mailID:(s=o.create({mailID:t.mailID,useConversation:t.useConversation,conversationID:t.conversationID,lockInvites:t.lockInvites,commentValue:t.commentValue,recipientList:t.recipientList}),zmMailCollab.Collection.MailShareData.put(s,{overwrite:!0}),e=!1);s.openedBy=t.openedBy,s.openedTab=r.getCurrentTab(t.openedTab),s.initialize({delay:t.commentLoadDelay}).done(function(){if(!r.isValidContainer(t.containerDOM,s))return r.log("SHARING_INVALID","wrong container loaded"),i.remove(t.containerDOM),!1;var o=C(s);(o.parentElm=t.containerDOM,o.createEntity&&(o.createEntityDeferredCallback=function(e){(e=e||{}).mentions=(e.mentions||"").trim(),e.includeRecipients=e.includeRecipients||!1,e.selectedMailIds=e.selectedMailIds||[];var t=e.mentions.length?e.mentions.split(","):[],i=e.selectedMailIds.length?r.sortMailIds(e.selectedMailIds,s.conversationData):[],n=d.createCommentEntity({mailID:o.mailID,shareConversation:Boolean(s.useConversation&&s.conversationID),useConversation:s.useConversation,inviteRecipients:e.includeRecipients,inviteesList:t,lockInvites:e.lockInvites,senderList:s.conversationData.senderList,mailCount:s.conversationData.mailCount,mailList:i}),a=s.useConversation&&1<s.conversationData.mailCount;return n.done(function(){r.showSuccessMessage(v(a?"messages.conversationShareSuccess":"messages.mailShareSuccess")),r.updateMailCache(o.mailID)}),n.promise()}),l.setData(o),n.subscribe(a.MAILSHAREDATA_PROPERTY_CHANGED,function(e,t){s===(t=t||{}).instance&&"entityExists"===t.property&&!0===t.value&&(o=C(s),l.setData(o))}),e)&&zmMailCollab.Event.publish(a.MAILSHAREDATA_PROPERTY_CHANGED,{containerDOM:s.containerDOM,property:"sharedUptoTime",instance:s,mailID:s.mailID})}).fail(function(e){(e=e||{}).suppressError||r.showErrorMessage(v("messages.cantLoadComments")),r.log("Cannot load comment data for mail",t.mailID,t.containerDOM)})})}},c=function(e,n){n=n||{};var t=zmMailCollab.Event,a=zmMailCollab.EventConstants,i=zmMailCollab.Util,o=n.deferred||$.Deferred();if(!_zm.isStreamsEnabled())return o.reject({code:2,message:v("messages.streamsDisabled")}),o.promise();if(!n.draftID)return o.reject({code:0,message:"Invalid params"}),o.promise();if(n.suppressComments)return o.reject({code:1,message:"User suppressed",suppressError:!0}),o.promise();var s=zmMailCollab.Model.MailShareData,r=zmMailCollab.Collection.MailShareData,l=zmMailCollab.Components.MailCollab,c=s.create({mailID:n.draftID,useConversation:!1,isDraftShare:!0}),m=l.create({isDraftShare:!0,isSmartCompose:n.isSmartCompose,containerDOM:n.containerDOM,commentFocused:n.commentFocused});n.containerDOM?m.appendDOM(n.containerDOM):"function"==typeof n.appendCallback&&n.appendCallback({jqDOM:$.e(m.getDOM())}),n.isSmartCompose||t.subscribe(a.COLLABCOMPONENT_INSTANCE_RESIZE,function(e,t){(t=t||{}).instance===m&&"function"==typeof n.onResize&&(i.log("Calling onResize() of compose...",n),n.onResize({draftID:n.draftID,context:n.context}))}),r.put(c,{overwrite:!0}),c.initialize();var u={mailID:n.draftID,uploadCallback:function(){"function"==typeof n.onResize&&n.onResize({draftID:n.draftID,context:n.context})}};return d.loadStreamsModule().then(function(){m.setProgress(!0),m.show(),c.initialize().done(function(){var i=C(c);i.createEntity&&(i.createEntityDeferredCallback=function(e){(e=e||{}).mentions=(e.mentions||"").trim();var t=e.mentions.length?e.mentions.split(","):[];return d.createCommentEntity({mailID:i.mailID,shareConversation:!1,useConversation:!1,inviteRecipients:!1,lockInvites:e.lockInvites,inviteesList:t,isDraftShare:!0}).promise()}),i.miscData=u,m.setData(i),t.subscribe(a.MAILSHAREDATA_PROPERTY_CHANGED,function(e,t){c===(t=t||{}).instance&&"entityExists"===t.property&&!0===t.value&&((i=C(c)).miscData=u,m.setData(i))});var e=c.getCommentData()||{};o.resolve({success:!0,entityExists:c.getEntityExists(),focusComments:function(){m.focus({suppressScroll:!0})},highlightComment:function(){m.highlight()},jqDOM:$.e(m.getDOM()),context:n.context,count:e.totalCount})}).fail(function(e){(e=e||{}).success=!1,o.reject(e),i.log("Cannot load comment data for draft",n.mailID,n.containerDOM)})}),o.promise()},m=function(e,t){t=t||{};var i=zmMailCollab.Backend;t.deferred=t.deferred||$.Deferred(),t.draftID&&t.zohoID&&t.accountID?i.notifyDraftUpdate({draftID:t.draftID,zohoID:t.zohoID,accountID:t.accountID}).done(function(e){t.deferred.resolve(e)}).fail(function(e){t.deferred.reject(e)}):t.deferred.reject({code:0,message:"Invalid params"})},u=function(e,t){(t=t||{}).config=t.config||{};var i=zmMailCollab.Util;t.config.allowed=i.isSharingValid(t);var n=zmMailCollab.Collection.CollabContainer.getWithDOM({containerDOM:t.container[0]})[0];if(t.config.allowed&&n){var a=zmMailCollab.Collection.MailShareData.get({mailID:n.getMailID(),conversationID:n.getConversationID(),useConversation:n.getUseConversation()}),o=a.entityExists;if(t.config.entityExists=o,t.config.isConvo=n.getUseConversation(),o){var s=a.getSharedMailIds();t.config.sharedText=s&&-1!==s.indexOf(t.mailID)?v("tooltips.unshare"):v("tooltips.shareConvo")}}},D=function(e,o){o=o||{};var s=zmMailCollab.Util;if(s.log("Update share icon clicked !",o),o.containerDOM&&o.mailID){var t=zmMailCollab.Backend,r=zmMailCollab.Collection.MailShareData,l=zmMailCollab.Collection.CollabContainer,c=l.getWithDOM({containerDOM:o.containerDOM})[0];if(c){if(c.getUpdateOperationPending())return s.showErrorMessage(v("messages.updateShareInProcess")),void s.log("Already an update operation is pending...");var m="updateConversationShare";$.e(o.elm).hasClass("shd")&&c.getUseConversation()&&(m="unShareMailsInConversation");var i=r.get({mailID:c.getMailID(),conversationID:c.getConversationID(),useConversation:c.getUseConversation()}),n=zmMailCollab.EventConstants;if(o.elm&&!$.e(o.elm).data("shared")&&!i.entityExists)return $.e(o.elm).toggleClass("sld"),o.mode=$.e(o.elm).hasClass("sld")?"add":"remove",void $.publish(n.MAILSHAREDATA_SELECTMAIL,o);if(!i)return s.showErrorMessage(v("messages.updateShareNoData")),void s.log("Mailshare data was not available...");var a=(i.getConversationData()||{}).mailReceiveTime||{},u=i.getSharedUptoTime(),d=a[o.mailID];u&&d&&d<=u&&!i.getSharedMailIds().length&&"unShareMailsInConversation"!==m||(c.setUpdateOperationPending(!0),t.updateConversationShare({mailID:o.mailID,mode:m,conversationID:c.conversationID}).done(function(e){if((e=e||{}).lastReceiveTime||"updateConversationShare"!==m){c=l.getWithDOM({containerDOM:o.containerDOM})[0];var t=r.get({mailID:o.mailID,useConversation:c.useConversation,conversationID:c.conversationID});if(t){var i,n=t.getSharedMailIds();i="updateConversationShare"===m?(n.push(o.mailID),v("tooltips.unshare")):(n.splice(n.indexOf(o.mailID),1),v("tooltips.shareConvo")),$.e(o.elm).attr("title",i),t.setSharedMailIds(n)}if(o.elm){var a="updateConversationShare"===m?"addClass":"removeClass";$.e(o.elm)[a]("shd")}s.showSuccessMessage(v("messages.updateShareSuccess")),s.log("Update share success",t)}}).fail(function(e){s.showErrorMessage(v("messages.updateShareError")),s.log("Update share error",e)}).always(function(){c.setUpdateOperationPending(!1)}))}else s.log("container component empty check if from streams side...")}else s.log("Update share error. Params missing.")},f=function(e,t){t=t||{};var i=zmMailCollab.Collection.CollabContainer,n=zmMailCollab.Util;if(t.containerDOM){t.workspaceID&&d.switchToApp(t.workspaceID);var a=i.getWithDOM({containerDOM:$.e(t.containerDOM)[0]});n.isCommentBoxHidden()&&$.e(t.containerDOM).find(".SCS_postWra").show().find(".SCS_cmnt").show(),a.forEach(function(e){e.getComponent().focus()})}else n.log("Cannot handle component focus without ContainerDOM reference")},p=function(e,t){if(-1!==["entityExists","sharedUptoTime"].indexOf((t=t||{}).property)){var i,n=zmMailCollab.Collection.CollabContainer,o=zmMailCollab.EventConstants,s=t.instance,a=n.getWithData({mailID:s.getMailID(),useConversation:s.getUseConversation(),conversationID:s.getConversationID()}),r=s.getSharedMailIds(),l=s.getConversationData(),c=l.mailReceiveTime||{},m=s.getSharedUptoTime(),u=l.mailIds;if(u=s.getUseConversation()?u:[s.mailID],!r.length)for(i in c)c[i]<=m&&r.push(i);var d=-1,C=1,D=0,f={disabled:"",shared:v("tooltips.sharedMail"),notshared:v("tooltips.unsharedMail"),singleMailShare:v("tooltips.singleMailShare")};a.forEach(function(e){for(var t,i=0;i<u.length;i++){t=u[i];var n=d,a=f.disabled;a=r&&-1!==r.indexOf(t)?(n=C,v("tooltips.unshare")):r.length?(n=D,v("tooltips.shareConvo")):(n=D,f.singleMailShare),$.publish(o.EXTERNAL_MAIL_PREVIEW_UPDATE_SHAREICON,{containerDOM:e.getContainerDOM(),mailID:t,state:n,tooltip:a,entityExists:s.getEntityExists()})}})}},I=function(e,t){t=t||{};var i=zmMailCollab.Collection.MailShareData,n=zmMailCollab.Util,a=t.instance;if(!a&&t.mailID&&(a={mailID:t.msgId,conversationID:t.thdId,useConversation:t.thdId&&""!==t.thdId}),a){var o=i.get({mailID:a.mailID,conversationID:a.conversationID,useConversation:a.useConversation});o&&(n.log("Data Initialize cancelled. Because new component loaded in same container... ",o),o.abortInit())}},h=function(e,t){t=t||{};var i=zmMailCollab.Util;t.conversationID&&i.log("Single mail converted into thread",t.conversationID)},M=function(e){zmMailCollab.Util.resetBottom(zmsuite.getCenter("zm_Container")[1].$el)};e=zmMailCollab.Event,$.subscribe(i.EXTERNAL_MAIL_FORWARD_EVENT,a),$.subscribe(i.EXTERNAL_COMPOSE_BCC_EVENT,a),$.subscribe(i.EXTERNAL_MAIL_OPENING_EVENT,r),$.subscribe(i.EXTERNAL_MAIL_OPENED_EVENT,l),$.subscribe(i.EXTERNAL_DRAFT_OPENED_EVENT,c),$.subscribe(i.EXTERNAL_DRAFT_OPENING_EVENT,s),$.subscribe(i.EXTERNAL_DRAFT_COMMENT_CONSTRUCT_EVENT,o),$.subscribe(i.EXTERNAL_DRAFT_NOTIFY_UPDATES_EVENT,m),$.subscribe(i.EXTERNAL_MAILCOLLAB_SHARE_STATUS,u),$.subscribe(i.EXTERNAL_MAIL_VIEW_FOCUSCOMMENT,f),$.subscribe(i.EXTERNAL_MAIL_PREVIEW_UPDATE_SHARE,D),$.subscribe(i.EXTERNAL_MAIL_THREAD_CREATED,h),$.subscribe(i.EXTERNAL_MAIL_CLOSE_PREVIEW,M),$.subscribe(i.EXTERNAL_MAIL_CHANGE_PREVIEW,I),e.subscribe(i.MAILSHAREDATA_PROPERTY_CHANGED,p),e.subscribe(i.COLLECTION_COLLABCOMPONENT_INSTANCE_REMOVED,I),zmMailCollab.reqPatch=!0}();
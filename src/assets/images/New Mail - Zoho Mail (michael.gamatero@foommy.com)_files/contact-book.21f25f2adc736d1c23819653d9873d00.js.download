"use strict";(function(t){var e=t("zmail.Utils.EmailValidator");this.isEmailID=function(){var t=e.validate.apply(this,arguments)||{};return!0===t.status};var o,s,i=/^\d+$/;this.isNumber=function(t){return i.test(t)},this.initials=function(t){t=t||"";var e=(t=$.trim(t)).split(/\s+/);return 2<=e.length?e[0][0]+e[1][0]:((t=e[0])[0]||"")+(t[1]||"")},this.colorClasses=(o=["avtrBg1","avtrBg2","avtrBg3","avtrBg4","avtrBg5","avtrBg6","avtrBg7"],s={},function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=t.text;if(e=(e||"").toLowerCase().trim()){if(s[e])return s[e];var i=0,r=0,n=0;return e.split("").forEach(function(t,e){e%0?r+=t.charCodeAt(0):i+=t.charCodeAt(0)}),n=Math.abs(r-i),s[e]=o[n%o.length],s[e]}return o[Math.floor(Math.random()*o.length)]})}).call(zmail.Core.Namespaces.create("zmail.ContactBook.Utils"),zmail.Core.Namespaces.get),function(){this.CONTACTS_TYPES={ZOHO:"zoho",ZOHO_ORG:"org",PERSONAL:"personal",CRM:"crm"},this.CATEGORY_TYPES={ORG:"org",PERSONAL:"personal"},this.EVENTS={GROUP_ADDED:"CONTACT_BOOK_GROUP_ADDED",GROUP_REMOVED:"CONTACT_BOOK_GROUP_REMOVED",GROUP_CHANGED:"CONTACT_BOOK_GROUP_CHANGED",GROUP_MEMBERS_ADDED:"CONTACT_BOOK_GROUP_MEMBERS_ADDED",GROUP_MEMBERS_REMOVED:"CONTACT_BOOK_GROUP_MEMBERS_REMOVED",GROUP_MODERATORS_ADDED:"CONTACT_BOOK_GROUP_MODERATORS_ADDED",GROUP_MODERATORS_REMOVED:"CONTACT_BOOK_GROUP_MODERATORS_REMOVED"},this.MODES={MOST_USED:"500",ZUID:"zuid",EMAIL_ID:"200",CATEGORY_ID:"300",SEARCH:"query",STREAM_GROUPS:"groups",STREAM_GROUP_MEMBERS:"groupid",ORG_MEMBERS:"orgdata",IS_ORG:"isorg"}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Constants")),function(t){var e,c=t("_"),u=zmail.Utils.DOM;this.avatarInitials=function(t){var e=u.element(zdom("span",null));return e.text(t),e},this._avatarImageLoader=(e=null,function(){return e||(e=zmail.Utils.Image.createThrottledLoader({storeRequests:!0,maxRequests:24})),e}),this.avatar=function(t){var e,i,r=(t=t||{}).$avatar||u.element(zdom("div",{className:"SC_avtr"})),n=t.avatarBgColor,o=this._avatarImageLoader();if(!0===t.isValidPhoto)(e=t.$img||u.element(zdom("img",{style:{visibility:"hidden"}}))).attr("src",t.photo),u.mount(e,r),o.load(t.photo).done(function(){e.css({visiblity:"visible",display:""}),e.attr("src",t.photo),e.removeAttr("style")});else if(!1===t.isValidPhoto)r.addClass(n),u.mount(this.avatarInitials(t.initials),r);else{var s=t.onLoad||c.noop,a=t.onError||c.noop;e=u.element(zdom("img",{style:{visibility:"hidden"}})),u.mount(e,r),i=this.avatarInitials(t.initials),u.mount(i,r),r.addClass(n),o.load(t.photo).done(function(){s(),e.css({visiblity:"visible",display:"none"}),e.fadeIn({duration:100,complete:i.remove}),e.attr("src",t.photo),e.removeAttr("style")}).fail(function(){a(),r.addClass(n),e.remove()})}return r},this.label=function(t){var e=u.element(zdom("span",{className:"SC_crmStamp"}));return e.text(t),e},this.card=function(t){var e=u.element(zdom("div",{className:"zmConData"},zdom("div",null,zdom("strong",{className:"js-name"})),zdom("div",null,zdom("span",{className:"js-desc"}))));if(t.name&&e.find(".js-name").text(t.name),t.nameLabel&&u.mount(this.label(t.nameLabel),e.find(".js-name").parent()),t.desc&&e.find(".js-desc").text(t.desc),t.descLabel&&u.mount(this.label(t.descLabel),e.find(".js-desc").parent()),t.type){var i=u.element(zdom("span",{className:"zmCLCategory zmFR js-contact-type-badge"}));i.text(t.typeTxt),u.mountBefore(i,e.find(".js-name"))}return e}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Templates"),zmail.Core.Namespaces.get),function(){var e=this.RequestLog=function(t){if(!(this instanceof e))return new e(t);t=t||{},this.logs=t.logs||{},this.delimiter=t.delimiter||"$:$"};e.prototype={hash:function(t){return[t.str||"",t.ids||"",t.typ||""].join(this.delimiter)},add:function(t){return t.hash=this.hash(t),this.logs[t.hash]=t,this},getLog:function(t){var e=this.hash(t);return this.logs[e]},getSuperSetLog:function(t){for(var e,i=t.str,r=i.length,n=1;n<r;n++)if((e=this.hash({str:i.substring(0,r-n),ids:t.ids,typ:t.typ}))in this.logs)return this.logs[e]},get:function(t){var e=this.getLog(t);return e||(e=this.getSuperSetLog(t)),e}}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Logs")),function(n){var s=n("_"),a=n("zmail.zoid"),c=n("zmail.ContactBook.Utils"),o=n("zmail.ContactBook.Templates"),u=zmail.Utils.DOM,t=["fn","ln","fn_ln","fn_mn_ln","nn","mn"],d=["fn","ln","fn_ln","fn_mn_ln","nn","mn","eid"],l=["zid","eid","fn","mn","ln","nn","photo"],e=this.Contact=function(t){if(!(this instanceof e))return new e(t);this.init(t)};e.prototype={defaults:function(){return{zid:void 0,eid:void 0,g:void 0,fn:"",mn:"",ln:"",nn:"",photo:void 0,isPrimary:void 0}},defineProperties:function(){var t,e,i,r,n=c.colorClasses({text:this.attrs.eid||this.attrs.fn}),o=this.attrs,s=this;return Object.defineProperties(this,{id:{get:function(){return o.zid||o.eid},enumerable:!1,configurable:!1},zoid:{get:function(){return i},set:function(t){i=t}},type:{get:function(){return e},set:function(t){e=t}},isValidPhoto:{get:function(){return r},set:function(t){r=t}},initials:{get:function(){return t}},isOrg:{get:function(){return s.zoid===a}},name:{get:function(){return[o.fn||"",o.mn||"",o.ln||""].join(" ").trim()||o.nn||""}},avatarBgColor:{get:function(){return n}}}),t=c.initials(this.name),this.photoOnLoad=this.photoOnLoad.bind(this),this.photoOnError=this.photoOnError.bind(this),this},get:function(t){return this.attrs[t]},avoidDuplicates:function(){var i=this.attrs,r={};return t.forEach(function(t){var e=i[t];e in r&&(i[t]=""),r[e]=1}),this},init:function(t){this.attrs={},t.fn=(t.fn||"").trim(),t.ln=(t.ln||"").trim(),t.mn=(t.mn||"").trim(),t.nn=(t.nn||"").trim(),t.eid=(t.eid||"").trim();var e=(t.fn||"").trim(),i=(t.mn||"").trim(),r=(t.ln||"").trim(),n="",o="";e&&r&&(n=e+" "+r),e&&i&&r&&(o=e+" "+i+" "+r),s.extend(this.attrs,this.defaults(),t,{fn_ln:n,fn_mn_ln:o}),this.defineProperties().avoidDuplicates()},equals:function(t){if(this===t)return!0;var e=this.attrs,i=t.attrs;return s(l).all(function(t){return e[t]===i[t]})},isPrimary:function(){return!0===this.get("isPrimary")},isMergeable:function(t){var r=this.attrs,n=t.attrs;return s(l).all(function(t){var e=r[t],i=n[t];return s.isEmpty(e)||s.isEmpty(i)||e===i})},merge:function(t){var e=this.attrs,i=t.attrs;return l.forEach(function(t){s.isEmpty(e[t])&&!s.isEmpty(i[t])&&(e[t]=i[t])}),this},toJSON:function(){return this.attrs},photo:function(t){if(!t||s.isEmpty(this.attrs.photo))return this.attrs.photo;var e=this.attrs.photo,i="?";return-1!==e.indexOf("?")&&(i="&"),e+i+"API=true"},photoOnLoad:function(){this.isValidPhoto=!0},photoOnError:function(){this.isValidPhoto=!1},avatar:function(t){return t=t||{},t=s.extend({isValidPhoto:this.isValidPhoto,onLoad:this.photoOnLoad,onError:this.photoOnError,photo:this.photo(!0),initials:this.initials,avatarBgColor:this.avatarBgColor},t),o.avatar(t)},view:function(t,e){if(e=e||{},(e=s.extend({name:t&&this.getMatchingName(t)||this.name,desc:this.attrs.eid,type:"crm"===this.type},e)).type){var i=n("zmText");e.typeTxt=i.get("contact-book").contact.typeTxt}var r=zdom("div",{className:"zmConWra"});return u.mountAtEnd(this.avatar(e),r),u.mountAtEnd(o.card(e),r),r},_getMatchingName:function(t,e){t=t.toLowerCase();for(var i=this.attrs,r=0;r<d.length;r++){var n=i[d[r]]||"",o=n&&n.toLowerCase().indexOf(t);if(e&&0===o||!e&&-1!==o)return n}},getMatchingName:function(t){return!s.isEmpty(t)&&this._getMatchingName(t,!0)||this._getMatchingName(t)}}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity"),zmail.Core.Namespaces.get),function(t){var i=t("_"),r=t("zmail.ContactBook.Templates"),e=t("zmail.ContactBook.Constants.CATEGORY_TYPES"),n=this.Category=function(t){if(!(this instanceof n))return new n(t);this.init(t)};n.prototype={defaults:function(){return{attrs:{cid:void 0,cname:void 0,type:void 0}}},defineProperties:function(){var t=this.attrs;Object.defineProperties(this,{id:{get:function(){return t.cid},enumerable:!1,configurable:!1}})},init:function(t){i.extend(this,this.defaults()),i.extend(this.attrs,t),this.defineProperties()},get:function(t){return this.attrs[t]},isOrg:function(){return this.get("type")===e.ORG},set:function(t,e){return this.attrs[t]=e,this},view:function(t,e){return e=e||{},e=i.extend({name:this.get("cname"),nameLabel:"category"},e),r.card(e)}}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity"),zmail.Core.Namespaces.get),function(t){var r=t("_"),n=t("zmail.ContactBook.Utils"),o=t("zmail.ContactBook.Templates"),s=t("zmail.Utils.DOM"),e=this.Group=function(t){if(!(this instanceof e))return new e(t);this.init(t)};e.prototype={defaults:function(){return{attrs:{}}},defineProperties:function(){var e,t=this.attrs,i=n.colorClasses({text:this.get("name")}),r=n.initials(this.get("name"));Object.defineProperties(this,{id:{get:function(){return t.id},enumerable:!1,configurable:!1},isValidPhoto:{get:function(){return e},set:function(t){e=t}},initials:{get:function(){return r},set:function(t){r=t}},avatarBgColor:{get:function(){return i}}}),this.photoOnLoad=this.photoOnLoad.bind(this),this.photoOnError=this.photoOnError.bind(this)},init:function(t){r.extend(this,this.defaults()),r.extend(this.attrs,t),this.defineProperties()},get:function(t){return this.attrs[t]},set:function(t,e){return this.attrs[t]=e,"name"===t&&this.setInitials(),this},setInitials:function(){return this.initials=n.initials(this.get("name")),this},photo:function(t){if(!t||r.isEmpty(this.attrs.photo))return this.attrs.photo;var e=this.attrs.photo,i="?";return-1!==e.indexOf("?")&&(i="&"),e+i+"API=true"},photoOnLoad:function(){this.isValidPhoto=!0},photoOnError:function(){this.isValidPhoto=!1},avatar:function(t){return t=t||{},t=r.extend({isValidPhoto:this.isValidPhoto,onLoad:this.photoOnLoad,onError:this.photoOnError,photo:this.photo(!0),initials:this.initials,avatarBgColor:this.avatarBgColor},t),o.avatar(t)},view:function(t,e){e=e||{},e=r.extend({name:this.get("name"),desc:this.get("eid")},e);var i=zdom("div",{className:"zmConWra"});return s.mountAtEnd(this.avatar(e),i),s.mountAtEnd(o.card(e),i),i},isEmailEnabled:function(){return!r.isEmpty(this.attrs.eid)}}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity"),zmail.Core.Namespaces.get),function(t){var a=t("_"),e=t("zmail.Maps.IndexedMap"),i=t("zmail.Maps.DelimitedMap"),s=t("zmail.ContactBook.Models.Entity.Group");(this.GroupBook=function(){this.me={},this.idMap={},this.emailMap={},this.names=[],this.nameMap=new i({map:new e,delimitedNames:function(t){var e=t.split(/\s+/);return 1<e.length&&e.push(t),e},get:function(t){return this.map.get(t)}})}).prototype={handleInitialResponse:function(t){var e=t.groups||{};return this.me=t.me&&new s(t.me)||this.me,a.isEmpty(this.me)||(this.me.set("name","Home").setInitials(),this.addGroup(this.me,{initial:!0})),this.order=t.order||[],this.order.forEach(function(t){this.addGroup(e[t],{initial:!0})},this),this},addGroup:function(t,e){e=e||{};var i=t instanceof s?t:new s(t),r=i.get("eid"),n=i.get("id"),o=(this.idMap[n]=i).get("name").toLowerCase();return this.nameMap.add(o,n),this.names.push(o),r&&(this.emailMap[r]=i,this.nameMap.add(r,n)),e.initial||this.order.unshift(n),this},getGroup:function(t){return t instanceof s?t:this.idMap[t]||this.emailMap[t]},removeGroup:function(t){var e=this.getGroup(t);if(e){delete this.idMap[e.id],delete this.emailMap[e.get("eid")],this.nameMap.remove(e.get("name"),t);var i=this.order.indexOf(t);this.order.splice(i,1)}return this},addMembers:function(t,e){var i=this.getGroup(t);if(!i)return this;var r=i.get("members")||[],n=i.get("memArr")||[];a.isArray(e)||(e=[e]),e.forEach(function(t){t.id||t.email?(n.push(t),t.id&&r.push(t.id)):r.push(t)});var o=r.reduce(function(t,e){return(t=t||{})[e]=!0,t},{});i.set("members",Object.keys(o));var s=n.reduce(function(t,e){return(t=t||{})[e.id||e.email]=e,t},{});return i.set("memArr",Object.keys(s).map(function(t){return s[t]})),this},removeMembers:function(t,e){var i=this.getGroup(t);if(!i)return this;a.isArray(e)||(e=[e]);var r=i.get("members"),n=i.get("memArr")||[];e.forEach(function(e){var t=r.indexOf(e.id||e);-1!==t&&r.splice(t,1);var i=n.findIndex(function(t){return t.id===e.id||t.email===e.email});-1!==i&&n.splice(i,1)},this)},addModerator:function(t,e){var i=this.getGroup(t);if(!i)return this;var r=i.get("moderator")||[],n=i.get("modArr")||[];a.isArray(e)||(e=[e]),e.forEach(function(t){t.id||t.email?(n.push(t),t.id&&r.push(t.id)):r.push(t)});var o=r.reduce(function(t,e){return(t=t||{})[e]=!0,t},{});i.set("moderator",Object.keys(o));var s=n.reduce(function(t,e){return(t=t||{})[e.id||e.email]=e,t},{});return i.set("modArr",Object.keys(s).map(function(t){return s[t]})),this},removeModerator:function(t,e){var i=this.getGroup(t);if(!i)return this;a.isArray(e)||(e=[e]);var r=i.get("moderator")||[],n=i.get("modArr")||[];e.forEach(function(e){var t=r.indexOf(e.id||e);-1!==t&&r.splice(t,1);var i=n.findIndex(function(t){return t.id===e.id||t.email===e.email});-1!==i&&n.splice(i,1)},this)},changeProps:function(t,e){var i=this.getGroup(t);if(i)for(var r in e)i.set(r,e[r]);return this},getGroupMembers:function(t){a.isArray(t)&&(t=[t]);var r=this;return t.reduce(function(t,e){var i=r.idMap[e];return i?t.concat(i.get("members")):t},[])},getGroups:function(t,r){r=r||{includeAllGroups:!0,includeEmailedGroups:!0};var n=this.idMap,o=this.emailMap,s={};return r.includeGroupHome||a.isEmpty(this.me)||(s[this.me.id]=1),(t||[]).reduce(function(t,e){if(!(e in s)){s[e]=1;var i=n[e]||o[e];i&&(r.includeAllGroups?t.push(i):r.includeEmailedGroups&&i.isEmailEnabled()&&t.push(n[e]))}return t},[])},has:function(t){return t in this.idMap||t in this.emailMap},get:function(t,e,i){var r=this;i=i||{},a.isArray(t)||(t=[t]),i.search&&(t=t.filter(function(t){return!(isFinite(t)&&t in r.idMap)}));var n,o=this.names,s=this;return n=e&&e.containsSearch?s.nameMap.get(t.reduce(function(t,e){return e=e.toLowerCase(),t.concat(o.filter(function(t){return-1!==t.indexOf(e)}))},[])):t.reduce(function(t,e){return s.has(e)?(t.push(e),t):t.concat(s.nameMap.get(e))},[]),this.getGroups(n,e)},getAll:function(t){var e=[];return t&&t.includeGroupHome&&e.push(this.me),e.concat(this.getGroups(this.order,t))}}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity.Collection"),zmail.Core.Namespaces.get),function(t){var o=t("_"),e=t("zmail.Maps.IndexedMap"),s=t("zmail.ContactBook.Models.Entity.Category");(this.CategoryBook=function(){this.idMap={},this.nameMap=new e}).prototype={add:function(t,e){if(e=e||{},!t)return this;o.isArray(t)||(t=[t]);var i=this.idMap,r=this.nameMap,n=e.type;return t.forEach(function(t){t.type=n;var e=new s(t);i[e.id]=e,r.add(e.get("cname"),e.id)}),this},getCategories:function(t){var i=this.idMap;return t.reduce(function(t,e){return t.push(i[e]),t},[])},has:function(t){return t in this.idMap},get:function(t){o.isArray(t)||(t=[t]);var i=this,e=t.reduce(function(t,e){return i.has(e)?(t.push(e),t):t.concat(i.nameMap.get(e))},[]);return this.getCategories(e)},getAll:function(){var t=this.nameMap.getAll();return this.getCategories(t)}}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity.Collection"),zmail.Core.Namespaces.get),function(v){var O=v("_"),a=v("$.Deferred"),n=v("Backbone.ajax"),e=v("zmail.Maps.Map"),i=v("zmail.Maps.IndexedMap"),r=v("zmail.Maps.MapKeeper"),d=v("zmail.ContactBook.Utils"),E=v("zmail.ContactBook.Constants.MODES"),y=v("zmail.ContactBook.Constants.CONTACTS_TYPES"),R=v("zmail.ContactBook.Constants.CATEGORY_TYPES"),o=v("zmail.ContactBook.Models.Entity.Group"),M=v("zmail.ContactBook.Models.Entity.Contact"),s=v("zmail.ContactBook.Models.Entity.Category"),c=v("zmail.ContactBook.Models.Logs.RequestLog"),u=v("zmail.ContactBook.Models.Entity.Collection.GroupBook"),l=v("zmail.ContactBook.Models.Entity.Collection.CategoryBook"),h=["eid","fn","ln","fn_ln","fn_mn_ln","nn","mn","others"],p=["start","offset","contactType"],f=y.PERSONAL,m={ME:"me"};(this.ContactBook=function(){var t=h.reduce(function(t,e){return e in t||(t[e]=new i),t},{});this.mapKeeper=new r(t),this.mostUsedMap=new e,this.idMap=new e,this.mostUsed=[],this.activeOrgMap={},this.addToActiveOrg=this.addToActiveOrg.bind(this),this.log=new c,this.categories=new l,this.categoryMap=new e,this.groups=new u,this.mostUsedFetched=new a,this.groupsFetched=new a,this.orgContactsFetched=new a,this.includeCRM=void 0}).prototype={expected:1,url:zmail.conPath+"/getContactsAlias.do",isAdequate:function(t,e){var i=t.length,r=e.expected;return 0!==i&&r<=i},hasPagination:function(t){return!t||!1!==t.pagination},isMostUsedFetched:function(){return"resolved"===this.mostUsedFetched.state()},isGroupsFetched:function(){return"resolved"===this.groupsFetched.state()},isOrgContactsFetched:function(){return"resolved"===this.orgContactsFetched.state()},setDefaultContactType:function(t){return void 0===t.type&&(t.type=f),this},copyContactType:function(t,e){return void 0===t.type&&void 0!==e.type&&(t.type=e.type),this},indexContactObject:function(t){return this.idMap.add(t.id,t),this},indexContactAttrs:function(t){var r=t.toJSON(),n=t.id,o={},e=h.reduce(function(t,e){var i=r[e];return i&&(o[i.toLowerCase()]=1,t[e]={name:i,value:n}),t},{});this.mapKeeper.add(e);var i=this,s=r.fn.split(/\s+/).slice(1);return s.forEach(function(t){!(t=t.toLowerCase())||t in o||(o[t]=1,i.mapKeeper.add({others:{name:t,value:n}}))}),this},index:function(e){var t=this.getContacts(e.id),i=!1,r=this;return t.forEach(function(t){t.type===e.type&&(t.equals(e)||t.isMergeable(e)?(i=!0,t.merge(e),r.copyContactType(t,e)):r.setDefaultContactType(t))}),i||this.indexContactObject(e).indexContactAttrs(e),this},set:function(t,e,i){var r=this;return t&&(O.isArray(t)||(t=[t]),e=e||O.noop,t.forEach(function(t){t instanceof M||(t=new M(t)),!0===i&&r.setDefaultContactType(t),this.index(t),e(t)},this)),this},getSpecialKeyContactIds:function(t){var e=(t.str||"").toLowerCase();return e===m.ME?(t.me=!0,[zmail.zuid]):[]},getIds:function(t){if(t.mode===E.CATEGORY_ID&&(t.eid=this.categoryMap.get(t.categoryid),t.eid.length&&(t.mode=E.EMAIL_ID)),t.mode===E.STREAM_GROUPS)return this.groups.getGroupMembers(t.groupid);if(t.mode===E.ZUID)return t.zuid;var e=this.getSpecialKeyContactIds(t);return e.concat(this.mapKeeper.get(t,h))},getContacts:function(t){return zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS&&zmail.ContactBook.UsageRestricted.ORG_CONTACTS?[]:(O.isString(t)&&(t=t.split(",")),t=t||[],this.idMap.get(t))},hasContact:function(t){return 0<this.getContacts(t).length},has:function(t){if(O.isString(t))return this.hasContact(t);var e=this;return O(t).every(function(t){return e.hasContact(t)})},isContact:function(t){return t instanceof M},isGroup:function(t){return O.isString(t)?zmail.zuid!==t&&this.groups.has(t):t instanceof o},isCategory:function(t){return O.isString(t)?this.categories.has(t):t instanceof s},sort:function(t,e){var i=t.name.toUpperCase(),r=e.name.toUpperCase();return i<r?-1:r<i?1:0},filter:function(t,e){var i=e.type.reduce(function(t,e){return t[e]=!0,t},{}),r=e.str,n=e.me,o={},s={},a=function(t){return void 0===t||!o[t]},c=function(t,e){e=e||o,void 0!==t&&(O.isArray(t)?t.forEach(function(t){void 0!==t&&(e[t]=1)}):e[t]=1)};e.excludeMe&&(c(zmail.zuid,s),this.getContacts(zmail.zuid).forEach(function(t){c(t.get("eid"),s)})),c(e.exclude,s);for(var u=e.excludeGroups,d=t.length,l=[],h=0;h<d;h++){var p=t[h],f=p.get("eid"),m=p.id,g=(f||"")+(m||"");if(!(f in s||m in s)){if(u){var C=this.groups.getGroup(m)||this.groups.getGroup(f);if(C&&!C.attrs.self){c(m);continue}}if(a(g)){if(this.isContact(p)){if(e.includeOnlyPrimary&&!p.isPrimary())continue;p.type in i&&(n||!r||p.getMatchingName(r))&&(c(g),l.push(p));continue}c(g),l.push(p)}}}if(t=l,e.mode===E.EMAIL_ID){var v=e.eid.reduce(function(t,e){return t[e]=1,t},{});t=t.filter(function(t){return t.get("eid")in v})}return e.mode===E.SEARCH&&e.excludeOrgUsers&&(t=(t||[]).filter(function(t){return!t.orgUser})),e.mode===E.SEARCH&&e.excludeInactiveUsers&&(t=(t||[]).filter(function(t){var e=("personal"===t.type||t.attrs.isOrg)&&!1===t.attrs.isActiveUser&&!1===t.attrs.isGroup;return!e})),e.excludeOrgContacts&&(t=(t||[]).filter(function(t){return!t.attrs.isOrg})),e.excludePersonalContacts&&(t=(t||[]).filter(function(t){return!("personal"===t.type&&!t.attrs.isOrg)})),e.offset&&0<e.offset&&(t=t.slice(e.offset,t.length)),e.sliceExpected&&(t=t.slice(0,e.expected)),t},sortResults:function(s,t){if(t.str){var e=0;s.forEach(function(t){t.attrs.usageRank&&e++});var a=s.splice(e,s.length-e);if(a.length){var i=[];if(t.prioritizeAllGroupMembers&&(i=zmail.ContactBook.getGroups().map(function(t){return t.id})),t.prioritizeGroupMembers)if(t.prioritizeGroupMembers.constructor!==Array&&(t.prioritizeGroupMembers=[t.prioritizeGroupMembers]),t.prioritizeAllGroupMembers){var r=i;i=(i=t.prioritizeGroupMembers).concat(O.difference(r,i))}else i=t.prioritizeGroupMembers;i.length&&i.forEach(function(t){t=String(t);var e=zmail.ContactBook.getGroups(t)[0];if(e){var i=e.attrs.members||[],r=Object.keys(a.reduce(function(t,e){return e.attrs.zid&&(t[e.attrs.zid]=!0),t},{})),n=O.intersection(i,r),o=[];n.forEach(function(i){a.forEach(function(t,e){t.attrs.zid===i&&(t=a.splice(e,1),o.push(t[0]))})}),s=s.concat(o)}})}a.length&&t.prioritizeOrgMembers&&(a.forEach(function(t,e){if(t.attrs.zid){var i=void 0!==zmail.ContactBook.get({zuid:t.attrs.zid,type:["org"],promise:!1})[0];i&&(t=a.splice(e,1)[0],a.unshift(t))}}),s=s.concat(a)),a.length&&(s=s.concat(a))}return s},retrieveContacts:function(t){var e,i,r,n,o,s=this.getIds(t),a=[];return(e=a).push.apply(e,babelHelpers.toConsumableArray(this.mostUsedMap.get(s))),(i=a).push.apply(i,babelHelpers.toConsumableArray(this.getContacts(s))),t.str&&!t.excludeGroups&&t.includeGroupHome&&(r=a).push.apply(r,babelHelpers.toConsumableArray(this.groups.me)),t.str&&!t.excludeGroups&&(t.includeAllGroups||t.includeEmailedGroups)&&(n=a).push.apply(n,babelHelpers.toConsumableArray(this.groups.get(t.str,t,{search:!0}))),t.str&&t.includeCategories&&(o=a).push.apply(o,babelHelpers.toConsumableArray(this.categories.get(t.str))),a=this.filter(a,t),a=this.sortResults(a,t)},updateGroupsLog:function(){var e=this;this.groups.getAll().forEach(function(t){e.log.add({ids:t.id,pagination:!e.has(t.members)})})},getLogHash:function(t){var e={str:t.str||t.eid&&t.eid.join&&t.eid.join(",")||t.fn||t.mn||t.ln||t.nn||"",ids:t.zuid&&t.zuid.join(",")||t.categoryid&&t.categoryid.join(",")||t.groupid&&t.groupid.join(",")||"",typ:t.type||""},i=this.log.get(e),r=i&&i.str!==t.str,n=-1!==t.type.indexOf("crm");return r&&n&&i.str&&i.str.length<3&&(i=null),i||(e.hash=this.log.hash(e),e)},parseQuery:function(t){var e=t.str||t,i=isFinite(e),r=e;i&&this.getGroups(e).length&&(r=void 0);var n,o=O.isString(t)?{str:t,expected:this.expected,eid:d.isEmailID(t)?t:void 0,groupid:r,categoryid:this.categories.has(t)?t:void 0}:t;if(o.str&&h.reduce(function(t,e){return t[e]||(t[e]=t.str),t},o),void 0===o.expected&&(o.expected=this.expected),void 0===o.type?o.type=[y.PERSONAL,y.ZOHO_ORG]:o.type=O.isArray(o.type)?o.type:[o.type],O.isArray(o.eid)||d.isEmailID(o.eid||o.str)){var s=o.eid||o.str;o.eid=O.isArray(s)?s:[s],o.mode=E.EMAIL_ID,n=o.eid.length,o.expected=o.expected<n?n:o.expected}else if(O.isArray(o.categoryid)||this.categories.has(o.categoryid||o.str)){var a=o.categoryid||o.str;o.categoryid=O.isArray(a)?a:[a],o.mode=E.CATEGORY_ID}else if(o.groupid){var c=o.groupid||o.str;o.groupid=O.isArray(c)?c:[c],o.mode=E.STREAM_GROUPS}else if(o.zuid){var u=o.zuid;o.zuid=O.isArray(u)?u:[u],o.mode=E.ZUID,n=o.zuid.length,o.expected=o.expected<n?n:o.expected}else o.mode=E.SEARCH;return o.excludeOrgUsers=o.excludeOrgUsers||!1,o.excludeInactiveUsers=o.excludeInactiveUsers||!1,o},request:function(i){var t=i.mode;if(t===E.MOST_USED&&!this.isMostUsedFetched()||t===E.STREAM_GROUPS&&!this.isGroupsFetched()||t===E.ORG_MEMBERS&&!this.isOrgContactsFetched())return{mode:t};if(t===E.ZUID)return{mode:t,zuids:O.isArray(i.zuid)?i.zuid.join(","):i.zuid};if(t===E.EMAIL_ID)return{mode:t,email:O.isArray(i.eid)?i.eid.join(","):i.eid};if(t===E.CATEGORY_ID)return{mode:t,cId:O.isArray(i.categoryid)?i.categoryid.join(","):i.categoryid};if(t===E.STREAM_GROUP_MEMBERS)return{mode:E.STREAM_GROUP_MEMBERS,groupid:O.isArray(i.groupid)?i.groupid.join(","):i.groupid};if(t!==E.SEARCH)return t===E.IS_ORG?{mode:E.IS_ORG,email:O.isArray(i.eid)?i.eid.join(","):i.eid}:void 0;var e={mode:E.SEARCH,query:i.str||i.eid||i.fn||i.mn||i.ln||i.nn};!1!==this.includeCRM&&-1!==i.type.indexOf("crm")&&zmail.isCRMServiceUser&&zmail.IntegrationStatus.CRM&&(e.includeCRM=!0);var r=p.reduce(function(t,e){return e in i&&(t[e]=i[e]),t},e);return zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS&&!zmail.ContactBook.UsageRestricted.ORG_CONTACTS?r.contactType="org":!zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS&&zmail.ContactBook.UsageRestricted.ORG_CONTACTS&&(r.contactType="personal"),r},responseHandler:function(t,e,i){var r,n,o,s,a=this,c=t.mode,u=this;if(c===E.ZUID||c===E.EMAIL_ID)e.clist=e.clist||{},i.pagination=!1,this.set(e.clist[c],this.addToActiveOrg);else if(c===E.STREAM_GROUP_MEMBERS)e.clist=e.clist||{},this.set(e.clist[E.ZUID],this.addToActiveOrg);else if(c===E.STREAM_GROUPS)this.groups.handleInitialResponse(e),this.groupsFetched.resolve();else if(c===E.MOST_USED)o=e.clist&&e.clist.CONTACTS_USAGE_ORDER||[],o=O.isArray(o)?o:[o],n=function(t){u.mostUsed.push(t),u.mostUsedMap.add(t.id,t)},o.forEach(function(t,e){t.usageRank=e+1,u.set(t,n,!0)}),zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS||this.categories.add(e.catlist,{type:R.PERSONAL}),zmail.ContactBook.UsageRestricted.ORG_CONTACTS||this.categories.add(e.orgcatlist,{type:R.ORG}),this.mostUsedFetched.resolve();else if(c===E.ORG_MEMBERS){o=e.zlist||[];var d=this.activeOrgMap,l=[];for(s in o){var h=o[s];h.photo||(h.photo="https://".concat(zmail.urls.contactsURL,"/file?t=user&fs=thumb&ID=").concat(h.zid));var p=new M(h);p.zoid=v("zmail.zoid"),p.type=y.ZOHO_ORG,p.orgUser=!0,d[p.get("zid")]=!0,d[p.get("eid")]=!0,l.push(p)}l.sort(this.sort),this.set(l),this.orgContactsFetched.resolve(),this.addToActiveOrg(this.mostUsed)}else if(c===E.SEARCH){for(s in o=e.clist)this.set(o[s],this.addToActiveOrg,!0);var f=function(t){var e,i,r,n;t&&(i=((e=t).fn||"").trim(),r=(e.ln||"").trim(),n=-1,r&&0<(n=i.lastIndexOf(r))&&(i=(i.substring(0,n)||"").trim(),e.fn=i),(t=new M(t)).type=y.CRM,a.set(t))};(e.crm||[]).forEach(function(t){f(t)},this),(e.crmLeads||[]).forEach(function(t){f(t)},this),-1!==t.type.indexOf("crm")&&t.str&&2<t.str.length&&(i.crmFetched=!0,void 0===u.includeCRM&&e.hasOwnProperty("crm")&&!e.crm.hasOwnProperty("Error")&&(u.includeCRM=!0))}else if(c===E.CATEGORY_ID){e.clist=e.clist||[],o=e.clist.concat(e.orgClist);var m,g=t.categoryid;for(s in r=function(t){var e=new M(t);u.set(e,u.addToActiveOrg,!0),u.categoryMap.add(m,e.get("eid"))},o){m=g[s];var C=o[s][m]||[];(C=O.isArray(C)?C:[C]).forEach(r)}this.log.add({ids:t.categoryid,pagination:!1})}this.updateGroupsLog()},addToActiveOrg:function(t){O.isArray(t)||(t=[t]);var e=this.activeOrgMap;return t.forEach(function(t){t.get("zid")in e?e[t.get("eid")]=!0:e[t.get("eid")]=!1}),this},_isActiveOrg:function(t){var e,i=this.activeOrgMap,r=[];t=O.isArray(t)?t:[t];for(var n=0;n<t.length;n++){var o=t[n];if(o in i){if(!1===(e=i[o]))break}else r.push(o)}return{all:e,eid:r}},isActiveOrg:function(e){var i=a(),r=this,n=r._isActiveOrg(e);if(!1===n.all||!0===n.all&&0===n.eid.length)return i.resolve(n.all).promise();var t={eid:n.eid};return this.get(t).then(function(t){n=!1===(n=r._isActiveOrg(e))?n:0===n.eid.length,i.resolve(n)},i.reject),i.promise()},processUsageRestrictions:function(t,e){var i=!0,r=zmail.ContactBook.UsageRestricted;switch(t.mode){case E.STREAM_GROUPS:!1===_zm.isStreamsEnabled()&&(i=!1);break;case E.MOST_USED:r.PERSONAL_CONTACTS&&(i=!1);break;case E.EMAIL_ID:case E.ZUID:case E.SEARCH:r.PERSONAL_CONTACTS&&r.ORG_CONTACTS&&(e.type=e.type.filter(function(t){return t!==y.PERSONAL&&t!==y.CRM})),e.type.length||(i=!1);break;case E.CATEGORY_ID:}return i},fetch:function(t){var i=a(),e=this.request(t),r=this.processUsageRestrictions(e,t);return r?e.mode!==E.SEARCH||e.query?e?n({data:e,url:this.url,type:"get"}).then(function(t){var e=1===t[0]?"resolve":"reject";i[e](t[1])},function(t){i.reject({networkError:0===t.readyState})}):i.reject():i.reject({invalidQuery:!0}):i.reject({error:"USAGE_RESTRICTED"}),i.promise()},fetchGroups:O.once(function(){var e={mode:E.STREAM_GROUPS},t=this,i=$.Deferred();return t.fetch(e).then(function(t){i.resolve(e,t)},function(){t.groupsFetched.reject(),i.reject()}),i.promise()}),processGroupsResponse:O.once(function(t,e){this.responseHandler(t,e)}),fetchMostUsed:O.once(function(){var e={mode:E.MOST_USED},t=this,i=$.Deferred(),r=zmail.isZMOfflineEnabled&&_zm.isOfflineEnabled(),n=[zmail.zuid,"offline","contacts","mostused"].join("_");if(r&&!window.navigator.onLine&&window.localStorage){var o=window.localStorage.getItem(n);if(o)return i.resolve(e,JSON.parse(o)),i.promise()}return t.fetch(e).then(function(t){r&&window.localStorage.setItem(n,JSON.stringify({clist:t.clist})),i.resolve(e,t)},function(){r&&window.navigator.onLine&&window.localStorage.removeItem(n),t.mostUsedFetched.reject(),i.reject()}),i.promise()}),processMostUsedResponse:O.once(function(t,e){this.responseHandler(t,e)}),fetchOrgContacts:O.once(function(){var e={mode:E.ORG_MEMBERS},t=this,i=$.Deferred();return zmail.isOrg?(t.fetch(e).then(function(t){i.resolve(e,t)},function(){t.orgContactsFetched.reject(),i.reject()}),i.promise()):(t.orgContactsFetched.resolve(),i.resolve().promise())}),processOrgContactsResponse:O.once(function(t,e){this.responseHandler(t,e)}),getCategories:function(t){if(zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS&&zmail.ContactBook.UsageRestricted.ORG_CONTACTS)return[];var e=[];return t&&(e=this.categories.get(t)),e=this.categories.getAll(),zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS&&(e=e.filter(function(t){return t.type!==R.PERSONAL})),zmail.ContactBook.UsageRestricted.ORG_CONTACTS&&(e=e.filter(function(t){return t.type!==R.ORG})),e},getGroups:function(t,e){return void 0===t||O.isString(t)||void 0!==e||(e=t,t=void 0),t?this.groups.get(t,e):this.groups.getAll(e)},getGroupOrder:function(){return this.groups.order},getGroupsByID:function(t,e){return Array.isArray(t)||(t=[t]),this.groups.getGroups(t,e)},getHomeGroup:function(){return this.groups.idMap[zmail.zuid]||{}},getGroupsIDMap:function(){return this.groups.idMap},getActiveOrg:function(t){t=t||{},t=this.parseQuery(O.extend(t,{str:"",type:y.ZOHO_ORG}));var e=this.getContacts(this.mapKeeper.getAll(h));return e=this.filter(e,t),t.sort?e.sort(this.sort):e},getMostUsedContacts:function(t){if(zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS)return[];if(O.isEmpty(t))return this.mostUsed.slice();var e=this.parseQuery(t),i=this.getIds(e);return this.mostUsedMap.get(i)},get:function(t){var e=this;if(!O.isEmpty(t)){zmail.ContactBook.UsageRestricted.ORG_CONTACTS&&(t.excludeOrgContacts=!0),zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS&&(t.excludePersonalContacts=!0);var i=this.parseQuery(t),r=this.retrieveContacts(i);if(!1===i.promise)return r;if(this.isAdequate(r,i))return a().resolve(r).promise();var n,o=this.getLogHash(i);if(o.deferred)return n=a(),o.deferred.then(function(){r=e.retrieveContacts(i),n.resolve(r)},n.reject),n.promise();var s=!1;return zmail.isCRMServiceUser&&-1!==i.type.indexOf("crm")&&i.str&&2<i.str.length&&!0!==o.crmFetched&&(s=!0),!0===this.hasPagination(o)||s?(n=o.deferred=a(),this.log.add(o),this.fetch(i).then(function(t){o.pagination=t.pagination,delete o.deferred,e.responseHandler(i,t,o),r=e.retrieveContacts(i),n.resolve(r)},function(t){t.networkError&&delete e.log.logs[o.hash],n.reject()}),n.promise()):a().resolve(r).promise()}}}}.call(zmail.Core.Namespaces.create("zmail.ContactBook.Models.Entity.Collection"),zmail.Core.Namespaces.get),function(t){var i=t("_"),e=t("$.Deferred"),r=t("zmail.ContactBook.Constants.EVENTS"),n=t("zmail.ContactBook.Models.Entity.Collection.ContactBook"),o=t("$.subscribe"),s=t("zmail.ContactBook.Constants.CATEGORY_TYPES");delete this.__namespace;var a=this;this.usageRestriction=new e;var c=new n;["get","getActiveOrg","getContacts","getCategories","getGroups","getGroupOrder","getMostUsedContacts","getGroupsByID","getGroupsIDMap","getHomeGroup","fetchGroups","fetchMostUsed","fetchOrgContacts","isGroupsFetched","isMostUsedFetched","isOrgContactsFetched","isContact","isGroup","isCategory","set","isOrg","isActiveOrg","mostUsedFetched","groupsFetched","orgContactsFetched","groups","categories"].forEach(function(t){var e=c[t];e&&(i.isFunction(e)?a[t]=e.bind(c):a[t]=e)});var u=a.groups;o(r.GROUP_ADDED,function(t,e){u.addGroup(e.group)}),o(r.GROUP_REMOVED,function(t,e){u.removeGroup(e.id)}),o(r.GROUP_CHANGED,function(t,e){u.changeProps(e.id,e.props)}),o(r.GROUP_MEMBERS_ADDED,function(t,e){u.addMembers(e.id,e.members)}),o(r.GROUP_MEMBERS_REMOVED,function(t,e){u.removeMembers(e.id,e.members)}),o(r.GROUP_MODERATORS_ADDED,function(t,e){u.addModerator(e.id,e.moderators)}),o(r.GROUP_MODERATORS_REMOVED,function(t,e){u.removeModerator(e.id,e.moderators)}),a.fetchProcess=new e,zmail.ContactBook.UsageRestricted={GROUPS:!1,ORG_CONTACTS:!1,PERSONAL_CONTACTS:!1},this.initialize=function(){var e,i;return(e=$.Deferred(),i={organisation:{value:{name:"ON",id:29}},personal:{value:{name:"ON",id:29}},group:{value:{name:"ON",id:29}}},zmAjq.XHR({t:"POST",u:zmail.conPath+"/getContactsAlias.do?mode=getContactUsageRestrictions",p:{},fn:function(t){e.resolve(Object.assign(i,t))},efn:function(t){e.resolve(Object.assign(i,{error:t}))}}),e.promise()).then(function(t){zmail.ContactBook.UsageRestricted=Object.assign(zmail.ContactBook.UsageRestricted,{GROUPS:"ON"!==t.group.value.name,ORG_CONTACTS:"ON"!==t.organisation.value.name,PERSONAL_CONTACTS:"ON"!==t.personal.value.name}),zmail.ContactBook.usageRestriction.resolve(),function(){var t=null,i=null,r=null;(t=a.fetchGroups()).always(function(t,e){t&&e&&c.processGroupsResponse(t,e)}),i=a.fetchMostUsed(),r=a.fetchOrgContacts();var e=function(){t.always(function(t,e){i.always(function(t,e){t&&e&&c.processMostUsedResponse(t,e),r.always(function(t,e){t&&e&&c.processOrgContactsResponse(t,e),a.fetchProcess.resolve()})})})};$.when(i,r).always(e)}()}),a.fetchProcess.promise()},this.isPersonalContactRestricted=function(){return zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS},this.isOrgContactRestricted=function(){return zmail.ContactBook.UsageRestricted.ORG_CONTACTS},this.addNewPersonalContact=function(t){c.set(t,null,!0)},this.addNewCategory=function(t,e){(e=e||{}).type=e.type||s.PERSONAL,c.categories.add(t,{type:e.type})}}.call(zmail.Core.Namespaces.create("zmail.ContactBook"),zmail.Core.Namespaces.get);
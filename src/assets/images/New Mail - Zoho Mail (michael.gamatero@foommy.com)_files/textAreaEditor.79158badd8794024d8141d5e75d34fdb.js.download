"use strict";zmail.Core.Namespaces.create("zmail.Components.TextAreaEditor.Templates").getEditor=function(){return zdom("div",{ref:"wrapper",className:"zm_mention",style:{color:"transparent"}},zdom("div",{ref:"background",className:"zm_mentionbg"}),zdom("textarea",{ref:"textarea",autoComplete:"off",autoCorrect:"off",autoCapitalize:"off"}))},function(){var e=zmail.Core.Namespaces.create("zmail.Components.TextAreaEditor"),n=zmail.Utils.TextArea,d=zmail.Utils.DOM,a=zmail.Components.TextAreaEditor.Templates,h="\ufeff",r=_zm.getDOMReferenceMap,i=function(e){return(e=e||"").replace(/[\uFEFF\uFFFE]/gim,"")},v={LEFT:37,RIGHT:39,DELETE:46,BACKSPACE:8,SPACE:32,ENTER:13,SHIFT:16,META:91,RIGHT_META:93},f={blockRemoved:"BLOCK_REMOVED",blockAdded:"BLOCK_ADDED",textChanged:"TEXT_CHANGED",heightChanged:"HEIGHT_CHANGED"},o=function(e){function n(){var e;babelHelpers.classCallCheck(this,n),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this));var t=babelHelpers.assertThisInitialized(e);return t.blockRenderers={},t.initBlockRenderers(),e}return babelHelpers.inherits(n,e),babelHelpers.createClass(n,[{key:"initBlockRenderers",value:function(){var e=this;e.setBlockRenderer("default",e.textBlockRenderer),e.setBlockRenderer("text",e.textBlockRenderer),e.setBlockRenderer("url",e.urlBlockRenderer)}},{key:"setBlockRenderer",value:function(e,t){e&&(this.blockRenderers[e]=t)}},{key:"textBlockRenderer",value:function(e,t){var n=(t=t||{}).padEOL||!1;return 0<e.value.length&&"\n"===e.value[e.value.length-1]&&n?e.value+"_":e.value}},{key:"urlBlockRenderer",value:function(e,t){return t=t||{},React.createElement("a",{href:e.data.url,target:"_blank",rel:"noreferrer noopener"},e.value)}},{key:"renderBlock",value:function(e,t){return t=t||{},(this.blockRenderers[e.type]||this.blockRenderers.default)(e,t)}},{key:"render",value:function(){var a=this,e=a.props,r=e.text||"",t=e.metaBlocks||[],i=[],o=0;return t.forEach(function(e){var t=r.substring(0,e.start-o);t&&i.push({type:"text",value:t});var n=r.substring(e.start-o,e.end-o);n&&i.push({type:e.type,value:n,data:e.data}),r=r.substring(e.end-o),o=e.end}),r&&(i.push({type:"text",value:r}),r=""),i=i.map(function(e,t){var n=i.length-1===t;return a.renderBlock(e,{padEOL:n})}),React.createElement("span",{style:{whiteSpace:"pre-wrap",display:"block"}},i)}}]),n}(React.Component),t=function(){function t(){babelHelpers.classCallCheck(this,t);var e=this;e.textarea=null,e.dom=null,e.refs=null,e.metaBlocks=null,e.maxHeightActive=!1}return babelHelpers.createClass(t,[{key:"getTemplate",value:function(){return a.getEditor()}},{key:"createDOM",value:function(){this.dom=this.getTemplate(),this.refs=r(this.dom,!0)}},{key:"init",value:function(e){e=e||{};var t=this,n=null;t.createDOM(),n=t.refs,e.textarea?(t.textarea=e.textarea,d.mountBefore(n.wrapper,t.textarea),d.mountAfter(t.textarea,n.textarea),d.unmount(n.textarea,!0),n.textarea=t.textarea):t.textarea=n.textarea,e.text&&t.setText(e.text,{silent:!0}),e.metaBlocks?t.setMetaBlocks(e.metaBlocks,{silent:!0}):t.metaBlocks=[],t.syncText(),t.bindEvents()}},{key:"getCursorPositionWithBOM",value:function(e){var t=this.textarea;return!0===e?t.selectionEnd:"forward"===t.selectionDirection?t.selectionEnd:"backward"===t.selectionDirection?t.selectionStart:t.selectionEnd||t.selectionStart}},{key:"getCursorPosition",value:function(){var e=this.textarea,t=-1;return"forward"===e.selectionDirection?t=e.selectionEnd:"backward"===e.selectionDirection&&(t=e.selectionStart),(t=e.selectionEnd||e.selectionStart)-this.bomCountBeforeIndex(t)}},{key:"setCursorPosition",value:function(e){var t=this.textarea,n=t.value;e<0&&(e=0),e>n.length&&(e=n.length),t.setSelectionRange(e,e)}},{key:"checkCursorPositionAndAdjust",value:function(){var e=this.getCursorPositionWithBOM();this.textarea.value.charAt(e-1)===h&&this.setCursorPosition(e-1)}},{key:"deletePreviousCharacter",value:function(){var e=this.getCursorPositionWithBOM(),t=this.textarea.value;t=t.substring(0,e-1)+t.substring(e),this.textarea.value=t}},{key:"deleteNextCharacter",value:function(){var e=this.getCursorPositionWithBOM(),t=this.textarea.value;t=t.substring(0,e)+t.substring(e+1),this.textarea.value=t}},{key:"replaceSelectedTextWith",value:function(e){var t=this.textarea;this.replaceTextRangeWith(e,t.selectionStart,t.selectionEnd,{silent:!0})}},{key:"replaceTextRangeWith",value:function(e,t,n,a){var r=this,i=r.textarea;a=a||{};var o=i.value;o=o.substring(0,t)+e+o.substring(n);var s=i.selectionEnd;s+=e.length-(n-t),i.value=o,r.setCursorPosition(s),a.silent||setTimeout(function(){d.element(r).triggerHandler(f.textChanged)},0)}},{key:"insertTextAt",value:function(e,t){var n=this.textarea,a=n.value;a=a.substring(0,n.selectionStart)+e+a.substring(n.selectionEnd),t+=e.length,n.value=a,this.setCursorPosition(t)}},{key:"handleInputEvent",value:function(){var e=this;e.checkCursorPositionAndAdjust(),e.syncText(),setTimeout(function(){d.element(e).triggerHandler(f.textChanged)},0)}},{key:"handleKeyDownEvent",value:function(e){var t=this,n=e.keyCode||e.which,a=t.getCursorPositionWithBOM(),r=!1,i=e.metaKey,o=e.shiftKey,s=e.ctrlKey,l=t.textarea.value,u=l.charAt(a-1),c=l.charAt(a);n===v.LEFT&&u===h&&(i||s||(o?t.textarea.selectionStart-=1:(t.setCursorPosition(a-1),r=!0))),n===v.BACKSPACE&&u===h&&(s||i||(t.setCursorPosition(a-1),t.deletePreviousCharacter(),t.syncText(),r=!0,setTimeout(function(){d.element(t).triggerHandler(f.textChanged)},0))),n===v.RIGHT&&c===h&&(a=t.getCursorPositionWithBOM(!0),i||s||(o?t.textarea.selectionEnd+=1:(t.setCursorPosition(a+2),r=!0))),n===v.DELETE&&c===h&&!s&&i&&(t.setCursorPosition(a+1),t.deleteNextCharacter(),t.syncText(),r=!0,setTimeout(function(){d.element(t).triggerHandler(f.textChanged)},0)),r&&(e.preventDefault(),t.checkCursorPositionAndAdjust())}},{key:"handleKeyUpEvent",value:function(e){e.shiftKey||this.checkCursorPositionAndAdjust()}},{key:"handleClickEvent",value:function(){this.checkCursorPositionAndAdjust()}},{key:"handlePasteEvent",value:function(e){var t=this,n=t.textarea,a=(e=e.originalEvent||e).clipboardData||window.clipboardData,r=a.getData("text/plain")||a.getData("Text")||"";r=i(r),n.selectionStart!==n.selectionEnd?t.replaceSelectedTextWith(r):t.insertTextAt(r,t.getCursorPositionWithBOM()),t.syncText(),t.checkCursorPositionAndAdjust(),e.preventDefault(),setTimeout(function(){d.element(t).triggerHandler(f.textChanged)},0)}},{key:"bindEvents",value:function(){var e=this;e.handleInputEvent=e.handleInputEvent.bind(e),d.element(e.textarea).on("input",e.handleInputEvent),e.handleKeyDownEvent=e.handleKeyDownEvent.bind(e),d.element(e.textarea).on("keydown",e.handleKeyDownEvent),e.handleKeyUpEvent=e.handleKeyUpEvent.bind(e),d.element(e.textarea).on("keyup",e.handleKeyUpEvent),e.handleClickEvent=e.handleClickEvent.bind(e),d.element(e.textarea).on("click",e.handleClickEvent),e.handlePasteEvent=e.handlePasteEvent.bind(e),d.element(e.textarea).on("paste",e.handlePasteEvent),e.textAreaScrollHandler=e.textAreaScrollHandler.bind(e),d.element(e.textarea).on("scroll",e.textAreaScrollHandler)}},{key:"unbindEvents",value:function(){var e=this;d.element(e.textarea).off("input",e.handleInputEvent),d.element(e.textarea).off("keydown",e.handleKeyDownEvent),d.element(e.textarea).off("keyup",e.handleKeyUpEvent),d.element(e.textarea).off("click",e.handleClickEvent),d.element(e.textarea).off("paste",e.handlePasteEvent),d.element(e.textarea).off("scroll",e.textAreaScrollHandler)}},{key:"getText",value:function(){var e=this.textarea.value;return i(e)}},{key:"setText",value:function(e,t){t=t||{};var n=this;n.textarea.value=i(e),!0!==t.silent&&n.syncText(),setTimeout(function(){d.element(n).triggerHandler(f.textChanged)},0)}},{key:"sortMetaBlocks",value:function(){this.metaBlocks=this.metaBlocks.sort(function(e,t){return e.start>t.start?1:e.start<t.start?-1:0})}},{key:"setMetaBlocks",value:function(e,t){t=t||{};var n=this;n.metaBlocks=[],(e=e||[]).forEach(function(e){n.addMetaBlock(e,t)}),!0!==t.silent&&n.syncText()}},{key:"getMetaBlocks",value:function(){return this.metaBlocks.map(function(e,t){return{text:e.text,id:e.id,type:e.type,data:e.data,start:e.start-e.bomOffset-1,end:e.end-e.bomOffset-1}})}},{key:"bomCountBeforeIndex",value:function(e){var t=this.textarea.value.substring(0,e),n=i(t);return t.length-n.length}},{key:"bomCountAfterIndex",value:function(e){var t=this.textarea.value.substring(e),n=i(t);return t.length-n.length}},{key:"addMetaBlock",value:function(e,t){var n=this;t=t||{};var a=n.textarea.value;if(!e.id)return!1;if(e.start>=e.end)return!1;if(e.text.length!==e.end-e.start)return!1;if(e.text!==a.substring(e.start,e.end))return!1;var r=n.bomCountBeforeIndex(e.start),i=e.start;a=a.substring(0,i)+h+a.substring(i);var o=i+1+e.text.length;return n.textarea.value=a,n.setCursorPosition(o),n.updateMetaBlocks({mode:"add-block"}),n.metaBlocks.push({start:e.start,end:e.end,text:e.text,data:e.data,type:e.type,id:e.id,bomOffset:r}),n.sortMetaBlocks(),!0!==t.silent&&n.syncText(),!0!==t.silent&&setTimeout(function(){d.element(n).triggerHandler(f.blockAdded,e)},0),n.checkCursorPositionAndAdjust(),!0}},{key:"removeMetaBlock",value:function(n,e){var t=this;e=e||{};var a=-1;t.metaBlocks.forEach(function(e,t){-1===a&&n===e.id&&(a=t)});var r=null;return-1!==a&&(r=t.metaBlocks.splice(a,1)),!0!==e.silent&&t.syncText(),!0!==e.silent&&setTimeout(function(){d.element(t).triggerHandler(f.blockRemoved,r)},0),r}},{key:"getBackgroundContentClass",value:function(){return o}},{key:"renderBackground",value:function(e){var t=this.refs,n=this.getBackgroundContentClass();ReactDOM.render(React.createElement(n,{text:this.getText(),metaBlocks:this.getMetaBlocks()}),t.background)}},{key:"updateMetaBlocks",value:function(e){var r=this;e=e||{};var i=r.textarea.value,o=0;r.metaBlocks.forEach(function(e,t){var n=e.text,a=i.indexOf(h+n,o);-1===a?e.invalid=!0:(e.start=a+1,e.end=a+1+n.length,e.bomOffset=r.bomCountBeforeIndex(a)),o=e.end});var t=r.metaBlocks.filter(function(e,t){return e.invalid});if(r.metaBlocks=r.metaBlocks.filter(function(e,t){return!e.invalid}),"add-block"!==e.mode){for(var n=[],a=new RegExp(h,"gm"),s=a.exec(i);null!==s;)n.push(s.index+1),s=a.exec(i);var l=r.metaBlocks.map(function(e){return e.start}),u=_.difference(n,l),c=0;u.forEach(function(e){e-=c,r.replaceTextRangeWith("",e-1,e),c++})}return t}},{key:"syncText",value:function(){var t=this;t.updateMetaBlocks().forEach(function(e){setTimeout(function(){d.element(t).triggerHandler(f.blockRemoved,e)},0)}),t.renderBackground();var e=t.textarea.getBoundingClientRect(),n=t.refs.background.getBoundingClientRect();d.setStyle(t.refs.textarea,{height:n.height+"px"}),d.setStyle(t.refs.background,{width:t.refs.textarea.clientWidth?t.refs.textarea.clientWidth+"px":"auto"}),e.height!==n.height&&setTimeout(function(){d.element(t).triggerHandler(f.heightChanged,{currentHeight:n.height,previousHeight:e.height,change:n.height-e.height})},0)}},{key:"destroy",value:function(){var e=this;e.unbindEvents(),ReactDOM.unmountComponentAtNode(e.refs.background),d.unmount(e.dom,!0),e.dom=null,e.textarea=null,e.refs=null,e.metaBlocks=null}},{key:"getCurrentTypingWord",value:function(){var e=this.getText().substr(0,this.getCursorPosition()),t=/(?:(?=\s*)([\S]+[^\S\n]*)$)/i.exec(e);return t?t[1]:" "}},{key:"getCurrentWordBounds",value:function(){return n.findCursorPosition(this.textarea)}},{key:"textAreaScrollHandler",value:function(){var e=this.refs;this.maxHeightActive&&(e.background.scrollTop=e.textarea.scrollTop)}},{key:"setMaxHeight",value:function(e){var t=(e=e||{}).maxHeight;!window.isFinite(t)||t<1||(d.setStyle(this.refs.textarea,{maxHeight:t+"px",overflowY:"auto"}),d.setStyle(this.refs.background,{maxHeight:t+"px",overflowY:"hidden"}),this.maxHeightActive=!0)}},{key:"resetMaxHeight",value:function(){d.setStyle(this.refs.textarea,{maxHeight:"",overflowY:"hidden"}),d.setStyle(this.refs.background,{maxHeight:"",overflowY:"hidden"}),this.maxHeightActive=!1}}]),t}();t.KEYS=v,t.EVENTS=f,t.BackgroundContent=o,e.BaseEditor=t}();
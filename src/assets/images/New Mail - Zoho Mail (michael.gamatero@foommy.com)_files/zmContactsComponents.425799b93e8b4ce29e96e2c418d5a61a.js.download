"use strict";window.zmAdd=function(){var N,A,M,a,o,T,O,B,P,i,L="",w={},H=!1,D="a",R=!0,E=[],z={},U=[],I=[],j=0,F=0,G=!1,X=zmText.get("zmContactsComponents","addressBook.labels"),J=X.allContacts,K="#zmabk_sel",Q="#zmsdialog_zmabk",s="#SC_Category",V="msi-uncheck",W="#zmabk_crm",Y="#zmsdialogcont_zmabk",e="data-index";i=zdom("li",null,X.crminfoMsg);var Z=function(e,a,t){var s=$.e(e).attr("data-eid");if(!$.q(e).hasClass("SC_no")){if(!e||$.e(e).find("i").hasClass("msi-tick")&&"all"!==t)e&&($.e(e).find("i").removeClass("msi-tick"),$.e(e).removeClass("sel"),$.q("#zmabk_sel div[data-eid='"+s+"']").remove(),$.q(".SC_conSel").find("[data-eid = '"+s+"']").remove(),delete w[s],Object.keys(w).length<=3&&$.e(M).remove());else{if($.e(e).find("i").addClass("msi-tick"),$.e(e).addClass("sel"),!$.q().length){var o=zdom("div",null);o.id="zmabk_sel",$.e(o).insertDOMAfter($.q("#zmabk")),$.q(K).css({height:"auto",overflow:"hidden"}).click(function(e){var a=e.target;$.q(a).hasClass("msi-close")&&N($.q(a).parent())})}if(!w[s]){var d,n=$.e(e).find("div").html(),l=$.e(e).find("[data-name]").text(),i="";-1!==n.indexOf("<font")&&(i=n.substring(n.indexOf("</b")+4,n.indexOf("</font"))),d=$.q(e).find("img").attr("src"),w[s]={fn:l,nn:i,eid:s,photo:d};var m=zdom("div",{className:"SC_cs","data-eid":s},zdom("span",null,l),zdom("i",{className:"msi-close"}));"crm"!==D?zmail.ContactBook.get(s).done(function(e){$.e(e[0].avatar()).insertDOMBefore($.e(m).find("span"))}):"crm"===D&&zmail.ContactBook.get({eid:s,type:["crm"]}).done(function(e){$.e(e[0].avatar()).insertDOMBefore($.e(m).find("span"))}),$.q(Q).find(".SC_conSelLst").appendDOM(m);var r=Object.keys(w).length;T(),zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS||(3<r?($.e(M).css("display","block"),$.e(M).find("input").focus()):$.e(M).css("display","none"))}var c=$.q(Q).find(".SC_conSelLst")[0];0<c.scrollHeight&&(c.scrollTop=c.scrollHeight)}zmAdd.resizeSelPane()}};N=function(e){var a=$.q(e).attr("data-eid");Object.keys(w).length<=3&&$.q(M).remove(),$.q("#zmabk li[data-eid='"+a+"']")[0]?Z($.q("#zmabk li[data-eid='"+a+"']")):($.q(e).remove(),delete w[a])},T=function(){$.q(s).remove(),$.q(M).css("display","none"),$.q(M).insertDOMBefore($.q(".SC_PUbtm")),$.q(M).on("click",function(e){a(e)})},a=function(e){var t,a=e.target,s=function(){var a=$.q(".SC_grpName");a.removeClass("SC_dyn"),t=$.q(M).find(".msi-edit"),$.q(t).on("click",function(){o(a[0].value),a[0].value=""}),$.q(M).find("input").focus(),a.on("keyup",function(e){0<a[0].value.length?($.q(t).attr("class","msi-tick"),$.q(t).attr("data-tooltip",zmText.get("zmContactsComponents","addressBook.save")),13===e.keyCode&&(o(a[0].value),a[0].value="")):(t=$.q(M).find(".msi-tick"),$.q(t).attr("class","msi-edit"),$.q(t).attr("data-tooltip",zmText.get("zmContactsComponents","addressBook.edit")))})};"SC_mkeGrpTxt"===a.className?($.q(a).addClass("SC_dyn"),s()):"msi-close"===a.className||"grp_close"===a.className?$.q(M).remove():"msi-edit"!==a.className&&"grp_save"!==a.className&&"msi-tick"!==a.className||($.q(".SC_mkeGrpTxt").addClass("SC_dyn"),s())},o=function(e){var t=zmText.get("zmContactsComponents","addressBook.labels.successMsg");if(""===e.trim())return $.q(s).addClass("highlightClass"),setTimeout(function(){$.q(s).removeClass("highlightClass")},5e3),!1;var a={mode:"addToCategory",ignoreCategoryCheck:"true",categoryName:e,email:Object.keys(w).toString()};zmail.ContactBook.UsageRestricted.PERSONAL_CONTACTS||zmAjq.XHR({u:zmail.conPath+"/getContactsAlias.do",t:"POST",p:a,fn:function(e,a){_zm.succErrMsg("s",t),$.q(".SC_grpName").value=""},efn:function(e,a,t,s,o){_zm.succErrMsg("e",o[1]["Error : "])},csr:"s"})};A=zdom("div",{className:"SC_Psa"},zdom("i",{className:""}),zmText.get("zmContactsComponents","addressBook.labels.selectAll"));var ee=function(e){for(var a=$.q("#zmabk_c").children(),t=a.length,s=e.attr,o=0;o<t;o++)Z(a[o],0,s)};return{showBook:function(e,a,t,s){var o=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{};e=o.callback||e,R=!0,I=[],F=j=0,L="a";var d={display:"none"};if(!$.q("#zmabk").length){var n=zdom("div",{id:"zmabk",ref:"addressbook"},zdom("div",{id:"zmabk_hdr",className:"SC_PUhd"},zdom("div",{className:"SC_sch SC_frt",id:"zmabk_srch"},zdom("i",{className:"msi-search"}),zdom("input",{type:"text",placeholder:"Search Contact"})),zdom("div",{className:"SCmb SC_flt",style:{padding:"0px"}},zdom("ul",null,zdom("li",{className:"SCtxt"},zdom("b",{id:"allContacts"},zdom("div",{className:"SC_hd"}),zdom("span",null,zdom("span",{"data-select":"select"},J),zdom("i",{className:"msi-barrow"})))))),zdom("div",{style:{clear:"both"}})),zdom("ul",{className:"SC_P2r SC_Phr","data-index":"0",id:"zmabk_c",style:d}),zdom("ul",{className:"SC_P2r SC_Phr","data-index":"0",id:"zmabk_a",style:d}),zdom("ul",{className:"SC_P2r SC_Phr",id:"zmabk_s","data-index":"0",style:d}),zdom("ul",{className:"SC_P2r SC_Phr",id:"zmabk_crm","data-index":"0",style:d},zdom("li",null,X.crminfoMsg))),l=_zm.getDOMReferenceMap(n,!0);O=l.addressbook,$.q("body").appendDOM(O)}var i={title:"",buttons:[{txt:zmText.get("zmContactsComponents","addressBook.labels.insert"),callback:function(){zmAdd.insertCont(e)}},{txt:zmText.get("zmContactsComponents","addressBook.labels.cancel"),isCancel:!0,callback:function(){zmAdd.closeAddBook()}}],mask:!0,pos:"left"};zmsDialog.create("zmabk",i);var m=$.q(Q).parent();m.attr("class","SC_pe SC_PopTop"),m.css("top","70px"),$.q("#zmabk").find(".SC_P2r").clearHTML(),$.q(K).clearHTML(),$.q("#zmabk").scrollTop(0);var r,c=zmail.ContactBook.getCategories(),z=[],C=[],f=[],p=[],k=3,u=2,v={},h=c.length;for(z[0]={txt:"All Contacts",data:{id:"my",val:"All Contacts"}},z[1]={sep:!0},z[2]={txt:"General Category",className:"nohr dd_label"},C[0]={sep:!0},C[1]={txt:"Organization Category",className:"nohr dd_label"},r=0;r<h;r++)c[r].isOrg()?(v={txt:c[r].attrs.cname,data:{id:c[r].attrs.cid,val:c[r].attrs.cname}},C[u]=v,u++):(v={txt:c[r].attrs.cname,data:{id:c[r].attrs.cid,val:c[r].attrs.cname}},z[k]=v,k++);for(u=z.length,h=C.length,f=z,r=0;r<h;r++)f[u]=C[r],u++;p[0]={sep:!0},p[1]={txt:"CRM",data:{id:"crm",val:"CRM"}},zmail.IntegrationStatus.CRM&&zmail.isCRMServiceUser&&(f.push(p[0]),f.push(p[1]));var _=$.q(O).find("#allContacts"),g={par:_,clk:function(e){!function(e){var a=e.id,t=e.val;if(void 0!==a){zmUtil.hideMenu();var s=document.createTextNode(t),o=O.querySelector("[data-select]");if($.q(o).clearHTML(""),$.e(A).remove(),$.q(o).appendDOM(s),G=!1,"my"===a)$.e($.q("#zmabk_s")[0]).clearHTML(),$.e($.q("#zmabk_c")[0]).clearHTML(),$.e($.q("#zmabk_a")[0]).clearHTML(),$.e($.q(W)[0]).clearHTML(),$.q("#zmabk").find(".SC_P2r").hide(),$.q("#zmabk .SC_Psa ").remove(),$.q("#zmabk_a").show().scrollTop(0),D=L="a",zmAdd.loadAlpt(L),R=!0,E=U;else if("CRM"===t)$.q("#zmabk_s").hide(),$.q("#zmabk_c").hide(),$.q("#zmabk_a").hide(),G=!0,$.q("#zmabk .SC_Psa ").remove(),$.q(W)[0].style.display="block";else{zmAdd.loadAlpt(a,"category");var d=$.q(A).find("i");$.q(A).off().on("click",function(){d[0].className===V?(d.addClass("msi-check").removeClass(V),ee({attr:"category"})):(d.addClass(V).removeClass("msi-check"),ee({attr:""}))}),U=E}}}(e)},list:f,ulClass:"SC_tin",align:"pleft",leftOffset:-1,container:$.q(Q)[0]};$.q(_).on("click",function(){$.q(_).addClass("SC_ddn"),new zmDropDownMenu(g).paint()}),$.q(Q).css("max-width","500px");var q=zmText.get("zmContactsComponents","addressBook.labels.create"),b=zdom("div",{className:"SC_conSel"},zdom("div",{className:"SC_conLbl SC_thm"},o.selectionListText||t.target.innerText||""),zdom("div",{className:"SC_conSelLst"}));M=zdom("div",{className:"SC_mkeGrp",id:"SC_Category"},zdom("span",{className:"SC_mkeGrpTxt"},X.create),zdom("input",{className:"SC_grpName SC_dyn",type:"text",placeholder:q}),zdom("span",{className:"grp_save"},zdom("i",{className:"msi-edit","data-tooltip":zmText.get("zmContactsComponents","addressBook.edit")})),zdom("span",{className:"grp_close"},zdom("i",{className:"msi-close","data-tooltip":zmText.get("zmContactsComponents","addressBook.close")}))),B=zdom("li",{className:"SC_no",id:"noMatchFound"},zdom("div",null,zdom("i",null),zdom("span",null)),zdom("div",null,zmText.get("zmContactsComponents","addressBook.labels.noMatchFound"))),$.q(b).insertDOMAfter($.q(Y));var S=parseInt($.q(Y).css("max-height"))/2;$.q(Y).css("min-height",S+"px");var x=parseInt($.q(Q).css("max-width"));$.q(Q).css("min-width",x+"px"),T(),P=$.q(W),$.q("#zmabk_srch input").mousedown(function(e){$.q("#zmsdialog_zmabk #zmabk_srch input").focus(),zmUtil.stopEvents(e)}).keyup(function(e){if(""===$.q(this).val().trim()){if(G)return zmAdd.loadAlpt($.q(this).val(),"crm"),!1;L="a",$.q("#zmabk_s li").remove(),zmAdd.loadAlpt("a")}else G?zmAdd.loadAlpt($.q(this).val(),"crm"):zmAdd.loadAlpt($.q(this).val(),"search");zmUtil.stopEvents(e)}),$.q("#zmabks_sel").click(function(e){var a=e.target;"I"===a.tagName&&Z(a)}),$.q("#zmabk").find(".SC_P2r").click(function(e){var a=e.target;"LI"!==a.tagName&&(a=$.e(e.target).parents("li")),Z(a)}),$.q("#zmabk").find(".SC_P2r").scroll(function(e){H||zmAdd.loadAlpt("","orgper")}),$.q(".SC_conSel").click(function(e){var a=e.target;"msi-close"===a.className&&N(a.closest("div"))});var y=$.query(Y)[0].offsetHeight-$.query("#zmabk_hdr")[0].offsetHeight+"px";$.q("#zmabk").show().children("ul").css({height:y,width:"500px",overflow:"hidden","overflow-y":"auto"}),zmAdd.loadAlpt(L),w={},$.q("#zmsdialog_zmabk #zmabk_srch input").focus()},loadAlpt:function(e,a){var t,s="abcdefghijklmnopqrstuvwxyz";if(void 0===a&&(D="a"),"orgper"===a){if(D="a",!R)return;if(F<10&&(t=s.indexOf(L),L=s.substring(t+1,t+2),I=[]),"z"===L)R=!1;else if(!$.q("#addLoad")[0]){var o=zdom("li",{id:"addLoad"},zmText.get("zmContactsComponents","addressBook.labels.loading"));$.q("#zmabk_a").appendDOM(o)}}else{if("category"===a)return $.q("#zmabk").find(".SC_P2r").hide(),$.q($.q("#zmabk_c")[0]).clearHTML(),D="c",H=!0,L="a",void zmail.ContactBook.get({categoryid:e}).done(function(e){if(0===(z=e).length)return $.e(B).remove(),$.q("#zmabk_c")[0].style.display="block",void $.q("#zmabk_c").appendDOM(B);var a;zmAdd.constructContacts(z,"category"),a=$.q(A).find("i"),$.q(A).insertDOMAfter($.q("#zmabk_hdr")),$.q("#zmabk_c li").length===$.q("#zmabk_c li.sel").length?a.addClass("msi-check").removeClass(V):a.addClass(V).removeClass("msi-check")});if("search"===a){$.q("#zmabk").find(".SC_P2r").hide(),$.e($.q("#zmabk_s")[0]).clearHTML(),$.q("#zmabk_a").hide(),$.e($.q("#zmabk_c")[0]).clearHTML(),D="s",L="a";var d={str:e,expected:1e3,type:["personal"],excludeOrgUsers:H=!0};return void zmail.ContactBook.get(d).done(function(e){if(0===(z=e).length){var a=_zm("#","zmabk_"+D),t=zmText.get("zmContactsComponents","addressBook.labels.noMatchCrmFound"),s=zdom("li",{className:"SC_no"},zdom("div",null,zdom("i",null),zdom("span",null)),zdom("div",null,t));return a.appendChild(s),void _zm.show(a)}zmAdd.constructContacts(z)})}if("crm"===a){$.q($.q("#zmabk_s")[0]).clearHTML(),$.q("#zmabk_a").hide();var n=zmText.get("zmContactsComponents","addressBook.labels.noMatchCrmFound");return $.q($.q("#zmabk_c")[0]).clearHTML(),D="crm",H=!0,L="a",0===e.trim().length&&($.e(P[0]).clearHTML(),P.appendDOM(i)),void(3<=e.trim().length?($.q("#zmabk").find(".SC_P2r").hide(),zmail.ContactBook.get({str:e,type:["crm"]}).done(function(e){if(z=e,$.q($.q(W)[0]).clearHTML(),0===z.length){var a=_zm("#","zmabk_"+D),t=zdom("li",{className:"SC_no"},zdom("div",null,zdom("i",null),zdom("span",null)),zdom("div",null,n));return a.appendChild(t),void _zm.show(a)}zmAdd.constructContacts(z)})):($.q(P[0]).clearHTML(),P.appendDOM(i)))}}var l={fn:L,expected:10,sliceExpected:!(H=!1),exclude:I,type:["personal"],excludeOrgUsers:!0};zmail.ContactBook.get(l).done(function(e){$.q("#zmabk_c").hide(),$.q("#zmabk_s").hide(),z=e,zmAdd.constructContacts(z,"orgper")})},constructContacts:function(e,n){var t,a,s,l,i,m;if(s="crm"!==n?($.q(".noMatchFound").remove(),$.q("#addLoad").remove(),F=(a=e).length):(a=e).length,t=function(e,a,t){var s=zdom("div",{className:"SC_avtr"});if(i=zdom("li",{"data-eid":a.eid,className:e.cls},zdom("div",{"data-primary":"primary"},zdom("span",null,zdom("b",{"data-name":"name"},e.name)),zdom("span",{id:"emailid"},a.eid)),zdom("font",null,zdom("i",{className:e.chk}))),m=_zm("#","zmabk_"+D),_zm.show(m),"crm"!==n&&(s=z[l].avatar(),"category"===t&&a.isPrimary)){var o=zdom("div",{className:"SC_frt"},zdom("i",{className:"msi-fav SC_fav"})),d=$.q(i).find("[data-primary]");$.q(d).prependDOM(o)}!function(e,a,t,s){for(var o in $.q(s).insertDOMAfter($.q(a).find("div")),w)o===a.getAttribute("data-eid")&&(a.className="sel",$.q(a).find("i").addClass("msi-tick"));t.appendChild(a)}(0,i,m,s)},"crm"!==n)for(l=0;l<s;l++){var o=z[l].attrs,d="",r="";if(o.eid&&(!o.eid||-1===o.eid.indexOf("List"))){I[++j]=o.eid,$.q("#zmabk_sel .SC_cs").length&&void 0!==w[o.eid]&&(d="msi-tick",r="sel"),o.photo||(o.photo=zmResource.get("image","SC-Photo.png"));var c=o.fn;o.ln&&(c+=" "+o.ln),t({name:c,cls:r,chk:d},o,n)}}else{a.forEach(function(e){var a=e.fullName;t(e,{name:a,chk:"",cls:""},"crm")})}$.q("#zmabk_a")[0].scrollHeight<=$.q("#zmabk_a")[0].clientHeight+$.q("#zmabk_a")[0].scrollTop&&"orgper"===n&&zmAdd.loadAlpt("","orgper")},resizeSelPane:function(){var e=document.getElementById("zmabk_sel");60<=$.q(K).height()&&($.q(K).css({height:"60px",overflow:"auto"}),e.scrollHeight<e.getBoundingClientRect().height&&0===e.scrollTop&&$.q(K).css({height:"auto",overflow:"hidden"})),$.q("#zmabk_sel .SC_cs").length?$.q(K).show():$.q(K).hide();var a,t=parseInt($.q("#zmabk").data("def"));a="search"===L?_zm("#","zmabk_s"):1===L.length?_zm("#","zmabk_a"):_zm("#","zmabk_c");var s=t-_zm("#","zmabk_sel").getBoundingClientRect().height;a.style.height=s+"px"},insertCont:function(e){var a=[],t=0;for(var s in w)a[t]=w[s],t++;e&&"function"==typeof e&&e(a),zmAdd.closeAddBook()},closeAddBook:function(){_zm("#","zmabk_a").setAttribute(e,0),_zm("#","zmabk_c").setAttribute(e,0),_zm("#","zmabk_s").setAttribute(e,0),_zm("#","zmabk_crm").setAttribute(e,0),E=[],zmsDialog.remove(),$.q(K).remove(),$.q("#zmabk").remove(),w={}}}}();
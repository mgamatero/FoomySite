"use strict";define([],function(r){var s,o,i=r("_zm"),c=r("$"),p=r("zmText"),n=r("zmAjq"),l=r("zmAppLoader"),e=r("zmail.Core.Namespaces"),f=r("zmail.Utils.DOM"),m=e.create("zmApp"),t=!1;zmail.extAppsDeferred={},zmail.extAppsDeferred.contacts={},zmail.extAppsDeferred.calendar={};var u={m:"mail",n:"notes",c:"calendar",t:"task",l:"bookmarks",cn:"contacts"},d=function(e){if(e=(e||"").trim()){var t=e.indexOf("//");return 0<=t&&(t+=2,e=e.substring(t)),"//"+e}},z=function(e){var t=c.Deferred(),n=zmComponent.loadingMasks({maskText:e,noMaskEvent:!0});t.done(function(){setTimeout(function(){n?n.remove():c.q("#jsZmLoadBnd").remove()},500)}),zmsuite.appLoadingBand=t},a=function(){var t,e;if(t=c.Deferred(),window.__zcalDev)return window.__zcalDev.loadConfig.totFiles.then(function(e){s=e,t.resolve(e)}),t;if(s)t.resolve(s);else{e="/zm/ncal/loadjs.do",e+="?lang="+p.currentLang.substr(0,2),p.displayedVariant&&(e+="&country="+p.displayedVariant);n.XHR({u:e,t:"GET",fn:function(e){t.resolve(e)},onerror:function(){i.succErrMsg("e",p.get("appsframework","calendarError")),t.reject()}})}return t},v=function(){var t;return t=c.Deferred(),c.when(a()).then(function(e){s=e,t.resolve()}),t},k=function(e){if(zmail.extAppsDeferred.calendar[e])return zmail.extAppsDeferred.calendar[e].promise();var a=c.Deferred();return v().then(function(){var t,n;t=s.jsPath||zmail.urls.calURL,n=s.cssPath||zmail.urls.calURL,s[e].css&&l.loadFiles("extcss",(s[e].css||[]).map(function(e){return d(n+e)})),l.loadFiles("extjs",(s[e].js||[]).map(function(e){return d(t+e)})).then(a.resolve)}),(zmail.extAppsDeferred.calendar[e]=a).promise()},h=function(){var t;return t=c.Deferred(),function(){var t;t=c.Deferred(),o?t.resolve(o):n.XHR({u:"/zm/zc/new/jsp/loaded.jsp",t:"GET",fn:function(e){t.resolve(e)},xhr:!1});return t}().then(function(e){o=e,t.resolve()}),t},A=function(e,t){k("calendar").done(function(){c.publish(e,[t])})},g=function(e){t?e&&c.publish(e):function(e){if(zmail.extAppsDeferred.contacts[e])return zmail.extAppsDeferred.contacts[e].promise();var a=c.Deferred();return h().then(function(){var t,n;t=o.jsPath,n=o.cssPath,o[e].css&&l.loadFiles("extcss",(o[e].css||[]).map(function(e){return d(n+e)})),l.loadFiles("extjs",(o[e].js||[]).map(function(e){return d(t+e)})).then(function(){c.publish("contacts/metaDataLoaded",{data:o.metaJson}),a.resolve()})}),(zmail.extAppsDeferred.contacts[e]=a).promise()}("contacts").done(function(){t=!0,e&&c.publish(e)})};c.extend(!0,m,{currentApp:"m",selectApp:function(e){e&&!zmail.fromOtherService&&(c.publish("zmsuite/loadApp",{app:e}),zmLHSApps.selectApp(u[e]))},showApp:function(e,t){r("zmUtil").hideMenu();var n=p.get("appsframework","createText");"m"===(m.selectedApp=e)?(n=i.isSmartComposeEnabled()?p.get("appsframework","smartCompose"):p.get("appsframework","composeText"),function(){var e=r("zmsuite"),t=r("zmInit"),n=r("zmTab");if(e.isWorkspaceAvailable("zm_Container")){var a=e.getAppObj("zm_Container");n.setTabForApp(a.obj),e.showApp("zm_Container"),e.getLeft().setListener("click",function(e){t.bindLeftActions(e)}),e.getLeft().setListener("contextmenu",function(e){t.bindLeftActions(e)}),e.getLeft().getNodes()[0].getLayer("zmlTreeH").setChildToggle(t.viewChild)}else t.initMailSuite()}()):"n"===e?(n=p.get("appsframework","createNote"),function(n){var e=r("zmsuite"),t=r("zmTab");if(e.isWorkspaceAvailable("zm_notes")){var a=e.getAppObj("zm_notes");t.setTabForApp(a.obj),e.showApp("zm_notes"),zmModules.notes.getNotesApp().then(function(e){(0,e.showNotesApp)(n)})}else z(p.get("appsframework","switchingBand.notes")),zmModules.notes.getNotesApp().then(function(e){var t=e.notesLoad;zmail.ContactBook.fetchProcess.then(function(){t(n)})})}(t)):"t"===e?(n=p.get("appsframework","createTask"),r("zmsuite").isWorkspaceAvailable("zm_task")?r("zmTask").init():(z(p.get("appsframework","switchingBand.tasks")),l.load("task").then(function(){r("zmTask").init()}))):"c"===e?(n=p.get("appsframework","createEvent"),A("/calendar/load")):"cn"===e?(n=p.get("appsframework","createContact"),g("/contacts/load")):"l"===e&&(n=p.get("appsframework","createLink"),r("zmsuite").isWorkspaceAvailable("zm_link")?zmModules.bookmarks.getApp().then(function(e){(0,e.init)()}):(z(p.get("appsframework","switchingBand.links")),zmModules.bookmarks.getApp().then(function(e){var t=e.init;zmail.ContactBook.fetchProcess.done(function(){t()})}))),zmLHSApps.selectApp(u[e]),m.selectApp(e);var a=f.selector(".zmNewBtn span").eq(0);f.setText(a,n),m.currentApp=e},loadCalendar:A,loadCalendarJS:v,loadPicker:function(){k("picker"),g()},loadStreamEvent:function(e){k("streamEvent").done(function(){"function"==typeof e&&e()})},loadCalendarCSS:function(){a().then(function(e){var t=e.cssPath||zmail.urls.calURL;e.calendar.css&&l.loadFiles("extcss",(e.calendar.css||[]).map(function(e){return d(t+e)}))})},loadCalendarSettingsResources:function(){var e=c.Deferred();return k("setting").done(e.resolve).fail(e.reject),e.promise()}});return zmail.postJsDeffered.promise.then(function(){m.loadPicker()}),m});
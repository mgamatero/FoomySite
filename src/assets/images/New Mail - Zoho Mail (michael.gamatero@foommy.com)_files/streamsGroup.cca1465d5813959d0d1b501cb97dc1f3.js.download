"use strict";var __rollupModule=function(e){var t=zmail.Core.Namespaces.get("zmail.DataLayer"),a=t.DSModel,r=t.DSCollection,i=t.Adapter.HTTPAdapter,U=null,C=function(e){var t=ZMStore.peekRecord("GroupAction",e);return t||(M(),t=ZMStore.peekRecord("GroupAction",e)),t},s=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getDefaults",value:function(){return{name:"",owner:"",scount:""}}},{key:"getIdAttribute",value:function(){return"id"}},{key:"updateMarkAllReadProgress",value:function(e){this.set("markAllReadProgress",e)}},{key:"updateUnreadType",value:function(e){this.set("unreadType",e)}},{key:"markPostsRead",value:function(n,p,m,d){var l=this;l.triggerAction("markAllRead",{url:zmail.conPath+"/post.do",etype:n,fromHome:d}).then(function(e){var t=e.resp;if("INTERNAL_ERROR"!==t.code){if(!t.sch){var a,r,i=0;if(t&&t.unreadCount&&"-1"!==n&&(i=t.unreadCount),l.id===zmail.zuid)if(d)r=(r=l.get("aucount")+(i-l.get("scount")))<0?0:r,zmUtil.changeAllUnread("",r);else{var s=zmStreamsApp.util.getGroupDetails();for(var o in s)zmUtil.changeUnread(o,"",0)}else(a=g(zmail.zuid))&&(r=(r=a.get("aucount")+(i-l.get("scount")))<0?0:r,zmUtil.changeAllUnread("",r));zmUtil.changeUnread(l.id,"",i),"function"==typeof p?p():zmStreamsApp.events.clearList(l.id)}}else m&&m()},function(){m&&m()})}},{key:"getHashTags",value:function(r,i,e){var s=this;r=r||"loadhashtags";var t=s.get(r);if(t)return"request"===t?[]:(i&&i(t),t);s.set(r,"request"),s.triggerAction("fetchTags",{actionType:r,startsWith:e}).then(function(e){var t=e.resp.hashTags||[],a=[];return t.length?(t=_.unique(t.map(function(e){return e.trim()})),_.each(t,function(e){a.push({name:e})})):a=[],s.set(r,a),i&&i(a),s},function(){s.set(r,"request")})}},{key:"correctUnread",value:function(){var o=this;o.triggerAction("correctUnread").then(function(e){var t=e.resp,a=t.count;if(void 0!==a){var r;if(a=parseInt(a),o.id!==zmail.zuid)r=parseInt(t.aucount),zmUtil.changeAllUnread(!1,r);else if(t.gcount){var i=zmStreamsApp.util.getGroupDetails()||{};for(var s in t.gcount)!i[s]||i[s].disabled||i[s].hidden||(r=parseInt(t.gcount[s]),zmUtil.changeUnread(s,"",r)),I(s,t.gcount[s])}o.id===zmail.zuid?t.aucount?(zmUtil.changeAllUnread("",parseInt(t.aucount)),zmUtil.changeUnread(o.id,"",a),I(zmail.zuid,a)):zmUtil.changeAllUnread("",a):zmUtil.changeUnread(o.id,"",a)}})}},{key:"createChat",value:function(){this.triggerAction("createChat",{url:zmail.conPath+"/util.do",type:"GET"})}},{key:"updateHashTagforAutofill",value:function(e){var t=this.getHashTags("loadhashtags");-1===_.pluck(t,"name").indexOf(e)&&(t.push({name:e}),this.set("loadhashtags",t))}}]),t}(a),o=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getUrl",value:function(){return zmail.conPath+"/stream.do"}},{key:"serialize",value:function(e,t){var a,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=t.get("id"),s={groupId:i};switch(e){case"markAllRead":a={actionType:"markallAsRead",mode:"markallread",streamsView:!0,entityType:r.etype},i!==zmail.zuid||r.fromHome||(a.mode="hmarkallread");break;case"fetchTags":a={actionType:r.actionType||"loadhashtags",mode:"hashTags"},r.startsWith&&(a.startsWith=r.startsWith,a.actionType="autocomplete");break;case"correctUnread":a={actionType:"viewGroupData",streamsView:!0,mode:"correctUnread"},s.allUnreadView=!0;break;case"createChat":a={mode:"createGroupChat"}}return s=$.extend(s,a,!0)}},{key:"normalize",value:function(e,t,a){return t||{}}}]),t}(i),n=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"getBaseModelClass",value:function(){return s}}]),t}(r),p={adapters:[{id:"http-adapter",type:"default",classObj:o}],default:"http-adapter"};U=ZMStore.createInstance("GroupAction",n,{adapterConfig:p,metaInfo:{}});var c="div[data-gid=";window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({});var T="",m=function(e){var t=C((e=e||{}).groupId);t&&t.set("scount",e.count)},d=function(e,t,a){if(e=e||zmail.zuid,zmUtil.getGroupOrder().length){var r=C(e);if(r)return r.getHashTags(t,a)}return[]},M=function(){var e=U,t=zmUtil.getGroupOrder(),a=zmail.zuid;-1===t.indexOf(a)&&t.unshift(a);var r={list:zmStreamsApp.util.getGroupDetails(void 0,!0),order:t};if(_.each(r.list,function(e,t){if(e.id===zmail.zuid){var a=zmText.get("streams");e.name=a.common.labels.home,e.photo=zmStreamsApp.util.selfPhotoUrl()}}),T=zmStreamsApp.util.orderComments(r.list,r.order),e&&!e.models.length)e.add(_.toArray(T),{parse:!0});else{var i=r.list;_.each(i,function(e){m({groupId:e.id,count:e.scount})})}d()},l=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree");if(t.el.length){var a={view:"all",gridview:"grid"===zmAdHocSettings.getStreamsListType(),addTitleHeader:!0};if(e.id===zmail.zuid){var r=C(e.id);if(r)0<r.get("aucount")&&(a.view="unread")}zmStreamsApp.PostApp.init("",e.id,a,!0,!0),zmStreamsApp.util.removeCommentClass(e.id,t)}zmUtil.hideMenu()},u=function(e){if(e){U.models.length&&U.remove(e),zmStreamsApp.util.removeGroup(e);var t,a=(t=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree")).listObject[e];_.isEmpty(a)||t.deleteNode(t.getRowObj(e));var r=t.listObject.more,i=!_.isEmpty(r)&&!r.hideNode;zmUtil.constructStreamLHS(!i)}},g=function(e){return C(e)},O=function(){return f.GroupId},I=function(e,t){t=parseInt(t);var a=zmStreamsApp.events.getCurrentView();if(O()===zmail.zuid&&a&&"unread"===a.view){var r=$.e(a.elm).find(c+e+"]");if(r.length){var i=r.find(".zmFL>.greyText");if(0===t)i.remove(),r.find(".zmFR").remove();else{var s=zmText.get("streams"),o=1===t?s.common.labels.unread:s.common.labels.unreads,n="("+zmText.applyArgs(o,{count:t})+")";i.length?i.text(n):$.e(zdom("span",{className:"greyText"},n)).insertDOMAfter(r.find(".unreadGName"))}}}},N=zmStreamsApp.constants.notifications,z=zmStreamsApp.constants.groupEvents,H="zmStreamTree";window.zmStreamsApp=window.zmStreamsApp||Zmail.App.extend({}),window.zmStreamsApp.GroupApp=window.zmStreamsApp.GroupApp||Zmail.App.extend({});var f=window.zmStreamsApp.GroupApp;return f.GroupId="",f.requestGroupId="",f.updateAllUnreadCount=function(e){var t=C(zmail.zuid);t&&t.set("aucount",e)},f.correctUnread=function(e){var t=C(e);t&&t.correctUnread()},f.emailGroup=function(e){zmUtil.compose({TO:zmStreamsApp.util.getGroupDetails(e).eid})},f.removeGroup=u,f.updateGroupListing=function(e){U||M();var r=f.requestGroupId;if(r&&U){if(e){var t={u:zmail.conPath+"/getGroups.do",p:{mode:"groups"},t:"POST",fn:function(e){if(e){var t=e.list?e.list:e.groups;for(var a in zmStreamsApp.util.addGroup(t[r]),t)zmUtil.changeUnread(String(a),"",t[a].scount)}}};zmAjq.XHR(t)}else u(r);$.publish("streams/addRemGroupSelf",{isAdd:e,gid:r})}},f.init=M,f.showtrendingTags=function(t,e){var a=C(e);a.getHashTags("trendingtags",function(){var e=a.get("trendingtags");zmStreamsApp.util.createPopup({items:e,parent:t,type:"trendingtags",liHover:!1,parentClass:"SC_tTags",callback:function(e,t){var a=$.e(t).data("text");if(zmStreamsApp.util.hideMenu(),a){var r=zmStreamsApp.events.getCurrentView(),i=zmStreamsApp.PostApp;i.showOtherTab("#"+a,"hashTag",a,zmStreamsApp.events.getCurrentGroupId()),i.fetchPosts({type:"other",ele:r.elm,previous:r.tab})}}})})},f.createGroupChat=function(e){C(e).createChat()},f.fetchHashTags=d,f.clearTags=function(e,t){e=e||zmail.zuid,t=t||"trendingtags";var a=C(e);a&&a.get("type")&&a.unset(t)},f.getModel=g,f.markAllRead=function s(o){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"-1",p=2<arguments.length?arguments[2]:void 0,m=C(o),d=function(e,t,a){var r=zmText.get("streams"),i=zmStreamsApp.PostApp.template.errorTemplate(r.streams.post.errMarkRead);return _zm(".","zmLink",i)[0].onclick=function(){s(e,t,a)},i};if(m){var l=zmStreamsApp.events.getCurrentView(),e=f.GroupId,t=zmStreamsApp.constants.workspaceId;zmsuite.isWorkspaceAvailable(t)&&e===o&&!p&&"unread"===l.view&&zmStreamsApp.PostApp.hideMarkAsRead(!0),m.updateMarkAllReadProgress(!0);var u=m.get("unreadType")||[];u.push(n),m.set("unreadType",u),zmStreamsApp.events.markAsReadProgress(o,p),m.markPostsRead(n,function(){m.updateMarkAllReadProgress(!1);var e=(u=m.get("unreadType")||[]).indexOf(n);if(-1!==e&&u.splice(e,1),m.updateUnreadType(u),p){var t=$.e(l.elm).find(c+o+"]")[0];if(!$.e(t).siblings().length){var a=t.parentNode;_zm.clearHTML(a),a.appendChild(zmStreamsApp.PostApp.template.noPost()),zmStreamsApp.PostApp.hideMarkAsRead(!0)}_zm.remove(t)}else zmStreamsApp.events.clearList(o),o===zmail.zuid&&$.e(zmStreamsApp.events.getCurrentView().elm).find(".SC_GrpBlock").remove()},function(){m.updateMarkAllReadProgress(!1);var e=(u=m.get("unreadType")||[]).indexOf(n);if(-1!==e&&u.splice(e,1),m.updateUnreadType(u),p){var t=$.e(l.elm).find(c+o+"]");t.length&&(t.find(".SC_grpPosts").empty(),t.find(".SC_grpPosts")[0].appendChild(d(o,n,p)))}else{var a=zmStreamsApp.events.getCurrentView();if(a)if($.e(a.elm).data("groupId")===o&&"unread"===a.view)$.e(a.elm).empty().appendDOM(d(o,n,p));else{var r=zmText.get("streams");_zm.succErrMsg("e",r.streams.post.errMarkRead)}}var i=zmail.mailLeft.getNodes()[0].getLayer("zmStreamTree");i.el.length&&zmStreamsApp.util.addReadLoader(o,i,!0)},p)}zmUtil.isGroup(zmStreamsApp.events.getCurrentGroupId())&&zmStreamsApp.PostApp.markPostRead(o)},f.updateHashTag=function(e,t){t=t||String(zmail.zuid);var a=C(t),r=e.text;r=-1!==r.indexOf("#")?r.substring(1):r,a.updateHashTagforAutofill(r)},f.getAllUnread=function(){U||M();var e={u:zmail.conPath+"/stream.do",t:"POST",fn:function(e){var t,a,r=0,i=zmStreamsApp.util.getGroupDetails();for(t in e)!(a=i[t])||a.hidden||a.disabled||(r+=e[t],zmUtil.changeUnread(String(t),"",e[t]));zmUtil.changeAllUnread(!1,r)},p:{mode:"allucount"}};zmAjq.XHR(e)},f.getCurrentGroup=O,f.showDropDown=function(e,i){var s=[],o=[];_.each(T,function(e){if(e){var t=zmStreamsApp.util.getGroupDetails(e.id),a=!t.disabled,r=t.hidden;e&&e.id===zmail.zuid&&e.id!==String(i)?(t.photo=zmStreamsApp.util.selfPhotoUrl(),t.avatar=zmStreamsApp.util.getContactDetails([zmail.zuid])[zmail.zuid].avatar,s.push(t)):_.size(t)&&e.id!==String(i)&&!r&&a?s.push(t):r&&a&&o.push(t)}}),s=s.concat(o),zmStreamsApp.util.showGroupDetails({groupInfo:s,elm:e,fn:l})},f.showMoreOption=function(e,t){var a=zmStreamsApp.util.getGroupDetails(t),r=zmText.get("streams"),i=r.groupSubscription.hideGrp,s=r.groupSubscription.grpInfo,o=[];a.isOwner&&(s=r.groupSubscription.grpEdit),o.push({txt:s,data:"editGrp"}),a.isOwner&&o.push({txt:r.common.labels.addNewMember,data:"addMem"}),a.hidden&&(i=r.groupSubscription.showGrp),o.push({txt:i,data:"hideGrp"});zmStreamsApp.util.createPopup({items:o,parent:e,parentClass:"SC_Sopt",type:"oneLine",noArrow:!0,avoidScroll:!0,align:"pleft",hoverElm:e,callback:function(e){zmStreamsApp.util.hideMenu(),"editGrp"===e.item?zmUtil.loadGroupManagement().then(function(){zmStreamsApp.GroupManageApp.triggerEditGroup(t,[{tab:"General",default:!0},{tab:"Calendar"},{tab:"Task"},{tab:"Members",callback:zmStreamsApp.events.loadPostsOfUsers}])}):"addMem"===e.item?zmModules.getMemberViewModule().then(function(e){(0,e.addMemberDialog)(t)}):"hideGrp"===e.item&&zmUtil.loadGroupManagement().then(function(){zmStreamsApp.GroupManageApp.hideGroup(t)})}})},!zmail.isPopupMail&&zmail.ContactBook&&zmail.ContactBook.groupsFetched.done(function(){M()}),function(){var p=function(e){var t,a,r=(t=zmail.mailLeft.getNodes()[0].getLayer(H)).listObject[e];if(_.isEmpty(r)){a=zmStreamsApp.util.getGroupDetails(e),t.listObject[e]=a;var i=zmList.getRowInfo(a.id,H);i[a.id].hideNode=!1,t.insertNodeAfter(i,t.listObject,zmail.zuid);var s=t.listObject.createGrp;_.isEmpty(s)||t.deleteNode(t.getRowObj("createGrp"))}};$.subscribe("group/unread",function(e,t){m(t)}),$.subscribe("group/streamsdisabled",function(e,t){var a=t.id;if(a){var r,i=(r=zmail.mailLeft.getNodes()[0].getLayer(H)).listObject[a];if(!_.isEmpty(i)){r.deleteNode(r.getRowObj(a));var s=r.listObject.more,o=!_.isEmpty(s)&&!s.hideNode;zmUtil.constructStreamLHS(!o)}if(i=r.listObject.disabledGrp,_.isEmpty(i)){r.listObject.disabledGrp={name:zmText.get("commonUtils","streams.disGrp"),id:"disGrp",txtNodeClass:"SC_thm",hideNode:!1,rowTitle:zmText.get("commonUtils","streams.stDisGrp")};var n=r.listObject.less;r.listObject.disabledGrp.hideNode=!(_.isEmpty(n)||!n.hideNode);var p=zmList.getRowInfo("disabledGrp",H);_.isEmpty(n)?r.appendNode(p,r.mapObject):r.insertNodeBefore(p,r.listObject,r.listObject.less.id)}}}),$.subscribe("group/streamsenabled",function(e,t){var a,r;if(a=zmail.mailLeft.getNodes()[0].getLayer(H),t.id){r=a.listObject[t.id],_.isEmpty(r)&&p(t.id);for(var i=zmail.ContactBook.getGroups(),s=_.pluck(i,"attrs"),o=!1,n=0;n<s.length;n++)if(s[n].disabled){o=!0;break}o||(r=a.listObject.disabledGrp,_.isEmpty(r)||a.deleteNode(a.getRowObj("disabledGrp")))}}),$.subscribe("group/showHideGroup",function(e,t){var a=t.id,r=zmail.mailLeft.getNodes()[0].getLayer(H);if(t.hidden){var i=r.listObject[a];_.isEmpty(i)||r.deleteNode(r.getRowObj(a))}else{p(a);var s=zmStreamsApp.util.getGroupDetails(a);zmUtil.streamUpdate({groupId:a,count:s.scount})}var o=r.listObject.more,n=!_.isEmpty(o)&&!o.hideNode;zmUtil.constructStreamLHS(!n)}),$.subscribe(z.groupAdded,function(e,t){var a=zmStreamsApp.util.getGroupDetails(t.groupID);if(U||M(),U){U.add(a);var r=C(t.groupID),i=a.scount;a.scount=i||0,T.splice(1,0,a),p(r.id)}}),$.subscribe(z.groupEdit,function(e,t){var a=t.props,r=t.id;if(a.hasOwnProperty("name")){var i=zmail.mailLeft.getNodes()[0].getLayer(H);if(!_.isEmpty(i.listObject[r])){var s=zmList.getRowInfo(r,H);s[r].name=a.name,i.editNode(s,i.mapObject)}var o=zmStreamsApp.constants.workspaceId;if(zmsuite.isWorkspaceAvailable(o)){var n=zmsuite.getCenter(o);n[0].getNodes()[1].$el.data("groupId")===r&&n.leftIconHeader.collection.get("groupName").set({text:a.name,avatar:{isGroup:!0,groupId:r}})}}else if(a.hasOwnProperty("photo")){var p=zmStreamsApp.constants.workspaceId;if(zmsuite.isWorkspaceAvailable(p)){var m=zmsuite.getCenter(p);m[0].getNodes()[1].$el.data("groupId")===r&&m.leftIconHeader.collection.get("groupName").set({avatar:{isGroup:!0,groupId:r}})}}});"undefined"!=typeof zmComponent&&zmComponent.notifier&&zmComponent.notifier.addHandler("streams",function(e,t){if(t=t.data||{},U||M(),U){"string"==typeof t.group&&(t.group=$.parseJSON(t.group)),"string"==typeof t.shgroups&&(t.shgroups=$.parseJSON(t.shgroups)),t.group=t.group||{};var a=_.size(t.shgroups)?t.shgroups:[t.group];if(!a||!_.size(a))return;var r,i,s,o=t.ntype,n=[N.mail_type,N.post_mention,N.unshared,N.invite,N.add_post,N.add_comment,N.comment_mention,N.add_task,N.post_group_mention,N.comment_group_mention,N.add_event,N.update_event,N.add_group_member,N.mail_share,N.add_attachment,N.add_tweet,N.change_task_due_date,N.change_task_assignee,N.change_task_status,N.change_task_priority,N.change_task_category,N.change_task_title,N.change_task_description,N.remove_attachment,N.draft_share,N.draft_shareupdate,N.draft_autosave,N.draft_mailmention,N.mail_share,N.add_link];for(var p in zmUtil.loadGroupManagement().then(function(){zmModules.getMemberViewModule().then(function(e){var t=e.constructMemberPopup,a=e.resetMemberValues,r=e.addMemberDialog,i=e.memberText,s=e.getUserDetails;zmStreamsApp.GroupManageApp.assignFunction({constructMemberPopup:t,resetMemberValues:a,addMemberDialog:r,memberText:i,getUserDetails:s})})}),a){if(r=(s=a[p]).id,i=C(r))if(o===N.add_group_member||o===N.remove_group_member){var m=o===N.add_group_member,d=m?"addMember":"removeMember",l=m?t.memberzuid.split(","):[t.memberzuid],u=zmStreamsApp.util.getContactDetails(l),c=[];for(var g in u)c.push({zoid:zmail.zoid,id:u[g].zid,email:u[g].eid});zmStreamsApp.util.groupManagement({mode:d,groupId:i.id,members:c});var z=i.get("members");z=m?z.concat(t.memberzuid):_.without(z,t.memberzuid),i.set("members",z),zmsuite.isWorkspaceAvailable("zmStreamsApp")&&O()===r&&zmsuite.getCenter("zmStreamsApp").leftIconHeader.collection.get("members").set("text",zmStreamsApp.GroupManageApp.memberText(zmStreamsApp.util.getGroupDetails(r))),zmStreamsApp.events.getCurrentGroupId()===r&&zmStreamsApp.util.reloadHeader(r),m?$.publish("streams/addGroupMember",{gid:r,zid:t.memberzuid}):$.publish("streams/removeGroupMember",{gid:r,zid:l})}else if(o===N.change_moderator){var f="removeModerator",h=zmStreamsApp.util.getContactDetails([t.memberzuid]),v=[];for(var b in h)v.push({zoid:zmail.zoid,id:h[b].zid,email:h[b].eid});"Moderator"===t.memberrole&&(f="addModerator"),zmStreamsApp.util.groupManagement({mode:f,groupId:i.id,members:v}),$.publish("streams/changeMemberRole",{mode:f,gid:i.id,zid:t.memberzuid}),zmStreamsApp.events.getCurrentGroupId()===r&&t.memberzuid===zmail.zuid&&zmStreamsApp.util.reloadHeader(r)}if(-1!==n.indexOf(o)&&t.nby!==zmail.zuid&&s.isGroup||o===N.add_tweet){if(zmUtil.isGroupMember(zmail.zuid,r)){var A=_.pluck(T,"id").indexOf(r),S=void 0;-1!==A&&(S=T[A],T.splice(A,1),T.splice(1,0,S))}var y=zmail.mailLeft.getNodes()[0].getLayer(H),G=zmList.getRowInfo(r,H);if(y&&G&&G[r]){G[r].hideNode=!1,y.moveNode(G,void 0,zmail.zuid);var k=$.e(y.el).find("#more");if(k.is(":visible")&&5<k.index()){var w=$.e(y.el).find("#more").prev().attr("id");G=zmList.getRowInfo(w,H),y.moveNode(G,void 0,"more"),y.hideNode(w)}}}}o===N.correctUnread&&(zmUtil.changeUnread(t.nsid,"",t.count),zmUtil.changeAllUnread("",t.aucount),I(t.nsid,t.count))}})}(),e.grpApp=f,e}({});window.__rollupModule=void 0;
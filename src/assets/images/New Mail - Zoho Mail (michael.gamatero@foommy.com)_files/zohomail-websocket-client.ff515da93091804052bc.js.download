(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{OtGb:function(e,t,s){"use strict";var i=s("Xuck"),n=100,o=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:n;arguments.length>1&&void 0!==arguments[1]&&arguments[1];babelHelpers.classCallCheck(this,e);this.maxSize=t,this._logs=[],this._currentSize=0}return babelHelpers.createClass(e,[{key:"push",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._currentSize>=this.maxSize&&this.pop(),this._logs.push({msg:e,time:new Date,opts:t}),this._currentSize++}},{key:"pop",value:function(){if(this._currentSize>0)return this._currentSize-=1,this._logs.shift()}},{key:"getLogs",value:function(){return this._logs}},{key:"clear",value:function(){this._logs.splice(0),this._currentSize=0}},{key:"toString",value:function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).separator||"\n",t="";return this._logs.forEach(function(s){t+=s.time+"--\x3e "+s.msg+e}),t}},{key:"downloadLog",value:function(e,t){"function"==typeof e&&e(this.toString(),babelHelpers.objectSpread({fileName:Date.now()},t))}}]),e}(),r=i.a,a="--/--",c="FRH",u="cst",l="s",h="m",d="set",g="mod",v="ls",b="type",f="sm",p="c",_="broadcast",S="push",y=50,m=function(e){function t(){var e,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,t),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));var i=babelHelpers.assertThisInitialized(e);return i._latestSeqNo=Number(s.latestSeqNo)||-1,i._refreshReceived=!1,i._pubsub=new r,i._broadcastPubSub=new r,i._logger=new o(200),i._notifier=s.notifier,i.debugLog=s.debugLogger,i._activitylogger=new o(200),i.duplicateOccurrence=0,e}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"setLatestSeqNo",value:function(e){this.debugLog("WS :: Seq number updated: "+e),this._latestSeqNo=Number(e)}},{key:"getLatestSeqNo",value:function(){return this._latestSeqNo}},{key:"subscribePushMsg",value:function(e,t){this._pubsub.on(e,t)}},{key:"unsubscribePushMsg",value:function(e,t){this._pubsub.off(e,t)}},{key:"subscribeBroadcastMsg",value:function(e,t){this._broadcastPubSub.on(e,t)}},{key:"unsubscribeBroadcastMsg",value:function(e,t){this._broadcastPubSub.off(e,t)}},{key:"isSeqNumReceivedValid",value:function(e){var t=this._refreshReceived,s=this.getLatestSeqNo();return e=Number(e),t&&(this._refreshReceived=!1),this.debugLog("WS :: New Seq num received "+e),!(-1!==s&&s!==e-1&&!t)}},{key:"parseAndReturnValidJSON",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t={};try{t=JSON.parse(e)}catch(e){this.debugLog("WS :: Invalid msg format")}return t}},{key:"_processSeqNumber",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=this.getLatestSeqNo();return this.isSeqNumReceivedValid(e)?(this.duplicateOccurrence=0,this.setLatestSeqNo(e),this.lastAckedMsg=t,t.hasOwnProperty(g)&&this.handleNotificationPush(t)):i>=Number(e)?(s.duplicateNotification=!0,i-Number(e)>=y&&(this._activitylogger.push("Duplicate Notification : "+e+" against latestSeq"+i),this.duplicateOccurrence++)):(s.invalidSeqNo=!0,s.lastAckedSeqNo=this.getLatestSeqNo()),s}},{key:"_processLatestSeqMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=this.getLatestSeqNo();-1===s?this.setLatestSeqNo(e):Number(e)>s||Number(e)<s?(t.invalidSeqNo=!0,t.lastAckedSeqNo=this.getLatestSeqNo()):t.duplicateNotification=!0}},{key:"_handlePushMessages",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e===S||e===_){var s=t[g];s&&(e===S?this._pubsub.trigger(s,t):e===_&&this._broadcastPubSub.trigger(s,t))}}},{key:"handleNotificationPush",value:function(e){var t,s={},i={};if(e.hasOwnProperty(h))try{s=JSON.parse(e[h])}catch(e){this.debugLog("Invalid format Received")}if(e.hasOwnProperty(f))try{i=JSON.parse(e[f])}catch(e){this.debugLog("Invalid session data Received")}e.hasOwnProperty(p)&&(t=e[p]),s&&("object"===babelHelpers.typeof(s)&&(s.newWS=!0),this._notifier&&this._notifier(s,{module:e[g],sessionData:i,changeId:t}))}},{key:"processMsg",value:function(e){var t,s,i,n,o={},r=e.data;return r!==a&&this._logger.push(r),r===a?(this.debugLog("WS :: Pong Messsage Received"),o):r===c?(this._refreshReceived=!0,o.refreshView=!0,o):0===r.indexOf(c)?(o.refreshView=!0,this.setLatestSeqNo(r.split(":")[1]),o):0===r.indexOf(u)?(o.serverTime=r.split(":")[1],o):((t=this.parseAndReturnValidJSON(r))[d]&&(o.sessionId=t[d].cid),(s=t[l])||(i=t[v],n=t[b]),void 0!==s?(this.debugLog("WS :: Msg Notifier publisher"+r),this._processSeqNumber(s,t,o)):void 0!==i?this._processLatestSeqMessage(i,o):n&&this._handlePushMessages(n,t,o),o)}}]),t}(r),k={WSS:"wss",WS:"ws",TIMEOUT_VAL:3e4,PING_MSG:"-?-",PONG_MSG:"--/--",REQ_MSG:"req",MAX_RECONNECT_PERIOD:90},N=function(){if(!0===window.__debug){var e=Array.prototype.slice.apply(arguments);e.unshift("ZM_DEBUG : ("+new Date+") > "),!0===zmail.debug&&window.console.log.apply(window.console,e)}},M=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,e);this.serverName=t.serverName,this.path=t.path,this.idleMsg=t.idleMsg,this.args=t.args,this.callbacks=t.callbacks||{},this.protocol=t.secure?k.WSS:k.WS,this.pingTimeout=null,this.sessionId=null,this._retry=Boolean(t.handleRetry),this._messageHandler=new m(t),this.ws=null,this._logger=new o(100),this.isRebranded=t.isRebranded,this._consecutiveFailCount=0,this._reconnectPeriod=0,this._reconnectTimer=null,this.requestedSeqMap={},this._lastReceivedMsgTime=-1,this._idleConnectingTimer=null,"function"==typeof t.debugLogger?this.debugLog=t.debugLogger:this.debugLog=N}return babelHelpers.createClass(e,[{key:"getSessionId",value:function(){return this.debugLog("session Id: "+this.sessionId),this.sessionId}},{key:"updateSessionId",value:function(e){var t=this.callbacks;this.sessionId=e,"function"==typeof t.onSessionIdUpdate&&t.onSessionIdUpdate(e)}},{key:"subscribePushMsg",value:function(e,t){this._messageHandler.subscribePushMsg(e,t)}},{key:"unsubscribePushMsg",value:function(e,t){this._messageHandlergeHandler.unsubscribePushMsg(e,t)}},{key:"subscribeBroadcastMsg",value:function(e,t){this._messageHandler.subscribeBroadcastMsg(e,t)}},{key:"unsubscribeBroadcastMsg",value:function(e,t){this._messageHandler.unsubscribeBroadcastMsg(e,t)}},{key:"getReconnectPeriod",value:function(){return this._reconnectPeriod}},{key:"setReconnectPeriod",value:function(e){this.debugLog("WS :: Set reconnect period: "+e),this._reconnectPeriod=e}},{key:"getLastReceivedMsgTime",value:function(){return this._lastReceivedMsgTime}},{key:"_setLastReceivedMsgTime",value:function(e){this._lastReceivedMsgTime=e}},{key:"_onOpen",value:function(e){var t=this.callbacks,s=this.getSessionId();this._onopenCalled=!0,this._clearTimeout(this._idleConnectingTimer),this._logger.push("WS :: Websocket connection opened"),this.debugLog("WS :: Websocket connection opened"),this._setLastReceivedMsgTime(-1),this.pingServer(),"function"==typeof t.onOpen&&t.onOpen(s,e)}},{key:"_onClose",value:function(e){var t=this.callbacks,s=this._retry;this._logger.push("closeEvent triggered",e),this.debugLog("WS :: Websocket connection closed"),this._clearTimeout(this._idleConnectingTimer),this._consecutiveFailCount+=1,"function"==typeof t.onClose&&(s=t.onClose(e)),s.retryStatus&&this.handleConnectionRetry(),s.closeStatus&&(this._lastClosedStatus=s.closeStatus)}},{key:"_onMessage",value:function(e){var t=this.callbacks;this._setLastReceivedMsgTime(Date.now()),0!==this._consecutiveFailCount&&(this._consecutiveFailCount=0,this.updateReconnectPeriod("reset"));var s=this._messageHandler.processMsg(e);this.handleMsgObject(s),"function"==typeof t.onMsg&&t.onMsg(e)}},{key:"disableRetry",value:function(){this._retry=!1}},{key:"enableRetry",value:function(){this._retry=!0}},{key:"updateReconnectPeriod",value:function(e){var t=this.getReconnectPeriod();"reset"===e?t=0:"inc"===e&&(0===t?t=1:t*=3),t>k.MAX_RECONNECT_PERIOD&&(t=k.MAX_RECONNECT_PERIOD),this.setReconnectPeriod(t)}},{key:"handleConnectionRetry",value:function(e){var t,s=this,i=(s.getSessionId(),s.ws.readyState);if(i===WebSocket.CONNECTING||i===WebSocket.CONNECTED)return!1;t=0,e||(t=s.getReconnectPeriod(),s.updateReconnectPeriod("inc")),s._logger.push("WS :: Current Reconnect period "+t+"seconds"),s.debugLog("WS :: Current Reconnect period "+t+"seconds"),s._reconnectTimer=setTimeout(function(){if(delete s._reconnectTimer,s.isConnected())return!1;s._initializeConnection()},1e3*t)}},{key:"removeFromRequestedSeqMap",value:function(e){delete this.requestedSeqMap[e]}},{key:"requestMissingNotifcations",value:function(e){var t=this;if(t.requestedSeqMap[e])return!1;t._logger.push("request Missing Notification : "+e),t.send(k.REQ_MSG+":"+e)&&(t.requestedSeqMap[e]=!0,setTimeout(function(){t.removeFromRequestedSeqMap(e)},3e3))}},{key:"handleMsgObject",value:function(e){var t=this.callbacks;e.sessionId&&(this.updateSessionId(e.sessionId),this.debugLog("WS :: Session Id updated")),e.invalidSeqNo&&this.requestMissingNotifcations(e.lastAckedSeqNo),e.refreshView&&"function"==typeof t.onRefreshView&&t.onRefreshView(),e.serverTime&&"function"==typeof t.onServerTime&&t.onServerTime(e)}},{key:"send",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return!(!e||!this.isConnected())&&(this.ws.send(e),this.pingServer(),!0)}},{key:"_clearTimeout",value:function(e){clearTimeout(e)}},{key:"pingServer",value:function(){var e=this,t=e.getLastReceivedMsgTime();t>-1&&Date.now()-t>2*k.TIMEOUT_VAL&&(e.debugLog("No response from server for past 60 seconds"),e.close(!0)),e.pingTimeout&&e._clearTimeout(e.pingTimeout),e.pingTimeout=setTimeout(function(){e.send(k.PING_MSG)},k.TIMEOUT_VAL)}},{key:"close",value:function(e){this.ws.onclose=void 0,this._reconnectTimer&&this._clearTimeout(this._reconnectTimer),this.ws.close(),e&&this._initializeConnection()}},{key:"_initializeEvents",value:function(){var e=this.ws;e.onopen=this._onOpen.bind(this),e.onclose=this._onClose.bind(this),e.onmessage=this._onMessage.bind(this)}},{key:"_initializeConnection",value:function(){var e=this,t=e.getConnectionPath();e._onopenCalled=!1;var s=new WebSocket(t);e._logger.push("Initialize connection called"),e._idleConnectingTimer=setTimeout(function(){e._logger.push("In Connecting state for too long. Closing and reconnecting"),e.close(),e._initializeConnection()},2e4),e.ws=s,e._initializeEvents()}},{key:"getConnectionPath",value:function(){var e=this.protocol+"://"+this.path+"/";e+=this.serverName;var t=!0,s=this.args;if("object"===babelHelpers.typeof(s))for(var i in s)t?(e+="?",t=!1):e+="&",e+=i+"="+s[i];return this.sessionId&&(t?(e+="?",t=!1):e+="&",e+="cid="+this.sessionId),this.isRebranded&&(e+=t?"?":"&",e+="isrbuser=true"),e}},{key:"isConnected",value:function(){var e=this.ws;if(e){var t=e.readyState;if(WebSocket.OPEN===t||WebSocket.CONNECTING===t)return!0}return!1}},{key:"init",value:function(){if(this.ws){if(this.isConnected())return!1;this.close()}this._initializeConnection()}}],[{key:"getLoggerInstance",value:function(e){return new o(e)}}]),e}();t.a=M},jXRH:function(e,t,s){"use strict";var i=s("OtGb");t.a=i.a}}]);
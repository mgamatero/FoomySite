"use strict";!function(){var d=zmail.Components.TokenInput,p=d.Constants.KEYS,a=zmail.isInternalOrgUser||!1,n=null,m=zmText.get("composeComponents").recipientField,i="data-tooltip",t=function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=requestAnimationFrame(function(){if(t){var e=(t.value.length||10)+0;t.size=e,n.fitParent&&(t.style.maxWidth=t.parentElement.offsetWidth-n.parentOffset+"px"),cancelAnimationFrame(r)}})},f=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return(e=(e||"").trim())&&n.valid?'"'+e+'" <'+t+">":t},r=function(){try{return"true"===String(zmail.Settings.Apps.SendMailAs.models.isSmimeEnabled)}catch(e){}return!1},o=function(e){function u(){var e;babelHelpers.classCallCheck(this,u),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(u).call(this));var t=babelHelpers.assertThisInitialized(e);return t.handleMouseMove=t.handleMouseMove.bind(t),t.handleMouseEnter=t.handleMouseEnter.bind(t),t.handleMouseLeave=t.handleMouseLeave.bind(t),t.handleAvatarClick=t.handleAvatarClick.bind(t),t.resizeInput=t.resizeInput.bind(t),t.resizeInput=_.throttle(t.resizeInput,100),t.contactCardOnHoverEnabled=!1,t.dragInitiated=!1,e}return babelHelpers.inherits(u,e),babelHelpers.createClass(u,[{key:"createDOM",value:function(){return this.dom=zdom("div",{ref:"wrapper",className:"SC_cs",tabIndex:"0"},zdom("i",{ref:"smimeBadge",className:"msi-secured zmDGreenClr zmDoubleIcon"}),zdom("span",{ref:"textLabel",className:"text-label"}),zdom("input",{ref:"textInput",className:"text-input",type:"text",autoComplete:"off",value:""}),zdom("i",{ref:"removeButton",className:"msi-close"})),this.dom}},{key:"getErrorClass",value:function(){return"zmerr"}},{key:"getSelectionClass",value:function(){return"zmfc"}},{key:"render",value:function(e){var t=this,n=e.attributes;t.contactCardOnHoverEnabled=!1,babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"render",this).call(this,e),n.invalid?$.e(t.refs.wrapper).addClass(t.getErrorClass()):a||$.e(t.refs.wrapper).attr(i,n.fullAddress);var r=null;r=n.contact?n.contact.avatar():zmail.ContactBook.Templates.avatar({isValidPhoto:!1,initials:zmail.ContactBook.Utils.initials(n.text||""),avatarBgColor:zmail.ContactBook.Utils.colorClasses({text:n.text||""})}),$.e(t.refs.wrapper).prependDOM(r),t.unbindAvatarEvents(),t._avatarDOM&&$.element(t._avatarDOM).remove(),t._avatarDOM=r,t.bindAvatarEvents(),n.invalid?$.element(t._avatarDOM).hide():$.element(t._avatarDOM).css({display:""}),n.smimeStatus&&("unknown"===n.smimeStatus||"fetch"===n.smimeStatus||"unavailable"===n.smimeStatus?$.element(t.refs.smimeBadge).hide():($.element(t.refs.smimeBadge).show(),$.element(t.refs.smimeBadge).removeClass("zmGreyClr").addClass("zmDGreenClr"),"unavailable"!==n.smimeStatus&&"disabled"!==n.smimeStatus||$.element(t.refs.smimeBadge).addClass("zmGreyClr").removeClass("zmDGreenClr")))}},{key:"resizeInput",value:function(){t(this.refs.textInput)}},{key:"_handleEditAction",value:function(e){var t=this,n=t.model.attributes;t.dragSource.disable(),$.e(t.refs.wrapper).removeAttr(i),$.e(t.refs.textInput).val(n.fullAddress),t._previousValue=n.fullAddress,$.e(t.refs.wrapper).removeClass(t.getErrorClass()),$.e(t.refs.smimeBadge).hide(),t.resizeInput(),babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"_handleEditAction",this).call(this,e),setTimeout(function(){t.refs.textInput.select()})}},{key:"_handleKeyUpAction",value:function(){if(this.refs&&""===this.refs.textInput.value.trim())return $.e(this).triggerHandler(d.Component.BaseTokenComponent.EVENTS.REMOVE,{instance:this}),!1}},{key:"_handleTextChangeAction",value:function(e,t){var n=this,r=n.model;if(n.dragSource.enable(),(n.refs.textInput.value||"").trim()){var a=zmail.Utils.EmailParser.parse(n.refs.textInput.value),i=!1;1<a.length?(_zm.succErrMsg("e",m.moreThanOneEmail),i=!0):a[0].valid||(_zm.succErrMsg("e",m.invalidEmail),i=!0);var o=!1;if("keydown"===e.type)o=(e.which||e.keyCode)===p.ESC;if(i){if(babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"_handleTextChangeAction",this).call(this),!o)return void(a[0].valid||$.e(n.refs.wrapper).addClass(n.getErrorClass()));$.e(n.refs.textInput).val(n._previousValue)}n._previousValue=null,babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"_handleTextChangeAction",this).call(this,e,t);var l=a[0];if(!i){l.name=(l.name||"").trim();var s={id:(l.email||"").toLowerCase(),text:l.name||l.email,fullAddress:f(l.name,l.email,{valid:l.valid}),email:l.email,invalid:!l.valid},c=r.attributes.email!==l.email;c&&(s.contact=null),r.set(s),c&&(r.fetchContact(),r.fetchSmimeStatus()),!0!==l.valid&&$.e(n.refs.wrapper).addClass(n.getErrorClass())}}else $.e(n).triggerHandler(d.Component.BaseTokenComponent.EVENTS.REMOVE,{instance:n})}},{key:"_showContactCardWithDelay",value:function(){var e=this;setTimeout(function(){e.contactCardOnHoverEnabled&&!e.dragInitiated&&e._showContactCard()},500)}},{key:"hideContactCard",value:function(){try{n.hide()}catch(e){}}},{key:"_showContactCard",value:function(){var t=this;a&&t.contactCardOnHoverEnabled&&t.refs&&t.refs.wrapper&&document.body.contains(t.refs.wrapper)&&t.state&&t.model&&(t.model.attributes.invalid||t.state.editMode||(zmTooltip.remove(),zmConUtil.showContactCard({dom:t.refs.wrapper,name:t.model.attributes.text,displayName:t.model.attributes.text,email:t.model.attributes.email,source:"compose",hideOnBlur:!0,popupOpts:{paddingOffset:20}}).then(function(e){n=e.component,setTimeout(function(){t.dragInitiated&&t.hideContactCard()},250)})))}},{key:"handleMouseMove",value:function(e){this.contactCardOnHoverEnabled||this.dragInitiated||(this.contactCardOnHoverEnabled=!0,this._showContactCardWithDelay())}},{key:"handleMouseEnter",value:function(e){this.dragInitiated||this._showContactCardWithDelay()}},{key:"handleMouseLeave",value:function(e){this.contactCardOnHoverEnabled=!1}},{key:"handleAvatarClick",value:function(e){var t=this;a||(e.preventDefault(),e.stopPropagation(),zmTooltip.remove(),zmConUtil.showContactCard({dom:t._avatarDOM,name:t.model.attributes.text,displayName:t.model.attributes.text,email:t.model.attributes.email,event:e,source:"compose",hideOnBlur:!0}).then(function(e){setTimeout(function(){t.dragInitiated&&t.hideContactCard()},200)}))}},{key:"bindAvatarEvents",value:function(){var e=this;$.element(e.refs.wrapper).on("mousemove",e.handleMouseMove),$.element(e.refs.wrapper).on("mouseenter",e.handleMouseEnter),$.element(e.refs.wrapper).on("mouseleave",e.handleMouseLeave),e._avatarDOM&&$.element(e._avatarDOM).on("click",e.handleAvatarClick)}},{key:"unbindAvatarEvents",value:function(){var e=this;$.element(e.refs.wrapper).off("mousemove",e.handleMouseMove),$.element(e.refs.wrapper).off("mouseenter",e.handleMouseEnter),$.element(e.refs.wrapper).off("mouseleave",e.handleMouseLeave),$.element(e.refs.wrapper).off("mousedown",e.hideContactsCard),e._avatarDOM&&$.element(e._avatarDOM).off("click",e.handleAvatarClick)}},{key:"_copyTextKeyCombinationHandler",value:function(e){var t=this,n=e.which||e.keyCode;"keyup"!==e.type?(e.ctrlKey||e.metaKey)&&67===n&&!t.blockCopyAction&&(e.preventDefault(),e.stopPropagation(),t.blockCopyAction=!0,$.events(t).triggerHandler("copyToken",{currentTokenText:t.model.attributes.fullAddress}),t.blockCopyAction=!1):t.blockCopyAction=!1}},{key:"_smimeBadgeClickHandler",value:function(e){e.stopPropagation(),e.preventDefault();var t=this.model.attributes.smimeStatus;"enabled"===t?this.model.set({smimeStatus:"disabled"}):"disabled"===t&&this.model.set({smimeStatus:"enabled"})}},{key:"initializeDrag",value:function(){var t=this;t.dragSource=new zmail.dndComp.Drag,t.dragSource.init(t.dom,{draggedClassName:"dragged",onDragStart:function(){zmTooltip.remove(),t.contactCardOnHoverEnabled=!1,t.dragInitiated=!0,t.hideContactCard(),$.e(t.refs.wrapper).removeAttr(i);var e={};return $.events(t).triggerHandler("dragStart",{returnArgs:e}),{id:t.model.id,type:"recipient-token",data:e,allowDrag:!0!==t.state.editMode,disableGhostImage:!0}},onDragEnd:function(){t.refs&&(a||$.e(t.refs.wrapper).attr(i,t.model.attributes.fullAddress))}})}},{key:"uninitializeDrag",value:function(){this.dragSource.destroy()}},{key:"initializeDOM",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this;babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"initializeDOM",this).call(this,e),t._copyTextKeyCombinationHandler=t._copyTextKeyCombinationHandler.bind(t),$.events(t.dom).on("keydown",t._copyTextKeyCombinationHandler),$.events(t.dom).on("keyup",t._copyTextKeyCombinationHandler),t._smimeBadgeClickHandler=t._smimeBadgeClickHandler.bind(t),$.events(t.refs.smimeBadge).on("click",t._smimeBadgeClickHandler),t._handleKeyUpAction=t._handleKeyUpAction.bind(t),$.e(t.refs.textInput).on("keyup",t._handleKeyUpAction),t.initializeDrag()}},{key:"uninitializeDOM",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this,n=$.e(t.refs.wrapper).data("contactCard");n&&n.remove(),t.uninitializeDrag(),$.events(t.dom).off("keydown",t._copyTextKeyCombinationHandler),$.events(t.dom).off("keyup",t._copyTextKeyCombinationHandler),$.events(t.refs.smimeBadge).off("click",t._smimeBadgeClickHandler),babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"uninitializeDOM",this).call(this,e)}}]),u}(d.Component.BaseTokenComponent),l=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"createComponent",value:function(e){return new o}}]),t}(d.Factory.BaseTokenComponentFactory),s=function(e){function i(e){var t;babelHelpers.classCallCheck(this,i),t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e));var n=babelHelpers.assertThisInitialized(t);return n.state=$.extend({},n.state,e.state||{ccBtn:!1,bccBtn:!1}),n.buttonLabels=e.buttonLabels||{},n.disableAutoFocus=!0,n.resizeInput=n.resizeInput.bind(n),n.resizeInput=_.throttle(n.resizeInput,100),t}return babelHelpers.inherits(i,e),babelHelpers.createClass(i,[{key:"createDOM",value:function(){return this.dom=zdom("div",{ref:"wrapper",className:"zmCTxt zmdrop recipient-field"},zdom("font",{ref:"titleButton",className:"title-button"}),zdom("input",{ref:"input",type:"text",className:"zm_sgst",placeholder:""}),zdom("div",{className:"SC_frt",ref:"rhsButtons"},zdom("em",{ref:"ccButton",className:"rhs-button"}),zdom("em",{ref:"bccButton",className:"rhs-button"}))),this.dom}},{key:"render",value:function(e){var t=this;babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"render",this).call(this,e),$.e(t.refs.titleButton).text(t.buttonLabels.title||""),$.e(t.refs.ccButton).text(t.buttonLabels.cc||""),$.e(t.refs.bccButton).text(t.buttonLabels.bcc||""),$.e(t.refs.rhsButtons).css({display:t.state.ccBtn||t.state.bccBtn?"":"none"}),$.e(t.refs.ccButton).css({display:t.state.ccBtn?"":"none"}),$.e(t.refs.bccButton).css({display:t.state.bccBtn?"":"none"}),t.state.showBccButton||$.e(t.refs.bccButton).css({display:"none"})}},{key:"renderToken",value:function(e){var r=this,a=babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"renderToken",this).call(this,e);return a.dragStartHandler||(a.dragStartHandler=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n={};$.events(r).triggerHandler("tokenDragStart",{token:a,returnArgs:n}),$.extend(t.returnArgs,n)},$.events(a).on("dragStart",a.dragStartHandler)),a.copyTokenHandler||(a.copyTokenHandler=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};r.handleCopyTokensAction(t)},$.events(a).on("copyToken",a.copyTokenHandler)),a}},{key:"mountTokenComponent",value:function(e){d.Utils.mountComponent(e,this.refs.wrapper,{parentComponent:this,nextDOMAnchor:this.refs.input})}},{key:"resizeInput",value:function(){t(this.refs.input)}},{key:"_inputFocusHandler",value:function(){$.events(this).triggerHandler("inputFocus",{type:"focus"})}},{key:"_inputBlurHandler",value:function(){var e=this;setTimeout(function(){e.refs.wrapper.contains(document.activeElement)||0===e.refs.wrapper.scrollTop||(e.refs.wrapper.scrollTop=0)},200),$.events(e).triggerHandler("inputBlur",{type:"blur"})}},{key:"sanitizePastedText",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";return ZMEmailAddressUtils.sanitize(e.trim())}},{key:"_inputPasteHandler",value:function(e){e=e.originalEvent||e;var t="";try{t=e.clipboardData.getData("Text")}catch(e){t=null}null!==t&&(t=this.sanitizePastedText(t),this.refs.input.value=t,e.preventDefault())}},{key:"_titleBtnClickHandler",value:function(e){e.stopPropagation(),$.e(this).triggerHandler("buttonAction",{id:"title-button",event:e})}},{key:"_ccBtnClickHandler",value:function(e){e.stopPropagation(),$.e(this).triggerHandler("buttonAction",{id:"cc-button",event:e})}},{key:"_bccBtnClickHandler",value:function(e){e.stopPropagation(),$.e(this).triggerHandler("buttonAction",{id:"bcc-button",event:e})}},{key:"_spaceKeyHandler",value:function(e){(e.which||e.keyCode)===p.SPACE&&$.e(e.target).trigger("click")}},{key:"_escKeyHandler",value:function(e){(e.which||e.keyCode)===p.ESC&&$.events(this).triggerHandler("escKeyPress",{keyEvent:e})}},{key:"handleCopyTokensAction",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};e.instance=this,$.events(this).triggerHandler("copyTokensToClipboard",e)}},{key:"hideContactCard",value:function(){try{n.hide()}catch(e){}}},{key:"_copyTextKeyCombinationHandler",value:function(e){var t=this,n=e.which||e.keyCode;if("keyup"!==e.type){var r=t.refs.input,a=e.ctrlKey||e.metaKey,i=r.selectionStart===r.selectionEnd;a&&i&&67===n&&!t.blockCopyAction&&(e.preventDefault(),e.stopPropagation(),t.blockCopyAction=!0,t.handleCopyTokensAction(),t.blockCopyAction=!1)}else t.blockCopyAction=!1}},{key:"initializeDrop",value:function(){var r=this;r.dropTarget=new zmail.dndComp.Drop,r.dropTarget.init(r.dom,{onDragOver:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n={};return r.hideContactCard(),$.events(r).triggerHandler("dragOver",{data:t,dropElement:e,returnArgs:n}),{allowDragOver:"recipient-token"===t.type&&n.valid}},onDrop:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.target,n=e.dragObj;r.dragInitiated=!1,$.events(r).triggerHandler("tokenDrop",{dragData:n,dropElement:t})}})}},{key:"uninitializeDrop",value:function(){this.dropTarget.destroy()}},{key:"initializeDOM",value:function(){var e=this;babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"initializeDOM",this).call(this),e._inputFocusHandler=e._inputFocusHandler.bind(e),e._inputBlurHandler=e._inputBlurHandler.bind(e),$.e(e.refs.input).on("focus",e._inputFocusHandler),$.e(e.refs.input).on("blur",e._inputBlurHandler),e._inputPasteHandler=e._inputPasteHandler.bind(e),$.e(e.refs.input).on("paste",e._inputPasteHandler),e._titleBtnClickHandler=e._titleBtnClickHandler.bind(e),e._ccBtnClickHandler=e._ccBtnClickHandler.bind(e),e._bccBtnClickHandler=e._bccBtnClickHandler.bind(e),$.e(e.refs.titleButton).on("click",e._titleBtnClickHandler),$.e(e.refs.ccButton).on("click",e._ccBtnClickHandler),$.e(e.refs.bccButton).on("click",e._bccBtnClickHandler),e._spaceKeyHandler=e._spaceKeyHandler.bind(e),$.e(e.refs.titleButton).on("keyup",e._spaceKeyHandler),$.e(e.refs.ccButton).on("keyup",e._spaceKeyHandler),$.e(e.refs.bccButton).on("keyup",e._spaceKeyHandler),e._escKeyHandler=e._escKeyHandler.bind(e),$.e(e.refs.input).on("keyup",e._escKeyHandler),e._copyTextKeyCombinationHandler=e._copyTextKeyCombinationHandler.bind(e),$.e(e.refs.input).on("keydown",e._copyTextKeyCombinationHandler),$.e(e.refs.input).on("keyup",e._copyTextKeyCombinationHandler),e.initializeDrop()}},{key:"uninitializeDOM",value:function(){var e=this;e.uninitializeDrop(),babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"uninitializeDOM",this).call(this),$.e(e.refs.input).off("focus",e._inputFocusHandler),$.e(e.refs.input).off("blur",e._inputBlurHandler),$.e(e.refs.input).off("paste",e._inputPasteHandler),$.e(e.refs.titleButton).off("click",e._titleBtnClickHandler),$.e(e.refs.ccButton).off("click",e._ccBtnClickHandler),$.e(e.refs.bccButton).off("click",e._bccBtnClickHandler),$.e(e.refs.titleButton).off("keyup",e._spaceKeyHandler),$.e(e.refs.ccButton).off("keyup",e._spaceKeyHandler),$.e(e.refs.bccButton).off("keyup",e._spaceKeyHandler),$.e(e.refs.input).off("keyup",e._escKeyHandler),$.e(e.refs.input).off("keydown",e._copyTextKeyCombinationHandler),$.e(e.refs.input).off("keyup",e._copyTextKeyCombinationHandler)}}]),i}(d.Component.BaseTokenInputComponent),c=d.Model.BaseTokenModel.extend({defaults:$.extend({},d.Model.BaseTokenModel.prototype.defaults,{fullAddress:"",email:"",invalid:!1,contact:null,smimeStatus:"unknown"}),fetchContact:function(){var n=this;n.set({contact:null});var e=new Promise(function(t,e){var a;n.attributes.invalid?e():(a=n.attributes.email,new Promise(function(t,n){var e=["personal"];zmail.isCRMServiceUser&&zmail.IntegrationStatus.CRM&&e.push("crm");var r={eid:a,includeEmailedGroups:!0,type:e,excludeOrgUsers:!0,excludeInactiveUsers:!0};zmail.ContactBook.get(r).then(function(e){e.length?t(e[0]):n()},n)})).then(function(e){n.set({contact:e}),$.e(n).triggerHandler("contactLoaded",{model:n,contact:e}),t()},e)});return e.catch(function(){}),e},fetchSmimeStatus:function(){var n=this;n.set({smimeStatus:"unknown"});var e=new Promise(function(e,t){!n.attributes.invalid&&r()?(n.set("smimeStatus","fetch"),e()):t()});return e.catch(function(){}),e}}),u=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"createModelInstance",value:function(){return new c}},{key:"createModel",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=this,t=(e.text||"").trim(),n=zmail.Utils.EmailParser.parse(t);if(n.length)return n.forEach(function(e){if(!e.valid){var t,n=e.email.split("@");2===n.length&&(t='"'+n[0]+'"'+"@"+n[1],zmail.Utils.EmailValidator.validate(t).status&&(e.valid=!0))}}),n.map(function(e){var t=r.createModelInstance(),n=(e.email||"").toLowerCase();return e.name=(e.name||"").trim(),t.set({id:n,text:e.name||e.email,fullAddress:f(e.name,e.email,{valid:e.valid}),email:e.valid?e.email:"",invalid:!e.valid,contact:null},{silent:!0}),t.once("add",function(){t.fetchContact(),t.fetchSmimeStatus()}),t})}}]),t}(d.Factory.BaseTokenModelFactory),h=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"createTokenComponentFactory",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return new l(e)}},{key:"createComponent",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return new s(e)}},{key:"createTokenModelFactory",value:function(e){return new u(e=e||{})}},{key:"createTriggers",value:function(e){return e=e||{},{enterKeyTrigger:new d.Trigger.EnterKeyInputTrigger(e),commaKeyTrigger:new d.Trigger.CommaKeyInputTrigger(e),tabKeyTrigger:new d.Trigger.TabKeyInputTrigger(e)}}},{key:"_componentTokenEntryHandler",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=this.model,r=n.attributes.tokens,a=this.tokenModelFactory.createModel(t);if(a&&a.length){var i=a.filter(function(e){return!r.get(e.attributes.id)});return a.filter(function(e){return r.get(e.attributes.id)}).length&&!t.silent?(_zm.succErrMsg("e",m.duplicateEmail),3):(n.set({text:""},{silent:!0}),n.addTokens(i),0)}return 1}},{key:"createTokens",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return this._componentTokenEntryHandler(null,e)}},{key:"renderComponent",value:function(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"renderComponent",this).call(this,{detached:!0,nextDOMAnchor:this.nextDOMAnchor})}},{key:"resetTokens",value:function(){this.model.getTokenCollection().reset()}},{key:"getRecipientList",value:function(){return this.model.getTokenModelList().filter(function(e){return!0!==e.attributes.invalid}).map(function(e){return e.attributes.fullAddress})}},{key:"getEmailList",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this.model.getTokenModelList().filter(function(e){return!0!==e.attributes.invalid});return r()&&(e.sMimeEnabled?t=t.filter(function(e){return"enabled"===e.attributes.smimeStatus}):e.sMimeDisabled&&(t=t.filter(function(e){return"disabled"===e.attributes.smimeStatus}))),t.map(function(e){return e.attributes.email})}},{key:"hasErrors",value:function(){return 0<this.model.getTokenModelList().filter(function(e){return!0===e.attributes.invalid||"fetch"===e.attributes.smimeStatus}).length}},{key:"resetSmimeState",value:function(){this.model.getTokenModelList().forEach(function(e){e.set({smimeStatus:"unknown"})})}},{key:"fetchSmimeState",value:function(){this.model.getTokenModelList().forEach(function(e){e.fetchSmimeStatus()})}}]),t}(d.System.BaseTokenInputSystem),v={createNew:function(e){return new h},getFullEmailAddress:function(e){var t=e.attrs;return'"'+([(t.fn||"").trim(),(t.mn||"").trim(),(t.ln||"").trim()].filter(function(e){return 0<e.length}).join(" ").trim()||t.eid)+'" <'+t.eid+">"},resizeInput:t,addQuotesToEmails:function(e){var t,n=e=e||"",r=/(?:@[^@>]+>) *(,{1})/gim,a=/(.*)(?=<)/i,i=null,o=[];for(i=r.exec(n);null!==i;)o.push(n.substr(0,i.index+i[0].length)),n=n.substr(i.index+i[0].length),r.lastIndex=0,i=r.exec(n);return(n=n.trim())&&o.push(n),e=(o=o.map(function(e){return a.lastIndex=0,(i=a.exec(e))&&(t=(i[0]||"").trim())&&'"'!==t.charAt(0)&&'"'!==t.charAt(t.length-1)&&(t='"'+(t=t.replace(/"/i,'\\"'))+'"',e=e.substr(i[0].length),e=t+" "+e),e})).join(" ")}},b=zmail.Components.AutoComplete,g=zmText.get("composeComponents").contactsSuggestion,y=zmail.isInternalOrgUser||!1,C=b.System.AbstractListItemModel.extend({defaults:$.extend({},b.System.AbstractListItemModel.prototype.defaults,{firstName:"",lastName:"",middleName:"",nickName:"",email:"",primaryAddress:!1,contact:null}),getFullName:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this.attributes,n=[(t.firstName||"").trim(),(t.middleName||"").trim(),(t.lastName||"").trim()].filter(function(e){return 0<e.length});return e.excludeNickName||(t.nickName||"").trim()&&n.push("( "+(t.nickName||"").trim()+" )"),n.join(" ").trim()||t.email},getFullEmailAddress:function(){var e=this.attributes;return e.email?'"'+this.getFullName({excludeNickName:!0})+'" <'+e.email+">":null}},{getUniqueID:function(e){return zmail.ContactBook.isCategory(e)?"cat_"+e.attrs.cid:e.attrs.eid}}),k=function(n,e,r,a){a=a||{},$.element(n)[0].innerHTML="",function(e,t,n){e=e||"";var r=[];if(!(t=t||""))return r=e?[e]:[];var a=e;(n=n||{}).caseSensitive||(t=t.toLowerCase(),a=a.toLowerCase());var i,o,l=-1;for(i=0,o=e.length;i<o&&-1!==(l=a.indexOf(t,i));i++)0!==l&&r.push(e.substring(i,l)),r.push(e.substring(l,l+t.length)),i=l+t.length-1;return i<o&&r.push(e.substring(i)),r}(e,r,a).forEach(function(e){var t=function(e,t,n){n=n||{};var r=$.element(zdom("span",null));return r.text(e),n.caseSensitive||(t=t.toLowerCase(),e=e.toLowerCase()),1<t.length&&t===e&&r.addClass("afHgl"),r}(e,r,a);$.element(n).appendDOM(t)}),a.showTooltip&&$.element(n).attr({title:a.tooltip||e})},H=function(e){function u(){return babelHelpers.classCallCheck(this,u),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(u).apply(this,arguments))}return babelHelpers.inherits(u,e),babelHelpers.createClass(u,[{key:"getSelectionClassName",value:function(){return"ddHIHover"}},{key:"getCRMIcon",value:function(){return this.crmIcon||(this.crmIcon=zdom("i",{className:"msi-crm",title:g.crm})),this.crmIcon}},{key:"getPrimaryIcon",value:function(){return this.primaryIcon||(this.primaryIcon=zdom("i",{className:"msi-fav",title:g.primaryEmail})),this.primaryIcon}},{key:"createDOM",value:function(){this.dom=zdom("li",{ref:"wrapper",className:"zmContactList ddHItem"},zdom("div",{ref:"avatarWrapper",className:"zmCLAvatar"}),zdom("div",{ref:"infoWrapper",className:"zmCLData"},zdom("div",{ref:"nameWrapper",className:"zmCLDRow"},zdom("span",{ref:"name",className:"zmCLUserName"})),zdom("div",{ref:"emailWrapper",className:"zmCLDRow"},zdom("span",{ref:"email",className:"zmCLUserEmail"}))))}},{key:"render",value:function(e){var t,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=this,a=e.attributes,i=zmail.ContactBook.isCategory(a.contact),o=!i&&"crm"===a.contact.type,l=!0===a.primaryAddress;if(babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"render",this).call(this,e,n),r.searchWord=n.searchWord||r.searchWord||"",k(r.refs.name,e.getFullName(),r.searchWord,{tooltip:n.minimalList&&!i?a.email:null,showTooltip:n.minimalList&&!i}),i?$.element(r.refs.email).text("["+g.category+"]"):k(r.refs.email,a.email,r.searchWord,{showTooltip:!1}),$.element(r.refs.avatarWrapper).clearHTML(),$.element(r.refs.avatarWrapper).appendDOM(i?(t=(t={name:a.firstName})||{},zmail.ContactBook.Templates.avatar({isValidPhoto:!1,initials:zmail.ContactBook.Utils.initials(t.name||""),avatarBgColor:zmail.ContactBook.Utils.colorClasses({text:t.name||""})})):a.contact.avatar()),n.minimalList?($.element(r.refs.wrapper).addClass("zmNameList"),$.element(r.refs.nameWrapper).prependDOM(r.refs.name),$.element(r.refs.emailWrapper).detach()):($.element(r.refs.wrapper).removeClass("zmNameList"),$.element(r.refs.infoWrapper).prependDOM(r.refs.nameWrapper),$.element(r.refs.nameWrapper).prependDOM(r.refs.name),$.element(r.refs.infoWrapper).appendDOM(r.refs.emailWrapper)),o){var s=r.getCRMIcon();$.element(r.refs.nameWrapper).appendDOM(s)}if(l){var c=r.getPrimaryIcon();$.element(r.refs.nameWrapper).appendDOM(c)}}},{key:"_triggerComponentHovered",value:function(e){$.events(this).triggerHandler(u.EVENTS.LIST_ITEM_MOUSE_ENTER,{event:e,component:this})}},{key:"_mouseOverHandler",value:function(e){this._triggerComponentHovered(e)}},{key:"initializeDOM",value:function(){var e=this;babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"initializeDOM",this).call(this),e._mouseOverHandler=e._mouseOverHandler.bind(e),$.element(e.refs.wrapper).on("mouseover",e._mouseOverHandler)}},{key:"uninitializeDOM",value:function(){$.element(this.refs.wrapper).off("mouseover",this._mouseOverHandler),babelHelpers.get(babelHelpers.getPrototypeOf(u.prototype),"uninitializeDOM",this).call(this)}}]),u}(b.System.AbstractListItemComponent);H.EVENTS=Object.assign({LIST_ITEM_MOUSE_ENTER:"listItemMouseEnter"},b.System.AbstractListItemComponent.EVENTS);var T=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"createComponent",value:function(e){return e instanceof C?new H:babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"createComponent",this).call(this,e)}}]),t}(b.System.AbstractListItemComponentFactory),S=function(e){function a(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};babelHelpers.classCallCheck(this,a),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(a).call(this));var n=babelHelpers.assertThisInitialized(e);return n.minimalList=t.minimalList||!1,n.mouseSelectionFlag=!1,n.keyboardNavigationActive=!1,n._mouseMoveHandler=n._mouseMoveHandler.bind(n),e}return babelHelpers.inherits(a,e),babelHelpers.createClass(a,[{key:"createDOM",value:function(){this.dom=zdom("div",{ref:"wrapper",className:"zmDropDown show zmComposeAutoComplete autocomplete-menu"},zdom("div",{className:"zmDdDataWra"},zdom("div",{ref:"scrollWrapper",className:"zmDdData"},zdom("ul",{ref:"listWrapper",className:"zmDdList"}))))}},{key:"getScrollWrapperDOM",value:function(){return this.refs.scrollWrapper}},{key:"renderListItem",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=this;e.minimalList=e.hasOwnProperty("minimalList")?e.minimalList:n.minimalList,n.mouseSelectionFlag&&t.attributes.selected&&(n.mouseSelectionFlag=!1,e.disableSelectedItemFocus=!0);var r=babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"renderListItem",this).call(this,t,e);return $.events(r).on(H.EVENTS.LIST_ITEM_MOUSE_ENTER,function(e){n.keyboardNavigationActive||$.events(n).triggerHandler(a.EVENTS.HIGHLIGHT_LIST_ITEM,t)}),r}},{key:"render",value:function(e,t){t.minimalList=this.minimalList,babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"render",this).call(this,e,t),$.element(this.refs.wrapper).css({visibility:e.attributes.searchInProgress?"hidden":"visible"})}},{key:"handleListSpaceOverflow",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this.getScrollWrapperDOM();$.element(t).css({maxHeight:e.height+"px",height:e.height+"px"})}},{key:"positionComponent",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this,n=t.getScrollWrapperDOM(),r=e.anchorBounds;$.element(n).css({height:"auto"}),t.visible||t.show();var a=b.Utils.positionDOM({dom:t.dom,anchorBounds:r,viewPortBounds:t.getViewPortBounds()});return $.element(t.dom).css({height:"auto"}),a.overflow&&t.handleListSpaceOverflow({height:a.height}),t.updateScrollIndicators(),a}},{key:"_mouseMoveHandler",value:function(){$.e(this.refs.wrapper).off("mousemove",this._mouseMoveHandler),this.keyboardNavigationActive=!1}},{key:"_keyDownHandler",value:function(e,t){var n=e.which||e.keyCode,r=b.Constants.KEYS;return n!==r.UP&&n!==r.DOWN||(this.keyboardNavigationActive=!0,$.e(this.refs.wrapper).off("mousemove",this._mouseMoveHandler).on("mousemove",this._mouseMoveHandler)),babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"_keyDownHandler",this).call(this,e,t)}},{key:"show",value:function(){$.element(this.dom).fadeIn({duration:10}),babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"show",this).call(this)}},{key:"hide",value:function(){$.element(this.dom).fadeOut({duration:10}),babelHelpers.get(babelHelpers.getPrototypeOf(a.prototype),"hide",this).call(this)}}]),a}(b.System.AbstractListComponent);S.EVENTS=Object.assign({HIGHLIGHT_LIST_ITEM:"highlightListItem"},b.System.AbstractListComponent.EVENTS);var D=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"bindEvents",value:function(){return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"bindEvents",this).call(this,{debounce:0})}},{key:"textChangeAction",value:function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).event,t=!0,n=(this._input.getText()||"").trim();if("keyup"===e.type&&e.ctrlKey){var r=e.which||e.key;(86===r||"v"===String(r).toLowerCase())&&50<n.length&&(t=!1)}"paste"===e.type&&50<n.length&&(t=!1),n&&t?(0===n.indexOf("@")&&(n=n.substr(1,n.length)),this.publishTriggerEvent({searchToken:n})):this.publishNegativeTriggerEvent()}}]),t}(b.System.AbstractTrigger),E=function(e){function t(){var e;return babelHelpers.classCallCheck(this,t),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this)),babelHelpers.assertThisInitialized(e).excludeList=[],e}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"fetchContacts",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this,n=e.searchToken,r=e.async;if(zmail.contactsThrottle&&n.length<2)return Promise.resolve([]);var a=["personal"];zmail.isCRMServiceUser&&zmail.IntegrationStatus.CRM&&a.push("crm");var i={str:n.toLowerCase(),includeEmailedGroups:!0,includeCategories:!0,expected:10,type:a,excludeOrgUsers:!0,excludeInactiveUsers:!0,sliceExpected:!0,exclude:t.excludeList||[]},o={};$.events(t).triggerHandler("beforeSearch",{provide:t,providerName:"contacts-data-provider",returnArgs:o}),t.excludeList=o.excludeList||t.excludeList||[],i.exclude=t.excludeList,r||(i.promise=!1);var l=zmail.ContactBook.get(i);return new Promise(function(e,t){r?l.then(e,t):e(l)})}},{key:"createModels",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],n={};return e.forEach(function(e){var t=e.attrs.contid?String(e.attrs.contid):null;t&&(n[t]=n[t]?n[t]+1:1)}),e.map(function(e){var t=e.attrs.contid?String(e.attrs.contid):null;return new C({id:C.getUniqueID(e),firstName:e.attrs.fn||e.attrs.cname,lastName:e.attrs.ln,middleName:e.attrs.mn,nickName:e.attrs.nn,email:e.attrs.eid,contact:e,primaryAddress:!(!t||!e.attrs.isPrimary)&&1<n[t]})})}},{key:"searchData",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=this,r=e.collection,a=e.deferred,t=(e.searchToken||"").trim();if(t){var i=!1,o=!1;r.reset([],{silent:!0}),n.fetchContacts({searchToken:t.toLowerCase()}).then(function(e){e.length&&!o&&(i=!0,r.reset(n.createModels(e),{silent:!0}),a.notify())}),setTimeout(function(){n.fetchContacts({async:!0,searchToken:t.toLowerCase()}).then(function(e){if(e.length||i){o=!0;var t=n.createModels(e);i&&(r.add(t,{silent:!0}),10<r.models.length&&(t=r.models.slice(0,10))),r.reset(t,{silent:!0}),a.resolve()}else a.reject()},function(){i?a.resolve():a.reject()})},0)}else a.reject()}}]),t}(b.System.AbstractDataProvider),I=function(e){function t(){return babelHelpers.classCallCheck(this,t),babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"accumulateData",value:function(e){var t=this;t.dataCollection.reset([],{silent:!0}),(e.collectionList||[]).forEach(function(e){t.dataCollection.add(e.models,{silent:!0})}),t.dataCollection.reset(t.dataCollection.models,{silent:!0}),t.triggerAccumulationComplete()}}]),t}(b.System.AbstractDataAccumulator),e=function(e){function n(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return babelHelpers.classCallCheck(this,n),e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this)),babelHelpers.assertThisInitialized(e).composeID=t.composeID,e}return babelHelpers.inherits(n,e),babelHelpers.createClass(n,[{key:"createUserInput",value:function(){return new b.System.AbstractHTMLInput}},{key:"createTrigger",value:function(){return new D}},{key:"createDataProviders",value:function(){return[new E]}},{key:"createDataAccumulator",value:function(){return new I}},{key:"createListComponent",value:function(){return new S}},{key:"createListItemComponentFactory",value:function(){return new T}},{key:"renderComponent",value:function(){var e=this.listModel,t=this.listComponent,n=e.attributes.currentSearchKey||"";e.attributes.searchInProgress||e.selectFirstItem({silent:!0}),t.render(e,{searchWord:n})}},{key:"_beforeSearchHandler",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};$.events(this).triggerHandler("dataProviderBeforeSearch",t)}},{key:"_highlightListItemHandler",value:function(e,t){this.listComponent.mouseSelectionFlag=!0,this.listModel.selectItem(t.attributes.id)}},{key:"_listItemFocusHandler",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};"function"==typeof this.onListItemFocus&&this.onListItemFocus(t)}},{key:"bindEvents",value:function(){var r=this;babelHelpers.get(babelHelpers.getPrototypeOf(n.prototype),"bindEvents",this).call(this),r._beforeSearchHandler=r._beforeSearchHandler.bind(r),r.dataProviders.forEach(function(e){$.events(e).on("beforeSearch",r._beforeSearchHandler)}),r._highlightListItemHandler=r._highlightListItemHandler.bind(r),$.events(r.listComponent).on(S.EVENTS.HIGHLIGHT_LIST_ITEM,r._highlightListItemHandler),r._listItemFocusHandler=r._listItemFocusHandler.bind(r),$.events(r.listComponent).on("itemFocused",r._listItemFocusHandler),$.subscribe("editorLoaded",function(e,t){if(t){var n=zmComp.getEditor(t).doc.body;$.e(n).on("mousedown",r._bodyMouseDownHandler)}})}},{key:"unbindEvents",value:function(){var t=this;if(babelHelpers.get(babelHelpers.getPrototypeOf(n.prototype),"unbindEvents",this).call(this),t.dataProviders.forEach(function(e){$.events(e).off("beforeSearch",t._beforeSearchHandler)}),$.events(t.listComponent).off(S.EVENTS.HIGHLIGHT_LIST_ITEM,t._highlightListItemHandler),$.events(t.listComponent).off("itemFocused",t._listItemFocusHandler),t.composeID)try{var e=zmComp.getEditor(t.composeID).doc.body;$.e(e).off("mousedown",t._bodyMouseDownHandler)}catch(e){}}}]),n}(b.System.BaseHTMLEditableAutoCompleteSystem),M={createNew:function(n){var r=new e(n=n||{}),a=null;return $.events(r).on("itemSelected",function(e,t){"function"==typeof n.itemSelectAction&&n.itemSelectAction.call(r,t.item,{})}),$.events(r).on("listComponentVisibilityChange",function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};"function"==typeof n.componentShowHideAction&&n.componentShowHideAction.call(r,t.visible,{}),!t.visible&&a&&(a.destroy(),a=null)}),r.onListItemFocus=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(y)if(t.isBatchRender)setTimeout(function(){var e=t;e.isBatchRender=!1,r.onListItemFocus(e)},200);else{var e=t.component,n=t.model;a&&(a.destroy(),a=null),n.attributes.email&&e.refs&&e.refs.wrapper&&(a=zmail.Components.ContactCard.show({anchor:e.refs.wrapper,contact:n.attributes.contact,props:{useLargePhoto:!0},onBeforePosition:function(e){var t=r.listComponent.refs.wrapper.getBoundingClientRect();return e.top+e.height>t.top+t.height&&e.height<=t.height&&(e.top=t.top+t.height-e.height+e.temporalHeight),e.positionToRight&&(e.left+=t.right-e.anchorRight),e}}),$.events(a).on(zmail.Components.ContactCard.EVENTS.COPY_EMAIL,function(){r.listComponent.mouseDown=!0}),$.events(a).on(zmail.Components.ContactCard.EVENTS.ZP_ACTION,function(){r.listComponent.mouseDown=!0}),$.events(a).on(zmail.Components.ContactCard.EVENTS.WMS_CHAT_ACTION,function(){}))}},r}},O=zmText.get("composeComponents").composeRecipientComponent,w=function(){var r=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).fromAddress;return new Promise(function(t,n){zmComponent.smimeUtil.getConfirmedEmailList().then(function(e){null!==(e.filter(function(e){return e.emailId===r&&e.isSmimeEnabled})[0]||null)?t():n()},function(){n()})})},z=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=e.recipientField,t=M.createNew({composeID:e.composeID,componentShowHideAction:function(e){n.triggers.enterKeyTrigger.enabled=!e},itemSelectAction:function(e){var t=e.attributes.contact;zmail.ContactBook.isCategory(t)?zmail.ContactBook.get({categoryid:t.attrs.cid,includeOnlyPrimary:!0}).then(function(e){if(0!==e.length){var t=e.map(function(e){return v.getFullEmailAddress(e)}).join(", ");n.createTokens({text:t,silent:!0})}else _zm.succErrMsg("i",O.noContactsInCategory)},function(){_zm.succErrMsg("e",O.errorFetchingCategory)}):n.createTokens({text:e.getFullEmailAddress()})}});return t.init({inputElement:n.component.refs.input}),t},L=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=$.element(t.parentDOM,!0),n=v.createNew();n.nextDOMAnchor=$.element(t.nextDOMAnchor,!0),n.init({parentDOM:$.element(e,!0),buttonLabels:$.extend({title:"",cc:"",bcc:""},t.buttonLabels||{}),state:$.extend({ccBtn:!1,bccBtn:!1},t.state||{})});var r=n.component.refs.input;return t.enableShorcutsInInputField&&$.element(r).attr({"data-enableshortcuts":!0}),$.events(n.component).on("buttonAction",function(e){switch((1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).id){case"title-button":zmAdd.showBook(null,null,null,null,{anchor:n.component.refs.titleButton,selectionListText:t.addressBookListText||"",callback:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];if(0!==e.length){var t=e.map(function(e){return'"'+e.fn+'" <'+e.eid+">"}).join(", ");n.createTokens({text:t,silent:!0})}}})}}),n},A=function(){function t(){babelHelpers.classCallCheck(this,t);var e=this;e.recipientField={to:null,cc:null,bcc:null},e.autoComplete={to:null,cc:null,bcc:null},e.parentDOM=null,e.buttonLabels={to:"",cc:"",bcc:""},e.handleDataProviderBeforeSearch=e.handleDataProviderBeforeSearch.bind(e),e.updateExcludeEmailList=e.updateExcludeEmailList.bind(e),e.validateDragOver=e.validateDragOver.bind(e),e.validateTokenDragStart=e.validateTokenDragStart.bind(e),e.handleTokenDrop=e.handleTokenDrop.bind(e),e.handleInputFocus=e.handleInputFocus.bind(e),e.handleInputBlur=e.handleInputBlur.bind(e),e.handleSmimeCertEvents=e.handleSmimeCertEvents.bind(e)}return babelHelpers.createClass(t,[{key:"init",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this;t.parentDOM=e.parentDOM,t.buttonLabels=$.extend({},t.buttonLabels,e.buttonLabels),t.composeID=e.composeID,t.initFields(e),t.initAutoComplete(e),t.excludeEmailList=[],t.updateExcludeEmailList()}},{key:"destroy",value:function(){var e=this;e.destroyAutoComplete(),e.destroyFields(),e.recipientField={to:null,cc:null,bcc:null},e.autoComplete={to:null,cc:null,bcc:null},e.parentDOM=null,e.buttonLabels=null,e.excludeEmailList=null}},{key:"initFields",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},a=this,t=a.recipientField;t.to=L({parentDOM:e.parentDOM,buttonLabels:{title:a.buttonLabels.to,cc:a.buttonLabels.cc,bcc:a.buttonLabels.bcc},state:{ccBtn:!e.ccFieldVisible,bccBtn:!e.bccFieldVisible,showBccButton:e.showBccButton},nextDOMAnchor:e.nextDOMAnchor,addressBookListText:a.buttonLabels.to}),t.cc=L({parentDOM:e.parentDOM,buttonLabels:{title:a.buttonLabels.cc},nextDOMAnchor:e.nextDOMAnchor,addressBookListText:a.buttonLabels.cc}),e.ccFieldVisible||$.element(a.recipientField.cc.component.refs.wrapper).addClass("SC_dyn"),t.bcc=L({parentDOM:e.parentDOM,buttonLabels:{title:a.buttonLabels.bcc},nextDOMAnchor:e.nextDOMAnchor,addressBookListText:a.buttonLabels.bcc}),e.bccFieldVisible||$.element(a.recipientField.bcc.component.refs.wrapper).addClass("SC_dyn"),$.events(t.to.component).on("buttonAction",function(e){switch((1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).id){case"cc-button":$.element(t.cc.component.refs.wrapper).removeClass("SC_dyn"),t.to.component.setState({ccBtn:!1}),zmComp.setHeight(a.composeID),t.cc.component.focusInput();break;case"bcc-button":$.element(t.bcc.component.refs.wrapper).removeClass("SC_dyn"),t.to.component.setState({bccBtn:!1}),zmComp.setHeight(a.composeID),t.bcc.component.focusInput()}}),a.getRecipientFieldList().forEach(function(e){$.events(e).on("tokenChange",a.updateExcludeEmailList),$.events(e.component).on("dragOver",a.validateDragOver),$.events(e.component).on("tokenDragStart",a.validateTokenDragStart),$.events(e.component).on("tokenDrop",a.handleTokenDrop),$.events(e.component).on("copyTokensToClipboard",a.handleTokenClipboardCopy),$.events(e.component).on("inputBlur",a.handleInputBlur),$.events(e.component).on("inputFocus",a.handleInputFocus),e.model.get("tokens").on("change",function(t){var n=t.attributes;if(t.hasChanged("smimeStatus")&&"fetch"===n.smimeStatus){var r=zmComp.getFromAddr(a.composeID);w({fromAddress:r}).then(function(){zmComponent.smimeAPI.getData(r,n.email).then(function(e){t.set({smimeStatus:(e[r]||{})[n.email]?"enabled":"unavailable"})},function(){t.set({smimeStatus:"unavailable"})})},function(){t.set({smimeStatus:"unavailable"})})}})}),$.subscribe("smimeChangeCertTriggered",a.handleSmimeCertEvents)}},{key:"initAutoComplete",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=this;t.autoComplete.to=z({recipientField:t.recipientField.to,composeID:e.composeID}),t.autoComplete.cc=z({recipientField:t.recipientField.cc,composeID:e.composeID}),t.autoComplete.bcc=z({recipientField:t.recipientField.bcc,composeID:e.composeID}),t.getAutoCompleteList().forEach(function(e){$.events(e).on("dataProviderBeforeSearch",t.handleDataProviderBeforeSearch)})}},{key:"getRecipientFieldList",value:function(){var t=this;return Object.keys(t.recipientField).map(function(e){return t.recipientField[e]})}},{key:"getAutoCompleteList",value:function(){var t=this;return Object.keys(t.autoComplete).map(function(e){return t.autoComplete[e]})}},{key:"handleDataProviderBeforeSearch",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};"contacts-data-provider"===t.providerName&&((t.returnArgs||{}).excludeList=this.excludeEmailList)}},{key:"getEmailList",value:function(){var t={};return this.getRecipientFieldList().forEach(function(e){e.model.getTokenModelList().forEach(function(e){t[e.attributes.email]=!0})}),Object.keys(t)}},{key:"updateExcludeEmailList",value:function(){this.excludeEmailList=this.getEmailList()||[]}},{key:"validateDragOver",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=t.dropElement,r=t.returnArgs,a=0<this.getRecipientFieldList().map(function(e){return e.component.dom}).filter(function(e){return e.contains(n)}).length;r.valid=a}},{key:"validateTokenDragStart",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=this,r=t.token,a=t.returnArgs,i=n.getRecipientFieldList().filter(function(e){return e.component.dom.contains(r.dom)}).map(function(t){return Object.keys(n.recipientField).filter(function(e){return n.recipientField[e]===t})[0]})[0];a.sourceField=i,a.composeID=n.composeID}},{key:"handleTokenDrop",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=this,r=t.dropElement,a=t.dragData,i=void 0===a?{}:a,o=i.id,l=i.data,s=void 0===l?{}:l,c=s.sourceField,u=s.composeID,d=n.getRecipientFieldList().filter(function(e){return e.component.dom.contains(r)}).map(function(t){return Object.keys(n.recipientField).filter(function(e){return n.recipientField[e]===t})[0]})[0];if(u===n.composeID){var p=n.recipientField[c],m=n.recipientField[d];setTimeout(function(){var e=p.model.getTokenCollection().get(o);p.model.getTokenCollection().remove(e),m.model.getTokenCollection().add(e)},0)}}},{key:"handleTokenClipboardCopy",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=t.instance.model.getTokenModelList(),r=n.filter(function(e){return e.attributes.selected}),a="";r.length&&(n=r),(a=((a=t.currentTokenText&&0===r.length?t.currentTokenText:n.map(function(e){return e.attributes.fullAddress}).join(", "))||"").trim())&&zmComponent.clipBoardAPI.setData(a,{onSuccess:function(){_zm.succErrMsg("s",O.copiedToClipboard)}})}},{key:"handleInputBlur",value:function(e){var t=this,n=e.target,r=Object.keys(t.recipientField).filter(function(e){return t.recipientField[e].component===n})[0],a=t.recipientField[r];t.autoComplete[r].listComponent.visible||a.createTokens({text:n.refs.input.value})}},{key:"handleInputFocus",value:function(e){var t=e.target;this.getRecipientFieldList().forEach(function(e){e.component!==t&&0!==e.component.refs.wrapper.scrollTop&&(e.component.refs.wrapper.scrollTop=0)})}},{key:"resetSmimeState",value:function(){this.getRecipientFieldList().forEach(function(e){e.resetSmimeState()})}},{key:"fetchSmimeState",value:function(){this.getRecipientFieldList().forEach(function(e){e.fetchSmimeState()})}},{key:"cacheSmimeData",value:function(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=n.fromAddress,a=this.getEmailList()||[];return 0===a.length?Promise.reject({noRecipients:!0}):new Promise(function(e,t){w({fromAddress:r}).then(function(){zmComponent.smimeAPI.getData(r,a).then(e,t)},function(){n.fetchData?t():t({smimeDisabled:!0})},function(){t()})})}},{key:"handleSmimeCertEvents",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=this,r=t.addr;r===zmComp.getFromAddr(n.composeID)&&(n.resetSmimeState(),n.cacheSmimeData({fromAddress:r,fetchData:!0}).then(function(){n.fetchSmimeState()},function(){}))}},{key:"destroyFields",value:function(){}},{key:"destroyAutoComplete",value:function(){}}]),t}(),x={createNew:function(e){e=e||{};var t=new A;return t.init(e),t}},B=zmail.Core.Namespaces.create("zmail.Compose.Components");B.recipientListComponent=v,B.contactsAutoComplete=M,B.composeRecipientComponent=x}(),window.__rollupModule=void 0;
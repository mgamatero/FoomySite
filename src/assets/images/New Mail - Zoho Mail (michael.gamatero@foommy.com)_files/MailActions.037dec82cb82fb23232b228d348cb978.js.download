"use strict";window.zmmailAct=function(){var V,B,e=zmText.get("mail"),n=e.listing,b=e.actions,m=e.preview,N=e.listing.common.deleteOutBox,Z={},A={},q=zmail.folviewThread,s=ZMail.lConstants,w=s.cls;B=["read","unread","flag","label","move","delete","archive","unarchive","spam","notspam","folderread","sweep"];var a,v="mail/updateRead",W="folder/archived",U="mail/listing/viewchanged",X=function(e,i,t){var l={url:zmail.conPath+"/mA.do",t:"POST",fn:t,p:e,csr:"s",ep:i};_zm.isOfflineLockAvailable()||(l.setSessionId=i.suppressWSNoti),ZMail.listing.collection.doMailAction(l)},u=function(e,i){e="thd"===i?"zm_tabt"+zmUtil.getMailObj(e,"T"):"zm_tab"+e,zmsuite.isWorkspaceAvailable(e)&&(zmsuite.closeWorkspace(e),zmsuite.showExistingApp(zmTab.currentTab))},L=function(e){zmCache.updateObj(e)},h=function(e,i){void 0!==zmUtil.getMailObj(e,"TS")&&(L({mode:"upd",msgId:e,key:"TS",val:i}),$.publish(v,{msgId:e}))},p=function(e,i,t){var l,a,d,m;if(d=zmUtil.getMailObj(e))switch(a=d.T,(l=$.extend({},Z)).label="",l.attach="",l.flag=i,2!==q&&l.fId===zmail.folId.spId||(l.fId=""),m=zmList.getMailSummaryList(l,a).length,t){case"0":1===m&&("1"===i?d.TI=!1:"2"===i?d.TM=!1:"3"===i&&(d.TF=!1));break;case"1":d.TI=!0,1===m&&("2"===i?d.TM=!1:"3"===i&&(d.TF=!1));break;case"2":d.TM=!0,1===m&&("1"===i?d.TI=!1:"3"===i&&(d.TF=!1));break;case"3":d.TF=!0,1===m&&("1"===i?d.TI=!1:"2"===i&&(d.TM=!1))}},T=function(e,i){var t=zmUtil.getMailObj(e);if(t)switch(L({mode:"upd",msgId:e,key:"NFG",val:i}),i){case"0":t.TI=!1,t.TF=!1,t.TM=!1;break;case"1":t.TI=!0,t.TF=!1,t.TM=!1;break;case"2":t.TI=!1,t.TF=!1,t.TM=!0;break;case"3":t.TI=!1,t.TF=!0,t.TM=!1}},S=function(e,i,t){var l=zmUtil.getMailObj(e);if(l){l.TTAGS=l.TTAGS||[];var a,d,m,r=[],n=l.TTAGS,s=l.T;switch(t){case"add":for(a=0;a<i.length;a++)-1===n.indexOf(i[a])&&l.TTAGS.push(i[a]);break;case"delete":for(a=0;a<i.length;a++)d=n.indexOf(i[a]),m=$.extend({},Z),2!==q&&m.fId===zmail.folId.spId||(m.fId=""),m.label=i[a],r=zmList.getMailSummaryList(m,s),-1!==d&&r.length<=1&&n.splice(d,1);break;case"deleteall":l.TTAGS=[]}}},C=function(e,i,t){var l=[];return zmUtil.getListMap(i)?l=zmList.getViewBasedMsgList(i,t):l.push(e),l},M=function(e,i){var t,l,a,d=[],m=zmUtil.getMailObj(e),r=m.FD;if("msg"===i)L({mode:"upd",msgId:e,key:"AR",val:0}),m.S||ZMail.utils.updateCount({fId:r,mode:"inc"});else if("thd"===i)for(a=m.T,l=(d=C(e,a,Z)).length,t=0;t<l;t++)L({mode:"upd",msgId:d[t],key:"AR",val:0});Z.fId&&"archive"===Z.view&&zmCache.updateCacheForViews(e)},F=function(e,i){var t=zmCenterListing.mailObjectAPI.getViewObject(e,"zm_Container");t=t&&t.$element;var l=e,a=zmUtil.getMailObj(e);if(i=i||"zm_Container",zmTab.currentTab.indexOf("zm_tabt"))if(a&&zmUtil.getListMap(a.T)){var d=zmCenterListing.mailObjectAPI.getViewParentOf("c"+l,i);d&&(t=d.$element)}else(l=zmList.getDupThdRowId(e,zmUtil.getFolId()))&&(t=$(zmail.mailCenter.listElem).find("#t"+l));else l=zmsuite.getCenterOuter().$el.data("row-detail").rowId,t=$(zmail.mailCenter.listElem).find("#"+l);return t},O=function(e,i){zmail.folCount[Z.fId]&&zmUtil.getMailObj(e,"TH")&&(Z.fId!==i?($("#zmHdrP"+e).parent().addClass("SC_Tfdr"),$("#zmHdrT"+e).parent().addClass("SC_Tfdr")):($("#zmHdrP"+e).parent().removeClass("SC_Tfdr"),$("#zmHdrT"+e).parent().removeClass("SC_Tfdr")))},j=function(e,i){var t=zmInit.findFolName(i),l="";l=zmUtil.getMailObj(e,"AR")?t+" ("+m.contentOptions.archived+")":t;var a="zm_folname";$.e(zmail.mailCenter.listElem).find("#"+e+" ."+w.folName).text(t),$.q("#zmHdrP"+e+" ."+a).text(l),$.q("#zmHdrT"+e+" ."+a).text(l),$.q("#zmHdrS"+e+" ."+a).text(l);var d=$.e(zmail.mailCenter.listElem).find("#t"+e);d.length&&d.find("."+w.folName).text(t)},P=function(e){var i=!1,t=zmUtil.getMailObj(e);return Z.fId&&!Z.flag&&!Z.label||"all"===Z.view?i=!0:0!==t.NFG&&Z.flag?"-1"!==Z.flag&&Z.flag!==t.NFG||(i=!0):t.TAG&&Z.label&&("-1"===Z.label||"-1"!==$.iArray(Z.label,t.TAG))&&(i=!0),i},I=function(e,i){e.length<99?i.text(e.length+1):i.text("99+")},g=function(e,i){1!==e.length&&(e.length<=100?i.text(e.length-1):i.text("99+"))},E=function(e){var i=e.parent("."+w.thdChild);i.prev().find("."+w.thdTreeCircle).remove(),i.prev().removeClass(w.thdTreeLine),i.remove()},y=function(){var e="";return e+=zmInit.isFlex?"":zdom("div",{className:"zm_td"},zdom("div",{className:"zm_tlb"})).outerHTML},k=function(e,i,t){var l,a=P(e),d=$("#"+e),m=zmUtil.getMailObj(e),r=zmList.getViewBasedMsgList(m.T,Z);if("zm_Container"!==zmTab.currentTab){if(1<r.length&&a){var n=$("#"+r[0]);l=n.parent().prev().find("."+w.tc),Z.fId===i?I(r,l):Z.fId===t&&(g(r,l),"1"===l.text()&&E(n))}else if(1===r.length)if(Z.fId===m.FD){zmPrev.clsPreview(),$("#t"+r[0]).remove(),u("t"+m.T);var s=zmUtil.getListMap(Z.fId);if(s)for(var o in s)s[o]===Z.fId&&s.MO.splice(o,1)}else a&&((l=$("#t"+r[0]).find("."+w.tc)).text(parseInt(l.text())+1),"2"===l.text()&&l.before(y()));d.remove()}else if(d.length&&a){l=d.parent().prev().find("."+w.tc);var f;g(r,l),1===(f=parseInt(l.text()))?E(d):f<1&&(d.parent().prev().remove(),d.parent().remove(),$(A.prevElem).hasClass("shw")&&m.T===zmUtil.getMailObj(zmPrev.prevDetails().msgId,"T")&&zmPrev.clsPreview()),d.remove()}else if(zmPrev.prevDetails().msgId&&m.T===zmUtil.getMailObj(zmPrev.prevDetails().msgId,"T"))if(l=$(zmail.mailCenter.listElem).find("."+w.sel+" ."+w.tc),1<r.length&&a)Z.fId===i?I(r,l):Z.fId===t&&g(r,l);else if(r.length<=1)if(Z.fId===m.FD){$(zmail.mailCenter.listElem).find("."+w.sel).remove(),zmPrev.clsPreview(),u("t"+m.T);var z=zmUtil.getListMap(Z.fId);if(z)for(var c in z)z[c]===Z.fId&&z.MO.splice(c,1)}else a&&(l.text(parseInt(l.text())+1),"2"===l.text()&&l.before(y()))},D=function(e,i){var t=e&&$("#"+e),l=e,a=(t.parent("."+w.thdChild),zmUtil.getMailObj(e));if("msg"===i&&a.T&&zmInit.checkThreadRead(a.T)&&(t=F(e)).length){0===(l=t[0].id).indexOf("t")&&(l=l.substring(1)),t.removeClass(w.unread),zmTab.currentTab.indexOf("zm_tabt")||"unread"!==Z.view||zmPrev.isEntityOpenedInPreview(l)||(t.remove(),$("#thd"+l).remove());var d=zmUtil.getFolId();if(zmUtil.getListMap(d)){var m=zmUtil.getFirstMsgId(a.T,Z);m&&(l=m)}h(l,1)}},x=function(e,i){var t,l,a=0,d=0,m=zmUtil.getMailObj(e);for(0===m.TC&&(m.TC=1),zmUtil.isFolderId(i)&&(m.FD=i),t=zmList.constructThreadChildRow(e),l=zmList.getMailSummaryList(Z,m.T),d=0;d<l.length;d++){if(zmUtil.getMailObj(l[d]).R<m.R){a=d;break}}$(A.listElem).find("#"+l[a]).before(t)},_=function(e,i){var t=$("#"+e),l=e,a=zmUtil.getMailObj(e);if("msg"===i&&a.T&&!zmInit.checkThreadRead(a.T)&&(t=F(e)).length){0===(l=t[0].id).indexOf("t")&&(l=l.substring(1)),t.addClass(w.unread);var d=zmUtil.getFolId();if(zmUtil.getListMap(d)){var m=zmUtil.getFirstMsgId(a.T,Z);m&&(l=m)}h(l,0)}},R=function(e,i,t){if(!i.preAction){var l,a,d,m,r,n,s=zmUtil.getMailObj(e);if(s.AR&&M(e,t),l=s.FD,a=i.folId,"notifier"!==i.from||l!==a||zmUtil.getFolId()!==a){if("msg"===t){if(m=$(zmail.mailCenter.listElem).find("#"+e),j(e,a),O(e,a),l===zmail.folId.tId||zmfolAction.isDeletedFolder(l)||l===zmail.folId.spId||a===zmail.folId.tId||zmfolAction.isDeletedFolder(a)||a===zmail.folId.spId)r=!0;else if((n=s.T)&&zmUtil.getListMap(n)){var o=zmList.getMailSummaryList(Z,n);if(o.length<=1&&-1!==i.mailId.indexOf(o[0])){var f=F(e);f.length&&(f.remove(),zmCenterListing.mailObjectAPI.rowRemovedInView(e,t)),E(m),$(A.prevElem).attr("data-mid")&&zmPrev.updatePrevOnDeletion(e)}}s.T&&(1===q||2===q&&r)?k(e,a,s.FD):("unread"!==(d=zmUtil.getFolId())&&"all"!==d&&"flag"!==d&&!zmUtil.isLabelId(d)&&"search"!==d||a===zmail.folId.tId||zmfolAction.isDeletedFolder(a)||a===zmail.folId.spId)&&(s.T&&0!==q||(m.remove(),zmCenterListing.mailObjectAPI.rowRemovedInView(e,t))),s.T&&(""===Z.fId||Z.fId===a)&&P(e)&&x(e,a)}else if("thd"===t){(m=$(zmail.mailCenter.listElem).find("#t"+e)).length||(m=$(zmail.mailCenter.listElem).find("#"+e));var z,c,I=[],g=zmInit.findFolName(a);if(n=s.T,zmUtil.getListMap(n)&&(I=zmList.getViewBasedMsgList(n,Z)),z=I.length,2===q&&Z.fId&&Z.fId!==a||1===q&&Z.fId===l&&l!==a||a===zmail.folId.tId||"archive"===Z.view||a===zmail.folId.spId)m.remove(),$(zmail.mailCenter.listElem).find("#thd"+e).remove(),zmCenterListing.mailObjectAPI.rowRemovedInView(e,t);else if(m.find("."+w.folName).text(g),2===q||!Z.fId)for(c=0;c<z;c++)$(zmail.mailCenter.listElem).find("#"+I[c]+" ."+w.folName).text(g),$.publish("mail/move",[I[c],"msg",i])}u(e,t),$.publish("mail/move",[e,"msg",i]),function(e,i,t,l){var a,d,m,r,n=[];r=t.folId;var s=zmUtil.getMailObj(e);if("msg"===l){if(L({mode:"move",msgId:e,rFrom:i,addTo:r,type:l}),!s.S&&!s.AR){var o={action:"move",src:i,dest:r};ZMail.utils.updateCount({fId:i,mode:"dec",actionObj:o}),ZMail.utils.updateCount({fId:r,mode:"inc",actionObj:o})}}else if("thd"===l)for(L({mode:"move",msgId:e,rFrom:i,addTo:r,type:l}),a=s.T,d=(n=C(e,a,Z)).length,m=0;m<d;m++)L({mode:"upd",msgId:n[m],key:"FD",val:r});zmfolAction.isMutualFolder(r)&&zmContentCache.isCached(e)&&zmContentCache.delete(e)}(e,l,i,t),"msg"===t&&zmPreviewTemplate.updateMailHeaderView(e),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&(zmInit.checkThreadRead(s.T)?D(e,t):_(e,t))}}},G=function(e,i,t){if(t){if(t.preAction)return;t.from&&(V=t.from)}var l,a,d,m,r,n=zmUtil.getMailObj(e),s=n.FD;if(Z=zmInit.getListingDetObj(),s&&$("#"+s+" .SC_ct").hasClass("SC_new")){zmail.mailLeft.getNodes()[0].getLayer("zmlTreeH").clearNew(s)}if("msg"===i){if((l=$(zmail.mailCenter.listElem).find("#"+e)).removeClass(w.unread),a=l.parent("."+w.thdChild),"mail_preview"!==V||"mail_preview"===V&&!zmTab.currentTab.indexOf("zm_srch"))if("unread"===Z.view&&("zm_Container"!==zmTab.currentTab||!$(A.prevElem).attr("data-mid")||$(A.prevElem).attr("data-mid")&&$(A.prevElem).attr("data-mid")!==e&&(!n.TH||n.TH&&n.T!==zmUtil.getMailObj($(A.prevElem).attr("data-mid"),"T")))){var o=n.T;if(o&&0!==q){if(1===zmList.getMailSummaryList(Z,o).length&&!zmPrev.isEntityOpenedInPreview(e)){E(l);var f=zmCenterListing.mailObjectAPI.getViewParentOf("c"+e,"zm_Container");if(f){var z="t"+f.id;r=z,$(zmail.mailCenter.listElem).find("#"+r).remove()}}}else l.remove()}else a.hasClass(w.thdChild)&&!a.children("div").hasClass(w.unread)&&a.prev().removeClass(w.unread);$("#zmHdrP"+e).find(".zmPT").removeClass("zm_urd"),$("#zmHdrT"+e).find(".zmPT").removeClass("zm_urd"),$("#zmHdrS"+e).find(".zmPT").removeClass("zm_urd")}else if("thd"===i)if((l=$(zmail.mailCenter.listElem).find("#t"+e)).length||(l=$(zmail.mailCenter.listElem).find("#"+e)),a=$(zmail.mailCenter.listElem).find("#thd"+e),l.removeClass(w.unread),a.children("div").removeClass(w.unread),"unread"!==Z.view||"click"===V||"zm_Container"===zmTab.currentTab&&$(A.prevElem).attr("data-mid")===e)for(d=zmList.getViewBasedMsgList(n.T,Z),m=0;m<d.length;m++)$("#zmHdrP"+d[m]).find(".zmPT").removeClass("zm_urd"),$("#zmHdrT"+d[m]).find(".zmPT").removeClass("zm_urd"),$("#zmHdrS"+d[m]).find(".zmPT").removeClass("zm_urd"),$.publish("mail/read",[d[m],"msg"]);else l.remove(),a.remove();$.publish("mail/read",[e,"msg"]),function(e,i,t){var l,a,d,m,r=[],n=zmUtil.getMailObj(e)||{};if("msg"===i){if(!n.S){var s,o,f,z;l=n.FD,L({mode:"upd",msgId:e,key:"S",val:1}),s=(o=$(zmail.mailCenter.listElem).find("#"+e)).parent("."+w.thdChild).length?o.parent("."+w.thdChild):$(zmail.mailCenter.listElem).find("."+w.sel).next(),n.T&&0!==q&&(f=s.prev()).length&&0===(z=f[0].id).indexOf("t")&&(z=z.substring(1),$.publish(v,{msgId:z})),n.AR||ZMail.utils.updateCount({fId:l,mode:"dec",info:t})}}else if("thd"===i){m=n.T;var c=$.extend({},Z);for("unread"===Z.view&&(""===Z.fId?c.view="all":c.view=""),zmUtil.getListMap(m)?r=zmList.getViewBasedMsgList(n.T,c):r.push(e),d=r.length,a=0;a<d;a++)zmUtil.getMailObj(r[a],"S")||L({mode:"upd",msgId:r[a],key:"S",val:1});h(e,1)}if("unread"===Z.view&&"mail_preview"!==V){var I=!1;if("zm_Container"!==zmTab.currentTab){var g=zmsuite.getCenterOuter().$el.data("row-detail")?zmsuite.getCenterOuter().$el.data("row-detail").rowId:"";g.indexOf("t")||(e=g.substring(1),n=zmUtil.getMailObj(e)),I=!0}else!n.TH&&$(A.prevElem).attr("data-mid")!==e||n.TH&&$(A.prevElem).attr("data-mid")&&zmUtil.getMailObj($(A.prevElem).attr("data-mid"),"T")!==n.T?I=!0:"dropdown"===V&&(I=!0);I&&(!n.TH||n.TH&&zmInit.checkThreadRead(n.T))&&zmCache.updateCacheForViews(e)}}(e,i,t),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&D(e,i)},H=function(e,i,t){if(!t){var l,a,d,m,r=zmUtil.getMailObj(e);if("msg"===i){var n,s;if((l=$(zmail.mailCenter.listElem).find("#"+e)).addClass(w.unread),a=l.parent("."+w.thdChild).length?l.parent("."+w.thdChild):$(zmail.mailCenter.listElem).find("."+w.sel).next(),r.T&&0!==q&&a.children("div").hasClass(w.unread)&&(""===Z.fId||""!==Z.fId&&Z.fId===r.FD))(n=a.prev()).addClass(w.unread),n.length&&(0===(s=n[0].id).indexOf("t")&&(s=s.substring(1)),h(s,0));$("#zmHdrP"+e).find(".zmPT").addClass("zm_urd"),$("#zmHdrT"+e).find(".zmPT").addClass("zm_urd"),$("#zmHdrS"+e).find(".zmPT").addClass("zm_urd")}else if("thd"===i){for((l=$(zmail.mailCenter.listElem).find("#t"+e)).length||(l=$(zmail.mailCenter.listElem).find("#"+e)),l.addClass(w.unread),$(zmail.mailCenter.listElem).find("#thd"+e).children("div").not(".zmsnt").addClass(w.unread),d=zmList.getViewBasedMsgList(r.T,Z),m=0;m<d.length;m++)zmUtil.getMailObj(d[m],"FD")!==zmail.folId.sId&&($("#zmHdrP"+d[m]).find(".zmPT").addClass("zm_urd"),$("#zmHdrT"+d[m]).find(".zmPT").addClass("zm_urd"),$("#zmHdrS"+d[m]).find(".zmPT").addClass("zm_urd"),$.publish("mail/unread",[d[m],"msg"]))}$.publish("mail/unread",[e,"msg"]),function(e,i){var t,l,a,d=[],m=zmUtil.getMailObj(e);if("msg"===i)m.S&&((t=m.FD)!==zmail.folId.sId&&L({mode:"upd",msgId:e,key:"S",val:0}),m.AR||ZMail.utils.updateCount({fId:t,mode:"inc"}));else if("thd"===i){var r;a=m.T;var n,s=$.extend({},Z);for("unread"===Z.view&&(""===Z.fId?s.view="all":s.view=""),zmUtil.getListMap(a)?d=zmList.getViewBasedMsgList(m.T,s):d.push(e),l=d.length,r=0;r<l;r++)(n=zmUtil.getMailObj(d[r])).S&&n.FD!==zmail.folId.sId&&L({mode:"upd",msgId:d[r],key:"S",val:0});h(e,0)}}(e,i),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&_(e,i)}},J=function(e,i){var t,l=zmList.getMailSummaryList(Z,zmUtil.getMailObj(e,"T")),a=0,d=$("#"+e);Z.flag?a="-1"===Z.flag&&"0"===i||"-1"!==Z.flag&&Z.flag!==i?0:1:Z.label&&(a=i),0===a?d.length?(t=d.parent().prev().find("."+w.tc),g(l,t),"1"===t.text()&&E(d)):(t=$(zmail.mailCenter.listElem).find("."+w.sel+" ."+w.tc),g(l,t)):d.length?(t=d.parent().prev().find("."+w.tc),I(l,t)):(t=$(zmail.mailCenter.listElem).find("."+w.sel+" ."+w.tc),I(l,t),"2"===t.text()&&t.before(y()))},K=function e(i,t,l,a){if(!a){var d,m,r,n,s=zmInit.flgClass(t),o="",f="",z=zmUtil.getMailObj(i);if("msg"===l){if(o=$.e(zmail.mailCenter.listElem).find("#"+i),z.TH&&0!==q&&(d=F(i))&&d.length){-1!==(f=d[0].id).indexOf("t")&&(f=f.substring(1));var c=zmUtil.getFolId();if(zmUtil.getListMap(c)){var I=zmUtil.getFirstMsgId(z.T,Z);I&&(f=I)}p(f,z.NFG,t),r=zmInit.getThdFlagvalue(f),m=zmInit.flgClass(r),d.find("."+w.flag).removeClass().addClass(m)}if($("#zmHdrP"+i+" ."+w.flag).removeClass().addClass(s),$("#zmHdrT"+i+" ."+w.flag).removeClass().addClass(s),$("#zmHdrS"+i+" ."+w.flag).removeClass().addClass(s),Z.flag&&"0"===t)z.T?"-1"!==Z.flag&&Z.flag!==z.NFG||0===z.NFG||(n=zmList.getMailSummaryList(Z,z.T),1===q||2===q?(J(i,t),2===n.length?E(o):1===n.length&&d.length&&(d.remove(),$(A.prevElem).attr("data-mid")===f&&"lt"===$(A.prevElem).attr("data-ty")&&zmPrev.clsPreview()),o.remove()):2===q&&1===n.length&&(E(o),d.length&&(d.remove(),$(A.prevElem).attr("data-mid")===f&&"lt"===$(A.prevElem).attr("data-ty")&&zmPrev.clsPreview()))):(o.remove(),$(A.prevElem).attr("data-mid")===i&&zmPrev.clsPreview()),o.find("."+w.flag).removeClass().addClass(s);else if(0===t)o.find("."+w.flag).removeClass().addClass(s);else{if(z.T){if(Z.flag)if(n=zmList.getMailSummaryList(Z,z.T),1===q||2===q)if(""===Z.fId)if("-1"===Z.flag&&"0"===z.NFG||Z.flag===t&&z.NFG!==t){if(x(i,""),1===n.length)if($("#t"+n[0]).length)$("#t"+n[0]).find("."+w.tc).before(y());else if($(zmail.mailCenter.listElem).find("."+w.sel).length){var g=zmail.mailCenter.listElem;$(g).find("."+w.sel+" ."+w.tc).before(y())}J(i,t)}else"-1"!==Z.flag&&z.NFG!==t&&(2===n.length?E(o):1===n.length&&(o.parent().prev().remove(),o.parent().remove(),zmPrev.clsPreview()),J(i,t),o.remove());else Z.fId===z.FD&&("-1"===Z.flag&&"0"===z.NFG||Z.flag===t&&z.NFG!==t?(x(i,""),J(i,t)):"-1"!==Z.flag&&z.NFG===Z.flag&&z.NFG!==t&&(J(i,t),o.remove()));else 2===q&&1===n.length&&(""===Z.fId&&"-1"!==Z.flag&&z.NFG!==t||Z.fId===z.FD&&"-1"!==Z.flag&&z.NFG===Z.flag&&z.NFG!==t)&&(E(o),d.length&&(d.remove(),$(A.prevElem).attr("data-mid")===f&&"lt"===$(A.prevElem).attr("data-ty")&&zmPrev.clsPreview()))}else Z.flag&&"-1"!==Z.flag&&z.NFG!==t&&o.remove();o.find("."+w.flag).removeClass().addClass(s)}L({mode:"upd",msgId:i,key:"NFG",val:t})}else if("thd"===l){var v,u,h;for(n=[],h=z.T,v=(n=zmList.getViewBasedMsgList(h,Z)).length,u=0;u<v;u++)e(n[u],t,"msg",a);(o=$(zmail.mailCenter.listElem).find("#t"+i)).length||(o=$(zmail.mailCenter.listElem).find("#"+i)),T(i,t),Z.flag&&"0"===t?(o.remove(),$(zmail.mailCenter.listElem).find("#thd"+i).remove(),$(A.prevElem).attr("data-mid")===i&&zmPrev.clsPreview()):"0"===t?o.find("."+w.flag).removeClass().addClass(s):Z.flag&&"-1"!==Z.flag&&Z.flag!==t?($(zmail.mailCenter.listElem).find("#thd"+i).remove(),o.remove(),$(A.prevElem).attr("data-mid")===i&&zmPrev.clsPreview()):o.find("."+w.flag).removeClass().addClass(s)}$.publish("mail/flag",[i,"msg",t]),Z.flag&&("-1"===Z.flag&&"0"===t||"-1"!==Z.flag&&t!==Z.flag)&&zmCache.updateCacheForViews(i),o.length&&0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&(zmInit.checkThreadRead(z.T)?D(i,l):_(i,l))}},Q=function e(i,t,l){if(!t.preAction){var a,d,m,r,n,s,o=!1,f=zmUtil.getMailObj(i);if("msg"===l){var z;if(a=$(zmail.mailCenter.listElem).find("#"+i),f.TH&&0!==q){if((d=F(i)).length){-1!==(m=d[0].id).indexOf("t")&&(m=m.substring(1));var c=zmUtil.getFolId();if(zmUtil.getListMap(c)){var I=zmUtil.getFirstMsgId(f.T,Z);I&&(m=I)}}S(m,[t.lId],t.lA)}if("add"===t.lA){if(f.TAG=f.TAG||[],n=f.TAG,f.T&&(1===q||2===q)&&Z.label)if(z=$.inArray(t.lId,f.TAG),""===Z.fId){if(Z.label===t.lId&&-1===z){if(x(i,""),1===(r=zmList.getMailSummaryList(Z,f.T)).length)if($("#t"+r[0]).length)$("#t"+r[0]).find("."+w.tc).before(y());else if($(zmail.mailCenter.listElem).find("."+w.sel).length){$(zmail.mailCenter.listElem).find("."+w.sel+" ."+w.tc).before(y())}J(i,1)}}else Z.fId===f.FD&&("-1"===Z.label&&0===f.TAG.length||Z.label===t.lId&&-1===z)&&(x(i,""),J(i,1));-1===(z=$.inArray(t.lId,n))&&f.TAG.push(t.lId)}else if("delete"===t.lA&&f.TAG){var g,v=f.TAG,u=v.length;for(f.T&&(1===q||2===q&&Z.fId===zmail.folId.tId)&&("-1"===Z.label&&1===f.TAG.length||Z.label===t.lId)&&(J(i,0),2===(r=zmList.getMailSummaryList(Z,f.T)).length?E(a):1===r.length&&(d.length&&(d.remove(),$(zmail.mailCenter.listElem).find("#thd"+m).remove(),$(A.prevElem).attr("data-mid")===m&&"lt"===$(A.prevElem).attr("data-ty")&&("zm_Container"===zmTab.currentTab?zmPrev.clsPreview():zmTab.currentTab.indexOf("zm_tab")||$.publish(U,[]))),o=!0,s=m)),g=0;g<u;g++)if(t.lId===v[g]){f.TAG.splice(g,1);break}}else"deleteall"===t.lA&&f.TAG&&(f.T&&(J(i,"0"),Z.label&&(2===(r=zmList.getMailSummaryList(Z,f.T)).length?E(a):1===r.length&&((d=F(i)).length&&(d.remove(),$(zmail.mailCenter.listElem).find("#thd"+m).remove(),$(A.prevElem).attr("data-mid")===m&&"lt"===$(A.prevElem).attr("data-ty")&&("zm_Container"===zmTab.currentTab?zmPrev.clsPreview():zmTab.currentTab.indexOf("zm_tab")||$.publish(U,[]))),o=!0,s=m))),f.TAG=[]);(Z.label&&"deleteall"===t.lA||(Z.label===t.lId||"-1"===Z.label)&&"delete"===t.lA)&&(a.remove(),o=!0,s=s||i,$(A.prevElem).attr("data-mid")!==i||f.T&&"th"!==$(A.prevElem).attr("data-ty")||("zm_Container"===zmTab.currentTab?zmPrev.clsPreview():zmTab.currentTab.indexOf("zm_tab")||$.publish(U,[])))}else if("thd"===l){var h,p,T,b=f.T;for(r=[],p=0,h=(r=zmList.getViewBasedMsgList(b,Z)).length;p<h;p++)T=zmUtil.getMailObj(r[p]),("deleteall"===t.lA&&T.TAG||"add"===t.lA&&(!T.TAG||-1===$.inArray(t.lId,T.TAG))||"delete"===t.lA&&$.inArray(t.lId,0<=T.TAG))&&e(r[p],t,"msg");if((a=d=$(zmail.mailCenter.listElem).find("#t"+i)).length||(a=d=$(zmail.mailCenter.listElem).find("#"+i)),S(i,[t.lId],t.lA),"add"===t.lA)f.TAG||(f.TAG=[]),n=f.TAG,-1===$.inArray(t.lId,f.TAG)&&n.push(t.lId);else if("delete"===t.lA&&f.TAG){var C,M=f.TAG,O=M.length;for(C=0;C<O;C++)if(t.lId===M[C]){f.TAG.splice(C,1);break}("-1"===Z.label&&0===f.TAG.length||Z.label===t.lId)&&($(zmail.mailCenter.listElem).find("#thd"+i).remove(),a.remove(),$(A.prevElem).attr("data-mid")===i&&zmPrev.clsPreview(),o=!0,s=i)}else"deleteall"===t.lA&&f.TAG&&($(zmail.mailCenter.listElem).find("#t"+i+" p").remove(),f.TAG=[]);Z.label&&"deleteall"===t.lA&&(a.remove(),L({mode:"upd",msgId:i,key:"TAG",val:""}),$(A.prevElem).attr("data-mid")===i&&zmPrev.clsPreview(),o=!0,s=i)}o&&s&&zmCache.updateCacheForViews(s),zmPreviewTemplate.refreshLabelsForMail(i,d),$.publish("mail/label",[i,"msg",t]),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&(zmInit.checkThreadRead(f.T)?D(i,l):_(i,l))}},Y=function(e,i,t,l){if(!l){var a,d=zmUtil.getMailObj(e);if("msg"===t)a=$.e(zmail.mailCenter.listElem).find("#"+e),j(e,zmail.folId.tId),O(e,zmail.folId.tId),d.T&&(d.FD===zmail.folId.dId&&zmUtil.removeDraftMapping(e),zmCenterListing.mailObjectAPI.rowRemovedInView(e,t),k(e,zmail.folId.tId,d.FD)),5!==i&&d.FD===zmail.folId.tId&&(i=5),Z.fId===zmail.folId.tId&&d.FD!==zmail.folId.tId&&P(e)&&x(e,zmail.folId.tId),d.TH&&0!==q||(a.remove(),zmCenterListing.mailObjectAPI.rowRemovedInView(e,t)),$.publish("/mail/msgDiscarded",[{draftId:e,actionType:"discard_draft"}]),zmContentCache.remove(e);else if("thd"===t){var m,r,n;for((a=$.e(zmail.mailCenter.listElem).find("#t"+e)).length||(a=$.e(zmail.mailCenter.listElem).find("#"+e)),n=(m=zmList.getViewBasedMsgList(void 0,Z)).length,r=0;r<n;r++)$.publish("mail/delete",[m[r],"msg",i]);a.remove(),zmCenterListing.mailObjectAPI.rowRemovedInView(e,t),$.e(zmail.mailCenter.listElem).find("#thd"+e).remove()}u(e,t),$.publish("mail/delete",[e,"msg",i]),function(e,i,t){var l,a,d,m=[],r=zmUtil.getMailObj(e);if("msg"===i){if(r.FD===zmail.folId.teId)ZMail.utils.updateCount({fId:zmail.folId.teId,mode:"dec"});else if(r.FD===zmail.folId.dId)ZMail.utils.updateCount({fId:zmail.folId.dId,mode:"dec"});else if(0===r.S&&!r.AR){var n={action:"delete",src:r.FD,dest:zmail.folId.tId};ZMail.utils.updateCount({fId:r.FD,mode:"dec",actionObj:n}),0===t&&ZMail.utils.updateCount({fId:zmail.folId.tId,mode:"inc",actionObj:n})}L({mode:"delete",msgId:e,folId:r.FD,type:i})}else if("thd"===i&&(l=r.T,zmUtil.getListMap(l)?m=zmList.getViewBasedMsgList(l,Z):m.push(e),d=m.length,0===t))for(a=0;a<d;a++)L({mode:"delete",msgId:m[a],folId:zmUtil.getMailObj(m[a],"FD"),type:i});!Z.fId&&(Z.view||Z.flag||Z.label)&&zmCache.updateCacheForViews(e)}(e,t,i),"msg"===t&&zmPreviewTemplate.updateMailHeaderView(e),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&(zmInit.checkThreadRead(d.T)?D(e,t):_(e,t))}},o=function(e,i){var t,l,a,d,m=zmUtil.getMailObj(e);t=C(e,m.T,Z),a=$(zmail.mailCenter.listElem).find("#"+e),d=Boolean(Z.fId),l=a.length?a.parent().prev().find("."+w.tc):$(zmail.mailCenter.listElem).find("."+w.sel+" ."+w.tc),d&&("unarchive"===i&&1===m.AR||"archive"===i&&0===m.AR)&&(g(t,l),"1"===l.text()&&E(a))},ee=function(e,i,t){if(!t){var l,a,d=!0,m=zmUtil.getMailObj(e),r=m.T;if("msg"===i){if((l=$(zmail.mailCenter.listElem).find("#"+e)).addClass(w.archIndication),r&&zmUtil.getListMap(r)){var n=zmList.getMailSummaryList(Z,r);if(n.length<=1&&e===n[0]){var s=F(e);s.length&&s.remove(),E(l),$(A.prevElem).attr("data-mid")&&zmPrev.updatePrevOnDeletion(e),d=!1}}d&&m.TH&&0!==q&&o(e,"archive"),("archive"!==Z.view&&Z.fId||!Z.fId&&"unread"===Z.view)&&l.remove()}else"thd"===i&&(l=$(zmail.mailCenter.listElem).find("#t"+e),a=$(zmail.mailCenter.listElem).find("#thd"+e),l.addClass(w.archIndication),"archive"!==Z.view&&""!==Z.fId&&(l.remove(),a.remove()));u(e,i),$.publish("mail/archive",[e,"msg"]),function(e,i){var t,l,a,d=[],m=zmUtil.getMailObj(e),r=m.FD;if("msg"===i)L({mode:"upd",msgId:e,key:"AR",val:1}),$.publish(W,[m.FD]),m.S||ZMail.utils.updateCount({fId:r,mode:"dec"});else if("thd"===i)for(a=m.T,l=(d=C(e,a,Z)).length,t=0;t<l;t++)L({mode:"upd",msgId:d[t],key:"AR",val:1}),$.publish(W,[zmUtil.getMailObj(d[t],"FD")]);(Z.fId&&"archive"!==Z.view||!Z.fId&&"unread"===Z.view)&&zmCache.updateCacheForViews(e)}(e,i),j(e,m.FD),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&(zmInit.checkThreadRead(m.T)?D(e,i):_(e,i))}},ie=function(e,i,t){if(!t){var l,a,d=!0,m=zmUtil.getMailObj(e),r=m.T;if("msg"===i){if((l=$(zmail.mailCenter.listElem).find("#"+e)).removeClass(w.archIndication),r&&zmUtil.getListMap(r)){var n=zmList.getMailSummaryList(Z,r);if(n.length<=1&&e===n[0]){var s=F(e);s.length&&s.remove(),E(l),$(A.prevElem).attr("data-mid")&&zmPrev.updatePrevOnDeletion(e),d=!1}}d&&m.TH&&0!==q&&o(e,"unarchive"),"archive"===Z.view&&l.remove()}else l=$(zmail.mailCenter.listElem).find("#t"+e),a=$(zmail.mailCenter.listElem).find("#thd"+e),l.removeClass(w.archIndication),"archive"===Z.view&&(l.remove(),a.remove());$.publish("mail/unarchive",[e,"msg"]),M(e,i),j(e,m.FD),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&(zmInit.checkThreadRead(m.T)?D(e,i):_(e,i))}},te=function(e,i,t){if(!t){var l,a,d=zmUtil.getMailObj(e);if("msg"===i){if(l=d.FD,a=zmail.folId.spId,j(e,a),O(e,a),d.T&&0!==q&&k(e,a,l),d.TH&&0!==q||$(zmail.mailCenter.listElem).find("#"+e).remove(),L({mode:"move",msgId:e,rFrom:l,addTo:a,type:i}),0===d.S&&!d.AR){var m={action:"spam",src:l,dest:a};ZMail.utils.updateCount({fId:l,mode:"dec",actionObj:m}),ZMail.utils.updateCount({fId:a,mode:"inc",actionObj:m})}}else if("thd"===i){var r,n,s,o;for(l=d.FD,a=zmail.folId.spId,o=d.T,$("#t"+e).remove(),$("#thd"+e).remove(),zmPrev.clsPreview(),L({mode:"move",msgId:e,rFrom:l,addTo:a,type:i}),n=(r=C(e,o,Z)).length,s=0;s<n;s++)L({mode:"upd",msgId:r[s],key:"FD",val:zmail.folId.spId})}u(e,i),"msg"===i&&zmPreviewTemplate.updateMailHeaderView(e),$.publish("mail/spam",[e,"msg"]),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&(zmInit.checkThreadRead(d.T)?D(e,i):_(e,i))}},le=function(e,i,t){var l,a,d,m,r,n;if(l=zmail.folId.spId,i){a=i.length;var s,o=zmUtil.getMailObj(e);if("msg"===t){if(d=i[0].folId,m=i[0].detail.m,j(e,d),O(e,d),(1===q||2===q&&Z.fId===zmail.folId.spId)&&o.T&&Z.fId===l&&k(e,d,l),(0===q||!o.TH||o.TH&&"unread"!==Z.view)&&$(zmail.mailCenter.listElem).find("#"+e).remove(),L({mode:"move",msgId:e,rFrom:zmail.folId.spId,addTo:d,type:t}),0===o.S&&!o.AR){var f={action:"notspam",src:l,dest:d};ZMail.utils.updateCount({fId:l,mode:"dec",actionObj:f}),ZMail.utils.updateCount({fId:d,mode:"inc",actionObj:f})}}else for($("#t"+e).remove(),$("#thd"+e).remove(),zmPrev.clsPreview(),r=0;r<a;r++)for(d=i[0].folId,m=i[0].detail.m,L({mode:"insert",msgId:e,rt:o.R,folId:d,type:t}),n=0;n<m.length;n++)if((s=zmUtil.getMailObj(m[n]))&&(L({mode:"upd",msgId:m[n],key:"FD",val:d}),0===s.S&&!s.AR)){var z={action:"notspam",src:l,dest:d};ZMail.utils.updateCount({fId:l,mode:"dec",actionObj:z}),ZMail.utils.updateCount({fId:d,mode:"inc",actionObj:z})}"msg"===t&&zmPreviewTemplate.updateMailHeaderView(e),$.publish("mail/notspam",[e,"msg",i]),0!==q&&Z.fId!==zmail.folId.tId&&Z.fId!==zmail.folId.dId&&(zmInit.checkThreadRead(o.T)?D(e,t):_(e,t))}},ae=function(e,i){zmUtil.hideMenu();var t={read:n.maillistopt.markread,unread:n.maillistopt.markunread,flag:b.common.flag,label:b.common.label,move:b.common.move,delete:b.common.delete,spam:n.maillistopt.markspam,notspam:n.maillistopt.notspam,archive:n.maillistopt.archive,unarchive:n.maillistopt.unarchive};if("success"===e.result)return zmUtil.succErrMsg("s",zmText.applyArgs(b.bulkaction.common.info,{actionname:t[i.action]})),void zmList.unchkAll()},de=function(e,i){var t,l,a,d,m,r,n=e.length,s=i.length,o=zmPrev.prevDetails().msgId,f=zmUtil.getMailObj(o),z=f&&f.TH&&q||0,c=!1,I=!1,g=!0;if((1===n&&0===s||0===n&&1===s)&&o===(l=n?e[0]:i[0])&&(c=!0),z&&0<n&&0===s){var v=f.T;for(m=0;m<n;m++)if(zmUtil.getMailObj(e[m],"T")!==v){g=!1;break}if(g)return}if(!c&&!I)for(m=0,a=n;m<a;m++)if(o===e[m]){I=!0;break}if(!c&&!I)for(t=zmInit.getListingDetObj(),m=0,a=s;!I&&m<a;m++){if(o===i[m]){I=!0;break}for(r=0,d=(e=zmList.getMailSummaryList(t,zmUtil.getMailObj(i[m],"T"))).length;r<d;r++)if(o===e[r]){I=!0;break}}c?zmPrev.updatePrevOnDeletion(l):I&&zmPrev.clsPreview()},me=function(){var e=zmUtil.getFolId(),i=zmUtil.getListMap(e);if(i){var t=parseInt(zmail.mailOpt.range)||50;(i.MO&&i.MO.length)<t&&zmInit.fillMails(t)}},re=function(){var e,i=[{id:"zm_Container",view:zmUtil.getFolId()},{id:"zm_srch1",view:"search"}],t=i.length,l=0;for(l=0;l<t;l++){var a,d,m=i[l].id,r=i[l].view;zmsuite.isWorkspaceAvailable(m)&&(d=zmsuite.getCenter(m)[0].getNodes()[2].$el,(a=zmPrev.prevDetails(m).msgId)&&0===d.find("."+s.cls.mRow+"."+w.sel).length&&(e=zmList.getDupThdRowId(a,r))&&zmList.setMailSelection(e,"lt",d))}},ne=function(e,i){if(!ZMail.utils.isROMode()){var t,l,a,d,m,r,n,s=i.mailId,o=i.amailId,f=i.tmailId,z=i.source,c=i.action,I=i.preAction,g=i.loadAdjacent,v=[];if(A=zmList.getElemObj(),"success"===e.result){var u,h,p=zmUtil.getMLConversionValue();for(zmUtil.hideMenu(),Z=zmTab.currentTab.indexOf("zm_tab")?zmTab.currentTab.indexOf("zm_srch")?zmInit.getListingDetObj():zmSearchUtil.getSearchViewDetails():zmsuite.getCenterOuter().$el.data("data-detail"),q=Z.fId===zmail.folId.sId&&0!==p?0:p,v.push(s),v.push(o),v.push(f),a=v.length,("popup"===z||g)&&""!==zmPrev.prevDetails().msgId&&("move"===c||"delete"===c||"spam"===c||"notspam"===c||"unarchive"===c&&"archive"===Z.view||"archive"===c&&("archive"!==Z.view&&Z.fId||!Z.fId&&"unread"===Z.view))&&de(s||[],f||[]),d=0;d<a;d++)for(m=0===d||1===d?"msg":"thd",l=(t=v[d])?t.length:0,r=0;r<l;r++)if(n=t[r],zmUtil.isMetaDataAvailable(n))switch(c){case"move":R(n,i,m);break;case"delete":Y(n,i.fT,m,I);break;case"archive":ee(n,m,I);break;case"unarchive":ie(n,m,I);break;case"spam":te(n,m,I);break;case"notspam":le(n,e.desFol||i.resp.desFol,m)}if(e.count)e.count.forEach(function(e){h=Object.keys(e)[0],(u=parseInt(e[h]))<0?ZMail.utils.updateCount({fId:h,mode:"bdec",count:Math.abs(u)}):ZMail.utils.updateCount({fId:h,mode:"binc",count:u})});"mail"===i.from||-1!==zmTab.currentTab.indexOf("zm_tab")||!Z.fId&&((Z.fId||"unread"!==Z.view)&&"search"!==Z.view||"delete"!==c&&"move"!==c&&"archive"!==c&&"spam"!==c&&"notspam"!==c)||("notifier"!==i.from&&(zmList.unchkAll(),"move"===c&&zmUtil.succErrMsg("s",b.info.moveSuccess)),$(A.prevElem).attr("data-mid")&&$(".SC_Popn").length&&zmPrev.removeCountinPreview(A)),re(),me()}else{var T=b.common.errorprocessing;e.result?T=e.result:e.error&&(T=e.error),zmsDialog.alert(T)}$.publish("/maction/"+i.action),i.updUnarchiveStatusforFId&&zmfolAction.markFolderAsUnarchived({folId:i.updUnarchiveStatusforFId})}},se=function(e,i){if(!ZMail.utils.isROMode()){var t,l,a,d,m,r,n,s=[];if(A=zmList.getElemObj(),"success"===e.result){e.hasOwnProperty("count")&&void 0!==i&&"unread"===i.action&&i.tmailId&&0<i.tmailId.length&&$.publish(v,{resp:e,data:i,msgId:i.tmailId[0]});var o,f,z=zmTab.currentTab,c=zmUtil.getMLConversionValue();for(Z=z.indexOf("zm_tab")?z.indexOf("zm_srch")?zmInit.getListingDetObj():zmSearchUtil.getSearchViewDetails():zmsuite.getCenterOuter().$el.data("data-detail"),q=Z.fId===zmail.folId.sId&&0!==c?0:c,void 0!==i&&(s.push(i.mailId),s.push(i.amailId),s.push(i.tmailId)),m=s.length,d=0;d<m;d++)for(l=0===d||1===d?"msg":"thd",a=0,(r=s[d])&&(a=r.length),n=0;n<a;n++)if(t=r[n],zmUtil.isMetaDataAvailable(t))switch(i.action){case"read":G(t,l,i);break;case"unread":H(t,l,i.preAction);break;case"flag":K(t,i.fVal,l,i.preAction);break;case"label":Q(t,i,l);break;case"spam":te(t,l)}if("notifier"!==i.from&&"zm_Container"===z&&("read"===i.action&&"unread"===Z.view||"flag"===i.action&&Z.flag||"label"===i.action&&Z.label)&&zmList.unchkAll(),e.count)e.count.forEach(function(e){f=Object.keys(e)[0],(o=parseInt(e[f]))<0?ZMail.utils.updateCount({fId:f,mode:"bdec",count:Math.abs(o)}):ZMail.utils.updateCount({fId:f,mode:"binc",count:o})});$(A.prevElem).attr("data-mid")&&$(".SC_Popn").length&&zmPrev.removeCountinPreview(A),re(),me()}else{var I=b.common.errorprocessing;e.result?I=e.result:e.error&&(I=e.error),zmsDialog.alert(I)}}},oe=function(e,i,t){var l,a,d,m,r,n,s,o,f,z=[];for(o=t.mailId||t.amailId,f=t.tmailId,z.push(o),z.push(f),l=z.length,A=zmList.getElemObj(),""!==zmPrev.prevDetails().msgId&&("move"===e||"delete"===e||"spam"===e||"notspam"===e||"unarchive"===e&&"archive"===Z.view||"archive"===e&&("archive"!==Z.view&&Z.fId||!Z.fId&&"unread"===Z.view))&&de(o||[],f||[]),a=0;a<l;a++)for(n=0===a?"msg":"thd",m=0,(r=z[a])&&(m=r.length),d=0;d<m;d++)switch(s=r[d],e){case"read":G(s,n);break;case"unread":H(s,n);break;case"flag":K(s,i.fA,n);break;case"label":t.preAction=!1,Q(s,t,n);break;case"move":t.preAction=!1,R(s,t,n);break;case"delete":Y(s,t.fT,n);break;case"archive":ee(s,n);break;case"unarchive":ie(s,n);break;case"spam":te(s,n)}},fe=function(){var e,i,t,l,a=[],d="";i=(e=zmUtil.getCheckedMailList())[0],t=e[1];var m,r=zmUtil.getMailObj(i[0],"R"),n=zmUtil.getMailObj(t[0],"R");for(i.length&&t.length?d=parseInt(r)>=parseInt(n)?parseInt(r):parseInt(n):i.length?d=parseInt(r):t.length&&(d=parseInt(n)),l=0;l<i.length&&(m=zmUtil.getMailObj(i[l],"R"),parseInt(m)===d);l++)a.push(i[l]);for(l=0;l<t.length&&(m=zmUtil.getMailObj(t[l],"R"),parseInt(m)===d);l++)a.push(t[l]);return{receivedTime:d,list:[a,[]]}},i={applyActions:function(e,i,t){if(!ZMail.utils.isROMode()){var l,a,d,m,r,n,s,o,f=!0,z=[],c=zmUtil.getMLConversionValue(),I={};if(V=i,a={accId:zmail.accId,mode:"markas"},d={action:e},zmInit.listingBand.isBulkActionSet){var g=fe();n=g.list,a.mode="bulkaction",a.receivetime=g.receivedTime,zmTab.currentTab.indexOf("zm_srch")||(a=$.extend(a,zmSearchUtil.getRequestParams()))}else{var v=zmUtil.getCheckedMailCount();if(n=zmUtil.getSelectedMails(),300<v)return}if(d.mailId=l=t&&t.msgId?t.msgId:n[0],r=t&&t.thd?t.thd:n[1],d.tmailId=r,zmTab.currentTab.indexOf("zm_tab")?I=zmTab.currentTab.indexOf("zm_srch")?(Z=zmInit.getListingDetObj(),zmList.selDetails.mListing||{}):(Z=zmSearchUtil.getSearchViewDetails(),zmList.selDetails.sListing||{}):Z=zmsuite.getCenterOuter().$el.data("data-detail"),q=Z.fId===zmail.folId.sId||Z.fId===zmail.folId.tId||Z.fId===zmail.folId.spId?0:c,Z.fId&&(a.viewfolId=Z.fId,o=Z.fId),(Z.view||zmInit.listingBand.isBulkActionSet&&I.view)&&(a.view=Z.view||I.view,o=Z.view),(Z.flag||zmInit.listingBand.isBulkActionSet&&I.flag)&&(a.flag=Z.flag||I.flag,o="flag"),(Z.label||zmInit.listingBand.isBulkActionSet&&I.label)&&(a.label=Z.label||I.label,o=Z.label),(Z.attach||zmInit.listingBand.isBulkActionSet&&I.attach)&&(a.attach=Z.attach||I.attach,o=Z.attach),zmInit.listingBand.isBulkActionSet||(a.folderSpec=q),r&&r.length&&(z=zmUtil.getThreadIdArr(r)),"zm_Container"===zmTab.currentTab&&"unread"===o&&$.e(zmail.mailCenter.prevElem).hasClass("shw")&&z.length){var u,h,p=zmPrev.prevDetails().msgId,T=$.extend({},Z),b=p&&zmUtil.getMailObj(p);if(h=b.T,u=z.indexOf(h),b.TH&&-1!==u){""===Z.fId?T.view="all":T.view="";var C=zmList.getMailSummaryList(Z,h);0===C.length&&(C=zmList.getMailSummaryList(T,h),l=l.concat(zmUtil.getListMap(h,"MO")),d.mailId=l,r.splice(u,1),d.tmailId=r)}}if((Z.fId===zmail.folId.tId||Z.fId===zmail.folId.dId||0===q)&&r&&r.length&&(l=l.concat(r),r=[],d.mailId=l,d.tmailId=[]),l&&l.length&&(m=zmmailAct.separateArchive(l),a.mailId=m[0].join(),a.mailId.length||(delete a.mailId,delete d.mailId),0<m[0].length&&zmUtil.isSharedFolder(Z.fId)&&(a.shId=d.shId=zmUtil.getShareId(Z.fId),zmail.opType[e]?a.opType=zmail.opType[e]:a.opType=0)),m&&0<m[1].length&&(d.amailId=m[1],a.amailId=m[1].join(),zmUtil.isSharedFolder(Z.fId)&&(a.shId=d.shId=zmUtil.getShareId(Z.fId),zmail.opType[e]?a.opType=zmail.opType[e]:a.opType=0)),r&&r.length&&(a.tmailId=z.join(),zmUtil.isSharedFolder(Z.fId)&&(a.shId=d.shId=zmUtil.getShareId(Z.fId),zmail.opType[e]?a.opType=zmail.opType[e]:a.opType=0)),a.todo=$.inArray(e,B),"flag"===e?(a.fA=t.fVal,d.fVal=t.fVal):"label"===e?(d.lA=t.lA,t.lId&&(a.lId=d.lId=t.lId),"add"===t.lA?(a.mailId&&a.mailId.length?s=zmmailAct.rmDuplicateLabel(a.mailId,t.lId,"msg"):(delete a.mailId,delete d.mailId),s&&0<s.length?(a.mailId=s.join(),a.lA=0):r&&r.length?f=!(a.lA=0):a.amailId&&a.amailId.length?((s=zmmailAct.rmDuplicateLabel(a.amailId,t.lId,"msg"))&&0<s.length&&(a.amailId=s.join()),a.lA=0):(zmUtil.hideMenu(),f=!1)):"delete"===t.lA?a.lA=2:a.lA=3,"default"===t.accType&&(a.accId=zmail.defAccId)):-1===a.todo&&(f=!1),f&&"zmStreamsApp"!==zmTab.currentTab){var M=se;if(d.suppressWSNoti=!0,zmInit.listingBand.isBulkActionSet?(d.suppressWSNoti=!1,d.preAction=!1,M=ae):a.shId?d.preAction=!1:d.preAction=!0,X(a,d,M),d.preAction){var O=$.extend({},a),A=$.extend({},d);oe(e,O,A)}}}},doActions:function(e,i,t){if(!ZMail.utils.isROMode()){var l,a,d,m,r,n,s,o={accId:zmail.accId,mode:"moveto"},f={action:e,from:i},z=!0,c=[],I=zmUtil.getMLConversionValue(),g={};if(V=i,zmTab.currentTab.indexOf("zm_tab")?g=zmTab.currentTab.indexOf("zm_srch")?(Z=zmInit.getListingDetObj(),zmList.selDetails.mListing||{}):(Z=zmSearchUtil.getSearchViewDetails(),zmList.selDetails.sListing||{}):Z=zmsuite.getCenterOuter().$el.data("data-detail"),q=Z.fId===zmail.folId.sId||Z.fId===zmail.folId.tId||Z.fId===zmail.folId.spId?0:I,"newm"!==e){if("sweep"===e){o.mode="bulkaction";var v=zmUtil.createSearchParams(t.senderList,Z);o=$.extend(o,v),(d=zmUtil.getSelectedMails())[0]=d[0].concat(d[1])||[];var u=zmUtil.getFolId(Z);zmUtil.getListMap(u,"MO").length?o.receivetime=zmUtil.getMailObj(zmUtil.getListMap(u,"MO")[0],"R"):o.receivetime=zmUtil.getMailObj(d[0][0],"R"),"delete"===t.actionType?o.sA=0:"archive"===t.actionType&&(o.sA=1,$.publish(W,[Z.fId])),f.action=t.actionType}else if(zmInit.listingBand.isBulkActionSet){var h=fe();d=h.list,o.mode="bulkaction",o.receivetime=h.receivedTime,zmTab.currentTab.indexOf("zm_srch")||(o=$.extend(o,zmSearchUtil.getRequestParams()))}else{var p=zmUtil.getCheckedMailCount();if(d=zmUtil.getSelectedMails(),300<p)return}if(f.mailId=l=t&&t.msgId?t.msgId:d[0],m=t&&t.thd?t.thd:d[1],f.tmailId=m,"sweep"!==e){if(Z.fId&&(o.viewfolId=Z.fId,r=Z.fId),(Z.view||zmInit.listingBand.isBulkActionSet&&g.view)&&(o.view=Z.view||g.view,r=Z.view,"bulkaction"===o.mode&&!Z.fId&&"search"===Z.view)){var T=zmSearchUtil.getSearchedFolders()[0]||"";T&&(o.viewfolId=T)}(Z.flag||zmInit.listingBand.isBulkActionSet&&g.flag)&&(o.flag=Z.flag||g.flag,r="flag"),(Z.label||zmInit.listingBand.isBulkActionSet&&g.label)&&(o.label=Z.label||g.label,r=Z.label),(Z.attach||zmInit.listingBand.isBulkActionSet&&g.attach)&&(o.attach=Z.attach||g.attach,r=Z.attach)}if(m&&m.length&&(c=zmUtil.getThreadIdArr(m)),"zm_Container"===zmTab.currentTab&&"unread"===r&&$(zmail.mailCenter.prevElem).hasClass("shw")&&c.length){var b,C,M=zmPrev.prevDetails().msgId,O=zmUtil.getMailObj(M),A=$.extend({},Z);if(C=O.T,b=c.indexOf(C),O.TH&&-1!==b){""===Z.fId?A.view="all":A.view="";var w=zmList.getMailSummaryList(Z,O.T);0===w.length&&(w=zmList.getMailSummaryList(A,O.T),l=l.concat(w),f.mailId=l,m.splice(b,1),f.tmailId=m)}}(Z.fId===zmail.folId.dId||Z.fId===zmail.folId.tId||0===q)&&m&&m.length&&(l=l.concat(m),m=[],f.mailId=l,f.tmailId=[]),l&&l.length&&(a=zmmailAct.separateArchive(l),o.mailId=a[0].join(),o.mailId.length||(delete o.mailId,delete f.mailId),0<a[0].length&&zmUtil.isSharedFolder(Z.fId)&&(o.shId=f.shId=zmUtil.getShareId(Z.fId),zmail.opType[e]?o.opType=zmail.opType[e]:o.opType=0)),a&&0<a[1].length&&(f.amailId=a[1],o.amailId=a[1].join(),zmUtil.isSharedFolder(Z.fId)&&(o.shId=f.shId=zmUtil.getShareId(Z.fId),zmail.opType[e]?o.opType=zmail.opType[e]:o.opType=0)),m&&m.length&&(o.tmailId=c.join(),zmUtil.isSharedFolder(Z.fId)&&(o.shId=f.shId=zmUtil.getShareId(Z.fId),zmail.opType[e]?o.opType=zmail.opType[e]:o.opType=0))}if(o.todo=$.inArray(e,B),"move"===e){var U,L;if(o.folId=f.folId=t.folId,o.mailId){for(U=o.mailId.toString().split(","),o.mailId="",L=0;L<U.length;L++)t.folId!==zmUtil.getMailObj(U[L],"FD")&&(0!==L&&""!==o.mailId&&(o.mailId+=","),o.mailId+=U[L]);o.mailId||delete o.mailId}if(o.tmailId&&1===q&&zmail.folCount[Z.fId])for(U=m.toString().split(","),o.tmailId="",L=0;L<U.length;L++)s=zmUtil.getMailObj(U[L]),t.folId!==s.FD&&(0!==L&&""!==o.tmailId&&(o.tmailId+=","),o.tmailId+=s.T)}else if("delete"===e){var S=Z.fId;"search"===Z.view&&(S=zmSearchUtil.getSearchedFolders()[0]||""),S===zmail.folId.dId?o.fT=f.fT=1:S===zmail.folId.teId?o.fT=f.fT=2:S===zmail.folId.spId?o.fT=f.fT=4:S===zmail.folId.tId?o.fT=f.fT=5:S===zmail.folId.oId?o.fT=f.fT=6:o.fT=f.fT=0,s=zmUtil.getMailObj(o.mailId),o.mailId&&s&&s.FD===zmail.folId.dId&&(o.fT=f.fT=1)}else if("notspam"===e){var F,j;if(o.mailId){for(F=o.mailId.toString().split(","),j=0;j<F.length;j++)zmUtil.getMailObj(F[j],"FD")!==zmail.folId.spId&&F.splice(j,1);o.mailId=F.join()}}else-1===o.todo&&(o.todo=-1);if(o.mailId||o.tmailId||o.amailId||"newm"===e||(zmUtil.hideMenu(),z=!1),"bulkaction"!==o.mode&&(1===q||2===q&&r===zmail.folId.tId||r===zmail.folId.dId?o.folderSpec=1:o.folderSpec=q,n=t&&t.listingType?t.listingType:zmAdHocSettings.getConversationActionType(),2!==o.folderSpec||"delete"!==e&&"spam"!==e&&"move"!==e||(o.folderSpec=parseInt(n))),z){var P,E,y,k=ne;if(f.suppressWSNoti=!0,"bulkaction"===o.mode?(f.preAction=!1,k=ae,f.suppressWSNoti=!1):o.shId||"notspam"===e?(f.preAction=!1,f.loadAdjacent=!0):f.preAction=!0,t&&t.actionSrc&&(o.actionSrc=t.actionSrc),"moveto"===o.mode&&6===o.fT){var D,x,_;y=o.mailId.split(","),$.subscribe("mail/updateOutBox",function(e,i){var t=i.M.split(",");y.forEach(function(i){t.forEach(function(e){if(i===e)return zmsDialog.remove(),!1})})}),1===y.length?(x=zmUtil.getMailObj(o.mailId),D=0===x.SCO.OT?N.schedule:N.Recurred):(D="",y.forEach(function(e){x=zmUtil.getMailObj(e),_=0===x.SCO.OT?N.schedule:N.Recurred,0===D.trim().length?D=_:D!==_&&(D=N.schedule)})),zmsDialog.confirm(D,{onOk:function(){X(o,f,k),f.preAction&&(P=$.extend({},o),E=$.extend({},f),oe(e,P,E))}})}else{if(("unarchive"===e||"delete"===e)&&"zm_Container"===zmTab.currentTab&&Z.fId&&"archive"===Z.view){var R=zmList.getSelectedRowCount(),G=zmUtil.getListMap(Z.fId)||{},H=G&&G.showNextPage;(zmInit.listingBand.isBulkActionSet||(G.MO||[]).length===R&&0===H)&&(f.updUnarchiveStatusforFId=Z.fId)}X(o,f,k),f.preAction&&(P=$.extend({},o),E=$.extend({},f),oe(e,P,E))}}}},rmDuplicateLabel:function(e,i){for(var t,l,a,d=e.toString().split(","),m=d.length,r=[],n=0;n<m;n++){var s;if(a=d[n],t=!1,l=zmUtil.getMailObj(a,"TAG"))for(s=0;s<l.length;s++)if(l[s]===i){t=!0;break}t||r.push(a)}return r},separateArchive:function(e){for(var i=[],t=[],l=e.length,a=0;a<l;a++)1===zmUtil.getMailObj(e[a],"AR")?t.push(e[a]):i.push(e[a]);return[i,t]},createCommentEntity:(a={no_data:{code:0,message:e.publishcomment.error.maildatanotavlbl},no_mention:{code:1,message:e.publishcomment.error.userorgrouprequire},req_fail:{code:2,message:e.publishcomment.error.requestfail}},function(e,i,t){var l=$.Deferred();return i=i||"",(e=String(e||""))?i&&i.length?zmAjq.XHR({u:zmail.conPath+"/mA.do",t:"POST",fn:function(){l.resolve()},p:{mode:"createCommentEntity",messageID:e,shareWith:i,shareConversation:t},csr:"s",efn:function(){l.reject({error:a.req_fail})}}).fail(function(){l.reject({error:a.req_fail})}):l.reject({error:a.no_mention}):l.reject({error:a.no_data}),l.promise()}),updateDraftCountInUI:function(e,i,t,l){var a,d,m=zmUtil.getMLConversionValue();if(""!==i&&void 0!==i&&0!==m&&(a=F(e,l)))if("discard_draft"===i)t?(d=1<t?t+" "+n.common.draftPlural:t+" "+n.common.draft,a.find("."+w.draft).appendDOM(zdom("span",null,d),{clear:!0})):(a.find("."+w.draft).clearHTML(),a.find("."+w.from).removeClass(w.hasDftCount));else if("save_draft"===i){var r=zmUtil.getMailObj(e);r&&!r.DMID&&(a.length&&0===(e=a.attr("id")).indexOf("t")&&(e=e.substring(1),r=zmUtil.getMailObj(e)),d=1<(t=r.DC?r.DC+1:1)?t+" "+n.common.draftPlural:t+" "+n.common.draft,a.find("."+w.draft).appendDOM(zdom("span",null,d),{clear:!0}),a.find("."+w.from).addClass(w.hasDftCount))}},rapplyAction:se,rdoAction:ne,updateUnreadStatusforThd:h,updateFlagStatusforThd:p,setFlagStatusforThd:T,updateLabelsforThd:S,deleteOfflineEmail:function(e){zmCompOffline.removeDraft(e).then(function(){ZMail.listing.collection.clearMsgFromListMap(e,zmUtil.getFolId()),ZMail.listing.collection.clearModel(e),ZMail.lView.delete(e),ZMail.lView.clearOfflineSeparator(),zmList.setEmptyListing()})}};return $.subscribe("/mail/draftsaved",function(e,i){i=i||{},zmUtil.isInlineCompose()&&zmUtil.getMailContent(String(i.draftId),{reload:!0}),zmmailAct.updateDraftCountInUI(i.msgId,"save_draft","","zm_Container")}),i}();